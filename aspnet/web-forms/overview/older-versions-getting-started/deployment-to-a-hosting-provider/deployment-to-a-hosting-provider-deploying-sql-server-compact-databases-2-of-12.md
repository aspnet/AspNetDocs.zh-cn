---
uid: web-forms/overview/older-versions-getting-started/deployment-to-a-hosting-provider/deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12
title: 使用 Visual Studio 或 Visual Web Developer SQL Server Compact 部署 ASP.NET Web 应用程序：部署 SQL Server Compact 数据库-2 个，共12个 |Microsoft Docs
author: tdykstra
description: 本系列教程说明如何使用 Visual Stu 部署（发布）包含 SQL Server Compact 数据库的 ASP.NET web 应用程序项目。
ms.author: riande
ms.date: 11/17/2011
ms.assetid: c3c76516-4c48-4153-bd03-d70e3a3edbb0
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deployment-to-a-hosting-provider/deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12
msc.type: authoredcontent
ms.openlocfilehash: 56ceabc79947967846d342354fd033510be5f05a
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78458252"
---
# <a name="deploying-an-aspnet-web-application-with-sql-server-compact-using-visual-studio-or-visual-web-developer-deploying-sql-server-compact-databases---2-of-12"></a><span data-ttu-id="9f62d-103">使用 Visual Studio 或 Visual Web Developer SQL Server Compact 部署 ASP.NET Web 应用程序：部署 SQL Server Compact 数据库-2 of 12</span><span class="sxs-lookup"><span data-stu-id="9f62d-103">Deploying an ASP.NET Web Application with SQL Server Compact using Visual Studio or Visual Web Developer: Deploying SQL Server Compact Databases - 2 of 12</span></span>

<span data-ttu-id="9f62d-104">作者： [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="9f62d-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="9f62d-105">下载初学者项目</span><span class="sxs-lookup"><span data-stu-id="9f62d-105">Download Starter Project</span></span>](https://code.msdn.microsoft.com/Deploying-an-ASPNET-Web-4e31366b)

> <span data-ttu-id="9f62d-106">本系列教程介绍了如何使用 Visual Studio 2012 RC 或 Visual Studio Express 2012 RC for Web，部署（发布）包含 SQL Server Compact 数据库的 ASP.NET web 应用程序项目。</span><span class="sxs-lookup"><span data-stu-id="9f62d-106">This series of tutorials shows you how to deploy (publish) an ASP.NET web application project that includes a SQL Server Compact database by using Visual Studio 2012 RC or Visual Studio Express 2012 RC for Web.</span></span> <span data-ttu-id="9f62d-107">如果安装 Web 发布更新，还可以使用 Visual Studio 2010。</span><span class="sxs-lookup"><span data-stu-id="9f62d-107">You can also use Visual Studio 2010 if you install the Web Publish Update.</span></span> <span data-ttu-id="9f62d-108">有关系列的简介，请参阅本[系列中的第一个教程](deployment-to-a-hosting-provider-introduction-1-of-12.md)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-108">For an introduction to the series, see [the first tutorial in the series](deployment-to-a-hosting-provider-introduction-1-of-12.md).</span></span>
> 
> <span data-ttu-id="9f62d-109">有关演示 Visual Studio 2012 RC 版本后引入的部署功能的教程，演示如何部署 SQL Server Compact 以外的 SQL Server 版本，并演示如何部署到 Azure App Service Web 应用，请参阅[使用 Visual Studio 的 ASP.NET Web 部署](../../deployment/visual-studio-web-deployment/introduction.md)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-109">For a tutorial that shows deployment features introduced after the RC release of Visual Studio 2012, shows how to deploy SQL Server editions other than SQL Server Compact, and shows how to deploy to Azure App Service Web Apps, see [ASP.NET Web Deployment using Visual Studio](../../deployment/visual-studio-web-deployment/introduction.md).</span></span>

## <a name="overview"></a><span data-ttu-id="9f62d-110">概述</span><span class="sxs-lookup"><span data-stu-id="9f62d-110">Overview</span></span>

<span data-ttu-id="9f62d-111">本教程介绍如何设置两个 SQL Server Compact 数据库和用于部署的数据库引擎。</span><span class="sxs-lookup"><span data-stu-id="9f62d-111">This tutorial shows how to set up two SQL Server Compact databases and the database engine for deployment.</span></span>

<span data-ttu-id="9f62d-112">对于数据库访问，Contoso 大学应用程序需要以下必须与应用程序一起部署的软件，因为它未包含在 .NET Framework 中：</span><span class="sxs-lookup"><span data-stu-id="9f62d-112">For database access, the Contoso University application requires the following software that must be deployed with the application because it is not included in the .NET Framework:</span></span>

- <span data-ttu-id="9f62d-113">[SQL Server Compact](https://www.microsoft.com/sqlserver/en/us/editions/compact.aspx) （数据库引擎）。</span><span class="sxs-lookup"><span data-stu-id="9f62d-113">[SQL Server Compact](https://www.microsoft.com/sqlserver/en/us/editions/compact.aspx) (the database engine).</span></span>
- <span data-ttu-id="9f62d-114">[ASP.NET 通用提供程序](http://www.hanselman.com/blog/IntroducingSystemWebProvidersASPNETUniversalProvidersForSessionMembershipRolesAndUserProfileOnSQLCompactAndSQLAzure.aspx)（使 ASP.NET 成员资格系统可以使用 SQL Server Compact）</span><span class="sxs-lookup"><span data-stu-id="9f62d-114">[ASP.NET Universal Providers](http://www.hanselman.com/blog/IntroducingSystemWebProvidersASPNETUniversalProvidersForSessionMembershipRolesAndUserProfileOnSQLCompactAndSQLAzure.aspx) (which enable the ASP.NET membership system to use SQL Server Compact)</span></span>
- <span data-ttu-id="9f62d-115">[实体框架 5.0](https://msdn.microsoft.com/library/gg696172(d=lightweight,v=vs.103).aspx)（Code First 迁移）。</span><span class="sxs-lookup"><span data-stu-id="9f62d-115">[Entity Framework 5.0](https://msdn.microsoft.com/library/gg696172(d=lightweight,v=vs.103).aspx)(Code First with Migrations).</span></span>

<span data-ttu-id="9f62d-116">数据库结构和应用程序的两个数据库中的某些（而非全部）数据也必须部署。</span><span class="sxs-lookup"><span data-stu-id="9f62d-116">The database structure and some (not all) of the data in the application's two databases must also be deployed.</span></span> <span data-ttu-id="9f62d-117">通常，在开发应用程序时，您可以将测试数据输入到不想部署到实时站点的数据库中。</span><span class="sxs-lookup"><span data-stu-id="9f62d-117">Typically, as you develop an application, you enter test data into a database that you don't want to deploy to a live site.</span></span> <span data-ttu-id="9f62d-118">不过，您也可以输入一些您要部署的生产数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-118">However, you might also enter some production data that you do want to deploy.</span></span> <span data-ttu-id="9f62d-119">在本教程中，你将配置 Contoso 大学项目，以便在部署时包括所需的软件和正确的数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-119">In this tutorial you'll configure the Contoso University project so that the required software and the correct data are included when you deploy.</span></span>

<span data-ttu-id="9f62d-120">提醒：如果你收到一条错误消息或在你完成本教程时无法正常工作，请务必查看[故障排除页](deployment-to-a-hosting-provider-creating-and-installing-deployment-packages-12-of-12.md)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-120">Reminder: If you get an error message or something doesn't work as you go through the tutorial, be sure to check the [troubleshooting page](deployment-to-a-hosting-provider-creating-and-installing-deployment-packages-12-of-12.md).</span></span>

## <a name="sql-server-compact-versus-sql-server-express"></a><span data-ttu-id="9f62d-121">SQL Server Compact 与 SQL Server Express</span><span class="sxs-lookup"><span data-stu-id="9f62d-121">SQL Server Compact versus SQL Server Express</span></span>

<span data-ttu-id="9f62d-122">示例应用程序使用 SQL Server Compact 4.0。</span><span class="sxs-lookup"><span data-stu-id="9f62d-122">The sample application uses SQL Server Compact 4.0.</span></span> <span data-ttu-id="9f62d-123">此数据库引擎是网站的一个相对全新的选项;早期版本的 SQL Server Compact 在 web 宿主环境中不起作用。</span><span class="sxs-lookup"><span data-stu-id="9f62d-123">This database engine is a relatively new option for websites; earlier versions of SQL Server Compact do not work in a web hosting environment.</span></span> <span data-ttu-id="9f62d-124">与使用 SQL Server Express 进行开发并将其部署到完整 SQL Server 更常见的方案相比，SQL Server Compact 提供了几个优点。</span><span class="sxs-lookup"><span data-stu-id="9f62d-124">SQL Server Compact offers a few benefits compared to the more common scenario of developing with SQL Server Express and deploying to full SQL Server.</span></span> <span data-ttu-id="9f62d-125">根据所选的托管提供程序，SQL Server Compact 可能会更便宜，因为某些提供程序需要额外付费来支持完全 SQL Server 的数据库。</span><span class="sxs-lookup"><span data-stu-id="9f62d-125">Depending on the hosting provider you choose, SQL Server Compact might be cheaper to deploy, because some providers charge extra to support a full SQL Server database.</span></span> <span data-ttu-id="9f62d-126">SQL Server Compact 不会额外收取费用，因为你可以在 web 应用程序中部署数据库引擎本身。</span><span class="sxs-lookup"><span data-stu-id="9f62d-126">There is no extra charge for SQL Server Compact because you can deploy the database engine itself as part of your web application.</span></span>

<span data-ttu-id="9f62d-127">但是，您还应知道其局限性。</span><span class="sxs-lookup"><span data-stu-id="9f62d-127">However, you should also be aware of its limitations.</span></span> <span data-ttu-id="9f62d-128">SQL Server Compact 不支持存储过程、触发器、视图或复制。</span><span class="sxs-lookup"><span data-stu-id="9f62d-128">SQL Server Compact does not support stored procedures, triggers, views, or replication.</span></span> <span data-ttu-id="9f62d-129">（有关 SQL Server Compact 不支持 SQL Server 功能的完整列表，请参阅[SQL Server Compact 和 SQL Server 之间的差异](https://msdn.microsoft.com/library/bb896140.aspx)。）此外，某些可用于在 SQL Server Express 和 SQL Server 数据库中操作架构和数据的工具不能与 SQL Server Compact 一起使用。</span><span class="sxs-lookup"><span data-stu-id="9f62d-129">(For a complete list of SQL Server features that are not supported by SQL Server Compact, see [Differences Between SQL Server Compact and SQL Server](https://msdn.microsoft.com/library/bb896140.aspx).) Also, some of the tools that you can use to manipulate schemas and data in SQL Server Express and SQL Server databases do not work with SQL Server Compact.</span></span> <span data-ttu-id="9f62d-130">例如，不能在 Visual Studio 中将 SQL Server Management Studio 或 SQL Server Data Tools 与 SQL Server Compact 数据库一起使用。</span><span class="sxs-lookup"><span data-stu-id="9f62d-130">For example, you cannot use SQL Server Management Studio or SQL Server Data Tools in Visual Studio with SQL Server Compact databases.</span></span> <span data-ttu-id="9f62d-131">您可以使用其他选项来处理 SQL Server Compact 数据库：</span><span class="sxs-lookup"><span data-stu-id="9f62d-131">You do have other options for working with SQL Server Compact databases:</span></span>

- <span data-ttu-id="9f62d-132">你可以在 Visual Studio 中使用服务器资源管理器，这为 SQL Server Compact 提供了有限的数据库操作功能。</span><span class="sxs-lookup"><span data-stu-id="9f62d-132">You can use Server Explorer in Visual Studio, which offers limited database manipulation functionality for SQL Server Compact.</span></span>
- <span data-ttu-id="9f62d-133">您可以使用[WebMatrix](https://www.microsoft.com/web/webmatrix/)的数据库操作功能，该功能的功能比服务器资源管理器多。</span><span class="sxs-lookup"><span data-stu-id="9f62d-133">You can use the database manipulation feature of [WebMatrix](https://www.microsoft.com/web/webmatrix/), which has more features than Server Explorer.</span></span>
- <span data-ttu-id="9f62d-134">您可以使用相对功能最齐全的第三方或开源工具，如[SQL Server Compact 工具箱](https://github.com/ErikEJ/SqlCeToolbox)和[SQL Compact 数据和架构脚本实用工具](https://github.com/ErikEJ/SqlCeToolbox)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-134">You can use relatively full-featured third-party or open source tools, such as the [SQL Server Compact Toolbox](https://github.com/ErikEJ/SqlCeToolbox) and [SQL Compact data and schema script utility](https://github.com/ErikEJ/SqlCeToolbox).</span></span>
- <span data-ttu-id="9f62d-135">您可以编写和运行自己的 DDL （数据定义语言）脚本来处理数据库架构。</span><span class="sxs-lookup"><span data-stu-id="9f62d-135">You can write and run your own DDL (data definition language) scripts to manipulate the database schema.</span></span>

<span data-ttu-id="9f62d-136">你可以从 SQL Server Compact 开始，然后随着需求的发展，稍后再升级。</span><span class="sxs-lookup"><span data-stu-id="9f62d-136">You can start with SQL Server Compact and then upgrade later as your needs evolve.</span></span> <span data-ttu-id="9f62d-137">本系列后面的教程介绍如何从 SQL Server Compact 迁移到 SQL Server Express 并 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="9f62d-137">Later tutorials in this series show you how to migrate from SQL Server Compact to SQL Server Express and to SQL Server.</span></span> <span data-ttu-id="9f62d-138">但是，如果你要创建新的应用程序并希望在不久的将来需要 SQL Server，则最好是从 SQL Server 或 SQL Server Express 开始。</span><span class="sxs-lookup"><span data-stu-id="9f62d-138">However, if you're creating a new application and expect to need SQL Server in the near future, it's probably best to start with SQL Server or SQL Server Express.</span></span>

## <a name="configuring-the-sql-server-compact-database-engine-for-deployment"></a><span data-ttu-id="9f62d-139">为部署配置 SQL Server Compact 数据库引擎</span><span class="sxs-lookup"><span data-stu-id="9f62d-139">Configuring the SQL Server Compact Database Engine for Deployment</span></span>

<span data-ttu-id="9f62d-140">通过安装以下 NuGet 包，添加了 Contoso 大学应用程序中数据访问所需的软件：</span><span class="sxs-lookup"><span data-stu-id="9f62d-140">The software required for data access in the Contoso University application was added by installing the following NuGet packages:</span></span>

- [<span data-ttu-id="9f62d-141">SqlServerCompact</span><span class="sxs-lookup"><span data-stu-id="9f62d-141">SqlServerCompact</span></span>](http://nuget.org/List/Packages/SqlServerCompact)
- <span data-ttu-id="9f62d-142">[System.web. Providers](http://nuget.org/List/Packages/System.Web.Providers) （ASP.NET 通用提供程序）</span><span class="sxs-lookup"><span data-stu-id="9f62d-142">[System.Web.Providers](http://nuget.org/List/Packages/System.Web.Providers) (ASP.NET universal providers)</span></span>
- [<span data-ttu-id="9f62d-143">EntityFramework</span><span class="sxs-lookup"><span data-stu-id="9f62d-143">EntityFramework</span></span>](http://nuget.org/List/Packages/EntityFramework)
- [<span data-ttu-id="9f62d-144">EntityFramework. SqlServerCompact</span><span class="sxs-lookup"><span data-stu-id="9f62d-144">EntityFramework.SqlServerCompact</span></span>](http://nuget.org/List/Packages/EntityFramework.sqlservercompact)

<span data-ttu-id="9f62d-145">这些链接指向这些包的当前版本，这些包可能比你在本教程中下载的初学者项目中安装的版本更新。</span><span class="sxs-lookup"><span data-stu-id="9f62d-145">The links point to the current versions of these packages, which might be newer than what is installed in the starter project that you downloaded for this tutorial.</span></span> <span data-ttu-id="9f62d-146">若要部署到宿主提供程序，请确保使用实体框架5.0 或更高版本。</span><span class="sxs-lookup"><span data-stu-id="9f62d-146">For deployment to a hosting provider, make sure that you use Entity Framework 5.0 or later.</span></span> <span data-ttu-id="9f62d-147">更早版本的 Code First 迁移需要完全信任，在许多托管提供程序中，你的应用程序将在中等信任环境下运行。</span><span class="sxs-lookup"><span data-stu-id="9f62d-147">Earlier versions of Code First Migrations require Full Trust, and at many hosting providers your application will run in Medium Trust.</span></span> <span data-ttu-id="9f62d-148">有关中等信任的详细信息，请参阅 "[以测试环境部署到 IIS](deployment-to-a-hosting-provider-deploying-to-iis-as-a-test-environment-5-of-12.md) " 教程。</span><span class="sxs-lookup"><span data-stu-id="9f62d-148">For more information about Medium Trust, see the [Deploying to IIS as a Test Environment](deployment-to-a-hosting-provider-deploying-to-iis-as-a-test-environment-5-of-12.md) tutorial.</span></span>

<span data-ttu-id="9f62d-149">NuGet 包安装通常负责将此软件与应用程序一起部署所需的所有内容。</span><span class="sxs-lookup"><span data-stu-id="9f62d-149">NuGet package installation generally takes care of everything that you need in order to deploy this software with the application.</span></span> <span data-ttu-id="9f62d-150">在某些情况下，这涉及到任务，例如更改 Web.config 文件以及添加每次生成解决方案时运行的 PowerShell 脚本。</span><span class="sxs-lookup"><span data-stu-id="9f62d-150">In some cases, this involves tasks such as changing the Web.config file and adding PowerShell scripts that run whenever you build the solution.</span></span> <span data-ttu-id="9f62d-151">**如果要在不使用 NuGet 的情况下添加对其中任何功能（如 SQL Server Compact 和实体框架）的支持，请确保了解 NuGet 包安装的功能，以便可以手动执行相同的工作。**</span><span class="sxs-lookup"><span data-stu-id="9f62d-151">**If you want to add support for any of these features (such as SQL Server Compact and Entity Framework) without using NuGet, make sure that you know what NuGet package installation does so that you can do the same work manually.**</span></span>

<span data-ttu-id="9f62d-152">有一个例外，NuGet 并不负责确保成功部署所需的一切内容。</span><span class="sxs-lookup"><span data-stu-id="9f62d-152">There is one exception where NuGet doesn't take care of everything you have to do in order to ensure successful deployment.</span></span> <span data-ttu-id="9f62d-153">SqlServerCompact NuGet 包将向项目中添加一个后期生成脚本，将本机程序集复制到项目*bin*文件夹下的*x86*和*amd64*子文件夹，但该脚本不包含项目中的这些文件夹。</span><span class="sxs-lookup"><span data-stu-id="9f62d-153">The SqlServerCompact NuGet package adds a post-build script to your project that copies the native assemblies to *x86* and *amd64* subfolders under the project *bin* folder, but the script does not include those folders in the project.</span></span> <span data-ttu-id="9f62d-154">因此，除非您手动将它们包含在项目中，否则 Web 部署不会将它们复制到目标网站。</span><span class="sxs-lookup"><span data-stu-id="9f62d-154">As a result, Web Deploy will not copy them to the destination web site unless you manually include them in the project.</span></span> <span data-ttu-id="9f62d-155">（此行为是由默认部署配置生成的，另一个选项（在本教程中不会使用）是更改控制此行为的设置。</span><span class="sxs-lookup"><span data-stu-id="9f62d-155">(This behavior results from the default deployment configuration; another option, which you won't use in these tutorials, is to change the setting that controls this behavior.</span></span> <span data-ttu-id="9f62d-156">您可以更改的设置只是在**项目 "属性**" 窗口的 "**打包/发布 Web** " 选项卡下**要部署的项目**下**运行应用程序所需的文件**。</span><span class="sxs-lookup"><span data-stu-id="9f62d-156">The setting that you can change is **Only files needed to run the application** under **Items to deploy** on the **Package/Publish Web** tab of the **Project Properties** window.</span></span> <span data-ttu-id="9f62d-157">通常不建议更改此设置，因为这可能会导致将更多的文件部署到生产环境中，而不是所需的数量。</span><span class="sxs-lookup"><span data-stu-id="9f62d-157">Changing this setting is not generally recommended because it can result in the deployment of many more files to the production environment than are needed there.</span></span> <span data-ttu-id="9f62d-158">有关备选方案的详细信息，请参阅[配置项目属性](deployment-to-a-hosting-provider-configuring-project-properties-4-of-12.md)教程。）</span><span class="sxs-lookup"><span data-stu-id="9f62d-158">For more information about the alternatives, see the [Configuring Project Properties](deployment-to-a-hosting-provider-configuring-project-properties-4-of-12.md) tutorial.)</span></span>

<span data-ttu-id="9f62d-159">生成项目，然后在**解决方案资源管理器**单击 "**显示所有文件**" （如果尚未这样做）。</span><span class="sxs-lookup"><span data-stu-id="9f62d-159">Build the project, and then in **Solution Explorer** click **Show all Files** if you have not already done so.</span></span> <span data-ttu-id="9f62d-160">你可能还需要单击 "**刷新**"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-160">You might also have to click **Refresh**.</span></span>

![Solution_Explorer_Show_All_Files](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image1.png)

<span data-ttu-id="9f62d-162">展开**bin**文件夹以查看**amd64**和**x86**文件夹，然后选择这些文件夹，右键单击，然后选择 "**包括在项目中**"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-162">Expand the **bin** folder to see the **amd64** and **x86** folders, and then select those folders, right-click, and select **Include in Project**.</span></span>

![amd64_and_x86_in_Solution_Explorer.png](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image2.png)

<span data-ttu-id="9f62d-164">文件夹图标将更改为显示该文件夹已包含在项目中。</span><span class="sxs-lookup"><span data-stu-id="9f62d-164">The folder icons change to show that the folder has been included in the project.</span></span>

![Solution_Explorer_amd64_included.png](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image3.png)

## <a name="configuring-code-first-migrations-for-application-database-deployment"></a><span data-ttu-id="9f62d-166">配置应用程序数据库部署的 Code First 迁移</span><span class="sxs-lookup"><span data-stu-id="9f62d-166">Configuring Code First Migrations for Application Database Deployment</span></span>

<span data-ttu-id="9f62d-167">当你部署应用程序数据库时，通常不会只是将你的开发数据库部署到生产数据库中的所有数据，因为其中的很多数据可能仅用于测试目的。</span><span class="sxs-lookup"><span data-stu-id="9f62d-167">When you deploy an application database, typically you don't simply deploy your development database with all of the data in it to production, because much of the data in it is probably there only for testing purposes.</span></span> <span data-ttu-id="9f62d-168">例如，测试数据库中的学生姓名是虚构的。</span><span class="sxs-lookup"><span data-stu-id="9f62d-168">For example, the student names in a test database are fictional.</span></span> <span data-ttu-id="9f62d-169">另一方面，通常不能只部署数据库结构，根本就不会包含任何数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-169">On the other hand, you often can't deploy just the database structure with no data in it at all.</span></span> <span data-ttu-id="9f62d-170">测试数据库中的某些数据可能是真实数据，当用户开始使用该应用程序时必须存在。</span><span class="sxs-lookup"><span data-stu-id="9f62d-170">Some of the data in your test database might be real data and must be there when users begin to use the application.</span></span> <span data-ttu-id="9f62d-171">例如，您的数据库可能有一个表包含有效的评分值或实际的部门名称。</span><span class="sxs-lookup"><span data-stu-id="9f62d-171">For example, your database might have a table that contains valid grade values or real department names.</span></span>

<span data-ttu-id="9f62d-172">若要模拟这种常见方案，你将配置一个 Code First 迁移种子方法，该方法仅在生产中插入到数据库中的数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-172">To simulate this common scenario, you'll configure a Code First Migrations Seed method that inserts into the database only the data that you want to be there in production.</span></span> <span data-ttu-id="9f62d-173">此种子方法不插入测试数据，因为它将在生产中 Code First 创建数据库后在生产中运行。</span><span class="sxs-lookup"><span data-stu-id="9f62d-173">This Seed method won't insert test data because it will run in production after Code First creates the database in production.</span></span>

<span data-ttu-id="9f62d-174">在发布迁移之前 Code First 早期版本中，种子方法经常插入测试数据，因为在开发过程中每个模型更改都必须完全删除并从头开始创建。</span><span class="sxs-lookup"><span data-stu-id="9f62d-174">In earlier versions of Code First before Migrations was released, it was common for Seed methods to insert test data also, because with every model change during development the database had to be completely deleted and re-created from scratch.</span></span> <span data-ttu-id="9f62d-175">在 Code First 迁移的情况下，在数据库更改后会保留测试数据，因此不需要在 Seed 方法中包括测试数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-175">With Code First Migrations, test data is retained after database changes, so including test data in the Seed method is not necessary.</span></span> <span data-ttu-id="9f62d-176">下载的项目使用预迁移方法，将所有数据包含在初始值设定项类的 Seed 方法中。</span><span class="sxs-lookup"><span data-stu-id="9f62d-176">The project you downloaded uses the pre-Migrations method of including all data in the Seed method of an initializer class.</span></span> <span data-ttu-id="9f62d-177">在本教程中，您将禁用初始值设定项类并启用迁移。</span><span class="sxs-lookup"><span data-stu-id="9f62d-177">In this tutorial you'll disable the initializer class and enable Migrations.</span></span> <span data-ttu-id="9f62d-178">然后，将更新迁移配置类中的 Seed 方法，以便只插入要在生产中插入的数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-178">Then you'll update the Seed method in the Migrations configuration class so that it inserts only data that you want to be inserted in production.</span></span>

<span data-ttu-id="9f62d-179">下图说明了应用程序数据库的架构：</span><span class="sxs-lookup"><span data-stu-id="9f62d-179">The following diagram illustrates the schema of the application database:</span></span>

<span data-ttu-id="9f62d-180">[![School_database_diagram](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image5.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="9f62d-180">[![School_database_diagram](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image5.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image4.png)</span></span>

<span data-ttu-id="9f62d-181">对于这些教程，你将假设首次部署站点时，`Student` 和 `Enrollment` 表应为空。</span><span class="sxs-lookup"><span data-stu-id="9f62d-181">For these tutorials, you'll assume that the `Student` and `Enrollment` tables should be empty when the site is first deployed.</span></span> <span data-ttu-id="9f62d-182">其他表包含在应用程序进入活动时必须预加载的数据。</span><span class="sxs-lookup"><span data-stu-id="9f62d-182">The other tables contain data that has to be preloaded when the application goes live.</span></span>

<span data-ttu-id="9f62d-183">由于将使用 Code First 迁移，因此不再需要使用**DropCreateDatabaseIfModelChanges** Code First 初始值设定项。</span><span class="sxs-lookup"><span data-stu-id="9f62d-183">Since you will be using Code First Migrations, you no longer have to use the **DropCreateDatabaseIfModelChanges** Code First initializer.</span></span> <span data-ttu-id="9f62d-184">此初始值设定项的代码位于 ContosoUniversity 项目的 SchoolInitializer.cs 文件中。</span><span class="sxs-lookup"><span data-stu-id="9f62d-184">The code for this initializer is in the SchoolInitializer.cs file in the ContosoUniversity.DAL project.</span></span> <span data-ttu-id="9f62d-185">Web.config 文件的**appSettings**元素中的设置使此初始值设定项在应用程序首次尝试访问数据库时运行：</span><span class="sxs-lookup"><span data-stu-id="9f62d-185">A setting in the **appSettings** element of the Web.config file causes this initializer to run whenever the application tries to access the database for the first time:</span></span>

[!code-xml[Main](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/samples/sample1.xml?highlight=3)]

<span data-ttu-id="9f62d-186">打开应用程序 Web.config 文件，并从 appSettings 元素中删除指定 Code First 初始值设定项类的元素。</span><span class="sxs-lookup"><span data-stu-id="9f62d-186">Open the application Web.config file and remove the element that specifies the Code First initializer class from the appSettings element.</span></span> <span data-ttu-id="9f62d-187">AppSettings 元素现在如下所示：</span><span class="sxs-lookup"><span data-stu-id="9f62d-187">The appSettings element now looks like this:</span></span>

[!code-xml[Main](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/samples/sample2.xml)]

> [!NOTE]
> <span data-ttu-id="9f62d-188">指定初始值设定项类的另一种方法是，在*global.asax*文件中的 `Application_Start` 方法中调用 `Database.SetInitializer`。</span><span class="sxs-lookup"><span data-stu-id="9f62d-188">Another way to specify an initializer class is do it by calling `Database.SetInitializer` in the `Application_Start` method in the *Global.asax* file.</span></span> <span data-ttu-id="9f62d-189">如果要在使用该方法来指定初始值设定项的项目中启用迁移，请删除该行代码。</span><span class="sxs-lookup"><span data-stu-id="9f62d-189">If you are enabling Migrations in a project that uses that method to specify the initializer, remove that line of code.</span></span>

<span data-ttu-id="9f62d-190">接下来，启用 Code First 迁移。</span><span class="sxs-lookup"><span data-stu-id="9f62d-190">Next, enable Code First Migrations.</span></span>

<span data-ttu-id="9f62d-191">第一步是确保将 ContosoUniversity 项目设置为启动项目。</span><span class="sxs-lookup"><span data-stu-id="9f62d-191">The first step is to make sure that the ContosoUniversity project is set as the startup project.</span></span> <span data-ttu-id="9f62d-192">在**解决方案资源管理器**中，右键单击 ContosoUniversity 项目，然后选择 "**设为启动项目**"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-192">In **Solution Explorer**, right-click the ContosoUniversity project and select **Set as Startup Project**.</span></span> <span data-ttu-id="9f62d-193">Code First 迁移将在启动项目中查找数据库连接字符串。</span><span class="sxs-lookup"><span data-stu-id="9f62d-193">Code First Migrations will look in the startup project to find the database connection string.</span></span>

<span data-ttu-id="9f62d-194">在“工具”菜单中，单击“NuGet 包管理器”，然后单击“包管理器控制台”。</span><span class="sxs-lookup"><span data-stu-id="9f62d-194">From the **Tools** menu, click **NuGet Package Manager** and then **Package Manager Console**.</span></span>

![Selecting_Package_Manager_Console](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image6.png)

<span data-ttu-id="9f62d-196">在 "**包管理器控制台**" 窗口顶部，选择 "ContosoUniversity" 作为默认项目，然后在 `PM>` 提示符下输入 "启用-迁移"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-196">At the top of the **Package Manager Console** window select ContosoUniversity.DAL as the default project and then at the `PM>` prompt enter "enable-migrations".</span></span>

![enable-migrations_command](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image7.png)

<span data-ttu-id="9f62d-198">此命令在 ContosoUniversity 项目中的新*迁移*文件夹中创建*Configuration.cs*文件。</span><span class="sxs-lookup"><span data-stu-id="9f62d-198">This command creates a *Configuration.cs* file in a new *Migrations* folder in the ContosoUniversity.DAL project.</span></span>

![Migrations_folder_in_Solution_Explorer](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image8.png)

<span data-ttu-id="9f62d-200">你选择了 DAL 项目，因为必须在包含 Code First 上下文类的项目中执行 "启用-迁移" 命令。</span><span class="sxs-lookup"><span data-stu-id="9f62d-200">You selected the DAL project because the "enable-migrations" command must be executed in the project that contains the Code First context class.</span></span> <span data-ttu-id="9f62d-201">当该类在类库项目中时，Code First 迁移将在解决方案的启动项目中查找数据库连接字符串。</span><span class="sxs-lookup"><span data-stu-id="9f62d-201">When that class is in a class library project, Code First Migrations looks for the database connection string in the startup project for the solution.</span></span> <span data-ttu-id="9f62d-202">在 ContosoUniversity 解决方案中，web 项目已设置为启动项目。</span><span class="sxs-lookup"><span data-stu-id="9f62d-202">In the ContosoUniversity solution, the web project has been set as the startup project.</span></span> <span data-ttu-id="9f62d-203">（如果你不想在 Visual Studio 中指定具有连接字符串的项目作为启动项目，则可以在 PowerShell 命令中指定启动项目。</span><span class="sxs-lookup"><span data-stu-id="9f62d-203">(If you did not want to designate the project that has the connection string as the startup project in Visual Studio, you can specify the startup project in the PowerShell command.</span></span> <span data-ttu-id="9f62d-204">若要查看 "启用-迁移" 命令的命令语法，可以输入 "get-help 启用-迁移" 命令。</span><span class="sxs-lookup"><span data-stu-id="9f62d-204">To see the command syntax for the enable-migrations command, you can enter the command "get-help enable-migrations".)</span></span>

<span data-ttu-id="9f62d-205">打开 Configuration.cs 文件，并将 `Seed` 方法中的注释替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="9f62d-205">Open the Configuration.cs file and replace the comments in the `Seed` method with the following code:</span></span>

[!code-csharp[Main](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/samples/sample3.cs)]

<span data-ttu-id="9f62d-206">对 `List` 的引用在其下有红色的波浪线，因为尚没有用于其命名空间的 `using` 语句。</span><span class="sxs-lookup"><span data-stu-id="9f62d-206">The references to `List` have red squiggly lines under them because you don't have a `using` statement for its namespace yet.</span></span> <span data-ttu-id="9f62d-207">右键单击其中一个 `List` 实例，单击 "**解析**"，然后单击 "**使用 system.object**"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-207">Right-click one of the instances of `List` and click **Resolve**, and then click **using System.Collections.Generic**.</span></span>

![使用 using 语句解析](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image9.png)

<span data-ttu-id="9f62d-209">此菜单选择会将以下代码添加到文件顶部附近的 `using` 语句中。</span><span class="sxs-lookup"><span data-stu-id="9f62d-209">This menu selection adds the following code to the `using` statements near the top of the file.</span></span>

[!code-csharp[Main](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/samples/sample4.cs)]

> [!NOTE]
> <span data-ttu-id="9f62d-210">将代码添加到 `Seed` 方法是将固定数据插入数据库的多种方式之一。</span><span class="sxs-lookup"><span data-stu-id="9f62d-210">Adding code to the `Seed` method is one of many ways that you can insert fixed data into the database.</span></span> <span data-ttu-id="9f62d-211">一种替代方法是向每个迁移类的 `Up` 和 `Down` 方法中添加代码。</span><span class="sxs-lookup"><span data-stu-id="9f62d-211">An alternative is to add code to the `Up` and `Down` methods of each migration class.</span></span> <span data-ttu-id="9f62d-212">`Up` 和 `Down` 方法包含实现数据库更改的代码。</span><span class="sxs-lookup"><span data-stu-id="9f62d-212">The `Up` and `Down` methods contain code that implements database changes.</span></span> <span data-ttu-id="9f62d-213">在[部署数据库更新](deployment-to-a-hosting-provider-deploying-a-database-update-9-of-12.md)教程中，你将看到这些示例的示例。</span><span class="sxs-lookup"><span data-stu-id="9f62d-213">You'll see examples of them in the [Deploying a Database Update](deployment-to-a-hosting-provider-deploying-a-database-update-9-of-12.md) tutorial.</span></span>
> 
> <span data-ttu-id="9f62d-214">你还可以使用 `Sql` 方法编写执行 SQL 语句的代码。</span><span class="sxs-lookup"><span data-stu-id="9f62d-214">You can also write code that executes SQL statements by using the `Sql` method.</span></span> <span data-ttu-id="9f62d-215">例如，如果您将某一预算列添加到部门表中，并且想要将所有部门预算初始化为 $1000.00，作为迁移的一部分，您可以将以下代码行添加到该迁移的 `Up` 方法中：</span><span class="sxs-lookup"><span data-stu-id="9f62d-215">For example, if you were adding a Budget column to the Department table and wanted to initialize all department budgets to $1,000.00 as part of a migration, you could add the following line of code to the `Up` method for that migration:</span></span>
> 
> `Sql("UPDATE Department SET Budget = 1000");`
> 
> <span data-ttu-id="9f62d-216">本教程中显示的此示例使用 Code First 迁移 `Configuration` 类的 `Seed` 方法中的 `AddOrUpdate` 方法。</span><span class="sxs-lookup"><span data-stu-id="9f62d-216">This example shown for this tutorial uses the `AddOrUpdate` method in the `Seed` method of the Code First Migrations `Configuration` class.</span></span> <span data-ttu-id="9f62d-217">Code First 迁移将在每次迁移后调用 `Seed` 方法，此方法将更新已插入的行，如果它们尚不存在，则将其插入。</span><span class="sxs-lookup"><span data-stu-id="9f62d-217">Code First Migrations calls the `Seed` method after every migration, and this method updates rows that have already been inserted, or inserts them if they don't exist yet.</span></span> <span data-ttu-id="9f62d-218">对于你的方案，`AddOrUpdate` 方法可能不是最佳选择。</span><span class="sxs-lookup"><span data-stu-id="9f62d-218">The `AddOrUpdate` method might not be the best choice for your scenario.</span></span> <span data-ttu-id="9f62d-219">有关详细信息，请参阅 Julie Lerman 的博客上的[EF 4.3 AddOrUpdate 方法](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-219">For more information, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

<span data-ttu-id="9f62d-220">按 CTRL-SHIFT-B 生成项目。</span><span class="sxs-lookup"><span data-stu-id="9f62d-220">Press CTRL-SHIFT-B to build the project.</span></span>

<span data-ttu-id="9f62d-221">下一步是创建用于初始迁移的 `DbMigration` 类。</span><span class="sxs-lookup"><span data-stu-id="9f62d-221">The next step is to create a `DbMigration` class for the initial migration.</span></span> <span data-ttu-id="9f62d-222">希望此迁移创建新的数据库，因此必须删除已存在的数据库。</span><span class="sxs-lookup"><span data-stu-id="9f62d-222">You want this migration to create a new database, so you have to delete the database that already exists.</span></span> <span data-ttu-id="9f62d-223">SQL Server Compact 数据库包含在*应用\_Data*文件夹中的 *.sdf*文件中。</span><span class="sxs-lookup"><span data-stu-id="9f62d-223">SQL Server Compact databases are contained in *.sdf* files in the *App\_Data* folder.</span></span> <span data-ttu-id="9f62d-224">在**解决方案资源管理器**中，展开 "ContosoUniversity" 项目中的 "*应用\_数据*" 以查看两个 SQL Server Compact 数据库，这些数据库由 *.sdf*文件表示。</span><span class="sxs-lookup"><span data-stu-id="9f62d-224">In **Solution Explorer**, expand *App\_Data* in the ContosoUniversity project to see the two SQL Server Compact databases, which are represented by *.sdf* files.</span></span>

<span data-ttu-id="9f62d-225">右键单击 " *School .sdf* " 文件，然后单击 "**删除**"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-225">Right-click the *School.sdf* file and click **Delete**.</span></span>

![sdf_files_in_Solution_Explorer](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image10.png)

<span data-ttu-id="9f62d-227">在 "**程序包管理器控制台**" 窗口中，输入 "添加迁移初始" 命令以创建初始迁移，并将其命名为 "初始"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-227">In the **Package Manager Console** window, enter the command "add-migration Initial" to create the initial migration and name it "Initial".</span></span>

![add-migration_command](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image11.png)

<span data-ttu-id="9f62d-229">Code First 迁移在 "*迁移*" 文件夹中创建另一个类文件，此类包含用于创建数据库架构的代码。</span><span class="sxs-lookup"><span data-stu-id="9f62d-229">Code First Migrations creates another class file in the *Migrations* folder, and this class contains code that creates the database schema.</span></span>

<span data-ttu-id="9f62d-230">在 "**程序包管理器控制台**" 中，输入命令 "更新数据库" 以创建数据库并运行**Seed**方法。</span><span class="sxs-lookup"><span data-stu-id="9f62d-230">In the **Package Manager Console**, enter the command "update-database" to create the database and run the **Seed** method.</span></span>

![update-database_command](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image12.png)

<span data-ttu-id="9f62d-232">（如果您收到一条错误消息，指示表已存在并且无法创建，则可能是您在删除数据库之后和执行 `update-database`之前运行了该应用程序。</span><span class="sxs-lookup"><span data-stu-id="9f62d-232">(If you get an error that indicates a table already exists and can't be created, it is probably because you ran the application after you deleted the database and before you executed `update-database`.</span></span> <span data-ttu-id="9f62d-233">在这种情况下，再次删除*School .sdf*文件，然后重试 `update-database` 命令。）</span><span class="sxs-lookup"><span data-stu-id="9f62d-233">In that case, delete the *School.sdf* file again and retry the `update-database` command.)</span></span>

<span data-ttu-id="9f62d-234">运行该应用程序。</span><span class="sxs-lookup"><span data-stu-id="9f62d-234">Run the application.</span></span> <span data-ttu-id="9f62d-235">现在，学生页面为空，但讲师页面包含指导员。</span><span class="sxs-lookup"><span data-stu-id="9f62d-235">Now the Students page is empty but the Instructors page contains instructors.</span></span> <span data-ttu-id="9f62d-236">这是在部署应用程序后将在生产中获得的内容。</span><span class="sxs-lookup"><span data-stu-id="9f62d-236">This is what you will get in production after you deploy the application.</span></span>

![Empty_Students_page](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image13.png)

![Instructors_page_after_initial_migration](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image14.png)

<span data-ttu-id="9f62d-239">项目现已准备好部署*School*数据库。</span><span class="sxs-lookup"><span data-stu-id="9f62d-239">The project is now ready to deploy the *School* database.</span></span>

## <a name="creating-a-membership-database-for-deployment"></a><span data-ttu-id="9f62d-240">为部署创建成员资格数据库</span><span class="sxs-lookup"><span data-stu-id="9f62d-240">Creating a Membership Database for Deployment</span></span>

<span data-ttu-id="9f62d-241">Contoso 大学应用程序使用 ASP.NET 成员资格系统和 forms 身份验证对用户进行身份验证和授权。</span><span class="sxs-lookup"><span data-stu-id="9f62d-241">The Contoso University application uses the ASP.NET membership system and forms authentication to authenticate and authorize users.</span></span> <span data-ttu-id="9f62d-242">只有管理员才能访问其中一个页面。</span><span class="sxs-lookup"><span data-stu-id="9f62d-242">One of its pages is accessible only to administrators.</span></span> <span data-ttu-id="9f62d-243">若要查看此页，请运行应用程序，并从 "**课程**" 下的弹出菜单中选择 "**更新信用**"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-243">To see this page, run the application and select **Update Credits** from the flyout menu under **Courses**.</span></span> <span data-ttu-id="9f62d-244">应用程序将显示 "**登录**" 页，因为只有管理员有权使用 "**更新信用额度**" 页。</span><span class="sxs-lookup"><span data-stu-id="9f62d-244">The application displays the **Log In** page, because only administrators are authorized to use the **Update Credits** page.</span></span>

<span data-ttu-id="9f62d-245">[![Log_in_page](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image16.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="9f62d-245">[![Log_in_page](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image16.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image15.png)</span></span>

<span data-ttu-id="9f62d-246">使用密码 "Pas $ w0rd" 以 "管理员" 身份登录（请注意，"w0rd" 中的字母 "o" 的位置数字为零）。</span><span class="sxs-lookup"><span data-stu-id="9f62d-246">Log in as "admin" using the password "Pas$w0rd" (notice the number zero in place of the letter "o" in "w0rd").</span></span> <span data-ttu-id="9f62d-247">登录后，将显示 "**更新信用额度**" 页。</span><span class="sxs-lookup"><span data-stu-id="9f62d-247">After you log in, the **Update Credits** page is displayed.</span></span>

<span data-ttu-id="9f62d-248">[![Update_Credits_page](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image18.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="9f62d-248">[![Update_Credits_page](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image18.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image17.png)</span></span>

<span data-ttu-id="9f62d-249">首次部署站点时，通常会排除你为测试创建的大多数或所有用户帐户。</span><span class="sxs-lookup"><span data-stu-id="9f62d-249">When you deploy a site for the first time, it is common to exclude most or all of the user accounts you create for testing.</span></span> <span data-ttu-id="9f62d-250">在这种情况下，你将部署一个管理员帐户，而不是用户帐户。</span><span class="sxs-lookup"><span data-stu-id="9f62d-250">In this case, you'll deploy an administrator account and no user accounts.</span></span> <span data-ttu-id="9f62d-251">不是手动删除测试帐户，而是创建一个新的成员资格数据库，该数据库只具有在生产中需要的一个管理员用户帐户。</span><span class="sxs-lookup"><span data-stu-id="9f62d-251">Rather than manually deleting test accounts, you'll create a new membership database that has only the one administrator user account that you need in production.</span></span>

> [!NOTE]
> <span data-ttu-id="9f62d-252">成员资格数据库存储帐户密码的哈希。</span><span class="sxs-lookup"><span data-stu-id="9f62d-252">The membership database stores a hash of account passwords.</span></span> <span data-ttu-id="9f62d-253">若要从一台计算机向另一台计算机部署帐户，必须确保在目标服务器上哈希例程不会生成不同于源计算机的哈希。</span><span class="sxs-lookup"><span data-stu-id="9f62d-253">In order to deploy accounts from one machine to another, you must make sure that hashing routines don't generate different hashes on the destination server than they do on the source computer.</span></span> <span data-ttu-id="9f62d-254">当你使用 ASP.NET 通用提供程序时，只要不更改默认算法，它们就会生成相同的哈希。</span><span class="sxs-lookup"><span data-stu-id="9f62d-254">They will generate the same hashes when you use the ASP.NET Universal Providers, as long as you don't change the default algorithm.</span></span> <span data-ttu-id="9f62d-255">默认算法是 HMACSHA256，它是在 web.config 文件中 **[machineKey](https://msdn.microsoft.com/library/w8h3skw9.aspx)** 元素的**验证**特性中指定的。</span><span class="sxs-lookup"><span data-stu-id="9f62d-255">The default algorithm is HMACSHA256 and is specified in the **validation** attribute of the **[machineKey](https://msdn.microsoft.com/library/w8h3skw9.aspx)** element in the Web.config file.</span></span>

<span data-ttu-id="9f62d-256">成员资格数据库不是由 Code First 迁移维护的，并且没有自动初始值设定项，它将数据库与测试帐户（如 School 数据库）进行种子设定。</span><span class="sxs-lookup"><span data-stu-id="9f62d-256">The membership database is not maintained by Code First Migrations, and there is no automatic initializer that seeds the database with test accounts (as there is for the School database).</span></span> <span data-ttu-id="9f62d-257">因此，为了使测试数据可用，在创建新的测试数据库之前，将创建一个测试数据库的副本。</span><span class="sxs-lookup"><span data-stu-id="9f62d-257">Therefore, to keep test data available you'll make a copy of the test database before you create a new one.</span></span>

<span data-ttu-id="9f62d-258">在**解决方案资源管理器**中，将*应用\_Data*文件夹中的*aspnet .Sdf*文件重命名为*aspnet-Dev*。</span><span class="sxs-lookup"><span data-stu-id="9f62d-258">In **Solution Explorer**, rename the *aspnet.sdf* file in the *App\_Data* folder to *aspnet-Dev.sdf*.</span></span> <span data-ttu-id="9f62d-259">（不要制作副本，只需重命名即可，稍后会创建一个新数据库。）</span><span class="sxs-lookup"><span data-stu-id="9f62d-259">(Don't make a copy, just rename it — you'll create a new database in a moment.)</span></span>

<span data-ttu-id="9f62d-260">在**解决方案资源管理器**中，确保选中 web 项目（ContosoUniversity，而不是 ContosoUniversity）。</span><span class="sxs-lookup"><span data-stu-id="9f62d-260">In **Solution Explorer**, make sure that the web project (ContosoUniversity, not ContosoUniversity.DAL) is selected.</span></span> <span data-ttu-id="9f62d-261">然后，在 "**项目**" 菜单中，选择 " **ASP.NET 配置**" 以运行**网站管理工具**（哪些）。</span><span class="sxs-lookup"><span data-stu-id="9f62d-261">Then in the **Project** menu, select **ASP.NET Configuration** to run the **Web Site Administration Tool**(WAT).</span></span>

<span data-ttu-id="9f62d-262">选择“安全性”选项卡。</span><span class="sxs-lookup"><span data-stu-id="9f62d-262">Select the **Security** tab.</span></span>

<span data-ttu-id="9f62d-263">[![WAT_Security_tab](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image20.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="9f62d-263">[![WAT_Security_tab](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image20.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image19.png)</span></span>

<span data-ttu-id="9f62d-264">单击 "**创建或管理角色**" 并添加**管理员**角色。</span><span class="sxs-lookup"><span data-stu-id="9f62d-264">Click **Create or Manage Roles** and add an **Administrator** role.</span></span>

<span data-ttu-id="9f62d-265">[![WAT_Create_New_Role](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image22.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="9f62d-265">[![WAT_Create_New_Role](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image22.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image21.png)</span></span>

<span data-ttu-id="9f62d-266">向后导航到 "**安全**" 选项卡，单击 "**创建用户**"，并以管理员身份添加用户 "管理员"。</span><span class="sxs-lookup"><span data-stu-id="9f62d-266">Navigate back to the **Security** tab, click **Create User**, and add user "admin" as an administrator.</span></span> <span data-ttu-id="9f62d-267">在单击 "**创建用户**" 页上的 "**创建用户**" 按钮之前，请确保选中 "**管理员**" 复选框。</span><span class="sxs-lookup"><span data-stu-id="9f62d-267">Before you click the **Create User** button on the **Create User** page, make sure that you select the **Administrator** check box.</span></span> <span data-ttu-id="9f62d-268">本教程中使用的密码是 "Pas $ w0rd"，你可以输入任何电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="9f62d-268">The password used in this tutorial is "Pas$w0rd", and you can enter any email address.</span></span>

<span data-ttu-id="9f62d-269">[![WAT_Create_User](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image24.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="9f62d-269">[![WAT_Create_User](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image24.png)](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image23.png)</span></span>

<span data-ttu-id="9f62d-270">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="9f62d-270">Close the browser.</span></span> <span data-ttu-id="9f62d-271">在**解决方案资源管理器**中，单击 "刷新" 按钮以查看新的*aspnet .sdf*文件。</span><span class="sxs-lookup"><span data-stu-id="9f62d-271">In **Solution Explorer**, click the refresh button to see the new *aspnet.sdf* file.</span></span>

![New_aspnet.sdf_in_Solution_Explorer](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image25.png)

<span data-ttu-id="9f62d-273">右键**单击 "** "，然后选择 **"包括在项目中"** 。</span><span class="sxs-lookup"><span data-stu-id="9f62d-273">Right-click **aspnet.sdf** and select **Include in Project**.</span></span>

## <a name="distinguishing-development-from-production-databases"></a><span data-ttu-id="9f62d-274">与生产数据库的开发区分开来</span><span class="sxs-lookup"><span data-stu-id="9f62d-274">Distinguishing Development from Production Databases</span></span>

<span data-ttu-id="9f62d-275">在本部分中，您将重命名数据库，使开发版本为 School-Dev 和 aspnet-Dev，并且生产版本为 School-Prod 和 aspnet-Prod。</span><span class="sxs-lookup"><span data-stu-id="9f62d-275">In this section, you'll rename the databases so that the development versions are School-Dev.sdf and aspnet-Dev.sdf and the production versions are School-Prod.sdf and aspnet-Prod.sdf.</span></span> <span data-ttu-id="9f62d-276">这并不是必需的，但这样做将有助于使你无法获取数据库的测试版本和生产版本。</span><span class="sxs-lookup"><span data-stu-id="9f62d-276">This isn't necessary, but doing so will help keep you from getting test and production versions of the databases confused.</span></span>

<span data-ttu-id="9f62d-277">在**解决方案资源管理器**中，单击 "**刷新**"，然后展开 "应用\_数据" 文件夹以查看之前创建的 School 数据库;右键单击该项目，然后选择 **"包括在项目中"** 。</span><span class="sxs-lookup"><span data-stu-id="9f62d-277">In **Solution Explorer**, click **Refresh** and expand the App\_Data folder to see the School database that you created earlier; right-click it and select **Include in project**.</span></span>

![Including_School.sdf_in_project](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/_static/image26.png)

<span data-ttu-id="9f62d-279">将*aspnet .sdf*重命名为*aspnet-Prod*。</span><span class="sxs-lookup"><span data-stu-id="9f62d-279">Rename *aspnet.sdf* to *aspnet-Prod.sdf*.</span></span>

<span data-ttu-id="9f62d-280">将*School*重命名为*School-Dev*。</span><span class="sxs-lookup"><span data-stu-id="9f62d-280">Rename *School.sdf* to *School-Dev.sdf*.</span></span>

<span data-ttu-id="9f62d-281">当你在 Visual Studio 中运行应用程序时，不希望使用数据库文件的*生产*版本，你需要使用 *-Dev*版本。</span><span class="sxs-lookup"><span data-stu-id="9f62d-281">When you run the application in Visual Studio you don't want to use the *-Prod* versions of the database files, you want to use *-Dev* versions.</span></span> <span data-ttu-id="9f62d-282">因此，您必须更改 Web.config 文件中的连接字符串，以使其指向数据库的*开发*版本。</span><span class="sxs-lookup"><span data-stu-id="9f62d-282">Therefore you have to change the connection strings in the Web.config file so that they point to the *-Dev* versions of the databases.</span></span> <span data-ttu-id="9f62d-283">（您尚未创建 School-Prod 文件，但这是正常的，因为 Code First 在您首次运行应用程序时，会在生产环境中创建该数据库。）</span><span class="sxs-lookup"><span data-stu-id="9f62d-283">(You haven't created a School-Prod.sdf file, but that's OK because Code First will create that database in production the first time you run your app there.)</span></span>

<span data-ttu-id="9f62d-284">打开应用程序的 web.config 文件，然后找到连接字符串：</span><span class="sxs-lookup"><span data-stu-id="9f62d-284">Open the application Web.config file, and locate the connection strings:</span></span>

[!code-xml[Main](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/samples/sample5.xml)]

<span data-ttu-id="9f62d-285">将 "aspnet .sdf" 更改为 "aspnet-Dev"，并将 "School .sdf" 改为 "School-Dev"：</span><span class="sxs-lookup"><span data-stu-id="9f62d-285">Change "aspnet.sdf" to "aspnet-Dev.sdf", and change "School.sdf" to "School-Dev.sdf":</span></span>

[!code-xml[Main](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12/samples/sample6.xml?highlight=4-5)]

<span data-ttu-id="9f62d-286">现在可以部署 SQL Server Compact 数据库引擎和两个数据库。</span><span class="sxs-lookup"><span data-stu-id="9f62d-286">The SQL Server Compact database engine and both databases are now ready to be deployed.</span></span> <span data-ttu-id="9f62d-287">在以下教程中，您将为开发、测试和生产环境中必须不同的设置*设置自动 web.config*文件转换。</span><span class="sxs-lookup"><span data-stu-id="9f62d-287">In the following tutorial you set up automatic *Web.config* file transformations for settings that must be different in the development, test, and production environments.</span></span> <span data-ttu-id="9f62d-288">（在必须更改的设置中是连接字符串，但稍后在创建发布配置文件时将设置这些更改。）</span><span class="sxs-lookup"><span data-stu-id="9f62d-288">(Among the settings that must be changed are the connection strings, but you'll set up those changes later when you create a publish profile.)</span></span>

## <a name="more-information"></a><span data-ttu-id="9f62d-289">详细信息</span><span class="sxs-lookup"><span data-stu-id="9f62d-289">More Information</span></span>

<span data-ttu-id="9f62d-290">有关 NuGet 的详细信息，请参阅通过 NuGet 和[Nuget 文档](http://docs.nuget.org/docs/start-here/overview)[管理项目库](https://msdn.microsoft.com/magazine/hh547106.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-290">For more information on NuGet, see [Manage Project Libraries with NuGet](https://msdn.microsoft.com/magazine/hh547106.aspx) and [NuGet Documentation](http://docs.nuget.org/docs/start-here/overview).</span></span> <span data-ttu-id="9f62d-291">如果你不想使用 NuGet，你将需要了解如何分析 NuGet 包，以确定它在安装时执行的操作。</span><span class="sxs-lookup"><span data-stu-id="9f62d-291">If you don't want to use NuGet, you'll need to learn how to analyze a NuGet package to determine what it does when it is installed.</span></span> <span data-ttu-id="9f62d-292">（例如，它可能配置*web.config*转换、将 PowerShell 脚本配置为在生成时运行，等等）若要详细了解 NuGet 的工作原理，请参阅特别是[创建和发布包](http://docs.nuget.org/docs/creating-packages/creating-and-publishing-a-package)、[配置文件和源代码转换](http://docs.nuget.org/docs/creating-packages/configuration-file-and-source-code-transformations)。</span><span class="sxs-lookup"><span data-stu-id="9f62d-292">(For example, it might configure *Web.config* transformations, configure PowerShell scripts to run at build time, etc.) To learn more about how NuGet works, see especially [Creating and Publishing a Package](http://docs.nuget.org/docs/creating-packages/creating-and-publishing-a-package) and [Configuration File and Source Code Transformations](http://docs.nuget.org/docs/creating-packages/configuration-file-and-source-code-transformations).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="9f62d-293">[上一页](deployment-to-a-hosting-provider-introduction-1-of-12.md)
> [下一页](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12.md)</span><span class="sxs-lookup"><span data-stu-id="9f62d-293">[Previous](deployment-to-a-hosting-provider-introduction-1-of-12.md)
[Next](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12.md)</span></span>
