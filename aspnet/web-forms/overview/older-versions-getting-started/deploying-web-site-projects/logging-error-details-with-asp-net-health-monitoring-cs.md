---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
title: ASP.NET 运行状况监视 (C#) 的日志记录错误详细信息 |Microsoft Docs
author: rick-anderson
description: Microsoft 的运行状况监控系统提供了简单且可自定义的方式记录各种 web 事件，包括未经处理的异常。 本教程介绍如何对...
ms.author: riande
ms.date: 06/09/2009
ms.assetid: b1abb452-642a-4ff3-8504-37b85590ff79
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
msc.type: authoredcontent
ms.openlocfilehash: 52b1aec577634dfb9fec7753e4f9b8bf46d159f0
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/09/2019
ms.locfileid: "59416254"
---
# <a name="logging-error-details-with-aspnet-health-monitoring-c"></a><span data-ttu-id="c9424-104">ASP.NET 运行状况监视的日志记录错误详细信息 (C#)</span><span class="sxs-lookup"><span data-stu-id="c9424-104">Logging Error Details with ASP.NET Health Monitoring (C#)</span></span>

<span data-ttu-id="c9424-105">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="c9424-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="c9424-106">[下载代码](http://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip)或[下载 PDF](http://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="c9424-106">[Download Code](http://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip) or [Download PDF](http://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)</span></span>

> <span data-ttu-id="c9424-107">Microsoft 的运行状况监控系统提供了简单且可自定义的方式记录各种 web 事件，包括未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c9424-107">Microsoft's health monitoring system provides an easy and customizable way to log various web events, including unhandled exceptions.</span></span> <span data-ttu-id="c9424-108">本教程将指导完成未经处理的异常记录到数据库并通知通过电子邮件的开发人员设置运行状况监控系统。</span><span class="sxs-lookup"><span data-stu-id="c9424-108">This tutorial walks through setting up the health monitoring system to log unhandled exceptions to a database and to notify developers via an email message.</span></span>


## <a name="introduction"></a><span data-ttu-id="c9424-109">介绍</span><span class="sxs-lookup"><span data-stu-id="c9424-109">Introduction</span></span>

<span data-ttu-id="c9424-110">日志记录是一个有用的工具用于监视部署的应用程序的运行状况和诊断可能会出现任何问题。</span><span class="sxs-lookup"><span data-stu-id="c9424-110">Logging is a useful tool for monitoring the health of a deployed application and for diagnosing any problems that may arise.</span></span> <span data-ttu-id="c9424-111">特别是，务必记录发生在已部署的应用程序中，以便它们可以纠正的错误。</span><span class="sxs-lookup"><span data-stu-id="c9424-111">It is especially important to log errors that occur in a deployed application so that they can be remedied.</span></span> <span data-ttu-id="c9424-112">`Error` ASP.NET 应用程序; 中出现未处理的异常时将引发事件[前面的教程](processing-unhandled-exceptions-cs.md)介绍了如何通知错误的开发人员并通过创建的事件处理程序记录其详细信息`Error`事件。</span><span class="sxs-lookup"><span data-stu-id="c9424-112">The `Error` event is raised whenever an unhandled exception occurs in an ASP.NET application; the [preceding tutorial](processing-unhandled-exceptions-cs.md) showed how to notify a developer of an error and log its details by creating an event handler for the `Error` event.</span></span> <span data-ttu-id="c9424-113">但是，创建`Error`事件处理程序来记录错误的详细信息并通知开发人员是不必要的因为可以由 ASP 执行此任务。NET 的*运行状况监控系统*。</span><span class="sxs-lookup"><span data-stu-id="c9424-113">However, creating an `Error` event handler to log the error's details and notify a developer is unnecessary, as this task can be performed by ASP.NET's *health monitoring system*.</span></span>

<span data-ttu-id="c9424-114">运行状况监控系统在 ASP.NET 2.0 中引入，它旨在监视已部署的 ASP.NET 应用程序的运行状况，通过在应用程序或请求的生存期期间发生的日志记录事件。</span><span class="sxs-lookup"><span data-stu-id="c9424-114">The health monitoring system was introduced in ASP.NET 2.0 and is designed to monitor the health of a deployed ASP.NET application by logging events that occur during the application or request's lifetime.</span></span> <span data-ttu-id="c9424-115">记录运行状况监控系统的事件嘿 *运行状况监视事件*或*Web 事件*，并且包括：</span><span class="sxs-lookup"><span data-stu-id="c9424-115">The events logged by the health monitoring system are referred to as *health monitoring events* or *Web events*, and include:</span></span>

- <span data-ttu-id="c9424-116">应用程序生存期事件，例如当应用程序启动或停止</span><span class="sxs-lookup"><span data-stu-id="c9424-116">Application lifetime events, such as when an application starts or stops</span></span>
- <span data-ttu-id="c9424-117">安全事件，其中包括登录尝试失败和失败的 URL 授权请求</span><span class="sxs-lookup"><span data-stu-id="c9424-117">Security events, including failed login attempts and failed URL authorization requests</span></span>
- <span data-ttu-id="c9424-118">应用程序错误，包括未经处理的异常，异常、 请求验证异常和其他类型的错误中的编译错误，分析的视图状态。</span><span class="sxs-lookup"><span data-stu-id="c9424-118">Application errors, including unhandled exceptions, view state parsing exceptions, request validation exceptions, and compilation errors, among other types of errors.</span></span>

<span data-ttu-id="c9424-119">当运行状况监视事件引发时它可以记录到任意数量的指定*日志源*。</span><span class="sxs-lookup"><span data-stu-id="c9424-119">When a health monitoring event is raised it can be logged to any number of specified *log sources*.</span></span> <span data-ttu-id="c9424-120">运行状况监控系统附带 Web 事件记录到 Windows 事件日志中，或通过电子邮件，其他项中的 Microsoft SQL Server 数据库的日志源。</span><span class="sxs-lookup"><span data-stu-id="c9424-120">The health monitoring system ships with log sources that log Web events to a Microsoft SQL Server database, to the Windows Event Log, or via an email message, among others.</span></span> <span data-ttu-id="c9424-121">此外可以创建自己的日志源。</span><span class="sxs-lookup"><span data-stu-id="c9424-121">You can also create your own log sources.</span></span>

<span data-ttu-id="c9424-122">中定义的事件日志的运行状况监控系统，以及使用，日志源`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="c9424-122">The events the health monitoring system logs, along with the log sources used, are defined in `Web.config`.</span></span> <span data-ttu-id="c9424-123">借助几行配置标记可以使用运行状况监视所有未经处理的异常记录到数据库并通知你通过电子邮件的异常。</span><span class="sxs-lookup"><span data-stu-id="c9424-123">With a few lines of configuration markup you can use health monitoring to log all unhandled exceptions to a database and to notify you of the exception via email.</span></span>

## <a name="exploring-the-health-monitoring-systems-configuration"></a><span data-ttu-id="c9424-124">探索的运行状况监视系统的配置</span><span class="sxs-lookup"><span data-stu-id="c9424-124">Exploring the Health Monitoring System's Configuration</span></span>

<span data-ttu-id="c9424-125">运行状况监视系统的行为由其配置信息，它位于[`<healthMonitoring>`元素](https://msdn.microsoft.com/library/2fwh2ss9.aspx)中`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="c9424-125">The health monitoring system's behavior is defined by its configuration information, which is located in the [`<healthMonitoring>` element](https://msdn.microsoft.com/library/2fwh2ss9.aspx) in `Web.config`.</span></span> <span data-ttu-id="c9424-126">此外，此配置节定义信息的以下 3 个重要部分：</span><span class="sxs-lookup"><span data-stu-id="c9424-126">This configuration section defines, among other things, the following three important pieces of information:</span></span>

1. <span data-ttu-id="c9424-127">运行状况监视事件，当引发时，应记录</span><span class="sxs-lookup"><span data-stu-id="c9424-127">The health monitoring events that, when raised, should be logged,</span></span>
2. <span data-ttu-id="c9424-128">日志源和</span><span class="sxs-lookup"><span data-stu-id="c9424-128">The log sources, and</span></span>
3. <span data-ttu-id="c9424-129">如何将每个运行状况监视事件 (1) 中定义映射到的日志源中 (2) 定义。</span><span class="sxs-lookup"><span data-stu-id="c9424-129">How each health monitoring event defined in (1) is mapped to the log sources defined in (2).</span></span>

<span data-ttu-id="c9424-130">通过三个子配置元素指定此信息： [ `<eventMappings>` ](https://msdn.microsoft.com/library/yc5yk01w.aspx)， [ `<providers>` ](https://msdn.microsoft.com/library/zaa41kz1.aspx)，以及[ `<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx)分别。</span><span class="sxs-lookup"><span data-stu-id="c9424-130">This information is specified through three children configuration elements: [`<eventMappings>`](https://msdn.microsoft.com/library/yc5yk01w.aspx), [`<providers>`](https://msdn.microsoft.com/library/zaa41kz1.aspx), and [`<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx), respectively.</span></span>

<span data-ttu-id="c9424-131">默认运行状况监控系统配置信息可在`Web.config`文件中`%WINDIR%\Microsoft.NET\Framework\version\CONFIG`文件夹。</span><span class="sxs-lookup"><span data-stu-id="c9424-131">The default health monitoring system configuration information can be found in the `Web.config` file in `%WINDIR%\Microsoft.NET\Framework\version\CONFIG` folder.</span></span> <span data-ttu-id="c9424-132">此默认的配置信息，为简便起见，删除一些标记如下所示：</span><span class="sxs-lookup"><span data-stu-id="c9424-132">This default configuration information, with some markup removed for brevity, is shown below:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample1.xml)]

<span data-ttu-id="c9424-133">监视感兴趣的事件定义中的运行状况`<eventMappings>`元素，从而使运行状况监视事件的类用户友好名称。</span><span class="sxs-lookup"><span data-stu-id="c9424-133">The health monitoring events of interest are defined in the `<eventMappings>` element, which gives a human-friendly name to a class of health monitoring events.</span></span> <span data-ttu-id="c9424-134">在上面，标记`<eventMappings>`元素指定的用户友好名称"的所有错误"的运行状况监视事件的类型`WebBaseErrorEvent`和名称"失败审核"运行状况监视事件的类型为`WebFailureAuditEvent`。</span><span class="sxs-lookup"><span data-stu-id="c9424-134">In the markup above, the `<eventMappings>` element assigns the human-friendly name "All Errors" to the health monitoring events of type `WebBaseErrorEvent` and the name "Failure Audits" to health monitoring events of type `WebFailureAuditEvent`.</span></span>

<span data-ttu-id="c9424-135">`<providers>`元素定义为他们提供用户友好名称和指定的任何日志特定于源的配置信息的日志源。</span><span class="sxs-lookup"><span data-stu-id="c9424-135">The `<providers>` element defines the log sources, giving them a human-friendly name and specifying any log source-specific configuration information.</span></span> <span data-ttu-id="c9424-136">第一个`<add>`元素定义记录指定的运行状况监视事件使用的"EventLogProvider"提供程序`EventLogWebEventProvider`类。</span><span class="sxs-lookup"><span data-stu-id="c9424-136">The first `<add>` element defines the "EventLogProvider" provider, which logs the specified health monitoring events using the `EventLogWebEventProvider` class.</span></span> <span data-ttu-id="c9424-137">`EventLogWebEventProvider`类将事件记录到 Windows 事件日志。</span><span class="sxs-lookup"><span data-stu-id="c9424-137">The `EventLogWebEventProvider` class logs the event to the Windows Event Log.</span></span> <span data-ttu-id="c9424-138">第二个`<add>`元素定义事件记录到通过在 Microsoft SQL Server 数据库的"SqlWebEventProvider"提供程序`SqlWebEventProvider`类。</span><span class="sxs-lookup"><span data-stu-id="c9424-138">The second `<add>` element defines the "SqlWebEventProvider" provider, which logs events to a Microsoft SQL Server database via the `SqlWebEventProvider` class.</span></span> <span data-ttu-id="c9424-139">"SqlWebEventProvider"配置指定数据库的连接字符串 (`connectionStringName`) 以及其他配置选项。</span><span class="sxs-lookup"><span data-stu-id="c9424-139">The "SqlWebEventProvider" configuration specifies the database's connection string (`connectionStringName`) among other configuration options.</span></span>

<span data-ttu-id="c9424-140">`<rules>`元素将映射中指定的事件`<eventMappings>`元素中的日志源`<providers>`元素。</span><span class="sxs-lookup"><span data-stu-id="c9424-140">The `<rules>` element maps the events specified in the `<eventMappings>` element to log sources in the `<providers>` element.</span></span> <span data-ttu-id="c9424-141">默认情况下，ASP.NET web 应用程序记录所有未处理的异常和审核故障到 Windows 事件日志中。</span><span class="sxs-lookup"><span data-stu-id="c9424-141">By default, ASP.NET web applications log all unhandled exceptions and audit failures to the Windows Event Log.</span></span>

## <a name="logging-events-to-a-database"></a><span data-ttu-id="c9424-142">到数据库的日志记录事件</span><span class="sxs-lookup"><span data-stu-id="c9424-142">Logging Events to a Database</span></span>

<span data-ttu-id="c9424-143">运行状况监视系统的默认配置可以自定义基于 web 的应用程序的 web 应用程序通过添加`<healthMonitoring>`应用程序的部分`Web.config`文件。</span><span class="sxs-lookup"><span data-stu-id="c9424-143">The health monitoring system's default configuration can be customized on a web application-by-web application basis by adding a `<healthMonitoring>` section to the application's `Web.config` file.</span></span> <span data-ttu-id="c9424-144">可以包含其他元素中的`<eventMappings>`， `<providers>`，并`<rules>`部分中的，通过使用`<add>`元素。</span><span class="sxs-lookup"><span data-stu-id="c9424-144">You can include additional elements in the `<eventMappings>`, `<providers>`, and `<rules>` sections by using the `<add>` element.</span></span> <span data-ttu-id="c9424-145">若要删除设置默认配置，请使用从`<remove>`元素或使用`<clear />`从上述部分之一删除所有默认值。</span><span class="sxs-lookup"><span data-stu-id="c9424-145">To remove a setting from the default configuration use the `<remove>` element, or use `<clear />` to remove all default values from one of these sections.</span></span> <span data-ttu-id="c9424-146">让我们书评 web 应用程序配置为记录所有未经处理的异常到 Microsoft SQL Server 数据库使用`SqlWebEventProvider`类。</span><span class="sxs-lookup"><span data-stu-id="c9424-146">Let's configure the Book Reviews web application to log all unhandled exceptions to a Microsoft SQL Server database using the `SqlWebEventProvider` class.</span></span>

<span data-ttu-id="c9424-147">`SqlWebEventProvider`类是运行状况监控系统的一部分，并记录运行状况监视事件到指定的 SQL Server 数据库。</span><span class="sxs-lookup"><span data-stu-id="c9424-147">The `SqlWebEventProvider` class is part of the health monitoring system and logs a health monitoring event to a specified SQL Server database.</span></span> <span data-ttu-id="c9424-148">`SqlWebEventProvider`类期望指定的数据库包括一个名为的存储的过程`aspnet_WebEvent_LogEvent`。</span><span class="sxs-lookup"><span data-stu-id="c9424-148">The `SqlWebEventProvider` class expects that the specified database includes a stored procedure named `aspnet_WebEvent_LogEvent`.</span></span> <span data-ttu-id="c9424-149">此存储的过程传递事件的详细信息，肩负存储事件的详细信息。</span><span class="sxs-lookup"><span data-stu-id="c9424-149">This stored procedure is passed the details of the event and is tasked with storing the event details.</span></span> <span data-ttu-id="c9424-150">好消息是您不需要创建此存储过程，也不存储事件的详细信息的表。</span><span class="sxs-lookup"><span data-stu-id="c9424-150">The good news is that you do not need to create this stored procedure nor the table to store the event details.</span></span> <span data-ttu-id="c9424-151">可以将这些对象添加到你的数据库使用`aspnet_regsql.exe`工具。</span><span class="sxs-lookup"><span data-stu-id="c9424-151">You can add these objects to your database using the `aspnet_regsql.exe` tool.</span></span>

> [!NOTE]
> <span data-ttu-id="c9424-152">`aspnet_regsql.exe`工具已返回中所述[*配置网站，使用应用程序服务*教程](configuring-a-website-that-uses-application-services-cs.md)时，我们添加了对 ASP 支持。NET 的应用程序服务。</span><span class="sxs-lookup"><span data-stu-id="c9424-152">The `aspnet_regsql.exe` tool was discussed back in the [*Configuring a Website That Uses Application Services* tutorial](configuring-a-website-that-uses-application-services-cs.md) when we added support for ASP.NET's application services.</span></span> <span data-ttu-id="c9424-153">因此，书评网站的数据库已包含`aspnet_WebEvent_LogEvent`存储过程，将存储到名为的表的事件信息`aspnet_WebEvent_Events`。</span><span class="sxs-lookup"><span data-stu-id="c9424-153">Consequently, the Book Reviews website's database already contains the `aspnet_WebEvent_LogEvent` stored procedure, which stores the event information into a table named `aspnet_WebEvent_Events`.</span></span>


<span data-ttu-id="c9424-154">必需执行的存储的过程和表添加到你的数据库后，所有的就是以指示运行状况监视到数据库中记录所有未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c9424-154">Once you have the necessary stored procedure and table added to your database, all that remains is to instruct health monitoring to log all unhandled exceptions to the database.</span></span> <span data-ttu-id="c9424-155">完成此操作通过将以下标记添加到你的网站`Web.config`文件：</span><span class="sxs-lookup"><span data-stu-id="c9424-155">Accomplish this by adding the following markup to your website's `Web.config` file:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample2.xml)]

<span data-ttu-id="c9424-156">运行状况监视上面使用的配置标记`<clear />`擦除预定义的运行状况监视中的配置信息的元素`<eventMappings>`， `<providers>`，和`<rules>`部分。</span><span class="sxs-lookup"><span data-stu-id="c9424-156">The health monitoring configuration markup above uses `<clear />` elements to wipe the pre-defined health monitoring configuration information from the `<eventMappings>`, `<providers>`, and `<rules>` sections.</span></span> <span data-ttu-id="c9424-157">然后，它将单个条目添加到以下各节。</span><span class="sxs-lookup"><span data-stu-id="c9424-157">It then adds a single entry to each of these sections.</span></span>

- <span data-ttu-id="c9424-158">`<eventMappings>`元素定义单一的运行状况监视感兴趣的名为"所有"的错误时出现未处理的异常，将引发的事件。</span><span class="sxs-lookup"><span data-stu-id="c9424-158">The `<eventMappings>` element defines a single health monitoring event of interest named "All Errors", which is raised whenever an unhandled exception occurs.</span></span>
- <span data-ttu-id="c9424-159">`<providers>`元素定义一个名为"SqlWebEventProvider"使用的单个日志源`SqlWebEventProvider`类。</span><span class="sxs-lookup"><span data-stu-id="c9424-159">The `<providers>` element defines a single log source named "SqlWebEventProvider" that uses the `SqlWebEventProvider` class.</span></span> <span data-ttu-id="c9424-160">`connectionStringName`属性已设置为"ReviewsConnectionString"，是我们连接的名称中定义的字符串`<connectionStrings>`部分。</span><span class="sxs-lookup"><span data-stu-id="c9424-160">The `connectionStringName` attribute has been set to "ReviewsConnectionString", which is the name of our connection string defined in the `<connectionStrings>` section.</span></span>
- <span data-ttu-id="c9424-161">最后，&lt;规则&gt;元素指示的"所有错误"事件怎样时它应记录的使用"SqlWebEventProvider"提供程序。</span><span class="sxs-lookup"><span data-stu-id="c9424-161">Finally, the &lt;rules&gt; element indicates that when an "All Errors" event transpires that it should be logged using the "SqlWebEventProvider" provider.</span></span>

<span data-ttu-id="c9424-162">此配置信息指示运行状况监视系统到书评数据库记录所有未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c9424-162">This configuration information instructs the health monitoring system to log all unhandled exceptions to the Book Reviews database.</span></span>

> [!NOTE]
> <span data-ttu-id="c9424-163">`WebBaseErrorEvent`服务器错误只引发事件; 它不会引发 HTTP 错误，例如找不到的 ASP.NET 资源的请求。</span><span class="sxs-lookup"><span data-stu-id="c9424-163">The `WebBaseErrorEvent` event is only raised for server errors; it is not raised for HTTP errors, such as a request for an ASP.NET resource that is not found.</span></span> <span data-ttu-id="c9424-164">这不同于的行为`HttpApplication`类的`Error`事件，该服务器和 HTTP 错误引发事件。</span><span class="sxs-lookup"><span data-stu-id="c9424-164">This differs from the behavior of the `HttpApplication` class's `Error` event, which is raised for both server and HTTP errors.</span></span>


<span data-ttu-id="c9424-165">若要查看运行状况监视系统中操作，请访问网站和生成运行时错误，请访问`Genre.aspx?ID=foo`。</span><span class="sxs-lookup"><span data-stu-id="c9424-165">To see the health monitoring system in action, visit the website and generate a runtime error by visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="c9424-166">您会看到相应的错误页的异常详细信息黄色屏幕死机 （当访问本地） 或自定义错误页上 （当访问在生产环境中的站点）。</span><span class="sxs-lookup"><span data-stu-id="c9424-166">You should see the appropriate error page - either the Exception Details Yellow Screen of Death (when visiting locally) or the custom error page (when visiting the site in production).</span></span> <span data-ttu-id="c9424-167">在后台运行状况监控系统记录到数据库中的错误信息。</span><span class="sxs-lookup"><span data-stu-id="c9424-167">Behind the scenes, the health monitoring system logged the error information to the database.</span></span> <span data-ttu-id="c9424-168">应在一条记录`aspnet_WebEvent_Events`表 (请参阅**图 1**); 此记录包含有关刚刚发生运行时错误的信息。</span><span class="sxs-lookup"><span data-stu-id="c9424-168">There should be one record in the `aspnet_WebEvent_Events` table (see **Figure 1**); this record contains information about the runtime error that just occurred.</span></span>

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image2.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image1.png)

<span data-ttu-id="c9424-169">**图 1**:错误详细信息记录到`aspnet_WebEvent_Events`表</span><span class="sxs-lookup"><span data-stu-id="c9424-169">**Figure 1**: The Error Details Were Logged to the `aspnet_WebEvent_Events` Table</span></span>  
<span data-ttu-id="c9424-170">([单击此项可查看原尺寸图像](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="c9424-170">([Click to view full-size image](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png))</span></span>

### <a name="displaying-the-error-log-in-a-web-page"></a><span data-ttu-id="c9424-171">在网页中显示错误日志</span><span class="sxs-lookup"><span data-stu-id="c9424-171">Displaying the Error Log In a Web Page</span></span>

<span data-ttu-id="c9424-172">使用网站的当前配置运行状况监控系统数据库中记录所有未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c9424-172">With the website's current configuration, the health monitoring system logs all unhandled exceptions to the database.</span></span> <span data-ttu-id="c9424-173">但是，运行状况监视不提供任何机制来查看通过网页错误日志。</span><span class="sxs-lookup"><span data-stu-id="c9424-173">However, health monitoring does not provide any mechanism to view the error log through a web page.</span></span> <span data-ttu-id="c9424-174">但是，您可以构建 ASP.NET 页显示来自数据库的此信息。</span><span class="sxs-lookup"><span data-stu-id="c9424-174">However, you could build an ASP.NET page that displays this information from the database.</span></span> <span data-ttu-id="c9424-175">（我们将看到暂时不可用，您可以选择将发送给你的电子邮件中的错误详细信息。）</span><span class="sxs-lookup"><span data-stu-id="c9424-175">(As we'll see momentarily, you can opt to have the error details sent to you in an email message.)</span></span>

<span data-ttu-id="c9424-176">如果创建此类页时，请确保您采取措施来仅允许授权的用户以查看错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="c9424-176">If you create such a page, make sure you take steps to allow only authorized users to view the error details.</span></span> <span data-ttu-id="c9424-177">如果您的网站已部署了用户帐户，则可以使用 URL 授权规则来限制对页向特定用户或角色的访问。</span><span class="sxs-lookup"><span data-stu-id="c9424-177">If your site already employs user accounts then you can use URL authorization rules to restrict access to the page to certain users or roles.</span></span> <span data-ttu-id="c9424-178">有关如何授予或限制对网页根据登录用户的访问的详细信息，请参阅我[网站安全教程](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="c9424-178">For more information on how to grant or restrict access to web pages based on the logged in user, refer to my [Website Security Tutorials](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md).</span></span>

> [!NOTE]
> <span data-ttu-id="c9424-179">后续教程探讨了名为 ELMAH 备用错误日志记录和通知系统。</span><span class="sxs-lookup"><span data-stu-id="c9424-179">The subsequent tutorial explores an alternative error logging and notification system named ELMAH.</span></span> <span data-ttu-id="c9424-180">Elmah 却包含内置的机制来查看错误日志从这两个网页和 RSS 源的形式。</span><span class="sxs-lookup"><span data-stu-id="c9424-180">ELMAH includes a built-in mechanism to view the error log from both a web page and as an RSS feed.</span></span>


## <a name="logging-events-to-email"></a><span data-ttu-id="c9424-181">日志事件记录到电子邮件</span><span class="sxs-lookup"><span data-stu-id="c9424-181">Logging Events to Email</span></span>

<span data-ttu-id="c9424-182">运行状况监控系统包括到电子邮件"日志"事件日志源提供程序。</span><span class="sxs-lookup"><span data-stu-id="c9424-182">The health monitoring system includes a log source provider that "logs" an event to an email message.</span></span> <span data-ttu-id="c9424-183">日志源包含相同的信息记录到电子邮件正文中的数据库。</span><span class="sxs-lookup"><span data-stu-id="c9424-183">The log source includes the same information that is logged to the database in the email message body.</span></span> <span data-ttu-id="c9424-184">此日志源可用于在某个运行状况监视事件发生时通知开发人员。</span><span class="sxs-lookup"><span data-stu-id="c9424-184">You can use this log source to notify a developer when a certain health monitoring event occurs.</span></span>

<span data-ttu-id="c9424-185">让我们更新网站的配置，以便我们收到的电子邮件，无论异常何时发生书评。</span><span class="sxs-lookup"><span data-stu-id="c9424-185">Let's update the Book Reviews website's configuration so that we receive an email whenever an exception occurs.</span></span> <span data-ttu-id="c9424-186">若要实现此目的，我们需要执行三个任务：</span><span class="sxs-lookup"><span data-stu-id="c9424-186">To accomplish this we need to perform three tasks:</span></span>

1. <span data-ttu-id="c9424-187">配置 ASP.NET web 应用程序发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c9424-187">Configure the ASP.NET web application to send email.</span></span> <span data-ttu-id="c9424-188">这通过指定如何通过发送电子邮件实现`<system.net>`配置元素。</span><span class="sxs-lookup"><span data-stu-id="c9424-188">This is accomplished by specifying how email messages are sent via the `<system.net>` configuration element.</span></span> <span data-ttu-id="c9424-189">有关详细信息发送电子邮件中的 ASP.NET 应用程序的消息指[在 ASP.NET 中发送电子邮件](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)和[System.Net.Mail 常见问题解答](http://systemnetmail.com/)。</span><span class="sxs-lookup"><span data-stu-id="c9424-189">For more information on sending email messages in an ASP.NET application refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx) and the [System.Net.Mail FAQ](http://systemnetmail.com/).</span></span>
2. <span data-ttu-id="c9424-190">注册电子邮件日志源提供程序中的`<providers>`元素，并</span><span class="sxs-lookup"><span data-stu-id="c9424-190">Register the email log source provider in the `<providers>` element, and</span></span>
3. <span data-ttu-id="c9424-191">将条目添加到`<rules>`映射到在步骤 (2) 中添加的日志源提供程序的"所有错误"事件的元素。</span><span class="sxs-lookup"><span data-stu-id="c9424-191">Add an entry to the `<rules>` element that maps the "All Errors" event to the log source provider added in step (2).</span></span>

<span data-ttu-id="c9424-192">运行状况监控系统包括两个电子邮件日志源提供程序类：`SimpleMailWebEventProvider`和`TemplatedMailWebEventProvider`。</span><span class="sxs-lookup"><span data-stu-id="c9424-192">The health monitoring system includes two email log source provider classes: `SimpleMailWebEventProvider` and `TemplatedMailWebEventProvider`.</span></span> <span data-ttu-id="c9424-193">[ `SimpleMailWebEventProvider`类](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx)发送纯文本电子邮件消息，其中包含事件详细信息和提供的电子邮件正文的小自定义。</span><span class="sxs-lookup"><span data-stu-id="c9424-193">The [`SimpleMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx) sends a plain-text email message that includes the event details and provides little customization of the email body.</span></span> <span data-ttu-id="c9424-194">与[`TemplatedMailWebEventProvider`类](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx)指定 ASP.NET 页面的呈现的标记用作电子邮件正文。</span><span class="sxs-lookup"><span data-stu-id="c9424-194">With the [`TemplatedMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) you specify an ASP.NET page whose rendered markup is used as the body for the email message.</span></span> <span data-ttu-id="c9424-195">[ `TemplatedMailWebEventProvider`类](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx)可提供很好地控制更高版本的内容和格式的电子邮件，但需要更多前期工作，因为您必须创建生成电子邮件消息的正文的 ASP.NET 页。</span><span class="sxs-lookup"><span data-stu-id="c9424-195">The [`TemplatedMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) gives you much greater control over the contents and format of the email message, but requires a bit more upfront work as you have to create the ASP.NET page that generates the email message's body.</span></span> <span data-ttu-id="c9424-196">本教程重点介绍使用`SimpleMailWebEventProvider`类。</span><span class="sxs-lookup"><span data-stu-id="c9424-196">This tutorial focuses on using the `SimpleMailWebEventProvider` class.</span></span>

<span data-ttu-id="c9424-197">更新监视系统的运行状况`<providers>`中的元素`Web.config`文件以包含的日志源`SimpleMailWebEventProvider`类：</span><span class="sxs-lookup"><span data-stu-id="c9424-197">Update the health monitoring system's `<providers>` element in the `Web.config` file to include a log source for the `SimpleMailWebEventProvider` class:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample3.xml)]

<span data-ttu-id="c9424-198">上面的标记使用`SimpleMailWebEventProvider`类作为日志源提供程序，并将其分配的友好名称"EmailWebEventProvider"。</span><span class="sxs-lookup"><span data-stu-id="c9424-198">The above markup uses the `SimpleMailWebEventProvider` class as the log source provider, and assigns it the friendly name "EmailWebEventProvider".</span></span> <span data-ttu-id="c9424-199">此外，`<add>`属性包含其他配置选项，例如收件人和从电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="c9424-199">Moreover, the `<add>` attribute includes additional configuration options, such as the To and From addresses of the email message.</span></span>

<span data-ttu-id="c9424-200">与电子邮件日志源定义，剩下的就是以指示运行状况监视系统使用此源用于"记录"未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c9424-200">With the email log source defined, all that remains is to instruct the health monitoring system to use this source to "log" unhandled exceptions.</span></span> <span data-ttu-id="c9424-201">这通过添加新的规则中实现`<rules>`部分：</span><span class="sxs-lookup"><span data-stu-id="c9424-201">This is accomplished by adding a new rule in the `<rules>` section:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample4.xml)]

<span data-ttu-id="c9424-202">`<rules>`部分现在包括两个规则。</span><span class="sxs-lookup"><span data-stu-id="c9424-202">The `<rules>` section now includes two rules.</span></span> <span data-ttu-id="c9424-203">第一个名为"所有错误到电子邮件"，将所有未经处理的异常发送到"EmailWebEventProvider"日志源。</span><span class="sxs-lookup"><span data-stu-id="c9424-203">The first one, named "All Errors To Email", sends all unhandled exceptions to the "EmailWebEventProvider" log source.</span></span> <span data-ttu-id="c9424-204">此规则的效果在网站上的错误的详细信息发送到指定的地址。</span><span class="sxs-lookup"><span data-stu-id="c9424-204">This rule has the effect of sending details about errors on the website to the specified To address.</span></span> <span data-ttu-id="c9424-205">"到数据库的所有错误"规则的站点数据库中记录错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="c9424-205">The "All Errors To Database" rule logs the error details to the site's database.</span></span> <span data-ttu-id="c9424-206">因此，每当未处理的异常发生时在站点上其详细信息都记录到数据库并且发送到指定的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="c9424-206">Consequently, whenever an unhandled exception occurs on the site its details are both logged to the database and sent to specified email address.</span></span>

<span data-ttu-id="c9424-207">**图 2**显示了生成的电子邮件`SimpleMailWebEventProvider`类访问时`Genre.aspx?ID=foo`。</span><span class="sxs-lookup"><span data-stu-id="c9424-207">**Figure 2** shows the email generated by the `SimpleMailWebEventProvider` class when visiting `Genre.aspx?ID=foo`.</span></span>

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image5.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image4.png)

<span data-ttu-id="c9424-208">**图 2**:在电子邮件发送错误详细信息</span><span class="sxs-lookup"><span data-stu-id="c9424-208">**Figure 2**: The Error Details are Sent in an Email Message</span></span>  
<span data-ttu-id="c9424-209">([单击此项可查看原尺寸图像](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="c9424-209">([Click to view full-size image](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png))</span></span>

## <a name="summary"></a><span data-ttu-id="c9424-210">总结</span><span class="sxs-lookup"><span data-stu-id="c9424-210">Summary</span></span>

<span data-ttu-id="c9424-211">ASP.NET 运行状况监视系统，旨在允许管理员监视已部署的 web 应用程序的运行状况。</span><span class="sxs-lookup"><span data-stu-id="c9424-211">The ASP.NET health monitoring system is designed to allow administrators to monitor the health of a deployed web application.</span></span> <span data-ttu-id="c9424-212">当特定的操作，将展开，例如当应用程序停止时，当用户成功登录到站点，或发生未经处理的异常，则会引发运行状况监视事件。</span><span class="sxs-lookup"><span data-stu-id="c9424-212">Health monitoring events are raised when certain actions unfold, such as when the application stops, when a user successfully logs onto the site, or when an unhandled exception occurs.</span></span> <span data-ttu-id="c9424-213">这些事件可以记录到任意数量的日志源。</span><span class="sxs-lookup"><span data-stu-id="c9424-213">These events can be logged to any number of log sources.</span></span> <span data-ttu-id="c9424-214">本教程介绍了如何记录未处理异常的详细信息，到数据库并通过电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c9424-214">This tutorial showed how to log the details of unhandled exceptions to a database and through an email message.</span></span>

<span data-ttu-id="c9424-215">本教程侧重于使用运行状况监视记录未处理的异常，但请记住，运行状况监视用于度量已部署的 ASP.NET 应用程序的总体运行状况和包括丰富的运行状况监视事件和不日志源此处介绍了。</span><span class="sxs-lookup"><span data-stu-id="c9424-215">This tutorial focused on using health monitoring to log unhandled exceptions, but keep in mind that health monitoring is designed to measure the overall health of a deployed ASP.NET application and includes a wealth of health monitoring events and log sources not explored here.</span></span> <span data-ttu-id="c9424-216">更多的是什么，您可以创建自己的运行状况监视事件和日志源需要出现。</span><span class="sxs-lookup"><span data-stu-id="c9424-216">What's more, you can create your own health monitoring events and log sources, should the need arise.</span></span> <span data-ttu-id="c9424-217">如果您有兴趣学习有关运行状况监视的详细信息，很好的第一步是读取[Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)的[运行状况监视常见问题](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c9424-217">If you are interested in learning more about health monitoring, a good first step is to read through [Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)'s [health monitoring FAQ](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx).</span></span> <span data-ttu-id="c9424-218">接下来，请查阅[How To:使用 ASP.NET 2.0 中的运行状况监视](https://msdn.microsoft.com/library/ms998306.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c9424-218">Following that, consult [How To: Use Health Monitoring in ASP.NET 2.0](https://msdn.microsoft.com/library/ms998306.aspx).</span></span>

<span data-ttu-id="c9424-219">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="c9424-219">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="c9424-220">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="c9424-220">Further Reading</span></span>

<span data-ttu-id="c9424-221">在本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="c9424-221">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="c9424-222">ASP.NET 运行状况监视概述</span><span class="sxs-lookup"><span data-stu-id="c9424-222">ASP.NET Health Monitoring Overview</span></span>](https://msdn.microsoft.com/library/bb398933.aspx)
- [<span data-ttu-id="c9424-223">配置和自定义运行状况监视系统的 ASP.NET</span><span class="sxs-lookup"><span data-stu-id="c9424-223">Configuring and Customizing the Health Monitoring System of ASP.NET</span></span>](http://dotnetslackers.com/articles/aspnet/ConfiguringAndCustomizingTheHealthMonitoringSystemOfASPNET.aspx)
- [<span data-ttu-id="c9424-224">常见问题-ASP.NET 2.0 中监视的运行状况</span><span class="sxs-lookup"><span data-stu-id="c9424-224">FAQ - Health Monitoring in ASP.NET 2.0</span></span>](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)
- [<span data-ttu-id="c9424-225">如何：发送电子邮件运行状况监视通知</span><span class="sxs-lookup"><span data-stu-id="c9424-225">How To: Send E-Mail for Health Monitoring Notifications</span></span>](https://msdn.microsoft.com/library/ms227553.aspx)
- [<span data-ttu-id="c9424-226">如何：使用 ASP.NET 中的运行状况监视</span><span class="sxs-lookup"><span data-stu-id="c9424-226">How To: Use Health Monitoring in ASP.NET</span></span>](https://msdn.microsoft.com/library/ms998306.aspx)
- [<span data-ttu-id="c9424-227">在 ASP.NET 中监视的运行状况</span><span class="sxs-lookup"><span data-stu-id="c9424-227">Health Monitoring in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/031407-1.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="c9424-228">[上一页](processing-unhandled-exceptions-cs.md)
> [下一页](logging-error-details-with-elmah-cs.md)</span><span class="sxs-lookup"><span data-stu-id="c9424-228">[Previous](processing-unhandled-exceptions-cs.md)
[Next](logging-error-details-with-elmah-cs.md)</span></span>
