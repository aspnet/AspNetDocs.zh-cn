---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
title: 通过 ASP.NET 运行状况监视记录错误详细C#信息（） |Microsoft Docs
author: rick-anderson
description: Microsoft 的运行状况监视系统提供一种简单且可自定义的方式来记录各种 web 事件，包括未经处理的异常。 本教程将指导将 。
ms.author: riande
ms.date: 06/09/2009
ms.assetid: b1abb452-642a-4ff3-8504-37b85590ff79
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
msc.type: authoredcontent
ms.openlocfilehash: e52ed94f78d053701771690fce432d5a1d465b62
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74637273"
---
# <a name="logging-error-details-with-aspnet-health-monitoring-c"></a><span data-ttu-id="7fb9c-104">ASP.NET 运行状况监视的日志记录错误详细信息 (C#)</span><span class="sxs-lookup"><span data-stu-id="7fb9c-104">Logging Error Details with ASP.NET Health Monitoring (C#)</span></span>

<span data-ttu-id="7fb9c-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="7fb9c-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="7fb9c-106">[下载代码](https://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip)或[下载 PDF](https://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="7fb9c-106">[Download Code](https://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip) or [Download PDF](https://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)</span></span>

> <span data-ttu-id="7fb9c-107">Microsoft 的运行状况监视系统提供一种简单且可自定义的方式来记录各种 web 事件，包括未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-107">Microsoft's health monitoring system provides an easy and customizable way to log various web events, including unhandled exceptions.</span></span> <span data-ttu-id="7fb9c-108">本教程介绍如何设置运行状况监视系统，以将未经处理的异常记录到数据库，并通过电子邮件通知开发人员。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-108">This tutorial walks through setting up the health monitoring system to log unhandled exceptions to a database and to notify developers via an email message.</span></span>

## <a name="introduction"></a><span data-ttu-id="7fb9c-109">简介</span><span class="sxs-lookup"><span data-stu-id="7fb9c-109">Introduction</span></span>

<span data-ttu-id="7fb9c-110">日志记录是一种有用的工具，用于监视已部署应用程序的运行状况，并诊断可能出现的任何问题。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-110">Logging is a useful tool for monitoring the health of a deployed application and for diagnosing any problems that may arise.</span></span> <span data-ttu-id="7fb9c-111">尤其重要的是记录已部署的应用程序中发生的错误，以便可以对其进行修正。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-111">It is especially important to log errors that occur in a deployed application so that they can be remedied.</span></span> <span data-ttu-id="7fb9c-112">ASP.NET 应用程序中发生未经处理的异常时，将引发 `Error` 事件;[前面的教程](processing-unhandled-exceptions-cs.md)演示了如何通过为 `Error` 事件创建事件处理程序，通知开发人员出现错误并记录其详细信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-112">The `Error` event is raised whenever an unhandled exception occurs in an ASP.NET application; the [preceding tutorial](processing-unhandled-exceptions-cs.md) showed how to notify a developer of an error and log its details by creating an event handler for the `Error` event.</span></span> <span data-ttu-id="7fb9c-113">但是，创建一个 `Error` 事件处理程序来记录错误的详细信息并通知开发人员，这是不必要的，因为此任务可以由 ASP 执行。网络*运行状况监视系统*。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-113">However, creating an `Error` event handler to log the error's details and notify a developer is unnecessary, as this task can be performed by ASP.NET's *health monitoring system*.</span></span>

<span data-ttu-id="7fb9c-114">运行状况监视系统是在 ASP.NET 2.0 中引入的，旨在通过记录应用程序或请求生存期内发生的事件来监视已部署的 ASP.NET 应用程序的运行状况。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-114">The health monitoring system was introduced in ASP.NET 2.0 and is designed to monitor the health of a deployed ASP.NET application by logging events that occur during the application or request's lifetime.</span></span> <span data-ttu-id="7fb9c-115">运行状况监视系统记录的事件被称为*运行状况监视事件*或*Web 事件*，包括：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-115">The events logged by the health monitoring system are referred to as *health monitoring events* or *Web events*, and include:</span></span>

- <span data-ttu-id="7fb9c-116">应用程序生存期事件，例如当应用程序启动或停止时</span><span class="sxs-lookup"><span data-stu-id="7fb9c-116">Application lifetime events, such as when an application starts or stops</span></span>
- <span data-ttu-id="7fb9c-117">安全事件，包括登录尝试失败和失败的 URL 授权请求</span><span class="sxs-lookup"><span data-stu-id="7fb9c-117">Security events, including failed login attempts and failed URL authorization requests</span></span>
- <span data-ttu-id="7fb9c-118">应用程序错误，包括未经处理的异常、查看状态分析异常、请求验证异常、编译错误以及其他类型的错误。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-118">Application errors, including unhandled exceptions, view state parsing exceptions, request validation exceptions, and compilation errors, among other types of errors.</span></span>

<span data-ttu-id="7fb9c-119">当引发运行状况监视事件时，可以将其记录到任意数量的指定*日志源*中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-119">When a health monitoring event is raised it can be logged to any number of specified *log sources*.</span></span> <span data-ttu-id="7fb9c-120">运行状况监视系统附带日志源，用于将 Web 事件记录到 Microsoft SQL Server 数据库、Windows 事件日志或通过电子邮件发送给其他人。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-120">The health monitoring system ships with log sources that log Web events to a Microsoft SQL Server database, to the Windows Event Log, or via an email message, among others.</span></span> <span data-ttu-id="7fb9c-121">还可以创建自己的日志源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-121">You can also create your own log sources.</span></span>

<span data-ttu-id="7fb9c-122">运行状况监视系统日志以及使用的日志源的事件是在 `Web.config`中定义的。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-122">The events the health monitoring system logs, along with the log sources used, are defined in `Web.config`.</span></span> <span data-ttu-id="7fb9c-123">使用几行配置标记，您可以使用运行状况监视将所有未经处理的异常记录到数据库中，并通过电子邮件向您通知例外。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-123">With a few lines of configuration markup you can use health monitoring to log all unhandled exceptions to a database and to notify you of the exception via email.</span></span>

## <a name="exploring-the-health-monitoring-systems-configuration"></a><span data-ttu-id="7fb9c-124">了解运行状况监视系统的配置</span><span class="sxs-lookup"><span data-stu-id="7fb9c-124">Exploring the Health Monitoring System's Configuration</span></span>

<span data-ttu-id="7fb9c-125">运行状况监视系统的行为由其在 `Web.config`的[`<healthMonitoring>` 元素](https://msdn.microsoft.com/library/2fwh2ss9.aspx)中的配置信息定义。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-125">The health monitoring system's behavior is defined by its configuration information, which is located in the [`<healthMonitoring>` element](https://msdn.microsoft.com/library/2fwh2ss9.aspx) in `Web.config`.</span></span> <span data-ttu-id="7fb9c-126">此配置节定义了以下三个重要信息，其中包括：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-126">This configuration section defines, among other things, the following three important pieces of information:</span></span>

1. <span data-ttu-id="7fb9c-127">应记录引发时的运行状况监视事件，</span><span class="sxs-lookup"><span data-stu-id="7fb9c-127">The health monitoring events that, when raised, should be logged,</span></span>
2. <span data-ttu-id="7fb9c-128">日志源和</span><span class="sxs-lookup"><span data-stu-id="7fb9c-128">The log sources, and</span></span>
3. <span data-ttu-id="7fb9c-129">（1）中定义的每个运行状况监视事件如何映射到（2）中定义的日志源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-129">How each health monitoring event defined in (1) is mapped to the log sources defined in (2).</span></span>

<span data-ttu-id="7fb9c-130">此信息通过三个子配置元素来指定：分别[`<eventMappings>`](https://msdn.microsoft.com/library/yc5yk01w.aspx)、 [`<providers>`](https://msdn.microsoft.com/library/zaa41kz1.aspx)和[`<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx)。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-130">This information is specified through three children configuration elements: [`<eventMappings>`](https://msdn.microsoft.com/library/yc5yk01w.aspx), [`<providers>`](https://msdn.microsoft.com/library/zaa41kz1.aspx), and [`<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx), respectively.</span></span>

<span data-ttu-id="7fb9c-131">默认的运行状况监视系统配置信息可在 `%WINDIR%\Microsoft.NET\Framework\version\CONFIG` 文件夹中的 `Web.config` 文件中找到。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-131">The default health monitoring system configuration information can be found in the `Web.config` file in `%WINDIR%\Microsoft.NET\Framework\version\CONFIG` folder.</span></span> <span data-ttu-id="7fb9c-132">此默认配置信息（为了简洁起见，移除了一些标记）如下所示：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-132">This default configuration information, with some markup removed for brevity, is shown below:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample1.xml)]

<span data-ttu-id="7fb9c-133">相关的运行状况监视事件在 `<eventMappings>` 元素中定义，该元素向运行状况监视事件的类提供一个友好名称。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-133">The health monitoring events of interest are defined in the `<eventMappings>` element, which gives a human-friendly name to a class of health monitoring events.</span></span> <span data-ttu-id="7fb9c-134">在上面的标记中，`<eventMappings>` 元素将友好名称 "所有错误" 分配给类型为 `WebBaseErrorEvent` 的运行状况监视事件，并将名称 "失败审核" 分配给 `WebFailureAuditEvent`类型的运行状况监视事件。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-134">In the markup above, the `<eventMappings>` element assigns the human-friendly name "All Errors" to the health monitoring events of type `WebBaseErrorEvent` and the name "Failure Audits" to health monitoring events of type `WebFailureAuditEvent`.</span></span>

<span data-ttu-id="7fb9c-135">`<providers>` 元素定义日志源，为它们提供友好名称，并指定任何特定于日志源的配置信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-135">The `<providers>` element defines the log sources, giving them a human-friendly name and specifying any log source-specific configuration information.</span></span> <span data-ttu-id="7fb9c-136">第一个 `<add>` 元素定义 "EventLogProvider" 提供程序，该提供程序使用 `EventLogWebEventProvider` 类记录指定的运行状况监视事件。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-136">The first `<add>` element defines the "EventLogProvider" provider, which logs the specified health monitoring events using the `EventLogWebEventProvider` class.</span></span> <span data-ttu-id="7fb9c-137">`EventLogWebEventProvider` 类将事件记录到 Windows 事件日志中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-137">The `EventLogWebEventProvider` class logs the event to the Windows Event Log.</span></span> <span data-ttu-id="7fb9c-138">第二个 `<add>` 元素定义 "SqlWebEventProvider" 提供程序，该提供程序通过 `SqlWebEventProvider` 类将事件记录到 Microsoft SQL Server 数据库。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-138">The second `<add>` element defines the "SqlWebEventProvider" provider, which logs events to a Microsoft SQL Server database via the `SqlWebEventProvider` class.</span></span> <span data-ttu-id="7fb9c-139">"SqlWebEventProvider" 配置在其他配置选项中指定数据库的连接字符串（`connectionStringName`）。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-139">The "SqlWebEventProvider" configuration specifies the database's connection string (`connectionStringName`) among other configuration options.</span></span>

<span data-ttu-id="7fb9c-140">`<rules>` 元素将 `<eventMappings>` 元素中指定的事件映射到 `<providers>` 元素中的日志源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-140">The `<rules>` element maps the events specified in the `<eventMappings>` element to log sources in the `<providers>` element.</span></span> <span data-ttu-id="7fb9c-141">默认情况下，ASP.NET web 应用程序将所有未经处理的异常和审核失败记录到 Windows 事件日志中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-141">By default, ASP.NET web applications log all unhandled exceptions and audit failures to the Windows Event Log.</span></span>

## <a name="logging-events-to-a-database"></a><span data-ttu-id="7fb9c-142">将事件记录到数据库</span><span class="sxs-lookup"><span data-stu-id="7fb9c-142">Logging Events to a Database</span></span>

<span data-ttu-id="7fb9c-143">通过向应用程序的 `Web.config` 文件添加 `<healthMonitoring>` 部分，可以在 web 应用程序的基础上按 web 应用程序自定义运行状况监视系统的默认配置。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-143">The health monitoring system's default configuration can be customized on a web application-by-web application basis by adding a `<healthMonitoring>` section to the application's `Web.config` file.</span></span> <span data-ttu-id="7fb9c-144">您可以使用 `<add>` 元素在 `<eventMappings>`、`<providers>`和 `<rules>` 部分中包含其他元素。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-144">You can include additional elements in the `<eventMappings>`, `<providers>`, and `<rules>` sections by using the `<add>` element.</span></span> <span data-ttu-id="7fb9c-145">若要从默认配置中删除设置，请使用 `<remove>` 元素，或使用 `<clear />` 删除这些部分中的所有默认值。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-145">To remove a setting from the default configuration use the `<remove>` element, or use `<clear />` to remove all default values from one of these sections.</span></span> <span data-ttu-id="7fb9c-146">接下来，让我们将书籍评论 web 应用程序配置为使用 `SqlWebEventProvider` 类将所有未经处理的异常记录到 Microsoft SQL Server 数据库中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-146">Let's configure the Book Reviews web application to log all unhandled exceptions to a Microsoft SQL Server database using the `SqlWebEventProvider` class.</span></span>

<span data-ttu-id="7fb9c-147">`SqlWebEventProvider` 类是运行状况监视系统的一部分，它将运行状况监视事件记录到指定的 SQL Server 数据库。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-147">The `SqlWebEventProvider` class is part of the health monitoring system and logs a health monitoring event to a specified SQL Server database.</span></span> <span data-ttu-id="7fb9c-148">`SqlWebEventProvider` 类需要指定的数据库包含名为 `aspnet_WebEvent_LogEvent`的存储过程。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-148">The `SqlWebEventProvider` class expects that the specified database includes a stored procedure named `aspnet_WebEvent_LogEvent`.</span></span> <span data-ttu-id="7fb9c-149">此存储过程将传递事件的详细信息，并负责存储事件的详细信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-149">This stored procedure is passed the details of the event and is tasked with storing the event details.</span></span> <span data-ttu-id="7fb9c-150">好消息是不需要创建此存储过程，也不需要创建表来存储事件的详细信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-150">The good news is that you do not need to create this stored procedure nor the table to store the event details.</span></span> <span data-ttu-id="7fb9c-151">可以使用 `aspnet_regsql.exe` 工具将这些对象添加到数据库。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-151">You can add these objects to your database using the `aspnet_regsql.exe` tool.</span></span>

> [!NOTE]
> <span data-ttu-id="7fb9c-152">在[*配置使用应用程序服务*教程的网站时，将在配置使用教程的网站](configuring-a-website-that-uses-application-services-cs.md)上讨论 `aspnet_regsql.exe` 工具。网络的应用程序服务。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-152">The `aspnet_regsql.exe` tool was discussed back in the [*Configuring a Website That Uses Application Services* tutorial](configuring-a-website-that-uses-application-services-cs.md) when we added support for ASP.NET's application services.</span></span> <span data-ttu-id="7fb9c-153">因此，书籍检查网站的数据库已经包含 `aspnet_WebEvent_LogEvent` 存储过程，该存储过程将事件信息存储到名为 `aspnet_WebEvent_Events`的表中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-153">Consequently, the Book Reviews website's database already contains the `aspnet_WebEvent_LogEvent` stored procedure, which stores the event information into a table named `aspnet_WebEvent_Events`.</span></span>

<span data-ttu-id="7fb9c-154">将所需的存储过程和表添加到数据库后，剩下的就是指示运行状况监视将所有未经处理的异常记录到数据库中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-154">Once you have the necessary stored procedure and table added to your database, all that remains is to instruct health monitoring to log all unhandled exceptions to the database.</span></span> <span data-ttu-id="7fb9c-155">通过将以下标记添加到网站的 `Web.config` 文件来完成此操作：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-155">Accomplish this by adding the following markup to your website's `Web.config` file:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample2.xml)]

<span data-ttu-id="7fb9c-156">上面的运行状况监视配置标记使用 `<clear />` 元素从 `<eventMappings>`、`<providers>`和 `<rules>` 部分中擦除预定义的运行状况监视配置信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-156">The health monitoring configuration markup above uses `<clear />` elements to wipe the pre-defined health monitoring configuration information from the `<eventMappings>`, `<providers>`, and `<rules>` sections.</span></span> <span data-ttu-id="7fb9c-157">然后，它向其中每个部分添加一个条目。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-157">It then adds a single entry to each of these sections.</span></span>

- <span data-ttu-id="7fb9c-158">`<eventMappings>` 元素定义了一个名为 "所有错误" 的名为 "所有错误" 的运行状况监视事件，每当发生未处理的异常时都会引发该事件。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-158">The `<eventMappings>` element defines a single health monitoring event of interest named "All Errors", which is raised whenever an unhandled exception occurs.</span></span>
- <span data-ttu-id="7fb9c-159">`<providers>` 元素定义了使用 `SqlWebEventProvider` 类的名为 "SqlWebEventProvider" 的单一日志源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-159">The `<providers>` element defines a single log source named "SqlWebEventProvider" that uses the `SqlWebEventProvider` class.</span></span> <span data-ttu-id="7fb9c-160">`connectionStringName` 属性设置为 "ReviewsConnectionString"，这是在 `<connectionStrings>` 部分中定义的连接字符串的名称。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-160">The `connectionStringName` attribute has been set to "ReviewsConnectionString", which is the name of our connection string defined in the `<connectionStrings>` section.</span></span>
- <span data-ttu-id="7fb9c-161">最后，&lt;规则&gt; 元素指示当 "所有错误" 事件发生应使用 "SqlWebEventProvider" 提供程序记录它时的情况。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-161">Finally, the &lt;rules&gt; element indicates that when an "All Errors" event transpires that it should be logged using the "SqlWebEventProvider" provider.</span></span>

<span data-ttu-id="7fb9c-162">此配置信息指示运行状况监视系统将所有未经处理的异常记录到书籍检查数据库。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-162">This configuration information instructs the health monitoring system to log all unhandled exceptions to the Book Reviews database.</span></span>

> [!NOTE]
> <span data-ttu-id="7fb9c-163">仅对服务器错误引发 `WebBaseErrorEvent` 事件;对于 HTTP 错误，不会引发此错误，例如，请求找不到 ASP.NET 资源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-163">The `WebBaseErrorEvent` event is only raised for server errors; it is not raised for HTTP errors, such as a request for an ASP.NET resource that is not found.</span></span> <span data-ttu-id="7fb9c-164">这不同于为服务器和 HTTP 错误引发 `HttpApplication` 类的 `Error` 事件的行为。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-164">This differs from the behavior of the `HttpApplication` class's `Error` event, which is raised for both server and HTTP errors.</span></span>

<span data-ttu-id="7fb9c-165">若要查看运行状况监视系统的运行状况，请访问网站并通过访问 `Genre.aspx?ID=foo`生成运行时错误。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-165">To see the health monitoring system in action, visit the website and generate a runtime error by visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="7fb9c-166">应会看到相应的错误页-异常详细信息黄色屏幕死亡（在本地访问时）或自定义错误页（访问生产中的站点时）。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-166">You should see the appropriate error page - either the Exception Details Yellow Screen of Death (when visiting locally) or the custom error page (when visiting the site in production).</span></span> <span data-ttu-id="7fb9c-167">在后台，运行状况监视系统将错误信息记录到数据库中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-167">Behind the scenes, the health monitoring system logged the error information to the database.</span></span> <span data-ttu-id="7fb9c-168">`aspnet_WebEvent_Events` 表中应有一条记录（请参阅**图 1**）;此记录包含有关刚刚发生的运行时错误的信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-168">There should be one record in the `aspnet_WebEvent_Events` table (see **Figure 1**); this record contains information about the runtime error that just occurred.</span></span>

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image2.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image1.png)

<span data-ttu-id="7fb9c-169">**图 1**：错误详细信息已记录到 `aspnet_WebEvent_Events` 表中</span><span class="sxs-lookup"><span data-stu-id="7fb9c-169">**Figure 1**: The Error Details Were Logged to the `aspnet_WebEvent_Events` Table</span></span>  
<span data-ttu-id="7fb9c-170">（[单击以查看完全大小的映像](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="7fb9c-170">([Click to view full-size image](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png))</span></span>

### <a name="displaying-the-error-log-in-a-web-page"></a><span data-ttu-id="7fb9c-171">在网页中显示错误日志</span><span class="sxs-lookup"><span data-stu-id="7fb9c-171">Displaying the Error Log In a Web Page</span></span>

<span data-ttu-id="7fb9c-172">在网站的当前配置中，运行状况监视系统会将所有未经处理的异常记录到数据库中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-172">With the website's current configuration, the health monitoring system logs all unhandled exceptions to the database.</span></span> <span data-ttu-id="7fb9c-173">但是，运行状况监视并不提供通过网页查看错误日志的任何机制。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-173">However, health monitoring does not provide any mechanism to view the error log through a web page.</span></span> <span data-ttu-id="7fb9c-174">但是，您可以生成一个从数据库显示此信息的 ASP.NET 页面。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-174">However, you could build an ASP.NET page that displays this information from the database.</span></span> <span data-ttu-id="7fb9c-175">（正如我们稍后将看到的，你可以选择在电子邮件中向你发送错误详细信息。）</span><span class="sxs-lookup"><span data-stu-id="7fb9c-175">(As we'll see momentarily, you can opt to have the error details sent to you in an email message.)</span></span>

<span data-ttu-id="7fb9c-176">如果创建此类页面，请确保只允许授权用户查看错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-176">If you create such a page, make sure you take steps to allow only authorized users to view the error details.</span></span> <span data-ttu-id="7fb9c-177">如果你的站点已使用用户帐户，则可以使用 URL 授权规则将对页面的访问限制为特定的用户或角色。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-177">If your site already employs user accounts then you can use URL authorization rules to restrict access to the page to certain users or roles.</span></span> <span data-ttu-id="7fb9c-178">若要详细了解如何根据登录的用户授予或限制对网页的访问权限，请参阅[网站安全教程](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-178">For more information on how to grant or restrict access to web pages based on the logged in user, refer to my [Website Security Tutorials](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md).</span></span>

> [!NOTE]
> <span data-ttu-id="7fb9c-179">后续教程将探讨一项名为 ELMAH 的替代错误日志记录和通知系统。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-179">The subsequent tutorial explores an alternative error logging and notification system named ELMAH.</span></span> <span data-ttu-id="7fb9c-180">ELMAH 包含一种内置机制，用于从网页和 RSS 源查看错误日志。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-180">ELMAH includes a built-in mechanism to view the error log from both a web page and as an RSS feed.</span></span>

## <a name="logging-events-to-email"></a><span data-ttu-id="7fb9c-181">将事件记录到电子邮件</span><span class="sxs-lookup"><span data-stu-id="7fb9c-181">Logging Events to Email</span></span>

<span data-ttu-id="7fb9c-182">运行状况监视系统包含一个日志源提供程序，该提供程序将事件 "记录" 到电子邮件中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-182">The health monitoring system includes a log source provider that "logs" an event to an email message.</span></span> <span data-ttu-id="7fb9c-183">日志源包括在电子邮件正文中记录到数据库中的相同信息。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-183">The log source includes the same information that is logged to the database in the email message body.</span></span> <span data-ttu-id="7fb9c-184">你可以使用此日志源在发生特定的运行状况监视事件时通知开发人员。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-184">You can use this log source to notify a developer when a certain health monitoring event occurs.</span></span>

<span data-ttu-id="7fb9c-185">接下来，我们将对网站的配置进行更新，以便在出现异常时收到电子邮件。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-185">Let's update the Book Reviews website's configuration so that we receive an email whenever an exception occurs.</span></span> <span data-ttu-id="7fb9c-186">若要实现此目的，我们需要执行三项任务：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-186">To accomplish this we need to perform three tasks:</span></span>

1. <span data-ttu-id="7fb9c-187">将 ASP.NET web 应用程序配置为发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-187">Configure the ASP.NET web application to send email.</span></span> <span data-ttu-id="7fb9c-188">这是通过指定如何通过 `<system.net>` 配置元素发送电子邮件来实现的。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-188">This is accomplished by specifying how email messages are sent via the `<system.net>` configuration element.</span></span> <span data-ttu-id="7fb9c-189">有关在 ASP.NET 应用程序中发送电子邮件的详细信息，请参阅[在 ASP.NET 中发送电子](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)邮件和[系统 .NET. Mail 常见问题解答](http://systemnetmail.com/)。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-189">For more information on sending email messages in an ASP.NET application refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx) and the [System.Net.Mail FAQ](http://systemnetmail.com/).</span></span>
2. <span data-ttu-id="7fb9c-190">在 `<providers>` 元素中注册电子邮件日志源提供程序，并</span><span class="sxs-lookup"><span data-stu-id="7fb9c-190">Register the email log source provider in the `<providers>` element, and</span></span>
3. <span data-ttu-id="7fb9c-191">将一个项添加到 `<rules>` 元素，该元素将 "所有错误" 事件映射到步骤中添加的日志源提供程序（2）。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-191">Add an entry to the `<rules>` element that maps the "All Errors" event to the log source provider added in step (2).</span></span>

<span data-ttu-id="7fb9c-192">运行状况监视系统包括两个电子邮件日志源提供程序类： `SimpleMailWebEventProvider` 和 `TemplatedMailWebEventProvider`。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-192">The health monitoring system includes two email log source provider classes: `SimpleMailWebEventProvider` and `TemplatedMailWebEventProvider`.</span></span> <span data-ttu-id="7fb9c-193">[`SimpleMailWebEventProvider` 类](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx)发送包含事件详细信息的纯文本电子邮件，并对电子邮件正文进行了很少的自定义。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-193">The [`SimpleMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx) sends a plain-text email message that includes the event details and provides little customization of the email body.</span></span> <span data-ttu-id="7fb9c-194">使用[`TemplatedMailWebEventProvider` 类](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx)指定 ASP.NET 页，该页面的呈现的标记用作电子邮件的正文。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-194">With the [`TemplatedMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) you specify an ASP.NET page whose rendered markup is used as the body for the email message.</span></span> <span data-ttu-id="7fb9c-195">使用[`TemplatedMailWebEventProvider` 类](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx)可以更好地控制电子邮件的内容和格式，但需要更多的前期工作，因为必须创建 ASP.NET 页面来生成电子邮件的正文。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-195">The [`TemplatedMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) gives you much greater control over the contents and format of the email message, but requires a bit more upfront work as you have to create the ASP.NET page that generates the email message's body.</span></span> <span data-ttu-id="7fb9c-196">本教程重点介绍如何使用 `SimpleMailWebEventProvider` 类。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-196">This tutorial focuses on using the `SimpleMailWebEventProvider` class.</span></span>

<span data-ttu-id="7fb9c-197">在 `Web.config` 文件中更新运行状况监视系统的 `<providers>` 元素，以包括 `SimpleMailWebEventProvider` 类的日志源：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-197">Update the health monitoring system's `<providers>` element in the `Web.config` file to include a log source for the `SimpleMailWebEventProvider` class:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample3.xml)]

<span data-ttu-id="7fb9c-198">上述标记使用 `SimpleMailWebEventProvider` 类作为日志源提供程序，并为其指定友好名称 "EmailWebEventProvider"。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-198">The above markup uses the `SimpleMailWebEventProvider` class as the log source provider, and assigns it the friendly name "EmailWebEventProvider".</span></span> <span data-ttu-id="7fb9c-199">此外，`<add>` 属性还包括附加的配置选项，如电子邮件的 "发件地址" 和 "发件地址"。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-199">Moreover, the `<add>` attribute includes additional configuration options, such as the To and From addresses of the email message.</span></span>

<span data-ttu-id="7fb9c-200">定义电子邮件日志源后，剩下的就是指示运行状况监视系统使用此源来 "记录" 未处理的异常。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-200">With the email log source defined, all that remains is to instruct the health monitoring system to use this source to "log" unhandled exceptions.</span></span> <span data-ttu-id="7fb9c-201">这是通过在 `<rules>` 部分中添加新规则来完成的：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-201">This is accomplished by adding a new rule in the `<rules>` section:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample4.xml)]

<span data-ttu-id="7fb9c-202">`<rules>` 部分现在包括两个规则。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-202">The `<rules>` section now includes two rules.</span></span> <span data-ttu-id="7fb9c-203">第一个名称为 "所有错误发至电子邮件"，将所有未经处理的异常发送到 "EmailWebEventProvider" 日志源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-203">The first one, named "All Errors To Email", sends all unhandled exceptions to the "EmailWebEventProvider" log source.</span></span> <span data-ttu-id="7fb9c-204">此规则的效果是将网站上有关错误的详细信息发送到指定的以解决问题。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-204">This rule has the effect of sending details about errors on the website to the specified To address.</span></span> <span data-ttu-id="7fb9c-205">"对数据库的所有错误" 规则将错误详细信息记录到站点的数据库中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-205">The "All Errors To Database" rule logs the error details to the site's database.</span></span> <span data-ttu-id="7fb9c-206">因此，只要站点上出现未处理的异常，其详细信息就会记录到数据库中并发送到指定的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-206">Consequently, whenever an unhandled exception occurs on the site its details are both logged to the database and sent to specified email address.</span></span>

<span data-ttu-id="7fb9c-207">**图 2**显示访问 `Genre.aspx?ID=foo`时由 `SimpleMailWebEventProvider` 类生成的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-207">**Figure 2** shows the email generated by the `SimpleMailWebEventProvider` class when visiting `Genre.aspx?ID=foo`.</span></span>

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image5.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image4.png)

<span data-ttu-id="7fb9c-208">**图 2**：在电子邮件中发送错误详细信息</span><span class="sxs-lookup"><span data-stu-id="7fb9c-208">**Figure 2**: The Error Details are Sent in an Email Message</span></span>  
<span data-ttu-id="7fb9c-209">（[单击以查看完全大小的映像](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="7fb9c-209">([Click to view full-size image](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png))</span></span>

## <a name="summary"></a><span data-ttu-id="7fb9c-210">总结</span><span class="sxs-lookup"><span data-stu-id="7fb9c-210">Summary</span></span>

<span data-ttu-id="7fb9c-211">ASP.NET 运行状况监视系统旨在允许管理员监视已部署的 web 应用程序的运行状况。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-211">The ASP.NET health monitoring system is designed to allow administrators to monitor the health of a deployed web application.</span></span> <span data-ttu-id="7fb9c-212">展开某些操作时，将引发运行状况监视事件，例如当应用程序停止时、用户成功登录到站点时或发生未经处理的异常时。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-212">Health monitoring events are raised when certain actions unfold, such as when the application stops, when a user successfully logs onto the site, or when an unhandled exception occurs.</span></span> <span data-ttu-id="7fb9c-213">这些事件可以记录到任意数量的日志源中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-213">These events can be logged to any number of log sources.</span></span> <span data-ttu-id="7fb9c-214">本教程演示了如何通过电子邮件将未经处理的异常的详细信息记录到数据库中。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-214">This tutorial showed how to log the details of unhandled exceptions to a database and through an email message.</span></span>

<span data-ttu-id="7fb9c-215">本教程重点介绍如何使用运行状况监视来记录未经处理的异常，但请记住，运行状况监视旨在衡量已部署的 ASP.NET 应用程序的总体运行状况，并包括大量的运行状况监视事件和日志源本文探讨。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-215">This tutorial focused on using health monitoring to log unhandled exceptions, but keep in mind that health monitoring is designed to measure the overall health of a deployed ASP.NET application and includes a wealth of health monitoring events and log sources not explored here.</span></span> <span data-ttu-id="7fb9c-216">而且，如果需要，你可以创建自己的运行状况监视事件和日志源。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-216">What's more, you can create your own health monitoring events and log sources, should the need arise.</span></span> <span data-ttu-id="7fb9c-217">如果有兴趣了解有关运行状况监视的详细信息，最好是通读[Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)的[运行状况监视常见问题解答](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-217">If you are interested in learning more about health monitoring, a good first step is to read through [Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)'s [health monitoring FAQ](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx).</span></span> <span data-ttu-id="7fb9c-218">请参阅[如何：在 ASP.NET 2.0 中使用运行状况监视](https://msdn.microsoft.com/library/ms998306.aspx)。</span><span class="sxs-lookup"><span data-stu-id="7fb9c-218">Following that, consult [How To: Use Health Monitoring in ASP.NET 2.0](https://msdn.microsoft.com/library/ms998306.aspx).</span></span>

<span data-ttu-id="7fb9c-219">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="7fb9c-219">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="7fb9c-220">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="7fb9c-220">Further Reading</span></span>

<span data-ttu-id="7fb9c-221">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="7fb9c-221">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="7fb9c-222">ASP.NET 运行状况监视概述</span><span class="sxs-lookup"><span data-stu-id="7fb9c-222">ASP.NET Health Monitoring Overview</span></span>](https://msdn.microsoft.com/library/bb398933.aspx)
- [<span data-ttu-id="7fb9c-223">配置和自定义 ASP.NET 的运行状况监视系统</span><span class="sxs-lookup"><span data-stu-id="7fb9c-223">Configuring and Customizing the Health Monitoring System of ASP.NET</span></span>](http://dotnetslackers.com/articles/aspnet/ConfiguringAndCustomizingTheHealthMonitoringSystemOfASPNET.aspx)
- [<span data-ttu-id="7fb9c-224">常见问题解答-ASP.NET 2.0 中的运行状况监视</span><span class="sxs-lookup"><span data-stu-id="7fb9c-224">FAQ - Health Monitoring in ASP.NET 2.0</span></span>](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)
- [<span data-ttu-id="7fb9c-225">如何：发送用于运行状况监视通知的电子邮件</span><span class="sxs-lookup"><span data-stu-id="7fb9c-225">How To: Send E-Mail for Health Monitoring Notifications</span></span>](https://msdn.microsoft.com/library/ms227553.aspx)
- [<span data-ttu-id="7fb9c-226">如何：在 ASP.NET 中使用运行状况监视</span><span class="sxs-lookup"><span data-stu-id="7fb9c-226">How To: Use Health Monitoring in ASP.NET</span></span>](https://msdn.microsoft.com/library/ms998306.aspx)
- [<span data-ttu-id="7fb9c-227">ASP.NET 中的运行状况监视</span><span class="sxs-lookup"><span data-stu-id="7fb9c-227">Health Monitoring in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/031407-1.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="7fb9c-228">[上一页](processing-unhandled-exceptions-cs.md)
> [下一页](logging-error-details-with-elmah-cs.md)</span><span class="sxs-lookup"><span data-stu-id="7fb9c-228">[Previous](processing-unhandled-exceptions-cs.md)
[Next](logging-error-details-with-elmah-cs.md)</span></span>
