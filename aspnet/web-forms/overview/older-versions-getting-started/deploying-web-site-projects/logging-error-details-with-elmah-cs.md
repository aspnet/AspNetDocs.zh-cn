---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-elmah-cs
title: 日志记录错误详细信息（C#）Microsoft Docs
author: rick-anderson
description: 错误日志记录模块和处理程序（ELMAH）提供了在生产环境中记录运行时错误的另一种方法。 ELMAH 是一个免费的开源错误 。
ms.author: riande
ms.date: 06/09/2009
ms.assetid: 11f6fe44-64ef-4a38-a3b4-35c7bb992352
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-elmah-cs
msc.type: authoredcontent
ms.openlocfilehash: 5018023eced23e7a70eab90e649f85862c548940
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78462806"
---
# <a name="logging-error-details-with-elmah-c"></a><span data-ttu-id="c73bc-104">ELMAH 的日志记录错误详细信息 (C#)</span><span class="sxs-lookup"><span data-stu-id="c73bc-104">Logging Error Details with ELMAH (C#)</span></span>

<span data-ttu-id="c73bc-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="c73bc-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="c73bc-106">[下载代码](https://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_14_CS.zip)或[下载 PDF](https://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial14_ELMAH_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="c73bc-106">[Download Code](https://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_14_CS.zip) or [Download PDF](https://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial14_ELMAH_cs.pdf)</span></span>

> <span data-ttu-id="c73bc-107">错误日志记录模块和处理程序（ELMAH）提供了在生产环境中记录运行时错误的另一种方法。</span><span class="sxs-lookup"><span data-stu-id="c73bc-107">Error Logging Modules And Handlers (ELMAH) offers another approach to logging runtime errors in a production environment.</span></span> <span data-ttu-id="c73bc-108">ELMAH 是一个免费的开源错误日志记录库，其中包含一些功能，例如错误筛选功能，还可以查看网页中的错误日志，作为 RSS 源，或将其作为逗号分隔的文件下载。</span><span class="sxs-lookup"><span data-stu-id="c73bc-108">ELMAH is a free, open source error logging library that includes features like error filtering and the ability to view the error log from a web page, as an RSS feed, or to download it as a comma-delimited file.</span></span> <span data-ttu-id="c73bc-109">本教程介绍如何下载和配置 ELMAH。</span><span class="sxs-lookup"><span data-stu-id="c73bc-109">This tutorial walks through downloading and configuring ELMAH.</span></span>

## <a name="introduction"></a><span data-ttu-id="c73bc-110">简介</span><span class="sxs-lookup"><span data-stu-id="c73bc-110">Introduction</span></span>

<span data-ttu-id="c73bc-111">[前面的教程](logging-error-details-with-asp-net-health-monitoring-cs.md)探讨了 ASP。NET 的运行状况监视系统，它提供了一个现成的库，用于记录范围广泛的 Web 事件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-111">The [preceding tutorial](logging-error-details-with-asp-net-health-monitoring-cs.md) examined ASP.NET's health monitoring system, which offers an out of the box library for recording a wide array of Web events.</span></span> <span data-ttu-id="c73bc-112">许多开发人员使用运行状况监视来记录未经处理的异常的详细信息并发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-112">Many developers use health monitoring to log and email the details of unhandled exceptions.</span></span> <span data-ttu-id="c73bc-113">不过，此系统有一些难题。</span><span class="sxs-lookup"><span data-stu-id="c73bc-113">However, there are a few pain points with this system.</span></span> <span data-ttu-id="c73bc-114">首先，最重要的是，缺少任何类型的用户界面来查看有关记录的事件的信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-114">First and foremost is the lack any sort of user interface for viewing information about the logged events.</span></span> <span data-ttu-id="c73bc-115">如果要查看最近10个错误的摘要，或查看上周发生的错误的详细信息，则必须浏览数据库、扫描电子邮件收件箱或生成显示 `aspnet_WebEvent_Events` 表中的信息的网页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-115">If you want to see a summary of the 10 last errors, or view the details of an error that happened last week, you must either poke through the database, scan through your email Inbox, or build a web page that displays information from the `aspnet_WebEvent_Events` table.</span></span>

<span data-ttu-id="c73bc-116">其他难点围绕运行状况监视的复杂性。</span><span class="sxs-lookup"><span data-stu-id="c73bc-116">Another pain point centers around health monitoring's complexity.</span></span> <span data-ttu-id="c73bc-117">由于运行状况监视可用于记录不同事件的很多，因此，由于有多种选项可用于指示事件的记录方式和时间，正确配置运行状况监视系统可能是一件繁重的任务。</span><span class="sxs-lookup"><span data-stu-id="c73bc-117">Because health monitoring can be used to record a plethora of different events, and because there are a variety of options for instructing how and when events are logged, correctly configuring the health monitoring system can be an onerous task.</span></span> <span data-ttu-id="c73bc-118">最后，存在兼容性问题。</span><span class="sxs-lookup"><span data-stu-id="c73bc-118">Finally, there are compatibility issues.</span></span> <span data-ttu-id="c73bc-119">由于运行状况监视首先添加到版本2.0 中的 .NET Framework，因此对于使用 ASP.NET 版本1.x 生成的旧版 web 应用程序不可用。</span><span class="sxs-lookup"><span data-stu-id="c73bc-119">Because health monitoring was first added to the .NET Framework in version 2.0, it is not available for older web applications built using ASP.NET version 1.x.</span></span> <span data-ttu-id="c73bc-120">此外，在前面的教程中，我们使用的 `SqlWebEventProvider` 类将错误详细信息记录到数据库中，只适用于 Microsoft SQL Server 的数据库。</span><span class="sxs-lookup"><span data-stu-id="c73bc-120">Moreover, the `SqlWebEventProvider` class, which we used in the preceding tutorial to logs error details to a database, only works with Microsoft SQL Server databases.</span></span> <span data-ttu-id="c73bc-121">如果需要将错误记录到备用数据存储（如 XML 文件或 Oracle 数据库），则需要创建自定义日志提供程序类。</span><span class="sxs-lookup"><span data-stu-id="c73bc-121">You will need to create a custom log provider class should you need to log errors to an alternate data store, such as an XML file or Oracle database.</span></span>

<span data-ttu-id="c73bc-122">运行状况监视系统的替代方法是错误日志记录模块和处理程序（ELMAH），这是由[Atif Aziz](http://www.raboof.com/)创建的一个免费的开源错误日志记录系统。</span><span class="sxs-lookup"><span data-stu-id="c73bc-122">An alternative to the health monitoring system is Error Logging Modules And Handlers (ELMAH), a free, open-source error logging system created by [Atif Aziz](http://www.raboof.com/).</span></span> <span data-ttu-id="c73bc-123">这两个系统之间最明显的区别在于，ELAMH 可以显示一个错误列表，还可以在网页中显示特定错误的详细信息，并将其作为 RSS 源来显示。</span><span class="sxs-lookup"><span data-stu-id="c73bc-123">The most notable difference between the two systems is ELAMH's ability to display a list of errors and the details of a specific error from a web page and as an RSS feed.</span></span> <span data-ttu-id="c73bc-124">ELMAH 比运行状况监视更易于配置，因为它只记录错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-124">ELMAH is easier to configure than health monitoring because it only logs errors.</span></span> <span data-ttu-id="c73bc-125">此外，ELMAH 还支持 ASP.NET 1.x、ASP.NET 2.0 和 ASP.NET 3.5 应用程序，并附带各种日志源提供程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-125">Furthermore, ELMAH includes support for ASP.NET 1.x, ASP.NET 2.0, and ASP.NET 3.5 applications, and ships with a variety of log source providers.</span></span>

<span data-ttu-id="c73bc-126">本教程介绍了向 ASP.NET 应用程序添加 ELMAH 所涉及的步骤。</span><span class="sxs-lookup"><span data-stu-id="c73bc-126">This tutorial walks through the steps involved in adding ELMAH to an ASP.NET application.</span></span> <span data-ttu-id="c73bc-127">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="c73bc-127">Let's get started!</span></span>

> [!NOTE]
> <span data-ttu-id="c73bc-128">运行状况监视系统和 ELMAH 都有其各自的优缺点。</span><span class="sxs-lookup"><span data-stu-id="c73bc-128">The health monitoring system and ELMAH both have their own sets of pros and cons.</span></span> <span data-ttu-id="c73bc-129">我鼓励您尝试这两个系统，并决定哪一种最适合您的需求。</span><span class="sxs-lookup"><span data-stu-id="c73bc-129">I encourage you to try both systems and decide what one best suits your needs.</span></span>

## <a name="adding-elmah-to-an-aspnet-web-application"></a><span data-ttu-id="c73bc-130">将 ELMAH 添加到 ASP.NET Web 应用程序</span><span class="sxs-lookup"><span data-stu-id="c73bc-130">Adding ELMAH to an ASP.NET Web Application</span></span>

<span data-ttu-id="c73bc-131">将 ELMAH 集成到新的或现有的 ASP.NET 应用程序是一个简单且简单的过程，只需5分钟即可完成。</span><span class="sxs-lookup"><span data-stu-id="c73bc-131">Integrating ELMAH into a new or existing ASP.NET application is an easy and straightforward process that takes under five minutes.</span></span> <span data-ttu-id="c73bc-132">简而言之，它涉及四个简单的步骤：</span><span class="sxs-lookup"><span data-stu-id="c73bc-132">In a nutshell, it involves four simple steps:</span></span>

1. <span data-ttu-id="c73bc-133">下载 ELMAH 并将 `Elmah.dll` 程序集添加到你的 web 应用程序，</span><span class="sxs-lookup"><span data-stu-id="c73bc-133">Download ELMAH and add the `Elmah.dll` assembly to your web application,</span></span>
2. <span data-ttu-id="c73bc-134">在 `Web.config`中注册 ELMAH 的 HTTP 模块和处理程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-134">Register ELMAH's HTTP Modules and Handler in `Web.config`,</span></span>
3. <span data-ttu-id="c73bc-135">指定 ELMAH 的配置选项，并</span><span class="sxs-lookup"><span data-stu-id="c73bc-135">Specify ELMAH's configuration options, and</span></span>
4. <span data-ttu-id="c73bc-136">如果需要，请创建错误日志源基础结构。</span><span class="sxs-lookup"><span data-stu-id="c73bc-136">Create the error log source infrastructure, if needed.</span></span>

<span data-ttu-id="c73bc-137">让我们逐一演练其中每个步骤。</span><span class="sxs-lookup"><span data-stu-id="c73bc-137">Let's walk through each of these four steps, one at a time.</span></span>

### <a name="step-1-downloading-the-elmah-project-files-and-addingelmahdllto-your-web-application"></a><span data-ttu-id="c73bc-138">步骤1：下载 ELMAH 项目文件并将`Elmah.dll`添加到 Web 应用程序</span><span class="sxs-lookup"><span data-stu-id="c73bc-138">Step 1: Downloading the ELMAH Project Files and Adding`Elmah.dll`To Your Web Application</span></span>

<span data-ttu-id="c73bc-139">ELMAH 1.0 BETA 3 （版本10617）（编写时的最新版本）包含在随本教程提供的下载中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-139">ELMAH 1.0 BETA 3 (Build 10617), the most recent version at the time of writing, is included in the download available with this tutorial.</span></span> <span data-ttu-id="c73bc-140">或者，你可以访问[ELMAH 网站](https://code.google.com/p/elmah/)以获取最新版本或下载源代码。</span><span class="sxs-lookup"><span data-stu-id="c73bc-140">Alternatively, you may visit the [ELMAH website](https://code.google.com/p/elmah/) to get the most recent version or to download the source code.</span></span> <span data-ttu-id="c73bc-141">将 ELMAH 下载内容提取到桌面上的文件夹，并找到 ELMAH assembly 文件（`Elmah.dll`）。</span><span class="sxs-lookup"><span data-stu-id="c73bc-141">Extract the ELMAH download to a folder on your desktop and locate the ELMAH assembly file (`Elmah.dll`).</span></span>

> [!NOTE]
> <span data-ttu-id="c73bc-142">`Elmah.dll` 文件位于下载 `Bin` 文件夹中，该文件夹包含不同 .NET Framework 版本的子文件夹，以及发布和调试版本。</span><span class="sxs-lookup"><span data-stu-id="c73bc-142">The `Elmah.dll` file is located in the download's `Bin` folder, which has subfolders for different .NET Framework versions and for Release and Debug builds.</span></span> <span data-ttu-id="c73bc-143">使用适当 framework 版本的发布版本。</span><span class="sxs-lookup"><span data-stu-id="c73bc-143">Use the Release build for the appropriate framework version.</span></span> <span data-ttu-id="c73bc-144">例如，如果要生成 ASP.NET 3.5 web 应用程序，请从 `Bin\net-3.5\Release` 文件夹复制 `Elmah.dll` 文件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-144">For instance, if you are building an ASP.NET 3.5 web application, copy the `Elmah.dll` file from the `Bin\net-3.5\Release` folder.</span></span>

<span data-ttu-id="c73bc-145">接下来，打开 Visual Studio，右键单击 "解决方案资源管理器中的" 网站名称 "，然后从上下文菜单中选择" 添加引用 "，将程序集添加到项目。</span><span class="sxs-lookup"><span data-stu-id="c73bc-145">Next, open Visual Studio and add the assembly to your project by right-clicking on the website name in the Solution Explorer and choosing Add Reference from the context menu.</span></span> <span data-ttu-id="c73bc-146">此时将打开 "添加引用" 对话框。</span><span class="sxs-lookup"><span data-stu-id="c73bc-146">This brings up the Add Reference dialog box.</span></span> <span data-ttu-id="c73bc-147">导航到 "浏览" 选项卡，然后选择 "`Elmah.dll` 文件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-147">Navigate to the Browse tab and choose the `Elmah.dll` file.</span></span> <span data-ttu-id="c73bc-148">此操作会将 `Elmah.dll` 文件添加到 web 应用程序的 `Bin` 文件夹中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-148">This action adds the `Elmah.dll` file to the web application's `Bin` folder.</span></span>

> [!NOTE]
> <span data-ttu-id="c73bc-149">Web 应用程序项目（WAP）类型不会在解决方案资源管理器中显示 `Bin` 文件夹。</span><span class="sxs-lookup"><span data-stu-id="c73bc-149">The Web Application Project (WAP) type does not show the `Bin` folder in the Solution Explorer.</span></span> <span data-ttu-id="c73bc-150">相反，它会在 "引用" 文件夹下列出这些项。</span><span class="sxs-lookup"><span data-stu-id="c73bc-150">Instead, it lists these items under the References folder.</span></span>

<span data-ttu-id="c73bc-151">`Elmah.dll` 程序集包括 ELMAH 系统使用的类。</span><span class="sxs-lookup"><span data-stu-id="c73bc-151">The `Elmah.dll` assembly includes the classes used by the ELMAH system.</span></span> <span data-ttu-id="c73bc-152">这些类分为以下三个类别之一：</span><span class="sxs-lookup"><span data-stu-id="c73bc-152">These classes fall into one of three categories:</span></span>

- <span data-ttu-id="c73bc-153">**Http**模块-http 模块是为 `HttpApplication` 事件（如 `Error` 事件）定义事件处理程序的类。</span><span class="sxs-lookup"><span data-stu-id="c73bc-153">**HTTP Modules** - an HTTP Module is a class that defines event handlers for `HttpApplication` events, such as the `Error` event.</span></span> <span data-ttu-id="c73bc-154">ELMAH 包含多个 HTTP 模块，其中三个最无关：</span><span class="sxs-lookup"><span data-stu-id="c73bc-154">ELMAH includes multiple HTTP Modules, the three most germane ones being:</span></span> 

    - <span data-ttu-id="c73bc-155">`ErrorLogModule`-将未经处理的异常记录到日志源中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-155">`ErrorLogModule` - logs unhandled exceptions to a log source.</span></span>
    - <span data-ttu-id="c73bc-156">`ErrorMailModule`-发送电子邮件中未经处理的异常的详细信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-156">`ErrorMailModule` - sends the details of an unhandled exception in an email message.</span></span>
    - <span data-ttu-id="c73bc-157">`ErrorFilterModule`-应用开发人员指定的筛选器，以确定要记录的异常以及忽略哪些异常。</span><span class="sxs-lookup"><span data-stu-id="c73bc-157">`ErrorFilterModule` - applies developer-specified filters to determine what exceptions are logged and what ones are ignored.</span></span>
- <span data-ttu-id="c73bc-158">**Http**处理程序-Http 处理程序是负责为特定类型的请求生成标记的类。</span><span class="sxs-lookup"><span data-stu-id="c73bc-158">**HTTP Handlers** - an HTTP Handler is a class that is responsible for generating the markup for a particular type of request.</span></span> <span data-ttu-id="c73bc-159">ELMAH 包含 HTTP 处理程序，该处理程序以网页形式呈现错误详细信息，作为 RSS 源，或以逗号分隔的文件（CSV）的形式呈现。</span><span class="sxs-lookup"><span data-stu-id="c73bc-159">ELMAH includes HTTP Handlers that render error details as a web page, as an RSS feed, or as a comma-delimited file (CSV).</span></span>
- <span data-ttu-id="c73bc-160">**错误日志源**-在此情况下，ELMAH 可以将错误记录到内存、Microsoft SQL Server 数据库、Microsoft Access 数据库、Oracle 数据库、XML 文件、SQLite 数据库或 Vista DB 数据库。</span><span class="sxs-lookup"><span data-stu-id="c73bc-160">**Error Log Sources** - out of the box ELMAH can log errors to memory, to a Microsoft SQL Server database, to a Microsoft Access database, to an Oracle database, to an XML file, to a SQLite database, or to a Vista DB database.</span></span> <span data-ttu-id="c73bc-161">与运行状况监视系统一样，ELMAH 的体系结构是使用提供程序模型构建的，这意味着，如果需要，你可以创建并无缝集成你自己的自定义日志源提供程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-161">Like the health monitoring system, ELMAH's architecture was built using the provider model, meaning that you can create and seamlessly integrate your own custom log source providers, if needed.</span></span>

### <a name="step-2-registering-elmahs-http-module-and-handler"></a><span data-ttu-id="c73bc-162">步骤2：注册 ELMAH 的 HTTP 模块和处理程序</span><span class="sxs-lookup"><span data-stu-id="c73bc-162">Step 2: Registering ELMAH's HTTP Module and Handler</span></span>

<span data-ttu-id="c73bc-163">虽然 `Elmah.dll` 文件包含自动记录未经处理的异常和显示网页中的错误详细信息所需的 HTTP 模块和处理程序，但必须在 web 应用程序的配置中显式注册这些内容。</span><span class="sxs-lookup"><span data-stu-id="c73bc-163">While the `Elmah.dll` file contains the HTTP Modules and Handler needed to automatically log unhandled exceptions and to display error details from a web page, these must be explicitly registered in the web application's configuration.</span></span> <span data-ttu-id="c73bc-164">`ErrorLogModule` HTTP 模块在注册后会订阅 `HttpApplication`的 `Error` 事件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-164">The `ErrorLogModule` HTTP Module, once registered, subscribes to the `HttpApplication`'s `Error` event.</span></span> <span data-ttu-id="c73bc-165">每当引发此事件时，`ErrorLogModule` 会将异常的详细信息记录到指定的日志源中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-165">Whenever this event is raised the `ErrorLogModule` logs the details of the exception to a specified log source.</span></span> <span data-ttu-id="c73bc-166">我们将在下一节 "配置 ELMAH" 中看到如何定义日志源提供程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-166">We'll see how to define the log source provider in the next section, "Configuring ELMAH."</span></span> <span data-ttu-id="c73bc-167">在从网页查看错误日志时，`ErrorLogPageFactory` HTTP 处理程序工厂负责生成标记。</span><span class="sxs-lookup"><span data-stu-id="c73bc-167">The `ErrorLogPageFactory` HTTP Handler factory is responsible for generating the markup when viewing the error log from a web page.</span></span>

<span data-ttu-id="c73bc-168">注册 HTTP 模块和处理程序的特定语法取决于为站点提供支持的 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="c73bc-168">The specific syntax for registering HTTP Modules and Handlers depends upon the web server that is powering the site.</span></span> <span data-ttu-id="c73bc-169">对于 ASP.NET 开发服务器和 Microsoft 的 IIS 版本6.0 及更早版本，HTTP 模块和处理程序在 `<httpModules>` 和 `<httpHandlers>` 节中注册，这些部分显示在 `<system.web>` 元素中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-169">For the ASP.NET Development Server and Microsoft's IIS version 6.0 and earlier, HTTP Modules and Handlers are registered in the `<httpModules>` and `<httpHandlers>` sections, which appear within the `<system.web>` element.</span></span> <span data-ttu-id="c73bc-170">如果使用 IIS 7.0，则需要在 `<system.webServer>` 元素的 `<modules>` 和 `<handlers>` 节中注册它们。</span><span class="sxs-lookup"><span data-stu-id="c73bc-170">If you are using IIS 7.0 then they need to be registered in the `<system.webServer>` element's `<modules>` and `<handlers>` sections.</span></span> <span data-ttu-id="c73bc-171">幸运的是，无论使用哪种 web 服务器，*都可以在这两个*位置定义 HTTP 模块和处理程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-171">Fortunately, you can define the HTTP Modules and Handlers in *both* places regardless of the web server being used.</span></span> <span data-ttu-id="c73bc-172">此选项是最易于移植的选项，因为它允许在开发和生产环境中使用相同的配置，而不考虑所使用的 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="c73bc-172">This option is the most portable one as it allows the same configuration to be used in the development and production environments regardless of the web server being used.</span></span>

<span data-ttu-id="c73bc-173">首先，在 `<system.web>`的 `<httpModules>` 和 `<httpHandlers>` 部分中注册 `ErrorLogModule` HTTP 模块和 `ErrorLogPageFactory` HTTP 处理程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-173">Start by registering the `ErrorLogModule` HTTP Module and the `ErrorLogPageFactory` HTTP Handler in the `<httpModules>` and `<httpHandlers>` section in `<system.web>`.</span></span> <span data-ttu-id="c73bc-174">如果配置已定义了这两个元素，则只需包括 ELMAH 的 HTTP 模块和处理程序的 `<add>` 元素。</span><span class="sxs-lookup"><span data-stu-id="c73bc-174">If your configuration already defines these two elements then simply include the `<add>` element for ELMAH's HTTP Module and Handler.</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample1.xml)]

<span data-ttu-id="c73bc-175">接下来，在 `<system.webServer>` 元素中注册 ELMAH 的 HTTP 模块和处理程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-175">Next, register ELMAH's HTTP Module and Handler in the `<system.webServer>` element.</span></span> <span data-ttu-id="c73bc-176">如前所述，如果在配置中不存在此元素，请添加该元素。</span><span class="sxs-lookup"><span data-stu-id="c73bc-176">As before, if this element is not already present in your configuration then add it.</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample2.xml)]

<span data-ttu-id="c73bc-177">默认情况下，如果在 `<system.web>` 部分注册了 HTTP 模块和处理程序，则使用 IIS 7 投诉原因。</span><span class="sxs-lookup"><span data-stu-id="c73bc-177">By default, IIS 7 complains if HTTP Modules and Handlers are registered in the `<system.web>` section.</span></span> <span data-ttu-id="c73bc-178">`<validation>` 元素中的 `validateIntegratedModeConfiguration` 属性指示 IIS 7 禁止显示此类错误消息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-178">The `validateIntegratedModeConfiguration` attribute in the `<validation>` element instructs IIS 7 to suppress such error messages.</span></span>

<span data-ttu-id="c73bc-179">请注意，用于注册 `ErrorLogPageFactory` HTTP 处理程序的语法包括设置为 `elmah.axd`的 `path` 属性。</span><span class="sxs-lookup"><span data-stu-id="c73bc-179">Note that the syntax for registering the `ErrorLogPageFactory` HTTP Handler includes a `path` attribute, which is set to `elmah.axd`.</span></span> <span data-ttu-id="c73bc-180">此属性通知 web 应用程序，如果请求到达名为 `elmah.axd` 的页，则该请求应由 `ErrorLogPageFactory` HTTP 处理程序进行处理。</span><span class="sxs-lookup"><span data-stu-id="c73bc-180">This attribute informs the web application that if a request arrives for a page named `elmah.axd` then the request should be processed by the `ErrorLogPageFactory` HTTP Handler.</span></span> <span data-ttu-id="c73bc-181">在本教程的后面部分，我们将看到 `ErrorLogPageFactory` 的 HTTP 处理程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-181">We'll see the `ErrorLogPageFactory` HTTP Handler in action later in this tutorial.</span></span>

### <a name="step-3-configuring-elmah"></a><span data-ttu-id="c73bc-182">步骤3：配置 ELMAH</span><span class="sxs-lookup"><span data-stu-id="c73bc-182">Step 3: Configuring ELMAH</span></span>

<span data-ttu-id="c73bc-183">ELMAH 会在名为 `<elmah>`的自定义配置节中的网站 `Web.config` 文件中查找其配置选项。</span><span class="sxs-lookup"><span data-stu-id="c73bc-183">ELMAH looks for its configuration options in the website's `Web.config` file in a custom configuration section named `<elmah>`.</span></span> <span data-ttu-id="c73bc-184">若要在中使用自定义节 `Web.config` 必须先在 `<configSections>` 元素中定义它。</span><span class="sxs-lookup"><span data-stu-id="c73bc-184">In order to use a custom section in `Web.config` it must first be defined in the `<configSections>` element.</span></span> <span data-ttu-id="c73bc-185">打开 `Web.config` 文件，并将以下标记添加到 `<configSections>`：</span><span class="sxs-lookup"><span data-stu-id="c73bc-185">Open the `Web.config` file and add the following markup to the `<configSections>`:</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample3.xml)]

> [!NOTE]
> <span data-ttu-id="c73bc-186">如果要为 ASP.NET 1.x 应用程序配置 ELMAH，请从上面的 `<section>` 元素中删除 `requirePermission="false"` 特性。</span><span class="sxs-lookup"><span data-stu-id="c73bc-186">If you are configuring ELMAH for an ASP.NET 1.x application then remove the `requirePermission="false"` attribute from the `<section>` elements above.</span></span>

<span data-ttu-id="c73bc-187">上面的语法注册自定义 `<elmah>` 节及其子节： `<security>`、`<errorLog>`、`<errorMail>`和 `<errorFilter>`。</span><span class="sxs-lookup"><span data-stu-id="c73bc-187">The above syntax registers the custom `<elmah>` section and its subsections: `<security>`, `<errorLog>`, `<errorMail>`, and `<errorFilter>`.</span></span>

<span data-ttu-id="c73bc-188">接下来，将 `<elmah>` 部分添加到 `Web.config`。</span><span class="sxs-lookup"><span data-stu-id="c73bc-188">Next, add the `<elmah>` section to `Web.config`.</span></span> <span data-ttu-id="c73bc-189">此部分应显示在与 `<system.web>` 元素相同的级别。</span><span class="sxs-lookup"><span data-stu-id="c73bc-189">This section should appear at the same level as the `<system.web>` element.</span></span> <span data-ttu-id="c73bc-190">在 `<elmah>` 部分中，添加 `<security>` 和 `<errorLog>` 节，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c73bc-190">Inside the `<elmah>` section add the `<security>` and `<errorLog>` sections like so:</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample4.xml)]

<span data-ttu-id="c73bc-191">`<security>` 节的 `allowRemoteAccess` 属性指示是否允许远程访问。</span><span class="sxs-lookup"><span data-stu-id="c73bc-191">The `<security>` section's `allowRemoteAccess` attribute indicates whether remote access is allowed.</span></span> <span data-ttu-id="c73bc-192">如果此值设置为0，则只能在本地查看 "错误日志" 网页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-192">If this value is set to 0, then the error log web page can only be viewed locally.</span></span> <span data-ttu-id="c73bc-193">如果将此属性设置为1，则将为远程和本地访问者启用 "错误日志" 网页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-193">If this attribute is set to 1 then the error log web page is enabled for both remote and local visitors.</span></span> <span data-ttu-id="c73bc-194">现在，让我们禁用远程访问者的错误日志网页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-194">For now, let's disable the error log web page for remote visitors.</span></span> <span data-ttu-id="c73bc-195">稍后我们将允许远程访问，稍后我们有机会讨论这样做的安全问题。</span><span class="sxs-lookup"><span data-stu-id="c73bc-195">We'll allow remote access later after we have an opportunity to discuss the security concerns of doing so.</span></span>

<span data-ttu-id="c73bc-196">`<errorLog>` 部分定义错误日志源，该源指示记录错误详细信息的位置;它类似于运行状况监视系统中的 `<providers>` 部分。</span><span class="sxs-lookup"><span data-stu-id="c73bc-196">The `<errorLog>` section defines the error log source, which dictates where the error details are recorded; it is similar to the `<providers>` section in the health monitoring system.</span></span> <span data-ttu-id="c73bc-197">上述语法将 `SqlErrorLog` 类指定为错误日志源，这会将错误记录到 `connectionStringName` 特性值所指定的 Microsoft SQL Server 数据库中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-197">The above syntax specifies the `SqlErrorLog` class as the error log source, which logs the errors to a Microsoft SQL Server database specified by the `connectionStringName` attribute value.</span></span>

> [!NOTE]
> <span data-ttu-id="c73bc-198">ELMAH 附带了额外的错误日志提供程序，可用于将错误记录到 XML 文件、Microsoft Access 数据库、Oracle 数据库和其他数据存储区中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-198">ELMAH ships with additional error log providers that can be used to log errors to an XML file, a Microsoft Access database, an Oracle database, and other data stores.</span></span> <span data-ttu-id="c73bc-199">有关如何使用这些备用错误日志提供程序的信息，请参阅包含在 ELMAH 下载中的示例 `Web.config` 文件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-199">Refer to the sample `Web.config` file that is included with the ELMAH download for information on how to use these alternate error log providers.</span></span>

### <a name="step-4-creating-the-error-log-source-infrastructure"></a><span data-ttu-id="c73bc-200">步骤4：创建错误日志源基础结构</span><span class="sxs-lookup"><span data-stu-id="c73bc-200">Step 4: Creating the Error Log Source Infrastructure</span></span>

<span data-ttu-id="c73bc-201">ELMAH 的 `SqlErrorLog` 提供程序将错误详细信息记录到指定的 Microsoft SQL Server 数据库。</span><span class="sxs-lookup"><span data-stu-id="c73bc-201">ELMAH's `SqlErrorLog` provider logs error details to a specified Microsoft SQL Server database.</span></span> <span data-ttu-id="c73bc-202">`SqlErrorLog` 提供程序要求此数据库具有一个名为 `ELMAH_Error` 的表和三个存储过程： `ELMAH_GetErrorsXml`、`ELMAH_GetErrorXml`和 `ELMAH_LogError`。</span><span class="sxs-lookup"><span data-stu-id="c73bc-202">The `SqlErrorLog` provider expects this database to have a table named `ELMAH_Error` and three stored procedures: `ELMAH_GetErrorsXml`, `ELMAH_GetErrorXml`, and `ELMAH_LogError`.</span></span> <span data-ttu-id="c73bc-203">ELMAH 下载内容包括一个名为 `db` `SQLServer.sql` 的文件，该文件包含用于创建此表和这些存储过程的 T-sql。</span><span class="sxs-lookup"><span data-stu-id="c73bc-203">The ELMAH download includes a file named `SQLServer.sql` in the `db` folder that contains the T-SQL for creating this table and these stored procedures.</span></span> <span data-ttu-id="c73bc-204">需要在数据库上运行这些语句才能使用 `SqlErrorLog` 提供程序。</span><span class="sxs-lookup"><span data-stu-id="c73bc-204">You'll need to run these statements on your database to use the `SqlErrorLog` provider.</span></span>

<span data-ttu-id="c73bc-205">**图1和图** **2**显示了 `SqlErrorLog` 提供程序所需的数据库对象之后，Visual Studio 中的数据库资源管理器。</span><span class="sxs-lookup"><span data-stu-id="c73bc-205">**Figures 1** and **2** show the Database Explorer in Visual Studio after the database objects needed by the `SqlErrorLog` provider have been added.</span></span>

[![](logging-error-details-with-elmah-cs/_static/image2.png)](logging-error-details-with-elmah-cs/_static/image1.png)

<span data-ttu-id="c73bc-206">**图 1**： `SqlErrorLog` 提供程序将错误记录到 `ELMAH_Error` 表中</span><span class="sxs-lookup"><span data-stu-id="c73bc-206">**Figure 1**: The `SqlErrorLog` Provider Logs Errors to the `ELMAH_Error` Table</span></span>

[![](logging-error-details-with-elmah-cs/_static/image4.png)](logging-error-details-with-elmah-cs/_static/image3.png)

<span data-ttu-id="c73bc-207">**图 2**： `SqlErrorLog` 提供程序使用三个存储过程</span><span class="sxs-lookup"><span data-stu-id="c73bc-207">**Figure 2**: The `SqlErrorLog` Provider Uses Three Stored Procedures</span></span>

## <a name="elmah-in-action"></a><span data-ttu-id="c73bc-208">操作中的 ELMAH</span><span class="sxs-lookup"><span data-stu-id="c73bc-208">ELMAH In Action</span></span>

<span data-ttu-id="c73bc-209">此时，我们已将 ELMAH 添加到 web 应用程序中，注册了 `ErrorLogModule` HTTP 模块和 `ErrorLogPageFactory` HTTP 处理程序，在 `Web.config`中指定了 ELMAH 的配置选项，并为 `SqlErrorLog` 错误日志提供程序添加了所需的数据库对象。</span><span class="sxs-lookup"><span data-stu-id="c73bc-209">At this point we have added ELMAH to the web application, registered the `ErrorLogModule` HTTP Module and the `ErrorLogPageFactory` HTTP Handler, specified ELMAH's configuration options in `Web.config`, and added the needed database objects for the `SqlErrorLog` error log provider.</span></span> <span data-ttu-id="c73bc-210">现在，我们已准备好在操作中看到 ELMAH！</span><span class="sxs-lookup"><span data-stu-id="c73bc-210">We are now ready to see ELMAH in action!</span></span> <span data-ttu-id="c73bc-211">访问书籍评论网站并访问生成运行时错误的页面（如 `Genre.aspx?ID=foo`）或不存在的页面（如 `NoSuchPage.aspx`）。</span><span class="sxs-lookup"><span data-stu-id="c73bc-211">Visit the Book Reviews website and visit a page that generates a runtime error, such as `Genre.aspx?ID=foo`, or a non-existent page, such as `NoSuchPage.aspx`.</span></span> <span data-ttu-id="c73bc-212">访问这些页面时看到的内容取决于 `<customErrors>` 配置以及你是在本地还是远程访问。</span><span class="sxs-lookup"><span data-stu-id="c73bc-212">What you see when visiting these pages depends on the `<customErrors>` configuration and whether you're visiting locally or remotely.</span></span> <span data-ttu-id="c73bc-213">（请返回到[*显示自定义错误页*教程](displaying-a-custom-error-page-cs.md)，了解本主题的复习。）</span><span class="sxs-lookup"><span data-stu-id="c73bc-213">(Refer back to the [*Displaying a Custom Error Page* tutorial](displaying-a-custom-error-page-cs.md) for a refresher on this topic.)</span></span>

<span data-ttu-id="c73bc-214">当发生未经处理的异常时，ELMAH 不会影响向用户显示的内容;它只记录其详细信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-214">ELMAH doesn't affect what content is shown to the user when an unhandled exception occurs; it just logs its details.</span></span> <span data-ttu-id="c73bc-215">可以从网站的根 `elmah.axd` 访问此错误日志，如 `http://localhost/BookReviews/elmah.axd`。</span><span class="sxs-lookup"><span data-stu-id="c73bc-215">This error log is accessible from the web page `elmah.axd` from the root of your website, such as `http://localhost/BookReviews/elmah.axd`.</span></span> <span data-ttu-id="c73bc-216">（此文件在物理上并不存在于你的项目中，但当请求进入时，`elmah.axd` 运行时将它调度到 `ErrorLogPageFactory` HTTP 处理程序，该处理程序会生成发送回浏览器的标记。）</span><span class="sxs-lookup"><span data-stu-id="c73bc-216">(This file does not physically exist in your project, but when a request comes in for `elmah.axd` the runtime dispatches it to the `ErrorLogPageFactory` HTTP Handler, which generates the markup sent back to the browser.)</span></span>

> [!NOTE]
> <span data-ttu-id="c73bc-217">还可以使用 "`elmah.axd`" 页指示 ELMAH 生成测试错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-217">You can also use the `elmah.axd` page to instruct ELMAH to generate a test error.</span></span> <span data-ttu-id="c73bc-218">访问 `elmah.axd/test` （如在中 `http://localhost/BookReviews/elmah.axd/test`）将导致 ELMAH 引发类型 `Elmah.TestException`的异常，该异常包含以下错误消息： "这是可以安全忽略的测试异常。"</span><span class="sxs-lookup"><span data-stu-id="c73bc-218">Visiting `elmah.axd/test` (as in, `http://localhost/BookReviews/elmah.axd/test`) causes ELMAH to throw an exception of type `Elmah.TestException`, which has the error message: " This is a test exception that can be safely ignored."</span></span>

<span data-ttu-id="c73bc-219">**图 3**显示了从开发环境中访问 `elmah.axd` 时的错误日志。</span><span class="sxs-lookup"><span data-stu-id="c73bc-219">**Figure 3** shows the error log when visiting `elmah.axd` from the development environment.</span></span>

[![](logging-error-details-with-elmah-cs/_static/image6.png)](logging-error-details-with-elmah-cs/_static/image5.png)

<span data-ttu-id="c73bc-220">**图 3**： `Elmah.axd` 显示网页中的错误日志</span><span class="sxs-lookup"><span data-stu-id="c73bc-220">**Figure 3**: `Elmah.axd` Displays the Error Log from a Web Page</span></span>  
<span data-ttu-id="c73bc-221">（[单击以查看完全大小的映像](logging-error-details-with-elmah-cs/_static/image7.png)）</span><span class="sxs-lookup"><span data-stu-id="c73bc-221">([Click to view full-size image](logging-error-details-with-elmah-cs/_static/image7.png))</span></span>

<span data-ttu-id="c73bc-222">**图 3**中的错误日志包含六个错误条目。</span><span class="sxs-lookup"><span data-stu-id="c73bc-222">The error log in **Figure 3** contains six error entries.</span></span> <span data-ttu-id="c73bc-223">每个条目都包括 HTTP 状态代码（404或500，适用于这些错误）、类型、说明、发生错误时登录用户的名称以及日期和时间。</span><span class="sxs-lookup"><span data-stu-id="c73bc-223">Each entry includes the HTTP status code (404 or 500, for these errors), the type, the description, the name of the logged on user when the error occurred, and the date and time.</span></span> <span data-ttu-id="c73bc-224">单击 "详细信息" 链接将显示一页，其中包含错误详细信息的黄色屏幕上显示的错误消息（请参阅**图 4**）以及错误发生时服务器变量的值（参见**图 5**）。</span><span class="sxs-lookup"><span data-stu-id="c73bc-224">Clicking the Details link displays a page that includes the same error message shown in the Error Details Yellow Screen of Death (see **Figure 4**) along with the values of the server variables at the time of the error (see **Figure 5**).</span></span> <span data-ttu-id="c73bc-225">你还可以查看保存错误详细信息的原始 XML，其中包括其他信息，例如 HTTP POST 标头中的值。</span><span class="sxs-lookup"><span data-stu-id="c73bc-225">You can also view the raw XML in which the error details are saved, which includes additional information such as the values in the HTTP POST header.</span></span>

[![](logging-error-details-with-elmah-cs/_static/image9.png)](logging-error-details-with-elmah-cs/_static/image8.png)

<span data-ttu-id="c73bc-226">**图 4**：查看错误详细信息 YSOD</span><span class="sxs-lookup"><span data-stu-id="c73bc-226">**Figure 4**: View the Error Details YSOD</span></span>  
<span data-ttu-id="c73bc-227">（[单击以查看完全大小的映像](logging-error-details-with-elmah-cs/_static/image10.png)）</span><span class="sxs-lookup"><span data-stu-id="c73bc-227">([Click to view full-size image](logging-error-details-with-elmah-cs/_static/image10.png))</span></span>

[![](logging-error-details-with-elmah-cs/_static/image12.png)](logging-error-details-with-elmah-cs/_static/image11.png)

<span data-ttu-id="c73bc-228">**图 5**：在发生错误时浏览服务器变量集合的值</span><span class="sxs-lookup"><span data-stu-id="c73bc-228">**Figure 5**: Explore the Values of the Server Variables Collection at the Time of the Error</span></span>  
<span data-ttu-id="c73bc-229">（[单击以查看完全大小的映像](logging-error-details-with-elmah-cs/_static/image13.png)）</span><span class="sxs-lookup"><span data-stu-id="c73bc-229">([Click to view full-size image](logging-error-details-with-elmah-cs/_static/image13.png))</span></span>

<span data-ttu-id="c73bc-230">将 ELMAH 部署到生产网站需要：</span><span class="sxs-lookup"><span data-stu-id="c73bc-230">Deploying ELMAH to the production website entails:</span></span>

- <span data-ttu-id="c73bc-231">将 `Elmah.dll` 文件复制到生产上的 `Bin` 文件夹中，</span><span class="sxs-lookup"><span data-stu-id="c73bc-231">Copying the `Elmah.dll` file to the `Bin` folder on production,</span></span>
- <span data-ttu-id="c73bc-232">将 ELMAH 特定的配置设置复制到生产环境中使用的 `Web.config` 文件，并</span><span class="sxs-lookup"><span data-stu-id="c73bc-232">Copying the ELMAH-specific configuration settings to the `Web.config` file used on production, and</span></span>
- <span data-ttu-id="c73bc-233">将错误日志源基础结构添加到生产数据库中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-233">Adding the error log source infrastructure to the production database.</span></span>

<span data-ttu-id="c73bc-234">我们已经探讨了在以前的教程中将文件从开发复制到生产的方法。</span><span class="sxs-lookup"><span data-stu-id="c73bc-234">We've explored techniques for copying files from development to production in previous tutorials.</span></span> <span data-ttu-id="c73bc-235">最简单的方法是在生产数据库中获取错误日志源基础结构，以便使用 SQL Server Management Studio 连接到生产数据库，然后执行 `SqlServer.sql` 脚本文件，这将创建所需的表和存储过程。</span><span class="sxs-lookup"><span data-stu-id="c73bc-235">Perhaps the easiest way to get the error log source infrastructure on the production database is to use SQL Server Management Studio to connect to the production database and then execute the `SqlServer.sql` script file, which will create the needed table and stored procedures.</span></span>

### <a name="viewing-the-error-details-page-on-production"></a><span data-ttu-id="c73bc-236">查看生产中的错误详细信息页</span><span class="sxs-lookup"><span data-stu-id="c73bc-236">Viewing the Error Details Page on Production</span></span>

<span data-ttu-id="c73bc-237">将站点部署到生产环境后，请访问生产网站并生成未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c73bc-237">After deploying your site to production, visit the production website and generate an unhandled exception.</span></span> <span data-ttu-id="c73bc-238">与开发环境一样，ELMAH 不会对在发生未经处理的异常时所显示的错误页产生任何影响;而只是记录错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-238">As in the development environment, ELMAH has no affect on the error page displayed when an unhandled exception occurs; instead, it merely logs the error.</span></span> <span data-ttu-id="c73bc-239">如果尝试从生产环境访问 "错误日志" 页（`elmah.axd`），则将看到另与**图 6**中所示的 "禁止访问" 页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-239">If you attempt to visit the error log page (`elmah.axd`) from the production environment, you will be greeted with the Forbidden page shown in **Figure 6**.</span></span>

[![](logging-error-details-with-elmah-cs/_static/image15.png)](logging-error-details-with-elmah-cs/_static/image14.png)

<span data-ttu-id="c73bc-240">**图 6**：默认情况下，远程访问者无法查看错误日志网页</span><span class="sxs-lookup"><span data-stu-id="c73bc-240">**Figure 6**: By Default, Remote Visitors Cannot View the Error Log Web Page</span></span>  
<span data-ttu-id="c73bc-241">（[单击以查看完全大小的映像](logging-error-details-with-elmah-cs/_static/image16.png)）</span><span class="sxs-lookup"><span data-stu-id="c73bc-241">([Click to view full-size image](logging-error-details-with-elmah-cs/_static/image16.png))</span></span>

<span data-ttu-id="c73bc-242">请记住，在 ELMAH 配置的 `<security>` 部分，我们将 `allowRemoteAccess` 属性设置为0，这将禁止远程用户查看错误日志。</span><span class="sxs-lookup"><span data-stu-id="c73bc-242">Recall that in the ELMAH configuration's `<security>` section we set the `allowRemoteAccess` attribute to 0, which prohibits remote users from viewing the error log.</span></span> <span data-ttu-id="c73bc-243">必须禁止匿名访问者查看错误日志，因为错误详细信息可能会显示安全漏洞或其他敏感信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-243">It's important to prohibit anonymous visitors from viewing the error log, as the error details might reveal security vulnerabilities or other sensitive information.</span></span> <span data-ttu-id="c73bc-244">如果决定将此属性设置为1并启用对错误日志的远程访问，请务必锁定 `elmah.axd` 路径，以便只有授权的访问者可以访问它。</span><span class="sxs-lookup"><span data-stu-id="c73bc-244">If you decide to set this attribute to 1 and enable remote access to the error log then it is important to lock down the `elmah.axd` path so that only authorized visitors can access it.</span></span> <span data-ttu-id="c73bc-245">这可以通过将 `<location>` 元素添加到 `Web.config` 文件来实现。</span><span class="sxs-lookup"><span data-stu-id="c73bc-245">This can be achieved by adding a `<location>` element to the `Web.config` file.</span></span>

<span data-ttu-id="c73bc-246">以下配置仅允许管理员角色中的用户访问错误日志网页：</span><span class="sxs-lookup"><span data-stu-id="c73bc-246">The following configuration permits only users in the Admin role to access the error log web page:</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample5.xml)]

> [!NOTE]
> <span data-ttu-id="c73bc-247">管理员角色和系统中的三个用户（Jisun 和 Alice）已在[*配置使用应用程序服务*教程的网站](configuring-a-website-that-uses-application-services-cs.md)中添加。</span><span class="sxs-lookup"><span data-stu-id="c73bc-247">The Admin role and the three users in the system - Scott, Jisun, and Alice - were added in the [*Configuring a Website That Uses Application Services* tutorial](configuring-a-website-that-uses-application-services-cs.md).</span></span> <span data-ttu-id="c73bc-248">用户 Scott 和 Jisun 是管理员角色的成员。</span><span class="sxs-lookup"><span data-stu-id="c73bc-248">Users Scott and Jisun are members of the Admin role.</span></span> <span data-ttu-id="c73bc-249">有关身份验证和授权的详细信息，请参阅我的[网站安全教程](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="c73bc-249">For more information on authentication and authorization, refer to my [Website Security Tutorials](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md).</span></span>

<span data-ttu-id="c73bc-250">生产环境中的错误日志现在可以由远程用户查看;有关错误日志网页的屏幕截图，请参阅**图 3**、 **4**和**5** 。</span><span class="sxs-lookup"><span data-stu-id="c73bc-250">The error log on the production environment can now be viewed by remote users; refer back to **Figures 3**, **4**, and **5** for screen shots of the error log web page.</span></span> <span data-ttu-id="c73bc-251">但是，如果匿名或非管理员用户尝试查看错误日志页面，则会自动将其重定向到登录页（`Login.aspx`），如**图 7**所示。</span><span class="sxs-lookup"><span data-stu-id="c73bc-251">However, if an anonymous or non-Admin user attempts to view the error log page they are automatically redirected to the login page (`Login.aspx`), as **Figure 7** shows.</span></span>

[![](logging-error-details-with-elmah-cs/_static/image18.png)](logging-error-details-with-elmah-cs/_static/image17.png)

<span data-ttu-id="c73bc-252">**图 7**：未经授权的用户将自动重定向到登录页</span><span class="sxs-lookup"><span data-stu-id="c73bc-252">**Figure 7**: Unauthorized Users are Automatically Redirected to the Login Page</span></span>  
<span data-ttu-id="c73bc-253">（[单击以查看完全大小的映像](logging-error-details-with-elmah-cs/_static/image19.png)）</span><span class="sxs-lookup"><span data-stu-id="c73bc-253">([Click to view full-size image](logging-error-details-with-elmah-cs/_static/image19.png))</span></span>

### <a name="programmatically-logging-errors"></a><span data-ttu-id="c73bc-254">以编程方式记录错误</span><span class="sxs-lookup"><span data-stu-id="c73bc-254">Programmatically Logging Errors</span></span>

<span data-ttu-id="c73bc-255">ELMAH 的 `ErrorLogModule` HTTP 模块自动将未经处理的异常记录到指定的日志源中。</span><span class="sxs-lookup"><span data-stu-id="c73bc-255">ELMAH's `ErrorLogModule` HTTP Module automatically logs unhandled exceptions to the specified log source.</span></span> <span data-ttu-id="c73bc-256">或者，您可以通过使用 `ErrorSignal` 类及其 `Raise` 方法来记录错误，而无需引发未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c73bc-256">Alternatively, you can log an error without having to raise an unhandled exception by using the `ErrorSignal` class and its `Raise` method.</span></span> <span data-ttu-id="c73bc-257">向 `Raise` 方法传递 `Exception` 对象，并将其记录为已引发该异常，并已在未处理的情况下到达 ASP.NET 运行时。</span><span class="sxs-lookup"><span data-stu-id="c73bc-257">The `Raise` method is passed an `Exception` object and logs it as if that exception had been thrown and had reached the ASP.NET runtime without being handled.</span></span> <span data-ttu-id="c73bc-258">但差别在于，请求在调用 `Raise` 方法后继续正常执行，而引发的未经处理的异常将中断请求的正常执行，并导致 ASP.NET 运行时显示配置的错误页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-258">The difference, however, is that the request continues executing normally after the `Raise` method has been called, whereas a thrown, unhandled exception interrupts the request's normal execution and causes the ASP.NET runtime to display the configured error page.</span></span>

<span data-ttu-id="c73bc-259">如果某些操作可能会失败，则 `ErrorSignal` 类非常有用，但其失败对执行的整体操作并不是灾难性的。</span><span class="sxs-lookup"><span data-stu-id="c73bc-259">The `ErrorSignal` class is useful in situations where there is some action that may fail, but its failure is not catastrophic to the overall operation being performed.</span></span> <span data-ttu-id="c73bc-260">例如，网站可能包含一个采用用户输入的窗体，将其存储在数据库中，然后向用户发送一封电子邮件，告知他们信息已处理。</span><span class="sxs-lookup"><span data-stu-id="c73bc-260">For instance, a website may contain a form that takes the user's input, stores it in a database, and then sends the user an email informing them that they information was processed.</span></span> <span data-ttu-id="c73bc-261">如果成功将信息保存到数据库，则会发生什么情况，但在发送电子邮件时出现错误？</span><span class="sxs-lookup"><span data-stu-id="c73bc-261">What should happen if the information is saved to the database successfully, but there is an error when sending the email message?</span></span> <span data-ttu-id="c73bc-262">一种选择是引发异常，并将用户发送到错误页。</span><span class="sxs-lookup"><span data-stu-id="c73bc-262">One option would be to throw an exception and send the user to the error page.</span></span> <span data-ttu-id="c73bc-263">但是，这可能会让用户认为他们输入的信息未保存。</span><span class="sxs-lookup"><span data-stu-id="c73bc-263">However, this might confuse the user into thinking that the information they entered was not saved.</span></span> <span data-ttu-id="c73bc-264">另一种方法是记录与电子邮件相关的错误，但不以任何方式更改用户的体验。</span><span class="sxs-lookup"><span data-stu-id="c73bc-264">Another approach would be to log the email-related error, but not alter the user's experience in any way.</span></span> <span data-ttu-id="c73bc-265">这就是 `ErrorSignal` 类有用的地方。</span><span class="sxs-lookup"><span data-stu-id="c73bc-265">This is where the `ErrorSignal` class is useful.</span></span>

[!code-csharp[Main](logging-error-details-with-elmah-cs/samples/sample6.cs)]

## <a name="error-notification-via-email"></a><span data-ttu-id="c73bc-266">通过电子邮件发送的错误通知</span><span class="sxs-lookup"><span data-stu-id="c73bc-266">Error Notification Via Email</span></span>

<span data-ttu-id="c73bc-267">除了将错误记录到数据库之外，还可以将 ELMAH 配置为向指定接收方发送电子邮件错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-267">Along with logging errors to a database, ELMAH can also be configured to email error details to a specified recipient.</span></span> <span data-ttu-id="c73bc-268">此功能由 `ErrorMailModule` HTTP 模块提供;因此，必须在 `Web.config` 中注册此 HTTP 模块，才能通过电子邮件发送错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-268">This functionality is provided by the `ErrorMailModule` HTTP Module; therefore, you must register this HTTP Module in `Web.config` in order to send error details via email.</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample7.xml)]

<span data-ttu-id="c73bc-269">接下来，在 `<elmah>` 元素的 `<errorMail>` 部分指定有关错误电子邮件的信息，指示电子邮件的发件人和收件人、主题以及是否以异步方式发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-269">Next, specify information about the error email in the `<elmah>` element's `<errorMail>` section, indicating the email's sender and recipient, the subject, and whether the email is sent asynchronously.</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample8.xml)]

<span data-ttu-id="c73bc-270">使用上述设置后，当发生运行时错误时，ELMAH 会向 support@example.com 发送一封电子邮件，其中包含错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="c73bc-270">With the above settings in place, whenever a runtime error occurs ELMAH sends an email to support@example.com with the error details.</span></span> <span data-ttu-id="c73bc-271">ELMAH 的错误电子邮件包含与 "错误详细信息" 网页中显示的信息相同的信息，即错误消息、堆栈跟踪和服务器变量（请参阅**图 4**和**5**）。</span><span class="sxs-lookup"><span data-stu-id="c73bc-271">ELMAH's error email includes the same information shown in the error details web page, namely the error message, the stack trace, and the server variables (refer back to **Figures 4** and **5**).</span></span> <span data-ttu-id="c73bc-272">错误电子邮件还包括异常详细信息，即死亡内容的黄色屏幕（`YSOD.html`）。</span><span class="sxs-lookup"><span data-stu-id="c73bc-272">The error email also includes the Exception Details Yellow Screen of Death content as an attachment (`YSOD.html`).</span></span>

<span data-ttu-id="c73bc-273">**图 8**显示了通过访问 `Genre.aspx?ID=foo`生成的 ELMAH 错误电子邮件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-273">**Figure 8** shows ELMAH's error email generated by visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="c73bc-274">虽然**图 8**只显示错误消息和堆栈跟踪，但服务器变量会在电子邮件的正文中进一步向下提供。</span><span class="sxs-lookup"><span data-stu-id="c73bc-274">While **Figure 8** shows only the error message and stack trace, the server variables are included further down in the email's body.</span></span>

[![](logging-error-details-with-elmah-cs/_static/image21.png)](logging-error-details-with-elmah-cs/_static/image20.png)

<span data-ttu-id="c73bc-275">**图 8**：你可以配置 ELMAH 以通过电子邮件发送错误详细信息</span><span class="sxs-lookup"><span data-stu-id="c73bc-275">**Figure 8**: You Can Configure ELMAH To Send Error Details Via Email</span></span>  
<span data-ttu-id="c73bc-276">（[单击以查看完全大小的映像](logging-error-details-with-elmah-cs/_static/image22.png)）</span><span class="sxs-lookup"><span data-stu-id="c73bc-276">([Click to view full-size image](logging-error-details-with-elmah-cs/_static/image22.png))</span></span>

## <a name="only-logging-errors-of-interest"></a><span data-ttu-id="c73bc-277">仅记录相关错误</span><span class="sxs-lookup"><span data-stu-id="c73bc-277">Only Logging Errors Of Interest</span></span>

<span data-ttu-id="c73bc-278">默认情况下，ELMAH 记录每个未处理的异常的详细信息，包括404和其他 HTTP 错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-278">By default, ELMAH logs the details of every unhandled exception, including 404 and other HTTP errors.</span></span> <span data-ttu-id="c73bc-279">您可以指示 ELMAH 使用错误筛选来忽略这些错误或其他类型的错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-279">You can instruct ELMAH to ignore these or other types of errors using error filtering.</span></span> <span data-ttu-id="c73bc-280">筛选逻辑由 ELMAH 的 `ErrorFilterModule` HTTP 模块执行，你需要在 `Web.config` 中进行注册，才能使用筛选逻辑。</span><span class="sxs-lookup"><span data-stu-id="c73bc-280">The filtering logic is performed by ELMAH's `ErrorFilterModule` HTTP Module, which you'll need to register in `Web.config` in order to use the filtering logic.</span></span> <span data-ttu-id="c73bc-281">用于筛选的规则在 `<errorFilter>` 部分中指定。</span><span class="sxs-lookup"><span data-stu-id="c73bc-281">The rules for filtering are specified in the `<errorFilter>` section.</span></span>

<span data-ttu-id="c73bc-282">以下标记指示 ELMAH 不记录404错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-282">The following markup instructs ELMAH to not log 404 errors.</span></span>

[!code-xml[Main](logging-error-details-with-elmah-cs/samples/sample9.xml)]

> [!NOTE]
> <span data-ttu-id="c73bc-283">别忘了，若要使用错误筛选，必须注册 `ErrorFilterModule` HTTP 模块。</span><span class="sxs-lookup"><span data-stu-id="c73bc-283">Don't forget, in order to use error filtering you must register the `ErrorFilterModule` HTTP Module.</span></span>

<span data-ttu-id="c73bc-284">`<test>` 部分内的 `<equal>` 元素称为 "断言"。</span><span class="sxs-lookup"><span data-stu-id="c73bc-284">The `<equal>` element inside the `<test>` section is referred to as an assertion.</span></span> <span data-ttu-id="c73bc-285">如果断言的计算结果为 true，则将根据 ELMAH 的日志筛选错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-285">If the assertion evaluates to true then the error is filtered from ELMAH's log.</span></span> <span data-ttu-id="c73bc-286">还有其他断言，其中包括： `<greater>`、`<greater-or-equal>`、`<not-equal>`、`<lesser>`、`<lesser-or-equal>`等。</span><span class="sxs-lookup"><span data-stu-id="c73bc-286">There are other assertions available, including: `<greater>`, `<greater-or-equal>`, `<not-equal>`, `<lesser>`, `<lesser-or-equal>`, and so on.</span></span> <span data-ttu-id="c73bc-287">你还可以使用 `<and>` 和 `<or>` 布尔运算符来合并断言。</span><span class="sxs-lookup"><span data-stu-id="c73bc-287">You can also combine assertions using the `<and>` and `<or>` Boolean operators.</span></span> <span data-ttu-id="c73bc-288">此外，您甚至可以将简单的 JavaScript 表达式包含为断言，或在或 Visual Basic 中编写您自己C#的断言。</span><span class="sxs-lookup"><span data-stu-id="c73bc-288">What's more, you can even include a simple JavaScript expression as an assertion, or write your own assertions in C# or Visual Basic.</span></span>

<span data-ttu-id="c73bc-289">有关 ELMAH 的错误筛选功能的详细信息，请参阅[ELMAH wiki](https://code.google.com/p/elmah/w/list)中的[错误筛选部分](https://code.google.com/p/elmah/wiki/ErrorFiltering)。</span><span class="sxs-lookup"><span data-stu-id="c73bc-289">For more information on ELMAH's error filtering capabilities, refer to the [Error Filtering section](https://code.google.com/p/elmah/wiki/ErrorFiltering) in the [ELMAH wiki](https://code.google.com/p/elmah/w/list).</span></span>

## <a name="summary"></a><span data-ttu-id="c73bc-290">摘要</span><span class="sxs-lookup"><span data-stu-id="c73bc-290">Summary</span></span>

<span data-ttu-id="c73bc-291">ELMAH 提供一种简单而强大的机制，用于在 ASP.NET web 应用程序中记录错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-291">ELMAH provides a simple, yet powerful mechanism for logging errors in an ASP.NET web application.</span></span> <span data-ttu-id="c73bc-292">与 Microsoft 的运行状况监视系统类似，ELMAH 可以将错误记录到数据库中，并可以通过电子邮件将错误详细信息发送给开发人员。</span><span class="sxs-lookup"><span data-stu-id="c73bc-292">Like Microsoft's health monitoring system, ELMAH can log errors to a database and can send the error details to a developer via email.</span></span> <span data-ttu-id="c73bc-293">与运行状况监视系统不同，ELMAH 包含对更广泛的错误日志数据存储的全新支持，包括： Microsoft SQL Server、Microsoft Access、Oracle、XML 文件，等等。</span><span class="sxs-lookup"><span data-stu-id="c73bc-293">Unlike the health monitoring system, ELMAH includes out of the box support for a wider range of error log data stores, including: Microsoft SQL Server, Microsoft Access, Oracle, XML files, and several others.</span></span> <span data-ttu-id="c73bc-294">此外，ELMAH 还提供了一种内置机制，用于查看错误日志以及有关网页中特定错误的详细信息，`elmah.axd`。</span><span class="sxs-lookup"><span data-stu-id="c73bc-294">Moreover, ELMAH offers a built-in mechanism for viewing the error log and details about a specific error from a web page, `elmah.axd`.</span></span> <span data-ttu-id="c73bc-295">`elmah.axd` 页还可以将错误信息作为 RSS 源或以逗号分隔的值文件（CSV）的形式呈现，您可以使用 Microsoft Excel 读取该文件。</span><span class="sxs-lookup"><span data-stu-id="c73bc-295">The `elmah.axd` page can also render error information as an RSS feed or as a comma-separated value file (CSV), which you can read using Microsoft Excel.</span></span> <span data-ttu-id="c73bc-296">还可以指示 ELMAH 使用声明性或编程断言从日志中筛选错误。</span><span class="sxs-lookup"><span data-stu-id="c73bc-296">You can also instruct ELMAH to filter errors from the log using declarative or programmatic assertions.</span></span> <span data-ttu-id="c73bc-297">和 ELMAH 可以与 ASP.NET 版本1.x 应用程序一起使用。</span><span class="sxs-lookup"><span data-stu-id="c73bc-297">And ELMAH can be used with ASP.NET version 1.x applications.</span></span>

<span data-ttu-id="c73bc-298">每个已部署的应用程序都应有一些机制来自动记录未经处理的异常，并向开发团队发送通知。</span><span class="sxs-lookup"><span data-stu-id="c73bc-298">Every deployed application should have some mechanism for automatically logging unhandled exceptions and sending notification to the development team.</span></span> <span data-ttu-id="c73bc-299">此操作是使用运行状况监视来实现还是使用 ELMAH 为辅助。</span><span class="sxs-lookup"><span data-stu-id="c73bc-299">Whether this is accomplished using health monitoring or ELMAH is secondary.</span></span> <span data-ttu-id="c73bc-300">换句话说，无论你使用的是运行状况监视还是 ELMAH，都不是很重要。评估两个系统，然后选择最符合你需求的系统。</span><span class="sxs-lookup"><span data-stu-id="c73bc-300">In other words, it doesn't really matter much whether you use health monitoring or ELMAH; evaluate both systems and then choose the one that best fits your needs.</span></span> <span data-ttu-id="c73bc-301">基本上重要的是，一些机制可用于在生产环境中记录未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="c73bc-301">What is fundamentally important is that some mechanism be put in place to log unhandled exceptions in the production environment.</span></span>

<span data-ttu-id="c73bc-302">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="c73bc-302">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="c73bc-303">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="c73bc-303">Further Reading</span></span>

<span data-ttu-id="c73bc-304">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="c73bc-304">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="c73bc-305">ELMAH-错误日志记录模块和处理程序</span><span class="sxs-lookup"><span data-stu-id="c73bc-305">ELMAH - Error Logging Modules and Handlers</span></span>](http://dotnetslackers.com/articles/aspnet/ErrorLoggingModulesAndHandlers.aspx)
- <span data-ttu-id="c73bc-306">[ELMAH 项目页](https://code.google.com/p/elmah/)（源代码、示例、wiki）</span><span class="sxs-lookup"><span data-stu-id="c73bc-306">[ELMAH Project Page](https://code.google.com/p/elmah/) (source code, samples, wiki)</span></span>
- <span data-ttu-id="c73bc-307">[将 ELMAH 插入 Web 应用程序以捕获未经处理的异常](http://screencastaday.com/ScreenCasts/43_Plugging_Elmah_into_Web_Application_to_Catch_Unhandled_Exceptions.aspx)（视频）</span><span class="sxs-lookup"><span data-stu-id="c73bc-307">[Plugging ELMAH Into a Web Application to Catch Unhandled Exceptions](http://screencastaday.com/ScreenCasts/43_Plugging_Elmah_into_Web_Application_to_Catch_Unhandled_Exceptions.aspx) (video)</span></span>
- [<span data-ttu-id="c73bc-308">安全错误日志页面</span><span class="sxs-lookup"><span data-stu-id="c73bc-308">Security Error Log Pages</span></span>](https://code.google.com/p/elmah/wiki/SecuringErrorLogPages)
- [<span data-ttu-id="c73bc-309">使用 HTTP 模块和处理程序创建可插入的 ASP.NET 组件</span><span class="sxs-lookup"><span data-stu-id="c73bc-309">Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components</span></span>](https://msdn.microsoft.com/library/aa479332.aspx)
- [<span data-ttu-id="c73bc-310">网站安全教程</span><span class="sxs-lookup"><span data-stu-id="c73bc-310">Website Security Tutorials</span></span>](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md)

> [!div class="step-by-step"]
> <span data-ttu-id="c73bc-311">[上一页](logging-error-details-with-asp-net-health-monitoring-cs.md)
> [下一页](precompiling-your-website-cs.md)</span><span class="sxs-lookup"><span data-stu-id="c73bc-311">[Previous](logging-error-details-with-asp-net-health-monitoring-cs.md)
[Next](precompiling-your-website-cs.md)</span></span>
