---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
title: 使用实体框架4.0 和 ObjectDataSource 控件，第1部分：入门 |Microsoft Docs
author: tdykstra
description: 本教程系列在使用实体框架教程系列的入门创建的 Contoso 大学 web 应用程序上构建。 如果 yo 。
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 244278c1-fec8-4255-8a8a-13bde491c4f5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
msc.type: authoredcontent
ms.openlocfilehash: 2f14707eb058d438495dd2bc4c17b976c471fc97
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78440402"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-1-getting-started"></a><span data-ttu-id="e6aec-104">使用实体框架4.0 和 ObjectDataSource 控件，第1部分：入门</span><span class="sxs-lookup"><span data-stu-id="e6aec-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 1: Getting Started</span></span>

<span data-ttu-id="e6aec-105">作者： [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="e6aec-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="e6aec-106">本教程系列在[使用实体框架 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)教程系列的入门创建的 Contoso 大学 web 应用程序上构建。</span><span class="sxs-lookup"><span data-stu-id="e6aec-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series.</span></span> <span data-ttu-id="e6aec-107">如果你没有完成前面的教程，作为本教程的起点，你可以下载你要创建[的应用程序](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="e6aec-108">你还可以下载完整的系列教程创建的[应用程序](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span>
> 
> <span data-ttu-id="e6aec-109">Contoso 大学示例 web 应用程序演示了如何使用实体框架4.0 和 Visual Studio 2010 创建 ASP.NET Web 窗体应用程序。</span><span class="sxs-lookup"><span data-stu-id="e6aec-109">The Contoso University sample web application demonstrates how to create ASP.NET Web Forms applications using the Entity Framework 4.0 and Visual Studio 2010.</span></span> <span data-ttu-id="e6aec-110">该示例应用程序是一个虚构的 Contoso 大学的网站。</span><span class="sxs-lookup"><span data-stu-id="e6aec-110">The sample application is a website for a fictional Contoso University.</span></span> <span data-ttu-id="e6aec-111">它包括诸如学生入学、 课程创建和导师分配等功能。</span><span class="sxs-lookup"><span data-stu-id="e6aec-111">It includes functionality such as student admission, course creation, and instructor assignments.</span></span>
> 
> <span data-ttu-id="e6aec-112">本教程演示中C#的示例。</span><span class="sxs-lookup"><span data-stu-id="e6aec-112">The tutorial shows examples in C#.</span></span> <span data-ttu-id="e6aec-113">[可下载的示例](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)包含C#和 Visual Basic 中的代码。</span><span class="sxs-lookup"><span data-stu-id="e6aec-113">The [downloadable sample](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) contains code in both C# and Visual Basic.</span></span>
> 
> ## <a name="database-first"></a><span data-ttu-id="e6aec-114">Database First</span><span class="sxs-lookup"><span data-stu-id="e6aec-114">Database First</span></span>
> 
> <span data-ttu-id="e6aec-115">可以通过三种方式使用实体框架中的数据： *Database First*、 *Model First*和*Code First*。</span><span class="sxs-lookup"><span data-stu-id="e6aec-115">There are three ways you can work with data in the Entity Framework: *Database First*, *Model First*, and *Code First*.</span></span> <span data-ttu-id="e6aec-116">本教程适用于 Database First。</span><span class="sxs-lookup"><span data-stu-id="e6aec-116">This tutorial is for Database First.</span></span> <span data-ttu-id="e6aec-117">有关这些工作流之间的差异以及如何为你的方案选择最佳方案的指南的信息，请参阅[实体框架开发工作流](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-117">For information about the differences between these workflows and guidance on how to choose the best one for your scenario, see [Entity Framework Development Workflows](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span></span>
> 
> ## <a name="web-forms"></a><span data-ttu-id="e6aec-118">Web Forms — Web 窗体</span><span class="sxs-lookup"><span data-stu-id="e6aec-118">Web Forms</span></span>
> 
> <span data-ttu-id="e6aec-119">与入门系列一样，本教程系列使用 ASP.NET Web 窗体模型，并假设你知道如何在 Visual Studio 中使用 ASP.NET Web 窗体。</span><span class="sxs-lookup"><span data-stu-id="e6aec-119">Like the Getting Started series, this tutorial series uses the ASP.NET Web Forms model and assumes you know how to work with ASP.NET Web Forms in Visual Studio.</span></span> <span data-ttu-id="e6aec-120">否则，请参阅[ASP.NET 4.5 Web Forms 入门](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-120">If you don't, see [Getting Started with ASP.NET 4.5 Web Forms](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span></span> <span data-ttu-id="e6aec-121">如果希望使用 ASP.NET MVC 框架，请参阅[使用 ASP.NET mvc 入门与实体框架](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-121">If you prefer to work with the ASP.NET MVC framework, see [Getting Started with the Entity Framework using ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>
> 
> ## <a name="software-versions"></a><span data-ttu-id="e6aec-122">软件版本</span><span class="sxs-lookup"><span data-stu-id="e6aec-122">Software versions</span></span>
> 
> | <span data-ttu-id="e6aec-123">**教程中所示**</span><span class="sxs-lookup"><span data-stu-id="e6aec-123">**Shown in the tutorial**</span></span> | <span data-ttu-id="e6aec-124">**还适用于**</span><span class="sxs-lookup"><span data-stu-id="e6aec-124">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="e6aec-125">Windows 7</span><span class="sxs-lookup"><span data-stu-id="e6aec-125">Windows 7</span></span> | <span data-ttu-id="e6aec-126">Windows 8</span><span class="sxs-lookup"><span data-stu-id="e6aec-126">Windows 8</span></span> |
> | <span data-ttu-id="e6aec-127">Visual Studio 2010</span><span class="sxs-lookup"><span data-stu-id="e6aec-127">Visual Studio 2010</span></span> | <span data-ttu-id="e6aec-128">Visual Studio 2010 Express for Web。</span><span class="sxs-lookup"><span data-stu-id="e6aec-128">Visual Studio 2010 Express for Web.</span></span> <span data-ttu-id="e6aec-129">本教程尚未通过更高版本的 Visual Studio 进行测试。</span><span class="sxs-lookup"><span data-stu-id="e6aec-129">The tutorial has not been tested with later versions of Visual Studio.</span></span> <span data-ttu-id="e6aec-130">菜单选择、对话框和模板有很多不同之处。</span><span class="sxs-lookup"><span data-stu-id="e6aec-130">There are many differences in menu selections, dialog boxes, and templates.</span></span> |
> | <span data-ttu-id="e6aec-131">.NET 4</span><span class="sxs-lookup"><span data-stu-id="e6aec-131">.NET 4</span></span> | <span data-ttu-id="e6aec-132">.NET 4.5 向后兼容 .NET 4，但本教程尚未通过 .NET 4.5 进行测试。</span><span class="sxs-lookup"><span data-stu-id="e6aec-132">.NET 4.5 is backward compatible with .NET 4, but the tutorial has not been tested with .NET 4.5.</span></span> |
> | <span data-ttu-id="e6aec-133">实体框架4</span><span class="sxs-lookup"><span data-stu-id="e6aec-133">Entity Framework 4</span></span> | <span data-ttu-id="e6aec-134">本教程尚未测试实体框架的更高版本。</span><span class="sxs-lookup"><span data-stu-id="e6aec-134">The tutorial has not been tested with later versions of Entity Framework.</span></span> <span data-ttu-id="e6aec-135">从实体框架5开始，EF 默认使用 EF 4.1 引入的 `DbContext API`。</span><span class="sxs-lookup"><span data-stu-id="e6aec-135">Starting with Entity Framework 5, EF uses by default the `DbContext API` that was introduced with EF 4.1.</span></span> <span data-ttu-id="e6aec-136">EntityDataSource 控件设计为使用 `ObjectContext` API。</span><span class="sxs-lookup"><span data-stu-id="e6aec-136">The EntityDataSource control was designed to use the `ObjectContext` API.</span></span> <span data-ttu-id="e6aec-137">有关如何将 EntityDataSource 控件与 `DbContext` API 一起使用的信息，请参阅[此博客文章](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-137">For information about how to use the EntityDataSource control with the `DbContext` API, see [this blog post](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span></span> |
> 
> ## <a name="questions"></a><span data-ttu-id="e6aec-138">问题</span><span class="sxs-lookup"><span data-stu-id="e6aec-138">Questions</span></span>
> 
> <span data-ttu-id="e6aec-139">如果你有与本教程不直接相关的问题，则可以将其发布到[ASP.NET 实体框架论坛](https://forums.asp.net/1227.aspx)、[实体框架和 LINQ to Entities 论坛](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/)，或[StackOverflow.com](http://stackoverflow.com/)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-139">If you have questions that are not directly related to the tutorial, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx), the [Entity Framework and LINQ to Entities forum](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), or [StackOverflow.com](http://stackoverflow.com/).</span></span>

<span data-ttu-id="e6aec-140">`EntityDataSource` 控件使您能够快速创建应用程序，但它通常要求您在 *.aspx*页面中保留大量的业务逻辑和数据访问逻辑。</span><span class="sxs-lookup"><span data-stu-id="e6aec-140">The `EntityDataSource` control enables you to create an application very quickly, but it typically requires you to keep a significant amount of business logic and data-access logic in your *.aspx* pages.</span></span> <span data-ttu-id="e6aec-141">如果你希望应用程序的复杂性增加并需要持续维护，则可以提前投入更多的开发时间，以便创建具有更好维护性的*n 层*或*分层*应用程序结构。</span><span class="sxs-lookup"><span data-stu-id="e6aec-141">If you expect your application to grow in complexity and to require ongoing maintenance, you can invest more development time up front in order to create an *n-tier* or *layered* application structure that's more maintainable.</span></span> <span data-ttu-id="e6aec-142">若要实现此体系结构，请将表示层与业务逻辑层（BLL）和数据访问层（DAL）分开。</span><span class="sxs-lookup"><span data-stu-id="e6aec-142">To implement this architecture, you separate the presentation layer from the business logic layer (BLL) and the data access layer (DAL).</span></span> <span data-ttu-id="e6aec-143">实现此结构的一种方法是使用 `ObjectDataSource` 控件而不是 `EntityDataSource` 控件。</span><span class="sxs-lookup"><span data-stu-id="e6aec-143">One way to implement this structure is to use the `ObjectDataSource` control instead of the `EntityDataSource` control.</span></span> <span data-ttu-id="e6aec-144">当使用 `ObjectDataSource` 控件时，可以实现自己的数据访问代码，然后使用与其他数据源控件具有许多相同功能的控件在 .aspx 页中调用该代码 *。*</span><span class="sxs-lookup"><span data-stu-id="e6aec-144">When you use the `ObjectDataSource` control, you implement your own data-access code and then invoke it in *.aspx* pages using a control that has many of the same features as other data-source controls.</span></span> <span data-ttu-id="e6aec-145">这使您可以将 n 层方法的优点与使用 Web 窗体控件进行数据访问的好处结合起来。</span><span class="sxs-lookup"><span data-stu-id="e6aec-145">This lets you combine the advantages of an n-tier approach with the benefits of using a Web Forms control for data access.</span></span>

<span data-ttu-id="e6aec-146">`ObjectDataSource` 控件也可为您提供更多的灵活性。</span><span class="sxs-lookup"><span data-stu-id="e6aec-146">The `ObjectDataSource` control gives you more flexibility in other ways as well.</span></span> <span data-ttu-id="e6aec-147">由于你编写自己的数据访问代码，因此更容易执行除读取、插入、更新或删除特定实体类型之外的其他操作，这是 `EntityDataSource` 控件旨在执行的任务。</span><span class="sxs-lookup"><span data-stu-id="e6aec-147">Because you write your own data-access code, it's easier to do more than just read, insert, update, or delete a specific entity type, which are the tasks that the `EntityDataSource` control is designed to perform.</span></span> <span data-ttu-id="e6aec-148">例如，您可以在每次更新实体时执行日志记录、每次删除实体时存档数据，或在插入具有外键值的行时自动检查和更新相关数据。</span><span class="sxs-lookup"><span data-stu-id="e6aec-148">For example, you can perform logging every time an entity is updated, archive data whenever an entity is deleted, or automatically check and update related data as needed when inserting a row with a foreign key value.</span></span>

## <a name="business-logic-and-repository-classes"></a><span data-ttu-id="e6aec-149">业务逻辑和存储库类</span><span class="sxs-lookup"><span data-stu-id="e6aec-149">Business Logic and Repository Classes</span></span>

<span data-ttu-id="e6aec-150">`ObjectDataSource` 控件的工作原理是调用你创建的类。</span><span class="sxs-lookup"><span data-stu-id="e6aec-150">An `ObjectDataSource` control works by invoking a class that you create.</span></span> <span data-ttu-id="e6aec-151">类包括用于检索和更新数据的方法，并向标记中的 `ObjectDataSource` 控件提供这些方法的名称。</span><span class="sxs-lookup"><span data-stu-id="e6aec-151">The class includes methods that retrieve and update data, and you provide the names of those methods to the `ObjectDataSource` control in markup.</span></span> <span data-ttu-id="e6aec-152">在呈现或回发处理期间，`ObjectDataSource` 会调用您指定的方法。</span><span class="sxs-lookup"><span data-stu-id="e6aec-152">During rendering or postback processing, the `ObjectDataSource` calls the methods that you've specified.</span></span>

<span data-ttu-id="e6aec-153">除了基本的 CRUD 操作，创建的用于 `ObjectDataSource` 控件的类在 `ObjectDataSource` 读取或更新数据时可能需要执行业务逻辑。</span><span class="sxs-lookup"><span data-stu-id="e6aec-153">Besides basic CRUD operations, the class that you create to use with the `ObjectDataSource` control might need to execute business logic when the `ObjectDataSource` reads or updates data.</span></span> <span data-ttu-id="e6aec-154">例如，在更新部门时，可能需要验证没有其他部门拥有相同的管理员，因为一个人员不能是多个部门的管理员。</span><span class="sxs-lookup"><span data-stu-id="e6aec-154">For example, when you update a department, you might need to validate that no other departments have the same administrator because one person cannot be administrator of more than one department.</span></span>

<span data-ttu-id="e6aec-155">在某些 `ObjectDataSource` 文档（如[ObjectDataSource 类概述](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx)）中，控件调用一个称为*业务对象*的类，该对象同时包含业务逻辑和数据访问逻辑。</span><span class="sxs-lookup"><span data-stu-id="e6aec-155">In some `ObjectDataSource` documentation, such as the [ObjectDataSource Class overview](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), the control calls a class referred to as a *business object* that includes both business logic and data-access logic.</span></span> <span data-ttu-id="e6aec-156">在本教程中，您将为业务逻辑和数据访问逻辑创建单独的类。</span><span class="sxs-lookup"><span data-stu-id="e6aec-156">In this tutorial you will create separate classes for business logic and for data-access logic.</span></span> <span data-ttu-id="e6aec-157">封装数据访问逻辑的类称为 "*存储库*"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-157">The class that encapsulates data-access logic is called a *repository*.</span></span> <span data-ttu-id="e6aec-158">业务逻辑类既包含业务逻辑方法又包含数据访问方法，但数据访问方法调用存储库来执行数据访问任务。</span><span class="sxs-lookup"><span data-stu-id="e6aec-158">The business logic class includes both business-logic methods and data-access methods, but the data-access methods call the repository to perform data-access tasks.</span></span>

<span data-ttu-id="e6aec-159">你还将在 BLL 和 DAL 之间创建一个抽象层，用于简化 BLL 的自动单元测试。</span><span class="sxs-lookup"><span data-stu-id="e6aec-159">You will also create an abstraction layer between your BLL and DAL that facilitates automated unit testing of the BLL.</span></span> <span data-ttu-id="e6aec-160">此抽象层是通过以下方式实现的：创建一个接口，然后在业务逻辑类中实例化该存储库时使用接口。</span><span class="sxs-lookup"><span data-stu-id="e6aec-160">This abstraction layer is implemented by creating an interface and using the interface when you instantiate the repository in the business-logic class.</span></span> <span data-ttu-id="e6aec-161">这使你可以向业务逻辑类提供对实现存储库接口的任何对象的引用。</span><span class="sxs-lookup"><span data-stu-id="e6aec-161">This makes it possible for you to provide the business-logic class with a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="e6aec-162">对于正常操作，提供与实体框架一起使用的存储库对象。</span><span class="sxs-lookup"><span data-stu-id="e6aec-162">For normal operation, you provide a repository object that works with the Entity Framework.</span></span> <span data-ttu-id="e6aec-163">对于测试，你提供了一个存储库对象，该对象可处理以你可以轻松操作的方式（如定义为集合的类变量）存储的数据。</span><span class="sxs-lookup"><span data-stu-id="e6aec-163">For testing, you provide a repository object that works with data stored in a way that you can easily manipulate, such as class variables defined as collections.</span></span>

<span data-ttu-id="e6aec-164">下图显示了业务逻辑类（其中包含没有存储库的数据访问逻辑）与使用存储库的数据访问逻辑之间的差异。</span><span class="sxs-lookup"><span data-stu-id="e6aec-164">The following illustration shows the difference between a business-logic class that includes data-access logic without a repository and one that uses a repository.</span></span>

<span data-ttu-id="e6aec-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span></span>

<span data-ttu-id="e6aec-166">首先创建一个网页，将 `ObjectDataSource` 控件直接绑定到存储库，因为它只执行基本的数据访问任务。</span><span class="sxs-lookup"><span data-stu-id="e6aec-166">You will begin by creating web pages in which the `ObjectDataSource` control is bound directly to a repository because it only performs basic data-access tasks.</span></span> <span data-ttu-id="e6aec-167">在下一教程中，你将使用验证逻辑创建业务逻辑类，并将 `ObjectDataSource` 控件绑定到该类而不是存储库类。</span><span class="sxs-lookup"><span data-stu-id="e6aec-167">In the next tutorial you will create a business logic class with validation logic and bind the `ObjectDataSource` control to that class instead of to the repository class.</span></span> <span data-ttu-id="e6aec-168">你还将为验证逻辑创建单元测试。</span><span class="sxs-lookup"><span data-stu-id="e6aec-168">You will also create unit tests for the validation logic.</span></span> <span data-ttu-id="e6aec-169">在本系列教程的第三个教程中，你将向应用程序添加排序和筛选功能。</span><span class="sxs-lookup"><span data-stu-id="e6aec-169">In the third tutorial in this series you will add sorting and filtering functionality to the application.</span></span>

<span data-ttu-id="e6aec-170">您在本教程中创建的页面将使用您在[入门教程系列](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)中创建的数据模型的 `Departments` 实体集。</span><span class="sxs-lookup"><span data-stu-id="e6aec-170">The pages you create in this tutorial work with the `Departments` entity set of the data model that you created in the [Getting Started tutorial series](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span></span>

<span data-ttu-id="e6aec-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span></span>

<span data-ttu-id="e6aec-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span></span>

## <a name="updating-the-database-and-the-data-model"></a><span data-ttu-id="e6aec-173">更新数据库和数据模型</span><span class="sxs-lookup"><span data-stu-id="e6aec-173">Updating the Database and the Data Model</span></span>

<span data-ttu-id="e6aec-174">在本教程中，将对数据库进行两次更改，这两个更改都需要[使用实体框架和 Web 窗体](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)教程对入门中创建的数据模型进行相应的更改。</span><span class="sxs-lookup"><span data-stu-id="e6aec-174">You will begin this tutorial by making two changes to the database, both of which require corresponding changes to the data model that you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorials.</span></span> <span data-ttu-id="e6aec-175">在其中一个教程中，您在设计器中进行了手动更改，以便在数据库更改后将数据模型与数据库同步。</span><span class="sxs-lookup"><span data-stu-id="e6aec-175">In one of those tutorials, you made changes in the designer manually to synchronize the data model with the database after a database change.</span></span> <span data-ttu-id="e6aec-176">在本教程中，您将使用设计器的 "**从数据库更新模型**" 工具来自动更新数据模型。</span><span class="sxs-lookup"><span data-stu-id="e6aec-176">In this tutorial, you will use the designer's **Update Model From Database** tool to update the data model automatically.</span></span>

### <a name="adding-a-relationship-to-the-database"></a><span data-ttu-id="e6aec-177">向数据库添加关系</span><span class="sxs-lookup"><span data-stu-id="e6aec-177">Adding a Relationship to the Database</span></span>

<span data-ttu-id="e6aec-178">在 Visual Studio 中，打开在 "[实体框架" 和 "Web 窗体](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)" 教程系列的入门中创建的 Contoso 大学 web 应用程序，然后打开 `SchoolDiagram` 数据库关系图。</span><span class="sxs-lookup"><span data-stu-id="e6aec-178">In Visual Studio, open the Contoso University web application you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series, and then open the `SchoolDiagram` database diagram.</span></span>

<span data-ttu-id="e6aec-179">如果在数据库关系图中查看 `Department` 表，将看到它有一个 `Administrator` 列。</span><span class="sxs-lookup"><span data-stu-id="e6aec-179">If you look at the `Department` table in the database diagram, you will see that it has an `Administrator` column.</span></span> <span data-ttu-id="e6aec-180">此列是 `Person` 表的外键，但在数据库中未定义外键关系。</span><span class="sxs-lookup"><span data-stu-id="e6aec-180">This column is a foreign key to the `Person` table, but no foreign key relationship is defined in the database.</span></span> <span data-ttu-id="e6aec-181">您需要创建关系并更新数据模型，以便实体框架可以自动处理此关系。</span><span class="sxs-lookup"><span data-stu-id="e6aec-181">You need to create the relationship and update the data model so that the Entity Framework can automatically handle this relationship.</span></span>

<span data-ttu-id="e6aec-182">在数据库关系图中，右键单击 `Department` 表，然后选择 "**关系**"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-182">In the database diagram, right-click the `Department` table, and select **Relationships**.</span></span>

<span data-ttu-id="e6aec-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span></span>

<span data-ttu-id="e6aec-184">在 "**外键关系**" 对话框中，单击 "**添加**"，然后单击 "**表和列规范**" 的省略号。</span><span class="sxs-lookup"><span data-stu-id="e6aec-184">In the **Foreign Key Relationships** box click **Add**, then click the ellipsis for **Tables and Columns Specification**.</span></span>

<span data-ttu-id="e6aec-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span></span>

<span data-ttu-id="e6aec-186">在 "**表和列**" 对话框中，将主键表和字段设置为 `Person` 和 `PersonID`，然后将外键表和字段设置为 `Department` 和 `Administrator`。</span><span class="sxs-lookup"><span data-stu-id="e6aec-186">In the **Tables and Columns** dialog box, set the primary key table and field to `Person` and `PersonID`, and set the foreign key table and field to `Department` and `Administrator`.</span></span> <span data-ttu-id="e6aec-187">（如果执行此操作，关系名称将从 `FK_Department_Department` 更改为 `FK_Department_Person`。）</span><span class="sxs-lookup"><span data-stu-id="e6aec-187">(When you do this, the relationship name will change from `FK_Department_Department` to `FK_Department_Person`.)</span></span>

<span data-ttu-id="e6aec-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span></span>

<span data-ttu-id="e6aec-189">在 "**表和列**" 框中单击 **"确定"** ，在 "**外键关系**" 框中单击 "**关闭**"，并保存所做的更改。</span><span class="sxs-lookup"><span data-stu-id="e6aec-189">Click **OK** in the **Tables and Columns** box, click **Close** in the **Foreign Key Relationships** box, and save the changes.</span></span> <span data-ttu-id="e6aec-190">如果系统询问您是否要保存 `Person` 和 `Department` 表，请单击 **"是"** 。</span><span class="sxs-lookup"><span data-stu-id="e6aec-190">If you're asked if you want to save the `Person` and `Department` tables, click **Yes**.</span></span>

> [!NOTE]
> <span data-ttu-id="e6aec-191">如果已删除 `Person` 与 `Administrator` 列中的数据相对应的行，则将无法保存此更改。</span><span class="sxs-lookup"><span data-stu-id="e6aec-191">If you've deleted `Person` rows that correspond to data that's already in the `Administrator` column, you will not be able to save this change.</span></span> <span data-ttu-id="e6aec-192">在这种情况下，请使用**服务器资源管理器**中的表编辑器来确保每个 `Department` 行中的 `Administrator` 值包含在 `Person` 表中实际存在的记录的 ID。</span><span class="sxs-lookup"><span data-stu-id="e6aec-192">In that case, use the table editor in **Server Explorer** to make sure that the `Administrator` value in every `Department` row contains the ID of a record that actually exists in the `Person` table.</span></span>
> 
> <span data-ttu-id="e6aec-193">保存更改后，如果用户是部门管理员，将无法从 `Person` 表中删除行。</span><span class="sxs-lookup"><span data-stu-id="e6aec-193">After you save the change, you will not be able to delete a row from the `Person` table if that person is a department administrator.</span></span> <span data-ttu-id="e6aec-194">在生产应用程序中，您可以在数据库约束阻止删除时提供特定的错误消息，也可以指定级联删除。</span><span class="sxs-lookup"><span data-stu-id="e6aec-194">In a production application, you would provide a specific error message when a database constraint prevents a deletion, or you would specify a cascading delete.</span></span> <span data-ttu-id="e6aec-195">有关如何指定级联删除的示例，请参阅[实体框架和 ASP.NET –入门第2部分](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md)。</span><span class="sxs-lookup"><span data-stu-id="e6aec-195">For an example of how to specify a cascading delete, see [The Entity Framework and ASP.NET – Getting Started Part 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span></span>

### <a name="adding-a-view-to-the-database"></a><span data-ttu-id="e6aec-196">向数据库添加视图</span><span class="sxs-lookup"><span data-stu-id="e6aec-196">Adding a View to the Database</span></span>

<span data-ttu-id="e6aec-197">在将创建*的新的*"node.js" 页面中，你想要提供讲师的下拉列表，名称采用 "last，first" 格式，以便用户可以选择部门管理员。</span><span class="sxs-lookup"><span data-stu-id="e6aec-197">In the new *Departments.aspx* page that you will be creating, you want to provide a drop-down list of instructors, with names in "last, first" format so that users can select department administrators.</span></span> <span data-ttu-id="e6aec-198">为了更轻松地执行此操作，您将在数据库中创建一个视图。</span><span class="sxs-lookup"><span data-stu-id="e6aec-198">To make it easier to do that, you will create a view in the database.</span></span> <span data-ttu-id="e6aec-199">视图将只包含下拉列表所需的数据：完整名称（格式正确）和记录键。</span><span class="sxs-lookup"><span data-stu-id="e6aec-199">The view will consist of just the data needed by the drop-down list: the full name (properly formatted) and the record key.</span></span>

<span data-ttu-id="e6aec-200">在**服务器资源管理器**中，展开 " *School*"，右键单击 "**视图**" 文件夹，然后选择 "**添加新视图**"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-200">In **Server Explorer**, expand *School.mdf*, right-click the **Views** folder, and select **Add New View**.</span></span>

<span data-ttu-id="e6aec-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span></span>

<span data-ttu-id="e6aec-202">在显示 "**添加表**" 对话框时单击 "**关闭**"，然后将以下 SQL 语句粘贴到 SQL 窗格中：</span><span class="sxs-lookup"><span data-stu-id="e6aec-202">Click **Close** when the **Add Table** dialog box appears, and paste the following SQL statement into the SQL pane:</span></span>

[!code-sql[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample1.sql)]

<span data-ttu-id="e6aec-203">将视图另存为 `vInstructorName`。</span><span class="sxs-lookup"><span data-stu-id="e6aec-203">Save the view as `vInstructorName`.</span></span>

### <a name="updating-the-data-model"></a><span data-ttu-id="e6aec-204">更新数据模型</span><span class="sxs-lookup"><span data-stu-id="e6aec-204">Updating the Data Model</span></span>

<span data-ttu-id="e6aec-205">在*DAL*文件夹中，打开*SchoolModel*文件，右键单击设计图面，然后选择 "**从数据库更新模型**"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-205">In the *DAL* folder, open the *SchoolModel.edmx* file, right-click the design surface, and select **Update Model from Database**.</span></span>

<span data-ttu-id="e6aec-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span></span>

<span data-ttu-id="e6aec-207">在 "**选择数据库对象**" 对话框中，选择 "**添加**" 选项卡并选择刚创建的视图。</span><span class="sxs-lookup"><span data-stu-id="e6aec-207">In the **Choose Your Database Objects** dialog box, select the **Add** tab and select the view you just created.</span></span>

<span data-ttu-id="e6aec-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span></span>

<span data-ttu-id="e6aec-209">单击“完成”。</span><span class="sxs-lookup"><span data-stu-id="e6aec-209">Click **Finish**.</span></span>

<span data-ttu-id="e6aec-210">在设计器中，可以看到该工具创建了一个 `vInstructorName` 实体和 `Department` 与 `Person` 实体之间的新关联。</span><span class="sxs-lookup"><span data-stu-id="e6aec-210">In the designer, you see that the tool created a `vInstructorName` entity and a new association between the `Department` and `Person` entities.</span></span>

<span data-ttu-id="e6aec-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span></span>

> [!NOTE]
> <span data-ttu-id="e6aec-212">在 "**输出**" 和 "**错误列表**" 窗口中，你可能会看到一条警告消息，告知你该工具为新的 `vInstructorName` 视图自动创建了主键。</span><span class="sxs-lookup"><span data-stu-id="e6aec-212">In the **Output** and **Error List** windows you might see a warning message informing you that the tool automatically created a primary key for the new `vInstructorName` view.</span></span> <span data-ttu-id="e6aec-213">这是预期行为。</span><span class="sxs-lookup"><span data-stu-id="e6aec-213">This is expected behavior.</span></span>

<span data-ttu-id="e6aec-214">如果在代码中引用新的 `vInstructorName` 实体，则不希望使用将小写字母 "v" 作为前缀的数据库约定。</span><span class="sxs-lookup"><span data-stu-id="e6aec-214">When you refer to the new `vInstructorName` entity in code, you don't want to use the database convention of prefixing a lower-case "v" to it.</span></span> <span data-ttu-id="e6aec-215">因此，您将重命名模型中的实体和实体集。</span><span class="sxs-lookup"><span data-stu-id="e6aec-215">Therefore, you will rename the entity and entity set in the model.</span></span>

<span data-ttu-id="e6aec-216">打开**模型浏览器**。</span><span class="sxs-lookup"><span data-stu-id="e6aec-216">Open the **Model Browser**.</span></span> <span data-ttu-id="e6aec-217">您将看到 `vInstructorName` 作为实体类型和视图列出。</span><span class="sxs-lookup"><span data-stu-id="e6aec-217">You see `vInstructorName` listed as an entity type and a view.</span></span>

<span data-ttu-id="e6aec-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span></span>

<span data-ttu-id="e6aec-219">在**SchoolModel** （而不是**SchoolModel**）下，右键单击**VInstructorName** ，然后选择 "**属性**"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-219">Under **SchoolModel** (not **SchoolModel.Store**), right-click **vInstructorName** and select **Properties**.</span></span> <span data-ttu-id="e6aec-220">在 "**属性**" 窗口中，将 "**名称**" 属性更改为 "InstructorName"，并将 "**实体集名称**" 属性更改为 "InstructorNames"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-220">In the **Properties** window, change the **Name** property to "InstructorName" and change the **Entity Set Name** property to "InstructorNames".</span></span>

<span data-ttu-id="e6aec-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span></span>

<span data-ttu-id="e6aec-222">保存并关闭数据模型，然后重新生成项目。</span><span class="sxs-lookup"><span data-stu-id="e6aec-222">Save and close the data model, and then rebuild the project.</span></span>

## <a name="using-a-repository-class-and-an-objectdatasource-control"></a><span data-ttu-id="e6aec-223">使用存储库类和 ObjectDataSource 控件</span><span class="sxs-lookup"><span data-stu-id="e6aec-223">Using a Repository Class and an ObjectDataSource Control</span></span>

<span data-ttu-id="e6aec-224">在*DAL*文件夹中创建一个新的类文件，将其命名为*SchoolRepository.cs*，并将现有代码替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="e6aec-224">Create a new class file in the *DAL* folder, name it *SchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample2.cs)]

<span data-ttu-id="e6aec-225">此代码提供了一个 `GetDepartments` 方法，该方法返回 `Departments` 实体集中的所有实体。</span><span class="sxs-lookup"><span data-stu-id="e6aec-225">This code provides a single `GetDepartments` method that returns all of the entities in the `Departments` entity set.</span></span> <span data-ttu-id="e6aec-226">因为你知道将访问返回的每个行的 `Person` 导航属性，所以可以通过使用 `Include` 方法为该属性指定预先加载。</span><span class="sxs-lookup"><span data-stu-id="e6aec-226">Because you know that you will be accessing the `Person` navigation property for every row returned, you specify eager loading for that property by using the `Include` method.</span></span> <span data-ttu-id="e6aec-227">类还实现 `IDisposable` 接口，以确保在释放对象时释放数据库连接。</span><span class="sxs-lookup"><span data-stu-id="e6aec-227">The class also implements the `IDisposable` interface to ensure that the database connection is released when the object is disposed.</span></span>

> [!NOTE]
> <span data-ttu-id="e6aec-228">常见的做法是为每个实体类型创建一个存储库类。</span><span class="sxs-lookup"><span data-stu-id="e6aec-228">A common practice is to create a repository class for each entity type.</span></span> <span data-ttu-id="e6aec-229">在本教程中，使用了多个实体类型的一个存储库类。</span><span class="sxs-lookup"><span data-stu-id="e6aec-229">In this tutorial, one repository class for multiple entity types is used.</span></span> <span data-ttu-id="e6aec-230">有关存储库模式的详细信息，请参阅[实体框架团队博客](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx)和[Julie Lerman 的博客](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/)文章。</span><span class="sxs-lookup"><span data-stu-id="e6aec-230">For more information about the repository pattern, see the posts in [the Entity Framework team's blog](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) and [Julie Lerman's blog](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span></span>

<span data-ttu-id="e6aec-231">`GetDepartments` 方法返回一个 `IEnumerable` 对象而不是 `IQueryable` 对象，以确保即使在存储存储库对象本身后，返回的集合也可用。</span><span class="sxs-lookup"><span data-stu-id="e6aec-231">The `GetDepartments` method returns an `IEnumerable` object rather than an `IQueryable` object in order to ensure that the returned collection is usable even after the repository object itself is disposed.</span></span> <span data-ttu-id="e6aec-232">`IQueryable` 对象在访问时可能会导致数据库访问，但存储库对象可能会在数据绑定控件尝试呈现数据时被释放。</span><span class="sxs-lookup"><span data-stu-id="e6aec-232">An `IQueryable` object can cause database access whenever it's accessed, but the repository object might be disposed by the time a databound control attempts to render the data.</span></span> <span data-ttu-id="e6aec-233">可以返回其他集合类型，例如 `IList` 对象，而不是 `IEnumerable` 对象。</span><span class="sxs-lookup"><span data-stu-id="e6aec-233">You could return another collection type, such as an `IList` object instead of an `IEnumerable` object.</span></span> <span data-ttu-id="e6aec-234">然而，返回 `IEnumerable` 对象可确保执行典型的只读列表处理任务（如 `foreach` 循环和 LINQ 查询），但不能添加或删除集合中的项，这可能意味着此类更改会保留到数据库中。</span><span class="sxs-lookup"><span data-stu-id="e6aec-234">However, returning an `IEnumerable` object ensures that you can perform typical read-only list processing tasks such as `foreach` loops and LINQ queries, but you cannot add to or remove items in the collection, which might imply that such changes would be persisted to the database.</span></span>

<span data-ttu-id="e6aec-235">创建一个*使用* *网站*母版页的 "node.js" 页，并在名为 `Content2`的 `Content` 控件中添加以下标记：</span><span class="sxs-lookup"><span data-stu-id="e6aec-235">Create a *Departments.aspx* page that uses the *Site.Master* master page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample3.aspx)]

<span data-ttu-id="e6aec-236">此标记创建一个 `ObjectDataSource` 控件，该控件使用刚创建的存储库类，并使用 `GridView` 控件来显示数据。</span><span class="sxs-lookup"><span data-stu-id="e6aec-236">This markup creates an `ObjectDataSource` control that uses the repository class you just created, and a `GridView` control to display the data.</span></span> <span data-ttu-id="e6aec-237">`GridView` 控件指定了**Edit**和**Delete**命令，但你尚未添加代码来支持这些命令。</span><span class="sxs-lookup"><span data-stu-id="e6aec-237">The `GridView` control specifies **Edit** and **Delete** commands, but you haven't added code to support them yet.</span></span>

<span data-ttu-id="e6aec-238">几列使用 `DynamicField` 控件，以便您可以利用自动数据格式和验证功能。</span><span class="sxs-lookup"><span data-stu-id="e6aec-238">Several columns use `DynamicField` controls so that you can take advantage of automatic data formatting and validation functionality.</span></span> <span data-ttu-id="e6aec-239">要使其正常工作，必须在 `Page_Init` 事件处理程序中调用 `EnableDynamicData` 方法。</span><span class="sxs-lookup"><span data-stu-id="e6aec-239">For these to work, you will have to call the `EnableDynamicData` method in the `Page_Init` event handler.</span></span> <span data-ttu-id="e6aec-240">（`Administrator` 字段中不使用`DynamicControl` 控件，因为这些控件不适用于导航属性。）</span><span class="sxs-lookup"><span data-stu-id="e6aec-240">(`DynamicControl` controls are not used in the `Administrator` field because they don't work with navigation properties.)</span></span>

<span data-ttu-id="e6aec-241">稍后，在将具有嵌套 `GridView` 控件的列添加到网格中时，`Vertical-Align="Top"` 属性将变得很重要。</span><span class="sxs-lookup"><span data-stu-id="e6aec-241">The `Vertical-Align="Top"` attributes will become important later when you add a column that has a nested `GridView` control to the grid.</span></span>

<span data-ttu-id="e6aec-242">打开*Departments.aspx.cs*文件并添加以下 `using` 语句：</span><span class="sxs-lookup"><span data-stu-id="e6aec-242">Open the *Departments.aspx.cs* file and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample4.cs)]

<span data-ttu-id="e6aec-243">然后为该页的 `Init` 事件添加以下处理程序：</span><span class="sxs-lookup"><span data-stu-id="e6aec-243">Then add the following handler for the page's `Init` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample5.cs)]

<span data-ttu-id="e6aec-244">在*DAL*文件夹中，创建一个名为*Department.cs*的新类文件，并将现有代码替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="e6aec-244">In the *DAL* folder, create a new class file named *Department.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample6.cs)]

<span data-ttu-id="e6aec-245">此代码会将元数据添加到数据模型。</span><span class="sxs-lookup"><span data-stu-id="e6aec-245">This code adds metadata to the data model.</span></span> <span data-ttu-id="e6aec-246">它指定 `Department` 实体的 `Budget` 属性实际上表示货币，但其数据类型 `Decimal`，并指定该值必须介于0到 $1000000.00 之间。</span><span class="sxs-lookup"><span data-stu-id="e6aec-246">It specifies that the `Budget` property of the `Department` entity actually represents currency although its data type is `Decimal`, and it specifies that the value must be between 0 and $1,000,000.00.</span></span> <span data-ttu-id="e6aec-247">它还指定应采用格式 mm/dd/yyyy 格式将 `StartDate` 属性格式化为日期格式。</span><span class="sxs-lookup"><span data-stu-id="e6aec-247">It also specifies that the `StartDate` property should be formatted as a date in the format mm/dd/yyyy.</span></span>

<span data-ttu-id="e6aec-248">运行 " *node.js" 页。*</span><span class="sxs-lookup"><span data-stu-id="e6aec-248">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="e6aec-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span></span>

<span data-ttu-id="e6aec-250">请注意，虽然未在 "**预算**" 或 "**开始日期**" 列的 " *.aspx* " 页标记中指定格式字符串，但 `DynamicField` 控件已使用在*Department.cs*文件中提供的元数据将默认货币和日期格式应用于它们。</span><span class="sxs-lookup"><span data-stu-id="e6aec-250">Notice that although you did not specify a format string in the *Departments.aspx* page markup for the **Budget** or **Start Date** columns, default currency and date formatting has been applied to them by the `DynamicField` controls, using the metadata that you supplied in the *Department.cs* file.</span></span>

## <a name="adding-insert-and-delete-functionality"></a><span data-ttu-id="e6aec-251">添加插入和删除功能</span><span class="sxs-lookup"><span data-stu-id="e6aec-251">Adding Insert and Delete Functionality</span></span>

<span data-ttu-id="e6aec-252">打开*SchoolRepository.cs*，添加以下代码以创建 `Insert` 方法和 `Delete` 方法。</span><span class="sxs-lookup"><span data-stu-id="e6aec-252">Open *SchoolRepository.cs*, add the following code in order to create an `Insert` method and a `Delete` method.</span></span> <span data-ttu-id="e6aec-253">此代码还包括一个名为 `GenerateDepartmentID` 的方法，该方法用于计算 `Insert` 方法使用的下一个可用记录键值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-253">The code also includes a method named `GenerateDepartmentID` that calculates the next available record key value for use by the `Insert` method.</span></span> <span data-ttu-id="e6aec-254">这是必需的，因为未将数据库配置为自动为 `Department` 表计算此数据。</span><span class="sxs-lookup"><span data-stu-id="e6aec-254">This is required because the database is not configured to calculate this automatically for the `Department` table.</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample7.cs)]

### <a name="the-attach-method"></a><span data-ttu-id="e6aec-255">Attach 方法</span><span class="sxs-lookup"><span data-stu-id="e6aec-255">The Attach Method</span></span>

<span data-ttu-id="e6aec-256">`DeleteDepartment` 方法将调用 `Attach` 方法，以便重新建立在对象上下文的对象状态管理器中维护的链接，该链接在内存中的实体和它所表示的数据库行之间。</span><span class="sxs-lookup"><span data-stu-id="e6aec-256">The `DeleteDepartment` method calls the `Attach` method in order to re-establish the link that's maintained in the object context's object state manager between the entity in memory and the database row it represents.</span></span> <span data-ttu-id="e6aec-257">此方法必须在方法调用 `SaveChanges` 方法之前发生。</span><span class="sxs-lookup"><span data-stu-id="e6aec-257">This must occur before the method calls the `SaveChanges` method.</span></span>

<span data-ttu-id="e6aec-258">术语 "*对象上下文*" 是指派生自 `ObjectContext` 类的实体框架类，该类用于访问实体集和实体。</span><span class="sxs-lookup"><span data-stu-id="e6aec-258">The term *object context* refers to the Entity Framework class that derives from the `ObjectContext` class that you use to access your entity sets and entities.</span></span> <span data-ttu-id="e6aec-259">在此项目的代码中，类命名为 `SchoolEntities`，它的实例始终命名为 `context`。</span><span class="sxs-lookup"><span data-stu-id="e6aec-259">In the code for this project, the class is named `SchoolEntities`, and an instance of it is always named `context`.</span></span> <span data-ttu-id="e6aec-260">对象上下文的*对象状态管理器*是一个派生自 `ObjectStateManager` 类的类。</span><span class="sxs-lookup"><span data-stu-id="e6aec-260">The object context's *object state manager* is a class that derives from the `ObjectStateManager` class.</span></span> <span data-ttu-id="e6aec-261">对象联系人使用对象状态管理器来存储实体对象，并跟踪每个实体对象是否与数据库中的相应表行同步。</span><span class="sxs-lookup"><span data-stu-id="e6aec-261">The object contact uses the object state manager to store entity objects and to keep track of whether each one is in sync with its corresponding table row or rows in the database.</span></span>

<span data-ttu-id="e6aec-262">读取实体时，对象上下文会将其存储在对象状态管理器中，并跟踪对象的表示形式是否与数据库同步。</span><span class="sxs-lookup"><span data-stu-id="e6aec-262">When you read an entity, the object context stores it in the object state manager and keeps track of whether that representation of the object is in sync with the database.</span></span> <span data-ttu-id="e6aec-263">例如，如果您更改属性值，则将设置一个标志以指示您更改的属性将不再与数据库同步。</span><span class="sxs-lookup"><span data-stu-id="e6aec-263">For example, if you change a property value, a flag is set to indicate that the property you changed is no longer in sync with the database.</span></span> <span data-ttu-id="e6aec-264">然后，当调用 `SaveChanges` 方法时，对象上下文知道要在数据库中执行的操作，因为对象状态管理器确切知道实体的当前状态与数据库状态之间的差异。</span><span class="sxs-lookup"><span data-stu-id="e6aec-264">Then when you call the `SaveChanges` method, the object context knows what to do in the database because the object state manager knows exactly what's different between the current state of the entity and the state of the database.</span></span>

<span data-ttu-id="e6aec-265">但是，此过程通常在 web 应用程序中不起作用，因为在页面呈现后，读取实体的对象上下文实例以及其对象状态管理器中的所有内容都将被释放。</span><span class="sxs-lookup"><span data-stu-id="e6aec-265">However, this process typically does not work in a web application, because the object context instance that reads an entity, along with everything in its object state manager, is disposed after a page is rendered.</span></span> <span data-ttu-id="e6aec-266">必须应用更改的对象上下文实例是为回发处理实例化的新实例。</span><span class="sxs-lookup"><span data-stu-id="e6aec-266">The object context instance that must apply changes is a new one that's instantiated for postback processing.</span></span> <span data-ttu-id="e6aec-267">如果是 `DeleteDepartment` 方法，`ObjectDataSource` 控件将从视图状态的值为你重新创建实体的原始版本，但此重新创建的 `Department` 实体在对象状态管理器中不存在。</span><span class="sxs-lookup"><span data-stu-id="e6aec-267">In the case of the `DeleteDepartment` method, the `ObjectDataSource` control re-creates the original version of the entity for you from values in view state, but this re-created `Department` entity does not exist in the object state manager.</span></span> <span data-ttu-id="e6aec-268">如果在此重新创建的实体上调用了 `DeleteObject` 方法，则调用将失败，因为对象上下文不知道实体是否与数据库同步。</span><span class="sxs-lookup"><span data-stu-id="e6aec-268">If you called the `DeleteObject` method on this re-created entity, the call would fail because the object context does not know whether the entity is in sync with the database.</span></span> <span data-ttu-id="e6aec-269">但是，调用 `Attach` 方法会重新建立重新创建的实体与数据库中的相同跟踪，该实体是在对象上下文的早期实例中读取实体时自动完成的。</span><span class="sxs-lookup"><span data-stu-id="e6aec-269">However, calling the `Attach` method re-establishes the same tracking between the re-created entity and the values in the database that was originally done automatically when the entity was read in an earlier instance of the object context.</span></span>

<span data-ttu-id="e6aec-270">有时，您不希望对象上下文跟踪对象状态管理器中的实体，并且可以设置标志来防止其执行此操作。</span><span class="sxs-lookup"><span data-stu-id="e6aec-270">There are times when you don't want the object context to track entities in the object state manager, and you can set flags to prevent it from doing that.</span></span> <span data-ttu-id="e6aec-271">本系列后面的教程中显示了这种情况的示例。</span><span class="sxs-lookup"><span data-stu-id="e6aec-271">Examples of this are shown in later tutorials in this series.</span></span>

### <a name="the-savechanges-method"></a><span data-ttu-id="e6aec-272">SaveChanges 方法</span><span class="sxs-lookup"><span data-stu-id="e6aec-272">The SaveChanges Method</span></span>

<span data-ttu-id="e6aec-273">此简单存储库类阐释了如何执行 CRUD 操作的基本原则。</span><span class="sxs-lookup"><span data-stu-id="e6aec-273">This simple repository class illustrates basic principles of how to perform CRUD operations.</span></span> <span data-ttu-id="e6aec-274">在此示例中，将在每次更新后立即调用 `SaveChanges` 方法。</span><span class="sxs-lookup"><span data-stu-id="e6aec-274">In this example, the `SaveChanges` method is called immediately after each update.</span></span> <span data-ttu-id="e6aec-275">在生产应用程序中，你可能需要从单独的方法中调用 `SaveChanges` 方法，以便更好地控制更新数据库的时间。</span><span class="sxs-lookup"><span data-stu-id="e6aec-275">In a production application you might want to call the `SaveChanges` method from a separate method to give you more control over when the database is updated.</span></span> <span data-ttu-id="e6aec-276">（在下一教程结束时，你会看到一个指向白皮书的链接，其中介绍了一种协调相关更新的工作单元。）另请注意，在此示例中，`DeleteDepartment` 方法不包括用于处理并发冲突的代码;本系列后面的教程中将添加要执行的代码。</span><span class="sxs-lookup"><span data-stu-id="e6aec-276">(At the end of the next tutorial you will find a link to a white paper that discusses the unit of work pattern which is one approach to coordinating related updates.) Notice also that in the example, the `DeleteDepartment` method does not include code for handling concurrency conflicts; code to do that will be added in a later tutorial in this series.</span></span>

### <a name="retrieving-instructor-names-to-select-when-inserting"></a><span data-ttu-id="e6aec-277">检索要在插入时选择的指导员名称</span><span class="sxs-lookup"><span data-stu-id="e6aec-277">Retrieving Instructor Names to Select When Inserting</span></span>

<span data-ttu-id="e6aec-278">创建新的部门时，用户必须能够从下拉列表中的一组教师列表中选择管理员。</span><span class="sxs-lookup"><span data-stu-id="e6aec-278">Users must be able to select an administrator from a list of instructors in a drop-down list when creating new departments.</span></span> <span data-ttu-id="e6aec-279">因此，请将以下代码添加到*SchoolRepository.cs* ，以创建一个方法来使用您之前创建的视图检索讲师列表：</span><span class="sxs-lookup"><span data-stu-id="e6aec-279">Therefore, add the following code to *SchoolRepository.cs* to create a method to retrieve the list of instructors using the view that you created earlier:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample8.cs)]

### <a name="creating-a-page-for-inserting-departments"></a><span data-ttu-id="e6aec-280">创建用于插入部门的页面</span><span class="sxs-lookup"><span data-stu-id="e6aec-280">Creating a Page for Inserting Departments</span></span>

<span data-ttu-id="e6aec-281">创建一个使用 DepartmentsAdd*页的 "* " 页，并在名为 `Content2`的 `Content` 控件中添加以下标记：</span><span class="sxs-lookup"><span data-stu-id="e6aec-281">Create a *DepartmentsAdd.aspx* page that uses the *Site.Master* page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample9.aspx)]

<span data-ttu-id="e6aec-282">此标记创建两个 `ObjectDataSource` 控件，一个用于插入新的 `Department` 实体，另一个用于检索用于选择部门管理员的 `DropDownList` 控件的指导员名称。</span><span class="sxs-lookup"><span data-stu-id="e6aec-282">This markup creates two `ObjectDataSource` controls, one for inserting new `Department` entities and one for retrieving instructor names for the `DropDownList` control that's used for selecting department administrators.</span></span> <span data-ttu-id="e6aec-283">标记创建用于输入新部门的 `DetailsView` 控件，并为控件的 `ItemInserting` 事件指定处理程序，以便可以设置 `Administrator` 外键值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-283">The markup creates a `DetailsView` control for entering new departments, and it specifies a handler for the control's `ItemInserting` event so that you can set the `Administrator` foreign key value.</span></span> <span data-ttu-id="e6aec-284">最后，`ValidationSummary` 控件可以显示错误消息。</span><span class="sxs-lookup"><span data-stu-id="e6aec-284">At the end is a `ValidationSummary` control to display error messages.</span></span>

<span data-ttu-id="e6aec-285">打开*DepartmentsAdd.aspx.cs*并添加以下 `using` 语句：</span><span class="sxs-lookup"><span data-stu-id="e6aec-285">Open *DepartmentsAdd.aspx.cs* and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample10.cs)]

<span data-ttu-id="e6aec-286">添加以下类变量和方法：</span><span class="sxs-lookup"><span data-stu-id="e6aec-286">Add the following class variable and methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample11.cs)]

<span data-ttu-id="e6aec-287">`Page_Init` 方法启用动态数据功能。</span><span class="sxs-lookup"><span data-stu-id="e6aec-287">The `Page_Init` method enables Dynamic Data functionality.</span></span> <span data-ttu-id="e6aec-288">`DropDownList` 控件的 `Init` 事件的处理程序保存对控件的引用，而 `DetailsView` 控件的 `Inserting` 事件的处理程序使用该引用获取选定讲师的 `PersonID` 值并更新 `Administrator` 实体的 `Department` 外键属性。</span><span class="sxs-lookup"><span data-stu-id="e6aec-288">The handler for the `DropDownList` control's `Init` event saves a reference to the control, and the handler for the `DetailsView` control's `Inserting` event uses that reference to get the `PersonID` value of the selected instructor and update the `Administrator` foreign key property of the `Department` entity.</span></span>

<span data-ttu-id="e6aec-289">运行页面，为新部门添加信息，然后单击 "**插入**" 链接。</span><span class="sxs-lookup"><span data-stu-id="e6aec-289">Run the page, add information for a new department, and then click the **Insert** link.</span></span>

<span data-ttu-id="e6aec-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span></span>

<span data-ttu-id="e6aec-291">为另一个新部门输入值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-291">Enter values for another new department.</span></span> <span data-ttu-id="e6aec-292">在 "**预算**" 字段和 "选项卡" 中，输入一个大于1000000.00 的数字作为下一个字段。</span><span class="sxs-lookup"><span data-stu-id="e6aec-292">Enter a number greater than 1,000,000.00 in the **Budget** field and tab to the next field.</span></span> <span data-ttu-id="e6aec-293">星号出现在字段中，如果将鼠标指针悬停在该字段上，则可以看到在该字段的元数据中输入的错误消息。</span><span class="sxs-lookup"><span data-stu-id="e6aec-293">An asterisk appears in the field, and if you hold the mouse pointer over it, you can see the error message that you entered in the metadata for that field.</span></span>

<span data-ttu-id="e6aec-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span></span>

<span data-ttu-id="e6aec-295">单击 "**插入**"，可以看到由页面底部的 `ValidationSummary` 控件显示的错误消息。</span><span class="sxs-lookup"><span data-stu-id="e6aec-295">Click **Insert**, and you see the error message displayed by the `ValidationSummary` control at the bottom of the page.</span></span>

<span data-ttu-id="e6aec-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span></span>

<span data-ttu-id="e6aec-297">接下来，关闭浏览器并打开 "*部门*" 页。</span><span class="sxs-lookup"><span data-stu-id="e6aec-297">Next, close the browser and open the *Departments.aspx* page.</span></span> <span data-ttu-id="e6aec-298">通过向 `ObjectDataSource` 控件添加 `DeleteMethod` 特性，并将 `DataKeyNames` 特性添加到 `GridView` 控件中，将删除功能添加到了*node.js 页中。*</span><span class="sxs-lookup"><span data-stu-id="e6aec-298">Add delete capability to the *Departments.aspx* page by adding a `DeleteMethod` attribute to the `ObjectDataSource` control, and a `DataKeyNames` attribute to the `GridView` control.</span></span> <span data-ttu-id="e6aec-299">这些控件的开始标记现在将类似于以下示例：</span><span class="sxs-lookup"><span data-stu-id="e6aec-299">The opening tags for these controls will now resemble the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample12.aspx)]

<span data-ttu-id="e6aec-300">运行页面。</span><span class="sxs-lookup"><span data-stu-id="e6aec-300">Run the page.</span></span>

<span data-ttu-id="e6aec-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span></span>

<span data-ttu-id="e6aec-302">删除运行*DepartmentsAdd*页面时添加的部门。</span><span class="sxs-lookup"><span data-stu-id="e6aec-302">Delete the department you added when you ran the *DepartmentsAdd.aspx* page.</span></span>

## <a name="adding-update-functionality"></a><span data-ttu-id="e6aec-303">添加更新功能</span><span class="sxs-lookup"><span data-stu-id="e6aec-303">Adding Update Functionality</span></span>

<span data-ttu-id="e6aec-304">打开*SchoolRepository.cs*并添加以下 `Update` 方法：</span><span class="sxs-lookup"><span data-stu-id="e6aec-304">Open *SchoolRepository.cs* and add the following `Update` method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample13.cs)]

<span data-ttu-id="e6aec-305">当在 " *default.aspx* " 页中单击 "**更新**" 时，`ObjectDataSource` 控件将创建两个要传递给 `UpdateDepartment` 方法的 `Department` 实体。</span><span class="sxs-lookup"><span data-stu-id="e6aec-305">When you click **Update** in the *Departments.aspx* page, the `ObjectDataSource` control creates two `Department` entities to pass to the `UpdateDepartment` method.</span></span> <span data-ttu-id="e6aec-306">一个包含已存储在视图状态中的原始值，另一个包含在 `GridView` 控件中输入的新值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-306">One contains the original values that have been stored in view state, and the other contains the new values that were entered in the `GridView` control.</span></span> <span data-ttu-id="e6aec-307">`UpdateDepartment` 方法中的代码将具有原始值的 `Department` 实体传递到 `Attach` 方法，以便在实体和数据库中的内容之间建立跟踪。</span><span class="sxs-lookup"><span data-stu-id="e6aec-307">The code in the `UpdateDepartment` method passes the `Department` entity that has the original values to the `Attach` method in order to establish the tracking between the entity and what's in the database.</span></span> <span data-ttu-id="e6aec-308">然后，该代码将具有新值的 `Department` 实体传递到 `ApplyCurrentValues` 方法。</span><span class="sxs-lookup"><span data-stu-id="e6aec-308">Then the code passes the `Department` entity that has the new values to the `ApplyCurrentValues` method.</span></span> <span data-ttu-id="e6aec-309">对象上下文比较旧值和新值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-309">The object context compares the old and new values.</span></span> <span data-ttu-id="e6aec-310">如果新值不同于旧值，则对象上下文将更改属性值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-310">If a new value is different from an old value, the object context changes the property value.</span></span> <span data-ttu-id="e6aec-311">然后 `SaveChanges` 方法仅更新数据库中已更改的列。</span><span class="sxs-lookup"><span data-stu-id="e6aec-311">The `SaveChanges` method then updates only the changed columns in the database.</span></span> <span data-ttu-id="e6aec-312">（但是，如果此实体的更新函数映射到存储过程，则无论更改了哪些列，整个行将被更新。）</span><span class="sxs-lookup"><span data-stu-id="e6aec-312">(However, if the update function for this entity were mapped to a stored procedure, the entire row would be updated regardless of which columns were changed.)</span></span>

<span data-ttu-id="e6aec-313">打开 "*部门 .aspx* " 文件，并将以下属性添加到 `DepartmentsObjectDataSource` 控件：</span><span class="sxs-lookup"><span data-stu-id="e6aec-313">Open the *Departments.aspx* file and add the following attributes to the `DepartmentsObjectDataSource` control:</span></span>

- `UpdateMethod="UpdateDepartment"`
- `ConflictDetection="CompareAllValues"`   
 <span data-ttu-id="e6aec-314">这会导致旧值存储在视图状态中，以便可以将它们与 `Update` 方法中的新值进行比较。</span><span class="sxs-lookup"><span data-stu-id="e6aec-314">This causes old values to be stored in view state so that they can be compared with the new values in the `Update` method.</span></span>
- `OldValuesParameterFormatString="orig{0}"`   
 <span data-ttu-id="e6aec-315">这会通知控件 `origDepartment` 原始值参数的名称。</span><span class="sxs-lookup"><span data-stu-id="e6aec-315">This informs the control that the name of the original values parameter is `origDepartment` .</span></span>

<span data-ttu-id="e6aec-316">`ObjectDataSource` 控件开始标记的标记现在类似于以下示例：</span><span class="sxs-lookup"><span data-stu-id="e6aec-316">The markup for the opening tag of the `ObjectDataSource` control now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample14.aspx)]

<span data-ttu-id="e6aec-317">向 `GridView` 控件添加 `OnRowUpdating="DepartmentsGridView_RowUpdating"` 特性。</span><span class="sxs-lookup"><span data-stu-id="e6aec-317">Add an `OnRowUpdating="DepartmentsGridView_RowUpdating"` attribute to the `GridView` control.</span></span> <span data-ttu-id="e6aec-318">您将使用此设置基于用户在下拉列表中选择的行来设置 `Administrator` 属性值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-318">You will use this to set the `Administrator` property value based on the row the user selects in a drop-down list.</span></span> <span data-ttu-id="e6aec-319">`GridView` 开始标记现在类似于以下示例：</span><span class="sxs-lookup"><span data-stu-id="e6aec-319">The `GridView` opening tag now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample15.aspx)]

<span data-ttu-id="e6aec-320">将 `Administrator` 列的 `EditItemTemplate` 控件添加到 `GridView` 控件，紧跟在该列的 `ItemTemplate` 控件之后：</span><span class="sxs-lookup"><span data-stu-id="e6aec-320">Add an `EditItemTemplate` control for the `Administrator` column to the `GridView` control, immediately after the `ItemTemplate` control for that column:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample16.aspx)]

<span data-ttu-id="e6aec-321">此 `EditItemTemplate` 控件类似于*DepartmentsAdd*页中的 `InsertItemTemplate` 控件。</span><span class="sxs-lookup"><span data-stu-id="e6aec-321">This `EditItemTemplate` control is similar to the `InsertItemTemplate` control in the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="e6aec-322">不同之处在于，使用 `SelectedValue` 特性设置控件的初始值。</span><span class="sxs-lookup"><span data-stu-id="e6aec-322">The difference is that the initial value of the control is set using the `SelectedValue` attribute.</span></span>

<span data-ttu-id="e6aec-323">在 `GridView` 控件之前，添加一个 `ValidationSummary` 控件，就像在*DepartmentsAdd*页中所做的一样。</span><span class="sxs-lookup"><span data-stu-id="e6aec-323">Before the `GridView` control, add a `ValidationSummary` control as you did in the *DepartmentsAdd.aspx* page.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample17.aspx)]

<span data-ttu-id="e6aec-324">打开*Departments.aspx.cs* ，并紧接在分部类声明的后面添加以下代码，以创建用于引用 `DropDownList` 控件的私有字段：</span><span class="sxs-lookup"><span data-stu-id="e6aec-324">Open *Departments.aspx.cs* and immediately after the partial-class declaration, add the following code to create a private field to reference the `DropDownList` control:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample18.cs)]

<span data-ttu-id="e6aec-325">然后为 `DropDownList` 控件的 `Init` 事件和 `GridView` 控件的 `RowUpdating` 事件添加处理程序：</span><span class="sxs-lookup"><span data-stu-id="e6aec-325">Then add handlers for the `DropDownList` control's `Init` event and the `GridView` control's `RowUpdating` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample19.cs)]

<span data-ttu-id="e6aec-326">`Init` 事件的处理程序保存对类字段中的 `DropDownList` 控件的引用。</span><span class="sxs-lookup"><span data-stu-id="e6aec-326">The handler for the `Init` event saves a reference to the `DropDownList` control in the class field.</span></span> <span data-ttu-id="e6aec-327">`RowUpdating` 事件的处理程序使用引用获取用户输入的值并将其应用于 `Department` 实体的 `Administrator` 属性。</span><span class="sxs-lookup"><span data-stu-id="e6aec-327">The handler for the `RowUpdating` event uses the reference to get the value the user entered and apply it to the `Administrator` property of the `Department` entity.</span></span>

<span data-ttu-id="e6aec-328">使用*DepartmentsAdd*页添加新的部门，然后运行 "node.js *" 页，* 并在添加的行上单击 "**编辑**"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-328">Use the *DepartmentsAdd.aspx* page to add a new department, then run the *Departments.aspx* page and click **Edit** on the row that you added.</span></span>

> [!NOTE]
> <span data-ttu-id="e6aec-329">由于数据库中的数据无效，您将无法编辑您未添加的行（即，已经存在于数据库中）。与数据库一起创建的行的管理员是学生。</span><span class="sxs-lookup"><span data-stu-id="e6aec-329">You will not be able to edit rows that you did not add (that is, that were already in the database), because of invalid data in the database; the administrators for the rows that were created with the database are students.</span></span> <span data-ttu-id="e6aec-330">如果尝试编辑其中一个文件，则会出现一个错误页面，报告错误，如 `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span><span class="sxs-lookup"><span data-stu-id="e6aec-330">If you try to edit one of them, you will get an error page that reports an error like `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span></span>

<span data-ttu-id="e6aec-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span></span>

<span data-ttu-id="e6aec-332">如果输入的**预算**金额无效，然后单击 "**更新**"，则会看到与在 "云和 *.aspx* " 页中看到的相同星号和错误消息。</span><span class="sxs-lookup"><span data-stu-id="e6aec-332">If you enter an invalid **Budget** amount and then click **Update**, you see the same asterisk and error message that you saw in the *Departments.aspx* page.</span></span>

<span data-ttu-id="e6aec-333">更改字段值或选择其他管理员，然后单击 "**更新**"。</span><span class="sxs-lookup"><span data-stu-id="e6aec-333">Change a field value or select a different administrator and click **Update**.</span></span> <span data-ttu-id="e6aec-334">将显示更改。</span><span class="sxs-lookup"><span data-stu-id="e6aec-334">The change is displayed.</span></span>

<span data-ttu-id="e6aec-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="e6aec-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span></span>

<span data-ttu-id="e6aec-336">这完成了将 `ObjectDataSource` 控件用于使用实体框架的基本 CRUD （创建、读取、更新、删除）操作的简介。</span><span class="sxs-lookup"><span data-stu-id="e6aec-336">This completes the introduction to using the `ObjectDataSource` control for basic CRUD (create, read, update, delete) operations with the Entity Framework.</span></span> <span data-ttu-id="e6aec-337">你已经构建了一个简单的 n 层应用程序，但业务逻辑层仍与数据访问层紧密耦合，这会使自动单元测试变得更加复杂。</span><span class="sxs-lookup"><span data-stu-id="e6aec-337">You've built a simple n-tier application, but the business-logic layer is still tightly coupled to the data-access layer, which complicates automated unit testing.</span></span> <span data-ttu-id="e6aec-338">在以下教程中，你将了解如何实现存储库模式，以便于进行单元测试。</span><span class="sxs-lookup"><span data-stu-id="e6aec-338">In the following tutorial you'll see how to implement the repository pattern to facilitate unit testing.</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="e6aec-339">下一部分</span><span class="sxs-lookup"><span data-stu-id="e6aec-339">Next</span></span>](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests.md)
