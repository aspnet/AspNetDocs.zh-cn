---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: 处理使用 Entity Framework 4.0 ASP.NET 4 Web 应用程序中的并发 |Microsoft Docs
author: tdykstra
description: 本系列教程以 Contoso University web 应用程序创建的与 Entity Framework 4.0 教程系列入门教程为基础。 我...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: fc9ce539005bce1790c726dfb859305f4ff78a6b
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59422559"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="e3b0c-104">使用 Entity Framework 4.0 ASP.NET 4 Web 应用程序中处理并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="e3b0c-105">通过[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="e3b0c-106">本系列教程为基础创建的 Contoso University web 应用程序[开始使用 Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started)系列教程。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="e3b0c-107">如果未完成之前的教程，作为本教程的起始点可以[下载应用程序](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)，您已经创建的。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="e3b0c-108">此外可以[下载应用程序](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)由完整的系列教程。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="e3b0c-109">如果你有疑问的教程，您可以发布到[ASP.NET 实体框架论坛](https://forums.asp.net/1227.aspx)。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="e3b0c-110">上一教程中介绍了如何进行排序和筛选器数据使用`ObjectDataSource`控件和 Entity Framework。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="e3b0c-111">本教程介绍使用实体框架的 ASP.NET web 应用程序中的并发处理的选项。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="e3b0c-112">将创建一个新的网页，专用于更新讲师的办公室分配。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="e3b0c-113">将处理该页面中和在前面创建的部门页面中的并发问题。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="e3b0c-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="e3b0c-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="e3b0c-116">并发冲突</span><span class="sxs-lookup"><span data-stu-id="e3b0c-116">Concurrency Conflicts</span></span>

<span data-ttu-id="e3b0c-117">一个用户编辑记录和另一个用户编辑同一个记录之前的第一个用户更改写入到数据库时，将发生并发冲突。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="e3b0c-118">如果不设置实体框架来检测此类冲突，最后更新数据库的人员覆盖其他用户的更改。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="e3b0c-119">在许多应用程序，这种风险是可接受的并且无需配置要处理可能的并发冲突的应用程序。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="e3b0c-120">(如果有几个用户或几个更新，或如果并不重要的某些更改将被覆盖，如果并发编程的成本可能胜过权益。)如果不需要担心并发冲突，则可以跳过本教程;系列中的其余两个教程不依赖于在本视频中生成的所有内容。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="e3b0c-121">悲观并发 （锁定）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="e3b0c-122">如果应用程序确实需要防止并发情况下出现意外数据丢失，一种方法是使用数据库锁定。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="e3b0c-123">这称为*保守式并发*。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="e3b0c-124">例如，在从数据库读取一行内容之前，请求锁定为只读或更新访问。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="e3b0c-125">如果将一行锁定为更新访问，则其他用户无法将该行锁定为只读或更新访问，因为他们得到的是正在更改的数据的副本。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="e3b0c-126">如果将一行锁定为只读访问，则其他人也可将其锁定为只读访问，但不能进行更新。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="e3b0c-127">管理锁定有一些缺点。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="e3b0c-128">编程可能很复杂。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-128">It can be complex to program.</span></span> <span data-ttu-id="e3b0c-129">它需要大量的数据库管理资源，并且它可能导致性能问题的应用程序的用户数增加 （即，它不能很好）。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="e3b0c-130">由于这些原因，并不是所有的数据库管理系统都支持悲观并发。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="e3b0c-131">实体框架不提供内置支持，以及本教程不展示如何实现它。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="e3b0c-132">开放式并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-132">Optimistic Concurrency</span></span>

<span data-ttu-id="e3b0c-133">悲观并发的替代方法是*乐观并发*。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="e3b0c-134">悲观并发是指允许发生并发冲突，并在并发冲突发生时作出正确反应。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="e3b0c-135">例如，John 运行*Department.aspx*页上，单击**编辑**历史记录部门中的链接并减少**预算**从 1000 美元，000.00 金额为 $125,000.00。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="e3b0c-136">（John 管理竞争部门和想要释放了他自己部门成本）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="e3b0c-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="e3b0c-138">John 单击之前**更新**，Jane 运行在同一页上，单击**编辑**链接，获取的历史记录部门，然后更改**开始日期**字段从 2011 年 1 月 10 日到 1/1 /1999。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="e3b0c-139">（Jane 管理历史记录部门和想要为其提供更多的资历。）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="e3b0c-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="e3b0c-141">John 单击**更新**Jane 单击的第一次，然后**更新**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="e3b0c-142">Jane 的浏览器现在列表**预算**金额为 $ 1000，000.00，但这不正确，因为已由 John 到 $125,000.00 更改量。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="e3b0c-143">一些可在此方案中执行的操作包括：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="e3b0c-144">可以跟踪用户已修改的属性，并仅更新数据库中相应的列。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="e3b0c-145">在示例方案中，不会有数据丢失，因为是由两个用户更新不同的属性。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="e3b0c-146">下次有人浏览历史记录系时，他们将看到 1/1/1999年和 125,000.00 美元。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="e3b0c-147">这是实体框架中的默认行为，它可以显著减少可能导致数据丢失的冲突数。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="e3b0c-148">但是，此行为不能避免数据丢失，如果实体的同一属性进行竞争性更改。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="e3b0c-149">此外，此行为并不总是可行;当存储的过程映射到的实体类型时，所有实体的属性更新时在数据库中进行了任何更改到的实体。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="e3b0c-150">可以让 John 的更改覆盖 Jane 的更改。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="e3b0c-151">Jane 单击后**更新**，则**预算**量将恢复为 1000，000.00 美元。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="e3b0c-152">这称为“客户端优先”或“最后一个优先”。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="e3b0c-153">（客户端的值优先于什么是数据存储区中。）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="e3b0c-154">您可以防止 Jane 的更改更新数据库中。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="e3b0c-155">通常情况下，会显示一条错误消息，给她提供数据的当前状态，让其重新输入她的更改，如果仍想要使它们。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="e3b0c-156">通过将保存其输入为她提供机会来重新将其应用而无需重新输入它，可以进一步自动化该过程。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="e3b0c-157">这称为“存储优先”方案。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="e3b0c-158">（数据存储值优先于客户端提交的值。）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="e3b0c-159">检测并发冲突</span><span class="sxs-lookup"><span data-stu-id="e3b0c-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="e3b0c-160">在实体框架中，您可以通过处理中解决冲突`OptimisticConcurrencyException`Entity Framework 引发的异常。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="e3b0c-161">为了知道何时引发这些异常，Entity Framework 必须能够检测到冲突。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="e3b0c-162">因此，你必须正确配置数据库和数据模型。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="e3b0c-163">启用冲突检测的某些选项包括：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="e3b0c-164">在数据库中，包括可用于确定何时已更改行的表格列。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="e3b0c-165">然后，可以配置实体框架，将该列中的包含`Where`的 SQL 子句`Update`或`Delete`命令。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="e3b0c-166">目的就在于`Timestamp`中的列`OfficeAssignment`表。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="e3b0c-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="e3b0c-168">数据类型`Timestamp`也称为列`Timestamp`。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="e3b0c-169">但是，列实际上不包含日期或时间值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="e3b0c-170">相反，值是每次更新行时递增的序列号。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="e3b0c-171">在中`Update`或`Delete`命令，`Where`子句包括原始`Timestamp`值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="e3b0c-172">如果正在更新的行已由另一个用户中的值更改`Timestamp`不同于原始值，因此`Where`子句将返回要更新的行。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="e3b0c-173">实体框架找到任何行，已更新由当前`Update`或`Delete`命令 （即，在受影响的行数为零），将其解释为并发冲突。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="e3b0c-174">配置实体框架，以便在表中包含的每个列的原始值`Where`子句`Update`和`Delete`命令。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="e3b0c-175">如下所示的第一个选项，如果自第一次读取一行，该行中的任何内容已更改`Where`子句不会返回的行，若要更新，该实体框架将解释为并发冲突。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="e3b0c-176">此方法是尽可能使用更有效`Timestamp`字段，但可能会降低效率。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="e3b0c-177">对于包含许多列的数据库表，它可能会导致非常大`Where`子句，并在 web 应用程序需要维护大量的状态。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="e3b0c-178">维护大量的状态会影响应用程序性能，因为它需要服务器资源 （例如，会话状态） 或必须包含在网页本身 （例如，视图状态）。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="e3b0c-179">在本教程中，您将添加错误处理不具有跟踪属性的实体的开放式并发冲突 (`Department`实体) 和实体具有跟踪属性 (`OfficeAssignment`实体)。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="e3b0c-180">处理开放式并发，且无跟踪属性</span><span class="sxs-lookup"><span data-stu-id="e3b0c-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="e3b0c-181">若要实现的乐观并发`Department`实体，其不具有跟踪 (`Timestamp`) 属性，将完成以下任务：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="e3b0c-182">将数据模型更改为启用并发跟踪`Department`实体。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="e3b0c-183">在中`SchoolRepository`类中的处理并发异常`SaveChanges`方法。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="e3b0c-184">在中*Departments.aspx*页上，通过向用户警告尝试的更改未成功显示一条消息的处理并发异常。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="e3b0c-185">然后，用户可以查看的当前值，然后重试所做的更改，如果仍然需要它们。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="e3b0c-186">启用跟踪数据模型中的并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="e3b0c-187">在 Visual Studio 中，打开在您使用在此系列中的上一教程中的 Contoso University web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="e3b0c-188">打开*SchoolModel.edmx*，然后在数据模型设计器中，右键单击`Name`中的属性`Department`实体，然后单击**属性**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="e3b0c-189">在中**属性**窗口中，更改`ConcurrencyMode`属性设置为`Fixed`。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="e3b0c-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="e3b0c-191">执行相同的其他非主键标量属性 (`Budget`， `StartDate`，和`Administrator`。)（您不能执行此操作的导航属性。）这会指定，只要实体框架生成`Update`或`Delete`SQL 命令来更新`Department`（与原始值） 这些列必须包含在数据库中的实体，`Where`子句。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="e3b0c-192">如果未不找到任何行`Update`或`Delete`命令执行时，实体框架将引发开放式并发异常。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="e3b0c-193">保存并关闭数据模型。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="e3b0c-194">DAL 中处理并发异常</span><span class="sxs-lookup"><span data-stu-id="e3b0c-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="e3b0c-195">打开*SchoolRepository.cs*并添加以下`using`语句`System.Data`命名空间：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="e3b0c-196">添加以下新`SaveChanges`方法，用于处理开放式并发异常：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="e3b0c-197">如果并发错误发生时调用此方法，在内存中的实体的属性值将替换为数据库中的当前值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="e3b0c-198">使网页能够应对其将被重新引发并发异常。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="e3b0c-199">在中`DeleteDepartment`并`UpdateDepartment`方法，将替换现有调用`context.SaveChanges()`通过调用`SaveChanges()`为了调用新方法。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="e3b0c-200">在表示层中处理并发异常</span><span class="sxs-lookup"><span data-stu-id="e3b0c-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="e3b0c-201">打开*Departments.aspx*并添加`OnDeleted="DepartmentsObjectDataSource_Deleted"`属性为`DepartmentsObjectDataSource`控件。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="e3b0c-202">控件的开始标记现在将类似于下面的示例。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="e3b0c-203">在中`DepartmentsGridView`控件，指定表的列中的所有`DataKeyNames`属性，如下面的示例中所示。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="e3b0c-204">请注意，这将创建非常大的视图状态字段，其中的原因之一是使用跟踪字段的原因通常是跟踪并发冲突的首选的方法。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="e3b0c-205">打开*Departments.aspx.cs*并添加以下`using`语句`System.Data`命名空间：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="e3b0c-206">添加以下新方法，将从数据源控件调用`Updated`和`Deleted`事件处理程序处理并发异常：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="e3b0c-207">此代码检查异常类型，并且如果它是并发异常，该代码动态创建`CustomValidator`又显示一条消息中的控件`ValidationSummary`控件。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="e3b0c-208">调用新方法从`Updated`前面添加的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="e3b0c-209">此外，创建一个新`Deleted`事件处理程序调用同一方法 （但不执行任何其他操作）：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="e3b0c-210">在部门页中测试乐观并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="e3b0c-211">运行*Departments.aspx*页。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="e3b0c-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="e3b0c-213">单击**编辑**行中，将在值更改**预算**列。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="e3b0c-214">(请记住，您只能编辑已为本教程中，创建记录因为现有`School`数据库记录包含一些无效数据。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="e3b0c-215">经济部门的记录是尝试使用一个安全密码）。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="e3b0c-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="e3b0c-217">打开新浏览器窗口并运行页再次 （复制到第二个浏览器窗口中的第一个浏览器窗口的地址框的 URL）。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="e3b0c-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="e3b0c-219">单击**编辑**在同一行，之前编辑和更改**预算**为其他值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="e3b0c-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="e3b0c-221">在第二个浏览器窗口中，单击**更新**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="e3b0c-222">**预算**量成功更改为此新值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="e3b0c-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="e3b0c-224">在第一个浏览器窗口中，单击**更新**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="e3b0c-225">更新将失败。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-225">The update fails.</span></span> <span data-ttu-id="e3b0c-226">**预算**量将重新显示使用在第二个浏览器窗口中，设置的值，你看到一条错误消息。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="e3b0c-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="e3b0c-228">使用跟踪属性的处理开放式并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="e3b0c-229">若要处理的跟踪属性的实体的开放式并发，您将完成以下任务：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="e3b0c-230">将存储的过程添加到数据模型来管理`OfficeAssignment`实体。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="e3b0c-231">（跟踪属性和存储的过程不需要一起使用; 它们只需组合在一起此处是为了进行说明。）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="e3b0c-232">将 CRUD 方法添加到 DAL 和为 BLL`OfficeAssignment`实体，包括代码来处理在 DAL 的开放式并发异常。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="e3b0c-233">创建一个办公室分配 web 页面。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="e3b0c-234">测试新的 web 页面中的开放式并发。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="e3b0c-235">添加 OfficeAssignment 存储到数据模型的过程</span><span class="sxs-lookup"><span data-stu-id="e3b0c-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="e3b0c-236">打开*SchoolModel.edmx*文件在模型设计器中，右键单击设计图面上，然后单击**从数据库更新模型**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="e3b0c-237">在**添加**选项卡**选择数据库对象**对话框中，展开**存储过程**，然后选择这三个`OfficeAssignment`存储过程 (请参阅以下屏幕截图），然后单击**完成**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="e3b0c-238">（这些存储的过程时，已在数据库中下载或创建其使用的脚本。）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="e3b0c-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="e3b0c-240">右键单击`OfficeAssignment`实体，然后选择**存储过程映射**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="e3b0c-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="e3b0c-242">设置**插入**，**更新**，并**删除**函数使用其相应存储过程。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="e3b0c-243">有关`OrigTimestamp`的参数`Update`函数中，设置**属性**到`Timestamp`，然后选择**使用原始值**选项。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="e3b0c-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="e3b0c-245">当实体框架调用`UpdateOfficeAssignment`存储的过程，它将通过的原始值`Timestamp`中的列`OrigTimestamp`参数。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="e3b0c-246">存储的过程使用此参数在其`Where`子句：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="e3b0c-247">存储的过程还将选择的新值`Timestamp`更新后的列，以便实体框架可以保留`OfficeAssignment`与相应的数据库行同步已在内存中的实体。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="e3b0c-248">(请注意，用于删除办公室分配的存储的过程不会具有`OrigTimestamp`参数。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="e3b0c-249">因此，实体框架无法验证实体不删除它之前变。）</span><span class="sxs-lookup"><span data-stu-id="e3b0c-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="e3b0c-250">保存并关闭数据模型。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="e3b0c-251">添加对 DAL OfficeAssignment 方法</span><span class="sxs-lookup"><span data-stu-id="e3b0c-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="e3b0c-252">打开*ISchoolRepository.cs*并添加以下的 CRUD 方法`OfficeAssignment`实体集：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="e3b0c-253">添加到以下新方法*SchoolRepository.cs*。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="e3b0c-254">在中`UpdateOfficeAssignment`方法，调用本地`SaveChanges`方法而不是`context.SaveChanges`。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="e3b0c-255">在测试项目中，打开*MockSchoolRepository.cs*并添加以下`OfficeAssignment`集合和 CRUD 方法。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="e3b0c-256">（mock 存储库必须实现存储库接口，或该解决方案将不会编译）。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="e3b0c-257">将 OfficeAssignment 方法添加到 BLL</span><span class="sxs-lookup"><span data-stu-id="e3b0c-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="e3b0c-258">在主项目中，打开*SchoolBL.cs*并添加以下的 CRUD 方法`OfficeAssignment`实体设置为它：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="e3b0c-259">创建 OfficeAssignments Web 页</span><span class="sxs-lookup"><span data-stu-id="e3b0c-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="e3b0c-260">创建新的 web 页，使用*Site.Master*母版页并将其命名*OfficeAssignments.aspx*。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="e3b0c-261">添加到以下标记`Content`名为控件`Content2`:</span><span class="sxs-lookup"><span data-stu-id="e3b0c-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="e3b0c-262">请注意，在`DataKeyNames`属性，该标记指定`Timestamp`属性，以及记录密钥 (`InstructorID`)。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="e3b0c-263">指定属性中的`DataKeyNames`属性会导致控件将它们保存在控件状态 （这是类似于视图状态），因此在回发处理过程中的原始值来提供。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="e3b0c-264">如果您没有保存`Timestamp`值，实体框架不会为它`Where`子句的 sql`Update`命令。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="e3b0c-265">因此不会找到要更新。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="e3b0c-266">因此，实体框架会引发开放式并发异常每次`OfficeAssignment`更新实体。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="e3b0c-267">打开*OfficeAssignments.aspx.cs*并添加以下`using`数据访问层的语句：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="e3b0c-268">以下代码添加到`Page_Init`方法，使动态数据功能。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="e3b0c-269">此外将添加以下处理程序`ObjectDataSource`控件的`Updated`事件，以检查是否有并发错误：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="e3b0c-270">在 OfficeAssignments 上测试乐观并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="e3b0c-271">运行*OfficeAssignments.aspx*页。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="e3b0c-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="e3b0c-273">单击**编辑**行中，将在值更改**位置**列。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="e3b0c-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="e3b0c-275">打开新浏览器窗口并运行页再次 （复制到第二个浏览器窗口中的第一个浏览器窗口的 URL）。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="e3b0c-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="e3b0c-277">单击**编辑**在同一行，之前编辑和更改**位置**为其他值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="e3b0c-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="e3b0c-279">在第二个浏览器窗口中，单击**更新**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="e3b0c-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="e3b0c-281">切换到第一个浏览器窗口，然后单击**更新**。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="e3b0c-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="e3b0c-283">你看到一条错误消息和**位置**值已更新以显示在第二个浏览器窗口中更改到的值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="e3b0c-284">EntityDataSource 控件具有处理并发</span><span class="sxs-lookup"><span data-stu-id="e3b0c-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="e3b0c-285">`EntityDataSource`控件包括识别数据模型中的并发设置的内置逻辑，并处理更新和相应地删除操作。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="e3b0c-286">但是，与所有异常，则必须处理`OptimisticConcurrencyException`异常自己以提供用户友好的错误消息。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="e3b0c-287">接下来，将配置*Courses.aspx*页面 (使用`EntityDataSource`控件) 允许更新和删除操作并显示一条错误消息，如果发生并发冲突。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="e3b0c-288">`Course`实体不具有跟踪列，因此您将使用相同的方法，就像处理并发`Department`实体： 跟踪所有非键属性的值。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="e3b0c-289">打开*SchoolModel.edmx*文件。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="e3b0c-290">非键属性的`Course`实体 (`Title`， `Credits`，和`DepartmentID`)，将**并发模式**属性设置为`Fixed`。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="e3b0c-291">然后保存并关闭数据模型。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-291">Then save and close the data model.</span></span>

<span data-ttu-id="e3b0c-292">打开*Courses.aspx*页上并进行以下更改：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="e3b0c-293">在中`CoursesEntityDataSource`控件中，添加`EnableUpdate="true"`和`EnableDelete="true"`属性。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="e3b0c-294">现在，该控件的开始标记类似于下面的示例：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="e3b0c-295">在中`CoursesGridView`控件，更改`DataKeyNames`属性值为`"CourseID,Title,Credits,DepartmentID"`。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="e3b0c-296">然后添加`CommandField`元素`Columns`显示的元素**编辑**并**删除**按钮 (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`)。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="e3b0c-297">`GridView`控件现在类似于下面的示例：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="e3b0c-298">运行页面并与你之前在部门页中创建冲突的情况。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="e3b0c-299">在两个浏览器窗口中运行页上，单击**编辑**在相同行在每个窗口中，并在每个使不同的更改。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="e3b0c-300">单击**更新**在一个窗口，然后单击**更新**在其他窗口中。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="e3b0c-301">当您单击**更新**第二个时，你看到错误页面，得到的未处理的并发异常。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="e3b0c-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="e3b0c-303">处理此错误的方式非常类似于如何处理它的`ObjectDataSource`控件。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="e3b0c-304">打开*Courses.aspx*页上，然后在`CoursesEntityDataSource`控件中，指定的处理程序`Deleted`和`Updated`事件。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="e3b0c-305">现在，该控件的开始标记类似于下面的示例：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="e3b0c-306">之前`CoursesGridView`控件中，添加以下`ValidationSummary`控件：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="e3b0c-307">在中*Courses.aspx.cs*，添加`using`语句`System.Data`命名空间中，添加一个方法来检查并发异常，并添加的处理程序`EntityDataSource`控件的`Updated`和`Deleted`处理程序。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="e3b0c-308">该代码将如下所示：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="e3b0c-309">此代码，并且你对之间的唯一区别`ObjectDataSource`控件是，在这种情况下并发异常处于`Exception`属性的事件参数对象而不是在该异常`InnerException`属性。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="e3b0c-310">运行页面，然后再次创建并发冲突。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="e3b0c-311">此时会显示一条错误消息：</span><span class="sxs-lookup"><span data-stu-id="e3b0c-311">This time you see an error message:</span></span>

<span data-ttu-id="e3b0c-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="e3b0c-313">处理并发冲突已介绍完毕。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="e3b0c-314">下一教程将提供有关如何提高性能的 web 应用程序使用 Entity Framework 中的指导。</span><span class="sxs-lookup"><span data-stu-id="e3b0c-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="e3b0c-315">[上一页](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [下一页](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="e3b0c-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
