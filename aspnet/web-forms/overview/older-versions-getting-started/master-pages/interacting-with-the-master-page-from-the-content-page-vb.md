---
uid: web-forms/overview/older-versions-getting-started/master-pages/interacting-with-the-master-page-from-the-content-page-vb
title: 从内容页与母版页交互（VB） |Microsoft Docs
author: rick-anderson
description: 检查如何从内容页中的代码调用母版页的方法、设置属性等。
ms.author: riande
ms.date: 07/11/2008
ms.assetid: 081fe010-ba0f-4e7d-b4ba-774840b601c2
msc.legacyurl: /web-forms/overview/older-versions-getting-started/master-pages/interacting-with-the-master-page-from-the-content-page-vb
msc.type: authoredcontent
ms.openlocfilehash: fe1f7b80b26ff25c1ce744e4f823e3fb35eea074
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74577259"
---
# <a name="interacting-with-the-master-page-from-the-content-page-vb"></a><span data-ttu-id="2cc86-103">从内容页与母版页交互 (VB)</span><span class="sxs-lookup"><span data-stu-id="2cc86-103">Interacting with the Master Page from the Content Page (VB)</span></span>

<span data-ttu-id="2cc86-104">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="2cc86-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="2cc86-105">[下载代码](https://download.microsoft.com/download/1/8/4/184e24fa-fcc8-47fa-ac99-4b6a52d41e97/ASPNET_MasterPages_Tutorial_06_VB.zip)或[下载 PDF](https://download.microsoft.com/download/e/b/4/eb4abb10-c416-4ba4-9899-32577715b1bd/ASPNET_MasterPages_Tutorial_06_VB.pdf)</span><span class="sxs-lookup"><span data-stu-id="2cc86-105">[Download Code](https://download.microsoft.com/download/1/8/4/184e24fa-fcc8-47fa-ac99-4b6a52d41e97/ASPNET_MasterPages_Tutorial_06_VB.zip) or [Download PDF](https://download.microsoft.com/download/e/b/4/eb4abb10-c416-4ba4-9899-32577715b1bd/ASPNET_MasterPages_Tutorial_06_VB.pdf)</span></span>

> <span data-ttu-id="2cc86-106">检查如何从内容页中的代码调用母版页的方法、设置属性等。</span><span class="sxs-lookup"><span data-stu-id="2cc86-106">Examines how to call methods, set properties, etc. of the Master Page from code in the Content Page.</span></span>

## <a name="introduction"></a><span data-ttu-id="2cc86-107">简介</span><span class="sxs-lookup"><span data-stu-id="2cc86-107">Introduction</span></span>

<span data-ttu-id="2cc86-108">在过去的五个教程中，我们已经介绍了如何创建母版页、定义内容区域、将 ASP.NET 页面绑定到母版页，并定义特定于页面的内容。</span><span class="sxs-lookup"><span data-stu-id="2cc86-108">Over the course of the past five tutorials we have looked at how to create a master page, define content regions, bind ASP.NET pages to a master page, and define page-specific content.</span></span> <span data-ttu-id="2cc86-109">当访问者请求特定内容页时，会在运行时将内容和母版页的标记融合在一起，从而呈现统一的控件层次结构。</span><span class="sxs-lookup"><span data-stu-id="2cc86-109">When a visitor requests a particular content page, the content and master pages' markup are fused at runtime, resulting in the rendering of a unified control hierarchy.</span></span> <span data-ttu-id="2cc86-110">因此，我们已了解到母版页和其中一个内容页可以交互的方式： "内容" 页将对要 transfuse 到母版页的 ContentPlaceHolder 控件中的标记进行了拼写。</span><span class="sxs-lookup"><span data-stu-id="2cc86-110">Therefore, we have already seen one way in which the master page and one of its content pages can interact: the content page spells out the markup to transfuse into the master page's ContentPlaceHolder controls.</span></span>

<span data-ttu-id="2cc86-111">我们尚未要检查的是母版页和内容页面如何以编程方式交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-111">What we have yet to examine is how the master page and content page can interact programmatically.</span></span> <span data-ttu-id="2cc86-112">除了为母版页的 ContentPlaceHolder 控件定义标记外，内容页还可以为其母版页的公共属性赋值并调用其公共方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-112">In addition to defining the markup for the master page's ContentPlaceHolder controls, a content page can also assign values to its master page's public properties and invoke its public methods.</span></span> <span data-ttu-id="2cc86-113">同样，母版页可能与其内容页交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-113">Similarly, a master page may interact with its content pages.</span></span> <span data-ttu-id="2cc86-114">尽管母版页和内容页面之间的编程交互不如其声明性标记之间的交互交互，但在很多情况下都需要此类编程交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-114">While programmatic interaction between a master and content page is less common than the interaction between their declarative markups, there are many scenarios where such programmatic interaction is needed.</span></span>

<span data-ttu-id="2cc86-115">在本教程中，我们将检查内容页如何以编程方式与母版页交互。在下一教程中，我们将探讨母版页如何与内容页交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-115">In this tutorial we examine how a content page can programmatically interact with its master page; in the next tutorial we will look at how the master page can similarly interact with its content pages.</span></span>

## <a name="examples-of-programmatic-interaction-between-a-content-page-and-its-master-page"></a><span data-ttu-id="2cc86-116">内容页和其母版页之间的编程交互示例</span><span class="sxs-lookup"><span data-stu-id="2cc86-116">Examples of Programmatic Interaction Between a Content Page and its Master Page</span></span>

<span data-ttu-id="2cc86-117">需要逐页配置页面的特定区域时，我们使用的是 ContentPlaceHolder 的控件。</span><span class="sxs-lookup"><span data-stu-id="2cc86-117">When a particular region of a page needs to be configured on a page-by-page basis, we use a ContentPlaceHolder control.</span></span> <span data-ttu-id="2cc86-118">但大多数页需要发出特定输出的情况如何，但少量页面需要对其进行自定义以显示其他内容呢？</span><span class="sxs-lookup"><span data-stu-id="2cc86-118">But what about situations where the majority of pages need to emit a certain output, but a small number of pages need to customize it to show something else?</span></span> <span data-ttu-id="2cc86-119">在[*多个 contentplaceholder 和默认内容*](multiple-contentplaceholders-and-default-content-vb.md)教程中，我们在此示例中所述的一个示例涉及在每一页上显示一个登录接口。</span><span class="sxs-lookup"><span data-stu-id="2cc86-119">One such example, which we examined in the [*Multiple ContentPlaceHolders and Default Content*](multiple-contentplaceholders-and-default-content-vb.md) tutorial, involves displaying a login interface on each page.</span></span> <span data-ttu-id="2cc86-120">虽然大多数页应包括一个登录接口，但对于少量页面（例如：主登录页（`Login.aspx`）），应将其取消。"创建帐户" 页;和其他只有经过身份验证的用户可以访问的页面。</span><span class="sxs-lookup"><span data-stu-id="2cc86-120">While most pages should include a login interface, it should be suppressed for a handful of pages, such as: the main login page (`Login.aspx`); the Create Account page; and other pages that are only accessible to authenticated users.</span></span> <span data-ttu-id="2cc86-121">[*多 contentplaceholder 和默认内容*](multiple-contentplaceholders-and-default-content-vb.md)教程介绍了如何在母版页中定义 ContentPlaceHolder 的默认内容，以及如何在不需要默认内容的那些页面中替代该内容。</span><span class="sxs-lookup"><span data-stu-id="2cc86-121">The [*Multiple ContentPlaceHolders and Default Content*](multiple-contentplaceholders-and-default-content-vb.md) tutorial showed how to define the default content for a ContentPlaceHolder in the master page and then how to override it in those pages where the default content was not wanted.</span></span>

<span data-ttu-id="2cc86-122">另一种方法是在母版页内创建一个公共属性或方法，该属性或方法指示是显示还是隐藏登录接口。</span><span class="sxs-lookup"><span data-stu-id="2cc86-122">Another option is to create a public property or method within the master page that indicates whether to show or hide the login interface.</span></span> <span data-ttu-id="2cc86-123">例如，母版页可能包含一个名为 `ShowLoginUI` 的公共属性，其值用于设置母版页中登录控件的 `Visible` 属性。</span><span class="sxs-lookup"><span data-stu-id="2cc86-123">For example, the master page might include a public property named `ShowLoginUI` whose value was used to set the `Visible` property of the Login control in the master page.</span></span> <span data-ttu-id="2cc86-124">此时应禁止显示登录用户界面的内容页，然后以编程方式将 `ShowLoginUI` 属性设置为 `False`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-124">Those content pages where the login user interface should be suppressed could then programmatically set the `ShowLoginUI` property to `False`.</span></span>

<span data-ttu-id="2cc86-125">如果在 "内容" 页中早于当前某些操作后需要刷新母版页中显示的数据，则可能会发生内容和母版页交互的最常见示例。</span><span class="sxs-lookup"><span data-stu-id="2cc86-125">Perhaps the most common example of content and master page interaction occurs when data displayed in the master page needs to be refreshed after some action has transpired in the content page.</span></span> <span data-ttu-id="2cc86-126">假设有一个包含 GridView 的母版页，其中显示了来自特定数据库表的五个最近添加的记录，并且其一个内容页包含用于向同一表中添加新记录的接口。</span><span class="sxs-lookup"><span data-stu-id="2cc86-126">Consider a master page that includes a GridView that displays the five most recently added records from a particular database table, and that one of its content pages includes an interface for adding new records to that same table.</span></span>

<span data-ttu-id="2cc86-127">当用户访问页面以添加新记录时，她会看到在母版页中显示的五个最近添加的记录。</span><span class="sxs-lookup"><span data-stu-id="2cc86-127">When a user visits the page to add a new record, she sees the five most recently added records displayed in the master page.</span></span> <span data-ttu-id="2cc86-128">在填写新记录的列的值之后，她提交窗体。</span><span class="sxs-lookup"><span data-stu-id="2cc86-128">After filling in the values for the new record's columns, she submits the form.</span></span> <span data-ttu-id="2cc86-129">假定母版页的 "`EnableViewState`" 属性设置为 "True" （默认值），则会将其内容从视图状态重新加载，因此即使刚将较新的记录添加到数据库中，也会显示五个相同的记录。</span><span class="sxs-lookup"><span data-stu-id="2cc86-129">Assuming that the GridView in the master page has its `EnableViewState` property set to True (the default), its content is reloaded from view state and, consequently, the five same records are displayed even though a newer record was just added to the database.</span></span> <span data-ttu-id="2cc86-130">这可能会给用户造成混淆。</span><span class="sxs-lookup"><span data-stu-id="2cc86-130">This may confuse the user.</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-131">即使您禁用了 GridView 的视图状态，以便它在每次回发时重新绑定到它的基础数据源，它仍不会显示刚刚添加的记录，因为数据在页生命周期中比将新记录添加到数据库时的数据绑定到ase.</span><span class="sxs-lookup"><span data-stu-id="2cc86-131">Even if you disable the GridView's view state so that it rebinds to its underlying data source on every postback, it still won't show the just-added record because the data is bound to the GridView earlier in the page lifecycle than when the new record is added to the database.</span></span>

<span data-ttu-id="2cc86-132">为了纠正这种情况，以便在回发的母版页上显示刚刚添加的记录，我们需要指示 GridView 在新记录添加到数据库*后*重新绑定到其数据源。</span><span class="sxs-lookup"><span data-stu-id="2cc86-132">To remedy this so that the just-added record is displayed in the master page's GridView on postback we need to instruct the GridView to rebind to its data source *after* the new record has been added to the database.</span></span> <span data-ttu-id="2cc86-133">这需要在内容页和母版页之间进行交互，因为用于添加新记录（及其事件处理程序）的接口位于内容页，但需要刷新的 GridView 在母版页中。</span><span class="sxs-lookup"><span data-stu-id="2cc86-133">This requires interaction between the content and master pages because the interface for adding the new record (and its event handlers) are in the content page but the GridView that needs to be refreshed is in the master page.</span></span>

<span data-ttu-id="2cc86-134">由于从内容页中的事件处理程序刷新母版页的显示是内容和母版页交互的最常见要求之一，接下来让我们更详细地探讨这一主题。</span><span class="sxs-lookup"><span data-stu-id="2cc86-134">Because refreshing the master page's display from an event handler in the content page is one of the most common needs for content and master page interaction, let's explore this topic in more detail.</span></span> <span data-ttu-id="2cc86-135">本教程的下载内容包括网站 `App_Data` 文件夹中名为 `NORTHWIND.MDF` Microsoft SQL Server 2005 Express Edition 数据库。</span><span class="sxs-lookup"><span data-stu-id="2cc86-135">The download for this tutorial includes a Microsoft SQL Server 2005 Express Edition database named `NORTHWIND.MDF` in the website's `App_Data` folder.</span></span> <span data-ttu-id="2cc86-136">Northwind 数据库存储虚构公司、Northwind 商贸的产品、员工和销售信息。</span><span class="sxs-lookup"><span data-stu-id="2cc86-136">The Northwind database stores product, employee, and sales information for a fictitious company, Northwind Traders.</span></span>

<span data-ttu-id="2cc86-137">步骤1指导完成在母版页的 GridView 中显示五个最近添加的产品。</span><span class="sxs-lookup"><span data-stu-id="2cc86-137">Step 1 walks through displaying the five most recently added products in a GridView in the master page.</span></span> <span data-ttu-id="2cc86-138">步骤2创建一个用于添加新产品的内容页。</span><span class="sxs-lookup"><span data-stu-id="2cc86-138">Step 2 creates a content page for adding new products.</span></span> <span data-ttu-id="2cc86-139">步骤3介绍了如何在母版页中创建公共属性和方法，步骤4说明了如何以编程方式通过内容页中的这些属性和方法进行界面。</span><span class="sxs-lookup"><span data-stu-id="2cc86-139">Step 3 looks at how to create public properties and methods in the master page, and Step 4 illustrates how to programmatically interface with these properties and methods from the content page.</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-140">本教程不深入探讨如何使用 ASP.NET 中的数据。</span><span class="sxs-lookup"><span data-stu-id="2cc86-140">This tutorial does not delve into the specifics of working with data in ASP.NET.</span></span> <span data-ttu-id="2cc86-141">用于设置母版页以显示数据的步骤和用于插入数据的内容页已完成，但 breezy。</span><span class="sxs-lookup"><span data-stu-id="2cc86-141">The steps for setting up the master page to display data and the content page for inserting data are complete, yet breezy.</span></span> <span data-ttu-id="2cc86-142">有关显示和插入数据以及使用 SqlDataSource 和 GridView 控件的更深入说明，请参阅本教程末尾的后续读取部分中的资源。</span><span class="sxs-lookup"><span data-stu-id="2cc86-142">For a more in-depth look at displaying and inserting data and using the SqlDataSource and GridView controls, consult the resources in the Further Readings section at the end of this tutorial.</span></span>

## <a name="step-1-displaying-the-five-most-recently-added-products-in-the-master-page"></a><span data-ttu-id="2cc86-143">步骤1：在母版页中显示最近添加的五个产品</span><span class="sxs-lookup"><span data-stu-id="2cc86-143">Step 1: Displaying the Five Most Recently Added Products in the Master Page</span></span>

<span data-ttu-id="2cc86-144">打开 "网站母版页" 母版页，并向 `leftContent` `<div>`中添加标签和 GridView 控件。</span><span class="sxs-lookup"><span data-stu-id="2cc86-144">Open the Site.master master page and add a Label and a GridView control to the `leftContent` `<div>`.</span></span> <span data-ttu-id="2cc86-145">清除标签的 `Text` 属性，将其 `EnableViewState` 属性设置为 `False`，并将其 `ID` 属性设置为 `GridMessage`;将 GridView 的 `ID` 属性设置为 "`RecentProducts`"。</span><span class="sxs-lookup"><span data-stu-id="2cc86-145">Clear out the Label's `Text` property, set its `EnableViewState` property to `False`, and its `ID` property to `GridMessage`; set the GridView's `ID` property to `RecentProducts`.</span></span> <span data-ttu-id="2cc86-146">接下来，从设计器展开 GridView 的智能标记，然后选择将其绑定到新的数据源。</span><span class="sxs-lookup"><span data-stu-id="2cc86-146">Next, from the Designer, expand the GridView's smart tag and choose to bind it to a new data source.</span></span> <span data-ttu-id="2cc86-147">这将启动 "数据源配置向导"。</span><span class="sxs-lookup"><span data-stu-id="2cc86-147">This launches the Data Source Configuration wizard.</span></span> <span data-ttu-id="2cc86-148">由于 `App_Data` 文件夹中的 Northwind 数据库是 Microsoft SQL Server 数据库，因此请选择通过选择创建 SqlDataSource （请参阅图1）;将 SqlDataSource 命名为 `RecentProductsDataSource`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-148">Because the Northwind database in the `App_Data` folder is a Microsoft SQL Server database, choose to create a SqlDataSource by selecting (see Figure 1); name the SqlDataSource `RecentProductsDataSource`.</span></span>

<span data-ttu-id="2cc86-149">[![将 GridView 绑定到名为 RecentProductsDataSource 的 SqlDataSource 控件](interacting-with-the-master-page-from-the-content-page-vb/_static/image2.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-149">[![Bind the GridView to a SqlDataSource Control Named RecentProductsDataSource](interacting-with-the-master-page-from-the-content-page-vb/_static/image2.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image1.png)</span></span>

<span data-ttu-id="2cc86-150">**图 01**：将 GridView 绑定到名为 `RecentProductsDataSource` 的 SqlDataSource 控件（[单击查看完全大小的图像](interacting-with-the-master-page-from-the-content-page-vb/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-150">**Figure 01**: Bind the GridView to a SqlDataSource Control Named `RecentProductsDataSource` ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image3.png))</span></span>

<span data-ttu-id="2cc86-151">下一步将要求我们指定要连接到的数据库。</span><span class="sxs-lookup"><span data-stu-id="2cc86-151">The next step asks us to specify what database to connect to.</span></span> <span data-ttu-id="2cc86-152">从下拉列表中选择 "`NORTHWIND.MDF` 数据库文件"，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="2cc86-152">Choose the `NORTHWIND.MDF` database file from the drop-down list and click Next.</span></span> <span data-ttu-id="2cc86-153">由于这是我们首次使用此数据库，因此向导将提供将连接字符串存储在 `Web.config`中。</span><span class="sxs-lookup"><span data-stu-id="2cc86-153">Because this is the first time we've used this database, the wizard will offer to store the connection string in `Web.config`.</span></span> <span data-ttu-id="2cc86-154">让它使用名称 `NorthwindConnectionString`存储连接字符串。</span><span class="sxs-lookup"><span data-stu-id="2cc86-154">Have it store the connection string using the name `NorthwindConnectionString`.</span></span>

<span data-ttu-id="2cc86-155">[![连接到 Northwind 数据库](interacting-with-the-master-page-from-the-content-page-vb/_static/image5.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-155">[![Connect to the Northwind Database](interacting-with-the-master-page-from-the-content-page-vb/_static/image5.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image4.png)</span></span>

<span data-ttu-id="2cc86-156">**图 02**：连接到 Northwind 数据库（[单击以查看完全大小的图像](interacting-with-the-master-page-from-the-content-page-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-156">**Figure 02**: Connect to the Northwind Database  ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image6.png))</span></span>

<span data-ttu-id="2cc86-157">"配置数据源" 向导提供了两种方法，通过该向导可以指定用于检索数据的查询：</span><span class="sxs-lookup"><span data-stu-id="2cc86-157">The Configure Data Source wizard provides two means by which we can specify the query used to retrieve data:</span></span>

- <span data-ttu-id="2cc86-158">通过指定自定义 SQL 语句或存储过程，或</span><span class="sxs-lookup"><span data-stu-id="2cc86-158">By specifying a custom SQL statement or stored procedure, or</span></span>
- <span data-ttu-id="2cc86-159">选择表或视图，然后指定要返回的列</span><span class="sxs-lookup"><span data-stu-id="2cc86-159">By picking a table or view and then specifying the columns to return</span></span>

<span data-ttu-id="2cc86-160">由于我们只需要返回最近添加的五个产品，因此需要指定自定义 SQL 语句。</span><span class="sxs-lookup"><span data-stu-id="2cc86-160">Because we want to return just the five most recently added products, we need to specify a custom SQL statement.</span></span> <span data-ttu-id="2cc86-161">使用以下 `SELECT` 查询：</span><span class="sxs-lookup"><span data-stu-id="2cc86-161">Use the following `SELECT` query:</span></span>

[!code-sql[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample1.sql)]

<span data-ttu-id="2cc86-162">`TOP 5` 关键字只返回查询的前5条记录。</span><span class="sxs-lookup"><span data-stu-id="2cc86-162">The `TOP 5` keyword returns only the first five records from the query.</span></span> <span data-ttu-id="2cc86-163">`Products` 表的主键 `ProductID`为 `IDENTITY` 列，这可确保添加到表中的每个新产品都将具有比上一个条目更大的值。</span><span class="sxs-lookup"><span data-stu-id="2cc86-163">The `Products` table's primary key, `ProductID`, is an `IDENTITY` column, which assures us that each new product added to the table will have a larger value than the previous entry.</span></span> <span data-ttu-id="2cc86-164">因此，`ProductID` 按降序对结果进行排序时，将返回以最近创建的产品开头的产品。</span><span class="sxs-lookup"><span data-stu-id="2cc86-164">Therefore, sorting the results by `ProductID` in descending order returns the products starting with the most recently created ones.</span></span>

<span data-ttu-id="2cc86-165">[![返回最近添加的五个产品](interacting-with-the-master-page-from-the-content-page-vb/_static/image8.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-165">[![Return the Five Most Recently Added Products](interacting-with-the-master-page-from-the-content-page-vb/_static/image8.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image7.png)</span></span>

<span data-ttu-id="2cc86-166">**图 03**：返回最近添加的五个产品（[单击以查看完全大小的映像](interacting-with-the-master-page-from-the-content-page-vb/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-166">**Figure 03**: Return the Five Most Recently Added Products  ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image9.png))</span></span>

<span data-ttu-id="2cc86-167">完成向导后，Visual Studio 将为 GridView 生成两个 BoundFields，以显示从数据库返回的 `ProductName` 和 `UnitPrice` 字段。</span><span class="sxs-lookup"><span data-stu-id="2cc86-167">After completing the wizard, Visual Studio generates two BoundFields for the GridView to display the `ProductName` and `UnitPrice` fields returned from the database.</span></span> <span data-ttu-id="2cc86-168">此时，母版页的声明性标记应包含如下标记：</span><span class="sxs-lookup"><span data-stu-id="2cc86-168">At this point your master page's declarative markup should include markup similar to the following:</span></span>

[!code-aspx[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample2.aspx)]

<span data-ttu-id="2cc86-169">如您所见，标记包含：标签 Web 控件（`GridMessage`）;GridView `RecentProducts`，具有两个 BoundFields;和一个 SqlDataSource 控件，该控件返回最近添加的五个产品。</span><span class="sxs-lookup"><span data-stu-id="2cc86-169">As you can see, the markup contains: the Label Web control (`GridMessage`); the GridView `RecentProducts`, with two BoundFields; and a SqlDataSource control that returns the five most recently added products.</span></span>

<span data-ttu-id="2cc86-170">创建此 GridView 并配置其 SqlDataSource 控件后，通过浏览器访问网站。</span><span class="sxs-lookup"><span data-stu-id="2cc86-170">With this GridView created and its SqlDataSource control configured, visit the website through a browser.</span></span> <span data-ttu-id="2cc86-171">如图4所示，将在左下角看到一个网格，其中列出了五个最近添加的产品。</span><span class="sxs-lookup"><span data-stu-id="2cc86-171">As Figure 4 shows, you will see a grid in the lower left corner that lists the five most recently added products.</span></span>

<span data-ttu-id="2cc86-172">[![GridView 显示最近添加的五个产品](interacting-with-the-master-page-from-the-content-page-vb/_static/image11.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-172">[![The GridView Displays the Five Most Recently Added Products](interacting-with-the-master-page-from-the-content-page-vb/_static/image11.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image10.png)</span></span>

<span data-ttu-id="2cc86-173">**图 04**： GridView 显示最近添加的五个产品（[单击以查看完全大小的图像](interacting-with-the-master-page-from-the-content-page-vb/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-173">**Figure 04**: The GridView Displays the Five Most Recently Added Products ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image12.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-174">随意清理 GridView 的外观。</span><span class="sxs-lookup"><span data-stu-id="2cc86-174">Feel free to clean up the appearance of the GridView.</span></span> <span data-ttu-id="2cc86-175">某些建议包括将显示的 `UnitPrice` 值的格式设置为货币，并使用背景色和字体来改善网格的外观。</span><span class="sxs-lookup"><span data-stu-id="2cc86-175">Some suggestions include formatting the displayed `UnitPrice` value as a currency and using background colors and fonts to improve the grid's appearance.</span></span>

## <a name="step-2-creating-a-content-page-to-add-new-products"></a><span data-ttu-id="2cc86-176">步骤2：创建内容页以添加新产品</span><span class="sxs-lookup"><span data-stu-id="2cc86-176">Step 2: Creating a Content Page to Add New Products</span></span>

<span data-ttu-id="2cc86-177">下一个任务是创建一个内容页，用户可以从中将新产品添加到 `Products` 表。</span><span class="sxs-lookup"><span data-stu-id="2cc86-177">Our next task is to create a content page from which a user can add a new product to the `Products` table.</span></span> <span data-ttu-id="2cc86-178">将新的 "内容" 页添加到名为 "`AddProduct.aspx``Admin` 文件夹中，并确保将其绑定到 `Site.master` 母版页。</span><span class="sxs-lookup"><span data-stu-id="2cc86-178">Add a new content page to the `Admin` folder named `AddProduct.aspx`, making sure to bind it to the `Site.master` master page.</span></span> <span data-ttu-id="2cc86-179">图5显示了在此页面添加到网站后解决方案资源管理器。</span><span class="sxs-lookup"><span data-stu-id="2cc86-179">Figure 5 shows the Solution Explorer after this page has been added to the website.</span></span>

<span data-ttu-id="2cc86-180">[![将新的 ASP.NET 页面添加到管理文件夹](interacting-with-the-master-page-from-the-content-page-vb/_static/image14.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-180">[![Add a New ASP.NET Page to the Admin Folder](interacting-with-the-master-page-from-the-content-page-vb/_static/image14.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image13.png)</span></span>

<span data-ttu-id="2cc86-181">**图 05**：将新的 "ASP.NET" 页添加到 `Admin` 文件夹（[单击查看完全大小的图像](interacting-with-the-master-page-from-the-content-page-vb/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-181">**Figure 05**: Add a New ASP.NET Page to the `Admin` Folder ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image15.png))</span></span>

<span data-ttu-id="2cc86-182">请记住，在母版页教程的 "[*指定标题、Meta 标记和其他 HTML 标题*](specifying-the-title-meta-tags-and-other-html-headers-in-the-master-page-vb.md)" 中，我们创建了一个名为 `BasePage` 的自定义基类类，如果未显式设置该页面的标题，则生成该页面的标题。</span><span class="sxs-lookup"><span data-stu-id="2cc86-182">Recall that in the [*Specifying the Title, Meta Tags, and Other HTML Headers in the Master Page*](specifying-the-title-meta-tags-and-other-html-headers-in-the-master-page-vb.md) tutorial we created a custom base page class named `BasePage` that generated the page's title if it was not explicitly set.</span></span> <span data-ttu-id="2cc86-183">转到 "`AddProduct.aspx`" 页的代码隐藏类，并使其从 `BasePage` （而不是从 `System.Web.UI.Page`）派生。</span><span class="sxs-lookup"><span data-stu-id="2cc86-183">Go to the `AddProduct.aspx` page's code-behind class and have it derive from `BasePage` (instead of from `System.Web.UI.Page`).</span></span>

<span data-ttu-id="2cc86-184">最后，更新 `Web.sitemap` 文件以包含本课中的条目。</span><span class="sxs-lookup"><span data-stu-id="2cc86-184">Finally, update the `Web.sitemap` file to include an entry for this lesson.</span></span> <span data-ttu-id="2cc86-185">在控件 ID 命名问题课程的 `<siteMapNode>` 下面添加以下标记：</span><span class="sxs-lookup"><span data-stu-id="2cc86-185">Add the following markup beneath the `<siteMapNode>` for the Control ID Naming Issues lesson:</span></span>

[!code-xml[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample3.xml)]

<span data-ttu-id="2cc86-186">如图6所示，此 `<siteMapNode>` 元素的添加在课程列表中反映出来。</span><span class="sxs-lookup"><span data-stu-id="2cc86-186">As shown in Figure 6, the addition of this `<siteMapNode>` element is reflected in the Lessons list.</span></span>

<span data-ttu-id="2cc86-187">返回 `AddProduct.aspx`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-187">Return to `AddProduct.aspx`.</span></span> <span data-ttu-id="2cc86-188">在 `MainContent` ContentPlaceHolder 的内容控件中，添加 DetailsView 控件并将其命名为 `NewProduct`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-188">In the Content control for the `MainContent` ContentPlaceHolder, add a DetailsView control and name it `NewProduct`.</span></span> <span data-ttu-id="2cc86-189">将 DetailsView 绑定到名为 `NewProductDataSource`的新 SqlDataSource 控件。</span><span class="sxs-lookup"><span data-stu-id="2cc86-189">Bind the DetailsView to a new SqlDataSource control named `NewProductDataSource`.</span></span> <span data-ttu-id="2cc86-190">与步骤1中的 SqlDataSource 类似，将向导配置为使用 Northwind 数据库，并选择指定自定义 SQL 语句。</span><span class="sxs-lookup"><span data-stu-id="2cc86-190">Like with the SqlDataSource in Step 1, configure the wizard so that it uses the Northwind database and choose to specify a custom SQL statement.</span></span> <span data-ttu-id="2cc86-191">因为 DetailsView 将用于向数据库添加项，所以需要同时指定 `SELECT` 语句和 `INSERT` 语句。</span><span class="sxs-lookup"><span data-stu-id="2cc86-191">Because the DetailsView will be used to add items to the database, we need to specify both a `SELECT` statement and an `INSERT` statement.</span></span> <span data-ttu-id="2cc86-192">使用以下 `SELECT` 查询：</span><span class="sxs-lookup"><span data-stu-id="2cc86-192">Use the following `SELECT` query:</span></span>

[!code-sql[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample4.sql)]

<span data-ttu-id="2cc86-193">然后，在 "插入" 选项卡中添加以下 `INSERT` 语句：</span><span class="sxs-lookup"><span data-stu-id="2cc86-193">Then, from the INSERT tab, add the following `INSERT` statement:</span></span>

[!code-sql[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample5.sql)]

<span data-ttu-id="2cc86-194">完成向导后，请跳到 DetailsView 的智能标记，并选中 "启用插入" 复选框。</span><span class="sxs-lookup"><span data-stu-id="2cc86-194">After completing the wizard go to the DetailsView's smart tag and check the "Enable Inserting" checkbox.</span></span> <span data-ttu-id="2cc86-195">这会将 CommandField 添加到 DetailsView，并将其 `ShowInsertButton` 属性设置为 True。</span><span class="sxs-lookup"><span data-stu-id="2cc86-195">This adds a CommandField to the DetailsView with its `ShowInsertButton` property set to True.</span></span> <span data-ttu-id="2cc86-196">由于此 DetailsView 仅用于插入数据，因此请将 DetailsView 的 `DefaultMode` 属性设置为 `Insert`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-196">Because this DetailsView will be used solely for inserting data, set the DetailsView's `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="2cc86-197">就这么简单！</span><span class="sxs-lookup"><span data-stu-id="2cc86-197">That's all there is to it!</span></span> <span data-ttu-id="2cc86-198">让我们测试此页。</span><span class="sxs-lookup"><span data-stu-id="2cc86-198">Let's test this page.</span></span> <span data-ttu-id="2cc86-199">通过浏览器访问 `AddProduct.aspx`，输入名称和价格（见图6）。</span><span class="sxs-lookup"><span data-stu-id="2cc86-199">Visit `AddProduct.aspx` through a browser, enter a name and price (see Figure 6).</span></span>

<span data-ttu-id="2cc86-200">[![将新产品添加到数据库](interacting-with-the-master-page-from-the-content-page-vb/_static/image17.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-200">[![Add a New Product to the Database](interacting-with-the-master-page-from-the-content-page-vb/_static/image17.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image16.png)</span></span>

<span data-ttu-id="2cc86-201">**图 06**：向数据库添加新产品（[单击以查看完全大小的映像](interacting-with-the-master-page-from-the-content-page-vb/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-201">**Figure 06**: Add a New Product to the Database  ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image18.png))</span></span>

<span data-ttu-id="2cc86-202">键入新产品的名称和价格后，单击 "插入" 按钮。</span><span class="sxs-lookup"><span data-stu-id="2cc86-202">After typing in the name and price for your new product, click the Insert button.</span></span> <span data-ttu-id="2cc86-203">这将导致窗体回发。</span><span class="sxs-lookup"><span data-stu-id="2cc86-203">This causes the form to postback.</span></span> <span data-ttu-id="2cc86-204">在回发时，将执行 SqlDataSource 控件的 `INSERT` 语句;它的两个参数用用户输入的值填充到 DetailsView 的两个 TextBox 控件中。</span><span class="sxs-lookup"><span data-stu-id="2cc86-204">On postback, the SqlDataSource control's `INSERT` statement is executed; its two parameters are populated with the user-entered values in the DetailsView's two TextBox controls.</span></span> <span data-ttu-id="2cc86-205">遗憾的是，没有出现插入的视觉反馈。</span><span class="sxs-lookup"><span data-stu-id="2cc86-205">Unfortunately, there is no visual feedback that an insert has occurred.</span></span> <span data-ttu-id="2cc86-206">最好显示一条消息，确认已添加新记录。</span><span class="sxs-lookup"><span data-stu-id="2cc86-206">It would be nice to have a message displayed, confirming that a new record has been added.</span></span> <span data-ttu-id="2cc86-207">我将此留给读者的练习。</span><span class="sxs-lookup"><span data-stu-id="2cc86-207">I leave this as an exercise for the reader.</span></span> <span data-ttu-id="2cc86-208">此外，在从 DetailsView 添加新记录后，母版页中的 GridView 仍显示与以前相同的五个记录;它不包含刚刚添加的记录。</span><span class="sxs-lookup"><span data-stu-id="2cc86-208">Also, after adding a new record from the DetailsView the GridView in the master page still shows the same five records as before; it does not include the just-added record.</span></span> <span data-ttu-id="2cc86-209">我们将在后面的步骤中检查如何解决此情况。</span><span class="sxs-lookup"><span data-stu-id="2cc86-209">We'll examine how to remedy this in the upcoming steps.</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-210">除了添加某种形式的视觉反馈以使插入成功，我还鼓励您同时更新 DetailsView 的插入界面以包括验证。</span><span class="sxs-lookup"><span data-stu-id="2cc86-210">In addition to adding some form of visual feedback that the insert has succeeded, I'd encourage you to also update the DetailsView's inserting interface to include validation.</span></span> <span data-ttu-id="2cc86-211">目前没有任何验证。</span><span class="sxs-lookup"><span data-stu-id="2cc86-211">Currently, there is no validation.</span></span> <span data-ttu-id="2cc86-212">如果用户为 "`UnitPrice`" 字段输入无效的值（例如 "开销太高"），则当系统尝试将该字符串转换为十进制时，回发时将引发异常。</span><span class="sxs-lookup"><span data-stu-id="2cc86-212">If a user enters an invalid value for the `UnitPrice` field, such as "Too expensive," an exception will be thrown on postback when the system attempts to convert that string into a decimal.</span></span> <span data-ttu-id="2cc86-213">有关自定义插入界面的详细信息，请参阅使用[数据教程系列](../../data-access/index.md)中的[*自定义数据修改界面*教程](https://asp.net/learn/data-access/tutorial-20-vb.aspx)。</span><span class="sxs-lookup"><span data-stu-id="2cc86-213">For more information on customizing the inserting interface, refer to the [*Customizing the Data Modification Interface* tutorial](https://asp.net/learn/data-access/tutorial-20-vb.aspx) from my [Working with Data tutorial series](../../data-access/index.md).</span></span>

## <a name="step-3-creating-public-properties-and-methods-in-the-master-page"></a><span data-ttu-id="2cc86-214">步骤3：在母版页中创建公共属性和方法</span><span class="sxs-lookup"><span data-stu-id="2cc86-214">Step 3: Creating Public Properties and Methods in the Master Page</span></span>

<span data-ttu-id="2cc86-215">在步骤1中，我们在母版页的 GridView 上方添加了名为 `GridMessage` 的标签 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="2cc86-215">In Step 1 we added a Label Web control named `GridMessage` above the GridView in the master page.</span></span> <span data-ttu-id="2cc86-216">此标签用于选择性地显示消息。</span><span class="sxs-lookup"><span data-stu-id="2cc86-216">This Label is intended to optionally display a message.</span></span> <span data-ttu-id="2cc86-217">例如，将新记录添加到 `Products` 表后，我们可能希望显示一条消息，其中包含： "*ProductName*已添加到数据库中"。</span><span class="sxs-lookup"><span data-stu-id="2cc86-217">For example, after adding a new record to the `Products` table, we might want to show a message that reads: "*ProductName* has been added to the database."</span></span> <span data-ttu-id="2cc86-218">我们可能想要通过内容页自定义该消息，而不是在母版页中对此标签文本进行硬编码。</span><span class="sxs-lookup"><span data-stu-id="2cc86-218">Rather than hard-code the text for this Label in the master page, we might want the message to be customizable by the content page.</span></span>

<span data-ttu-id="2cc86-219">由于标签控件作为母版页内的受保护成员变量实现，因此无法直接从内容页访问它。</span><span class="sxs-lookup"><span data-stu-id="2cc86-219">Because the Label control is implemented as a protected member variable within the master page it cannot be accessed directly from content pages.</span></span> <span data-ttu-id="2cc86-220">若要在内容页中处理母版页中的标签（或者在此情况下，在母版页中的任何 Web 控件），我们需要在公开 Web 控件或用作代理的母版页中创建一个公共属性，该属性可以是 存取.</span><span class="sxs-lookup"><span data-stu-id="2cc86-220">In order to work with the Label within a master page from the content page (or, for that matter, any Web control in the master page) we need to create a public property in the master page that exposes the Web control or serves as a proxy by which one of its properties can be accessed.</span></span> <span data-ttu-id="2cc86-221">将以下语法添加到母版页的代码隐藏类中，以公开标签的 `Text` 属性：</span><span class="sxs-lookup"><span data-stu-id="2cc86-221">Add the following syntax to the master page's code-behind class to expose the Label's `Text` property:</span></span>

[!code-vb[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample6.vb)]

<span data-ttu-id="2cc86-222">将新记录从内容页添加到 `Products` 表时，母版页中的 `RecentProducts` GridView 需要重新绑定到其基础数据源。</span><span class="sxs-lookup"><span data-stu-id="2cc86-222">When a new record is added to the `Products` table from a content page the `RecentProducts` GridView in the master page needs to rebind to its underlying data source.</span></span> <span data-ttu-id="2cc86-223">若要重新绑定 GridView，请调用其 `DataBind` 方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-223">To rebind the GridView call its `DataBind` method.</span></span> <span data-ttu-id="2cc86-224">由于不能通过编程方式访问母版页中的 GridView，因此需要在母版页中创建一个公共方法，该方法在被调用时将数据重新绑定到 GridView。</span><span class="sxs-lookup"><span data-stu-id="2cc86-224">Because the GridView in the master page is not programmatically accessible to the content pages, we need to create a public method in the master page that, when called, rebinds the data to the GridView.</span></span> <span data-ttu-id="2cc86-225">将以下方法添加到母版页的代码隐藏类：</span><span class="sxs-lookup"><span data-stu-id="2cc86-225">Add the following method to the master page's code-behind class:</span></span>

[!code-vb[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample7.vb)]

<span data-ttu-id="2cc86-226">利用 `GridMessageText` 属性和 `RefreshRecentProductsGrid` 方法，任何内容页都可以以编程方式设置或读取 `GridMessage` 标签 `Text` 属性的值，或将数据重新绑定到 `RecentProducts` GridView。</span><span class="sxs-lookup"><span data-stu-id="2cc86-226">With the `GridMessageText` property and `RefreshRecentProductsGrid` method in place, any content page can programmatically set or read the value of the `GridMessage` Label's `Text` property or rebind the data to the `RecentProducts` GridView.</span></span> <span data-ttu-id="2cc86-227">步骤4检查如何从内容页访问母版页的公共属性和方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-227">Step 4 examines how to access the master page's public properties and methods from a content page.</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-228">不要忘记将母版页的属性和方法标记为 `Public`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-228">Don't forget to mark the master page's properties and methods as `Public`.</span></span> <span data-ttu-id="2cc86-229">如果未将这些属性和方法显式表示为 `Public`，将无法从 "内容" 页访问这些属性和方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-229">If you do not explicitly denote these properties and methods as `Public`, they will not be accessible from the content page.</span></span>

## <a name="step-4-calling-the-master-pages-public-members-from-a-content-page"></a><span data-ttu-id="2cc86-230">步骤4：从内容页调用母版页的公共成员</span><span class="sxs-lookup"><span data-stu-id="2cc86-230">Step 4: Calling the Master Page's Public Members from a Content Page</span></span>

<span data-ttu-id="2cc86-231">现在，母版页具有必要的公共属性和方法，接下来可以从 `AddProduct.aspx` 的内容页调用这些属性和方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-231">Now that the master page has the necessary public properties and methods, we're ready to invoke these properties and methods from the `AddProduct.aspx` content page.</span></span> <span data-ttu-id="2cc86-232">具体而言，我们需要设置母版页的 `GridMessageText` 属性，并在将新产品添加到数据库后调用其 `RefreshRecentProductsGrid` 方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-232">Specifically, we need to set the master page's `GridMessageText` property and call its `RefreshRecentProductsGrid` method after the new product has been added to the database.</span></span> <span data-ttu-id="2cc86-233">所有 ASP.NET 数据 Web 控件都在完成各种任务之前和之后引发事件，使页面开发人员可以轻松地在任务之前或之后执行某些编程操作。</span><span class="sxs-lookup"><span data-stu-id="2cc86-233">All the ASP.NET data Web controls fire events immediately before and after completing various tasks, which make it easy for page developers to take some programmatic action either before or after the task.</span></span> <span data-ttu-id="2cc86-234">例如，当最终用户单击 DetailsView 的 "插入" 按钮时，在回发之前，DetailsView 会引发其 `ItemInserting` 事件，然后再开始插入工作流。</span><span class="sxs-lookup"><span data-stu-id="2cc86-234">For example, when the end user clicks the DetailsView's Insert button, on postback the DetailsView raises its `ItemInserting` event before beginning the inserting workflow.</span></span> <span data-ttu-id="2cc86-235">然后，将记录插入到数据库中。</span><span class="sxs-lookup"><span data-stu-id="2cc86-235">It then inserts the record into the database.</span></span> <span data-ttu-id="2cc86-236">之后，DetailsView 会引发其 `ItemInserted` 事件。</span><span class="sxs-lookup"><span data-stu-id="2cc86-236">Following that, the DetailsView raises its `ItemInserted` event.</span></span> <span data-ttu-id="2cc86-237">因此，为了在添加新产品后使用母版页，请为 DetailsView 的 `ItemInserted` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="2cc86-237">Therefore, in order to work with the master page after the new product has been added, create an event handler for the DetailsView's `ItemInserted` event.</span></span>

<span data-ttu-id="2cc86-238">内容页可以通过两种方式以编程方式与母版页交互：</span><span class="sxs-lookup"><span data-stu-id="2cc86-238">There are two ways that a content page can programmatically interface with its master page:</span></span>

- <span data-ttu-id="2cc86-239">使用 `Page.Master` 属性，该属性将返回对母版页的松散类型引用，或</span><span class="sxs-lookup"><span data-stu-id="2cc86-239">Using the `Page.Master` property, which returns a loosely-typed reference to the master page, or</span></span>
- <span data-ttu-id="2cc86-240">通过 `@MasterType` 指令指定页的母版页类型或文件路径;这会自动将强类型属性添加到名为 `Master`的页面。</span><span class="sxs-lookup"><span data-stu-id="2cc86-240">Specify the page's master page type or file path via a `@MasterType` directive; this automatically adds a strongly-typed property to the page named `Master`.</span></span>

<span data-ttu-id="2cc86-241">我们来看一下这两种方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-241">Let's examine both approaches.</span></span>

### <a name="using-the-loosely-typedpagemasterproperty"></a><span data-ttu-id="2cc86-242">使用松散类型的`Page.Master`属性</span><span class="sxs-lookup"><span data-stu-id="2cc86-242">Using the Loosely-Typed`Page.Master`Property</span></span>

<span data-ttu-id="2cc86-243">所有 ASP.NET 网页必须派生自 `System.Web.UI` 命名空间中的 `Page` 类。</span><span class="sxs-lookup"><span data-stu-id="2cc86-243">All ASP.NET web pages must derive from the `Page` class, which is located in the `System.Web.UI` namespace.</span></span> <span data-ttu-id="2cc86-244">`Page` 类包含一个[`Master` 属性](https://msdn.microsoft.com/library/system.web.ui.page.master.aspx)，该属性返回对页的母版页的引用。</span><span class="sxs-lookup"><span data-stu-id="2cc86-244">The `Page` class includes a [`Master` property](https://msdn.microsoft.com/library/system.web.ui.page.master.aspx) that returns a reference to the page's master page.</span></span> <span data-ttu-id="2cc86-245">如果页面没有 `Master` 返回 `Nothing`的母版页。</span><span class="sxs-lookup"><span data-stu-id="2cc86-245">If the page does not have a master page `Master` returns `Nothing`.</span></span>

<span data-ttu-id="2cc86-246">`Master` 属性返回[`MasterPage`](https://msdn.microsoft.com/library/system.web.ui.masterpage.aspx)类型的对象（也位于 `System.Web.UI` 命名空间），该对象是所有母版页从中派生的基类型。</span><span class="sxs-lookup"><span data-stu-id="2cc86-246">The `Master` property returns an object of type [`MasterPage`](https://msdn.microsoft.com/library/system.web.ui.masterpage.aspx) (also located in the `System.Web.UI` namespace) which is the base type from which all master pages derive from.</span></span> <span data-ttu-id="2cc86-247">因此，若要使用网站母版页中定义的公共属性或方法，必须将从 `Master` 属性返回的 `MasterPage` 对象转换为相应的类型。</span><span class="sxs-lookup"><span data-stu-id="2cc86-247">Therefore, to use public properties or methods defined in our website's master page we must cast the `MasterPage` object returned from the `Master` property to the appropriate type.</span></span> <span data-ttu-id="2cc86-248">由于我们将母版页文件命名 `Site.master`，因此代码隐藏类名为 `Site`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-248">Because we named our master page file `Site.master`, the code-behind class was named `Site`.</span></span> <span data-ttu-id="2cc86-249">因此，以下代码将 `Page.Master` 属性强制转换为 `Site` 类的实例。</span><span class="sxs-lookup"><span data-stu-id="2cc86-249">Therefore, the following code casts the `Page.Master` property to an instance of the `Site` class.</span></span>

[!code-vb[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample8.vb)]

<span data-ttu-id="2cc86-250">现在，我们已将松散类型的 `Page.Master` 属性强制转换到站点类型，接下来我们可以引用特定于站点的属性和方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-250">Now that we have casted the loosely-typed `Page.Master` property to the Site type we can reference the properties and methods specific to Site.</span></span> <span data-ttu-id="2cc86-251">如图7所示，公共属性 `GridMessageText` 会出现在 IntelliSense 下拉。</span><span class="sxs-lookup"><span data-stu-id="2cc86-251">As Figure 7 shows, the public property `GridMessageText` appears in the IntelliSense drop-down.</span></span>

<span data-ttu-id="2cc86-252">[![IntelliSense 显示母版页的公共属性和方法](interacting-with-the-master-page-from-the-content-page-vb/_static/image20.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-252">[![IntelliSense Shows our Master Page's Public Properties and Methods](interacting-with-the-master-page-from-the-content-page-vb/_static/image20.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image19.png)</span></span>

<span data-ttu-id="2cc86-253">**图 07**： IntelliSense 显示母版页的公共属性和方法（[单击以查看完全大小的图像](interacting-with-the-master-page-from-the-content-page-vb/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-253">**Figure 07**: IntelliSense Shows our Master Page's Public Properties and Methods ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image21.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-254">如果已将母版页文件命名 `MasterPage.master` 则母版页的代码隐藏类名称将 `MasterPage`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-254">If you named your master page file `MasterPage.master` then the master page's code-behind class name is `MasterPage`.</span></span> <span data-ttu-id="2cc86-255">从类型 `System.Web.UI.MasterPage` 转换到 `MasterPage` 类时，这可能导致不明确的代码。</span><span class="sxs-lookup"><span data-stu-id="2cc86-255">This can lead to ambiguous code when casting from the type `System.Web.UI.MasterPage` to your `MasterPage` class.</span></span> <span data-ttu-id="2cc86-256">简而言之，你需要完全限定要强制转换到的类型，这在使用网站项目模型时可能有点棘手。</span><span class="sxs-lookup"><span data-stu-id="2cc86-256">In short, you need to fully qualify the type you are casting to, which can be a little tricky when using the Web Site Project model.</span></span> <span data-ttu-id="2cc86-257">我的建议是确保在创建母版页时将其命名为除 `MasterPage.master` 或更好的方式，即创建对母版页的强类型引用。</span><span class="sxs-lookup"><span data-stu-id="2cc86-257">My suggestion would be to either make sure that when you create your master page you name it something other than `MasterPage.master` or, even better, create a strongly-typed reference to the master page.</span></span>

### <a name="creating-a-strongly-typed-reference-with-themastertypedirective"></a><span data-ttu-id="2cc86-258">使用`@MasterType`指令创建强类型引用</span><span class="sxs-lookup"><span data-stu-id="2cc86-258">Creating a Strongly-Typed Reference with the`@MasterType`Directive</span></span>

<span data-ttu-id="2cc86-259">仔细查看时，可以看到 ASP.NET 页面的代码隐藏类是分部类（请注意类定义中的 `Partial` 关键字）。</span><span class="sxs-lookup"><span data-stu-id="2cc86-259">If you look closely you can see that an ASP.NET page's code-behind class is a partial class (note the `Partial` keyword in the class definition).</span></span> <span data-ttu-id="2cc86-260">分部类在C#和 Visual Basic with.NET Framework 2.0 中引入，并且简言之，允许跨多个文件定义类的成员。</span><span class="sxs-lookup"><span data-stu-id="2cc86-260">Partial classes were introduced in C# and Visual Basic with.NET Framework 2.0 and, in a nutshell, allow for a class's members to be defined across multiple files.</span></span> <span data-ttu-id="2cc86-261">例如，代码隐藏类文件 `AddProduct.aspx.vb`，其中包含开发人员创建的代码。</span><span class="sxs-lookup"><span data-stu-id="2cc86-261">The code-behind class file - `AddProduct.aspx.vb`, for example - contains the code that we, the page developer, create.</span></span> <span data-ttu-id="2cc86-262">除了我们的代码，ASP.NET 引擎还会自动创建一个单独的类文件，其中包含中的属性和事件处理程序，将声明性标记转换为该页的类层次结构。</span><span class="sxs-lookup"><span data-stu-id="2cc86-262">In addition to our code, the ASP.NET engine automatically creates a separate class file with properties and event handlers in that translate the declarative markup into the page's class hierarchy.</span></span>

<span data-ttu-id="2cc86-263">只要访问 ASP.NET 页面，就会自动生成代码，铺平了道路为一些更有趣的有用方法。</span><span class="sxs-lookup"><span data-stu-id="2cc86-263">The automatic code generation that occurs whenever an ASP.NET page is visited paves the way for some rather interesting and useful possibilities.</span></span> <span data-ttu-id="2cc86-264">对于母版页，如果我们告诉 ASP.NET 引擎我们的内容页面正在使用哪个母版页，它会为我们生成强类型的 `Master` 属性。</span><span class="sxs-lookup"><span data-stu-id="2cc86-264">In the case of master pages, if we tell the ASP.NET engine what master page is being used by our content page it generates a strongly-typed `Master` property for us.</span></span>

<span data-ttu-id="2cc86-265">使用[`@MasterType` 指令](https://msdn.microsoft.com/library/ms228274.aspx)通知 ASP.NET 引擎内容页的母版页类型。</span><span class="sxs-lookup"><span data-stu-id="2cc86-265">Use the [`@MasterType` directive](https://msdn.microsoft.com/library/ms228274.aspx) to inform the ASP.NET engine of the content page's master page type.</span></span> <span data-ttu-id="2cc86-266">`@MasterType` 指令可以接受母版页的类型名称或其文件路径。</span><span class="sxs-lookup"><span data-stu-id="2cc86-266">The `@MasterType` directive can accept either the type name of the master page or its file path.</span></span> <span data-ttu-id="2cc86-267">若要指定 `AddProduct.aspx` 页使用 `Site.master` 作为其母版页，请将以下指令添加到 `AddProduct.aspx`的顶部：</span><span class="sxs-lookup"><span data-stu-id="2cc86-267">To specify that the `AddProduct.aspx` page uses `Site.master` as its master page, add the following directive to the top of `AddProduct.aspx`:</span></span>

[!code-aspx[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample9.aspx)]

<span data-ttu-id="2cc86-268">此指令指示 ASP.NET 引擎通过名为 `Master`的属性向母版页添加强类型引用。</span><span class="sxs-lookup"><span data-stu-id="2cc86-268">This directive instructs the ASP.NET engine to add a strongly-typed reference to the master page through a property named `Master`.</span></span> <span data-ttu-id="2cc86-269">使用 `@MasterType` 指令后，可以直接通过 `Master` 属性调用 `Site.master` 母版页的公共属性和方法，无需进行任何强制转换。</span><span class="sxs-lookup"><span data-stu-id="2cc86-269">With the `@MasterType` directive in place, we can call the `Site.master` master page's public properties and methods directly through the `Master` property without any casts.</span></span>

> [!NOTE]
> <span data-ttu-id="2cc86-270">如果省略 `@MasterType` 指令，则语法 `Page.Master` 和 `Master` 返回相同的内容：到页面的母版页的松散类型的对象。</span><span class="sxs-lookup"><span data-stu-id="2cc86-270">If you omit the `@MasterType` directive, the syntax `Page.Master` and `Master` return the same thing: a loosely-typed object to the page's master page.</span></span> <span data-ttu-id="2cc86-271">如果包括 `@MasterType` 指令，则 `Master` 返回对指定母版页的强类型引用。</span><span class="sxs-lookup"><span data-stu-id="2cc86-271">If you include the `@MasterType` directive then `Master` returns a strongly-typed reference to the specified master page.</span></span> <span data-ttu-id="2cc86-272">但 `Page.Master`仍返回松类型引用。</span><span class="sxs-lookup"><span data-stu-id="2cc86-272">`Page.Master`, however, still returns a loosely-typed reference.</span></span> <span data-ttu-id="2cc86-273">若要更全面地了解这种情况的原因，以及如何在包含 `@MasterType` 指令时构造 `Master` 属性，请参阅[ASP.NET 2.0 中](http://odetocode.com/Blogs/scott/archive/2005/07/16/1944.aspx)的[Allen](http://odetocode.com/blogs/scott/default.aspx)的博客文章`@MasterType`。</span><span class="sxs-lookup"><span data-stu-id="2cc86-273">For a more thorough look at why this is the case and how the `Master` property is constructed when the `@MasterType` directive is included, see [K. Scott Allen](http://odetocode.com/blogs/scott/default.aspx)'s blog entry [`@MasterType` in ASP.NET 2.0](http://odetocode.com/Blogs/scott/archive/2005/07/16/1944.aspx).</span></span>

### <a name="updating-the-master-page-after-adding-a-new-product"></a><span data-ttu-id="2cc86-274">添加新产品后更新母版页</span><span class="sxs-lookup"><span data-stu-id="2cc86-274">Updating the Master Page After Adding a New Product</span></span>

<span data-ttu-id="2cc86-275">现在，我们知道如何从内容页中调用母版页的公共属性和方法，接下来可以更新 `AddProduct.aspx` 页面，使母版页在添加新产品后进行刷新。</span><span class="sxs-lookup"><span data-stu-id="2cc86-275">Now that we know how to invoke a master page's public properties and methods from a content page, we're ready to update the `AddProduct.aspx` page so that the master page is refreshed after adding a new product.</span></span> <span data-ttu-id="2cc86-276">在步骤4开始时，我们为 DetailsView 控件的 `ItemInserting` 事件创建了一个事件处理程序，该事件将在新产品添加到数据库之后立即执行。</span><span class="sxs-lookup"><span data-stu-id="2cc86-276">At the beginning of Step 4 we created an event handler for the DetailsView control's `ItemInserting` event, which executes immediately after the new product has been added to the database.</span></span> <span data-ttu-id="2cc86-277">将以下代码添加到该事件处理程序：</span><span class="sxs-lookup"><span data-stu-id="2cc86-277">Add the following code to that event handler:</span></span>

[!code-vb[Main](interacting-with-the-master-page-from-the-content-page-vb/samples/sample10.vb)]

<span data-ttu-id="2cc86-278">上面的代码使用松散类型的 `Page.Master` 属性和强类型的 `Master` 属性。</span><span class="sxs-lookup"><span data-stu-id="2cc86-278">The above code uses both the loosely-typed `Page.Master` property and the strongly-typed `Master` property.</span></span> <span data-ttu-id="2cc86-279">请注意，`GridMessageText` 属性设置为 "已添加到网格的*ProductName* ..."可以通过 `e.Values` 集合访问刚刚添加的产品值;正如您所看到的，只需通过 `e.Values("ProductName")`访问刚添加的 `ProductName` 值即可。</span><span class="sxs-lookup"><span data-stu-id="2cc86-279">Note that the `GridMessageText` property is set to "*ProductName* added to grid..." The just-added product's values are accessible through the `e.Values` collection; as you can see, the just-added `ProductName` value is accessed via `e.Values("ProductName")`.</span></span>

<span data-ttu-id="2cc86-280">图8显示了一个新产品 Soda （已添加到数据库）后立即出现 `AddProduct.aspx` 页面。</span><span class="sxs-lookup"><span data-stu-id="2cc86-280">Figure 8 shows the `AddProduct.aspx` page immediately after a new product - Scott's Soda - has been added to the database.</span></span> <span data-ttu-id="2cc86-281">请注意，在母版页的标签中将注明刚刚添加的产品名称，并且 GridView 已刷新为包含产品及其价格。</span><span class="sxs-lookup"><span data-stu-id="2cc86-281">Note that the just-added product name is noted in the master page's Label and that the GridView has been refreshed to include the product and its price.</span></span>

<span data-ttu-id="2cc86-282">[![母版页的标签和 GridView 显示刚刚添加的产品](interacting-with-the-master-page-from-the-content-page-vb/_static/image23.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="2cc86-282">[![The Master Page's Label and GridView Show the Just-Added Product](interacting-with-the-master-page-from-the-content-page-vb/_static/image23.png)](interacting-with-the-master-page-from-the-content-page-vb/_static/image22.png)</span></span>

<span data-ttu-id="2cc86-283">**图 08**：母版页的标签和 GridView 显示刚刚添加的产品（[单击查看完全尺寸的图像](interacting-with-the-master-page-from-the-content-page-vb/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="2cc86-283">**Figure 08**: The Master Page's Label and GridView Show the Just-Added Product ([Click to view full-size image](interacting-with-the-master-page-from-the-content-page-vb/_static/image24.png))</span></span>

## <a name="summary"></a><span data-ttu-id="2cc86-284">总结</span><span class="sxs-lookup"><span data-stu-id="2cc86-284">Summary</span></span>

<span data-ttu-id="2cc86-285">理想情况下，母版页及其内容页完全独立，无需交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-285">Ideally, a master page and its content pages are completely separate from one another and require no level of interaction.</span></span> <span data-ttu-id="2cc86-286">尽管母版页和内容页面的设计目的应考虑到这一点，但在某些常见情况下，内容页必须与其母版页交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-286">While master pages and content pages should be designed with that goal in mind, there are a number of common scenarios in which a content page must interface with its master page.</span></span> <span data-ttu-id="2cc86-287">最常见的原因之一是，基于在内容页中早于当前的某个操作更新母版页显示的特定部分。</span><span class="sxs-lookup"><span data-stu-id="2cc86-287">One of the most common reasons centers around updating a particular portion of the master page display based on some action that transpired in the content page.</span></span>

<span data-ttu-id="2cc86-288">好消息是，使内容页以编程方式与母版页交互是相对简单的。</span><span class="sxs-lookup"><span data-stu-id="2cc86-288">The good news is that it's relatively straightforward to have a content page programmatically interact with its master page.</span></span> <span data-ttu-id="2cc86-289">首先在母版页中创建公共属性或方法，该母版页封装了内容页需要调用的功能。</span><span class="sxs-lookup"><span data-stu-id="2cc86-289">Start by creating public properties or methods in the master page that encapsulate the functionality that needs to be invoked by a content page.</span></span> <span data-ttu-id="2cc86-290">然后，在 "内容" 页中，通过松散类型的 `Page.Master` 属性访问母版页的属性和方法，或使用 `@MasterType` 指令创建对母版页的强类型引用。</span><span class="sxs-lookup"><span data-stu-id="2cc86-290">Then, in the content page, access the master page's properties and methods through the loosely-typed `Page.Master` property or use the `@MasterType` directive to create a strongly-typed reference to the master page.</span></span>

<span data-ttu-id="2cc86-291">在下一教程中，我们将检查如何使母版页以编程方式与其中一个内容页交互。</span><span class="sxs-lookup"><span data-stu-id="2cc86-291">In the next tutorial we examine how to have the master page programmatically interact with one of its content pages.</span></span>

<span data-ttu-id="2cc86-292">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="2cc86-292">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="2cc86-293">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="2cc86-293">Further Reading</span></span>

<span data-ttu-id="2cc86-294">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="2cc86-294">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="2cc86-295">访问和更新 ASP.NET 中的数据</span><span class="sxs-lookup"><span data-stu-id="2cc86-295">Accessing and Updating Data in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/011106-1.aspx)
- [<span data-ttu-id="2cc86-296">ASP.NET 母版页：提示、技巧和陷阱</span><span class="sxs-lookup"><span data-stu-id="2cc86-296">ASP.NET Master Pages: Tips, Tricks, and Traps</span></span>](http://www.odetocode.com/articles/450.aspx)
- [<span data-ttu-id="2cc86-297">ASP.NET 2.0 中的 `@MasterType`</span><span class="sxs-lookup"><span data-stu-id="2cc86-297">`@MasterType` in ASP.NET 2.0</span></span>](http://odetocode.com/Blogs/scott/archive/2005/07/16/1944.aspx)
- [<span data-ttu-id="2cc86-298">在内容和母版页之间传递信息</span><span class="sxs-lookup"><span data-stu-id="2cc86-298">Passing Information Between Content and Master Pages</span></span>](http://aspnet.4guysfromrolla.com/articles/013107-1.aspx)
- [<span data-ttu-id="2cc86-299">使用 ASP.NET 教程中的数据</span><span class="sxs-lookup"><span data-stu-id="2cc86-299">Working with Data in ASP.NET Tutorials</span></span>](../../data-access/index.md)

### <a name="about-the-author"></a><span data-ttu-id="2cc86-300">关于作者</span><span class="sxs-lookup"><span data-stu-id="2cc86-300">About the Author</span></span>

<span data-ttu-id="2cc86-301">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的多个 ASP/asp 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="2cc86-301">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="2cc86-302">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="2cc86-302">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="2cc86-303">他的最新书籍是，[*在24小时内，sam ASP.NET 3.5*](https://www.amazon.com/exec/obidos/ASIN/0672329972/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="2cc86-303">His latest book is [*Sams Teach Yourself ASP.NET 3.5 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672329972/4guysfromrollaco).</span></span> <span data-ttu-id="2cc86-304">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="2cc86-304">Scott can be reached at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="2cc86-305">特别感谢</span><span class="sxs-lookup"><span data-stu-id="2cc86-305">Special Thanks To</span></span>

<span data-ttu-id="2cc86-306">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="2cc86-306">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="2cc86-307">本教程的领导审查人员是 Zack 的。</span><span class="sxs-lookup"><span data-stu-id="2cc86-307">Lead reviewer for this tutorial was Zack Jones.</span></span> <span data-ttu-id="2cc86-308">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="2cc86-308">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="2cc86-309">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2cc86-309">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="2cc86-310">[上一页](control-id-naming-in-content-pages-vb.md)
> [下一页](interacting-with-the-content-page-from-the-master-page-vb.md)</span><span class="sxs-lookup"><span data-stu-id="2cc86-310">[Previous](control-id-naming-in-content-pages-vb.md)
[Next](interacting-with-the-content-page-from-the-master-page-vb.md)</span></span>
