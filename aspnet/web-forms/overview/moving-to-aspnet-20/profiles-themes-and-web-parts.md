---
uid: web-forms/overview/moving-to-aspnet-20/profiles-themes-and-web-parts
title: 配置文件、主题和 Web 部件 |微软文档
author: rick-anderson
description: ASP.NET 2.0 中的配置和检测发生了重大变化。 新的ASP.NET配置 API 允许进行配置更改。
ms.author: riande
ms.date: 02/20/2005
ms.assetid: 92df4051-77c6-492c-bd34-23d24189cea4
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/profiles-themes-and-web-parts
msc.type: authoredcontent
ms.openlocfilehash: 4bc98cca226a0bd9bd766a21e88b0facf2a4b610
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2020
ms.locfileid: "81543634"
---
# <a name="profiles-themes-and-web-parts"></a>配置文件、主题和 Web 部件

由[微软](https://github.com/microsoft)

> ASP.NET 2.0 中的配置和检测发生了重大变化。 新的ASP.NET配置 API 允许以编程方式进行配置更改。 此外，存在许多新的配置设置允许新的配置和检测。

ASP.NET 2.0 表示个性化网站领域的显著改善。 除了我们已经介绍的成员资格功能外，ASP.NET配置文件、主题和 Web 部件还显著增强了网站的个性化。

## <a name="aspnet-profiles"></a>ASP.NET配置文件

ASP.NET配置文件类似于会话。 区别在于配置文件是永久性的，而当浏览器关闭时会话丢失。 会话和配置文件之间的另一个巨大区别是配置文件类型强，因此在开发过程中为您提供 IntelliSense。

配置文件在计算机配置文件或应用程序的 Web.config 文件中定义。 （您不能在子文件夹 Web.config 文件中定义配置文件。下面的代码定义了一个配置文件来存储网站访问者的名字和姓氏。

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample1.xml)]

配置文件属性的默认数据类型为 System.String。 在上面的示例中，未指定数据类型。 因此，名字和姓氏属性都是字符串类型。 如前所述，配置文件属性是强类型。 下面的代码为 Int32 类型的年龄添加了一个新属性。

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample2.xml)]

配置文件通常与ASP.NET窗体身份验证一起使用。 当与窗体身份验证结合使用时，每个用户都有与其用户 ID 关联的单独配置文件。 但是，还可以允许在匿名应用程序中使用配置文件中的&lt;配置文件，使用配置文件中的匿名标识&gt;元素以及**allowAnonymous**属性，如下所示：

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample3.xml)]

当匿名用户浏览网站时，ASP.NET为用户创建**ProfileCommon**实例。 此配置文件使用存储在浏览器 Cookie 中的唯一 ID 来标识用户为唯一访问者。 通过这种方式，您可以为匿名浏览的用户存储配置文件信息。

## <a name="profile-groups"></a>配置文件组

可以对配置文件的属性进行分组。 通过分组属性，可以模拟特定应用程序的多个配置文件。

以下配置为两个组配置"NameName"和"姓氏"属性;买家和潜在客户。

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample4.xml)]

然后，可以按照如下方式设置特定组的属性：

[!code-csharp[Main](profiles-themes-and-web-parts/samples/sample5.cs)]

## <a name="storing-complex-objects"></a>存储复杂对象

到目前为止，我们介绍的示例已存储在配置文件中的简单数据类型。 还可以通过使用**序列化 As**属性指定序列化方法，将复杂的数据类型存储在配置文件中，如下所示：

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample6.xml)]

在这种情况下，类型是采购发票。 采购发票类需要标记为可序列化，并可以包含任意数量的属性。 例如，如果购买发票具有名为**NumItems购买**的属性，则可以在代码中引用该属性，如下所示：

[!code-css[Main](profiles-themes-and-web-parts/samples/sample7.css)]

## <a name="profile-inheritance"></a>配置文件继承

可以创建用于多个应用程序的配置文件。 通过创建派生自 ProfileBase 的配置文件类，可以使用**继承**属性在多个应用程序中重用配置文件，如下所示：

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample8.xml)]

在这种情况下，类**采购配置文件**如下所示：

[!code-csharp[Main](profiles-themes-and-web-parts/samples/sample9.cs)]

## <a name="profile-providers"></a>配置文件提供程序

ASP.NET配置文件使用提供程序模型。 默认提供程序使用 SqlProfileProvider 提供程序将信息存储在 Web\_应用程序的应用数据文件夹中的 SQL Server Express 数据库中。 如果数据库不存在，ASP.NET将在配置文件尝试存储信息时自动创建它。

但是，在某些情况下，您可能需要开发自己的配置文件提供程序。 ASP.NET配置文件功能使您能够轻松使用不同的提供程序。

在：

- 您需要在数据源（如 FoxPro 数据库或 Oracle 数据库中）存储配置文件信息，而 .NET Framework 中包含的配置文件提供程序不支持这些信息。
- 您需要使用与 .NET 框架中包含的提供程序使用的数据库架构不同的数据库架构来管理配置文件信息。 一个常见示例是，您希望将配置文件信息与现有 SQL Server 数据库中的用户数据集成。

### <a name="required-classes"></a>必填类

要实现配置文件提供程序，请创建继承 System.Web.Profile.Profile.ProfileProvider 抽象类的类。 **配置文件提供程序**抽象类反过来继承 System.配置.settingsProvider 提供程序抽象类，该类继承系统.配置.提供程序.提供程序基础抽象类。 由于此继承链，除了**配置文件提供程序**类的必需成员外，还必须实现**设置提供程序**和**提供程序基础**类所需的成员。

下表描述了必须从**提供程序基础**、**设置提供程序**和**配置文件提供程序**抽象类实现的属性和方法。

### <a name="providerbase-members"></a>提供商基础成员

| **成员** | **说明** |
| --- | --- |
| Initialize 方法 | 将提供程序实例的名称和配置设置的 NameValue 集合作为输入。 用于为提供程序实例设置选项和属性值，包括计算机配置或 Web.config 文件中指定的特定于实现的值和选项。 |

### <a name="settingsprovider-members"></a>设置 提供程序成员

| **成员** | **说明** |
| --- | --- |
| 应用程序名称属性 | 与每个配置文件一起存储的应用程序名称。 配置文件提供程序使用应用程序名称为每个应用程序单独存储配置文件信息。 这样，如果在不同的应用程序中创建相同的用户名，则多个ASP.NET应用程序可以使用相同的数据源，而不会发生冲突。 或者，多个ASP.NET应用程序可以通过指定相同的应用程序名称共享配置文件数据源。 |
| 获取属性值方法 | 将"设置上下文"和"设置属性收集"对象作为输入。 **设置上下文**提供有关用户的信息。 可以使用信息作为主键来检索用户的配置文件属性信息。 使用 **"设置上下文"** 对象获取用户名以及用户是否经过身份验证还是匿名。 **"设置属性集合**"包含设置属性对象的集合。 每个**SettingsProperty**对象都提供属性的名称和类型以及其他信息，例如属性的默认值以及该属性是否为只读。 **GetPropertyValue**方法基于作为输入提供的 **"设置属性"** 对象使用"设置属性值"对象填充"设置属性值集合"。 指定用户的数据源中的值将分配给每个**SettingsPropertyValue**对象的属性值属性，并返回整个集合。 调用 该方法还会将指定用户配置文件的"上次活动日期"值更新为当前日期和时间。 |
| 设置属性值方法 | 将 **"设置上下文"** 和 **"设置属性值收集"** 对象作为输入。 **设置上下文**提供有关用户的信息。 可以使用信息作为主键来检索用户的配置文件属性信息。 使用 **"设置上下文"** 对象获取用户名以及用户是否经过身份验证还是匿名。 **"设置属性值集合**"包含**设置属性值**对象的集合。 每个**SettingsPropertyValue 对象**都提供属性的名称、类型和值以及其他信息，例如属性的默认值以及该属性是否为只读。 **SetPropertyValue**方法更新指定用户的数据源中的配置文件属性值。 调用 该方法还会将指定用户配置文件**的"上次活动日期"** 和"上次更新日期"值更新为当前日期和时间。 |

### <a name="profileprovider-members"></a>配置文件提供商成员

| **成员** | **说明** |
| --- | --- |
| 删除配置文件方法 | 将用户名字符串数组作为输入，并从数据源中删除应用程序名称与**应用程序名称**属性值匹配的指定名称的所有配置文件信息和属性值。 如果数据源支持事务，建议您在事务中包括所有删除操作，并在任何删除操作失败时回滚事务并引发异常。 |
| 删除配置文件方法 | 将 ProfileInfo 对象的集合作为输入，并从数据源中删除应用程序名称与**应用程序名称匹配应用程序名称**属性值的每个配置文件的所有配置文件信息和属性值。 如果数据源支持事务，建议您在事务中包括所有删除操作，并回滚事务，并在任何删除操作失败时引发异常。 |
| 删除非活动配置文件方法 | 将 Profile 身份验证选项值和 DateTime 对象作为输入，并从数据源中删除最后活动日期小于或等于指定日期和时间且应用程序名称与**应用程序名称与应用程序名称**属性值匹配的所有配置文件信息和属性值。 **配置文件身份验证选项**参数指定是否仅删除匿名配置文件、仅身份验证的配置文件或所有配置文件。 如果数据源支持事务，建议您在事务中包括所有删除操作，并回滚事务，并在任何删除操作失败时引发异常。 |
| 获取所有配置文件方法 | 将**配置文件身份验证选项**值、指定页面索引的整数、指定页面大小的整数和将设置为配置文件总计数的整数的引用作为输入。 返回配置文件信息集合，其中包含数据源中所有配置文件的**配置文件，** 其中应用程序名称与**应用程序名称**属性值匹配。 **配置文件身份验证选项**参数指定是否仅返回匿名配置文件、仅身份验证的配置文件或所有配置文件。 **GetAllProfiles**方法返回的结果受页面索引和页面大小值的约束。 页面大小值指定要在**配置文件信息集合**中返回的最大**配置文件信息**对象数。 页面索引值指定要返回的结果页面，其中 1 标识第一页。 总记录的参数是一个 out 参数（您可以在 Visual Basic 中使用**ByRef），** 该参数设置为配置文件的总数。 例如，如果数据存储包含应用程序的 13 个配置文件，并且页面索引值为 2，页面大小为 5，则返回**的 ProfileInfoCollection**包含第六个到第十个配置文件。 当方法返回时，总记录值设置为 13。 |
| 获取所有非活动配置文件方法 | 将**配置文件身份验证选项**值 **、DateTime**对象、指定页面索引的整数、指定页面大小的整数以及将设置为配置文件总计数的整数的引用作为输入。 返回**配置文件信息集合**，其中包含数据源中所有配置文件的**ProfileInfo**对象，其中上次活动日期小于或等于指定的**DateTime，** 并且应用程序名称与**应用程序名称**属性值匹配。 **配置文件身份验证选项**参数指定是否仅返回匿名配置文件、仅身份验证的配置文件或所有配置文件。 **GetAllInactive 配置文件**方法返回的结果受页面索引和页面大小值的约束。 页面大小值指定要在**配置文件信息集合**中返回的最大**配置文件信息**对象数。 页面索引值指定要返回的结果页面，其中 1 标识第一页。 总记录的参数是一个 out 参数（您可以在 Visual Basic 中使用**ByRef），** 该参数设置为配置文件的总数。 例如，如果数据存储包含应用程序的 13 个配置文件，并且页面索引值为 2，页面大小为 5，则返回**的 ProfileInfoCollection**包含第六个到第十个配置文件。 当方法返回时，总记录值设置为 13。 |
| 查找配置文件按用户名方法 | 将 Profile**身份验证选项**值、包含用户名的字符串、指定页面索引的整数、指定页面大小的整数以及将设置为配置文件总计数的整数的引用作为输入。 返回**配置文件信息集合**，其中包含数据源中所有配置文件的**ProfileInfo**对象，其中用户名与指定的用户名匹配，应用程序名称与**应用程序名称**属性值匹配。 **配置文件身份验证选项**参数指定是否仅返回匿名配置文件、仅身份验证的配置文件或所有配置文件。 如果数据源支持其他搜索功能（如通配符），则可以为用户名提供更广泛的搜索功能。 **FindProfilesByUserName**方法返回的结果受页面索引和页面大小值的约束。 页面大小值指定要在**配置文件信息集合**中返回的最大**配置文件信息**对象数。 页面索引值指定要返回的结果页面，其中 1 标识第一页。 总记录的参数是一个 out 参数（您可以在 Visual Basic 中使用**ByRef），** 该参数设置为配置文件的总数。 例如，如果数据存储包含应用程序的 13 个配置文件，并且页面索引值为 2，页面大小为 5，则返回**的 ProfileInfoCollection**包含第六个到第十个配置文件。 当方法返回时，总记录值设置为 13。 |
| 查找非活动配置文件按用户名方法 | 将 Profile**身份验证选项**值、包含用户名的字符串 **、DateTime**对象、指定页面索引的整数、指定页面大小的整数以及对将设置为配置文件总计数的整数的引用作为输入。 返回**配置文件信息集合**，其中包含数据源中所有配置文件的**ProfileInfo**对象，其中用户名与指定的用户名匹配，上次活动日期小于或等于指定的**DateTime**，以及应用程序名称与**应用程序名称**属性值匹配。 **配置文件身份验证选项**参数指定是否仅返回匿名配置文件、仅身份验证的配置文件或所有配置文件。 如果数据源支持其他搜索功能（如通配符），则可以为用户名提供更广泛的搜索功能。 **FindInactive配置文件ByUserName**方法返回的结果受页面索引和页面大小值的约束。 页面大小值指定要在**配置文件信息集合**中返回的最大**配置文件信息**对象数。 页面索引值指定要返回的结果页面，其中 1 标识第一页。 总记录的参数是一个 out 参数（您可以在 Visual Basic 中使用**ByRef），** 该参数设置为配置文件的总数。 例如，如果数据存储包含应用程序的 13 个配置文件，并且页面索引值为 2，页面大小为 5，则返回**的 ProfileInfoCollection**包含第六个到第十个配置文件。 当方法返回时，总记录值设置为 13。 |
| 获取非活动配置文件方法的数量 | 将**配置文件身份验证选项**值和**DateTime**对象作为输入，并返回数据源中所有配置文件的计数，其中上次活动日期小于或等于指定的**DateTime，** 并且应用程序名称与**应用程序名称**属性值匹配。 **配置文件身份验证选项**参数指定是否仅计算匿名配置文件、仅身份验证的配置文件或所有配置文件。 |

### <a name="applicationname"></a>ApplicationName

由于配置文件提供程序为每个应用程序单独存储配置文件信息，因此必须确保数据架构包含应用程序名称，并且查询和更新也包含应用程序名称。 例如，以下命令用于根据用户名和配置文件是否匿名从数据库中检索属性值，并确保**应用程序中名**值包含在查询中。

[!code-sql[Main](profiles-themes-and-web-parts/samples/sample10.sql)]

## <a name="aspnet-themes"></a>ASP.NET主题

## <a name="what-are-aspnet-20-themes"></a>什么是2.0主题ASP.NET？

Web 应用程序最重要的方面之一是整个站点的外观和感觉一致。 ASP.NET 1.x 开发人员通常使用级联样式表 （CSS） 来实现一致的外观。 ASP.NET 2.0 主题在 CSS 上显著提高，因为它们使ASP.NET开发人员能够定义ASP.NET服务器控件和 HTML 元素的外观。 ASP.NET主题可以应用于单个控件、特定网页或整个 Web 应用程序。 如果需要图像，主题使用 CSS 文件、可选外观文件和可选图像目录的组合。 外观文件控制服务器控件ASP.NET的可视外观。

## <a name="where-are-themes-stored"></a>主题存储在哪里？

主题的存储位置因主题的范围而异。 可应用于任何应用程序的主题存储在以下文件夹中：

`C:\WINDOWS\Microsoft.NET\Framework\v2.x.xxxxx\ASP.NETClientFiles\Themes\<Theme_Name>`

特定于特定应用程序的主题存储在`App\_Themes\<Theme\_Name>`网站根目录中。

> [!NOTE]
> 外观文件应仅修改影响外观的服务器控件属性。

全局主题是一个主题，可应用于 Web 服务器上运行的任何应用程序或网站。 默认情况下，这些主题存储在 v2.x.xxxxx 目录内的 ASP.NETClientfile_主题目录中。 或者，您可以将主题文件移动到网站根目录中的 aspnet\_客户端/\_系统 Web/[版本]/主题/[\_主题名称]文件夹中。

特定于应用程序的主题只能应用于文件所在的应用程序。 这些文件存储在`App\_Themes/<theme\_name>`网站根目录中。

## <a name="the-components-of-a-theme"></a>主题的组成部分

主题由一个或多个 CSS 文件、可选外观文件和可选的图像文件夹组成。 CSS 文件可以是您希望的任何名称（即默认.css 或主题.css 等），并且必须位于主题文件夹的根目录中。 CSS 文件用于定义特定选择器的普通 CSS 类和属性。 要将其中一个 CSS 类应用于页面元素，将使用**CSSClass**属性。

外观文件是一个 XML 文件，其中包含ASP.NET服务器控件的属性定义。 下面列出的代码是示例外观文件。

[!code-aspx[Main](profiles-themes-and-web-parts/samples/sample11.aspx)]

**下图 1**显示了浏览的一个小ASP.NET页面，其中没有应用主题。 **图 2**显示了应用主题的同一文件。 背景颜色和文本颜色通过 CSS 文件进行配置。 按钮和文本框的外观使用上面列出的外观文件进行配置。

![无主题](profiles-themes-and-web-parts/_static/image1.gif)

**图 1**： 无主题

![应用主题](profiles-themes-and-web-parts/_static/image2.gif)

**图 2**： 应用的主题

上面列出的外观文件为所有 TextBox 控件和 Button 控件定义了默认外观。 这意味着，插入到页面上的每个 TextBox 控件和按钮控件都将采用此外观。 您还可以使用控件的**SkinID**属性定义可应用于这些控件的特定实例的皮肤。

下面的代码为 Button 控件定义外观。 只有具有**goButton** **SkinID**属性的 Button 控件才会呈现外观。

[!code-aspx[Main](profiles-themes-and-web-parts/samples/sample12.aspx)]

每个服务器控件类型只能有一个默认外观。 如果需要其他外观，则应使用 SkinID 属性。

## <a name="applying-themes-to-pages"></a>将主题应用于页面

可以使用以下任一方法应用主题：

- 在&lt;Web.config 文件的页面&gt;元素中
- 在@Page页面的指令中
- 以编程方式

## <a name="applying-a-theme-in-the-configuration-file"></a>在配置文件中应用主题

要在应用程序配置文件中应用主题，请使用以下语法：

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample13.xml)]

此处指定的主题名称必须与主题文件夹的名称匹配。 此文件夹可以存在于本课程前面提到的任意位置。 如果尝试应用不存在的主题，则会发生配置错误。

## <a name="applying-a-theme-in-the-page-directive"></a>应用页面指令中的主题

您还可以在 @ Page 指令中应用主题。 此方法允许您为特定页面使用主题。

要应用指令中@Page的主题，请使用以下语法：

[!code-aspx[Main](profiles-themes-and-web-parts/samples/sample14.aspx)]

同样，此处指定的主题必须与前面提到的主题文件夹匹配。 如果尝试应用不存在的主题，则会发生生成失败。 Visual Studio 还将突出显示该属性，并通知您不存在此类主题。

## <a name="applying-a-theme-programmatically"></a>以编程方式应用主题

要以编程方式应用主题，必须在 **"页面\_PreInit"** 方法中指定页面**的主题**属性。

要以编程方式应用主题，请使用以下语法：

[!code-csharp[Main](profiles-themes-and-web-parts/samples/sample15.cs)]

由于页面生命周期，有必要在 PreInit 方法中应用主题。 如果在该点之后应用它，则运行时已应用页面主题，并且此时的更改在生命周期中为时已晚。 如果应用不存在的主题，则会发生 **"例外"。** 以编程方式应用主题时，如果任何服务器控件指定了 SkinID 属性，则将发生生成警告。 此警告旨在通知您，没有声明性地应用任何主题，并且可以忽略它。

## <a name="exercise-1--applying-a-theme"></a>练习 1 ： 应用主题

在本练习中，您将对网站应用ASP.NET主题。

> [!IMPORTANT]
> 如果使用 Microsoft Word 在外观文件中输入信息，请确保不会用智能引号替换常规报价。 智能引号会导致皮肤文件出现问题。

1. 创建新的 ASP.NET 网站。
2. 右键单击解决方案资源管理器中的项目，然后选择"添加新项目"。
3. 从文件列表中选择 Web 配置文件，然后单击"添加"。
4. 右键单击解决方案资源管理器中的项目，然后选择"添加新项目"。
5. 选择"皮肤文件"，然后单击"添加"。
6. 当被问及是否希望将文件放在应用\_主题文件夹内时，请单击"是"。
7. 右键单击解决方案资源管理器中应用\_主题文件夹内的 SkinFile 文件夹，然后选择"添加新项目"。
8. 从文件列表中选择"样式表"，然后单击"添加"。 现在，您拥有实现新主题所需的所有文件。 但是，Visual Studio 已命名您的主题文件夹 SkinFile。 右键单击该文件夹并将名称更改为 CoolTheme。
9. 打开 SkinFile.skin 文件，并在文件末尾添加以下代码： 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample16.aspx)]
10. 保存外观文件.皮肤文件。
11. 打开样式表。css.
12. 将其中的所有文本替换为以下内容： 

    [!code-css[Main](profiles-themes-and-web-parts/samples/sample17.css)]
13. 保存样式表.css 文件。
14. 打开默认.aspx 页面。
15. 添加文本框控件和按钮控件。
16. 保存页。 现在浏览默认.aspx 页面。 它应显示为普通 Web 窗体。
17. 打开 Web.config 文件。
18. 在打开`<system.web>`标记的正下方添加以下内容： 

    [!code-xml[Main](profiles-themes-and-web-parts/samples/sample18.xml)]
19. 保存 Web.config 文件。 现在浏览默认.aspx 页面。 它应显示应用的主题。
20. 如果尚未打开，则打开 Visual Studio 中的 Default.aspx 页面。
21. 选择按钮。
22. 将**SkinID**属性更改为"按钮"。 请注意，Visual Studio 提供了一个带有按钮控件有效 SkinID 值的下拉列表。
23. 保存页。 现在再次在浏览器中预览页面。 按钮现在应该说"去"，并且应该在外观上更宽。

使用**SkinID**属性，可以轻松地为特定类型的服务器控件的不同实例配置不同的外观。

## <a name="the-stylesheettheme-property"></a>样式表主题属性

到目前为止，我们只讨论了使用主题属性应用主题。 使用 主题属性时，外观文件将覆盖服务器控件的任何声明性设置。 例如，在练习 1 中，您为 Button 控件指定了"goButton"的 SkinID，并将按钮的文本更改为"go"。 您可能已经注意到，设计器中的 Button 的 Text 属性设置为"按钮"，但主题超过了该属性。 主题将始终覆盖设计器中的任何属性设置。

如果希望能够使用设计器中指定的属性覆盖主题外观文件中定义的属性，则可以使用**StyleSheetTheme**属性而不是主题属性。 StyleSheetTheme 属性与主题属性相同，只不过它不覆盖所有显式属性设置（如主题属性）。

要查看此操作，应打开练习 1 中的项目中的 Web.config 文件，`<pages>`并将该元素更改为以下内容：

[!code-xml[Main](profiles-themes-and-web-parts/samples/sample19.xml)]

现在浏览 Default.aspx 页面，您将看到 Button 控件再次具有"按钮"的文本属性。 这是因为设计器中的显式属性设置重写 goButton SkinID 设置的文本属性。

## <a name="overriding-themes"></a>压倒主题

通过在应用程序的"应用\_主题"文件夹中应用同名主题，可以覆盖全局主题。 但是，主题不会应用于真正的重写方案。 如果运行时遇到应用\_主题文件夹中的主题文件，它将使用这些文件应用主题，并将忽略全局主题。

StyleSheetTheme 属性是可重写的，可以在代码中重写，如下所示：

[!code-csharp[Main](profiles-themes-and-web-parts/samples/sample20.cs)]

## <a name="web-parts"></a>Web 部件

ASP.NET Web 部件是一组集成的控件，用于创建网站，使最终用户能够直接从浏览器修改网页的内容、外观和行为。 修改可以应用于网站上的所有用户或单个用户。 当用户修改页面和控件时，可以保存这些设置，以便在将来的浏览器会话中保留用户的个人首选项，这是一种称为个性化的功能。 这些 Web 部件功能意味着开发人员可以授权最终用户动态个性化 Web 应用程序，而无需开发人员或管理员干预。

使用 Web 部件控件集，作为开发人员，您可以使最终用户能够：

- 个性化页面内容。 用户可以向页面添加新的 Web 部件控件、删除它们、隐藏它们或像普通窗口一样最小化它们。
- 个性化页面布局。 用户可以将 Web 部件控件拖动到页面上的不同区域，或更改其外观、属性和行为。
- 导出和导入控制。 用户可以导入或导出 Web 部件控件设置以用于其他页面或网站，保留控件中的属性、外观甚至数据。 这减少了最终用户的数据输入和配置需求。
- 创建连接。 用户可以在控件之间建立连接，以便图表控件可以在股票代码控件中显示数据的图形。 用户不仅可以个性化连接本身，还可以对图表控件如何显示数据的外观和详细信息进行个性化设置。
- 管理和个性化站点级设置。 授权用户可以配置站点级设置、确定谁可以访问站点或页面、设置基于角色的控件访问等。 例如，管理角色中的用户可以将 Web 部件控件设置为由所有用户共享，并防止非管理员的用户对共享控件进行个性化设置。

通常，您将使用 Web 部件的三种方式之一：创建使用 Web 部件控件的页面、创建单独的 Web 部件控件或创建完整、可个性化的 Web 应用程序（如门户）。

## <a name="page-development"></a>页面开发

页面开发人员可以使用可视化设计工具（如 Microsoft Visual Studio 2005）创建使用 Web 部件的页面。 使用 Visual Studio 等工具的一个优点是，Web 部件控件集提供了用于在可视化设计器中拖放创建和配置 Web 部件控件的功能。 例如，可以使用设计器将 Web 部件区域或 Web 部件编辑器控件拖到设计图面上，然后使用 Web 部件控件集提供的 UI 在设计器中配置控件。 这可以加快 Web 部件应用程序的开发，并减少必须编写的代码量。

## <a name="control-development"></a>控制开发

您可以将任何现有的ASP.NET控件用作 Web 部件控件，包括标准 Web 服务器控件、自定义服务器控件和用户控件。 为了最大限度地编程地控制环境，您还可以创建派生自 WebPart 类的自定义 Web 部件控件。 对于单个 Web 部件控件开发，您通常会创建用户控件并将其用作 Web 部件控件，或者开发自定义 Web 部件控件。

作为开发自定义 Web 部件控件的示例，您可以创建一个控件来提供其他ASP.NET服务器控件提供的任何功能，这些功能可能可用于打包为可个性化 Web 部件控件：日历、列表、财务信息、新闻、计算器、用于更新内容的丰富文本控件、连接到数据库的可编辑网格、动态更新其显示器的图表，或天气和旅行信息。 如果为视觉设计器提供了控件，则使用 Visual Studio 的任何页面开发人员只需将控件拖入 Web 部件区域并在设计时对其进行配置，而无需编写其他代码即可。

个性化是 Web 部件功能的基础。 它使用户能够修改或个性化页面上 Web 部件控件的布局、外观和行为。 个性化设置是长期存在的：它们不仅在当前浏览器会话期间（如视图状态）保留，而且还保存在长期存储中，以便用户的设置也保存为将来的浏览器会话。 默认情况下，为 Web 部件页面启用个性化。

UI 结构组件依赖于个性化，并提供所有 Web 部件控件所需的核心结构和服务。 每个 Web 部件页上都需要一个 UI 结构组件是 WebPartManager 控件。 尽管永远不会可见，但此控件具有协调页面上所有 Web 部件控件的关键任务。 例如，它跟踪所有单独的 Web 部件控件。 它管理 Web 部件区域（在页面上包含 Web 部件控件的区域），以及哪些控件位于哪些区域中。 它还跟踪和控制页面可以采用的不同显示模式，例如浏览、连接、编辑或目录模式，以及个性化更改是否适用于所有用户或单个用户。 最后，它启动和跟踪 Web 部件控件之间的连接和通信。

第二种 UI 结构组件是区域。 区域充当 Web 部件页上的布局管理器。 它们包含并组织派生自 Part 类（零件控件）的控件，并提供以水平或垂直方向执行模块化页面布局的能力。 区域还提供常见和一致的 UI 元素（如标题和页脚样式、标题、边框样式、操作按钮等）以包含每个控件;这些常见元素称为控件的镶边。 在不同的显示模式和各种控件中，使用几种专用类型的区域。 不同类型的区域在下面的"Web 部件基本控制"部分中介绍。

Web 部件 UI 控件（所有这些控件都派生自**部件**类）构成了 Web 部件页上的主 UI。 Web 部件控件集在创建零件控件的选项中具有灵活性和包容性。 除了创建自己的自定义 Web 部件控件外，还可以使用现有的ASP.NET服务器控件、用户控件或自定义服务器控件作为 Web 部件控件。 下一节将介绍最常用于创建 Web 部件页的基本控件。

## <a name="web-parts-essential-controls"></a>Web 部件 基本控制

Web 部件控件集很广泛，但某些控件至关重要，因为它们是 Web 部件工作所必需的，或者因为它们是 Web 部件页面上最常用的控件。 当您开始使用 Web 部件并创建基本的 Web 部件页时，熟悉下表中描述的基本 Web 部件控件会很有帮助。

| **Web 部件控件** | **说明** |
| --- | --- |
| Web部件管理器 | 管理页面上的所有 Web 部件控件。 每个 Web 部件页都需要一个（并且只有一个 **）WebPartManager**控件。 |
| 目录区 | 包含目录部分控件。 使用此区域可以创建 Web 部件控件的目录，用户可以从中选择要添加到页面的控件。 |
| 编辑器区域 | 包含编辑器部分控件。 使用此区域可使用户能够编辑和个性化页面上的 Web 部件控件。 |
| Web部分区域 | 包含并提供有关构成页面主 UI 的 WebPart 控件的总体布局。 每当使用 Web 部件控件创建页面时，都会使用此区域。 页面可以包含一个或多个区域。 |
| 连接区域 | 包含 WebPart 连接控件，并提供用于管理连接的 UI。 |
| Web 部件（通用 Web 部分） | 呈现主 UI;大多数 Web 部件 UI 控件都属于此类别。 为了进行最大的编程控制，您可以创建从基本**WebPart**控件派生的自定义 Web 部件控件。 您还可以使用现有的服务器控件、用户控件或自定义控件作为 Web 部件控件。 每当将其中任何一个控件放置在区域中时 **，WebPartManager**控件会在运行时自动将其与**泛型WebPart**控件进行包装，以便您可以将它们与 Web 部件功能一起使用。 |
| 目录部分 | 包含用户可以添加到页面的可用 Web 部件控件的列表。 |
| Web部分连接 | 在页面上的两个 Web 部件控件之间创建连接。 连接将其中一个 Web 部件控件定义为提供程序（数据），另一个控件定义为使用者。 |
| 编辑器部分 | 用作专用编辑器控件的基类。 |
| 编辑器部分控件（外观编辑器部分、布局编辑器部分、行为编辑器部分和属性网格编辑器部分） | 允许用户在页面上个性化 Web 部件 UI 控件的各个方面 |

## <a name="lab-create-a-web-part-page"></a>实验室：创建网页零件页面

在本实验中，您将创建一个 Web 部件页，该页面将通过ASP.NET配置文件保留信息。

### <a name="creating-a-simple-page-with-web-parts"></a>使用 Web 部件创建简单页面

在本演练的这一部分中，您将创建一个使用 Web 部件控件显示静态内容的页面。 使用 Web 部件的第一步是创建包含两个必需结构元素的页面。 首先，Web 部件页需要 WebPartManager 控件来跟踪和协调所有 Web 部件控件。 其次，Web 部件页需要一个或多个区域，这些区域是包含 WebPart 或其他服务器控件并占用页面指定区域的复合控件。

> [!NOTE]
> 您无需执行任何操作来启用 Web 部件个性化;默认情况下，它为 Web 部件控件集启用。 首次在网站上运行 Web 部件页面时，ASP.NET设置默认个性化提供程序以存储用户个性化设置。 有关个性化的详细信息，请参阅 Web 部件个性化概述。

### <a name="to-create-a-page-for-containing-web-parts-controls"></a>创建用于包含 Web 部件控件的页面

1. 关闭默认页面，向名为 WebPartsDemo.aspx 的网站添加新页面。
2. 切换到 **"设计"** 视图。
3. 在 **"查看"** 菜单中，请确保选择了 **"非可视控件**和**详细信息**"选项，以便可以看到没有 UI 的布局标记和控件。
4. 将插入点放在设计图`<div>`面上的标记之前，然后按 ENTER 添加新行。 将插入点放在新行字符之前，单击菜单上的 **"块格式"** 下拉列表控件，然后选择**标题 1**选项。 在标题中，添加文本**Web 部件演示页**。
5. 从工具箱的**WebParts**选项卡中，将**WebPartManager**控件拖到页面上，将其定位在新行字符之后和`<div>`标记之前。   
  
   **WebPartManager**控件不呈现任何输出，因此它在设计器表面上显示为灰色框。
6. 将插入点放置在标记中`<div>`。
7. 在 **"布局"** 菜单中，单击 **"插入表**"并创建一个包含一行和三列的新表。 单击 **"单元格属性**"按钮，从 **"垂直对齐**下拉列表"中选择**顶部**，单击"**确定**"，然后再次单击 **"确定**"以创建表。
8. 将 WebPartZone 控件拖动到左侧表列中。 右键单击**WebPartZone**控件，选择**属性**，然后设置以下属性：   
  
   ID： 边栏区域   
  
   标题文本：边栏
9. 将第二个**WebPartZone 控件**拖动到中间表列中并设置以下属性：   
  
   ID： 主区域   
  
   标题文本：主
10. 保存文件。

您的页面现在有两个不同的区域，您可以单独控制。 但是，这两个区域都没有任何内容，因此创建内容是下一步。 在本演练中，您可以使用仅显示静态内容的 Web 部件控件。

Web 部件区域的布局由&lt;区域模板&gt;元素指定。 在区域模板中，可以添加任何ASP.NET控件，无论是自定义 Web 部件控件、用户控件还是现有服务器控件。 请注意，此处使用"标签"控件，并且只需添加静态文本即可。 将常规服务器控件放置在**WebPartZone**区域时，ASP.NET在运行时将该控件视为 Web 部件控件，从而在控件上启用 Web 部件功能。

**为主区域创建内容**

1. 在 **"设计"** 视图中，将 **"标签"** 控件从工具箱**的"标准**"选项卡拖动到其**ID**属性设置为 MainZone 的区域的内容区域中。
2. 切换到**源**视图。 请注意，&lt;已添加区域&gt;模板元素以包装 MainZone 中**的标签**控件。
3. 将名为**标题**的属性添加到&lt;asp：label&gt;元素，并将其值设置为"内容"。 从&lt;asp：label&gt;元素中删除 Text="Label"属性。 在&lt;&gt; asp：label 元素的打开和关闭标记之间，在一对&lt;h2&gt;元素标记中添加一些文本，如 **"欢迎到我的主页**"。 您的代码应如下所示。 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample21.aspx)]
4. 保存文件。

接下来，创建一个用户控件，该控件也可以作为 Web 部件控件添加到页面。

### <a name="to-create-a-user-control"></a>创建用户控件

1. 向您的网站添加新的 Web 用户控件以用作搜索控件。 取消选择要**将源代码放在单独的文件中**的选项。 将其添加到与 WebPartsDemo.aspx 页面相同的目录中，并将其命名为"搜索用户控制.ascx"。   
  
    > [!NOTE]
    > 本演练的用户控件不实现实际搜索功能;因此，此演练的用户控件不实现实际搜索功能。它仅用于演示 Web 部件功能。
2. 切换到 **"设计"** 视图。 从工具箱的 **"标准**"选项卡中，将文本框控件拖到页面上。
3. 将插入点放在刚刚添加的文本框后，然后按 ENTER 添加新行。
4. 将"按钮"控件拖到您刚刚添加的文本框下方的新行上的页面上。
5. 切换到**源**视图。 确保用户控件的源代码类似于以下示例。 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample22.aspx)]
6. 保存并关闭该文件。

现在，您可以将 Web 部件控件添加到边栏区域。 您将向边栏区域添加两个控件，一个包含链接列表，另一个控件是您在上一个过程中创建的用户控件。 这些链接添加为标准**Label**服务器控件，类似于为主区域创建静态文本的方式。 但是，尽管用户控件中包含的单个服务器控件可以直接包含在区域中（如标签控件），但在这种情况下，它们不是。 相反，它们是您在上一过程中创建的用户控件的一部分。 这演示了一种常见方法，用于打包用户控件中所需的任何控件和额外功能，然后将区域中的控件引用为 Web 部件控件。

在运行时，Web 部件控件集使用泛型WebPart控件换行两个控件。 当**GenericWebPart**控件包装 Web 服务器控件时，通用部件控件是父控件，您可以通过父控件的子控件属性访问服务器控件。 使用通用部件控件使标准 Web 服务器控件具有与从**WebPart**类派生的 Web 部件控件相同的基本行为和属性。

### <a name="to-add-web-parts-controls-to-the-sidebar-zone"></a>将 Web 部件控件添加到边栏区域

1. 打开 WebPartsDemo.aspx 页面。
2. 切换到 **"设计"** 视图。
3. 将您创建的用户控件页面 SearchUserControl.ascx 从**解决方案资源管理器**拖动到其**ID**属性设置为 SidebarZone 的区域，并将其拖放到该区域。
4. 保存 WebPartsDemo.aspx 页面。
5. 切换到**源**视图。
6. 在侧&lt;边栏区域的 asp：webpartzone&gt;元素（对用户控件的引用正上方）内，&lt;添加包含链接的&gt;asp：label 元素，如以下示例所示。 此外，向用户控件标记添加**Title**属性，其值为 **"搜索**"，如图所示。 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample23.aspx)]
7. 保存并关闭该文件。

现在，您可以通过在浏览器中浏览页面来测试页面。 该页显示两个区域。 下面的屏幕截图显示了页面。

**包含两个区域的 Web 部件演示页面**

![Web 部件 VS 演练 1 屏幕截图](profiles-themes-and-web-parts/_static/image3.gif)

**图 3**： Web 部件 VS 演练 1 屏幕截图

在每个控件的标题栏中，是一个向下箭头，用于访问可在控件上执行的可用操作的谓词菜单。 单击其中一个控件的谓词菜单，然后单击 **"最小化**"谓词并注意该控件最小化。 在谓词菜单中，单击"**还原**"，控件将返回到其正常大小。

### <a name="enabling-users-to-edit-pages-and-change-layout"></a>允许用户编辑页面和更改布局

Web 部件为用户提供了通过将 Web 部件控件从一个区域拖动到另一个区域来更改其布局的功能。 除了允许用户将**WebPart**控件从一个区域移动到另一个区域外，还可以允许用户编辑控件的各种特征，包括其外观、布局和行为。 Web 部件控件集为**WebPart**控件提供了基本编辑功能。 尽管在本演练中不会这样做，但您也可以创建自定义编辑器控件，允许用户编辑**WebPart**控件的功能。 与更改**WebPart**控件的位置一样，编辑控件的属性依赖于ASP.NET个性化来保存用户所做的更改。

在本演练的这一部分中，您可以添加用户编辑页面上任何**WebPart**控件的基本特征的能力。 要启用这些功能，向页面添加另一个自定义用户控件以及 asp：editorzone&lt;&gt;元素和两个编辑控件。

### <a name="to-create-a-user-control-that-enables-changing-page-layout"></a>创建启用更改页面布局的用户控件

1. 在可视化工作室中，在"**文件**"菜单中，选择 **"新建**子菜单"，然后单击"**文件**"选项。
2. 在"**添加新项目"** 对话框中，选择**Web 用户控件**。 命名新文件 DisplayModeMenu.ascx。 取消选择要**将源代码放在单独的文件中**的选项。
3. 单击"添加"以创建新控件。
4. 切换到**源**视图。
5. 删除新文件中的所有现有代码，并粘贴到以下代码中。 此用户控制代码使用 Web 部件控件集的功能，使页面能够更改其视图或显示模式，还使您能够在某些显示模式下更改页面的物理外观和布局。 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample24.aspx)]
6. 通过单击工具栏上的"保存"图标或选择"**在文件**"菜单上**保存**文件来保存文件。

### <a name="to-enable-users-to-change-the-layout"></a>允许用户更改布局

1. 打开 WebPartsDemo.aspx 页面，然后切换到 **"设计"** 视图。
2. 在之前添加的**WebPartManager**控件之后，将插入点放置在 **"设计"** 视图中。 在文本后添加硬返回，以便在**WebPartManager**控件之后有一个空白行。 将插入点放在空白行上。
3. 将您刚刚创建的用户控件（该文件名为 DisplayModeMenu.ascx）拖到 WebPartsDemo.aspx 页面，并将其拖放到空白行上。
4. 将编辑器区域控件从工具箱的**Web 部件**部分拖动到 WebPartsDemo.aspx 页中的剩余打开的表单元格。
5. 从工具箱的**Web 部件**部分，将外观编辑器部分控件和布局编辑器部分控件拖动到**编辑器区域**控件中。
6. 切换到**源**视图。 表单元格中生成的代码应类似于以下代码。 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample25.aspx)]
7. 保存 WebPartsDemo.aspx 文件。 您已创建一个允许用户更改显示模式和更改页面布局的用户控件，并且已引用主 Web 页上的控件。

您现在可以测试编辑页面和更改布局的功能。

### <a name="to-test-layout-changes"></a>测试布局更改

1. 在浏览器中加载页面。
2. 单击 **"显示模式**"下拉菜单，然后选择 **"编辑**"。 将显示区域标题。
3. 按标题栏将 **"我的链接"** 控件从边栏区域拖动到主区域的底部。 您的页面应类似于以下屏幕截图。

### <a name="web-parts-demo-page-with-my-links-control-moved"></a>移动"我的链接"控件的 Web 部件演示页面

![Web 部件 VS 演练 2 屏幕截图](profiles-themes-and-web-parts/_static/image4.gif)

**图 4**： Web 部件 VS 演练 2 屏幕截图

1. 单击 **"显示模式**"下拉菜单，然后选择 **"浏览**"。 页面将刷新，区域名称消失，"**我的链接"** 控件将保留您定位的位置。
2. 要证明个性化功能是否正常工作，关闭浏览器，然后再次加载页面。 您所做的更改将保存为将来的浏览器会话。
3. 在 **"显示模式"** 菜单中，选择 **"编辑**"。   
  
   页面上的每个控件现在在其标题栏中显示一个向下箭头，其中包含谓词下拉菜单。
4. 单击箭头以在"**我的链接"** 控件上显示谓词菜单。 单击 **"编辑"** 谓词。   
  
   将显示 **"编辑器区域**"控件，显示您添加的编辑器部分控件。
5. 在编辑控件的 **"外观"** 部分中，将 **"标题**更改为"我的收藏夹"，使用 **"Chrome 类型**"下拉列表选择 **"仅限标题**"，然后单击"**应用**"。 以下屏幕截图显示页面处于编辑模式。

### <a name="web-parts-demo-page-in-edit-mode"></a>编辑模式下的 Web 部件演示页面

![Web 部件 VS 演练 3 屏幕截图](profiles-themes-and-web-parts/_static/image5.gif)

**图 5**： Web 部件 VS 演练 3 屏幕截图

1. 单击 **"显示模式"** 菜单，然后选择 **"浏览"** 以返回到浏览模式。
2. 控件现在具有更新的标题和没有边框，如下屏幕拍摄所示。

### <a name="edited-web-parts-demo-page"></a>编辑的 Web 部件演示页面

![Web 部件 VS 演练 4 屏幕截图](profiles-themes-and-web-parts/_static/image6.gif)

**图 4**： Web 部件 VS 演练 4 屏幕截图

### <a name="adding-web-parts-at-run-time"></a>在运行时添加 Web 部件

您还可以允许用户在运行时将 Web 部件控件添加到其页面。 为此，请使用 Web 部件目录配置页面，该目录包含要提供给用户的 Web 部件控件的列表。

**允许用户在运行时添加 Web 部件**

1. 打开 WebPartsDemo.aspx 页面，然后切换到 **"设计"** 视图。
2. 从工具箱的**Web 部件**选项卡中，将目录区域控件拖动到"**编辑器区域"** 控件下方的表右列中。   
  
   两个控件可以位于同一表单元格中，因为它们不会同时显示。
3. 在"属性"窗格中，将字符串 **"添加 Web 部件"** 分配给**目录区域**控件的"标题文本"属性。
4. 从工具箱的**Web 部件**部分，将声明目录部分控件拖动到**目录区域**控件的内容区域中。
5. 单击 **"声明目录"** 控件右上角的箭头以公开其任务菜单，然后选择 **"编辑模板**"。
6. 从工具箱**的标准**部分，将**文件上传**控件和**日历**控件拖动到**声明目录部分**的**WebPartsTemplate**部分。
7. 切换到**源**视图。 检查 asp：catalog&lt;区域&gt;元素的源代码。 请注意，**声明目录部分**控件包含一个 Webpartstemplate&lt;&gt;元素，其中包含两个随附的服务器控件，您将能够从目录中添加到页面。
8. 使用下面代码示例中为每个标题显示的字符串值，将**Title**属性添加到添加到目录中的每个控件。 即使标题不是您通常在设计时可以在这两个服务器控件上设置的属性，但当用户在运行时将这些控件从目录添加到**WebPartZone**区域时，它们都用**泛型WebPart**控件进行包装。 这使他们能够充当 Web 部件控件，因此它们将能够显示标题。   
  
   **声明目录Part**控件中包含的两个控件的代码应如下所示。 

    [!code-aspx[Main](profiles-themes-and-web-parts/samples/sample26.aspx)]
9. 保存页。

您现在可以测试目录。

### <a name="to-test-the-web-parts-catalog"></a>测试 Web 部件目录

1. 在浏览器中加载页面。
2. 单击 **"显示模式**"下拉菜单，然后选择 **"目录**"。   
  
   将显示标题为 **"添加 Web 部件"的**目录。
3. 将 **"我的收藏夹"** 控件从主区域拖回边栏区域的顶部，然后将其拖放到该区域的顶部。
4. 在 **"添加 Web 部件**"目录中，选择两个复选框，然后从包含可用区域的下拉列表中选择 **"主"。**
5. 单击"在目录中**添加**"。 控件将添加到主区域。 如果需要，可以将多个控件实例从目录添加到页面。   
  
   以下屏幕截图显示包含文件上载控件的页面和主区域中的日历。 

![从目录添加到主区域的控件](profiles-themes-and-web-parts/_static/image7.gif)

    **Figure 5**: Controls added to Main zone from the catalog
6. 单击 **"显示模式**"下拉菜单，然后选择 **"浏览**"。 目录将消失，页面将刷新。
7. 关闭浏览器。 再次加载页面。 您所做的更改将保持不变。
