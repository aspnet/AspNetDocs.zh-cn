---
uid: web-forms/overview/older-versions-security/roles/creating-and-managing-roles-cs
title: 创建和管理角色（C#） |Microsoft Docs
author: rick-anderson
description: 本教程将探讨配置角色框架所需的步骤。 接下来，我们将构建网页来创建和删除角色。
ms.author: riande
ms.date: 03/24/2008
ms.assetid: 113f10b3-a19a-471b-8ff6-db3c79ce8a91
msc.legacyurl: /web-forms/overview/older-versions-security/roles/creating-and-managing-roles-cs
msc.type: authoredcontent
ms.openlocfilehash: a7883d0b05f2fa5a3fdac887f8c8b39d70418fb3
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78520064"
---
# <a name="creating-and-managing-roles-c"></a><span data-ttu-id="b36a9-104">创建和管理角色 (C#)</span><span class="sxs-lookup"><span data-stu-id="b36a9-104">Creating and Managing Roles (C#)</span></span>

<span data-ttu-id="b36a9-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="b36a9-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="b36a9-106">[下载代码](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/CS.09.zip)或[下载 PDF](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial09_CreatingRoles_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="b36a9-106">[Download Code](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/CS.09.zip) or [Download PDF](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial09_CreatingRoles_cs.pdf)</span></span>

> <span data-ttu-id="b36a9-107">本教程将探讨配置角色框架所需的步骤。</span><span class="sxs-lookup"><span data-stu-id="b36a9-107">This tutorial examines the steps necessary for configuring the Roles framework.</span></span> <span data-ttu-id="b36a9-108">接下来，我们将构建网页来创建和删除角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-108">Following that, we will build web pages to create and delete roles.</span></span>

## <a name="introduction"></a><span data-ttu-id="b36a9-109">简介</span><span class="sxs-lookup"><span data-stu-id="b36a9-109">Introduction</span></span>

<span data-ttu-id="b36a9-110"><a id="_msoanchor_1"></a>在[*基于用户的授权*](../membership/user-based-authorization-cs.md)教程中，我们探讨了如何使用 URL 授权来限制一组页面中的某些用户，并探索了用于根据访问用户调整 ASP.NET 页面功能的声明性和编程技术。</span><span class="sxs-lookup"><span data-stu-id="b36a9-110">In the <a id="_msoanchor_1"></a>[*User-Based Authorization*](../membership/user-based-authorization-cs.md) tutorial we looked at using URL authorization to restrict certain users from a set of pages and explored declarative and programmatic techniques for adjusting an ASP.NET page's functionality based on the visiting user.</span></span> <span data-ttu-id="b36a9-111">但是，授予每个用户的页面访问权限或功能的权限，在存在多个用户帐户或用户的特权经常更改的情况下，这种情况会成为一项维护工作。</span><span class="sxs-lookup"><span data-stu-id="b36a9-111">Granting permission for page access or functionality on a user-by-user basis, however, can become a maintenance nightmare in scenarios where there are many user accounts or when users' privileges change often.</span></span> <span data-ttu-id="b36a9-112">用户任何时候获得或失去执行特定任务的授权时，管理员都需要更新相应的 URL 授权规则、声明性标记和代码。</span><span class="sxs-lookup"><span data-stu-id="b36a9-112">Any time a user gains or loses authorization to perform a particular task, the administrator needs to update the appropriate URL authorization rules, declarative markup, and code.</span></span>

<span data-ttu-id="b36a9-113">它通常有助于将用户划分到组或*角色*中，然后对角色按角色应用权限。</span><span class="sxs-lookup"><span data-stu-id="b36a9-113">It usually helps to classify users into groups or *roles* and then to apply permissions on a role-by-role basis.</span></span> <span data-ttu-id="b36a9-114">例如，大多数 web 应用程序都有一组特定的页面或任务，它们只为管理用户预留。</span><span class="sxs-lookup"><span data-stu-id="b36a9-114">For example, most web applications have a certain set of pages or tasks that are reserved only for administrative users.</span></span> <span data-ttu-id="b36a9-115">使用*基于用户的授权*教程中学习的技术，我们将添加相应的 URL 授权规则、声明性标记和代码，以允许指定的用户帐户执行管理任务。</span><span class="sxs-lookup"><span data-stu-id="b36a9-115">Using the techniques learned in the *User-Based Authorization* tutorial, we would add the appropriate URL authorization rules, declarative markup, and code to allow the specified user accounts to perform administrative tasks.</span></span> <span data-ttu-id="b36a9-116">但是，如果添加了新的管理员，或者如果现有管理员已撤消管理权限，则必须返回并更新配置文件和网页。</span><span class="sxs-lookup"><span data-stu-id="b36a9-116">But if a new administrator was added or if an existing administrator needed to have her administration rights revoked, we would have to return and update the configuration files and web pages.</span></span> <span data-ttu-id="b36a9-117">然而，使用角色，我们可以创建一个名为 "管理员" 的角色，并将这些受信任的用户分配给 "管理员" 角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-117">With roles, however, we could create a role called Administrators and assign those trusted users to the Administrators role.</span></span> <span data-ttu-id="b36a9-118">接下来，我们将添加相应的 URL 授权规则、声明性标记和代码，以允许管理员角色执行各种管理任务。</span><span class="sxs-lookup"><span data-stu-id="b36a9-118">Next, we would add the appropriate URL authorization rules, declarative markup, and code to allow the Administrators role to perform the various administrative tasks.</span></span> <span data-ttu-id="b36a9-119">此基础结构准备就绪后，将新管理员添加到该站点或删除现有管理员非常简单，只需要从管理员角色中包括或删除用户即可。</span><span class="sxs-lookup"><span data-stu-id="b36a9-119">With this infrastructure in place, adding new administrators to the site or removing existing ones is as simple as including or removing the user from the Administrators role.</span></span> <span data-ttu-id="b36a9-120">无需进行配置、声明性标记或代码更改。</span><span class="sxs-lookup"><span data-stu-id="b36a9-120">No configuration, declarative markup, or code changes are necessary.</span></span>

<span data-ttu-id="b36a9-121">ASP.NET 提供角色框架，用于定义角色并将其与用户帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="b36a9-121">ASP.NET offers a Roles framework for defining roles and associating them with user accounts.</span></span> <span data-ttu-id="b36a9-122">使用角色框架，我们可以创建和删除角色，向角色添加用户或从中删除用户，确定属于特定角色的用户组，并判断用户是否属于特定角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-122">With the Roles framework we can create and delete roles, add users to or remove users from a role, determine the set of users that belong to a particular role, and tell whether a user belongs to a particular role.</span></span> <span data-ttu-id="b36a9-123">配置角色框架后，我们可以通过 URL 授权规则限制每个角色对页面的访问，并基于当前登录用户的角色在页面上显示或隐藏其他信息或功能。</span><span class="sxs-lookup"><span data-stu-id="b36a9-123">Once the Roles framework has been configured, we can limit access to pages on a role-by-role basis through URL authorization rules and show or hide additional information or functionality on a page based on the currently logged on user's roles.</span></span>

<span data-ttu-id="b36a9-124">本教程将探讨配置角色框架所需的步骤。</span><span class="sxs-lookup"><span data-stu-id="b36a9-124">This tutorial examines the steps necessary for configuring the Roles framework.</span></span> <span data-ttu-id="b36a9-125">接下来，我们将构建网页来创建和删除角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-125">Following that, we will build web pages to create and delete roles.</span></span> <span data-ttu-id="b36a9-126">在将<a id="_msoanchor_2"> </a>[*角色分配给用户*](assigning-roles-to-users-cs.md)教程中，我们将介绍如何在角色中添加和删除用户。</span><span class="sxs-lookup"><span data-stu-id="b36a9-126">In the <a id="_msoanchor_2"></a>[*Assigning Roles to Users*](assigning-roles-to-users-cs.md) tutorial we will look at how to add and remove users from roles.</span></span> <span data-ttu-id="b36a9-127">在<a id="_msoanchor_3"> </a>[*基于角色的授权*](role-based-authorization-cs.md)教程中，我们将了解如何按角色限制对页面的访问，以及如何根据访问用户的角色调整页面功能。</span><span class="sxs-lookup"><span data-stu-id="b36a9-127">And in the <a id="_msoanchor_3"></a>[*Role-Based Authorization*](role-based-authorization-cs.md) tutorial we will see how to limit access to pages on a role-by-role basis along with how to adjust page functionality depending on the visiting user's role.</span></span> <span data-ttu-id="b36a9-128">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="b36a9-128">Let's get started!</span></span>

## <a name="step-1-adding-new-aspnet-pages"></a><span data-ttu-id="b36a9-129">步骤1：添加新的 ASP.NET 页面</span><span class="sxs-lookup"><span data-stu-id="b36a9-129">Step 1: Adding New ASP.NET Pages</span></span>

<span data-ttu-id="b36a9-130">在本教程和接下来的两个教程中，我们将检查各种与角色相关的函数和功能。</span><span class="sxs-lookup"><span data-stu-id="b36a9-130">In this tutorial and the next two we will be examining various roles-related functions and capabilities.</span></span> <span data-ttu-id="b36a9-131">我们将需要一系列 ASP.NET 页面来实现这些教程中所讨论的主题。</span><span class="sxs-lookup"><span data-stu-id="b36a9-131">We will need a series of ASP.NET pages to implement the topics examined throughout these tutorials.</span></span> <span data-ttu-id="b36a9-132">让我们创建这些页面并更新站点图。</span><span class="sxs-lookup"><span data-stu-id="b36a9-132">Let's create these pages and update the site map.</span></span>

<span data-ttu-id="b36a9-133">首先，在项目中创建一个名为 `Roles`的新文件夹。</span><span class="sxs-lookup"><span data-stu-id="b36a9-133">Start by creating a new folder in the project named `Roles`.</span></span> <span data-ttu-id="b36a9-134">接下来，将四个新的 ASP.NET 页面添加到 `Roles` 文件夹，将每个页面与 `Site.master` 的母版页链接。</span><span class="sxs-lookup"><span data-stu-id="b36a9-134">Next, add four new ASP.NET pages to the `Roles` folder, linking each page with the `Site.master` master page.</span></span> <span data-ttu-id="b36a9-135">命名页面：</span><span class="sxs-lookup"><span data-stu-id="b36a9-135">Name the pages:</span></span>

- `ManageRoles.aspx`
- `UsersAndRoles.aspx`
- `CreateUserWizardWithRoles.aspx`
- `RoleBasedAuthorization.aspx`

<span data-ttu-id="b36a9-136">此时，项目的解决方案资源管理器应类似于图1所示的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="b36a9-136">At this point your project's Solution Explorer should look similar to the screen shot shown in Figure 1.</span></span>

<span data-ttu-id="b36a9-137">[已将四个新页面添加到 "角色" 文件夹中 ![](creating-and-managing-roles-cs/_static/image2.png)](creating-and-managing-roles-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-137">[![Four New Pages Have Been Added to the Roles Folder](creating-and-managing-roles-cs/_static/image2.png)](creating-and-managing-roles-cs/_static/image1.png)</span></span>

<span data-ttu-id="b36a9-138">**图 1**：已将四个新页面添加到 `Roles` 文件夹（[单击查看完全大小的图像](creating-and-managing-roles-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-138">**Figure 1**: Four New Pages Have Been Added to the `Roles` Folder  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image3.png))</span></span>

<span data-ttu-id="b36a9-139">此时，每个页面都应具有两个内容控件，一个用于母版页的每个 Contentplaceholder： `MainContent` 和 `LoginContent`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-139">Each page should, at this point, have the two Content controls, one for each of the master page's ContentPlaceHolders: `MainContent` and `LoginContent`.</span></span>

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample1.aspx)]

<span data-ttu-id="b36a9-140">请记住，`LoginContent` ContentPlaceHolder 的默认标记会显示一个用于登录或注销站点的链接，具体取决于是否对用户进行了身份验证。</span><span class="sxs-lookup"><span data-stu-id="b36a9-140">Recall that the `LoginContent` ContentPlaceHolder's default markup displays a link to log on or log off the site, depending on whether the user is authenticated.</span></span> <span data-ttu-id="b36a9-141">但在 ASP.NET 页中存在 `Content2` 内容控件，但会重写母版页的默认标记。</span><span class="sxs-lookup"><span data-stu-id="b36a9-141">The presence of the `Content2` Content control in the ASP.NET page, however, overrides the master page's default markup.</span></span> <span data-ttu-id="b36a9-142">如我们在<a id="_msoanchor_4"> </a> [*Forms 身份验证概述*](../introduction/an-overview-of-forms-authentication-cs.md)教程中所述，替代默认标记对于我们不想在左列中显示与登录相关的选项的页面非常有用。</span><span class="sxs-lookup"><span data-stu-id="b36a9-142">As we discussed in <a id="_msoanchor_4"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, overriding the default markup is useful in pages where we do not want to display login-related options in the left column.</span></span>

<span data-ttu-id="b36a9-143">但对于这四个页面，我们想要为 `LoginContent` ContentPlaceHolder 显示母版页的默认标记。</span><span class="sxs-lookup"><span data-stu-id="b36a9-143">For these four pages, however, we want to show the master page's default markup for the `LoginContent` ContentPlaceHolder.</span></span> <span data-ttu-id="b36a9-144">因此，删除 `Content2` 内容控件的声明性标记。</span><span class="sxs-lookup"><span data-stu-id="b36a9-144">Therefore, remove the declarative markup for the `Content2` Content control.</span></span> <span data-ttu-id="b36a9-145">完成此操作后，四个页面的标记中的每一个都应该只包含一个内容控件。</span><span class="sxs-lookup"><span data-stu-id="b36a9-145">After doing so, each of the four page's markup should contain just one Content control.</span></span>

<span data-ttu-id="b36a9-146">最后，让我们更新网站图（`Web.sitemap`）以包含这些新网页。</span><span class="sxs-lookup"><span data-stu-id="b36a9-146">Finally, let's update the site map (`Web.sitemap`) to include these new web pages.</span></span> <span data-ttu-id="b36a9-147">在为成员资格教程添加的 `<siteMapNode>` 后面添加以下 XML。</span><span class="sxs-lookup"><span data-stu-id="b36a9-147">Add the following XML after the `<siteMapNode>` we added for the Membership tutorials.</span></span>

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample2.xml)]

<span data-ttu-id="b36a9-148">更新站点地图后，通过浏览器访问站点。</span><span class="sxs-lookup"><span data-stu-id="b36a9-148">With the site map updated, visit the site through a browser.</span></span> <span data-ttu-id="b36a9-149">如图2所示，左侧的导航包含角色教程中的项。</span><span class="sxs-lookup"><span data-stu-id="b36a9-149">As Figure 2 shows, the navigation on the left now includes items for the Roles tutorials.</span></span>

<span data-ttu-id="b36a9-150">[已将四个新页面添加到 "角色" 文件夹中 ![](creating-and-managing-roles-cs/_static/image5.png)](creating-and-managing-roles-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-150">[![Four New Pages Have Been Added to the Roles Folder](creating-and-managing-roles-cs/_static/image5.png)](creating-and-managing-roles-cs/_static/image4.png)</span></span>

<span data-ttu-id="b36a9-151">**图 2**：已将四个新页面添加到 `Roles` 文件夹（[单击查看完全大小的图像](creating-and-managing-roles-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-151">**Figure 2**: Four New Pages Have Been Added to the `Roles` Folder  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image6.png))</span></span>

## <a name="step-2-specifying-and-configuring-the-roles-framework-provider"></a><span data-ttu-id="b36a9-152">步骤2：指定和配置角色框架提供程序</span><span class="sxs-lookup"><span data-stu-id="b36a9-152">Step 2: Specifying and Configuring the Roles Framework Provider</span></span>

<span data-ttu-id="b36a9-153">与成员身份框架一样，角色框架是在提供程序模型的顶层生成的。</span><span class="sxs-lookup"><span data-stu-id="b36a9-153">Like the Membership framework, the Roles framework is built atop the provider model.</span></span> <span data-ttu-id="b36a9-154">如<a id="_msoanchor_5"> </a>[*安全基础知识和 ASP.NET 支持*](../introduction/security-basics-and-asp-net-support-cs.md)教程中所述，.NET Framework 附带了三个内置角色提供商： [`AuthorizationStoreRoleProvider`](https://msdn.microsoft.com/library/system.web.security.authorizationstoreroleprovider.aspx)、 [`WindowsTokenRoleProvider`](https://msdn.microsoft.com/library/system.web.security.windowstokenroleprovider.aspx)和[`SqlRoleProvider`](https://msdn.microsoft.com/library/system.web.security.sqlroleprovider.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b36a9-154">As discussed in the <a id="_msoanchor_5"></a>[*Security Basics and ASP.NET Support*](../introduction/security-basics-and-asp-net-support-cs.md) tutorial, the .NET Framework ships with three built-in Roles providers: [`AuthorizationStoreRoleProvider`](https://msdn.microsoft.com/library/system.web.security.authorizationstoreroleprovider.aspx), [`WindowsTokenRoleProvider`](https://msdn.microsoft.com/library/system.web.security.windowstokenroleprovider.aspx), and [`SqlRoleProvider`](https://msdn.microsoft.com/library/system.web.security.sqlroleprovider.aspx).</span></span> <span data-ttu-id="b36a9-155">本教程系列重点介绍 `SqlRoleProvider`，它使用 Microsoft SQL Server 数据库作为角色存储。</span><span class="sxs-lookup"><span data-stu-id="b36a9-155">This tutorial series focuses on the `SqlRoleProvider`, which uses a Microsoft SQL Server database as the role store.</span></span>

<span data-ttu-id="b36a9-156">下面的内容涵盖角色框架和 `SqlRoleProvider` 工作，就像成员身份框架和 `SqlMembershipProvider`一样。</span><span class="sxs-lookup"><span data-stu-id="b36a9-156">Underneath the covers the Roles framework and `SqlRoleProvider` work just like the Membership framework and `SqlMembershipProvider`.</span></span> <span data-ttu-id="b36a9-157">.NET Framework 包含一个 `Roles` 类，该类充当角色框架的 API。</span><span class="sxs-lookup"><span data-stu-id="b36a9-157">The .NET Framework contains a `Roles` class that serves as the API to the Roles framework.</span></span> <span data-ttu-id="b36a9-158">`Roles` 类具有静态方法，如 `CreateRole`、`DeleteRole`、`GetAllRoles`、`AddUserToRole`、`IsUserInRole`等。</span><span class="sxs-lookup"><span data-stu-id="b36a9-158">The `Roles` class has static methods like `CreateRole`, `DeleteRole`, `GetAllRoles`, `AddUserToRole`, `IsUserInRole`, and so forth.</span></span> <span data-ttu-id="b36a9-159">当调用其中一种方法时，`Roles` 类会将调用委托给已配置的提供程序。</span><span class="sxs-lookup"><span data-stu-id="b36a9-159">When one of these methods is invoked, the `Roles` class delegates the call to the configured provider.</span></span> <span data-ttu-id="b36a9-160">`SqlRoleProvider` 与特定于角色的表（`aspnet_Roles` 和 `aspnet_UsersInRoles`）一起使用以响应。</span><span class="sxs-lookup"><span data-stu-id="b36a9-160">The `SqlRoleProvider` works with the role-specific tables (`aspnet_Roles` and `aspnet_UsersInRoles`) in response.</span></span>

<span data-ttu-id="b36a9-161">若要在应用程序中使用 `SqlRoleProvider` 提供程序，需要指定要用作存储的数据库。</span><span class="sxs-lookup"><span data-stu-id="b36a9-161">In order to use the `SqlRoleProvider` provider in our application, we need to specify what database to use as the store.</span></span> <span data-ttu-id="b36a9-162">`SqlRoleProvider` 要求指定的角色存储具有某些数据库表、视图和存储过程。</span><span class="sxs-lookup"><span data-stu-id="b36a9-162">The `SqlRoleProvider` expects the specified role store to have certain database tables, views, and stored procedures.</span></span> <span data-ttu-id="b36a9-163">可以使用[`aspnet_regsql.exe` 工具](https://msdn.microsoft.com/library/ms229862.aspx)添加这些必需的数据库对象。</span><span class="sxs-lookup"><span data-stu-id="b36a9-163">These requisite database objects can be added using the [`aspnet_regsql.exe` tool](https://msdn.microsoft.com/library/ms229862.aspx).</span></span> <span data-ttu-id="b36a9-164">此时，我们已经有了一个数据库，其中包含 `SqlRoleProvider`所需的架构。</span><span class="sxs-lookup"><span data-stu-id="b36a9-164">At this point we already have a database with the schema necessary for the `SqlRoleProvider`.</span></span> <span data-ttu-id="b36a9-165"><a id="_msoanchor_6"></a>返回 SQL Server 教程创建[*成员身份架构*](../membership/creating-the-membership-schema-in-sql-server-cs.md)中创建一个名为 `SecurityTutorials.mdf` 的数据库，并使用 `aspnet_regsql.exe` 添加应用程序服务，其中包括 `SqlRoleProvider`所需的数据库对象。</span><span class="sxs-lookup"><span data-stu-id="b36a9-165">Back in the <a id="_msoanchor_6"></a>[*Creating the Membership Schema in SQL Server*](../membership/creating-the-membership-schema-in-sql-server-cs.md) tutorial we created a database named `SecurityTutorials.mdf` and used `aspnet_regsql.exe` to add the application services, which included the database objects required by the `SqlRoleProvider`.</span></span> <span data-ttu-id="b36a9-166">因此，只需告诉角色框架启用角色支持并将 `SqlRoleProvider` 与 `SecurityTutorials.mdf` 数据库作为角色存储。</span><span class="sxs-lookup"><span data-stu-id="b36a9-166">Therefore we just need to tell the Roles framework to enable role support and to use the `SqlRoleProvider` with the `SecurityTutorials.mdf` database as the role store.</span></span>

<span data-ttu-id="b36a9-167">角色框架是通过应用程序 `Web.config` 文件中的 &lt;`roleManager`&gt; 元素配置的。</span><span class="sxs-lookup"><span data-stu-id="b36a9-167">The Roles framework is configured via the &lt;`roleManager`&gt; element in the application's `Web.config` file.</span></span> <span data-ttu-id="b36a9-168">默认情况下，禁用角色支持。</span><span class="sxs-lookup"><span data-stu-id="b36a9-168">By default, role support is disabled.</span></span> <span data-ttu-id="b36a9-169">若要启用它，必须将[&lt;`roleManager`&gt;](https://msdn.microsoft.com/library/ms164660.aspx)元素的 `enabled` 特性设置为，`true` 如下所示：</span><span class="sxs-lookup"><span data-stu-id="b36a9-169">To enable it, you must set the [&lt;`roleManager`&gt;](https://msdn.microsoft.com/library/ms164660.aspx) element's `enabled` attribute to `true` like so:</span></span>

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample3.xml)]

<span data-ttu-id="b36a9-170">默认情况下，所有 web 应用程序都有一个名为 `AspNetSqlRoleProvider` 类型 `SqlRoleProvider`的角色提供程序。</span><span class="sxs-lookup"><span data-stu-id="b36a9-170">By default, all web applications have a Roles provider named `AspNetSqlRoleProvider` of type `SqlRoleProvider`.</span></span> <span data-ttu-id="b36a9-171">此默认提供程序在 `machine.config` 中注册（位于 `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG`）：</span><span class="sxs-lookup"><span data-stu-id="b36a9-171">This default provider is registered in `machine.config` (located at `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG`):</span></span>

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample4.xml)]

<span data-ttu-id="b36a9-172">提供程序的 `connectionStringName` 属性指定使用的角色存储区。</span><span class="sxs-lookup"><span data-stu-id="b36a9-172">The provider's `connectionStringName` attribute specifies the role store that is used.</span></span> <span data-ttu-id="b36a9-173">`AspNetSqlRoleProvider` 提供程序将此属性设置为 `LocalSqlServer`，默认情况下，它也在 `machine.config` 和点中定义为名为 `App_Data` `aspnet.mdf`文件夹中的 SQL Server 2005 Express Edition 数据库。</span><span class="sxs-lookup"><span data-stu-id="b36a9-173">The `AspNetSqlRoleProvider` provider sets this attribute to `LocalSqlServer`, which is also defined in `machine.config` and points, by default, to a SQL Server 2005 Express Edition database in the `App_Data` folder named `aspnet.mdf`.</span></span>

<span data-ttu-id="b36a9-174">因此，如果只是启用角色框架而不在应用程序的 `Web.config` 文件中指定任何提供程序信息，则应用程序将使用默认注册的角色提供程序，`AspNetSqlRoleProvider`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-174">Consequently, if we simply enable the Roles framework without specifying any provider information in our application's `Web.config` file, the application uses the default registered Roles provider, `AspNetSqlRoleProvider`.</span></span> <span data-ttu-id="b36a9-175">如果 `~/App_Data/aspnet.mdf` 数据库不存在，ASP.NET 运行时将自动创建它并添加应用程序服务架构。</span><span class="sxs-lookup"><span data-stu-id="b36a9-175">If the `~/App_Data/aspnet.mdf` database does not exist, the ASP.NET runtime will automatically create it and add the application services schema.</span></span> <span data-ttu-id="b36a9-176">但是，我们不想使用 `aspnet.mdf` 数据库;相反，我们想要使用已创建的 `SecurityTutorials.mdf` 数据库，并将应用程序服务架构添加到。</span><span class="sxs-lookup"><span data-stu-id="b36a9-176">However, we don't want to use the `aspnet.mdf` database; rather, we want to use the `SecurityTutorials.mdf` database that we have already created and added the application services schema to.</span></span> <span data-ttu-id="b36a9-177">可以通过以下两种方式之一完成此修改：</span><span class="sxs-lookup"><span data-stu-id="b36a9-177">This modification can be accomplished in one of two ways:</span></span>

- <span data-ttu-id="b36a9-178">为<strong>`Web.config`</strong>中<strong>`LocalSqlServer`</strong><strong>连接字符串名称</strong><strong>指定值</strong> <strong>。</strong></span><span class="sxs-lookup"><span data-stu-id="b36a9-178"><strong>Specify a value for the</strong><strong>`LocalSqlServer`</strong><strong>connection string name in</strong><strong>`Web.config`</strong><strong>.</strong></span></span> <span data-ttu-id="b36a9-179">通过覆盖 `Web.config`中的 `LocalSqlServer` 连接字符串名称值，我们可以使用默认的已注册角色提供程序（`AspNetSqlRoleProvider`）并使其与 `SecurityTutorials.mdf` 数据库一起正确使用。</span><span class="sxs-lookup"><span data-stu-id="b36a9-179">By overwriting the `LocalSqlServer` connection string name value in `Web.config`, we can use the default registered Roles provider (`AspNetSqlRoleProvider`) and have it correctly work with the `SecurityTutorials.mdf` database.</span></span> <span data-ttu-id="b36a9-180">有关此技术的详细信息，请参阅[Scott Guthrie](https://weblogs.asp.net/scottgu/)的博客文章将[ASP.NET 2.0 应用程序服务配置为使用 SQL Server 2000 或 SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b36a9-180">For more information on this technique, see [Scott Guthrie](https://weblogs.asp.net/scottgu/)'s blog post, [Configuring ASP.NET 2.0 Application Services to Use SQL Server 2000 or SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx).</span></span>
- <span data-ttu-id="b36a9-181"><strong>添加`SqlRoleProvider`类型的新注册的提供程序</strong> <strong>，并将其</strong><strong>`connectionStringName`</strong><strong>设置配置为指向</strong><strong>`SecurityTutorials.mdf`</strong><strong>数据库。</strong></span><span class="sxs-lookup"><span data-stu-id="b36a9-181"><strong>Add a new registered provider of type</strong><strong>`SqlRoleProvider`</strong><strong>and configure its</strong><strong>`connectionStringName`</strong><strong>setting to point to the</strong><strong>`SecurityTutorials.mdf`</strong><strong>database.</strong></span></span> <span data-ttu-id="b36a9-182">这是我在<a id="_msoanchor_7"> </a> [*SQL Server 教程中创建成员身份架构*](../membership/creating-the-membership-schema-in-sql-server-cs.md)时建议和使用的方法，也是我将在本教程中使用的方法。</span><span class="sxs-lookup"><span data-stu-id="b36a9-182">This is the approach I recommended and used in the <a id="_msoanchor_7"></a>[*Creating the Membership Schema in SQL Server*](../membership/creating-the-membership-schema-in-sql-server-cs.md) tutorial, and it is the approach I will use in this tutorial as well.</span></span>

<span data-ttu-id="b36a9-183">将以下角色配置标记添加到 `Web.config` 文件中。</span><span class="sxs-lookup"><span data-stu-id="b36a9-183">Add the following Roles configuration markup to the `Web.config` file.</span></span> <span data-ttu-id="b36a9-184">此标记将注册一个名为 `SecurityTutorialsSqlRoleProvider`的新提供程序。</span><span class="sxs-lookup"><span data-stu-id="b36a9-184">This markup registers a new provider named `SecurityTutorialsSqlRoleProvider`.</span></span>

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample5.xml)]

<span data-ttu-id="b36a9-185">上面的标记将 `SecurityTutorialsSqlRoleProvider` 定义为默认提供程序（通过 `<roleManager>` 元素中的 `defaultProvider` 特性）。</span><span class="sxs-lookup"><span data-stu-id="b36a9-185">The above markup defines the `SecurityTutorialsSqlRoleProvider` as the default provider (via the `defaultProvider` attribute in the `<roleManager>` element).</span></span> <span data-ttu-id="b36a9-186">它还将 `SecurityTutorialsSqlRoleProvider`的 `applicationName` 设置设置为 `SecurityTutorials`，这与成员资格提供程序（`SecurityTutorialsSqlMembershipProvider`）使用的 `applicationName` 设置相同。</span><span class="sxs-lookup"><span data-stu-id="b36a9-186">It also sets the `SecurityTutorialsSqlRoleProvider`'s `applicationName` setting to `SecurityTutorials`, which is the same `applicationName` setting used by the Membership provider (`SecurityTutorialsSqlMembershipProvider`).</span></span> <span data-ttu-id="b36a9-187">尽管此处未显示，但 `SqlRoleProvider` 的[`<add>` 元素](https://msdn.microsoft.com/library/ms164662.aspx)还可能包含一个 `commandTimeout` 属性，用于指定数据库超时持续时间（以秒为单位）。</span><span class="sxs-lookup"><span data-stu-id="b36a9-187">While not shown here, the [`<add>` element](https://msdn.microsoft.com/library/ms164662.aspx) for the `SqlRoleProvider` may also contain a `commandTimeout` attribute to specify the database timeout duration, in seconds.</span></span> <span data-ttu-id="b36a9-188">默认值为 30。</span><span class="sxs-lookup"><span data-stu-id="b36a9-188">The default value is 30.</span></span>

<span data-ttu-id="b36a9-189">使用此配置标记后，便可以开始在应用程序中使用角色功能。</span><span class="sxs-lookup"><span data-stu-id="b36a9-189">With this configuration markup in place, we are ready to start using role functionality within our application.</span></span>

> [!NOTE]
> <span data-ttu-id="b36a9-190">上述配置标记说明了如何使用 &lt;`roleManager`&gt; 元素的 `enabled` 和 `defaultProvider` 特性。</span><span class="sxs-lookup"><span data-stu-id="b36a9-190">The above configuration markup illustrates using the &lt;`roleManager`&gt; element's `enabled` and `defaultProvider` attributes.</span></span> <span data-ttu-id="b36a9-191">还有多个其他属性会影响角色框架如何按用户关联角色信息。</span><span class="sxs-lookup"><span data-stu-id="b36a9-191">There are a number of other attributes that affect how the Roles framework associates role information on a user-by-user basis.</span></span> <span data-ttu-id="b36a9-192">我们会在<a id="_msoanchor_8"> </a>[*基于角色的授权*](role-based-authorization-cs.md)教程中检查这些设置。</span><span class="sxs-lookup"><span data-stu-id="b36a9-192">We will examine these settings in the <a id="_msoanchor_8"></a>[*Role-Based Authorization*](role-based-authorization-cs.md) tutorial.</span></span>

## <a name="step-3-examining-the-roles-api"></a><span data-ttu-id="b36a9-193">步骤3：检查角色 API</span><span class="sxs-lookup"><span data-stu-id="b36a9-193">Step 3: Examining the Roles API</span></span>

<span data-ttu-id="b36a9-194">Role framework 的功能通过[`Roles` 类](https://msdn.microsoft.com/library/system.web.security.roles.aspx)公开，该类包含用于执行基于角色的操作的十三个静态方法。</span><span class="sxs-lookup"><span data-stu-id="b36a9-194">The Roles framework's functionality is exposed via the [`Roles` class](https://msdn.microsoft.com/library/system.web.security.roles.aspx), which contains thirteen static methods for performing role-based operations.</span></span> <span data-ttu-id="b36a9-195">在步骤4和6中查看创建和删除角色时，将使用[`CreateRole`](https://msdn.microsoft.com/library/system.web.security.roles.createrole.aspx)和[`DeleteRole`](https://msdn.microsoft.com/library/system.web.security.roles.deleterole.aspx)方法，这些方法可在系统中添加或删除角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-195">When we look at creating and deleting roles in Steps 4 and 6 we will use the [`CreateRole`](https://msdn.microsoft.com/library/system.web.security.roles.createrole.aspx) and [`DeleteRole`](https://msdn.microsoft.com/library/system.web.security.roles.deleterole.aspx) methods, which add or remove a role from the system.</span></span>

<span data-ttu-id="b36a9-196">若要获取系统中所有角色的列表，请使用[`GetAllRoles` 方法](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx)（请参阅步骤5）。</span><span class="sxs-lookup"><span data-stu-id="b36a9-196">To get a list of all of the roles in the system, use the [`GetAllRoles` method](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx) (see Step 5).</span></span> <span data-ttu-id="b36a9-197">[`RoleExists` 方法](https://msdn.microsoft.com/library/system.web.security.roles.roleexists.aspx)返回一个布尔值，该值指示指定的角色是否存在。</span><span class="sxs-lookup"><span data-stu-id="b36a9-197">The [`RoleExists` method](https://msdn.microsoft.com/library/system.web.security.roles.roleexists.aspx) returns a Boolean value indicating whether a specified role exists.</span></span>

<span data-ttu-id="b36a9-198">在下一教程中，我们将介绍如何将用户与角色相关联。</span><span class="sxs-lookup"><span data-stu-id="b36a9-198">In the next tutorial we will examine how to associate users with roles.</span></span> <span data-ttu-id="b36a9-199">`Roles` 类的[`AddUserToRole`](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx)、 [`AddUserToRoles`](https://msdn.microsoft.com/library/system.web.security.roles.addusertoroles.aspx)、 [`AddUsersToRole`](https://msdn.microsoft.com/library/system.web.security.roles.adduserstorole.aspx)和[`AddUsersToRoles`](https://msdn.microsoft.com/library/system.web.security.roles.adduserstoroles.aspx)方法将一个或多个用户添加到一个或多个角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-199">The `Roles` class's [`AddUserToRole`](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx), [`AddUserToRoles`](https://msdn.microsoft.com/library/system.web.security.roles.addusertoroles.aspx), [`AddUsersToRole`](https://msdn.microsoft.com/library/system.web.security.roles.adduserstorole.aspx), and [`AddUsersToRoles`](https://msdn.microsoft.com/library/system.web.security.roles.adduserstoroles.aspx) methods add one or more users to one or more roles.</span></span> <span data-ttu-id="b36a9-200">若要从角色中删除用户，请使用[`RemoveUserFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx)、 [`RemoveUserFromRoles`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromroles.aspx)、 [`RemoveUsersFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromrole.aspx)或[`RemoveUsersFromRoles`](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromroles.aspx)方法。</span><span class="sxs-lookup"><span data-stu-id="b36a9-200">To remove users from roles, use the [`RemoveUserFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx), [`RemoveUserFromRoles`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromroles.aspx), [`RemoveUsersFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromrole.aspx), or [`RemoveUsersFromRoles`](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromroles.aspx) methods.</span></span>

<span data-ttu-id="b36a9-201"><a id="_msoanchor_9"></a>在[*基于角色的授权*](role-based-authorization-cs.md)教程中，我们将探讨如何基于当前登录用户的角色以编程方式显示或隐藏功能。</span><span class="sxs-lookup"><span data-stu-id="b36a9-201">In the <a id="_msoanchor_9"></a>[*Role-Based Authorization*](role-based-authorization-cs.md) tutorial we will look at ways to programmatically show or hide functionality based on the currently logged in user's role.</span></span> <span data-ttu-id="b36a9-202">为实现此目的，可以使用 `Role` 类的[`FindUsersInRole`](https://msdn.microsoft.com/library/system.web.security.roles.findusersinrole.aspx)、 [`GetRolesForUser`](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx)、 [`GetUsersInRole`](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx)或[`IsUserInRole`](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx)方法。</span><span class="sxs-lookup"><span data-stu-id="b36a9-202">To accomplish this, we can use the `Role` class's [`FindUsersInRole`](https://msdn.microsoft.com/library/system.web.security.roles.findusersinrole.aspx), [`GetRolesForUser`](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx), [`GetUsersInRole`](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx), or [`IsUserInRole`](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx) methods.</span></span>

> [!NOTE]
> <span data-ttu-id="b36a9-203">请记住，只要调用其中一种方法，`Roles` 类就会将调用委托给已配置的提供程序。</span><span class="sxs-lookup"><span data-stu-id="b36a9-203">Keep in mind that any time one of these methods is invoked, the `Roles` class delegates the call to the configured provider.</span></span> <span data-ttu-id="b36a9-204">在我们的示例中，这意味着调用发送到 `SqlRoleProvider`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-204">In our case, this means that the call is being sent to the `SqlRoleProvider`.</span></span> <span data-ttu-id="b36a9-205">然后，`SqlRoleProvider` 基于调用的方法执行相应的数据库操作。</span><span class="sxs-lookup"><span data-stu-id="b36a9-205">The `SqlRoleProvider` then performs the appropriate database operation based on the invoked method.</span></span> <span data-ttu-id="b36a9-206">例如，代码 `Roles.CreateRole("Administrators")` 生成 `SqlRoleProvider` 执行 `aspnet_Roles_CreateRole` 存储过程，该过程将新记录插入到名为 Administrators 的 `aspnet_Roles` 表中。</span><span class="sxs-lookup"><span data-stu-id="b36a9-206">For example, the code `Roles.CreateRole("Administrators")` results in the `SqlRoleProvider` executing the `aspnet_Roles_CreateRole` stored procedure, which inserts a new record into the `aspnet_Roles` table named Administrators .</span></span>

<span data-ttu-id="b36a9-207">本教程的其余部分介绍如何使用 `Roles` 类的 `CreateRole`、`GetAllRoles`和 `DeleteRole` 方法来管理系统中的角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-207">The remainder of this tutorial looks at using the `Roles` class's `CreateRole`, `GetAllRoles`, and `DeleteRole` methods to manage the roles in the system.</span></span>

## <a name="step-4-creating-new-roles"></a><span data-ttu-id="b36a9-208">步骤4：创建新角色</span><span class="sxs-lookup"><span data-stu-id="b36a9-208">Step 4: Creating New Roles</span></span>

<span data-ttu-id="b36a9-209">角色提供了任意分组用户的方式，并且大多数情况下，这种分组用于更方便地应用授权规则。</span><span class="sxs-lookup"><span data-stu-id="b36a9-209">Roles offer a way to arbitrarily group users, and most commonly this grouping is used for a more convenient way to apply authorization rules.</span></span> <span data-ttu-id="b36a9-210">但是，若要使用角色作为授权机制，首先需要定义应用程序中存在哪些角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-210">But in order to use roles as an authorization mechanism we first need to define what roles exist in the application.</span></span> <span data-ttu-id="b36a9-211">遗憾的是，ASP.NET 不包含 CreateRoleWizard 控件。</span><span class="sxs-lookup"><span data-stu-id="b36a9-211">Unfortunately, ASP.NET does not include a CreateRoleWizard control.</span></span> <span data-ttu-id="b36a9-212">为了添加新的角色，我们需要创建合适的用户界面，并亲自调用角色 API。</span><span class="sxs-lookup"><span data-stu-id="b36a9-212">In order to add new roles we need to create a suitable user interface and invoke the Roles API ourselves.</span></span> <span data-ttu-id="b36a9-213">好消息是，这很容易完成。</span><span class="sxs-lookup"><span data-stu-id="b36a9-213">The good news is that this is very easy to accomplish.</span></span>

> [!NOTE]
> <span data-ttu-id="b36a9-214">尽管没有 CreateRoleWizard Web 控件，但仍有 ASP.NET 的网站[管理工具](https://msdn.microsoft.com/library/ms228053.aspx)，该工具是一个本地 ASP.NET 应用程序，旨在帮助查看和管理 Web 应用程序的配置。</span><span class="sxs-lookup"><span data-stu-id="b36a9-214">While there is no CreateRoleWizard Web control, there is the [ASP.NET Web Site Administration Tool](https://msdn.microsoft.com/library/ms228053.aspx), which is a local ASP.NET application designed to assist with viewing and managing your web application's configuration.</span></span> <span data-ttu-id="b36a9-215">但是，由于两个原因，我并不是 ASP.NET 网站管理工具的一个大风扇。</span><span class="sxs-lookup"><span data-stu-id="b36a9-215">However, I am not a big fan of the ASP.NET Web Site Administration Tool for two reasons.</span></span> <span data-ttu-id="b36a9-216">首先，这是一个很大的错误，用户体验会很有必要。</span><span class="sxs-lookup"><span data-stu-id="b36a9-216">First, it is a bit buggy and the user experience leaves a lot to be desired.</span></span> <span data-ttu-id="b36a9-217">其次，ASP.NET 网站管理工具设计为仅在本地工作，这意味着，如果需要远程管理活动站点上的角色，则必须构建自己的角色管理网页。</span><span class="sxs-lookup"><span data-stu-id="b36a9-217">Second, the ASP.NET Web Site Administration Tool is designed to only work locally, meaning that you will have to build your own role management web pages if you need to manage roles on a live site remotely.</span></span> <span data-ttu-id="b36a9-218">出于这两个原因，本教程和下一个教程将重点介绍如何在网页中构建必要的角色管理工具，而不是依赖于 ASP.NET 网站管理工具。</span><span class="sxs-lookup"><span data-stu-id="b36a9-218">For these two reasons, this tutorial and the next will focus on building the necessary role management tools in a web page rather than relying on the ASP.NET Web Site Administration Tool.</span></span>

<span data-ttu-id="b36a9-219">打开 `Roles` 文件夹中的 "`ManageRoles.aspx`" 页，并向页面添加一个文本框和一个按钮 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="b36a9-219">Open the `ManageRoles.aspx` page in the `Roles` folder and add a TextBox and a Button Web control to the page.</span></span> <span data-ttu-id="b36a9-220">将 TextBox 控件的 `ID` 属性设置为 `RoleName`，按钮的 `ID` 和 `Text` 属性分别设置为 `CreateRoleButton` 和创建角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-220">Set the TextBox control's `ID` property to `RoleName` and the Button's `ID` and `Text` properties to `CreateRoleButton` and Create Role, respectively.</span></span> <span data-ttu-id="b36a9-221">此时，页面的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b36a9-221">At this point, your page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample6.aspx)]

<span data-ttu-id="b36a9-222">接下来，双击设计器中的 "`CreateRoleButton`" 按钮控件以创建 `Click` 事件处理程序，然后添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="b36a9-222">Next, double-click the `CreateRoleButton` Button control in the Designer to create a `Click` event handler and then add the following code:</span></span>

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample7.cs)]

<span data-ttu-id="b36a9-223">上面的代码首先将在 "`RoleName`" 文本框中输入的剪裁角色名称分配给 `newRoleName` 变量。</span><span class="sxs-lookup"><span data-stu-id="b36a9-223">The above code starts by assigning the trimmed role name entered in the `RoleName` TextBox to the `newRoleName` variable.</span></span> <span data-ttu-id="b36a9-224">接下来，调用 `Roles` 类的 `RoleExists` 方法来确定系统中是否已存在该角色 `newRoleName`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-224">Next, the `Roles` class's `RoleExists` method is called to determine if the role `newRoleName` already exists in the system.</span></span> <span data-ttu-id="b36a9-225">如果角色不存在，则通过调用 `CreateRole` 方法创建。</span><span class="sxs-lookup"><span data-stu-id="b36a9-225">If the role does not exist, it is created via a call to the `CreateRole` method.</span></span> <span data-ttu-id="b36a9-226">如果向 `CreateRole` 方法传递系统中已存在的角色名称，则会引发 `ProviderException` 异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-226">If the `CreateRole` method is passed a role name that already exists in the system, a `ProviderException` exception is thrown.</span></span> <span data-ttu-id="b36a9-227">这就是代码首次检查以确保在调用 `CreateRole`之前该角色在系统中不存在的原因。</span><span class="sxs-lookup"><span data-stu-id="b36a9-227">This is why the code first checks to ensure that the role does not already exist in the system before calling `CreateRole`.</span></span> <span data-ttu-id="b36a9-228">`Click` 事件处理程序通过清除 `RoleName` 文本框的 `Text` 属性来结束。</span><span class="sxs-lookup"><span data-stu-id="b36a9-228">The `Click` event handler concludes by clearing out the `RoleName` TextBox's `Text` property.</span></span>

> [!NOTE]
> <span data-ttu-id="b36a9-229">如果用户没有在 "`RoleName`" 文本框中输入任何值，可能会想知道发生了什么情况。</span><span class="sxs-lookup"><span data-stu-id="b36a9-229">You may be wondering what will happen if the user doesn't enter any value into the `RoleName` TextBox.</span></span> <span data-ttu-id="b36a9-230">如果传递到 `CreateRole` 方法的值为 `null` 或空字符串，则会引发异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-230">If the value passed into the `CreateRole` method is `null` or an empty string, an exception is raised.</span></span> <span data-ttu-id="b36a9-231">同样，如果角色名称包含逗号，则会引发异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-231">Likewise, if the role name contains a comma an exception is raised.</span></span> <span data-ttu-id="b36a9-232">因此，页面应包含验证控件，以确保用户输入角色并且不包含任何逗号。</span><span class="sxs-lookup"><span data-stu-id="b36a9-232">Consequently, the page should contain validation controls to ensure that the user enters a role and that it does not contain any commas.</span></span> <span data-ttu-id="b36a9-233">我为读者作了练习。</span><span class="sxs-lookup"><span data-stu-id="b36a9-233">I leave as an exercise for the reader.</span></span>

<span data-ttu-id="b36a9-234">让我们创建一个名为 "管理员" 的角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-234">Let's create a role named Administrators.</span></span> <span data-ttu-id="b36a9-235">通过浏览器访问 `ManageRoles.aspx` 页面，在文本框中键入 "管理员" （参见图3），然后单击 "创建角色" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b36a9-235">Visit the `ManageRoles.aspx` page through a browser, type in Administrators into the textbox (see Figure 3), and then click the Create Role button.</span></span>

<span data-ttu-id="b36a9-236">[![创建管理员角色](creating-and-managing-roles-cs/_static/image8.png)](creating-and-managing-roles-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-236">[![Create an Administrators Role](creating-and-managing-roles-cs/_static/image8.png)](creating-and-managing-roles-cs/_static/image7.png)</span></span>

<span data-ttu-id="b36a9-237">**图 3**：创建管理员角色（[单击以查看完全大小的映像](creating-and-managing-roles-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-237">**Figure 3**: Create an Administrators Role  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image9.png))</span></span>

<span data-ttu-id="b36a9-238">发生了什么情况？</span><span class="sxs-lookup"><span data-stu-id="b36a9-238">What happens?</span></span> <span data-ttu-id="b36a9-239">发生回发，但没有视觉提示，指出该角色实际上已添加到系统中。</span><span class="sxs-lookup"><span data-stu-id="b36a9-239">A postback occurs, but there's no visual cue that the role has actually been added to the system.</span></span> <span data-ttu-id="b36a9-240">我们将在步骤5中更新此页面以包括视觉反馈。</span><span class="sxs-lookup"><span data-stu-id="b36a9-240">We will update this page in Step 5 to include visual feedback.</span></span> <span data-ttu-id="b36a9-241">不过，现在可以通过转到 `SecurityTutorials.mdf` 数据库并显示 `aspnet_Roles` 表中的数据来验证角色是否已创建。</span><span class="sxs-lookup"><span data-stu-id="b36a9-241">For now, however, you can verify that the role was created by going to the `SecurityTutorials.mdf` database and displaying the data from the `aspnet_Roles` table.</span></span> <span data-ttu-id="b36a9-242">如图4所示，`aspnet_Roles` 表包含刚添加的管理员角色的记录。</span><span class="sxs-lookup"><span data-stu-id="b36a9-242">As Figure 4 shows, the `aspnet_Roles` table contains a record for the just-added Administrators roles.</span></span>

<span data-ttu-id="b36a9-243">[![aspnet_Roles 表有一个适用于管理员的行](creating-and-managing-roles-cs/_static/image11.png)](creating-and-managing-roles-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-243">[![The aspnet_Roles Table has a Row for the Administrators](creating-and-managing-roles-cs/_static/image11.png)](creating-and-managing-roles-cs/_static/image10.png)</span></span>

<span data-ttu-id="b36a9-244">**图 4**： "`aspnet_Roles`" 表为管理员提供了一行（[单击以查看完全大小的图像](creating-and-managing-roles-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-244">**Figure 4**: The `aspnet_Roles` Table has a Row for the Administrators  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image12.png))</span></span>

## <a name="step-5-displaying-the-roles-in-the-system"></a><span data-ttu-id="b36a9-245">步骤5：显示系统中的角色</span><span class="sxs-lookup"><span data-stu-id="b36a9-245">Step 5: Displaying the Roles in the System</span></span>

<span data-ttu-id="b36a9-246">增加 `ManageRoles.aspx` 页面，使其包含系统中当前角色的列表。</span><span class="sxs-lookup"><span data-stu-id="b36a9-246">Let's augment the `ManageRoles.aspx` page to include a list of the current roles in the system.</span></span> <span data-ttu-id="b36a9-247">若要实现此目的，请将 GridView 控件添加到页面，并将其 `ID` 属性设置为 `RoleList`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-247">To accomplish this, add a GridView control to the page and set its `ID` property to `RoleList`.</span></span> <span data-ttu-id="b36a9-248">接下来，使用以下代码将方法添加到名为 `DisplayRolesInGrid` 的页的代码隐藏类：</span><span class="sxs-lookup"><span data-stu-id="b36a9-248">Next, add a method to the page's code-behind class named `DisplayRolesInGrid` using the following code:</span></span>

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample8.cs)]

<span data-ttu-id="b36a9-249">`Roles` 类的 `GetAllRoles` 方法以字符串数组的形式返回系统中的所有角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-249">The `Roles` class's `GetAllRoles` method returns all of the roles in the system as an array of strings.</span></span> <span data-ttu-id="b36a9-250">然后，将此字符串数组绑定到 GridView。</span><span class="sxs-lookup"><span data-stu-id="b36a9-250">This string array is then bound to the GridView.</span></span> <span data-ttu-id="b36a9-251">若要在第一次加载页面时将角色列表绑定到 GridView，需要从页面的 `Page_Load` 事件处理程序中调用 `DisplayRolesInGrid` 方法。</span><span class="sxs-lookup"><span data-stu-id="b36a9-251">In order to bind the list of roles to the GridView when the page is first loaded, we need to call the `DisplayRolesInGrid` method from the page's `Page_Load` event handler.</span></span> <span data-ttu-id="b36a9-252">当首次访问页面时，以下代码调用此方法，而不是在后续回发时调用。</span><span class="sxs-lookup"><span data-stu-id="b36a9-252">The following code calls this method when the page is first visited, but not on subsequent postbacks.</span></span>

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample9.cs)]

<span data-ttu-id="b36a9-253">使用此代码后，请通过浏览器访问此页。</span><span class="sxs-lookup"><span data-stu-id="b36a9-253">With this code in place, visit the page through a browser.</span></span> <span data-ttu-id="b36a9-254">如图5所示，你应该看到一个网格，其中包含一个标记为 "Item" 的列。</span><span class="sxs-lookup"><span data-stu-id="b36a9-254">As Figure 5 shows, you should see a grid with a single column labeled Item.</span></span> <span data-ttu-id="b36a9-255">网格为在步骤4中添加的管理员角色包含一行。</span><span class="sxs-lookup"><span data-stu-id="b36a9-255">The grid includes a row for the Administrators role we added in Step 4.</span></span>

<span data-ttu-id="b36a9-256">[![GridView 显示单个列中的角色](creating-and-managing-roles-cs/_static/image14.png)](creating-and-managing-roles-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-256">[![The GridView Displays the Roles in a Single Column](creating-and-managing-roles-cs/_static/image14.png)](creating-and-managing-roles-cs/_static/image13.png)</span></span>

<span data-ttu-id="b36a9-257">**图 5**： GridView 显示单个列中的角色（[单击以查看完全大小的图像](creating-and-managing-roles-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-257">**Figure 5**: The GridView Displays the Roles in a Single Column  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image15.png))</span></span>

<span data-ttu-id="b36a9-258">GridView 将显示一个标记为 "Item" 的列，因为 GridView 的 `AutoGenerateColumns` 属性设置为 True （默认值），这会导致 GridView 自动为其 `DataSource`中的每个属性创建一个列。</span><span class="sxs-lookup"><span data-stu-id="b36a9-258">The GridView displays a lone column labeled Item because the GridView's `AutoGenerateColumns` property is set to True (the default), which causes the GridView to automatically create a column for each property in its `DataSource`.</span></span> <span data-ttu-id="b36a9-259">数组有一个属性，该属性表示数组中的元素，因此是 GridView 中的单个列。</span><span class="sxs-lookup"><span data-stu-id="b36a9-259">An array has a single property that represents the elements in the array, hence the single column in the GridView.</span></span>

<span data-ttu-id="b36a9-260">使用 GridView 显示数据时，我更喜欢显式定义列，而不是由 GridView 隐式生成。</span><span class="sxs-lookup"><span data-stu-id="b36a9-260">When displaying data with a GridView, I prefer to explicitly define my columns rather than have them implicitly generated by the GridView.</span></span> <span data-ttu-id="b36a9-261">通过显式定义列，可以更轻松地对数据进行格式设置、重新排列列以及执行其他常见任务。</span><span class="sxs-lookup"><span data-stu-id="b36a9-261">By explicitly defining the columns it is much easier to format the data, rearrange the columns, and perform other common tasks.</span></span> <span data-ttu-id="b36a9-262">因此，让我们更新 GridView 的声明性标记，以便显式定义其列。</span><span class="sxs-lookup"><span data-stu-id="b36a9-262">Therefore, let's update the GridView's declarative markup so that its columns are explicitly defined.</span></span>

<span data-ttu-id="b36a9-263">首先，将 GridView 的 `AutoGenerateColumns` 属性设置为 False。</span><span class="sxs-lookup"><span data-stu-id="b36a9-263">Start by setting the GridView's `AutoGenerateColumns` property to False.</span></span> <span data-ttu-id="b36a9-264">接下来，将 "TemplateField" 添加到网格，将其 `HeaderText` 属性设置为 "角色"，并将其 `ItemTemplate` 配置为显示数组的内容。</span><span class="sxs-lookup"><span data-stu-id="b36a9-264">Next, add a TemplateField to the grid, set its `HeaderText` property to Roles, and configure its `ItemTemplate` so that it displays the contents of the array.</span></span> <span data-ttu-id="b36a9-265">若要实现此目的，请将名为 `RoleNameLabel` 的标签 Web 控件添加到 `ItemTemplate`，并将其 `Text` 属性绑定到 `Container.DataItem`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-265">To accomplish this, add a Label Web control named `RoleNameLabel` to the `ItemTemplate` and bind its `Text` property to `Container.DataItem`.</span></span>

<span data-ttu-id="b36a9-266">可以通过声明方式或通过 GridView 的 "字段" 对话框和编辑模板界面来设置这些属性和 `ItemTemplate`的内容。</span><span class="sxs-lookup"><span data-stu-id="b36a9-266">These properties and the `ItemTemplate`'s contents can be set declaratively or through the GridView's Fields dialog box and Edit Templates interface.</span></span> <span data-ttu-id="b36a9-267">若要访问 "字段" 对话框，请单击 GridView 智能标记中的 "编辑列" 链接。</span><span class="sxs-lookup"><span data-stu-id="b36a9-267">To reach the Fields dialog box, click the Edit Columns link in the GridView's Smart Tag.</span></span> <span data-ttu-id="b36a9-268">接下来，取消选中 "自动生成字段" 复选框，将 `AutoGenerateColumns` 属性设置为 False，并将 TemplateField 添加到 GridView，并将其 `HeaderText` 属性设置为 Role。</span><span class="sxs-lookup"><span data-stu-id="b36a9-268">Next, uncheck the Auto-generate fields checkbox to set the `AutoGenerateColumns` property to False, and add a TemplateField to the GridView, setting its `HeaderText` property to Role.</span></span> <span data-ttu-id="b36a9-269">若要定义 `ItemTemplate`的内容，请从 GridView 的智能标记选择 "编辑模板" 选项。</span><span class="sxs-lookup"><span data-stu-id="b36a9-269">To define the `ItemTemplate`'s contents, choose the Edit Templates option from the GridView's Smart Tag.</span></span> <span data-ttu-id="b36a9-270">将标签 Web 控件拖动到 `ItemTemplate`上，将其 `ID` 属性设置为 `RoleNameLabel`，并配置其数据绑定设置，以便将其 `Text` 属性绑定到 `Container.DataItem`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-270">Drag a Label Web control onto the `ItemTemplate`, set its `ID` property to `RoleNameLabel`, and configure its databinding settings so that its `Text` property is bound to `Container.DataItem`.</span></span>

<span data-ttu-id="b36a9-271">不管你使用哪种方法，在完成后，GridView 生成的声明性标记应类似于以下内容。</span><span class="sxs-lookup"><span data-stu-id="b36a9-271">Regardless of what approach you use, the GridView's resulting declarative markup should look similar to the following when you are done.</span></span>

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample10.aspx)]

> [!NOTE]
> <span data-ttu-id="b36a9-272">使用数据绑定语法 `<%# Container.DataItem %>`显示数组的内容。</span><span class="sxs-lookup"><span data-stu-id="b36a9-272">The array's contents are displayed using the databinding syntax `<%# Container.DataItem %>`.</span></span> <span data-ttu-id="b36a9-273">有关在显示绑定到 GridView 的数组内容时使用此语法的详细说明，不在本教程的讨论范围之内。</span><span class="sxs-lookup"><span data-stu-id="b36a9-273">A thorough description of why this syntax is used when displaying the contents of an array bound to the GridView is beyond the scope of this tutorial.</span></span> <span data-ttu-id="b36a9-274">有关此问题的详细信息，请参阅将[标量数组绑定到数据 Web 控件](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b36a9-274">For more information on this matter, refer to [Binding a Scalar Array to a Data Web Control](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx).</span></span>

<span data-ttu-id="b36a9-275">目前，在首次访问页面时，`RoleList` GridView 仅绑定到角色列表。</span><span class="sxs-lookup"><span data-stu-id="b36a9-275">Currently, the `RoleList` GridView is only bound to the list of roles when the page is first visited.</span></span> <span data-ttu-id="b36a9-276">需要在添加新角色时刷新网格。</span><span class="sxs-lookup"><span data-stu-id="b36a9-276">We need to refresh the grid whenever a new role is added.</span></span> <span data-ttu-id="b36a9-277">若要完成此操作，请更新 "`CreateRoleButton`" 按钮的 `Click` 事件处理程序，以便在创建新角色时调用 `DisplayRolesInGrid` 方法。</span><span class="sxs-lookup"><span data-stu-id="b36a9-277">To accomplish this, update the `CreateRoleButton` Button's `Click` event handler so that it calls the `DisplayRolesInGrid` method if a new role is created.</span></span>

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample11.cs)]

<span data-ttu-id="b36a9-278">现在，当用户添加新角色时，`RoleList` GridView 会在回发时显示刚刚添加的角色，并提供成功创建角色的视觉反馈。</span><span class="sxs-lookup"><span data-stu-id="b36a9-278">Now when the user adds a new role the `RoleList` GridView shows the just-added role on postback, providing visual feedback that the role was successfully created.</span></span> <span data-ttu-id="b36a9-279">为了说明这一点，请通过浏览器访问 `ManageRoles.aspx` 页面，并添加一个名为监察员的角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-279">To illustrate this, visit the `ManageRoles.aspx` page through a browser and add a role named Supervisors.</span></span> <span data-ttu-id="b36a9-280">单击 "创建角色" 按钮后，将不幸回发，并将更新网格，使其包括管理员以及新的角色监察员。</span><span class="sxs-lookup"><span data-stu-id="b36a9-280">Upon clicking the Create Role button, a postback will ensue and the grid will update to include Administrators as well as the new role, Supervisors.</span></span>

<span data-ttu-id="b36a9-281">[已添加 "监察员" 角色 ![](creating-and-managing-roles-cs/_static/image17.png)](creating-and-managing-roles-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-281">[![The Supervisors Role has Been Added](creating-and-managing-roles-cs/_static/image17.png)](creating-and-managing-roles-cs/_static/image16.png)</span></span>

<span data-ttu-id="b36a9-282">**图 6**：添加了 "监察员" 角色（[单击以查看完全大小的映像](creating-and-managing-roles-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-282">**Figure 6**: The Supervisors Role has Been Added  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image18.png))</span></span>

## <a name="step-6-deleting-roles"></a><span data-ttu-id="b36a9-283">步骤6：删除角色</span><span class="sxs-lookup"><span data-stu-id="b36a9-283">Step 6: Deleting Roles</span></span>

<span data-ttu-id="b36a9-284">此时，用户可以创建新角色，并从 "`ManageRoles.aspx`" 页查看所有现有角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-284">At this point a user can create a new role and view all existing roles from the `ManageRoles.aspx` page.</span></span> <span data-ttu-id="b36a9-285">允许用户也删除角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-285">Let's allow users to also delete roles.</span></span> <span data-ttu-id="b36a9-286">`Roles.DeleteRole` 方法有两个重载：</span><span class="sxs-lookup"><span data-stu-id="b36a9-286">The `Roles.DeleteRole` method has two overloads:</span></span>

- <span data-ttu-id="b36a9-287">[`DeleteRole(roleName)`](https://msdn.microsoft.com/library/ek4sywc0.aspx) -*删除角色角色*。</span><span class="sxs-lookup"><span data-stu-id="b36a9-287">[`DeleteRole(roleName)`](https://msdn.microsoft.com/library/ek4sywc0.aspx) - deletes the role *roleName*.</span></span> <span data-ttu-id="b36a9-288">如果角色包含一个或多个成员，则会引发异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-288">An exception is thrown if the role contains one or more members.</span></span>
- <span data-ttu-id="b36a9-289">[`DeleteRole(roleName, throwOnPopulatedRole)`](https://msdn.microsoft.com/library/38h6wf59.aspx) -*删除角色角色*。</span><span class="sxs-lookup"><span data-stu-id="b36a9-289">[`DeleteRole(roleName, throwOnPopulatedRole)`](https://msdn.microsoft.com/library/38h6wf59.aspx) - deletes the role *roleName*.</span></span> <span data-ttu-id="b36a9-290">如果 `true`*throwOnPopulateRole* ，则在角色包含一个或多个成员时将引发异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-290">If *throwOnPopulateRole* is `true`, then an exception is thrown if the role contains one or more members.</span></span> <span data-ttu-id="b36a9-291">如果 `false`*throwOnPopulateRole* ，则无论角色是否包含任何成员，都将被删除。</span><span class="sxs-lookup"><span data-stu-id="b36a9-291">If *throwOnPopulateRole* is `false`, then the role is deleted whether it contains any members or not.</span></span> <span data-ttu-id="b36a9-292">在内部，`DeleteRole(roleName)` 方法调用 `DeleteRole(roleName, true)`。</span><span class="sxs-lookup"><span data-stu-id="b36a9-292">Internally, the `DeleteRole(roleName)` method calls `DeleteRole(roleName, true)`.</span></span>

<span data-ttu-id="b36a9-293">如果使用了 "工作的 `null`" 或 "空字符串" 或 *"包含逗号* *"，则*`DeleteRole` 方法也将引发异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-293">The `DeleteRole` method will also throw an exception if *roleName* is `null` or an empty string or if *roleName* contains a comma.</span></span> <span data-ttu-id="b36a9-294">如果*系统中不存在*该工作项，`DeleteRole` 会悄悄地失败，而不会引发异常。</span><span class="sxs-lookup"><span data-stu-id="b36a9-294">If *roleName* does not exist in the system, `DeleteRole` fails silently, without raising an exception.</span></span>

<span data-ttu-id="b36a9-295">接下来，我们将 `ManageRoles.aspx` 中的 GridView 补充为包含一个删除按钮，单击该按钮将删除所选角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-295">Let's augment the GridView in `ManageRoles.aspx` to include a Delete button that, when clicked, deletes the selected role.</span></span> <span data-ttu-id="b36a9-296">首先将 "删除" 按钮添加到 GridView，方法是转到 "字段" 对话框并添加 "删除" 按钮，该按钮位于 "CommandField" 选项下。</span><span class="sxs-lookup"><span data-stu-id="b36a9-296">Start by adding a Delete button to the GridView by going to the Fields dialog box and adding a Delete button, which is located under the CommandField option.</span></span> <span data-ttu-id="b36a9-297">使 "删除" 按钮成为最左侧的列，并将其 `DeleteText` 属性设置为 "删除角色"。</span><span class="sxs-lookup"><span data-stu-id="b36a9-297">Make the Delete button the far left column and set its `DeleteText` property to Delete Role .</span></span>

<span data-ttu-id="b36a9-298">[![向 RoleList GridView 添加 "删除" 按钮](creating-and-managing-roles-cs/_static/image20.png)](creating-and-managing-roles-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="b36a9-298">[![Add a Delete Button to the RoleList GridView](creating-and-managing-roles-cs/_static/image20.png)](creating-and-managing-roles-cs/_static/image19.png)</span></span>

<span data-ttu-id="b36a9-299">**图 7**：将 "删除" 按钮添加到 `RoleList` GridView （[单击以查看完全大小的图像](creating-and-managing-roles-cs/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="b36a9-299">**Figure 7**: Add a Delete Button to the `RoleList` GridView  ([Click to view full-size image](creating-and-managing-roles-cs/_static/image21.png))</span></span>

<span data-ttu-id="b36a9-300">添加 "删除" 按钮后，GridView 的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b36a9-300">After adding the Delete button, your GridView's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample12.aspx)]

<span data-ttu-id="b36a9-301">接下来，为 GridView 的 `RowDeleting` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="b36a9-301">Next, create an event handler for the GridView's `RowDeleting` event.</span></span> <span data-ttu-id="b36a9-302">这是在单击 "删除角色" 按钮时对回发引发的事件。</span><span class="sxs-lookup"><span data-stu-id="b36a9-302">This is the event that is raised on postback when the Delete Role button is clicked.</span></span> <span data-ttu-id="b36a9-303">将以下代码添加到该事件处理程序中。</span><span class="sxs-lookup"><span data-stu-id="b36a9-303">Add the following code to the event handler.</span></span>

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample13.cs)]

<span data-ttu-id="b36a9-304">代码首先以编程方式在单击了 "删除角色" 按钮的行中引用 `RoleNameLabel` Web 控件。</span><span class="sxs-lookup"><span data-stu-id="b36a9-304">The code starts by programmatically referencing the `RoleNameLabel` Web control in the row whose Delete Role button was clicked.</span></span> <span data-ttu-id="b36a9-305">然后调用 `Roles.DeleteRole` 方法，并传入 `RoleNameLabel` 和 `false`的 `Text`，从而删除角色，无论是否存在任何与该角色关联的用户。</span><span class="sxs-lookup"><span data-stu-id="b36a9-305">The `Roles.DeleteRole` method is then invoked, passing in the `Text` of the `RoleNameLabel` and `false`, thereby deleting the role regardless of whether there are any users associated with the role.</span></span> <span data-ttu-id="b36a9-306">最后，将刷新 `RoleList` GridView，使刚删除的角色不再出现在网格中。</span><span class="sxs-lookup"><span data-stu-id="b36a9-306">Finally, the `RoleList` GridView is refreshed so that the just-deleted role no longer appears in the grid.</span></span>

> [!NOTE]
> <span data-ttu-id="b36a9-307">删除角色之前，"删除角色" 按钮不需要用户进行任何类型的确认。</span><span class="sxs-lookup"><span data-stu-id="b36a9-307">The Delete Role button does not require any sort of confirmation from the user before deleting the role.</span></span> <span data-ttu-id="b36a9-308">确认操作的最简单方法之一是通过客户端确认对话框。</span><span class="sxs-lookup"><span data-stu-id="b36a9-308">One of the easiest ways to confirm an action is through a client-side confirm dialog box.</span></span> <span data-ttu-id="b36a9-309">有关此技术的详细信息，请参阅[删除时添加客户端确认](https://asp.net/learn/data-access/tutorial-42-cs.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b36a9-309">For more information on this technique, see [Adding Client-Side Confirmation When Deleting](https://asp.net/learn/data-access/tutorial-42-cs.aspx).</span></span>

## <a name="summary"></a><span data-ttu-id="b36a9-310">摘要</span><span class="sxs-lookup"><span data-stu-id="b36a9-310">Summary</span></span>

<span data-ttu-id="b36a9-311">许多 web 应用程序都有某些授权规则或页面级别的功能，这些功能仅适用于某些类的用户。</span><span class="sxs-lookup"><span data-stu-id="b36a9-311">Many web applications have certain authorization rules or page-level functionality that is only available to certain classes of users.</span></span> <span data-ttu-id="b36a9-312">例如，可能有一组只有管理员才能访问的网页。</span><span class="sxs-lookup"><span data-stu-id="b36a9-312">For example, there may be a set of web pages that only administrators can access.</span></span> <span data-ttu-id="b36a9-313">通常，根据角色定义规则更有用，而不是逐个用户地定义这些授权规则。</span><span class="sxs-lookup"><span data-stu-id="b36a9-313">Rather than defining these authorization rules on a user-by-user basis, oftentimes it is more useful to define the rules based on a role.</span></span> <span data-ttu-id="b36a9-314">也就是说，更易于维护的方法是允许管理员角色的成员访问这些页面，然后将 Scott 和 Jisun 表示为用户，而不是明确地允许用户 Jisun 访问管理网页。Administrators 角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-314">That is, rather than explicitly allowing users Scott and Jisun to access the administrative web pages, a more maintainable approach is to permit members of the Administrators role to access these pages, and then to denote Scott and Jisun as users belonging to the Administrators role.</span></span>

<span data-ttu-id="b36a9-315">角色框架可以轻松创建和管理角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-315">The Roles framework makes it easy to create and manage roles.</span></span> <span data-ttu-id="b36a9-316">在本教程中，我们介绍了如何将角色框架配置为使用 `SqlRoleProvider`，后者使用 Microsoft SQL Server 数据库作为角色存储。</span><span class="sxs-lookup"><span data-stu-id="b36a9-316">In this tutorial we examined how to configure the Roles framework to use the `SqlRoleProvider`, which uses a Microsoft SQL Server database as the role store.</span></span> <span data-ttu-id="b36a9-317">我们还创建了一个网页，其中列出了系统中的现有角色，并允许创建新角色并删除现有角色。</span><span class="sxs-lookup"><span data-stu-id="b36a9-317">We also created a web page that lists the existing roles in the system and allows for new roles to be created and existing ones to be deleted.</span></span> <span data-ttu-id="b36a9-318">在后续教程中，我们将了解如何将用户分配到角色，以及如何应用基于角色的授权。</span><span class="sxs-lookup"><span data-stu-id="b36a9-318">In subsequent tutorials we will see how to assign users to roles and how to apply role-based authorization.</span></span>

<span data-ttu-id="b36a9-319">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="b36a9-319">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="b36a9-320">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="b36a9-320">Further Reading</span></span>

<span data-ttu-id="b36a9-321">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="b36a9-321">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="b36a9-322">检查 ASP.NET 2.0 的成员资格、角色和配置文件</span><span class="sxs-lookup"><span data-stu-id="b36a9-322">Examining ASP.NET 2.0's Membership, Roles, and Profile</span></span>](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [<span data-ttu-id="b36a9-323">如何：在 ASP.NET 2.0 中使用角色管理器</span><span class="sxs-lookup"><span data-stu-id="b36a9-323">How To: Use Role Manager in ASP.NET 2.0</span></span>](https://msdn.microsoft.com/library/ms998314.aspx)
- [<span data-ttu-id="b36a9-324">角色提供程序</span><span class="sxs-lookup"><span data-stu-id="b36a9-324">Role Providers</span></span>](https://msdn.microsoft.com/library/aa478950.aspx)
- [<span data-ttu-id="b36a9-325">滚动你自己的网站管理工具</span><span class="sxs-lookup"><span data-stu-id="b36a9-325">Rolling Your Own Website Administration Tool</span></span>](http://aspnet.4guysfromrolla.com/articles/052307-1.aspx)
- [<span data-ttu-id="b36a9-326">`<roleManager>` 元素的技术文档</span><span class="sxs-lookup"><span data-stu-id="b36a9-326">Technical documentation for the `<roleManager>` Element</span></span>](https://msdn.microsoft.com/library/ms164660.aspx)
- [<span data-ttu-id="b36a9-327">使用成员身份和角色管理器 Api</span><span class="sxs-lookup"><span data-stu-id="b36a9-327">Using the Membership and Role Manager APIs</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/membership.aspx)

### <a name="about-the-author"></a><span data-ttu-id="b36a9-328">关于作者</span><span class="sxs-lookup"><span data-stu-id="b36a9-328">About the Author</span></span>

<span data-ttu-id="b36a9-329">Scott Mitchell，创始人的多个 ASP/ASP 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="b36a9-329">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="b36a9-330">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="b36a9-330">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="b36a9-331">他的最新书籍是， *[在24小时内，sam ASP.NET 2.0](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* 。</span><span class="sxs-lookup"><span data-stu-id="b36a9-331">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="b36a9-332">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="b36a9-332">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="b36a9-333">特别感谢</span><span class="sxs-lookup"><span data-stu-id="b36a9-333">Special Thanks To</span></span>

<span data-ttu-id="b36a9-334">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="b36a9-334">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="b36a9-335">本教程的主管评审者包括 Alicja Maziarz、Suchi Banerjee 和 Teresa Murphy。</span><span class="sxs-lookup"><span data-stu-id="b36a9-335">Lead reviewers for this tutorial include Alicja Maziarz, Suchi Banerjee, and Teresa Murphy.</span></span> <span data-ttu-id="b36a9-336">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="b36a9-336">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="b36a9-337">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="b36a9-337">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="b36a9-338">下一部分</span><span class="sxs-lookup"><span data-stu-id="b36a9-338">Next</span></span>](assigning-roles-to-users-cs.md)
