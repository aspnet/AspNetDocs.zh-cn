---
uid: web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-vb
title: Forms 身份验证配置和高级主题（VB） |Microsoft Docs
author: rick-anderson
description: 在本教程中，我们将检查各种 forms 身份验证设置，并查看如何通过 forms 元素修改这些设置。 这将需要更详细的 。
ms.author: riande
ms.date: 01/14/2008
ms.assetid: 829d2f56-5c48-445b-b826-3418a450c788
msc.legacyurl: /web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-vb
msc.type: authoredcontent
ms.openlocfilehash: 4d77816a489a4fa16cd70ec4214cd2f8ee563029
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78518132"
---
# <a name="forms-authentication-configuration-and-advanced-topics-vb"></a><span data-ttu-id="20871-104">Forms 身份验证配置和高级主题 (VB)</span><span class="sxs-lookup"><span data-stu-id="20871-104">Forms Authentication Configuration and Advanced Topics (VB)</span></span>

<span data-ttu-id="20871-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="20871-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="20871-106">[下载代码](https://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_03_VB.zip)或[下载 PDF](https://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial03_AuthAdvanced_vb.pdf)</span><span class="sxs-lookup"><span data-stu-id="20871-106">[Download Code](https://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_03_VB.zip) or [Download PDF](https://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial03_AuthAdvanced_vb.pdf)</span></span>

> <span data-ttu-id="20871-107">在本教程中，我们将检查各种 forms 身份验证设置，并查看如何通过 forms 元素修改这些设置。</span><span class="sxs-lookup"><span data-stu-id="20871-107">In this tutorial we will examine the various forms authentication settings and see how to modify them through the forms element.</span></span> <span data-ttu-id="20871-108">这将需要详细了解如何使用带有自定义 URL （如登录 .aspx 而不是登录 .aspx）和无 cookie forms 身份验证票证的登录页自定义 forms 身份验证票证的超时值。</span><span class="sxs-lookup"><span data-stu-id="20871-108">This will entail a detailed look at customizing the forms authentication ticket's timeout value, using a login page with a custom URL (like SignIn.aspx instead of Login.aspx), and cookieless forms authentication tickets.</span></span>

## <a name="introduction"></a><span data-ttu-id="20871-109">简介</span><span class="sxs-lookup"><span data-stu-id="20871-109">Introduction</span></span>

<span data-ttu-id="20871-110">在[上一教程](an-overview-of-forms-authentication-vb.md)中，我们介绍了在 ASP.NET 应用程序中实现 forms 身份验证所需的步骤，从在 web.config 中指定配置设置到创建登录页，以便为经过身份验证的用户和匿名用户显示不同的内容。</span><span class="sxs-lookup"><span data-stu-id="20871-110">In the [previous tutorial](an-overview-of-forms-authentication-vb.md) we looked at the steps necessary for implementing forms authentication in an ASP.NET application, from specifying configuration settings in Web.config to creating a log in page to displaying different content for authenticated and anonymous users.</span></span> <span data-ttu-id="20871-111">回忆一下，我们已将网站配置为使用 forms 身份验证，方法是将 &lt;authentication&gt; 元素的 mode 属性设置为 Forms。</span><span class="sxs-lookup"><span data-stu-id="20871-111">Recall that we configured the website to use forms authentication by setting the mode attribute of the &lt;authentication&gt; element to Forms.</span></span> <span data-ttu-id="20871-112">&lt;authentication&gt; 元素可以选择性地包括 &lt;窗体&gt; 子元素，通过该元素可以指定一种形式的窗体身份验证设置。</span><span class="sxs-lookup"><span data-stu-id="20871-112">The &lt;authentication&gt; element may optionally include a &lt;forms&gt; child element, through which an assortment of forms authentication settings may be specified.</span></span>

<span data-ttu-id="20871-113">在本教程中，我们将检查各种 forms 身份验证设置，并查看如何通过 &lt;窗体&gt; 元素来修改它们。</span><span class="sxs-lookup"><span data-stu-id="20871-113">In this tutorial we will examine the various forms authentication settings and see how to modify them through the &lt;forms&gt; element.</span></span> <span data-ttu-id="20871-114">这将需要详细了解如何使用带有自定义 URL （如登录 .aspx 而不是登录 .aspx）和无 cookie forms 身份验证票证的登录页自定义 forms 身份验证票证的超时值。</span><span class="sxs-lookup"><span data-stu-id="20871-114">This will entail a detailed look at customizing the forms authentication ticket's timeout value, using a login page with a custom URL (like SignIn.aspx instead of Login.aspx), and cookieless forms authentication tickets.</span></span> <span data-ttu-id="20871-115">我们还将更仔细地检查 forms 身份验证票证的构成，并了解 ASP.NET 采取的措施，以确保票证的数据免受检查和篡改。</span><span class="sxs-lookup"><span data-stu-id="20871-115">We will also examine the makeup of the forms authentication ticket more closely and see the precautions ASP.NET takes to ensure that the ticket's data is secure from inspection and tampering.</span></span> <span data-ttu-id="20871-116">最后，我们将介绍如何将额外的用户数据存储在 forms 身份验证票证中，以及如何通过自定义主体对象对此数据建模。</span><span class="sxs-lookup"><span data-stu-id="20871-116">Finally, we will look at how to store extra user data in the forms authentication ticket and how to model this data through a custom principal object.</span></span>

## <a name="step-1-examining-the-ltformsgt-configuration-settings"></a><span data-ttu-id="20871-117">步骤1：检查 &lt;窗体&gt; 配置设置</span><span class="sxs-lookup"><span data-stu-id="20871-117">Step 1: Examining the &lt;forms&gt; Configuration Settings</span></span>

<span data-ttu-id="20871-118">ASP.NET 中的 forms 身份验证系统提供了许多配置设置，这些设置可根据应用程序进行自定义。</span><span class="sxs-lookup"><span data-stu-id="20871-118">The forms authentication system in ASP.NET offers a number of configuration settings that can be customized on an application-by-application basis.</span></span> <span data-ttu-id="20871-119">这包括如下设置： forms 身份验证票证的生存期;对票证应用哪种类型的保护;在什么情况下使用无 cookie 身份验证票证;登录页的路径;和其他信息。</span><span class="sxs-lookup"><span data-stu-id="20871-119">This includes settings like: the lifetime of the forms authentication ticket; what sort of protection is applied to the ticket; under what conditions cookieless authentication tickets are used; the path to the login page; and other information.</span></span> <span data-ttu-id="20871-120">若要修改默认值，请将[&lt;窗体&gt; 元素](https://msdn.microsoft.com/library/1d3t3c61.aspx)添加为[&lt;authentication&gt; 元素](https://msdn.microsoft.com/library/532aee0e.aspx)的子元素，并指定要自定义为类似于 XML 特性的属性值，如下所示：</span><span class="sxs-lookup"><span data-stu-id="20871-120">To modify the default values, add a [&lt;forms&gt; element](https://msdn.microsoft.com/library/1d3t3c61.aspx) as a child of the [&lt;authentication&gt; element](https://msdn.microsoft.com/library/532aee0e.aspx), specifying those property values you want to customize as XML attributes like so:</span></span>

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample1.xml)]

<span data-ttu-id="20871-121">表1汇总了可通过 &lt;窗体&gt; 元素自定义的属性。</span><span class="sxs-lookup"><span data-stu-id="20871-121">Table 1 summarizes the properties that can be customized through the &lt;forms&gt; element.</span></span> <span data-ttu-id="20871-122">由于 web.config 是一个 XML 文件，左栏中的属性名称区分大小写。</span><span class="sxs-lookup"><span data-stu-id="20871-122">Since Web.config is an XML file, the attribute names in the left column are case-sensitive.</span></span>

| <span data-ttu-id="20871-123"><strong>特性</strong></span><span class="sxs-lookup"><span data-stu-id="20871-123"><strong>Attribute</strong></span></span> |                                                                                                                                                                                                                                     <span data-ttu-id="20871-124"><strong>描述</strong></span><span class="sxs-lookup"><span data-stu-id="20871-124"><strong>Description</strong></span></span>                                                                                                                                                                                                                                      |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|         <span data-ttu-id="20871-125">无</span><span class="sxs-lookup"><span data-stu-id="20871-125">cookieless</span></span>         |                                                                                                                <span data-ttu-id="20871-126">此属性指定在什么条件下，在 cookie 中存储身份验证票证，而不是将其嵌入到 URL 中。</span><span class="sxs-lookup"><span data-stu-id="20871-126">This attribute specifies under what conditions the authentication ticket is stored in a cookie versus being embedded in the URL.</span></span> <span data-ttu-id="20871-127">允许的值为： UseCookies;UseUri;检测和 UseDeviceProfile （默认值）。</span><span class="sxs-lookup"><span data-stu-id="20871-127">Allowable values are: UseCookies; UseUri; AutoDetect; and UseDeviceProfile (the default).</span></span> <span data-ttu-id="20871-128">步骤2更详细地检查此设置。</span><span class="sxs-lookup"><span data-stu-id="20871-128">Step 2 examines this setting in more detail.</span></span>                                                                                                                |
|         <span data-ttu-id="20871-129">defaultUrl</span><span class="sxs-lookup"><span data-stu-id="20871-129">defaultUrl</span></span>         |                                                                                                                                                         <span data-ttu-id="20871-130">如果查询字符串中未指定 RedirectUrl 值，则指示从登录页登录后用户重定向到的 URL。</span><span class="sxs-lookup"><span data-stu-id="20871-130">Indicates the URL that users are redirected to after signing in from the login page if there is no RedirectUrl value specified in the querystring.</span></span> <span data-ttu-id="20871-131">默认值为 default.aspx。</span><span class="sxs-lookup"><span data-stu-id="20871-131">The default value is default.aspx.</span></span>                                                                                                                                                         |
|           <span data-ttu-id="20871-132">域</span><span class="sxs-lookup"><span data-stu-id="20871-132">domain</span></span>           | <span data-ttu-id="20871-133">使用基于 cookie 的身份验证票证时，此设置指定 cookie 的域值。</span><span class="sxs-lookup"><span data-stu-id="20871-133">When using cookie-based authentication tickets, this setting specifies the cookie s domain value.</span></span> <span data-ttu-id="20871-134">默认值为空字符串，这将使浏览器使用其发出的域（如 www.yourdomain.com）。</span><span class="sxs-lookup"><span data-stu-id="20871-134">The default value is an empty string, which causes the browser to use the domain from which it was issued (such as www.yourdomain.com).</span></span> <span data-ttu-id="20871-135">在这种情况下，在向子域发出请求（如 admin.yourdomain.com）时，<strong>不</strong>会发送 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-135">In this case, the cookie will <strong>not</strong> be sent when making requests to subdomains, such as admin.yourdomain.com.</span></span> <span data-ttu-id="20871-136">如果希望将 cookie 传递给所有子域，则需要自定义域属性将其设置为 yourdomain.com。</span><span class="sxs-lookup"><span data-stu-id="20871-136">If you want the cookie to be passed to all subdomains you need to customize the domain attribute setting it to yourdomain.com.</span></span> |
|  <span data-ttu-id="20871-137">enableCrossAppRedirects</span><span class="sxs-lookup"><span data-stu-id="20871-137">enableCrossAppRedirects</span></span>   |                                                                                                                                                                   <span data-ttu-id="20871-138">一个布尔值，指示在重定向到同一服务器上的其他 web 应用程序中的 Url 时是否记住经过身份验证的用户。</span><span class="sxs-lookup"><span data-stu-id="20871-138">A Boolean value indicating whether authenticated users are remembered when redirected to URLs in other web applications on the same server.</span></span> <span data-ttu-id="20871-139">默认值为 false。</span><span class="sxs-lookup"><span data-stu-id="20871-139">The default is false.</span></span>                                                                                                                                                                   |
|          <span data-ttu-id="20871-140">loginUrl</span><span class="sxs-lookup"><span data-stu-id="20871-140">loginUrl</span></span>          |                                                                                                                                                                                                                      <span data-ttu-id="20871-141">登录页的 URL。</span><span class="sxs-lookup"><span data-stu-id="20871-141">The URL of the login page.</span></span> <span data-ttu-id="20871-142">默认值为 login.aspx。</span><span class="sxs-lookup"><span data-stu-id="20871-142">The default value is login.aspx.</span></span>                                                                                                                                                                                                                      |
|            <span data-ttu-id="20871-143">NAME</span><span class="sxs-lookup"><span data-stu-id="20871-143">name</span></span>            |                                                                                                                                                                                                   <span data-ttu-id="20871-144">使用基于 cookie 的身份验证票证时，该 cookie 的名称。</span><span class="sxs-lookup"><span data-stu-id="20871-144">When using cookie-based authentication tickets, the name of the cookie.</span></span> <span data-ttu-id="20871-145">默认值为.ASPXAUTH.</span><span class="sxs-lookup"><span data-stu-id="20871-145">The default is .ASPXAUTH.</span></span>                                                                                                                                                                                                   |
|            <span data-ttu-id="20871-146">path</span><span class="sxs-lookup"><span data-stu-id="20871-146">path</span></span>            |                                                                             <span data-ttu-id="20871-147">使用基于 cookie 的身份验证票证时，此设置将指定 cookie 的 path 属性。</span><span class="sxs-lookup"><span data-stu-id="20871-147">When using cookie-based authentication tickets, this setting specifies the cookie s path attribute.</span></span> <span data-ttu-id="20871-148">使用 path 特性，开发人员可以将 cookie 的作用域限制为特定的目录层次结构。</span><span class="sxs-lookup"><span data-stu-id="20871-148">The path attribute enables a developer to limit the scope of a cookie to a particular directory hierarchy.</span></span> <span data-ttu-id="20871-149">默认值为/，通知浏览器将身份验证票证 cookie 发送到向域发出的任何请求。</span><span class="sxs-lookup"><span data-stu-id="20871-149">The default value is /, which informs the browser to send the authentication ticket cookie to any request made to the domain.</span></span>                                                                              |
|         <span data-ttu-id="20871-150">保护</span><span class="sxs-lookup"><span data-stu-id="20871-150">protection</span></span>         |                                                                                                                                            <span data-ttu-id="20871-151">指示用于保护 forms 身份验证票证的技术。</span><span class="sxs-lookup"><span data-stu-id="20871-151">Indicates what techniques are used to protect the forms authentication ticket.</span></span> <span data-ttu-id="20871-152">允许的值为： All （默认值）;密匙内容和验证。</span><span class="sxs-lookup"><span data-stu-id="20871-152">The allowable values are: All (the default); Encryption; None; and Validation.</span></span> <span data-ttu-id="20871-153">步骤3中详细讨论了这些设置。</span><span class="sxs-lookup"><span data-stu-id="20871-153">These settings are discussed in detail in Step 3.</span></span>                                                                                                                                            |
|         <span data-ttu-id="20871-154">requireSSL</span><span class="sxs-lookup"><span data-stu-id="20871-154">requireSSL</span></span>         |                                                                                                                                                                                <span data-ttu-id="20871-155">一个布尔值，指示是否需要 SSL 连接来传输身份验证 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-155">A Boolean value that indicates whether an SSL connection is required to transmit the authentication cookie.</span></span> <span data-ttu-id="20871-156">默认值为 False。</span><span class="sxs-lookup"><span data-stu-id="20871-156">The default value is false.</span></span>                                                                                                                                                                                |
|     <span data-ttu-id="20871-157">slidingExpiration</span><span class="sxs-lookup"><span data-stu-id="20871-157">slidingExpiration</span></span>      |                                                                                                 <span data-ttu-id="20871-158">一个布尔值，该值指示每次用户在单个会话期间访问站点时是否重置身份验证 cookie 的超时时间。</span><span class="sxs-lookup"><span data-stu-id="20871-158">A Boolean value that indicates whether the authentication cookie s timeout is reset each time the user visits the site during a single session.</span></span> <span data-ttu-id="20871-159">默认值为 true。</span><span class="sxs-lookup"><span data-stu-id="20871-159">The default value is true.</span></span> <span data-ttu-id="20871-160">"指定票证超时值" 部分更详细地讨论了身份验证票证超时策略。</span><span class="sxs-lookup"><span data-stu-id="20871-160">The authentication ticket timeout policy is discussed in more detail in the Specifying the Ticket s Timeout Value section.</span></span>                                                                                                 |
|          <span data-ttu-id="20871-161">超时</span><span class="sxs-lookup"><span data-stu-id="20871-161">timeout</span></span>           |                                                                                                                               <span data-ttu-id="20871-162">指定身份验证票证 cookie 过期的时间，以分钟为单位。</span><span class="sxs-lookup"><span data-stu-id="20871-162">Specifies the time, in minutes, after which the authentication ticket cookie expires.</span></span> <span data-ttu-id="20871-163">默认值为 30。</span><span class="sxs-lookup"><span data-stu-id="20871-163">The default value is 30.</span></span> <span data-ttu-id="20871-164">"指定票证超时值" 部分更详细地讨论了身份验证票证超时策略。</span><span class="sxs-lookup"><span data-stu-id="20871-164">The authentication ticket timeout policy is discussed in more detail in the Specifying the Ticket s Timeout Value section.</span></span>                                                                                                                               |

<span data-ttu-id="20871-165">**表 1**： &lt;窗体&gt; 元素属性的摘要</span><span class="sxs-lookup"><span data-stu-id="20871-165">**Table 1**: A Summary of the &lt;forms&gt; Element's Attributes</span></span>

<span data-ttu-id="20871-166">在 ASP.NET 2.0 和更高版本中，默认的窗体身份验证值在 .NET Framework 的 FormsAuthenticationConfiguration 类中进行硬编码。</span><span class="sxs-lookup"><span data-stu-id="20871-166">In ASP.NET 2.0 and beyond, the default forms authentication values are hard-coded in the FormsAuthenticationConfiguration class in the .NET Framework.</span></span> <span data-ttu-id="20871-167">在 web.config 文件中，必须逐个应用程序应用任何修改。</span><span class="sxs-lookup"><span data-stu-id="20871-167">Any modifications must be applied on an application-by-application basis in the Web.config file.</span></span> <span data-ttu-id="20871-168">这不同于 ASP.NET 1.x，其中默认的 forms 身份验证值存储在 machine.config 文件中（因此可以通过编辑 machine.config 进行修改）。</span><span class="sxs-lookup"><span data-stu-id="20871-168">This differs from ASP.NET 1.x, where the default forms authentication values were stored in the machine.config file (and could therefore be modified via editing machine.config).</span></span> <span data-ttu-id="20871-169">尽管在 ASP.NET 1.x 的主题中，有必要说，在 ASP.NET 2.0 和 ASP.NET 1.x 中，许多 forms 身份验证系统设置具有不同的默认值。</span><span class="sxs-lookup"><span data-stu-id="20871-169">While on the topic of ASP.NET 1.x, it is worthwhile to mention that a number of the forms authentication system settings have different default values in ASP.NET 2.0 and beyond than in ASP.NET 1.x.</span></span> <span data-ttu-id="20871-170">如果要从 ASP.NET 1.x 环境迁移应用程序，请务必了解这些差异。</span><span class="sxs-lookup"><span data-stu-id="20871-170">If you are migrating your application from an ASP.NET 1.x environment, it is important to be aware of these differences.</span></span> <span data-ttu-id="20871-171">有关差异列表，请参阅[&lt;窗体&gt; 元素技术文档](https://msdn.microsoft.com/library/1d3t3c61.aspx)。</span><span class="sxs-lookup"><span data-stu-id="20871-171">Consult [the &lt;forms&gt; element technical documentation](https://msdn.microsoft.com/library/1d3t3c61.aspx) for a list of the differences.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-172">多种 forms 身份验证设置（如超时、域和路径）为生成的 forms 身份验证票证 cookie 指定详细信息。</span><span class="sxs-lookup"><span data-stu-id="20871-172">Several forms authentication settings, such as the timeout, domain, and path, specify details for the resulting forms authentication ticket cookie.</span></span> <span data-ttu-id="20871-173">若要详细了解 cookie 及其工作原理，请阅读[此 cookie 教程](http://www.quirksmode.org/js/cookies.html)。</span><span class="sxs-lookup"><span data-stu-id="20871-173">For more information on cookies, how they work, and their various properties, read [this Cookies tutorial](http://www.quirksmode.org/js/cookies.html).</span></span>

### <a name="specifying-the-tickets-timeout-value"></a><span data-ttu-id="20871-174">指定票证的超时值</span><span class="sxs-lookup"><span data-stu-id="20871-174">Specifying the Ticket's Timeout Value</span></span>

<span data-ttu-id="20871-175">Forms 身份验证票证是表示标识的令牌。</span><span class="sxs-lookup"><span data-stu-id="20871-175">The forms authentication ticket is a token that represents an identity.</span></span> <span data-ttu-id="20871-176">通过基于 cookie 的身份验证票证，此令牌以 cookie 的形式保存，并在每个请求上发送到 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="20871-176">With cookie-based authentication tickets, this token is held in the form of a cookie and sent to the web server on each request.</span></span> <span data-ttu-id="20871-177">该令牌的所有权实质上是声明的，我是*用户名*，我已经登录了，并使用了，这样就可以在页面访问之间记住用户的标识。</span><span class="sxs-lookup"><span data-stu-id="20871-177">Possession of the token, in essence, declares, I am *username*, I have already logged in, and is used so that a user's identity can be remembered across page visits.</span></span>

<span data-ttu-id="20871-178">Forms 身份验证票证不仅包括用户的标识，还包含有助于确保令牌的完整性和安全性的信息。</span><span class="sxs-lookup"><span data-stu-id="20871-178">The forms authentication ticket not only includes the user's identity, but also contains information to help ensure the integrity and security of the token.</span></span> <span data-ttu-id="20871-179">毕竟，我们不希望恶意用户能够创建假冒令牌，或以某种 underhanded 的方式修改 legit 令牌。</span><span class="sxs-lookup"><span data-stu-id="20871-179">After all, we don't want a nefarious user to be able to create a counterfeit token, or to modify a legit token in some underhanded way.</span></span>

<span data-ttu-id="20871-180">票证中包含的一项信息是*过期*时间，即票证不再有效的日期和时间。</span><span class="sxs-lookup"><span data-stu-id="20871-180">One such bit of information included in the ticket is an *expiry*, which is the date and time the ticket is no longer valid.</span></span> <span data-ttu-id="20871-181">每次 FormsAuthenticationModule 检查一个身份验证票证时，它都会确保票证的到期时间尚未过。</span><span class="sxs-lookup"><span data-stu-id="20871-181">Each time the FormsAuthenticationModule inspects an authentication ticket, it ensures that the ticket's expiry has not yet passed.</span></span> <span data-ttu-id="20871-182">如果已存在，它将忽略票证，并将用户标识为匿名用户。</span><span class="sxs-lookup"><span data-stu-id="20871-182">If it has, it disregards the ticket and identifies the user as being anonymous.</span></span> <span data-ttu-id="20871-183">此安全措施有助于防止重放攻击。</span><span class="sxs-lookup"><span data-stu-id="20871-183">This safeguard helps protect against replay attacks.</span></span> <span data-ttu-id="20871-184">如果黑客能够亲自进入用户的有效身份验证票证（也许是通过获取其计算机的物理访问权限，并通过其 cookie 定位），就不会过期，他们可以使用此盗用的身份验证票证向服务器发送请求，获取项。</span><span class="sxs-lookup"><span data-stu-id="20871-184">Without an expiry, if a hacker was able to get her hands on a user's valid authentication ticket - perhaps by gaining physical access to their computer and rooting through their cookies - they could send a request to the server with this stolen authentication ticket and gain entry.</span></span> <span data-ttu-id="20871-185">尽管过期不会阻止这种情况发生，但它确实限制了此类攻击可以成功的窗口。</span><span class="sxs-lookup"><span data-stu-id="20871-185">While the expiry doesn't prevent this scenario, it does limit the window during which such an attack can succeed.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-186">步骤3详细说明 forms authentication 系统用来保护身份验证票证的其他技术。</span><span class="sxs-lookup"><span data-stu-id="20871-186">Step 3 details additional techniques used by the forms authentication system to protect the authentication ticket.</span></span>

<span data-ttu-id="20871-187">创建身份验证票证时，forms 身份验证系统通过查阅超时设置来确定其过期时间。</span><span class="sxs-lookup"><span data-stu-id="20871-187">When creating the authentication ticket, the forms authentication system determines its expiry by consulting the timeout setting.</span></span> <span data-ttu-id="20871-188">如表1所示，超时设置默认为30分钟，这意味着在创建 forms 身份验证票证时，其过期时间设置为将来的日期和时间30分钟。</span><span class="sxs-lookup"><span data-stu-id="20871-188">As noted in Table 1, the timeout setting defaults to 30 minutes, meaning that when the forms authentication ticket is created its expiry is set to a date and time 30 minutes in the future.</span></span>

<span data-ttu-id="20871-189">当表单身份验证票证到期时，到期定义将来的绝对时间。</span><span class="sxs-lookup"><span data-stu-id="20871-189">The expiry defines an absolute time in the future when the forms authentication ticket expires.</span></span> <span data-ttu-id="20871-190">但通常情况下，开发人员需要实现一个可调过期，每次用户回顾站点时都会重置。</span><span class="sxs-lookup"><span data-stu-id="20871-190">But usually developers want to implement a sliding expiry, one that is reset every time the user revisits the site.</span></span> <span data-ttu-id="20871-191">此行为由 slidingExpiration 设置确定。</span><span class="sxs-lookup"><span data-stu-id="20871-191">This behavior is determined by the slidingExpiration settings.</span></span> <span data-ttu-id="20871-192">如果设置为 true （默认值），则每次 FormsAuthenticationModule 对用户进行身份验证时，将更新票证的过期时间。</span><span class="sxs-lookup"><span data-stu-id="20871-192">If set to true (the default), each time the FormsAuthenticationModule authenticates a user, it updates the ticket's expiry.</span></span> <span data-ttu-id="20871-193">如果设置为 false，则不会对每个请求更新过期时间，从而导致票证的过期时间与首次创建票证时的超时时间完全相同。</span><span class="sxs-lookup"><span data-stu-id="20871-193">If set to false, the expiry is not updated on each request, thereby causing the ticket to expire exactly timeout number of minutes past when the ticket was first created.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-194">身份验证票证中存储的过期时间是一个绝对日期和时间值，如8月2日，2008 11:34 AM。</span><span class="sxs-lookup"><span data-stu-id="20871-194">The expiry stored in the authentication ticket is an absolute date and time value, like August 2, 2008 11:34 AM.</span></span> <span data-ttu-id="20871-195">而且，日期和时间是相对于 web 服务器的本地时间。</span><span class="sxs-lookup"><span data-stu-id="20871-195">Moreover, the date and time are relative to the web server's local time.</span></span> <span data-ttu-id="20871-196">此设计决策可能会对夏令时（DST）产生一些有趣的副作用，即，将美国中的时钟移到一小时后（假定 web 服务器在观察到夏令时的区域设置中）。</span><span class="sxs-lookup"><span data-stu-id="20871-196">This design decision can have some interesting side effects around Daylight Saving Time (DST), which is when clocks in the United States are moved ahead one hour (assuming the web server is hosted in a locale where Daylight Saving Time is observed).</span></span> <span data-ttu-id="20871-197">考虑在 DST 开始（上午2:00 点）接近30分钟过期后，ASP.NET 网站会发生什么情况。</span><span class="sxs-lookup"><span data-stu-id="20871-197">Consider what would happen for an ASP.NET website with a 30 minute expiry near the time that DST begins (which is at 2:00 AM).</span></span> <span data-ttu-id="20871-198">假设有一个访问者在2008年3月11日上午1:55 登录到网站。</span><span class="sxs-lookup"><span data-stu-id="20871-198">Imagine a visitor signs on to the site on March 11, 2008 at 1:55 AM.</span></span> <span data-ttu-id="20871-199">这会生成一个 forms 身份验证票证，该票证将于 2:25 2008 年3月11日（在未来30分钟）过期。</span><span class="sxs-lookup"><span data-stu-id="20871-199">This would generate a forms authentication ticket that expires at March 11, 2008 at 2:25 AM (30 minutes in the future).</span></span> <span data-ttu-id="20871-200">但是，在 2:00 AM 之后，时钟将跳转到 3:00 AM （由于 DST）。</span><span class="sxs-lookup"><span data-stu-id="20871-200">However, once 2:00 AM rolls around, the clock jumps to 3:00 AM because of DST.</span></span> <span data-ttu-id="20871-201">如果用户在登录后六分钟加载新页（上午3:01），则 FormsAuthenticationModule 会注意到票证已过期，并将用户重定向到登录页。</span><span class="sxs-lookup"><span data-stu-id="20871-201">When the user loads a new page six minutes after signing in (at 3:01 AM), the FormsAuthenticationModule notes that the ticket has expired and redirects the user to the login page.</span></span> <span data-ttu-id="20871-202">有关此和其他身份验证票证超时问题以及解决方法的详细讨论，请选择 Stefan Schackow 的*ASP.NET 2.0 安全性、成员身份和角色管理*的副本（ISBN：978-0-7645-9698-8）。</span><span class="sxs-lookup"><span data-stu-id="20871-202">For a more thorough discussion on this and other authentication ticket timeout oddities, as well as workarounds, pick up a copy of Stefan Schackow's *Professional ASP.NET 2.0 Security, Membership, and Role Management* (ISBN: 978-0-7645-9698-8).</span></span>

<span data-ttu-id="20871-203">图1说明了 slidingExpiration 设置为 false 时的工作流，而 timeout 设置为30。</span><span class="sxs-lookup"><span data-stu-id="20871-203">Figure 1 illustrates the workflow when slidingExpiration is set to false and timeout is set to 30.</span></span> <span data-ttu-id="20871-204">请注意，在登录时生成的身份验证票证包含过期日期，此值不会在后续请求上更新。</span><span class="sxs-lookup"><span data-stu-id="20871-204">Note that the authentication ticket generated at login contains the expiration date, and this value is not updated on subsequent requests.</span></span> <span data-ttu-id="20871-205">如果 FormsAuthenticationModule 发现票证已过期，则会将其丢弃并将请求视为匿名。</span><span class="sxs-lookup"><span data-stu-id="20871-205">If the FormsAuthenticationModule finds that the ticket has expired, it discards it and treats the request as anonymous.</span></span>

<span data-ttu-id="20871-206">[![slidingExpiration 为 false 时 Forms 身份验证票证到期的图形表示形式](forms-authentication-configuration-and-advanced-topics-vb/_static/image2.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="20871-206">[![A Graphical Representation of the Forms Authentication Ticket's Expiry When slidingExpiration is false](forms-authentication-configuration-and-advanced-topics-vb/_static/image2.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image1.png)</span></span>

<span data-ttu-id="20871-207">**图 01**： slidingExpiration 为 False 时 Forms 身份验证票证到期的图形表示形式（[单击以查看完全大小的映像](forms-authentication-configuration-and-advanced-topics-vb/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-207">**Figure 01**: A Graphical Representation of the Forms Authentication Ticket's Expiry When slidingExpiration is false ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image3.png))</span></span>

<span data-ttu-id="20871-208">图2显示了当 slidingExpiration 设置为 true 且 timeout 设置为30时的工作流。</span><span class="sxs-lookup"><span data-stu-id="20871-208">Figure 2 shows the workflow when slidingExpiration is set to true and timeout is set to 30.</span></span> <span data-ttu-id="20871-209">接收到身份验证的请求（具有非过期票证）后，其过期时间将更新到将来的超时分钟数。</span><span class="sxs-lookup"><span data-stu-id="20871-209">When an authenticated request is received (with a non-expired ticket) its expiry is updated to timeout number of minutes in the future.</span></span>

<span data-ttu-id="20871-210">[当 slidingExpiration 为 true 时，![Forms 身份验证票证的图形表示形式](forms-authentication-configuration-and-advanced-topics-vb/_static/image5.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="20871-210">[![A Graphical Representation of the Forms Authentication Ticket's When slidingExpiration is true](forms-authentication-configuration-and-advanced-topics-vb/_static/image5.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image4.png)</span></span>

<span data-ttu-id="20871-211">**图 02**： slidingExpiration 为 True 时 Forms 身份验证票证的图形表示形式（[单击以查看完全大小的图像](forms-authentication-configuration-and-advanced-topics-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-211">**Figure 02**: A Graphical Representation of the Forms Authentication Ticket's When slidingExpiration is true ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image6.png))</span></span>

<span data-ttu-id="20871-212">使用基于 cookie 的身份验证票证（默认值）时，此讨论就变得更加混乱，因为 cookie 还可以指定其自己的 expiries。</span><span class="sxs-lookup"><span data-stu-id="20871-212">When using cookie-based authentication tickets (the default), this discussion becomes a little more confusing because cookies can also have their own expiries specified.</span></span> <span data-ttu-id="20871-213">Cookie 的过期时间（或缺少此 cookie）会指示浏览器应销毁 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-213">A cookie's expiry (or lack thereof) instructs the browser when the cookie should be destroyed.</span></span> <span data-ttu-id="20871-214">如果 cookie 缺少过期时间，则会在浏览器关闭时销毁该 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-214">If the cookie lacks an expiry, it is destroyed when the browser shuts down.</span></span> <span data-ttu-id="20871-215">但是，如果存在过期，cookie 会一直存储在用户的计算机上，直到过期指定的日期和时间。</span><span class="sxs-lookup"><span data-stu-id="20871-215">If an expiry is present, however, the cookie remains stored on the user's computer until the date and time specified in the expiry has passed.</span></span> <span data-ttu-id="20871-216">当浏览器销毁 cookie 时，它将不再发送到 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="20871-216">When a cookie is destroyed by the browser, it is no longer sent to the web server.</span></span> <span data-ttu-id="20871-217">因此，cookie 的销毁类似于用户注销站点。</span><span class="sxs-lookup"><span data-stu-id="20871-217">Therefore, the destruction of a cookie is analogous to the user logging out of the site.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-218">当然，用户可以主动删除存储在计算机上的任何 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-218">Of course, a user may proactively remove any cookies stored on their computer.</span></span> <span data-ttu-id="20871-219">在 Internet Explorer 7 中，你将转到 "工具"、"选项"，然后单击 "浏览历史记录" 部分中的 "删除" 按钮。</span><span class="sxs-lookup"><span data-stu-id="20871-219">In Internet Explorer 7, you would go to Tools, Options, and click the Delete button in the Browsing history section.</span></span> <span data-ttu-id="20871-220">在该处单击 "删除 cookie" 按钮。</span><span class="sxs-lookup"><span data-stu-id="20871-220">From there, click the Delete cookies button.</span></span>

<span data-ttu-id="20871-221">Forms 身份验证系统根据传入到*persistCookie*参数的值创建基于会话或基于过期的 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-221">The forms authentication system creates session-based or expiry-based cookies depending on the value passed in to the *persistCookie* parameter.</span></span> <span data-ttu-id="20871-222">回忆一下，FormsAuthentication 类的 GetAuthCookie、SetAuthCookie 和 Formsauthentication.redirectfromloginpage 方法采用两个输入参数： *username*和*persistCookie*。</span><span class="sxs-lookup"><span data-stu-id="20871-222">Recall that the FormsAuthentication class's GetAuthCookie, SetAuthCookie, and RedirectFromLoginPage methods take in two input parameters: *username* and *persistCookie*.</span></span> <span data-ttu-id="20871-223">在前面的教程中创建的登录页面包含一个 "记住我" 复选框，该复选框确定是否创建了持久性 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-223">The login page we created in the preceding tutorial included a Remember me CheckBox, which determined whether a persistent cookie was created.</span></span> <span data-ttu-id="20871-224">永久性 cookie 基于过期;非持久性 cookie 是基于会话的。</span><span class="sxs-lookup"><span data-stu-id="20871-224">Persistent cookies are expiry-based; non-persistent cookies are session-based.</span></span>

<span data-ttu-id="20871-225">已讨论的超时和 slidingExpiration 概念对基于会话和过期的 cookie 同样适用。</span><span class="sxs-lookup"><span data-stu-id="20871-225">The timeout and slidingExpiration concepts already discussed apply the same to both session- and expiry-based cookies.</span></span> <span data-ttu-id="20871-226">在执行过程中只有一个细微差异：在将 slidingTimeout 设置为 true 时使用基于过期的 cookie 时，仅当超过指定时间的一半时才会更新 cookie 的过期时间。</span><span class="sxs-lookup"><span data-stu-id="20871-226">There is only one minor difference in execution: when using expiry-based cookies with slidingTimeout set to true, the cookie's expiry is only updated when more than half of the specified time has elapsed.</span></span>

<span data-ttu-id="20871-227">让我们更新网站的身份验证票证超时策略，以便在一小时（60分钟）后使用滑动过期时间超时。</span><span class="sxs-lookup"><span data-stu-id="20871-227">Let's update our website's authentication ticket timeout policies so that tickets timeout after one hour (60 minutes), using a sliding expiration.</span></span> <span data-ttu-id="20871-228">若要使此更改生效，请更新 Web.config 文件，将 &lt;窗体&gt; 元素添加到具有以下标记的 &lt;authentication&gt; 元素：</span><span class="sxs-lookup"><span data-stu-id="20871-228">To effect this change, update the Web.config file, adding a &lt;forms&gt; element to the &lt;authentication&gt; element with the following markup:</span></span>

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample2.xml)]

### <a name="using-an-login-page-url-other-than-loginaspx"></a><span data-ttu-id="20871-229">使用除 Login 以外的登录页 URL</span><span class="sxs-lookup"><span data-stu-id="20871-229">Using an Login Page URL Other than Login.aspx</span></span>

<span data-ttu-id="20871-230">由于 FormsAuthenticationModule 会自动将未经授权的用户重定向到登录页，因此它需要知道登录页的 URL。</span><span class="sxs-lookup"><span data-stu-id="20871-230">Since the FormsAuthenticationModule automatically redirects unauthorized users to the login page, it needs to know the login page's URL.</span></span> <span data-ttu-id="20871-231">此 URL 由 &lt;窗体&gt; 元素中的 loginUrl 属性指定，并且默认为登录 .aspx。</span><span class="sxs-lookup"><span data-stu-id="20871-231">This URL is specified by the loginUrl attribute in the &lt;forms&gt; element and defaults to login.aspx.</span></span> <span data-ttu-id="20871-232">如果要在现有网站上进行迁移，则可能已经有一个具有不同 URL 的登录页面，搜索引擎已将这些页面设置为书签并进行索引。</span><span class="sxs-lookup"><span data-stu-id="20871-232">If you are porting over an existing website, you may already have a login page with a different URL, one that has already been bookmarked and indexed by search engines.</span></span> <span data-ttu-id="20871-233">您可以改为将 loginUrl 属性修改为指向登录页，而不是将您的现有登录页重命名为 .aspx 并断开链接和用户的书签。</span><span class="sxs-lookup"><span data-stu-id="20871-233">Rather than renaming your existing login page to login.aspx and breaking links and users' bookmarks, you can instead modify the loginUrl attribute to point to your login page.</span></span>

<span data-ttu-id="20871-234">例如，如果您的登录页命名为 login .aspx 并且位于用户目录中，则可以将 loginUrl 配置设置指向 ~/Users/SignIn.aspx，如下所示：</span><span class="sxs-lookup"><span data-stu-id="20871-234">For example, if your login page was named SignIn.aspx and was located in the Users directory, you could point the loginUrl configuration setting to ~/Users/SignIn.aspx like so:</span></span>

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample3.xml)]

<span data-ttu-id="20871-235">由于当前应用程序已经有一个名为 "Login" 的登录页，因此无需在 &lt;窗体&gt; 元素中指定自定义值。</span><span class="sxs-lookup"><span data-stu-id="20871-235">Since our current application already has a login page named Login.aspx, there's no need to specify a custom value in the &lt;forms&gt; element.</span></span>

## <a name="step-2-using-cookieless-forms-authentication-tickets"></a><span data-ttu-id="20871-236">步骤2：使用无 Cookie Forms 身份验证票证</span><span class="sxs-lookup"><span data-stu-id="20871-236">Step 2: Using Cookieless Forms Authentication Tickets</span></span>

<span data-ttu-id="20871-237">默认情况下，窗体身份验证系统将确定是将其身份验证票证存储在 cookie 集合中，还是将其嵌入到基于访问站点的用户代理的 URL 中。</span><span class="sxs-lookup"><span data-stu-id="20871-237">By default the forms authentication system determines whether to store its authentication tickets in the cookies collection or embed them in the URL based on the user agent visiting the site.</span></span> <span data-ttu-id="20871-238">所有主流桌面浏览器（如 Internet Explorer、Firefox、Opera 和 Safari）都支持 cookie，但并非所有移动设备都支持。</span><span class="sxs-lookup"><span data-stu-id="20871-238">All mainstream desktop browsers like Internet Explorer, Firefox, Opera, and Safari, support cookies, but not all mobile devices do.</span></span>

<span data-ttu-id="20871-239">Forms 身份验证系统使用的 cookie 策略取决于 &lt;窗体&gt; 元素中的无 cookie 设置，可以为其分配以下四个值之一：</span><span class="sxs-lookup"><span data-stu-id="20871-239">The cookie policy used by the forms authentication system depends on the cookieless setting in the &lt;forms&gt; element, which can be assigned one of four values:</span></span>

- <span data-ttu-id="20871-240">UseCookies-指定将始终使用基于 cookie 的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-240">UseCookies - specifies that cookie-based authentication tickets will always be used.</span></span>
- <span data-ttu-id="20871-241">UseUri-指示将从不使用基于 cookie 的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-241">UseUri - indicates that cookie-based authentication tickets will never be used.</span></span>
- <span data-ttu-id="20871-242">自动检测-如果设备配置文件不支持 cookie，则不使用基于 cookie 的身份验证票证;如果设备配置文件支持 cookie，则使用探测机制来确定是否启用了 cookie。</span><span class="sxs-lookup"><span data-stu-id="20871-242">AutoDetect - if the device profile does not support cookies, cookie-based authentication tickets are not used; if the device profile supports cookies, a probing mechanism is used to determine if cookies are enabled.</span></span>
- <span data-ttu-id="20871-243">UseDeviceProfile-默认值;如果设备配置文件支持 cookie，则使用基于 cookie 的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-243">UseDeviceProfile - the default; uses cookie-based authentication tickets only if the device profile supports cookies.</span></span> <span data-ttu-id="20871-244">不使用探测机制。</span><span class="sxs-lookup"><span data-stu-id="20871-244">No probing mechanism is used.</span></span>

<span data-ttu-id="20871-245">自动检测和 UseDeviceProfile 设置依赖于认定中的*设备配置文件*，无论使用基于 cookie 还是无 cookie 身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-245">The AutoDetect and UseDeviceProfile settings rely on a *device profile* in ascertaining whether to use cookie-based or cookieless authentication tickets.</span></span> <span data-ttu-id="20871-246">ASP.NET 维护各种设备及其功能的数据库，例如它们是否支持 cookie、它们支持的 JavaScript 版本等。</span><span class="sxs-lookup"><span data-stu-id="20871-246">ASP.NET maintains a database of various devices and their capabilities, such as whether they support cookies, what version of JavaScript they support, and so on.</span></span> <span data-ttu-id="20871-247">每次设备从 web 服务器请求网页时，它将沿标识设备类型的*用户代理*HTTP 标头进行发送。</span><span class="sxs-lookup"><span data-stu-id="20871-247">Each time a device requests a web page from a web server it sends along a *user-agent* HTTP header that identifies the device type.</span></span> <span data-ttu-id="20871-248">ASP.NET 自动将提供的用户代理字符串与在其数据库中指定的相应配置文件进行匹配。</span><span class="sxs-lookup"><span data-stu-id="20871-248">ASP.NET automatically matches the supplied user-agent string with the corresponding profile specified in its database.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-249">此设备功能数据库存储在多个符合[浏览器定义文件架构](https://msdn.microsoft.com/library/ms228122.aspx)的 XML 文件中。</span><span class="sxs-lookup"><span data-stu-id="20871-249">This database of device capabilities is stored in a number of XML files that adhere to the [Browser Definition File schema](https://msdn.microsoft.com/library/ms228122.aspx).</span></span> <span data-ttu-id="20871-250">默认设备配置文件位于%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG\Browsers. 中。</span><span class="sxs-lookup"><span data-stu-id="20871-250">The default device profile files are located in %WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG\Browsers.</span></span> <span data-ttu-id="20871-251">你还可以将自定义文件添加到应用程序\_浏览器 "文件夹中。</span><span class="sxs-lookup"><span data-stu-id="20871-251">You can also add custom files to your application's App\_Browsers folder.</span></span> <span data-ttu-id="20871-252">有关详细信息，请参阅[如何：在 ASP.NET 网页中检测浏览器类型](https://msdn.microsoft.com/library/3yekbd5b.aspx)。</span><span class="sxs-lookup"><span data-stu-id="20871-252">For more information, see [How To: Detect Browser Types in ASP.NET Web Pages](https://msdn.microsoft.com/library/3yekbd5b.aspx).</span></span>

<span data-ttu-id="20871-253">由于默认设置为 UseDeviceProfile，因此当站点被其配置文件报告不支持 cookie 的设备访问该站点时，将使用无 cookie forms 身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-253">Because the default setting is UseDeviceProfile, cookieless forms authentication tickets will be used when the site is visited by a device whose profile reports that it does not support cookies.</span></span>

### <a name="encoding-the-authentication-ticket-in-the-url"></a><span data-ttu-id="20871-254">编码 URL 中的身份验证票证</span><span class="sxs-lookup"><span data-stu-id="20871-254">Encoding the Authentication Ticket in the URL</span></span>

<span data-ttu-id="20871-255">Cookie 是将每个请求中的信息从浏览器中包括到特定网站的自然媒介，这就是默认表单身份验证设置在访问设备支持 cookie 时使用 cookie 的原因。</span><span class="sxs-lookup"><span data-stu-id="20871-255">Cookies are a natural medium for including information from the browser in each request to a particular website, which is why the default forms authentication settings use cookies if the visiting device supports them.</span></span> <span data-ttu-id="20871-256">如果不支持 cookie，则必须采用备用方法将身份验证票证从客户端传递到服务器。</span><span class="sxs-lookup"><span data-stu-id="20871-256">If cookies are not supported, an alternate means for passing the authentication ticket from the client to the server must be employed.</span></span> <span data-ttu-id="20871-257">在无 cookie 环境中使用的常见解决方法是在 URL 中编码 cookie 数据。</span><span class="sxs-lookup"><span data-stu-id="20871-257">A common workaround used in cookieless environments is to encode the cookie data in the URL.</span></span>

<span data-ttu-id="20871-258">若要查看如何将此类信息嵌入 URL，最佳方法是强制站点使用无 cookie 的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-258">The best way to see how such information can be embedded within the URL is to force the site to use cookieless authentication tickets.</span></span> <span data-ttu-id="20871-259">为此，可将无 cookie 的配置设置设置为 UseUri：</span><span class="sxs-lookup"><span data-stu-id="20871-259">This can be accomplished by setting the cookieless configuration setting to UseUri:</span></span>

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample4.xml)]

<span data-ttu-id="20871-260">做出此更改后，请通过浏览器访问站点。</span><span class="sxs-lookup"><span data-stu-id="20871-260">Once you have made this change, visit the site through a browser.</span></span> <span data-ttu-id="20871-261">作为匿名用户访问时，Url 看起来就像以前一样。</span><span class="sxs-lookup"><span data-stu-id="20871-261">When visiting as an anonymous user, the URLs will look exactly like they did before.</span></span> <span data-ttu-id="20871-262">例如，在访问 default.aspx 页面时，浏览器的地址栏会显示以下 URL：</span><span class="sxs-lookup"><span data-stu-id="20871-262">For example, when visiting Default.aspx page my browser's address bar shows the following URL:</span></span>

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/default.aspx`

<span data-ttu-id="20871-263">但是，登录后，表单身份验证票证将嵌入到 URL 中。</span><span class="sxs-lookup"><span data-stu-id="20871-263">However, upon logging in, the forms authentication ticket is embedded into the URL.</span></span> <span data-ttu-id="20871-264">例如，在访问登录页并以 Sam 身份登录后，我将返回到 default.aspx 页，但这一次，URL 如下：</span><span class="sxs-lookup"><span data-stu-id="20871-264">For example, after visiting the login page and logging in as Sam, I am returned to the Default.aspx page, but the URL this time is:</span></span>

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/default.aspx`

<span data-ttu-id="20871-265">Forms 身份验证票证已嵌入到 URL 中。</span><span class="sxs-lookup"><span data-stu-id="20871-265">The forms authentication ticket has been embedded within the URL.</span></span> <span data-ttu-id="20871-266">字符串（F （jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2）表示十六进制编码的身份验证票证信息，并且是通常存储在 cookie 内的相同数据。</span><span class="sxs-lookup"><span data-stu-id="20871-266">The string (F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2) represents the hex-encoded authentication ticket information, and is the same data that is usually stored within a cookie.</span></span>

<span data-ttu-id="20871-267">为了使无 cookie 身份验证票证正常工作，系统必须对页面上的所有 Url 进行编码以包括身份验证票证数据，否则当用户单击链接时，身份验证票证将丢失。</span><span class="sxs-lookup"><span data-stu-id="20871-267">In order for cookieless authentication tickets to work, the system must encode all URLs on the page to include the authentication ticket data, otherwise the authentication ticket will be lost when the user clicks on a link.</span></span> <span data-ttu-id="20871-268">令人欣慰，此嵌入逻辑将自动执行。</span><span class="sxs-lookup"><span data-stu-id="20871-268">Thankfully, this embedding logic is performed automatically.</span></span> <span data-ttu-id="20871-269">若要演示此功能，请打开 default.aspx 页并添加一个超链接控件，并将其 Text 和 NavigateUrl 属性设置为 Test Link and SomePage。</span><span class="sxs-lookup"><span data-stu-id="20871-269">To demonstrate this functionality, open the Default.aspx page and add a HyperLink control, setting its Text and NavigateUrl properties to Test Link and SomePage.aspx, respectively.</span></span> <span data-ttu-id="20871-270">不重要的是，我们的项目中不存在名为 SomePage 的页。</span><span class="sxs-lookup"><span data-stu-id="20871-270">It doesn't matter that there really isn't a page in our project named SomePage.aspx.</span></span>

<span data-ttu-id="20871-271">保存对 default.aspx 的更改，然后通过浏览器进行访问。</span><span class="sxs-lookup"><span data-stu-id="20871-271">Save the changes to Default.aspx and then visit it through a browser.</span></span> <span data-ttu-id="20871-272">登录到站点，使 forms 身份验证票证嵌入到 URL 中。</span><span class="sxs-lookup"><span data-stu-id="20871-272">Log on to the site so that the forms authentication ticket is embedded in the URL.</span></span> <span data-ttu-id="20871-273">接下来，从 default.aspx，单击 "测试链接" 链接。</span><span class="sxs-lookup"><span data-stu-id="20871-273">Next, from Default.aspx, click the Test Link link.</span></span> <span data-ttu-id="20871-274">这是怎么回事？</span><span class="sxs-lookup"><span data-stu-id="20871-274">What happened?</span></span> <span data-ttu-id="20871-275">如果不存在名为 SomePage 的页，则会出现404错误，但此处不重要。</span><span class="sxs-lookup"><span data-stu-id="20871-275">If no page named SomePage.aspx exists, then a 404 error occurred, but that's not what's important here.</span></span> <span data-ttu-id="20871-276">而是在浏览器的地址栏上重点介绍。</span><span class="sxs-lookup"><span data-stu-id="20871-276">Instead, focus on the Address bar in your browser.</span></span> <span data-ttu-id="20871-277">请注意，它在 URL 中包含 forms 身份验证票证！</span><span class="sxs-lookup"><span data-stu-id="20871-277">Note that it includes the forms authentication ticket in the URL!</span></span>

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/SomePage.aspx`

<span data-ttu-id="20871-278">链接中的 URL SomePage 已自动转换为包含身份验证票证的 URL-我们无需编写代码的舔！</span><span class="sxs-lookup"><span data-stu-id="20871-278">The URL SomePage.aspx in the link was automatically converted into a URL that included the authentication ticket - we didn't have to write a lick of code!</span></span> <span data-ttu-id="20871-279">对于不以 http://或/开头的任何超链接，将自动在 URL 中嵌入表单身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-279">The form authentication ticket will automatically be embedded in the URL for any hyperlinks that do not start with http:// or /.</span></span> <span data-ttu-id="20871-280">如果超链接出现在对响应的调用中，则不重要。重定向、超链接控件或定位点 HTML 元素（即 &lt;href = "..."&gt;...&lt;/a&gt;）。</span><span class="sxs-lookup"><span data-stu-id="20871-280">It doesn't matter if the hyperlink appears in a call to Response.Redirect, in a HyperLink control, or in an anchor HTML element (i.e., &lt;a href="..."&gt;...&lt;/a&gt;).</span></span> <span data-ttu-id="20871-281">只要 URL 不像 http://www.someserver.com/SomePage.aspx 或/SomePage.aspx，就会嵌入 forms 身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-281">As long as the URL isn't something like http://www.someserver.com/SomePage.aspx or /SomePage.aspx, the forms authentication ticket will be embedded for us.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-282">无 cookie forms 身份验证票证遵循与基于 cookie 的身份验证票证相同的超时策略。</span><span class="sxs-lookup"><span data-stu-id="20871-282">Cookieless forms authentication tickets adhere to the same timeout policies as cookie-based authentication tickets.</span></span> <span data-ttu-id="20871-283">但是，无 cookie 身份验证票证更容易重播攻击，因为身份验证票证直接嵌入 URL。</span><span class="sxs-lookup"><span data-stu-id="20871-283">However, cookieless authentication tickets are more prone to replay attacks since the authentication ticket is embedded directly in the URL.</span></span> <span data-ttu-id="20871-284">假设访问某个网站的用户登录，然后将其电子邮件中的 URL 粘贴到同事。</span><span class="sxs-lookup"><span data-stu-id="20871-284">Imagine a user who visits a website, logs in, and then pastes the URL in an email to a colleague.</span></span> <span data-ttu-id="20871-285">如果同事在达到过期之前单击了该链接，他们将以发送电子邮件的用户身份登录！</span><span class="sxs-lookup"><span data-stu-id="20871-285">If the colleague clicks on that link before the expiry is reached, they will be logged in as the user who sent the email!</span></span>

## <a name="step-3-securing-the-authentication-ticket"></a><span data-ttu-id="20871-286">步骤3：保护身份验证票证</span><span class="sxs-lookup"><span data-stu-id="20871-286">Step 3: Securing the Authentication Ticket</span></span>

<span data-ttu-id="20871-287">Forms 身份验证票证是通过网络传输的，无论是在 cookie 中还是直接嵌入在 URL 中。</span><span class="sxs-lookup"><span data-stu-id="20871-287">The forms authentication ticket is transmitted over the wire either in a cookie or embedded directly within the URL.</span></span> <span data-ttu-id="20871-288">除了标识信息，身份验证票证还可以包含用户数据（如我们将在步骤4中看到的那样）。</span><span class="sxs-lookup"><span data-stu-id="20871-288">In addition to identity information, the authentication ticket can also include user data (as we will see in Step 4).</span></span> <span data-ttu-id="20871-289">因此，对票证的数据进行加密非常重要，因为 forms 身份验证系统可以保证票证不被篡改，这一点更重要。</span><span class="sxs-lookup"><span data-stu-id="20871-289">Consequently, it is important that the ticket's data is encrypted from prying eyes and (even more importantly) that the forms authentication system can guarantee that the ticket was not tampered with.</span></span>

<span data-ttu-id="20871-290">为了确保票证的数据的隐私，表单身份验证系统可以加密票证数据。</span><span class="sxs-lookup"><span data-stu-id="20871-290">To ensure the privacy of the ticket's data, the forms authentication system can encrypt the ticket data.</span></span> <span data-ttu-id="20871-291">未能加密票证数据会以纯文本格式通过网络发送潜在的敏感信息。</span><span class="sxs-lookup"><span data-stu-id="20871-291">Failure to encrypt the ticket data sends potentially sensitive information over the wire in plain-text.</span></span>

<span data-ttu-id="20871-292">为了保证票证的真实性，forms authentication 系统必须*验证*该票证。</span><span class="sxs-lookup"><span data-stu-id="20871-292">To guarantee a ticket's authenticity, the forms authentication system must *validate* the ticket.</span></span> <span data-ttu-id="20871-293">验证是指确保一段特定的数据未修改，并通过 *[消息身份验证代码（MAC）](http://en.wikipedia.org/wiki/Message_authentication_code)* 来实现的行为。</span><span class="sxs-lookup"><span data-stu-id="20871-293">Validation is the act of ensuring that a particular piece of data has not been modified, and is accomplished via a *[message authentication code (MAC)](http://en.wikipedia.org/wiki/Message_authentication_code)*.</span></span> <span data-ttu-id="20871-294">简而言之，MAC 是一小部分信息，用于标识需要验证的数据（在本例中为票据）。</span><span class="sxs-lookup"><span data-stu-id="20871-294">In a nutshell, the MAC is a small piece of information that identifies the data that needs to be validated (in this case, the ticket).</span></span> <span data-ttu-id="20871-295">如果修改了 MAC 表示的数据，则 MAC 和数据将不会匹配。</span><span class="sxs-lookup"><span data-stu-id="20871-295">If the data represented by the MAC is modified, then the MAC and the data will not match up.</span></span> <span data-ttu-id="20871-296">此外，为黑客提供一项计算工作来修改数据并生成自己的 MAC 以与修改后的数据相对应。</span><span class="sxs-lookup"><span data-stu-id="20871-296">Moreover, it is computationally hard for a hacker to both modify the data and generate his own MAC to correspond with the modified data.</span></span>

<span data-ttu-id="20871-297">在创建（或修改）票证时，forms 身份验证系统将创建一个 MAC 并将其附加到票证的数据上。</span><span class="sxs-lookup"><span data-stu-id="20871-297">When creating (or modifying) a ticket, the forms authentication system creates a MAC and attaches it to the ticket's data.</span></span> <span data-ttu-id="20871-298">当后续请求到达时，forms 身份验证系统会比较 MAC 和票证数据，以验证票证数据的真实性。</span><span class="sxs-lookup"><span data-stu-id="20871-298">When a subsequent request arrives, the forms authentication system compares the MAC and ticket data to validate the authenticity of the ticket data.</span></span> <span data-ttu-id="20871-299">图3以图形方式说明了此工作流。</span><span class="sxs-lookup"><span data-stu-id="20871-299">Figure 3 illustrates this workflow graphically.</span></span>

<span data-ttu-id="20871-300">[![通过 MAC 确保票证的真实性](forms-authentication-configuration-and-advanced-topics-vb/_static/image8.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="20871-300">[![The Ticket's Authenticity is Ensured through a MAC](forms-authentication-configuration-and-advanced-topics-vb/_static/image8.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image7.png)</span></span>

<span data-ttu-id="20871-301">**图 03**：通过 MAC 确保票证的真实性（[单击以查看完全大小的映像](forms-authentication-configuration-and-advanced-topics-vb/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-301">**Figure 03**: The Ticket's Authenticity is Ensured through a MAC ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image9.png))</span></span>

<span data-ttu-id="20871-302">应用于身份验证票证的安全措施取决于 &lt;forms&gt; 元素中的保护设置。</span><span class="sxs-lookup"><span data-stu-id="20871-302">What security measures are applied to the authentication ticket depends on the protection setting in the &lt;forms&gt; element.</span></span> <span data-ttu-id="20871-303">可以将保护设置分配给以下三个值之一：</span><span class="sxs-lookup"><span data-stu-id="20871-303">The protection setting may be assigned to one of the following three values:</span></span>

- <span data-ttu-id="20871-304">所有-票证都是加密和数字签名（默认值）。</span><span class="sxs-lookup"><span data-stu-id="20871-304">All - the ticket is both encrypted and digitally signed (the default).</span></span>
- <span data-ttu-id="20871-305">应用仅加密加密-不生成 MAC。</span><span class="sxs-lookup"><span data-stu-id="20871-305">Encryption - only encryption is applied - no MAC is generated.</span></span>
- <span data-ttu-id="20871-306">无-不加密票证，也不进行数字签名。</span><span class="sxs-lookup"><span data-stu-id="20871-306">None - the ticket is neither encrypted nor digitally signed.</span></span>
- <span data-ttu-id="20871-307">验证-生成 MAC，但票证数据是以纯文本格式通过网络发送的。</span><span class="sxs-lookup"><span data-stu-id="20871-307">Validation - a MAC is generated, but the ticket data is sent over the wire in plain-text.</span></span>

<span data-ttu-id="20871-308">Microsoft 强烈建议使用 "全部" 设置。</span><span class="sxs-lookup"><span data-stu-id="20871-308">Microsoft strongly recommends using the All setting.</span></span>

### <a name="setting-the-validation-and-decryption-keys"></a><span data-ttu-id="20871-309">设置验证密钥和解密密钥</span><span class="sxs-lookup"><span data-stu-id="20871-309">Setting the Validation and Decryption Keys</span></span>

<span data-ttu-id="20871-310">Forms authentication 系统用来加密和验证身份验证票证的加密和哈希算法可通过 Web.config 中[&lt;machineKey&gt; 元素](https://msdn.microsoft.com/library/w8h3skw9.aspx)进行自定义。表2列出了 &lt;machineKey&gt; 元素的属性及其可能的值。</span><span class="sxs-lookup"><span data-stu-id="20871-310">The encryption and hashing algorithms used by the forms authentication system to encrypt and validate the authentication ticket are customizable through the [&lt;machineKey&gt; element](https://msdn.microsoft.com/library/w8h3skw9.aspx) in Web.config. Table 2 outlines the &lt;machineKey&gt; element's attributes and their possible values.</span></span>

| <span data-ttu-id="20871-311">**特性**</span><span class="sxs-lookup"><span data-stu-id="20871-311">**Attribute**</span></span> | <span data-ttu-id="20871-312">**描述**</span><span class="sxs-lookup"><span data-stu-id="20871-312">**Description**</span></span> |
| --- | --- |
| <span data-ttu-id="20871-313">解密</span><span class="sxs-lookup"><span data-stu-id="20871-313">decryption</span></span> | <span data-ttu-id="20871-314">指示用于加密的算法。</span><span class="sxs-lookup"><span data-stu-id="20871-314">Indicates the algorithm used for encryption.</span></span> <span data-ttu-id="20871-315">此属性可以具有以下四个值之一：-Auto-默认值;确定基于 decryptionKey 属性长度的算法。</span><span class="sxs-lookup"><span data-stu-id="20871-315">This attribute can have one of the following four values: - Auto - the default; determines the algorithm based on the length of the decryptionKey attribute.</span></span> <span data-ttu-id="20871-316">-AES-使用[高级加密标准（AES）](http://en.wikipedia.org/wiki/Advanced_Encryption_Standard)算法。</span><span class="sxs-lookup"><span data-stu-id="20871-316">- AES - uses the [Advanced Encryption Standard (AES)](http://en.wikipedia.org/wiki/Advanced_Encryption_Standard) algorithm.</span></span> <span data-ttu-id="20871-317">-DES-使用[数据加密标准（DES）](http://en.wikipedia.org/wiki/Data_Encryption_Standard)此算法被视为计算弱，不应使用。</span><span class="sxs-lookup"><span data-stu-id="20871-317">- DES - uses the [Data Encryption Standard (DES)](http://en.wikipedia.org/wiki/Data_Encryption_Standard) This algorithm is considered computationally weak and should not be used.</span></span> <span data-ttu-id="20871-318">-3DES-使用三重[des 算法，该算法通过](http://en.wikipedia.org/wiki/Triple_DES)应用 DES 算法三次来运行。</span><span class="sxs-lookup"><span data-stu-id="20871-318">- 3DES - uses the [Triple DES](http://en.wikipedia.org/wiki/Triple_DES) algorithm, which works by applying the DES algorithm three times.</span></span> |
| <span data-ttu-id="20871-319">decryptionKey</span><span class="sxs-lookup"><span data-stu-id="20871-319">decryptionKey</span></span> | <span data-ttu-id="20871-320">加密算法使用的密钥。</span><span class="sxs-lookup"><span data-stu-id="20871-320">The secret key used by the encryption algorithm.</span></span> <span data-ttu-id="20871-321">此值必须是适当长度的十六进制字符串（基于解密的值）、自动生成或追加的值 IsolateApps。</span><span class="sxs-lookup"><span data-stu-id="20871-321">This value must either be a hexadecimal string of the appropriate length (based on the value in decryption), AutoGenerate, or either value appended with,IsolateApps.</span></span> <span data-ttu-id="20871-322">添加 IsolateApps 将指示 ASP.NET 为每个应用程序使用唯一值。</span><span class="sxs-lookup"><span data-stu-id="20871-322">Adding IsolateApps instructs ASP.NET to use a unique value for each application.</span></span> <span data-ttu-id="20871-323">默认值为自动生成 IsolateApps。</span><span class="sxs-lookup"><span data-stu-id="20871-323">The default is AutoGenerate,IsolateApps.</span></span> |
| <span data-ttu-id="20871-324">验证</span><span class="sxs-lookup"><span data-stu-id="20871-324">validation</span></span> | <span data-ttu-id="20871-325">指示用于验证的算法。</span><span class="sxs-lookup"><span data-stu-id="20871-325">Indicates the algorithm used for validation.</span></span> <span data-ttu-id="20871-326">此属性可以具有以下四个值之一：-AES-使用高级加密标准（AES）算法。</span><span class="sxs-lookup"><span data-stu-id="20871-326">This attribute can have one of the following four values: - AES - uses the Advanced Encryption Standard (AES) algorithm.</span></span> <span data-ttu-id="20871-327">-MD5-使用[消息摘要5（MD5）](http://en.wikipedia.org/wiki/MD5)算法。</span><span class="sxs-lookup"><span data-stu-id="20871-327">- MD5 - uses the [Message-Digest 5 (MD5)](http://en.wikipedia.org/wiki/MD5) algorithm.</span></span> <span data-ttu-id="20871-328">-SHA1-使用[sha1](http://en.wikipedia.org/wiki/Sha1)算法（默认值）。</span><span class="sxs-lookup"><span data-stu-id="20871-328">- SHA1 - uses the [SHA1](http://en.wikipedia.org/wiki/Sha1) algorithm (the default).</span></span> <span data-ttu-id="20871-329">-3DES-使用三重 DES 算法。</span><span class="sxs-lookup"><span data-stu-id="20871-329">- 3DES - uses the Triple DES algorithm.</span></span> |
| <span data-ttu-id="20871-330">validationKey</span><span class="sxs-lookup"><span data-stu-id="20871-330">validationKey</span></span> | <span data-ttu-id="20871-331">验证算法使用的机密密钥。</span><span class="sxs-lookup"><span data-stu-id="20871-331">The secret key used by the validation algorithm.</span></span> <span data-ttu-id="20871-332">此值必须是适当长度的十六进制字符串（基于验证中的值）、自动生成或追加的值 IsolateApps。</span><span class="sxs-lookup"><span data-stu-id="20871-332">This value must either be a hexadecimal string of the appropriate length (based on the value in validation), AutoGenerate, or either value appended with,IsolateApps.</span></span> <span data-ttu-id="20871-333">添加 IsolateApps 将指示 ASP.NET 为每个应用程序使用唯一值。</span><span class="sxs-lookup"><span data-stu-id="20871-333">Adding IsolateApps instructs ASP.NET to use a unique value for each application.</span></span> <span data-ttu-id="20871-334">默认值为自动生成 IsolateApps。</span><span class="sxs-lookup"><span data-stu-id="20871-334">The default is AutoGenerate,IsolateApps.</span></span> |

<span data-ttu-id="20871-335">**表 2**： &lt;MachineKey&gt; 元素特性</span><span class="sxs-lookup"><span data-stu-id="20871-335">**Table 2**: The &lt;machineKey&gt; Element Attributes</span></span>

<span data-ttu-id="20871-336">全面讨论了这些加密和验证选项以及各种算法的优缺点，这超出了本教程的范围。</span><span class="sxs-lookup"><span data-stu-id="20871-336">A thorough discussion of these encryption and validation options, and the pros and cons of the various algorithms, is beyond the scope of this tutorial.</span></span> <span data-ttu-id="20871-337">若要深入了解这些问题，包括有关要使用哪些加密和验证算法、要使用哪些密钥长度以及如何最好地生成这些密钥的指导，请参阅*专业 ASP.NET 2.0 安全性、成员身份和角色管理*。</span><span class="sxs-lookup"><span data-stu-id="20871-337">For an in-depth look at these issues, including guidance on what encryption and validation algorithms to use, what key lengths to use, and how best to generate these keys, refer to *Professional ASP.NET 2.0 Security, Membership, and Role Management*.</span></span>

<span data-ttu-id="20871-338">默认情况下，将为每个应用程序自动生成用于加密和验证的密钥，这些密钥存储在本地安全机构（LSA）中。</span><span class="sxs-lookup"><span data-stu-id="20871-338">By default, the keys used for encryption and validation are generated automatically for each application, and these keys are stored in the Local Security Authority (LSA).</span></span> <span data-ttu-id="20871-339">简而言之，默认设置在 web 服务器和应用程序的基础上确保唯一的密钥。</span><span class="sxs-lookup"><span data-stu-id="20871-339">In short, the default settings guarantee unique keys on a web server-by-web server and application-by-application basis.</span></span> <span data-ttu-id="20871-340">因此，此默认行为不适用于以下两种情况：</span><span class="sxs-lookup"><span data-stu-id="20871-340">Consequently, this default behavior will not work for the two following scenarios:</span></span>

- <span data-ttu-id="20871-341">**Web 场**-在[web 场](http://en.wikipedia.org/wiki/Web_farm)方案中，单个 web 应用程序托管在多个 web 服务器上，以实现可伸缩性和冗余。</span><span class="sxs-lookup"><span data-stu-id="20871-341">**Web Farms** - in a [web farm](http://en.wikipedia.org/wiki/Web_farm) scenario, a single web application is hosted on multiple web servers for purposes of scalability and redundancy.</span></span> <span data-ttu-id="20871-342">每个传入请求将被分派给场中的服务器，这意味着在用户会话的整个生存期内，可以使用不同的服务器来处理其不同的请求。</span><span class="sxs-lookup"><span data-stu-id="20871-342">Each incoming request is dispatched to a server in the farm, meaning that over the lifetime of a user's session, different servers may be used to handle his various requests.</span></span> <span data-ttu-id="20871-343">因此，每个服务器都必须使用相同的加密密钥和验证密钥，以便可以在服务器场中的其他服务器上解密和验证在一台服务器上创建、加密和验证的 forms 身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-343">Consequently, each server must use the same encryption and validation keys so that the forms authentication ticket created, encrypted, and validated on one server can be decrypted and validated on a different server in the farm.</span></span>
- <span data-ttu-id="20871-344">**跨应用程序票证共享**-单个 web 服务器可以承载多个 ASP.NET 应用程序。</span><span class="sxs-lookup"><span data-stu-id="20871-344">**Cross Application Ticket Sharing** - a single web server may host multiple ASP.NET applications.</span></span> <span data-ttu-id="20871-345">如果需要将这些不同的应用程序共享单个 forms 身份验证票证，则其加密和验证密钥必须匹配。</span><span class="sxs-lookup"><span data-stu-id="20871-345">If you need for these different applications to share a single forms authentication ticket, it is imperative that their encryption and validation keys match up.</span></span>

<span data-ttu-id="20871-346">在 web 场中工作或在同一服务器上的应用程序之间共享身份验证票证时，需要在受影响的应用程序中配置 &lt;machineKey&gt; 元素，使其 decryptionKey 和 validationKey 值匹配。</span><span class="sxs-lookup"><span data-stu-id="20871-346">When working in a web farm setting or sharing authentication tickets across applications on the same server, you will need to configure the &lt;machineKey&gt; element in the affected applications so that their decryptionKey and validationKey values match up.</span></span>

<span data-ttu-id="20871-347">尽管上述方案均不适用于我们的示例应用程序，但我们仍可以指定显式 decryptionKey 和 validationKey 值，并定义要使用的算法。</span><span class="sxs-lookup"><span data-stu-id="20871-347">While neither of the above scenarios applies to our sample application, we can still specify explicit decryptionKey and validationKey values and define the algorithms to be used.</span></span> <span data-ttu-id="20871-348">向 Web.config 文件添加一个 &lt;machineKey&gt; 设置：</span><span class="sxs-lookup"><span data-stu-id="20871-348">Add a &lt;machineKey&gt; setting to the Web.config file:</span></span>

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample5.xml)]

<span data-ttu-id="20871-349">有关详细信息，请参阅[如何：配置 MachineKey in ASP.NET 2.0](https://msdn.microsoft.com/library/ms998288.aspx)。</span><span class="sxs-lookup"><span data-stu-id="20871-349">For more information check out [How To: Configure MachineKey in ASP.NET 2.0](https://msdn.microsoft.com/library/ms998288.aspx).</span></span>

> [!NOTE]
> <span data-ttu-id="20871-350">DecryptionKey 和 validationKey 值取自[Steve Gibson](http://www.grc.com/stevegibson.htm)的 "[完美密码" 网页](https://www.grc.com/passwords.htm)，这会在每个页面访问时生成64个随机十六进制字符。</span><span class="sxs-lookup"><span data-stu-id="20871-350">The decryptionKey and validationKey values were taken from [Steve Gibson](http://www.grc.com/stevegibson.htm)'s [Perfect Passwords web page](https://www.grc.com/passwords.htm), which generates 64 random hexadecimal characters on each page visit.</span></span> <span data-ttu-id="20871-351">为了减少这些密钥进入生产应用程序的可能性，建议你将上述密钥替换为从完美密码页面随机生成的密钥。</span><span class="sxs-lookup"><span data-stu-id="20871-351">To lessen the likelihood of these keys making their way into your production applications, you are encouraged to replace the above keys with randomly generated ones from the Perfect Passwords page.</span></span>

## <a name="step-4-storing-additional-user-data-in-the-ticket"></a><span data-ttu-id="20871-352">步骤4：将其他用户数据存储在票证中</span><span class="sxs-lookup"><span data-stu-id="20871-352">Step 4: Storing Additional User Data in the Ticket</span></span>

<span data-ttu-id="20871-353">许多 web 应用程序都在当前登录的用户上显示有关或使页面显示的信息。</span><span class="sxs-lookup"><span data-stu-id="20871-353">Many web applications display information about or base the page's display on the currently logged on user.</span></span> <span data-ttu-id="20871-354">例如，网页可能会显示用户的名称以及每个页面上一次登录的日期。</span><span class="sxs-lookup"><span data-stu-id="20871-354">For example, a web page might show the user's name and the date she last logged on in the upper corner of every page.</span></span> <span data-ttu-id="20871-355">Forms 身份验证票证存储当前登录的用户的用户名，但当需要任何其他信息时，该页必须发送到用户存储区（通常为数据库）来查找未存储在身份验证票证中的信息。</span><span class="sxs-lookup"><span data-stu-id="20871-355">The forms authentication ticket stores the currently logged on user's username, but when any other information is needed, the page must go to the user store - typically a database - to lookup the information not stored in the authentication ticket.</span></span>

<span data-ttu-id="20871-356">使用少量代码，我们可以在 forms 身份验证票证中存储其他用户信息。</span><span class="sxs-lookup"><span data-stu-id="20871-356">With a little bit of code we can store additional user information in the forms authentication ticket.</span></span> <span data-ttu-id="20871-357">此类数据可以通过[FormsAuthenticationTicket 类](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx)的[UserData 属性](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.userdata.aspx)来表示。</span><span class="sxs-lookup"><span data-stu-id="20871-357">Such data can be expressed through the [FormsAuthenticationTicket class](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx)'s [UserData property](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.userdata.aspx).</span></span> <span data-ttu-id="20871-358">这是一个有用的位置，用于放置通常需要的有关用户的少量信息。</span><span class="sxs-lookup"><span data-stu-id="20871-358">This is a useful place to put small amounts of information about the user that is commonly needed.</span></span> <span data-ttu-id="20871-359">在 "UserData" 属性中指定的值作为身份验证票证 cookie 的一部分包含在内，如其他票证字段一样，会根据 forms 身份验证系统的配置对其进行加密和验证。</span><span class="sxs-lookup"><span data-stu-id="20871-359">The value specified in the UserData property is included as part of the authentication ticket cookie and, like the other ticket fields, is encrypted and validated based on the forms authentication system's configuration.</span></span> <span data-ttu-id="20871-360">默认情况下，UserData 为空字符串。</span><span class="sxs-lookup"><span data-stu-id="20871-360">By default, UserData is an empty string.</span></span>

<span data-ttu-id="20871-361">若要在身份验证票证中存储用户数据，我们需要在登录页中编写一些代码来获取特定于用户的信息，并将其存储在票证中。</span><span class="sxs-lookup"><span data-stu-id="20871-361">In order to store user data in the authentication ticket, we need to write a bit of code in the login page that grabs the user-specific information and stores it in the ticket.</span></span> <span data-ttu-id="20871-362">由于 UserData 是字符串类型的属性，因此中存储的数据必须正确地序列化为字符串。</span><span class="sxs-lookup"><span data-stu-id="20871-362">Since UserData is a property of type String, the data stored in it must be properly serialized as a string.</span></span> <span data-ttu-id="20871-363">例如，假设用户存储包含每个用户的出生日期和其雇主的名称，并且我们希望将这两个属性值存储在身份验证票证中。</span><span class="sxs-lookup"><span data-stu-id="20871-363">For example, imagine that our user store included each user's date of birth and the name of their employer, and we wanted to store these two property values in the authentication ticket.</span></span> <span data-ttu-id="20871-364">我们可以通过使用竖线（|）将用户的出生日期字符串连接到字符串，后跟雇主姓名，将这些值序列化为一个字符串。</span><span class="sxs-lookup"><span data-stu-id="20871-364">We could serialize these values into a string by concatenating the user's date of birth's string with a pipe ( | ), followed by the employer name.</span></span> <span data-ttu-id="20871-365">对于在1974年8月15日（适用于 Northwind 商贸）的用户，我们将为 UserData 属性分配字符串： 1974-08-15 |Northwind 商贸。</span><span class="sxs-lookup"><span data-stu-id="20871-365">For a user born on August 15, 1974 that works for Northwind Traders, we would assign the UserData property the string: 1974-08-15|Northwind Traders .</span></span>

<span data-ttu-id="20871-366">每当需要访问存储在票证中的数据时，我们都可以通过获取当前请求的 FormsAuthenticationTicket 并反序列化 UserData 属性来实现此目的。</span><span class="sxs-lookup"><span data-stu-id="20871-366">Whenever we need to access the data stored in the ticket, we can do so by grabbing the current request's FormsAuthenticationTicket and deserializing the UserData property.</span></span> <span data-ttu-id="20871-367">如果是出生日期和雇主姓名示例，我们会根据分隔符（|）将 UserData 字符串拆分为两个子字符串。</span><span class="sxs-lookup"><span data-stu-id="20871-367">In the case of the date of birth and employer name example, we would split the UserData string into two substrings based on the delimiter ( | ).</span></span>

<span data-ttu-id="20871-368">[![可以在身份验证票证中存储其他用户信息](forms-authentication-configuration-and-advanced-topics-vb/_static/image11.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="20871-368">[![Additional User Information Can Be Stored in the Authentication Ticket](forms-authentication-configuration-and-advanced-topics-vb/_static/image11.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image10.png)</span></span>

<span data-ttu-id="20871-369">**图 04**：其他用户信息可以存储在身份验证票证中（[单击以查看完全大小的映像](forms-authentication-configuration-and-advanced-topics-vb/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-369">**Figure 04**: Additional User Information Can Be Stored in the Authentication Ticket ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image12.png))</span></span>

### <a name="writing-information-to-userdata"></a><span data-ttu-id="20871-370">将信息写入 UserData</span><span class="sxs-lookup"><span data-stu-id="20871-370">Writing Information to UserData</span></span>

<span data-ttu-id="20871-371">遗憾的是，将特定于用户的信息添加到 forms 身份验证票证并不像预期那样简单。</span><span class="sxs-lookup"><span data-stu-id="20871-371">Unfortunately, adding user-specific information to a forms authentication ticket is not as straightforward as one might expect.</span></span> <span data-ttu-id="20871-372">FormsAuthenticationTicket 类的 UserData 属性是只读的，并且只能通过 FormsAuthenticationTicket 类构造函数指定。</span><span class="sxs-lookup"><span data-stu-id="20871-372">The UserData property of the FormsAuthenticationTicket class is read-only and can only be specified through the FormsAuthenticationTicket class constructor.</span></span> <span data-ttu-id="20871-373">在构造函数中指定 UserData 属性时，我们还需要提供票证的其他值：用户名、发行日期、到期时间等。</span><span class="sxs-lookup"><span data-stu-id="20871-373">When specifying the UserData property in the constructor, we also need to provide the ticket's other values: the username, the issue date, the expiration, and so on.</span></span> <span data-ttu-id="20871-374">当我们在上一教程中创建登录页时，此操作由 FormsAuthentication 类处理。</span><span class="sxs-lookup"><span data-stu-id="20871-374">When we created the login page in the preceding tutorial, this was all handled for us by the FormsAuthentication class.</span></span> <span data-ttu-id="20871-375">将 UserData 添加到 FormsAuthenticationTicket 时，需要编写代码来复制 FormsAuthentication 类已经提供的大部分功能。</span><span class="sxs-lookup"><span data-stu-id="20871-375">When adding UserData to the FormsAuthenticationTicket, we will need to write code to replicate much of the functionality already provided by the FormsAuthentication class.</span></span>

<span data-ttu-id="20871-376">让我们来了解通过更新 "登录 .aspx" 页来记录用户对身份验证票证的其他信息时使用的必要代码。</span><span class="sxs-lookup"><span data-stu-id="20871-376">Let's explore the necessary code for working with UserData by updating the Login.aspx page to record additional information about the user to the authentication ticket.</span></span> <span data-ttu-id="20871-377">假设我们的用户存储区包含用户使用的公司的相关信息及其标题，并想要在身份验证票证中捕获此信息。</span><span class="sxs-lookup"><span data-stu-id="20871-377">Pretend that our user store contains information about the company the user works for and their title, and that we want to capture this information in the authentication ticket.</span></span> <span data-ttu-id="20871-378">更新登录 .aspx 页的 LoginButton 单击事件处理程序，使代码如下所示：</span><span class="sxs-lookup"><span data-stu-id="20871-378">Update the Login.aspx page's LoginButton Click event handler so that the code looks like the following:</span></span>

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample6.vb)]

<span data-ttu-id="20871-379">让我们每次逐行执行此代码。</span><span class="sxs-lookup"><span data-stu-id="20871-379">Let's step through this code one line at a time.</span></span> <span data-ttu-id="20871-380">方法首先定义四个字符串数组：用户、密码、公司名称和 titleAtCompany。</span><span class="sxs-lookup"><span data-stu-id="20871-380">The method starts by defining four string arrays: users, passwords, companyName, and titleAtCompany.</span></span> <span data-ttu-id="20871-381">这些数组保存系统中用户帐户的用户名、密码、公司名称和标题，其中有三个： Scott、Jisun 和 Sam。</span><span class="sxs-lookup"><span data-stu-id="20871-381">These arrays hold the usernames, passwords, company names, and titles for the user accounts in the system, of which there are three: Scott, Jisun, and Sam.</span></span> <span data-ttu-id="20871-382">在实际应用程序中，将从用户存储区中查询这些值，而不是在页面的源代码中进行硬编码。</span><span class="sxs-lookup"><span data-stu-id="20871-382">In a real application, these values would be queried from the user store, not hard-coded in the page's source code.</span></span>

<span data-ttu-id="20871-383">在上一教程中，如果提供的凭据有效，我们只需调用 FormsAuthentication Formsauthentication.redirectfromloginpage （RememberMe），这会执行以下步骤：</span><span class="sxs-lookup"><span data-stu-id="20871-383">In the previous tutorial, if the supplied credentials were valid we simply called FormsAuthentication.RedirectFromLoginPage(UserName.Text, RememberMe.Checked), which performed the following steps:</span></span>

1. <span data-ttu-id="20871-384">已创建 forms 身份验证票证</span><span class="sxs-lookup"><span data-stu-id="20871-384">Created the forms authentication ticket</span></span>
2. <span data-ttu-id="20871-385">已将票证写入适当的商店。</span><span class="sxs-lookup"><span data-stu-id="20871-385">Wrote the ticket to the appropriate store.</span></span> <span data-ttu-id="20871-386">对于基于 cookie 的身份验证票证，使用浏览器的 cookie 集合;对于无 cookie 身份验证票证，会将票证数据序列化为 URL</span><span class="sxs-lookup"><span data-stu-id="20871-386">For cookies-based authentication tickets, the browser's cookies collection is used; for cookieless authentication tickets, the ticket data is serialized into the URL</span></span>
3. <span data-ttu-id="20871-387">将用户重定向到适当页面</span><span class="sxs-lookup"><span data-stu-id="20871-387">Redirected the user to the appropriate page</span></span>

<span data-ttu-id="20871-388">这些步骤将在上面的代码中进行复制。</span><span class="sxs-lookup"><span data-stu-id="20871-388">These steps are replicated in the code above.</span></span> <span data-ttu-id="20871-389">首先，我们最终存储在 UserData 属性中的字符串是通过组合公司名称和标题组成的，并用竖线字符（|）分隔这两个值。</span><span class="sxs-lookup"><span data-stu-id="20871-389">First, the string we will eventually store in the UserData property is formed by combining the company name and the title, delimiting the two values with a pipe character ( | ).</span></span>

<span data-ttu-id="20871-390">Dim userDataString As String = String.Concat(companyName(i), "|", titleAtCompany(i))</span><span class="sxs-lookup"><span data-stu-id="20871-390">Dim userDataString As String = String.Concat(companyName(i), "|", titleAtCompany(i))</span></span>

<span data-ttu-id="20871-391">接下来，调用 FormsAuthentication GetAuthCookie 方法，该方法将创建身份验证票证，根据配置设置对其进行加密和验证，然后将其放在 HttpCookie 对象中。</span><span class="sxs-lookup"><span data-stu-id="20871-391">Next, the FormsAuthentication.GetAuthCookie method is invoked, which creates the authentication ticket, encrypts and validates it according to the configuration settings, and places it in an HttpCookie object.</span></span>

<span data-ttu-id="20871-392">Dim authCookie As HttpCookie = FormsAuthentication GetAuthCookie （UserName. Text，RememberMe）</span><span class="sxs-lookup"><span data-stu-id="20871-392">Dim authCookie As HttpCookie = FormsAuthentication.GetAuthCookie(UserName.Text, RememberMe.Checked)</span></span>

<span data-ttu-id="20871-393">若要处理 cookie 中嵌入的 FormAuthenticationTicket，需要调用 FormAuthentication 类的[解密方法](https://msdn.microsoft.com/library/system.web.security.formsauthentication.decrypt.aspx)，并传入 cookie 值。</span><span class="sxs-lookup"><span data-stu-id="20871-393">In order to work with the FormAuthenticationTicket embedded within the cookie, we need to call the FormAuthentication class's [Decrypt method](https://msdn.microsoft.com/library/system.web.security.formsauthentication.decrypt.aspx), passing in the cookie value.</span></span>

<span data-ttu-id="20871-394">Dim ticket As FormsAuthenticationTicket = FormsAuthentication.Decrypt(authCookie.Value)</span><span class="sxs-lookup"><span data-stu-id="20871-394">Dim ticket As FormsAuthenticationTicket = FormsAuthentication.Decrypt(authCookie.Value)</span></span>

<span data-ttu-id="20871-395">然后，基于现有 FormsAuthenticationTicket 的值创建一个*新*的 FormsAuthenticationTicket 实例。</span><span class="sxs-lookup"><span data-stu-id="20871-395">We then create a *new* FormsAuthenticationTicket instance based on the existing FormsAuthenticationTicket's values.</span></span> <span data-ttu-id="20871-396">但是，此新票证包含用户特定的信息（userDataString）。</span><span class="sxs-lookup"><span data-stu-id="20871-396">However, this new ticket includes the user-specific information (userDataString).</span></span>

<span data-ttu-id="20871-397">Dim newTicket As FormsAuthenticationTicket = New FormsAuthenticationTicket （ticket。版本，票证。Name、ticket。IssueDate、ticket。过期，票证。IsPersistent、userDataString）</span><span class="sxs-lookup"><span data-stu-id="20871-397">Dim newTicket As FormsAuthenticationTicket = New FormsAuthenticationTicket(ticket.Version, ticket.Name, ticket.IssueDate, ticket.Expiration, ticket.IsPersistent, userDataString)</span></span>

<span data-ttu-id="20871-398">然后，通过调用[encrypt 方法](https://msdn.microsoft.com/library/system.web.security.formsauthentication.encrypt.aspx)加密（和验证）新的 FormsAuthenticationTicket 实例，并将此加密（和验证）数据放回到 authCookie 中。</span><span class="sxs-lookup"><span data-stu-id="20871-398">We then encrypt (and validate) the new FormsAuthenticationTicket instance by calling the [Encrypt method](https://msdn.microsoft.com/library/system.web.security.formsauthentication.encrypt.aspx), and put this encrypted (and validated) data back into authCookie.</span></span>

<span data-ttu-id="20871-399">authCookie.Value = FormsAuthentication.Encrypt(newTicket)</span><span class="sxs-lookup"><span data-stu-id="20871-399">authCookie.Value = FormsAuthentication.Encrypt(newTicket)</span></span>

<span data-ttu-id="20871-400">最后，authCookie 将添加到响应中。 Cookie 集合和调用 GetRedirectUrl 方法，以确定发送用户的相应页面。</span><span class="sxs-lookup"><span data-stu-id="20871-400">Finally, authCookie is added to the Response.Cookies collection and the GetRedirectUrl method is called to determine the appropriate page to send the user.</span></span>

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample7.vb)]

<span data-ttu-id="20871-401">所有这些代码都是必需的，因为 UserData 属性是只读的，而 FormsAuthentication 类不提供任何用于在其 GetAuthCookie、SetAuthCookie 或 Formsauthentication.redirectfromloginpage 方法中指定 UserData 信息的方法。</span><span class="sxs-lookup"><span data-stu-id="20871-401">All of this code is needed because the UserData property is read-only and the FormsAuthentication class does not provide any methods for specifying UserData information in its GetAuthCookie, SetAuthCookie, or RedirectFromLoginPage methods.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-402">我们刚才检查的代码将用户特定的信息存储在基于 cookie 的身份验证票证中。</span><span class="sxs-lookup"><span data-stu-id="20871-402">The code we just examined stores user-specific information in a cookies-based authentication ticket.</span></span> <span data-ttu-id="20871-403">负责将 forms 身份验证票证序列化为 URL 的类在 .NET Framework 内部。</span><span class="sxs-lookup"><span data-stu-id="20871-403">The classes responsible for serializing the forms authentication ticket to the URL are internal to the .NET Framework.</span></span> <span data-ttu-id="20871-404">简短故事，你无法将用户数据存储在无 cookie forms 身份验证票证中。</span><span class="sxs-lookup"><span data-stu-id="20871-404">Long story short, you cannot store user data in a cookieless forms authentication ticket.</span></span>

### <a name="accessing-the-userdata-information"></a><span data-ttu-id="20871-405">访问 UserData 信息</span><span class="sxs-lookup"><span data-stu-id="20871-405">Accessing the UserData Information</span></span>

<span data-ttu-id="20871-406">此时，每个用户的公司名称和标题都存储在登录时的 forms 身份验证票证的 UserData 属性中。</span><span class="sxs-lookup"><span data-stu-id="20871-406">At this point each user's company name and title is stored in the forms authentication ticket's UserData property when they log in.</span></span> <span data-ttu-id="20871-407">可从任何页面上的身份验证票证访问此信息，而无需访问用户存储。</span><span class="sxs-lookup"><span data-stu-id="20871-407">This information can be accessed from the authentication ticket on any page without requiring a trip to the user store.</span></span> <span data-ttu-id="20871-408">为了说明如何从 UserData 属性检索此信息，我们更新了 default.aspx，使其欢迎消息不仅包括用户的名称，而且还包括他们使用的公司及其职务。</span><span class="sxs-lookup"><span data-stu-id="20871-408">To illustrate how this information can be retrieved from the UserData property, let's update Default.aspx so that its welcome message includes not only the user's name, but also the company they work for and their title.</span></span>

<span data-ttu-id="20871-409">目前，default.aspx 包含一个 AuthenticatedMessagePanel 面板，其中包含名为 WelcomeBackMessage 的标签控件。</span><span class="sxs-lookup"><span data-stu-id="20871-409">Currently, Default.aspx contains an AuthenticatedMessagePanel Panel with a Label control named WelcomeBackMessage.</span></span> <span data-ttu-id="20871-410">此面板仅向经过身份验证的用户显示。</span><span class="sxs-lookup"><span data-stu-id="20871-410">This Panel is only displayed to authenticated users.</span></span> <span data-ttu-id="20871-411">\_Load 事件处理程序中更新 .aspx 页面中的代码，使其类似于以下内容：</span><span class="sxs-lookup"><span data-stu-id="20871-411">Update the code in Default.aspx's Page\_Load event handler so that it looks like the following:</span></span>

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample8.vb)]

<span data-ttu-id="20871-412">如果 IsAuthenticated 为 True，则 WelcomeBackMessage 的 Text 属性首先设置为 "欢迎回来，*用户名*"。</span><span class="sxs-lookup"><span data-stu-id="20871-412">If Request.IsAuthenticated is True, then the WelcomeBackMessage's Text property is first set to Welcome back, *username*.</span></span> <span data-ttu-id="20871-413">然后，将 User. Identity 属性强制转换为 FormsIdentity 对象，以便我们可以访问基础 FormsAuthenticationTicket。</span><span class="sxs-lookup"><span data-stu-id="20871-413">Then, the User.Identity property is cast to a FormsIdentity object so that we can access the underlying FormsAuthenticationTicket.</span></span> <span data-ttu-id="20871-414">有了 FormsAuthenticationTicket 后，我们会将 UserData 属性反序列化为公司名称和标题。</span><span class="sxs-lookup"><span data-stu-id="20871-414">Once we have the FormsAuthenticationTicket, we deserialize the UserData property into the company name and title.</span></span> <span data-ttu-id="20871-415">这是通过将字符串拆分为管道字符来完成的。</span><span class="sxs-lookup"><span data-stu-id="20871-415">This is accomplished by splitting the string on the pipe character.</span></span> <span data-ttu-id="20871-416">然后，将在 "WelcomeBackMessage" 标签中显示公司名称和标题。</span><span class="sxs-lookup"><span data-stu-id="20871-416">The company name and title are then displayed in the WelcomeBackMessage Label.</span></span>

<span data-ttu-id="20871-417">图5显示了此显示在操作中的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="20871-417">Figure 5 shows a screenshot of this display in action.</span></span> <span data-ttu-id="20871-418">以 Scott 身份登录时，会显示一个包含 Scott 公司和职务的欢迎消息。</span><span class="sxs-lookup"><span data-stu-id="20871-418">Logging in as Scott displays a welcome back message that includes Scott's company and title.</span></span>

<span data-ttu-id="20871-419">[显示当前登录的用户的公司和标题 ![](forms-authentication-configuration-and-advanced-topics-vb/_static/image14.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="20871-419">[![The Currently Logged On User's Company and Title are Displayed](forms-authentication-configuration-and-advanced-topics-vb/_static/image14.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image13.png)</span></span>

<span data-ttu-id="20871-420">**图 05**：显示当前登录的用户的公司和标题（[单击查看完全大小的图像](forms-authentication-configuration-and-advanced-topics-vb/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-420">**Figure 05**: The Currently Logged On User's Company and Title are Displayed ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image15.png))</span></span>

> [!NOTE]
> <span data-ttu-id="20871-421">身份验证票证的 UserData 属性用作用户存储的缓存。</span><span class="sxs-lookup"><span data-stu-id="20871-421">The authentication ticket's UserData property serves as a cache for the user store.</span></span> <span data-ttu-id="20871-422">与任何缓存一样，在修改基础数据时，需要对其进行更新。</span><span class="sxs-lookup"><span data-stu-id="20871-422">Like any cache, it needs to be updated when the underlying data is modified.</span></span> <span data-ttu-id="20871-423">例如，如果有一个网页可供用户更新其配置文件，则必须刷新在 UserData 属性中缓存的字段，以反映用户所做的更改。</span><span class="sxs-lookup"><span data-stu-id="20871-423">For example, if there is a web page from which users can update their profile, the fields cached in the UserData property must be refreshed to reflect the changes made by the user.</span></span>

## <a name="step-5-using-a-custom-principal"></a><span data-ttu-id="20871-424">步骤5：使用自定义主体</span><span class="sxs-lookup"><span data-stu-id="20871-424">Step 5: Using a Custom Principal</span></span>

<span data-ttu-id="20871-425">对于每个传入请求，FormsAuthenticationModule 将尝试对用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="20871-425">On each incoming request the FormsAuthenticationModule attempts to authenticate the user.</span></span> <span data-ttu-id="20871-426">如果存在未过期的身份验证票证，则 FormsAuthenticationModule 会将 HttpContext 属性分配给新的 GenericPrincipal 对象。</span><span class="sxs-lookup"><span data-stu-id="20871-426">If a non-expired authentication ticket is present, the FormsAuthenticationModule assigns the HttpContext.User property to a new GenericPrincipal object.</span></span> <span data-ttu-id="20871-427">此 GenericPrincipal 对象有一个 FormsIdentity 类型的标识，其中包括对 forms 身份验证票证的引用。</span><span class="sxs-lookup"><span data-stu-id="20871-427">This GenericPrincipal object has an Identity of type FormsIdentity, which includes a reference to the forms authentication ticket.</span></span> <span data-ttu-id="20871-428">GenericPrincipal 类包含实现 IPrincipal 的类所需的最小功能-它只包含一个 Identity 属性和一个 IsInRole 方法。</span><span class="sxs-lookup"><span data-stu-id="20871-428">The GenericPrincipal class contains the bare minimum functionality needed by a class that implements IPrincipal - it just has an Identity property and an IsInRole method.</span></span>

<span data-ttu-id="20871-429">主体对象有两个责任：指示用户所属的角色并提供标识信息。</span><span class="sxs-lookup"><span data-stu-id="20871-429">The principal object has two responsibilities: to indicate what roles the user belongs to and to provide identity information.</span></span> <span data-ttu-id="20871-430">这可以分别通过 IPrincipal 接口的*IsInRole （"* 标识"）方法和 "标识" 属性来实现。</span><span class="sxs-lookup"><span data-stu-id="20871-430">This is accomplished through the IPrincipal interface's IsInRole(*roleName*) method and Identity property, respectively.</span></span> <span data-ttu-id="20871-431">GenericPrincipal 类允许通过其构造函数指定角色名称的字符串数组;它的 IsInRole *（"* 方法"）方法只检查字符串*数组中是否存在传入*的 "有条件"。</span><span class="sxs-lookup"><span data-stu-id="20871-431">The GenericPrincipal class allows for a string array of role names to be specified via its constructor; its IsInRole(*roleName*) method merely checks to see if the passed in *roleName* exists within the string array.</span></span> <span data-ttu-id="20871-432">当 FormsAuthenticationModule 创建 GenericPrincipal 时，它将在一个空字符串数组中传递到 GenericPrincipal 的构造函数。</span><span class="sxs-lookup"><span data-stu-id="20871-432">When the FormsAuthenticationModule creates the GenericPrincipal, it passes in an empty string array to the GenericPrincipal's constructor.</span></span> <span data-ttu-id="20871-433">因此，对 IsInRole 的任何调用都将始终返回 False。</span><span class="sxs-lookup"><span data-stu-id="20871-433">Consequently, any call to IsInRole will always return False.</span></span>

<span data-ttu-id="20871-434">GenericPrincipal 类满足大多数基于窗体的身份验证方案的需求，其中不使用角色。</span><span class="sxs-lookup"><span data-stu-id="20871-434">The GenericPrincipal class meets the needs for most forms based authentication scenarios where roles are not used.</span></span> <span data-ttu-id="20871-435">对于默认角色处理不足或需要将自定义 IIdentity 对象与用户关联的情况，可以在身份验证工作流过程中创建自定义 IPrincipal 对象，并将其分配给 HttpContext。</span><span class="sxs-lookup"><span data-stu-id="20871-435">For those situations where the default role handling is insufficient or when you need to associate a custom IIdentity object with the user, you can create a custom IPrincipal object during the authentication workflow and assign it to the HttpContext.User property.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-436">在将来的教程中，我们将在 ASP 时看到。网络角色框架已启用。它创建[RolePrincipal](https://msdn.microsoft.com/library/system.web.security.roleprincipal.aspx)类型的自定义主体对象，并覆盖 forms 身份验证创建的 GenericPrincipal 对象。</span><span class="sxs-lookup"><span data-stu-id="20871-436">As we will see in future tutorials, when ASP.NET's Roles framework is enabled it creates a custom principal object of type [RolePrincipal](https://msdn.microsoft.com/library/system.web.security.roleprincipal.aspx) and overwrites the forms authentication-created GenericPrincipal object.</span></span> <span data-ttu-id="20871-437">这样做是为了自定义主体的 IsInRole 方法，以便与角色框架的 API 进行交互。</span><span class="sxs-lookup"><span data-stu-id="20871-437">It does this in order to customize the principal's IsInRole method to interface with the Roles framework's API.</span></span>

<span data-ttu-id="20871-438">由于我们尚未关心角色，因此，在此结合创建自定义主体的唯一原因是将自定义 IIdentity 对象关联到主体。</span><span class="sxs-lookup"><span data-stu-id="20871-438">Since we have not concerned ourselves with roles yet, the only reason we would have for creating a custom principal at this juncture would be to associate a custom IIdentity object to the principal.</span></span> <span data-ttu-id="20871-439">在步骤4中，我们探讨了如何在身份验证票证的 UserData 属性中存储其他用户信息，尤其是用户的公司名称和标题。</span><span class="sxs-lookup"><span data-stu-id="20871-439">In Step 4 we looked at storing additional user information in the authentication ticket's UserData property, in particular the user's company name and their title.</span></span> <span data-ttu-id="20871-440">但是，只需通过身份验证票证即可访问 UserData 信息，只需将其作为序列化字符串，这意味着，无论何时，只要要查看存储在票证中的用户信息，都需要分析 UserData 属性。</span><span class="sxs-lookup"><span data-stu-id="20871-440">However, the UserData information is only accessible through the authentication ticket and only then as a serialized string, meaning that anytime we want to view the user information stored in the ticket we need to parse the UserData property.</span></span>

<span data-ttu-id="20871-441">我们可以通过创建实现 IIdentity 的类，并包括 "公司名称" 和 "标题" 属性来改善开发人员体验。</span><span class="sxs-lookup"><span data-stu-id="20871-441">We can improve the developer experience by creating a class that implements IIdentity and includes CompanyName and Title properties.</span></span> <span data-ttu-id="20871-442">这样一来，开发人员就可以直接通过 "公司名称" 和 "标题" 属性访问当前登录的用户的公司名称和标题，而无需知道如何分析 UserData 属性。</span><span class="sxs-lookup"><span data-stu-id="20871-442">That way, a developer can access the currently logged on user's company name and title directly through the CompanyName and Title properties without needed to know how to parse the UserData property.</span></span>

### <a name="creating-the-custom-identity-and-principal-classes"></a><span data-ttu-id="20871-443">创建自定义标识和主体类</span><span class="sxs-lookup"><span data-stu-id="20871-443">Creating the Custom Identity and Principal Classes</span></span>

<span data-ttu-id="20871-444">对于本教程，让我们在应用程序\_代码文件夹中创建自定义主体和标识对象。</span><span class="sxs-lookup"><span data-stu-id="20871-444">For this tutorial, let's create the custom principal and identity objects in the App\_Code folder.</span></span> <span data-ttu-id="20871-445">首先将应用\_代码文件夹添加到项目-右键单击解决方案资源管理器中的项目名称，选择 "添加 ASP.NET" 文件夹选项，然后选择 "应用\_代码"。</span><span class="sxs-lookup"><span data-stu-id="20871-445">Start by adding an App\_Code folder to your project - right-click on the project name in Solution Explorer, select the Add ASP.NET Folder option, and choose App\_Code.</span></span> <span data-ttu-id="20871-446">应用\_代码文件夹是一个特殊的 ASP.NET 文件夹，保存特定于网站的类文件。</span><span class="sxs-lookup"><span data-stu-id="20871-446">The App\_Code folder is a special ASP.NET folder that holds class files specific to the website.</span></span>

> [!NOTE]
> <span data-ttu-id="20871-447">仅应在通过网站项目模型管理项目时使用应用\_代码文件夹。</span><span class="sxs-lookup"><span data-stu-id="20871-447">The App\_Code folder should only be used when managing your project through the Website Project Model.</span></span> <span data-ttu-id="20871-448">如果你使用的是[Web 应用程序项目模型](https://msdn.microsoft.com/asp.net/Aa336618.aspx)，请创建一个标准文件夹并将类添加到该文件夹中。</span><span class="sxs-lookup"><span data-stu-id="20871-448">If you are using the [Web Application Project Model](https://msdn.microsoft.com/asp.net/Aa336618.aspx), create a standard folder and add the classes to that.</span></span> <span data-ttu-id="20871-449">例如，你可以添加一个名为类的新文件夹，并将你的代码放在此处。</span><span class="sxs-lookup"><span data-stu-id="20871-449">For example, you could add a new folder named Classes, and place your code there.</span></span>

<span data-ttu-id="20871-450">接下来，将两个新的类文件添加到应用\_代码文件夹，一个名为 CustomIdentity，另一个名为 CustomPrincipal。</span><span class="sxs-lookup"><span data-stu-id="20871-450">Next, add two new class files to the App\_Code folder, one named CustomIdentity.vb and one named CustomPrincipal.vb.</span></span>

<span data-ttu-id="20871-451">[![将 CustomIdentity 和 CustomPrincipal 类添加到项目](forms-authentication-configuration-and-advanced-topics-vb/_static/image17.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="20871-451">[![Add the CustomIdentity and CustomPrincipal Classes to Your Project](forms-authentication-configuration-and-advanced-topics-vb/_static/image17.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image16.png)</span></span>

<span data-ttu-id="20871-452">**图 06**：向项目中添加 CustomIdentity 和 CustomPrincipal 类（[单击以查看完全大小的图像](forms-authentication-configuration-and-advanced-topics-vb/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-452">**Figure 06**: Add the CustomIdentity and CustomPrincipal Classes to Your Project ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image18.png))</span></span>

<span data-ttu-id="20871-453">CustomIdentity 类负责实现 IIdentity 接口，该接口定义 AuthenticationType、IsAuthenticated 和 Name 属性。</span><span class="sxs-lookup"><span data-stu-id="20871-453">The CustomIdentity class is responsible for implementing the IIdentity interface, which defines the AuthenticationType, IsAuthenticated, and Name properties.</span></span> <span data-ttu-id="20871-454">除了这些所需的属性之外，我们还对公开底层 forms 身份验证票证以及用户公司名称和标题的属性感兴趣。</span><span class="sxs-lookup"><span data-stu-id="20871-454">In addition to those required properties, we are interested in exposing the underlying forms authentication ticket as well as properties for the user's company name and title.</span></span> <span data-ttu-id="20871-455">在 CustomIdentity 类中输入以下代码。</span><span class="sxs-lookup"><span data-stu-id="20871-455">Enter the following code into the CustomIdentity class.</span></span>

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample9.vb)]

<span data-ttu-id="20871-456">请注意，类包含 FormsAuthenticationTicket 成员变量（\_ticket），并且必须通过构造函数提供此票证信息。</span><span class="sxs-lookup"><span data-stu-id="20871-456">Note that the class includes a FormsAuthenticationTicket member variable (\_ticket) and that this ticket information must be supplied through the constructor.</span></span> <span data-ttu-id="20871-457">此票证数据用于返回标识的名称;将分析其 UserData 属性以返回 "公司名称" 和 "标题" 属性的值。</span><span class="sxs-lookup"><span data-stu-id="20871-457">This ticket data is used in returning the identity's Name; its UserData property is parsed to return the values for the CompanyName and Title properties.</span></span>

<span data-ttu-id="20871-458">接下来，创建 CustomPrincipal 类。</span><span class="sxs-lookup"><span data-stu-id="20871-458">Next, create the CustomPrincipal class.</span></span> <span data-ttu-id="20871-459">由于我们不关心此接合处的角色，CustomPrincipal 类的构造函数只接受 CustomIdentity 对象;它的 IsInRole 方法始终返回 False。</span><span class="sxs-lookup"><span data-stu-id="20871-459">Since we are not concerned with roles at this juncture, the CustomPrincipal class's constructor accepts only a CustomIdentity object; its IsInRole method always returns False.</span></span>

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample10.vb)]

### <a name="assigning-a-customprincipal-object-to-the-incoming-requests-security-context"></a><span data-ttu-id="20871-460">将 CustomPrincipal 对象分配给传入请求的安全上下文</span><span class="sxs-lookup"><span data-stu-id="20871-460">Assigning a CustomPrincipal Object to the Incoming Request's Security Context</span></span>

<span data-ttu-id="20871-461">现在，我们有一个类，它将默认的 IIdentity 规范扩展为包含 "公司名称" 和 "标题" 属性以及使用自定义标识的自定义主体类。</span><span class="sxs-lookup"><span data-stu-id="20871-461">We now have a class that extends the default IIdentity specification to include CompanyName and Title properties, as well as a custom principal class that uses the custom identity.</span></span> <span data-ttu-id="20871-462">我们已准备单步执行 ASP.NET 管道，并将自定义主体对象分配给传入请求的安全上下文。</span><span class="sxs-lookup"><span data-stu-id="20871-462">We are ready to step into the ASP.NET pipeline and assign our custom principal object to the incoming request's security context.</span></span>

<span data-ttu-id="20871-463">ASP.NET 管道接收传入请求并通过多个步骤进行处理。</span><span class="sxs-lookup"><span data-stu-id="20871-463">The ASP.NET pipeline takes an incoming request and processes it through a number of steps.</span></span> <span data-ttu-id="20871-464">在每个步骤中，将引发特定事件，使开发人员能够在 ASP.NET 管道中点击并在其生命周期中的特定时间点修改请求。</span><span class="sxs-lookup"><span data-stu-id="20871-464">At each step, a particular event is raised, making it possible for developers to tap into the ASP.NET pipeline and modify the request at certain points in its lifecycle.</span></span> <span data-ttu-id="20871-465">例如，FormsAuthenticationModule 会等待 ASP.NET 引发[AuthenticateRequest 事件](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)，此时，会检查传入请求的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-465">The FormsAuthenticationModule, for example, waits for ASP.NET to raise the [AuthenticateRequest event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), at which point it inspects the incoming request for an authentication ticket.</span></span> <span data-ttu-id="20871-466">如果找到身份验证票证，则会创建一个 GenericPrincipal 对象，并将其分配给 HttpContext. User 属性。</span><span class="sxs-lookup"><span data-stu-id="20871-466">If an authentication ticket is found, a GenericPrincipal object is created and assigned to the HttpContext.User property.</span></span>

<span data-ttu-id="20871-467">AuthenticateRequest 事件完成后，ASP.NET 管道将引发[PostAuthenticateRequest 事件](https://msdn.microsoft.com/library/system.web.httpapplication.postauthenticaterequest.aspx)，可在其中将 FormsAuthenticationModule 创建的 GenericPrincipal 对象替换为我们的 CustomPrincipal 对象的实例。</span><span class="sxs-lookup"><span data-stu-id="20871-467">After the AuthenticateRequest event, the ASP.NET pipeline raises the [PostAuthenticateRequest event](https://msdn.microsoft.com/library/system.web.httpapplication.postauthenticaterequest.aspx), which is where we can replace the GenericPrincipal object created by the FormsAuthenticationModule with an instance of our CustomPrincipal object.</span></span> <span data-ttu-id="20871-468">图7介绍了此工作流。</span><span class="sxs-lookup"><span data-stu-id="20871-468">Figure 7 depicts this workflow.</span></span>

<span data-ttu-id="20871-469">[![GenericPrincipal 被 PostAuthenticationRequest 事件中的 CustomPrincipal 替换](forms-authentication-configuration-and-advanced-topics-vb/_static/image20.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="20871-469">[![The GenericPrincipal is Replaced by a CustomPrincipal in the PostAuthenticationRequest Event](forms-authentication-configuration-and-advanced-topics-vb/_static/image20.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image19.png)</span></span>

<span data-ttu-id="20871-470">**图 07**： GenericPrincipal 替换为 PostAuthenticationRequest 事件中的 CustomPrincipal （[单击以查看完全大小的图像](forms-authentication-configuration-and-advanced-topics-vb/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-470">**Figure 07**: The GenericPrincipal is Replaced by a CustomPrincipal in the PostAuthenticationRequest Event ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image21.png))</span></span>

<span data-ttu-id="20871-471">为了执行代码以响应 ASP.NET 管道事件，可以在 global.asax 中创建相应的事件处理程序，或者创建我们自己的 HTTP 模块。</span><span class="sxs-lookup"><span data-stu-id="20871-471">In order to execute code in response to an ASP.NET pipeline event, we can either create the appropriate event handler in Global.asax or create our own HTTP Module.</span></span> <span data-ttu-id="20871-472">在本教程中，我们将在 global.asax 中创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="20871-472">For this tutorial let's create the event handler in Global.asax.</span></span> <span data-ttu-id="20871-473">首先将 global.asax 添加到你的网站。</span><span class="sxs-lookup"><span data-stu-id="20871-473">Start by adding Global.asax to your website.</span></span> <span data-ttu-id="20871-474">在解决方案资源管理器中右键单击项目名称，并添加一个名为 "global.asax" 的全局应用程序类类型的项。</span><span class="sxs-lookup"><span data-stu-id="20871-474">Right-click on the project name in Solution Explorer and add an item of type Global Application Class named Global.asax.</span></span>

<span data-ttu-id="20871-475">[![向网站添加一个 global.asax 文件](forms-authentication-configuration-and-advanced-topics-vb/_static/image23.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="20871-475">[![Add a Global.asax File to Your Website](forms-authentication-configuration-and-advanced-topics-vb/_static/image23.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image22.png)</span></span>

<span data-ttu-id="20871-476">**图 08**：向网站添加一个 global.asax 文件（[单击以查看完全大小的图像](forms-authentication-configuration-and-advanced-topics-vb/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="20871-476">**Figure 08**: Add a Global.asax File to Your Website ([Click to view full-size image](forms-authentication-configuration-and-advanced-topics-vb/_static/image24.png))</span></span>

<span data-ttu-id="20871-477">默认的 global.asax 模板包括多个 ASP.NET 管道事件的事件处理程序，包括启动、结束和[错误事件](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx)，等等。</span><span class="sxs-lookup"><span data-stu-id="20871-477">The default Global.asax template includes event handlers for a number of the ASP.NET pipeline events, including the Start, End and [Error event](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx), among others.</span></span> <span data-ttu-id="20871-478">可以随意删除这些事件处理程序，因为对于此应用程序，我们不需要它们。</span><span class="sxs-lookup"><span data-stu-id="20871-478">Feel free to remove these event handlers, as we do not need them for this application.</span></span> <span data-ttu-id="20871-479">我们感兴趣的事件是 PostAuthenticateRequest。</span><span class="sxs-lookup"><span data-stu-id="20871-479">The event we are interested in is PostAuthenticateRequest.</span></span> <span data-ttu-id="20871-480">更新 global.asax 文件，使其标记类似于以下内容：</span><span class="sxs-lookup"><span data-stu-id="20871-480">Update your Global.asax file so its markup looks similar to the following:</span></span>

[!code-aspx[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample11.aspx)]

<span data-ttu-id="20871-481">每次 ASP.NET 运行时引发 PostAuthenticateRequest 事件时，将执行应用程序\_OnPostAuthenticateRequest 方法，这会在每个传入页面请求发生一次。</span><span class="sxs-lookup"><span data-stu-id="20871-481">The Application\_OnPostAuthenticateRequest method executes each time the ASP.NET runtime raises the PostAuthenticateRequest event, which happens once on each incoming page request.</span></span> <span data-ttu-id="20871-482">事件处理程序通过检查是否已通过 forms 身份验证对用户进行身份验证和身份验证而开始。</span><span class="sxs-lookup"><span data-stu-id="20871-482">The event handler starts by checking to see if the user is authenticated and was authenticated via forms authentication.</span></span> <span data-ttu-id="20871-483">如果是这样，则将创建一个新的 CustomIdentity 对象，并在其构造函数中传递当前请求的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="20871-483">If so, a new CustomIdentity object is created and passed the current request's authentication ticket in its constructor.</span></span> <span data-ttu-id="20871-484">之后，将创建一个 CustomPrincipal 对象，并在其构造函数中传递刚刚创建的 CustomIdentity 对象。</span><span class="sxs-lookup"><span data-stu-id="20871-484">Following that, a CustomPrincipal object is created and passed the just-created CustomIdentity object in its constructor.</span></span> <span data-ttu-id="20871-485">最后，当前请求的安全上下文将分配给新创建的 CustomPrincipal 对象。</span><span class="sxs-lookup"><span data-stu-id="20871-485">Finally, the current request's security context is assigned to the newly created CustomPrincipal object.</span></span>

<span data-ttu-id="20871-486">请注意，最后一步是将 CustomPrincipal 对象与请求的安全上下文相关联，将主体分配给两个属性： HttpContext. User 和 Thread.currentprincipal。</span><span class="sxs-lookup"><span data-stu-id="20871-486">Note that the last step - associating the CustomPrincipal object with the request's security context - assigns the principal to two properties: HttpContext.User and Thread.CurrentPrincipal.</span></span> <span data-ttu-id="20871-487">这两个赋值是必需的，因为在 ASP.NET 中处理安全上下文的方式。</span><span class="sxs-lookup"><span data-stu-id="20871-487">These two assignments are necessary because of the way security contexts are handled in ASP.NET.</span></span> <span data-ttu-id="20871-488">.NET Framework 将安全上下文与每个正在运行的线程关联;此信息可通过[Thread 对象](https://msdn.microsoft.com/library/system.threading.thread.aspx)的[Thread.currentprincipal 属性](https://msdn.microsoft.com/library/system.threading.thread.currentcontext.aspx)作为 IPrincipal 对象提供。</span><span class="sxs-lookup"><span data-stu-id="20871-488">The .NET Framework associates a security context with each running thread; this information is available as an IPrincipal object through the [Thread object](https://msdn.microsoft.com/library/system.threading.thread.aspx)'s [CurrentPrincipal property](https://msdn.microsoft.com/library/system.threading.thread.currentcontext.aspx).</span></span> <span data-ttu-id="20871-489">令人费解的是，ASP.NET 具有其自己的安全上下文信息（HttpContext）。</span><span class="sxs-lookup"><span data-stu-id="20871-489">What is a confusing is that ASP.NET has its own security context information (HttpContext.User).</span></span>

<span data-ttu-id="20871-490">在某些情况下，在确定安全上下文时会检查 Thread.currentprincipal 属性;在其他情况下，使用 HttpContext。</span><span class="sxs-lookup"><span data-stu-id="20871-490">In certain scenarios, the Thread.CurrentPrincipal property is examined when determining the security context; in other scenarios, HttpContext.User is used.</span></span> <span data-ttu-id="20871-491">例如，.NET 中有一些安全功能，这些功能可让开发人员以声明方式陈述哪些用户或角色可以实例化类或调用特定的方法（请参阅[使用 PrincipalPermissionAttributes 将授权规则添加到业务层和数据层](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)）。</span><span class="sxs-lookup"><span data-stu-id="20871-491">For example, there are security features in .NET that allow developers to declaratively state what users or roles can instantiate a class or invoke specific methods (see [Adding Authorization Rules to Business and Data Layers Using PrincipalPermissionAttributes](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)).</span></span> <span data-ttu-id="20871-492">这些声明性技术在涵盖范围下，通过 Thread.currentprincipal 属性确定安全上下文。</span><span class="sxs-lookup"><span data-stu-id="20871-492">Underneath the covers, these declarative techniques determine the security context via the Thread.CurrentPrincipal property.</span></span>

<span data-ttu-id="20871-493">在其他情况下，将使用 HttpContext 属性。</span><span class="sxs-lookup"><span data-stu-id="20871-493">In other scenarios, the HttpContext.User property is used.</span></span> <span data-ttu-id="20871-494">例如，在上一教程中，我们使用此属性来显示当前登录的用户的用户名。</span><span class="sxs-lookup"><span data-stu-id="20871-494">For example, in the previous tutorial we used this property to display the currently logged on user's username.</span></span> <span data-ttu-id="20871-495">显然，Thread.currentprincipal 和 HttpContext 属性中的安全上下文信息都是匹配的。</span><span class="sxs-lookup"><span data-stu-id="20871-495">Clearly, then, it is imperative that the security context information in the Thread.CurrentPrincipal and HttpContext.User properties match up.</span></span>

<span data-ttu-id="20871-496">ASP.NET 运行时自动为我们同步这些属性值。</span><span class="sxs-lookup"><span data-stu-id="20871-496">The ASP.NET runtime automatically syncs these property values for us.</span></span> <span data-ttu-id="20871-497">但是，此同步发生在 AuthenticateRequest 事件之后，而在 PostAuthenticateRequest 事件*之前*发生。</span><span class="sxs-lookup"><span data-stu-id="20871-497">However, this synchronization occurs after the AuthenticateRequest event, but *before* the PostAuthenticateRequest event.</span></span> <span data-ttu-id="20871-498">因此，在 PostAuthenticateRequest 事件中添加自定义主体时，需要确保手动分配 Thread.currentprincipal 或 else Thread.currentprincipal 和 HttpContext。用户将不同步。有关此问题的详细讨论，请参阅[thread.currentprincipal](http://leastprivilege.com/2005/11/23/context-user-vs-thread-currentprincipal/) 。</span><span class="sxs-lookup"><span data-stu-id="20871-498">Consequently, when adding a custom principal in the PostAuthenticateRequest event we need to be certain to manually assign the Thread.CurrentPrincipal or else Thread.CurrentPrincipal and HttpContext.User will be out of sync. See [Context.User vs. Thread.CurrentPrincipal](http://leastprivilege.com/2005/11/23/context-user-vs-thread-currentprincipal/) for a more detailed discussion on this issue.</span></span>

### <a name="accessing-the-companyname-and-title-properties"></a><span data-ttu-id="20871-499">访问 "公司名称" 和 "标题" 属性</span><span class="sxs-lookup"><span data-stu-id="20871-499">Accessing the CompanyName and Title Properties</span></span>

<span data-ttu-id="20871-500">每当请求到达并被调度到 ASP.NET 引擎时，将激发 global.asax 中的应用程序\_OnPostAuthenticateRequest 事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="20871-500">Whenever a request arrives and is dispatched to the ASP.NET engine, the Application\_OnPostAuthenticateRequest event handler in Global.asax will fire.</span></span> <span data-ttu-id="20871-501">如果请求已通过 FormsAuthenticationModule 成功进行身份验证，则事件处理程序将根据 forms 身份验证票证创建一个具有 CustomIdentity 对象的新 CustomPrincipal 对象。</span><span class="sxs-lookup"><span data-stu-id="20871-501">If the request has been successfully authenticated by the FormsAuthenticationModule, the event handler will create a new CustomPrincipal object with a CustomIdentity object based on the forms authentication ticket.</span></span> <span data-ttu-id="20871-502">利用这一逻辑，访问有关当前已登录用户的公司名称和职务的信息非常简单。</span><span class="sxs-lookup"><span data-stu-id="20871-502">With this logic in place, accessing information about the currently logged on user's company name and title is incredibly straightforward.</span></span>

<span data-ttu-id="20871-503">返回到\_Load 事件处理程序的页面。在步骤4中，我们编写了用于检索表单身份验证票证的代码，并分析了 UserData 属性，以便显示用户的公司名称和标题。</span><span class="sxs-lookup"><span data-stu-id="20871-503">Return to the Page\_Load event handler in Default.aspx, where in Step 4 we wrote code to retrieve the form authentication ticket and parse the UserData property in order to display the user's company name and title.</span></span> <span data-ttu-id="20871-504">现在，使用 CustomPrincipal 和 CustomIdentity 对象，无需分析票证的 UserData 属性中的值。</span><span class="sxs-lookup"><span data-stu-id="20871-504">With the CustomPrincipal and CustomIdentity objects in use now, there's no need to parse the values out of the ticket's UserData property.</span></span> <span data-ttu-id="20871-505">相反，只需获取对 CustomIdentity 对象的引用并使用其 "公司名称" 和 "标题" 属性：</span><span class="sxs-lookup"><span data-stu-id="20871-505">Instead, simply get a reference to the CustomIdentity object and use its CompanyName and Title properties:</span></span>

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample12.vb)]

## <a name="summary"></a><span data-ttu-id="20871-506">摘要</span><span class="sxs-lookup"><span data-stu-id="20871-506">Summary</span></span>

<span data-ttu-id="20871-507">在本教程中，我们介绍了如何通过 web.config 自定义 forms 身份验证系统的设置。我们查看了如何处理身份验证票证的过期，以及如何使用加密和验证安全措施来保护票证不被检查和修改。</span><span class="sxs-lookup"><span data-stu-id="20871-507">In this tutorial we examined how to customize the forms authentication system's settings via Web.config. We looked at how the authentication ticket's expiration is handled and how the encryption and validation safeguards are used to protect the ticket from inspection and modification.</span></span> <span data-ttu-id="20871-508">最后，我们讨论了如何使用身份验证票证的 UserData 属性在票证本身中存储其他用户信息，以及如何使用自定义主体和标识对象以更好的开发人员更好的方式公开这些信息。</span><span class="sxs-lookup"><span data-stu-id="20871-508">Finally, we discussed using the authentication ticket's UserData property to store additional user information in the ticket itself, and how to use custom principal and identity objects to expose this information in a more developer-friendly manner.</span></span>

<span data-ttu-id="20871-509">本教程介绍如何在 ASP.NET 中检查 forms 身份验证。</span><span class="sxs-lookup"><span data-stu-id="20871-509">This tutorial concludes our examination of forms authentication in ASP.NET.</span></span> <span data-ttu-id="20871-510">下一教程将开始我们的成员身份框架旅程。</span><span class="sxs-lookup"><span data-stu-id="20871-510">The next tutorial starts our journey into the Membership framework.</span></span>

<span data-ttu-id="20871-511">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="20871-511">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="20871-512">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="20871-512">Further Reading</span></span>

<span data-ttu-id="20871-513">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="20871-513">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="20871-514">二级 Forms 身份验证</span><span class="sxs-lookup"><span data-stu-id="20871-514">Dissecting Forms Authentication</span></span>](http://aspnet.4guysfromrolla.com/articles/072005-1.aspx)
- [<span data-ttu-id="20871-515">说明： ASP.NET 2.0 中的 Forms 身份验证</span><span class="sxs-lookup"><span data-stu-id="20871-515">Explained: Forms Authentication in ASP.NET 2.0</span></span>](https://msdn.microsoft.com/library/aa480476.aspx)
- [<span data-ttu-id="20871-516">如何：在 ASP.NET 2.0 中保护 Forms 身份验证</span><span class="sxs-lookup"><span data-stu-id="20871-516">How To: Protect Forms Authentication in ASP.NET 2.0</span></span>](https://msdn.microsoft.com/library/ms998310.aspx)
- <span data-ttu-id="20871-517">[Professional ASP.NET 2.0 安全性、成员身份和角色管理](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html)（ISBN：978-0-7645-9698-8）</span><span class="sxs-lookup"><span data-stu-id="20871-517">[Professional ASP.NET 2.0 Security, Membership, and Role Management](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html) (ISBN: 978-0-7645-9698-8)</span></span>
- [<span data-ttu-id="20871-518">保护登录控件</span><span class="sxs-lookup"><span data-stu-id="20871-518">Securing Login Controls</span></span>](https://msdn.microsoft.com/library/ms178346.aspx)
- [<span data-ttu-id="20871-519">&lt;authentication&gt; 元素</span><span class="sxs-lookup"><span data-stu-id="20871-519">The &lt;authentication&gt; Element</span></span>](https://msdn.microsoft.com/library/532aee0e.aspx)
- [<span data-ttu-id="20871-520">&lt;身份验证的 &lt;窗体&gt; 元素&gt;</span><span class="sxs-lookup"><span data-stu-id="20871-520">The &lt;forms&gt; Element for &lt;authentication&gt;</span></span>](https://msdn.microsoft.com/library/1d3t3c61.aspx)
- [<span data-ttu-id="20871-521">&lt;machineKey&gt; 元素</span><span class="sxs-lookup"><span data-stu-id="20871-521">The &lt;machineKey&gt; Element</span></span>](https://msdn.microsoft.com/library/w8h3skw9.aspx)
- [<span data-ttu-id="20871-522">了解 Forms 身份验证票证和 Cookie</span><span class="sxs-lookup"><span data-stu-id="20871-522">Understanding the Forms Authentication Ticket and Cookie</span></span>](https://support.microsoft.com/kb/910443)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a><span data-ttu-id="20871-523">本教程中包含的主题的视频培训</span><span class="sxs-lookup"><span data-stu-id="20871-523">Video Training on Topics Contained in this Tutorial</span></span>

- [<span data-ttu-id="20871-524">如何更改 Forms 身份验证属性</span><span class="sxs-lookup"><span data-stu-id="20871-524">How to Change the Forms Authentication Properties</span></span>](../../../videos/authentication/how-to-change-the-forms-authentication-properties.md)
- [<span data-ttu-id="20871-525">如何在 ASP.NET 应用程序中设置和使用不区分 Cookie 的身份验证</span><span class="sxs-lookup"><span data-stu-id="20871-525">How to Setup and Use Cookie-less Authentication in an ASP.NET Application</span></span>](../../../videos/authentication/how-to-setup-and-use-cookie-less-authentication-in-an-aspnet-application.md)
- [<span data-ttu-id="20871-526">ASP 窗体登录重定位</span><span class="sxs-lookup"><span data-stu-id="20871-526">ASP Forms Login Relocation</span></span>](../../../videos/authentication/asp-forms-login-relocation.md)
- [<span data-ttu-id="20871-527">窗体登录自定义密钥配置</span><span class="sxs-lookup"><span data-stu-id="20871-527">Forms Login Custom Key Configuration</span></span>](../../../videos/authentication/forms-login-custom-key-configuration.md)
- [<span data-ttu-id="20871-528">向身份验证方法添加自定义数据</span><span class="sxs-lookup"><span data-stu-id="20871-528">Add Custom Data to the Authentication Method</span></span>](../../../videos/authentication/add-custom-data-to-the-authentication-method.md)
- [<span data-ttu-id="20871-529">使用自定义主体对象</span><span class="sxs-lookup"><span data-stu-id="20871-529">Use Custom Principal Objects</span></span>](../../../videos/authentication/use-custom-principal-objects.md)

### <a name="about-the-author"></a><span data-ttu-id="20871-530">关于作者</span><span class="sxs-lookup"><span data-stu-id="20871-530">About the Author</span></span>

<span data-ttu-id="20871-531">Scott Mitchell，创始人的多个 ASP/ASP 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="20871-531">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="20871-532">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="20871-532">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="20871-533">他的最新书籍是， *[在24小时内，sam ASP.NET 2.0](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* 。</span><span class="sxs-lookup"><span data-stu-id="20871-533">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="20871-534">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="20871-534">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="20871-535">特别感谢</span><span class="sxs-lookup"><span data-stu-id="20871-535">Special Thanks To</span></span>

<span data-ttu-id="20871-536">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="20871-536">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="20871-537">本教程的主管审查人员是 Alicja Maziarz。</span><span class="sxs-lookup"><span data-stu-id="20871-537">Lead reviewer for this tutorial was Alicja Maziarz.</span></span> <span data-ttu-id="20871-538">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="20871-538">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="20871-539">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com)放置一行。</span><span class="sxs-lookup"><span data-stu-id="20871-539">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com).</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="20871-540">上一页</span><span class="sxs-lookup"><span data-stu-id="20871-540">Previous</span></span>](an-overview-of-forms-authentication-vb.md)
