---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: 解锁和审批用户帐户 (C#) |Microsoft Docs
author: rick-anderson
description: 本教程演示如何生成某一网页寻求管理员可以管理用户的锁定和批准状态。 我们还将了解如何批准新用户 o...
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: b27be9dff132989a37eca7d5ef3af7b0e1aaeb74
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/06/2019
ms.locfileid: "65131305"
---
# <a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="c7ed0-104">解锁和审批用户帐户 (C#)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-104">Unlocking and Approving User Accounts (C#)</span></span>

<span data-ttu-id="c7ed0-105">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="c7ed0-106">[下载代码](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip)或[下载 PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-106">[Download Code](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="c7ed0-107">本教程演示如何生成某一网页寻求管理员可以管理用户的锁定和批准状态。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="c7ed0-108">我们还将了解如何批准新用户，仅后他们验证其电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-108">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="introduction"></a><span data-ttu-id="c7ed0-109">介绍</span><span class="sxs-lookup"><span data-stu-id="c7ed0-109">Introduction</span></span>

<span data-ttu-id="c7ed0-110">用户名、 密码和电子邮件，以及每个用户帐户有两个状态字段指示用户是否可以登录到网站的： 锁定和批准。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="c7ed0-111">用户会自动锁定如果它们提供无效的凭据中指定的 （默认设置后将其锁定用户 10 分钟内的 5 个无效的登录尝试） 的分钟数按指定的次数。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="c7ed0-112">已批准的状态是在其中某项操作必须经过多新的用户能够登录到该站点之前的情况下很有用。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="c7ed0-113">例如，用户可能需要先验证其电子邮件地址或由管理员批准之前都无法提供登录名。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="c7ed0-114">因为锁定或未经批准用户无法登录，它是唯一的自然而然地想知道如何重置这些状态。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="c7ed0-115">ASP.NET 不包括任何内置功能或 Web 控件，用于管理用户的锁定和部分批准状态，因为这些决策需要基于站点的站点进行处理。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="c7ed0-116">某些站点可能会自动批准所有的新用户帐户 （默认行为）。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="c7ed0-117">其他人有管理员批准的新帐户或不批准用户直到他们访问他们注册时提供的电子邮件地址发送的链接。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="c7ed0-118">同样，某些站点可能会锁定用户，直到管理员重置其状态，而其他站点将一封电子邮件发送到 URL 的锁定用户他们可以访问要解锁其帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="c7ed0-119">本教程演示如何生成某一网页寻求管理员可以管理用户的锁定和批准状态。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="c7ed0-120">我们还将了解如何批准新用户，仅后他们验证其电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="c7ed0-121">步骤 1：管理用户的锁定和批准状态</span><span class="sxs-lookup"><span data-stu-id="c7ed0-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="c7ed0-122">在中<a id="Tutorial12"> </a> [*到选择一个用户帐户生成一个接口，从很多*](building-an-interface-to-select-one-user-account-from-many-cs.md)教程中我们构造列出中分页，每个用户帐户的页面筛选 GridView。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="c7ed0-123">网格列出每个用户的名称和电子邮件、 及其已批准和锁定状态，无论它们是当前联机和有关用户的任何备注。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="c7ed0-124">若要管理用户的批准和锁定状态，我们无法使此网格可编辑。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="c7ed0-125">若要更改用户的已批准的状态，管理员会首先找到用户帐户，并选中或取消选中已批准复选框，然后编辑相应的 GridView 行。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="c7ed0-126">或者，我们可以管理通过单独的 ASP.NET 页的已批准和锁定状态。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="c7ed0-127">对于本教程，让我们使用两个 ASP.NET 页：`ManageUsers.aspx`和`UserInformation.aspx`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="c7ed0-128">这里的思路是`ManageUsers.aspx`在系统中，列出的用户帐户时`UserInformation.aspx`使管理员能够管理的特定用户的批准和锁定状态。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="c7ed0-129">我们首要任务是以增加在 GridView`ManageUsers.aspx`包括 HyperLinkField，将呈现为链接的列。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="c7ed0-130">我们希望每个链接以指向`UserInformation.aspx?user=UserName`，其中*用户名*是要编辑的用户的名称。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="c7ed0-131">如果你已下载的代码<a id="Tutorial13"> </a> [*恢复和更改密码*](recovering-and-changing-passwords-cs.md)教程，您可能已经注意到，`ManageUsers.aspx`页已包含的一组"管理"链接和`UserInformation.aspx`页会提供一个接口更改选定的用户的密码。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="c7ed0-132">我决定不复制该功能在代码中与本教程中，因为它通过绕过成员身份 API 和操作直接与要更改用户的密码的 SQL Server 数据库的工作。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="c7ed0-133">本教程开始使用从头`UserInformation.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>

### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="c7ed0-134">添加"管理"链接到`UserAccounts`GridView</span><span class="sxs-lookup"><span data-stu-id="c7ed0-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="c7ed0-135">打开`ManageUsers.aspx`页上，添加到 HyperLinkField `UserAccounts` GridView。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="c7ed0-136">设置 HyperLinkField`Text`属性设置为"管理"并将其`DataNavigateUrlFields`并`DataNavigateUrlFormatString`属性设置为`UserName`和"UserInformation.aspx?user={0}"分别。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="c7ed0-137">这些设置以便所有超链接显示文本"管理"，但每个链接会将传递在相应配置 HyperLinkField*用户名*到查询字符串值。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="c7ed0-138">添加后 HyperLinkField 到 GridView，花点时间查看`ManageUsers.aspx`通过浏览器的页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="c7ed0-139">如图 1 所示，每个 GridView 行现在包括"管理"链接。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="c7ed0-140">Bruce 的"管理"链接指向`UserInformation.aspx?user=Bruce`，而 Dave 的"管理"链接指向`UserInformation.aspx?user=Dave`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>

<span data-ttu-id="c7ed0-141">[![添加了 HyperLinkField](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="c7ed0-142">**图 1**:HyperLinkField 将为每个用户帐户添加的"管理"链接 ([单击此项可查看原尺寸图像](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>

<span data-ttu-id="c7ed0-143">创建用户界面，并为代码`UserInformation.aspx`页中时刻，但首先让我们讨论有关如何以编程方式更改用户的锁定和批准状态。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="c7ed0-144">[ `MembershipUser`类](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)具有[ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx)并[`IsApproved`属性](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="c7ed0-145">`IsLockedOut`属性是只读的。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="c7ed0-146">没有任何机制来以编程方式锁定用户;若要解锁用户，请使用`MembershipUser`类的[`UnlockUser`方法](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="c7ed0-147">`IsApproved`属性是可读和可写。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="c7ed0-148">若要保存对此属性的任何更改，我们需要调用`Membership`类的[`UpdateUser`方法](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)，并传入已修改`MembershipUser`对象。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="c7ed0-149">因为`IsApproved`属性是可读和可写，复选框控件可能是用于配置此属性的最佳用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="c7ed0-150">但是，一个复选框将不能用于`IsLockedOut`属性管理员不能锁定用户，因为她可能仅解锁用户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="c7ed0-151">为一个合适的用户界面`IsLockedOut`属性是一个按钮，单击时，解除了该用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="c7ed0-152">如果用户锁定，则只应启用此按钮。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="c7ed0-153">创建`UserInformation.aspx`页</span><span class="sxs-lookup"><span data-stu-id="c7ed0-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="c7ed0-154">我们现已准备好实现中的用户界面`UserInformation.aspx`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="c7ed0-155">打开此页并添加以下 Web 控件：</span><span class="sxs-lookup"><span data-stu-id="c7ed0-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="c7ed0-156">超链接控件，单击时，返回到管理员`ManageUsers.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="c7ed0-157">用于显示所选的用户的名称的标签 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="c7ed0-158">设置此标签`ID`到`UserNameLabel`并将清除其`Text`属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="c7ed0-159">名为的复选框控件`IsApproved`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="c7ed0-160">设置其`AutoPostBack`属性设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="c7ed0-161">用于显示用户的标签控件的上一次锁定出日期。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="c7ed0-162">命名此标签`LastLockedOutDateLabel`并将清除其`Text`属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="c7ed0-163">用于解锁用户按钮。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-163">A Button for unlocking the user.</span></span> <span data-ttu-id="c7ed0-164">命名此按钮`UnlockUserButton`并设置其`Text`属性设置为"解锁用户"。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="c7ed0-165">标签控件用于显示状态消息，例如"已更新用户的已批准的状态"。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="c7ed0-166">命名此控件`StatusMessage`，清除出其`Text`属性，并设置其`CssClass`属性设置为`Important`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="c7ed0-167">( `Important` CSS 类中定义`Styles.css`样式表文件; 它以大型、 红色字体显示相应的文本。)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="c7ed0-168">添加这些控件之后, 在 Visual Studio 中的设计视图应类似于屏幕截图图 2 中。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>

<span data-ttu-id="c7ed0-169">[![创建 UserInformation.aspx 的用户界面](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="c7ed0-170">**图 2**:创建的用户界面`UserInformation.aspx`([单击以查看实际尺寸的图像](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>

<span data-ttu-id="c7ed0-171">用户界面完成后，我们的下一个任务是设置`IsApproved`复选框和其他控件根据所选的用户的信息。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="c7ed0-172">创建页面的一个事件处理程序`Load`事件，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="c7ed0-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="c7ed0-173">上面的代码首先会确保这第一次访问的页面并不在后续回发。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="c7ed0-174">随后，将通过传递的用户名`user`查询字符串字段，并检索有关该用户帐户，通过信息`Membership.GetUser(username)`方法。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="c7ed0-175">如果没有用户名提供通过在查询字符串，或者如果找不到指定的用户，管理员发送回`ManageUsers.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="c7ed0-176">`MembershipUser`对象的`UserName`值然后显示在`UserNameLabel`并且`IsApproved`选中复选框根据`IsApproved`属性值。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="c7ed0-177">`MembershipUser`对象的[`LastLockoutDate`属性](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx)返回`DateTime`值，该值指示用户上次已锁定。如果用户永远不会被锁定，返回的值取决于成员资格提供程序。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="c7ed0-178">创建新的帐户后，`SqlMembershipProvider`设置`aspnet_Membership`表的`LastLockoutDate`字段`1754-01-01 12:00:00 AM`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="c7ed0-179">上面的代码显示在一个空字符串`LastLockoutDateLabel`如果`LastLockoutDate`属性出现在年之前 2000年; 否则为的日期部分`LastLockoutDate`标签中显示属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="c7ed0-180">`UnlockUserButton'` S`Enabled`属性设置为用户的锁定状态，这意味着如果用户锁定才会启用此按钮。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="c7ed0-181">请花费片刻时间来测试`UserInformation.aspx`通过浏览器的页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="c7ed0-182">您将当然，需要开始`ManageUsers.aspx`，然后选择要管理的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="c7ed0-183">在到达`UserInformation.aspx`，请注意，`IsApproved`仅已选中复选框，如果用户批准。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="c7ed0-184">如果用户曾经已锁定，则显示上一个锁定日期。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="c7ed0-185">用户当前被锁定的情况下，才启用解锁用户按钮。选中或取消选中`IsApproved`复选框或单击解除锁定用户按钮会导致回发，但不修改都会对用户帐户，因为我们尚未为创建这些事件的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="c7ed0-186">返回到 Visual Studio 并创建事件处理程序`IsApproved`复选框的`CheckedChanged`事件并`UnlockUser`按钮的`Click`事件。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="c7ed0-187">在中`CheckedChanged`事件处理程序设置的用户`IsApproved`属性设置为`Checked`属性的复选框，然后保存所做更改，通过调用`Membership.UpdateUser`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="c7ed0-188">在中`Click`事件处理程序，只需调用`MembershipUser`对象的`UnlockUser`方法。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="c7ed0-189">在这两个事件处理程序中，显示在合适的消息`StatusMessage`标签。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="c7ed0-190">测试`UserInformation.aspx`页</span><span class="sxs-lookup"><span data-stu-id="c7ed0-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="c7ed0-191">在发生这些事件处理程序，与重新访问该页和未批准的用户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="c7ed0-192">图 3 所示，你应该看到一条消息，指示在页上用户的简短`IsApproved`已成功修改属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>

<span data-ttu-id="c7ed0-193">[![Chris 已被未批准](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="c7ed0-194">**图 3**:Chris 已被未批准 ([单击此项可查看原尺寸图像](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>

<span data-ttu-id="c7ed0-195">接下来，先注销，然后重试以用户身份登录其帐户时只是未批准。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="c7ed0-196">用户未获批准，因为它们不能登录。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="c7ed0-197">默认情况下，Login 控件显示同一消息，如果用户无法登录，无论是什么原因。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="c7ed0-198">但在<a id="Tutorial6"> </a> [*验证用户凭据对成员身份用户存储*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md)教程探讨了增强登录控件以显示更合适的消息。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="c7ed0-199">如图 4 所示，Chris 是显示一条消息说明，他不能成功登录，因为他的帐户尚未批准。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>

<span data-ttu-id="c7ed0-200">[![Chris 不能登录因为 His 帐户未批准](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="c7ed0-201">**图 4**:Chris 不能登录因为 His 帐户是否未批准 ([单击此项可查看原尺寸图像](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>

<span data-ttu-id="c7ed0-202">若要测试的锁定的功能，请尝试作为已批准用户，登录，但使用了错误的密码。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="c7ed0-203">重复此过程所需数量的次多次，直至用户的帐户已锁定。Login 控件也已更新为显示自定义消息如果尝试从锁定的帐户登录。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="c7ed0-204">您知道，帐户已锁定后，开始看到在登录页上的以下消息："你的帐户已锁定由于无效的登录尝试次数太多。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="c7ed0-205">请与管理员联系以解锁帐户。"</span><span class="sxs-lookup"><span data-stu-id="c7ed0-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="c7ed0-206">返回到`ManageUsers.aspx`页上，单击管理链接为锁定状态的用户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="c7ed0-207">图 5 所示，你应该看到中的值`LastLockedOutDateLabel`应启用解锁用户按钮。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="c7ed0-208">单击解除锁定用户按钮以解锁用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="c7ed0-209">一旦解锁用户，他们将能够再次登录。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-209">Once you have unlocked the user, they will be able to login again.</span></span>

<span data-ttu-id="c7ed0-210">[![Dave 锁定系统](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="c7ed0-211">**图 5**:Dave 具有已锁定的系统 ([单击此项可查看原尺寸图像](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>

## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="c7ed0-212">步骤 2：指定新用户的批准状态</span><span class="sxs-lookup"><span data-stu-id="c7ed0-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="c7ed0-213">已批准的状态是在想要一个新用户能够登录并访问该站点的特定于用户的功能之前执行某些操作的情况下很有用。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="c7ed0-214">例如，您可能在运行所有页面，除了登录名和注册页中，仅供经过身份验证的用户访问专用网站。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="c7ed0-215">但是，会发生什么情况象是达到你的网站，查找注册页上，并创建一个帐户？</span><span class="sxs-lookup"><span data-stu-id="c7ed0-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="c7ed0-216">若要避免这种情况发生无法移动到注册页`Administration`文件夹中，并且需要管理员手动创建的每个帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="c7ed0-217">或者，您可以允许任何人进行注册，但禁止站点访问，直到得到管理员的批准的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="c7ed0-218">默认情况下，CreateUserWizard 控件批准新的帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="c7ed0-219">你可以配置使用控件的此行为[`DisableCreatedUser`属性](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="c7ed0-220">将此属性设置为`true`不批准新的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="c7ed0-221">默认情况下 CreateUserWizard 控件自动登录新用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="c7ed0-222">此行为由该控件的指定[`LoginCreatedUser`属性](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="c7ed0-223">未批准的用户无法登录到站点，因为当`DisableCreatedUser`是`true`新的用户帐户未登录到站点，而不考虑值`LoginCreatedUser`属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>

<span data-ttu-id="c7ed0-224">如果要以编程方式创建新用户帐户通过`Membership.CreateUser`方法中，若要创建的未批准的用户帐户使用接受新用户的重载之一`IsApproved`作为输入参数的属性值。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="c7ed0-225">步骤 3：批准用户通过验证其电子邮件地址</span><span class="sxs-lookup"><span data-stu-id="c7ed0-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="c7ed0-226">支持用户帐户的很多网站不批准新用户，直到它们验证时注册它们提供的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="c7ed0-227">此验证过程通常用于防止机器人、 垃圾邮件发送者和不入流，因为它需要是唯一的已验证电子邮件地址，并在注册过程中添加一个额外的步骤。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="c7ed0-228">借助此模型中，当新用户注册时它们会发送电子邮件，其中包含链接到验证页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="c7ed0-229">通过访问以下链接用户已被证明他们收到该电子邮件和，因此，提供的电子邮件，地址有效。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="c7ed0-230">验证页是负责审批用户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="c7ed0-231">这可能会自动发生，从而批准的任何用户都到达此页上，或仅在用户提供一些其他信息，如后[CAPTCHA](http://en.wikipedia.org/wiki/Captcha)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="c7ed0-232">为了适应此工作流，我们需要首先更新帐户创建页面，以便新用户未获批准。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="c7ed0-233">打开`EnhancedCreateUserWizard.aspx`页中`Membership`文件夹并设置 CreateUserWizard 控件`DisableCreatedUser`属性设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="c7ed0-234">接下来，我们需要配置 CreateUserWizard 控件以将一封电子邮件发送到新用户，说明如何验证其帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="c7ed0-235">具体而言，我们将电子邮件中包含一个链接`Verification.aspx`页 (我们尚未为其创建)，并传入新用户的`UserId`通过在查询字符串。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="c7ed0-236">`Verification.aspx`页将查找指定的用户，并将其批准的标记。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="c7ed0-237">将验证电子邮件发送到新用户</span><span class="sxs-lookup"><span data-stu-id="c7ed0-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="c7ed0-238">若要从 CreateUserWizard 控件发送一封电子邮件，配置其`MailDefinition`属性正确。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="c7ed0-239">如中所述<a id="Tutorial13"> </a>[前一篇教程](recovering-and-changing-passwords-cs.md)，ChangePassword 和 PasswordRecovery 控件包括[`MailDefinition`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx)其工作方式与CreateUserWizard 控件的。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="c7ed0-240">若要使用`MailDefinition`中的属性需要指定邮件传递选项`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="c7ed0-241">有关详细信息，请参阅[在 ASP.NET 中发送电子邮件](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>

<span data-ttu-id="c7ed0-242">首先，创建一个名为的新电子邮件模板`CreateUserWizard.txt`在`EmailTemplates`文件夹。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="c7ed0-243">模板使用以下文本：</span><span class="sxs-lookup"><span data-stu-id="c7ed0-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="c7ed0-244">设置`MailDefinition'`s`BodyFileName`属性设置为"~ / EmailTemplates/CreateUserWizard.txt"并将其`Subject`属性设置为"欢迎使用我的网站 ！</span><span class="sxs-lookup"><span data-stu-id="c7ed0-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="c7ed0-245">请激活您的帐户。"</span><span class="sxs-lookup"><span data-stu-id="c7ed0-245">Please activate your account."</span></span>

<span data-ttu-id="c7ed0-246">请注意，`CreateUserWizard.txt`电子邮件模板包括`<%VerificationUrl%>`占位符。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="c7ed0-247">这就是 URL`Verification.aspx`将放置页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="c7ed0-248">将自动替换 CreateUserWizard`<%UserName%>`并`<%Password%>`占位符替换新帐户的用户名和密码，但没有内置的`<%VerificationUrl%>`占位符。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="c7ed0-249">我们需要手动将其替换为相应的验证 URL。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="c7ed0-250">若要实现此目的，创建一个事件处理程序 CreateUserWizard [ `SendingMail`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx)并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="c7ed0-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="c7ed0-251">`SendingMail`事件后会激发`CreatedUser`事件，这意味着，上述的事件处理程序执行新用户时已创建帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="c7ed0-252">我们就可以访问新用户的`UserId`值通过调用`Membership.GetUser`方法，传入`UserName`CreateUserWizard 控件中输入。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="c7ed0-253">接下来，将形成的验证 URL。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="c7ed0-254">该语句`Request.Url.GetLeftPart(UriPartial.Authority)`返回`http://yourserver.com`一部分而定。`Request.ApplicationPath`返回应用程序的根节点位置的路径。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="c7ed0-255">验证 URL 然后定义为`Verification.aspx?ID=userId`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="c7ed0-256">然后将其连接这两个字符串以形成完整的 URL。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="c7ed0-257">最后，将电子邮件正文 (`e.Message.Body`) 具有的所有匹配项`<%VerificationUrl%>`替换为完整的 URL。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="c7ed0-258">实际效果是新用户未批准的这意味着它们不能登录到网站。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="c7ed0-259">此外，它们将自动发送包含链接的电子邮件到的验证 URL （请参阅图 6）。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>

<span data-ttu-id="c7ed0-260">[![新用户会收到包含验证 URL 的链接的电子邮件](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="c7ed0-261">**图 6**:新用户会收到一封电子邮件，其中包含指向验证 URL ([单击此项可查看原尺寸图像](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>

> [!NOTE]
> <span data-ttu-id="c7ed0-262">CreateUserWizard 控件的默认 CreateUserWizard 步骤才会显示一条消息，告知的用户其帐户已创建并显示继续按钮。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="c7ed0-263">单击此将用户转到由该控件的指定的 URL`ContinueDestinationPageUrl`属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="c7ed0-264">在 CreateUserWizard`EnhancedCreateUserWizard.aspx`配置为发送新用户添加到`~/Membership/AdditionalUserInfo.aspx`，此时会提示用户输入其家乡，主页 URL 和签名。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="c7ed0-265">因为此信息只能通过登录的用户，所以应该更新此属性，以向用户发送回站点的主页 (`~/Default.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="c7ed0-266">此外，`EnhancedCreateUserWizard.aspx`应增加页面或 CreateUserWizard 步骤向用户通知它们已发送验证电子邮件和不会激活其帐户，直到它们按照此电子邮件中的说明。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="c7ed0-267">我将这些修改作为练习留给读者。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-267">I leave these modifications as an exercise for the reader.</span></span>

### <a name="creating-the-verification-page"></a><span data-ttu-id="c7ed0-268">创建验证页</span><span class="sxs-lookup"><span data-stu-id="c7ed0-268">Creating the Verification Page</span></span>

<span data-ttu-id="c7ed0-269">最后一项任务是创建`Verification.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="c7ed0-270">将此页添加到根文件夹，将其与`Site.master`母版页。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="c7ed0-271">像我们所做的大部分添加到该站点在前面的内容页中，删除引用的内容控件`LoginContent`ContentPlaceHolder，以便内容页使用母版页的默认内容。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="c7ed0-272">添加到标签 Web 控件`Verification.aspx`页上，将其`ID`到`StatusMessage`并将清除其 text 属性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="c7ed0-273">接下来，创建`Page_Load`事件处理程序并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="c7ed0-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="c7ed0-274">上面的代码大部分确认`UserId`通过提供查询字符串存在，它是一个有效`Guid`值和它引用现有的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="c7ed0-275">如果所有这些检查通过，批准的用户帐户;否则，将显示一条合适的状态消息。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="c7ed0-276">图 7 显示了`Verification.aspx`页上通过浏览器访问时。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>

<span data-ttu-id="c7ed0-277">[![新用户的帐户是现在批准](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="c7ed0-278">**图 7**:新用户的帐户是现在批准 ([单击此项可查看原尺寸图像](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="c7ed0-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>

## <a name="summary"></a><span data-ttu-id="c7ed0-279">总结</span><span class="sxs-lookup"><span data-stu-id="c7ed0-279">Summary</span></span>

<span data-ttu-id="c7ed0-280">所有成员资格用户帐户具有确定用户可以登录到网站的两种状态：`IsLockedOut`和`IsApproved`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="c7ed0-281">两个属性必须是`true`该用户的登录名。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="c7ed0-282">用户的锁定状态用作一种安全措施以减少黑客通过暴力破解方法到站点中断的可能性。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="c7ed0-283">具体而言，用户被锁定是否存在一定数量的特定的时间窗口内的无效登录尝试。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="c7ed0-284">这些边界是通过中的成员资格提供程序设置可配置`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="c7ed0-285">已批准的状态通常用作一种方法来禁止新用户登录，直到某项操作已发生的情况。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="c7ed0-286">站点可能需要先由管理员批准的新帐户或与我们在步骤 3 中看到通过验证其电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="c7ed0-287">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="c7ed0-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="c7ed0-288">关于作者</span><span class="sxs-lookup"><span data-stu-id="c7ed0-288">About the Author</span></span>

<span data-ttu-id="c7ed0-289">自 1998 年以来，Scott Mitchell，多部 asp/ASP.NET 书籍的作者及 4GuysFromRolla.com 的已从事 Microsoft Web 技术工作。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="c7ed0-290">Scott 是独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="c7ed0-291">他最新著作是 *[Sams Teach 自己 ASP.NET 2.0 24 小时内](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="c7ed0-292">可以在达到 Scott [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com)或通过他的博客[ http://ScottOnWriting.NET ](http://scottonwriting.net/)。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="c7ed0-293">特别感谢...</span><span class="sxs-lookup"><span data-stu-id="c7ed0-293">Special Thanks To…</span></span>

<span data-ttu-id="c7ed0-294">很多有用的审阅者已评审本系列教程。</span><span class="sxs-lookup"><span data-stu-id="c7ed0-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="c7ed0-295">是否有兴趣查看我即将推出的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="c7ed0-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="c7ed0-296">如果是这样，给我在行 [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="c7ed0-297">[上一页](recovering-and-changing-passwords-cs.md)
> [下一页](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="c7ed0-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
