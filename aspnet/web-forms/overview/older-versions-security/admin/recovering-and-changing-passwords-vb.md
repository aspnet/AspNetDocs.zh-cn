---
uid: web-forms/overview/older-versions-security/admin/recovering-and-changing-passwords-vb
title: 恢复和更改密码（VB） |Microsoft Docs
author: rick-anderson
description: ASP.NET 包含两个用于帮助恢复和更改密码的 Web 控件。 PasswordRecovery 控件使访问者能够恢复其丢失的 pa 。
ms.author: riande
ms.date: 04/01/2008
ms.assetid: f9adcb5d-6d70-4885-a3bf-ed95efb4da1a
msc.legacyurl: /web-forms/overview/older-versions-security/admin/recovering-and-changing-passwords-vb
msc.type: authoredcontent
ms.openlocfilehash: 0ed1df9455af94a86ce59ecc06c55846a4880596
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78510608"
---
# <a name="recovering-and-changing-passwords-vb"></a><span data-ttu-id="5aa7c-104">恢复和更改密码 (VB)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-104">Recovering and Changing Passwords (VB)</span></span>

<span data-ttu-id="5aa7c-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="5aa7c-106">[下载代码](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/VB.13.zip)或[下载 PDF](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial13_ChangingPasswords_vb.pdf)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-106">[Download Code](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/VB.13.zip) or [Download PDF](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial13_ChangingPasswords_vb.pdf)</span></span>

> <span data-ttu-id="5aa7c-107">ASP.NET 包含两个用于帮助恢复和更改密码的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-107">ASP.NET includes two Web controls for assisting with recovering and changing passwords.</span></span> <span data-ttu-id="5aa7c-108">PasswordRecovery 控件使访问者能够恢复其丢失的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-108">The PasswordRecovery control enables a visitor to recover his lost password.</span></span> <span data-ttu-id="5aa7c-109">ChangePassword 控件允许用户更新其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-109">The ChangePassword control allows the user to update his password.</span></span> <span data-ttu-id="5aa7c-110">与我们在本系列教程中看到的其他与登录相关的 Web 控件一样，PasswordRecovery 和 ChangePassword 控件适用于后台的成员身份框架，用于重置或修改用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-110">Like the other Login-related Web controls we've seen throughout this tutorial series, the PasswordRecovery and ChangePassword controls work with the Membership framework behind the scenes to reset or modify users' passwords.</span></span>

## <a name="introduction"></a><span data-ttu-id="5aa7c-111">简介</span><span class="sxs-lookup"><span data-stu-id="5aa7c-111">Introduction</span></span>

<span data-ttu-id="5aa7c-112">在我的银行、公用事业公司、手机公司、电子邮件帐户和个性化 web 门户的网站之间，我像大多数人一样，我要记住许多不同的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-112">Between the websites for my bank, utility company, phone company, email accounts, and personalized web portals, I, like most people, have dozens of different passwords to remember.</span></span> <span data-ttu-id="5aa7c-113">由于有这么多的凭据需要记住，这种情况并不太常见，人们忘记了自己的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-113">With so many credentials to memorize these days, it's not uncommon for people to forget their password.</span></span> <span data-ttu-id="5aa7c-114">为此，提供用户帐户的网站需要为用户提供一种恢复其密码的方法。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-114">To account for this, websites that offer user accounts need to include a way for a user to recover his password.</span></span> <span data-ttu-id="5aa7c-115">此过程通常涉及生成新的随机密码，并通过电子邮件将其发送给用户在文件上的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-115">This process typically involves generating a new, random password and emailing it to the user's email address on file.</span></span> <span data-ttu-id="5aa7c-116">收到新密码后，大多数用户都返回到该站点，并将其密码从随机生成的密码更改为更容易记住的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-116">After receiving their new password most users return to the site and change their password from the randomly generated one to a more memorable one.</span></span>

<span data-ttu-id="5aa7c-117">ASP.NET 包含两个用于帮助恢复和更改密码的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-117">ASP.NET includes two Web controls for assisting with recovering and changing passwords.</span></span> <span data-ttu-id="5aa7c-118">PasswordRecovery 控件使访问者能够恢复其丢失的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-118">The PasswordRecovery control enables a visitor to recover his lost password.</span></span> <span data-ttu-id="5aa7c-119">ChangePassword 控件允许用户更新其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-119">The ChangePassword control allows the user to update his password.</span></span> <span data-ttu-id="5aa7c-120">与我们在本系列教程中看到的其他与登录相关的 Web 控件一样，PasswordRecovery 和 ChangePassword 控件适用于后台的成员身份框架，用于重置或修改用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-120">Like the other Login-related Web controls we've seen throughout this tutorial series, the PasswordRecovery and ChangePassword controls work with the Membership framework behind the scenes to reset or modify users' passwords.</span></span>

<span data-ttu-id="5aa7c-121">在本教程中，我们将使用这两个控件进行检查。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-121">In this tutorial we will examine using these two controls.</span></span> <span data-ttu-id="5aa7c-122">我们还将了解如何通过 `MembershipUser` 类的 `ChangePassword` 和 `ResetPassword` 方法以编程方式更改和重置用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-122">We will also see how to programmatically change and reset a user's password via the `MembershipUser` class's `ChangePassword` and `ResetPassword` methods.</span></span>

## <a name="step-1-helping-users-recover-lost-passwords"></a><span data-ttu-id="5aa7c-123">步骤1：帮助用户恢复丢失的密码</span><span class="sxs-lookup"><span data-stu-id="5aa7c-123">Step 1: Helping Users Recover Lost Passwords</span></span>

<span data-ttu-id="5aa7c-124">支持用户帐户的所有网站都需要为用户提供一些用于恢复其忘记的密码的机制。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-124">All websites that support user accounts need to provide users with some mechanism for recovering their forgotten passwords.</span></span> <span data-ttu-id="5aa7c-125">好消息是，通过 PasswordRecovery Web 控件，实现 ASP.NET 中的此类功能非常简单。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-125">The good news is that implementing such functionality in ASP.NET is a breeze thanks to the PasswordRecovery Web control.</span></span> <span data-ttu-id="5aa7c-126">PasswordRecovery 控件呈现一个接口，该接口提示用户输入其用户名，并在需要时提示其安全问题的答案。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-126">The PasswordRecovery control renders an interface that prompts the user for their username and, if needed, the answer to their security question.</span></span> <span data-ttu-id="5aa7c-127">然后，通过电子邮件向用户发送其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-127">It then emails the user their password.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-128">由于电子邮件以纯文本方式在网络上传输，因此通过电子邮件发送用户密码会带来安全风险。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-128">Because email messages are transmitted over the wire in plain-text there are security risks involved with sending a user's password via email.</span></span>

<span data-ttu-id="5aa7c-129">PasswordRecovery 控件包含三个视图：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-129">The PasswordRecovery control consists of three views:</span></span>

- <span data-ttu-id="5aa7c-130">**用户名**-提示访问者输入用户名。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-130">**UserName** - prompts the visitor for their username.</span></span> <span data-ttu-id="5aa7c-131">这是初始视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-131">This is the initial view.</span></span>
- <span data-ttu-id="5aa7c-132">**问题**-将用户的用户名和安全问题显示为文本，并将用户的文本框输入到安全问题的答案。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-132">**Question**- displays the user's username and security question as text, along with a TextBox for the user to enter the answer to his security question.</span></span>
- <span data-ttu-id="5aa7c-133">**成功**-显示一条消息，告知用户其密码已通过电子邮件发送。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-133">**Success**- displays a message informing the user that his password has been emailed.</span></span>

<span data-ttu-id="5aa7c-134">显示的视图和 PasswordRecovery 控件执行的操作取决于下列成员身份配置设置：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-134">The views displayed and actions performed by the PasswordRecovery control depend upon the following Membership configuration settings:</span></span>

- `RequiresQuestionAndAnswer`
- `EnablePasswordRetrieval`
- `EnablePasswordReset`

<span data-ttu-id="5aa7c-135">成员身份框架的 `RequiresQuestionAndAnswer` 设置指示用户在注册帐户时是否必须指定安全问题和答案。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-135">The Membership framework's `RequiresQuestionAndAnswer` setting indicates whether users must specify a security question and answer when registering for an account.</span></span> <span data-ttu-id="5aa7c-136">如我们在<a id="_msoanchor_1"> </a>[*创建用户帐户*](../membership/creating-user-accounts-vb.md)教程中所述，如果 `RequiresQuestionAndAnswer` 为 True （默认值），则 CreateUserWizard 的接口包含新用户的安全问题和答案的 TextBox 控件;如果 `RequiresQuestionAndAnswer` 为 False，则不收集此类信息。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-136">As we discussed in the <a id="_msoanchor_1"></a>[*Creating User Accounts*](../membership/creating-user-accounts-vb.md) tutorial, if `RequiresQuestionAndAnswer` is True (the default) then the CreateUserWizard's interface includes TextBox controls for the new user's security question and answer; if `RequiresQuestionAndAnswer` is False, no such information is collected.</span></span> <span data-ttu-id="5aa7c-137">同样，如果 `RequiresQuestionAndAnswer` 为 True，则在用户输入用户名后，PasswordRecovery 控件将显示问题视图;仅当用户输入正确的安全答案时才会恢复密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-137">Similarly, if `RequiresQuestionAndAnswer` is True, then the PasswordRecovery control displays the Question view after the user has entered their username; the password is recovered only if the user enters the correct security answer.</span></span> <span data-ttu-id="5aa7c-138">但是，如果 `RequiresQuestionAndAnswer` 为 False，则 PasswordRecovery 控件将从 "用户名" 视图直接移至 "成功" 视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-138">If `RequiresQuestionAndAnswer` is False, however, the PasswordRecovery control moves straight from the UserName view to the Success view.</span></span>

<span data-ttu-id="5aa7c-139">用户提供用户名或用户名和安全答案后，如果 `RequiresQuestionAndAnswer` 为 True，则 PasswordRecovery 会向用户发送其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-139">After the user has provided his username - or his username and security answer, if `RequiresQuestionAndAnswer` is True - the PasswordRecovery emails the user his password.</span></span> <span data-ttu-id="5aa7c-140">如果 `EnablePasswordRetrieval` 选项设置为 True，则用户通过电子邮件发送其当前密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-140">If the `EnablePasswordRetrieval` option is set to True, then the user is emailed their current password.</span></span> <span data-ttu-id="5aa7c-141">如果将其设置为 False，并将 `EnablePasswordReset` 设置为 True，则 PasswordRecovery 控件将为用户生成一个新的随机密码，并向其发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-141">If it is set to False and `EnablePasswordReset` is set to True, then the PasswordRecovery control generates a new, random password for the user, and emails this new password to them.</span></span> <span data-ttu-id="5aa7c-142">如果 `EnablePasswordRetrieval` 和 `EnablePasswordReset` 均为 False，则 PasswordRecovery 控件将引发异常。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-142">If both `EnablePasswordRetrieval` and `EnablePasswordReset` are False, the PasswordRecovery control throws an exception.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-143">请记住，`SqlMembershipProvider` 以以下三种格式之一存储用户密码：清除、哈希（默认值）或加密。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-143">Recall that the `SqlMembershipProvider` stores users' passwords in one of three formats: Clear, Hashed (the default), or Encrypted.</span></span> <span data-ttu-id="5aa7c-144">使用的存储机制取决于成员身份配置设置;演示程序使用经过哈希处理的密码格式。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-144">The storage mechanism used depends on the Membership configuration settings; the demo application uses the Hashed password format.</span></span> <span data-ttu-id="5aa7c-145">使用哈希密码格式时，`EnablePasswordRetrieval` 选项必须设置为 False，因为系统无法从存储在数据库中的哈希版本确定用户的实际密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-145">When using the Hashed password format the `EnablePasswordRetrieval` option must be set to False because the system cannot determine the user's actual password from the hashed version stored in the database.</span></span>

<span data-ttu-id="5aa7c-146">图1说明了成员身份配置如何影响 PasswordRecovery 的接口和行为。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-146">Figure 1 illustrates how the PasswordRecovery's interface and behavior is influenced by the Membership configuration.</span></span>

<span data-ttu-id="5aa7c-147">[![RequiresQuestionAndAnswer、EnablePasswordRetrieval 和 EnablePasswordReset 影响 PasswordRecovery 控件的外观和行为](recovering-and-changing-passwords-vb/_static/image2.png)](recovering-and-changing-passwords-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-147">[![The RequiresQuestionAndAnswer, EnablePasswordRetrieval, and EnablePasswordReset Influence the PasswordRecovery control's Appearance and Behavior](recovering-and-changing-passwords-vb/_static/image2.png)](recovering-and-changing-passwords-vb/_static/image1.png)</span></span>

<span data-ttu-id="5aa7c-148">**图 1**： `RequiresQuestionAndAnswer`、`EnablePasswordRetrieval`和 `EnablePasswordReset` 影响 PasswordRecovery 控件的外观和行为（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-148">**Figure 1**: The `RequiresQuestionAndAnswer`, `EnablePasswordRetrieval`, and `EnablePasswordReset` Influence the PasswordRecovery control's Appearance and Behavior  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image3.png))</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-149"><a id="_msoanchor_2"></a>在 SQL Server 教程中[*创建成员身份架构*](../membership/creating-the-membership-schema-in-sql-server-vb.md)中，我们通过将 `RequiresQuestionAndAnswer` 设置为 true，`EnablePasswordRetrieval` 设置为 False，并 `EnablePasswordReset` 为 true 来配置成员资格提供程序。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-149">In the <a id="_msoanchor_2"></a>[*Creating the Membership Schema in SQL Server*](../membership/creating-the-membership-schema-in-sql-server-vb.md) tutorial we configured the Membership provider by setting `RequiresQuestionAndAnswer` to True, `EnablePasswordRetrieval` to False, and `EnablePasswordReset` to True.</span></span>

### <a name="using-the-passwordrecovery-control"></a><span data-ttu-id="5aa7c-150">使用 PasswordRecovery 控件</span><span class="sxs-lookup"><span data-stu-id="5aa7c-150">Using the PasswordRecovery Control</span></span>

<span data-ttu-id="5aa7c-151">让我们看一下如何在 ASP.NET 页中使用 PasswordRecovery 控件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-151">Let's look at using the PasswordRecovery control in an ASP.NET page.</span></span> <span data-ttu-id="5aa7c-152">打开 `RecoverPassword.aspx` 并将 PasswordRecovery 控件从工具箱拖放到设计器上;将其 `ID` 设置为 `RecoverPwd`。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-152">Open `RecoverPassword.aspx` and drag and drop a PasswordRecovery control from the Toolbox onto the Designer; set its `ID` to `RecoverPwd`.</span></span> <span data-ttu-id="5aa7c-153">与登录和 CreateUserWizard Web 控件一样，PasswordRecovery 控件的视图呈现丰富的复合接口，其中包括标签、文本框、按钮和验证控件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-153">Like the Login and CreateUserWizard Web controls, the PasswordRecovery control's views render a rich composite interface that includes Labels, TextBoxes, Buttons, and validation controls.</span></span> <span data-ttu-id="5aa7c-154">您可以通过控件的样式属性或通过将视图转换为模板来自定义视图的外观。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-154">You can customize the appearance of the views through the control's style properties or by converting the views into templates.</span></span> <span data-ttu-id="5aa7c-155">对于感兴趣的读者来说，我将其作为练习。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-155">I leave this as an exercise for the interested reader.</span></span>

<span data-ttu-id="5aa7c-156">当用户访问此页面时，她将输入用户名并单击 "提交" 按钮。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-156">When a user visits this page she will enter her username and click the Submit button.</span></span> <span data-ttu-id="5aa7c-157">由于我们在成员身份配置设置中将 `RequiresQuestionAndAnswer` 属性设置为 True，因此 PasswordRecovery 控件将显示 "问题" 视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-157">Because we have set the `RequiresQuestionAndAnswer` property to True in our Membership configuration settings, the PasswordRecovery control will then display the Question view.</span></span> <span data-ttu-id="5aa7c-158">用户输入正确的安全答案并单击 "提交" 后，PasswordRecovery 控件会将用户的密码更新为随机生成的密码，并通过电子邮件将此密码发送到文件上的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-158">After the user enters her correct security answer and clicks Submit, the PasswordRecovery control will update the user's password to a randomly-generated one, and email this password to the email address on file.</span></span> <span data-ttu-id="5aa7c-159">所有这些都是可能的，但我们必须编写一行代码！</span><span class="sxs-lookup"><span data-stu-id="5aa7c-159">All of this was possible without us having to write a single line of code!</span></span>

<span data-ttu-id="5aa7c-160">在测试此页之前，有一个要配置的最后一段配置：需要在 `Web.config`中指定邮件传递设置。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-160">Before you test this page, there's one final piece of configuration to tend to: we need to specify the mail delivery settings in `Web.config`.</span></span> <span data-ttu-id="5aa7c-161">PasswordRecovery 控件依赖于这些设置来发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-161">The PasswordRecovery control relies on these settings for sending the email.</span></span>

<span data-ttu-id="5aa7c-162">邮件传递配置通过[`<system.net>` 元素](https://msdn.microsoft.com/library/6484zdc1.aspx)的[`<mailSettings>` 元素](https://msdn.microsoft.com/library/w355a94k.aspx)来指定。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-162">The mail delivery configuration is specified through the [`<system.net>` element](https://msdn.microsoft.com/library/6484zdc1.aspx)'s [`<mailSettings>` element](https://msdn.microsoft.com/library/w355a94k.aspx).</span></span> <span data-ttu-id="5aa7c-163">使用[`<smtp>` 元素](https://msdn.microsoft.com/library/ms164240.aspx)来指示传递方法和默认的 "发件人" 地址。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-163">Use the [`<smtp>` element](https://msdn.microsoft.com/library/ms164240.aspx) to indicate the delivery method and the default From address.</span></span> <span data-ttu-id="5aa7c-164">以下标记将邮件设置配置为在端口25上使用名为 `smtp.example.com` 的网络 SMTP 服务器，并使用用户名和密码的用户名/密码凭据。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-164">The following markup configures mail settings to use a network SMTP server named `smtp.example.com` on port 25 and with username/password credentials of username and password.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-165">`<system.net>` 是根 `<configuration>` 元素的子元素和 `<system.web>`的同级元素。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-165">`<system.net>` is a child element of the root `<configuration>` element and a sibling of `<system.web>`.</span></span> <span data-ttu-id="5aa7c-166">因此，请不要将 `<system.net>` 元素放在 `<system.web>` 元素内;而是将其置于同一级别。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-166">Therefore, do not put the `<system.net>` element within the `<system.web>` element; instead, put it at the same level.</span></span>

[!code-xml[Main](recovering-and-changing-passwords-vb/samples/sample1.xml)]

<span data-ttu-id="5aa7c-167">除了使用网络上的 SMTP 服务器以外，还可以指定要发送的电子邮件应存放到的拾取目录。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-167">In addition to using an SMTP server on the network, you can alternatively specify a pickup directory where email messages to be sent should be deposited.</span></span>

<span data-ttu-id="5aa7c-168">配置 SMTP 设置后，请通过浏览器访问 `RecoverPassword.aspx` 页面。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-168">Once you have configured the SMTP settings, visit the `RecoverPassword.aspx` page through a browser.</span></span> <span data-ttu-id="5aa7c-169">首先尝试输入用户存储中不存在的用户名。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-169">First try entering a username that doesn't exist in the user store.</span></span> <span data-ttu-id="5aa7c-170">如图2所示，PasswordRecovery 控件显示一条消息，指示无法访问用户信息。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-170">As Figure 2 shows, the PasswordRecovery control displays a message indicating that the user information could not be accessed.</span></span> <span data-ttu-id="5aa7c-171">消息的文本可通过控件的[`UserNameFailureText` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.usernamefailuretext.aspx)进行自定义。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-171">The text of the message can be customized through the control's [`UserNameFailureText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.usernamefailuretext.aspx).</span></span>

<span data-ttu-id="5aa7c-172">[![如果输入无效用户名，则显示一条错误消息](recovering-and-changing-passwords-vb/_static/image5.png)](recovering-and-changing-passwords-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-172">[![An Error Message is Displayed if an Invalid Username is Entered](recovering-and-changing-passwords-vb/_static/image5.png)](recovering-and-changing-passwords-vb/_static/image4.png)</span></span>

<span data-ttu-id="5aa7c-173">**图 2**：如果输入了无效用户名，将显示一条错误消息（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-173">**Figure 2**: An Error Message is Displayed if an Invalid Username is Entered  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image6.png))</span></span>

<span data-ttu-id="5aa7c-174">现在输入用户名。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-174">Now enter a username.</span></span> <span data-ttu-id="5aa7c-175">使用系统中帐户的用户名，其中包含可访问的电子邮件地址以及你知道的安全答案。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-175">Use the username of an account in the system with an email address that you can access and whose security answer you know.</span></span> <span data-ttu-id="5aa7c-176">输入用户名并单击 "提交" 后，PasswordRecovery 控件将显示其 "问题" 视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-176">After entering the username and clicking Submit, the PasswordRecovery control displays its Question view.</span></span> <span data-ttu-id="5aa7c-177">与 "用户名" 视图一样，如果输入错误答案，PasswordRecovery 控件会显示错误消息（请参阅图3）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-177">As with the UserName view, if you enter an incorrect answer the PasswordRecovery control displays an error message (see Figure 3).</span></span> <span data-ttu-id="5aa7c-178">使用[`QuestionFailureText` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.questionfailuretext.aspx)可自定义此错误消息。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-178">Use the [`QuestionFailureText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.questionfailuretext.aspx) to customize this error message.</span></span>

<span data-ttu-id="5aa7c-179">[如果用户输入的安全答案无效，则会显示 ![错误消息](recovering-and-changing-passwords-vb/_static/image8.png)](recovering-and-changing-passwords-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-179">[![An Error Message is Displayed if the User Enters an Invalid Security Answer](recovering-and-changing-passwords-vb/_static/image8.png)](recovering-and-changing-passwords-vb/_static/image7.png)</span></span>

<span data-ttu-id="5aa7c-180">**图 3**：如果用户输入无效的安全答案（[单击查看完全大小的映像](recovering-and-changing-passwords-vb/_static/image9.png)），则显示一条错误消息</span><span class="sxs-lookup"><span data-stu-id="5aa7c-180">**Figure 3**: An Error Message is Displayed if the User Enters an Invalid Security Answer  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image9.png))</span></span>

<span data-ttu-id="5aa7c-181">最后，输入正确的安全答案，然后单击 "提交"。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-181">Finally, enter the correct security answer and click Submit.</span></span> <span data-ttu-id="5aa7c-182">在后台，PasswordRecovery 控件生成随机密码，将其分配给用户帐户，发送一封电子邮件，告知用户其新密码（请参阅图4），然后显示 "成功" 视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-182">Behind the scenes, the PasswordRecovery control generates a random password, assigns it to the user account, sends an email informing the user of their new password (see Figure 4), and then displays the Success view.</span></span>

<span data-ttu-id="5aa7c-183">[![使用新密码向用户发送电子邮件](recovering-and-changing-passwords-vb/_static/image11.png)](recovering-and-changing-passwords-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-183">[![The User is Sent an Email with His New Password](recovering-and-changing-passwords-vb/_static/image11.png)](recovering-and-changing-passwords-vb/_static/image10.png)</span></span>

<span data-ttu-id="5aa7c-184">**图 4**：向用户发送一封电子邮件，其中包含新密码（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-184">**Figure 4**: The User is Sent an Email with His New Password  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image12.png))</span></span>

### <a name="customizing-the-email"></a><span data-ttu-id="5aa7c-185">自定义电子邮件</span><span class="sxs-lookup"><span data-stu-id="5aa7c-185">Customizing the Email</span></span>

<span data-ttu-id="5aa7c-186">PasswordRecovery 控件发送的默认电子邮件相当暗（参见图4）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-186">The default email sent by the PasswordRecovery control is rather dull (see Figure 4).</span></span> <span data-ttu-id="5aa7c-187">将从 `<smtp>` 元素的 `from` 属性中指定的帐户发送消息，其中包含主题密码和纯文本正文：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-187">The message is sent from the account specified in the `<smtp>` element's `from` attribute with the subject Password and the plain-text body:</span></span>

<span data-ttu-id="5aa7c-188">请返回到站点并使用以下信息登录。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-188">Please return to the site and log in using the following information.</span></span>

<span data-ttu-id="5aa7c-189">用户名：*用户名*</span><span class="sxs-lookup"><span data-stu-id="5aa7c-189">User Name: *username*</span></span>

<span data-ttu-id="5aa7c-190">密码：*密码*</span><span class="sxs-lookup"><span data-stu-id="5aa7c-190">Password: *password*</span></span>

<span data-ttu-id="5aa7c-191">可以通过 PasswordRecovery 控件的[`SendingMail` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.sendingmail.aspx)的事件处理程序以编程方式自定义此消息，也可以通过[`MailDefinition` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.maildefinition.aspx)以声明方式自定义此消息。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-191">This message can be customized programmatically through an event handler for the PasswordRecovery control's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.sendingmail.aspx), or declaratively through the [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.maildefinition.aspx).</span></span> <span data-ttu-id="5aa7c-192">让我们浏览一下这两个选项。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-192">Let's explore both of these options.</span></span>

<span data-ttu-id="5aa7c-193">在发送电子邮件之前，将立即触发 `SendingMail` 事件，这是我们最后一次用来以编程方式调整电子邮件的机会。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-193">The `SendingMail` event is fired right before the email message is sent and is our last chance to programmatically adjust the email message.</span></span> <span data-ttu-id="5aa7c-194">引发此事件时，会向事件处理程序传递类型[`MailMessageEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.mailmessageeventargs.aspx)的对象，其 `Message` 属性包含对要发送的电子邮件的引用。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-194">When this event is raised, the event handler is passed an object of type [`MailMessageEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.mailmessageeventargs.aspx), whose `Message` property contains a reference to the email about to be sent.</span></span>

<span data-ttu-id="5aa7c-195">为 `SendingMail` 事件创建事件处理程序并添加以下代码，以编程方式将 `webmaster@example.com` 添加到 CC 列表。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-195">Create an event handler for the `SendingMail` event and add the following code, which programmatically adds `webmaster@example.com` to the CC list.</span></span>

[!code-vb[Main](recovering-and-changing-passwords-vb/samples/sample2.vb)]

<span data-ttu-id="5aa7c-196">还可以通过声明性方式配置电子邮件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-196">The email message can also be configured through declarative means.</span></span> <span data-ttu-id="5aa7c-197">PasswordRecovery 的 `MailDefinition` 属性是[`MailDefinition`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.aspx)类型的对象。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-197">The PasswordRecovery's `MailDefinition` property is an object of type [`MailDefinition`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.aspx).</span></span> <span data-ttu-id="5aa7c-198">`MailDefinition` 类提供与电子邮件相关的属性的宿主，其中包括 `From`、`CC`、`Priority`、`Subject`、`IsBodyHtml`、`BodyFileName`和其他属性。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-198">The `MailDefinition` class offers a host of email-related properties, including `From`, `CC`, `Priority`, `Subject`, `IsBodyHtml`, `BodyFileName`, and others.</span></span> <span data-ttu-id="5aa7c-199">对于初学者，请将[`Subject` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.subject.aspx)设置为比默认使用的（密码）更具描述性的内容，如你的密码已重置 。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-199">For starters, set the [`Subject` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.subject.aspx) to something more descriptive than the one used by default ( Password ), such as Your password has been reset...</span></span>

<span data-ttu-id="5aa7c-200">若要自定义电子邮件的正文，我们需要创建一个包含正文内容的单独电子邮件模板文件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-200">To customize the body of the email message we need to create a separate email template file that contains the body's contents.</span></span> <span data-ttu-id="5aa7c-201">首先在名为 `EmailTemplates`的网站中创建一个新文件夹。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-201">Start by creating a new folder in the website named `EmailTemplates`.</span></span> <span data-ttu-id="5aa7c-202">接下来，向此文件夹中添加名为 "`PasswordRecovery.txt`" 的新文本文件，并添加以下内容：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-202">Next, add a new text file to this folder named `PasswordRecovery.txt` and add the following content:</span></span>

[!code-aspx[Main](recovering-and-changing-passwords-vb/samples/sample3.aspx)]

<span data-ttu-id="5aa7c-203">请注意 `<%UserName%>` 和 `<%Password%>`使用占位符。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-203">Note the use of the placeholders `<%UserName%>` and `<%Password%>`.</span></span> <span data-ttu-id="5aa7c-204">在发送电子邮件之前，PasswordRecovery 控件会自动将这两个占位符替换为用户的用户名和已恢复密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-204">The PasswordRecovery control automatically replaces these two placeholders with the user's username and recovered password prior to sending the email.</span></span>

<span data-ttu-id="5aa7c-205">最后，将 `MailDefinition`的[`BodyFileName` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.bodyfilename.aspx)指向刚刚创建的电子邮件模板（`~/EmailTemplates/PasswordRecovery.txt`）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-205">Lastly, point the `MailDefinition`'s [`BodyFileName` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.bodyfilename.aspx) to the email template we just created (`~/EmailTemplates/PasswordRecovery.txt`).</span></span>

<span data-ttu-id="5aa7c-206">进行这些更改后，请重新访问 `RecoverPassword.aspx` 页面，并输入你的用户名和安全答案。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-206">After making these changes revisit the `RecoverPassword.aspx` page and enter your username and security answer.</span></span> <span data-ttu-id="5aa7c-207">您收到的电子邮件应类似于图5所示。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-207">You receive should an email that looks like the one in Figure 5.</span></span> <span data-ttu-id="5aa7c-208">请注意，`webmaster@example.com` 已是抄送，并已更新主题和正文。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-208">Note that `webmaster@example.com` has been CC'd and that the subject and body have been updated.</span></span>

<span data-ttu-id="5aa7c-209">[已更新 "主题"、"正文" 和 "抄送" 列表 ![](recovering-and-changing-passwords-vb/_static/image14.png)](recovering-and-changing-passwords-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-209">[![The Subject, Body, and CC List Have Been Updated](recovering-and-changing-passwords-vb/_static/image14.png)](recovering-and-changing-passwords-vb/_static/image13.png)</span></span>

<span data-ttu-id="5aa7c-210">**图 5**： "主题"、"正文" 和 "抄送" 列表已更新（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-210">**Figure 5**: The Subject, Body, and CC List Have Been Updated  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image15.png))</span></span>

<span data-ttu-id="5aa7c-211">若要将 HTML 格式的电子邮件集[`IsBodyHtml`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.isbodyhtml.aspx)设置为 True （默认值为 False），并更新电子邮件模板以包含 HTML。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-211">To send an HTML-formatted email set [`IsBodyHtml`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.isbodyhtml.aspx) to True (the default is False) and update the email template to include HTML.</span></span>

<span data-ttu-id="5aa7c-212">`MailDefinition` 属性对 PasswordRecovery 类不是唯一的。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-212">The `MailDefinition` property is not unique to the PasswordRecovery class.</span></span> <span data-ttu-id="5aa7c-213">如我们将在步骤2中看到的那样，ChangePassword 控件还提供 `MailDefinition` 属性。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-213">As we will see in Step 2, the ChangePassword control also offers a `MailDefinition` property.</span></span> <span data-ttu-id="5aa7c-214">而且，CreateUserWizard 控件包含这样一个属性，你可以将其配置为自动向新用户发送欢迎电子邮件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-214">Moreover, the CreateUserWizard control includes such a property that you can configure to automatically send a welcome email message to new users.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-215">当前左侧导航栏中没有用于到达 `RecoverPassword.aspx` 页面的链接。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-215">Currently there are no links in the left-hand navigation for reaching the `RecoverPassword.aspx` page.</span></span> <span data-ttu-id="5aa7c-216">如果用户无法成功登录到站点，则该用户只会对访问此页感兴趣。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-216">A user would only be interested in visiting this page if she was unable to successfully log on to the site.</span></span> <span data-ttu-id="5aa7c-217">因此，请更新 `Login.aspx` 页面以包括指向 `RecoverPassword.aspx` 页面的链接。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-217">Therefore, update the `Login.aspx` page to include a link to the `RecoverPassword.aspx` page.</span></span>

### <a name="programmatically-resetting-a-users-password"></a><span data-ttu-id="5aa7c-218">以编程方式重置用户的密码</span><span class="sxs-lookup"><span data-stu-id="5aa7c-218">Programmatically Resetting a User's Password</span></span>

<span data-ttu-id="5aa7c-219">重置用户密码时，PasswordRecovery 控件将调用 `MembershipUser` 对象的[`ResetPassword` 方法](https://msdn.microsoft.com/library/system.web.security.membershipuser.resetpassword.aspx)。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-219">When resetting a user's password the PasswordRecovery control calls the `MembershipUser` object's [`ResetPassword` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.resetpassword.aspx).</span></span> <span data-ttu-id="5aa7c-220">此方法有两个重载：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-220">This method has two overloads:</span></span>

- <span data-ttu-id="5aa7c-221">**[`ResetPassword`](https://msdn.microsoft.com/library/d94bdzz2.aspx)** -重置用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-221">**[`ResetPassword`](https://msdn.microsoft.com/library/d94bdzz2.aspx)** - resets a user's password.</span></span> <span data-ttu-id="5aa7c-222">如果 `RequiresQuestionAndAnswer` 为 False，则使用此重载。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-222">Use this overload if `RequiresQuestionAndAnswer` is False.</span></span>
- <span data-ttu-id="5aa7c-223">**[`ResetPassword(securityAnswer)`](https://msdn.microsoft.com/library/d90zte4w.aspx)** -仅当提供的*securityAnswer*正确时重置用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-223">**[`ResetPassword(securityAnswer)`](https://msdn.microsoft.com/library/d90zte4w.aspx)** - resets a user's password only if the supplied *securityAnswer* is correct.</span></span> <span data-ttu-id="5aa7c-224">如果 `RequiresQuestionAndAnswer` 为 True，则使用此重载。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-224">Use this overload if `RequiresQuestionAndAnswer` is True.</span></span>

<span data-ttu-id="5aa7c-225">两个重载都返回新的、随机生成的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-225">Both overloads return the new, randomly-generated password.</span></span>

<span data-ttu-id="5aa7c-226">与成员身份框架中的其他方法一样，`ResetPassword` 方法委托给已配置的提供程序。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-226">Like with the other methods in the Membership framework, the `ResetPassword` method delegates to the configured provider.</span></span> <span data-ttu-id="5aa7c-227">`SqlMembershipProvider` 调用 `aspnet_Membership_ResetPassword` 存储过程，并传入用户的用户名、新密码以及提供的密码答案，包括其他字段。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-227">The `SqlMembershipProvider` invokes the `aspnet_Membership_ResetPassword` stored procedure, passing in the user's username, the new password, and the supplied password answer, among other fields.</span></span> <span data-ttu-id="5aa7c-228">该存储过程可确保密码答案匹配，然后更新用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-228">The stored procedure ensures that the password answer matches and then updates the user's password.</span></span>

<span data-ttu-id="5aa7c-229">几个低级别的实现说明：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-229">A couple of low-level implementation notes:</span></span>

- <span data-ttu-id="5aa7c-230">锁定的用户无法重置其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-230">A locked out user cannot reset her password.</span></span> <span data-ttu-id="5aa7c-231">但未经批准的用户可能会。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-231">However, an unapproved user may.</span></span> <span data-ttu-id="5aa7c-232">在<a id="_msoanchor_3"> </a>[*解锁和批准用户*](unlocking-and-approving-user-accounts-vb.md)帐户教程中，我们将更详细地讨论锁定和批准的状态。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-232">We will discuss the locked out and approved states in more detail in the <a id="_msoanchor_3"></a>[*Unlocking and Approving User*](unlocking-and-approving-user-accounts-vb.md) Accounts tutorial.</span></span>
- <span data-ttu-id="5aa7c-233">如果密码答案不正确，则会增加用户的密码答案尝试计数。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-233">If the password answer is incorrect, the user's failed password answer attempt count is incremented.</span></span> <span data-ttu-id="5aa7c-234">如果在指定的时间范围内发生指定数量的无效安全答案尝试，则用户将被锁定。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-234">If a specified number of invalid security answer attempts occur within a specified time window, the user is locked out.</span></span>

### <a name="a-word-on-how-the-random-passwords-are-generated"></a><span data-ttu-id="5aa7c-235">有关如何生成随机密码的单词</span><span class="sxs-lookup"><span data-stu-id="5aa7c-235">A Word on How the Random Passwords are Generated</span></span>

<span data-ttu-id="5aa7c-236">图4和5中的电子邮件中显示的随机生成的密码由成员身份类的[`GeneratePassword` 方法](https://msdn.microsoft.com/library/system.web.security.membership.generatepassword.aspx)创建。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-236">The randomly-generated passwords shown in the email messages in Figures 4 and 5 are created by the Membership class's [`GeneratePassword` method](https://msdn.microsoft.com/library/system.web.security.membership.generatepassword.aspx).</span></span> <span data-ttu-id="5aa7c-237">此方法接受两个整数输入参数-*长度*和*numberOfNonAlphanumericCharacters* ，并返回至少*长度*字符至少为*numberOfNonAlphanumericCharacters*的非字母数字字符的字符串。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-237">This method accepts two integer input paramters - *length* and *numberOfNonAlphanumericCharacters* - and returns a string at least *length* characters long with at least *numberOfNonAlphanumericCharacters* number of non-alphanumeric characters.</span></span> <span data-ttu-id="5aa7c-238">如果从成员身份类或与登录相关的 Web 控件中调用此方法，则这两个参数的值由成员身份配置的 `MinRequiredPasswordLength` 和 `MinRequiredNonalphanumericCharacters` 属性确定，该属性分别设置为7和1。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-238">When this method is called from within the Membership classes or Login-related Web controls, the values for these two parameters are determined by the Membership configuration's `MinRequiredPasswordLength` and `MinRequiredNonalphanumericCharacters` properties, which we set to 7 and 1, respectively.</span></span>

<span data-ttu-id="5aa7c-239">`GeneratePassword` 方法使用加密型强随机数生成器，以确保选择了多少个随机字符。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-239">The `GeneratePassword` method uses a cryptographically strong random number generator to ensure that there is no bias in what random characters are selected.</span></span> <span data-ttu-id="5aa7c-240">此外，`GeneratePassword` `Public`，这意味着，如果需要生成随机字符串或密码，则可以直接从 ASP.NET 应用程序使用它。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-240">Furthermore, `GeneratePassword` is `Public`, meaning that you can use it directly from your ASP.NET application if you need to generate random strings or passwords.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-241">`SqlMembershipProvider` 类始终生成长度至少为14个字符的随机密码，因此如果 `MinRequiredPasswordLength` 小于14，则将忽略其值。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-241">The `SqlMembershipProvider` class always generates a random password at least 14 characters long, so if `MinRequiredPasswordLength` is less than 14 then its value is ignored.</span></span>

## <a name="step-2-changing-passwords"></a><span data-ttu-id="5aa7c-242">步骤2：更改密码</span><span class="sxs-lookup"><span data-stu-id="5aa7c-242">Step 2: Changing Passwords</span></span>

<span data-ttu-id="5aa7c-243">随机生成的密码很难记住。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-243">The randomly-generated passwords are difficult to remember.</span></span> <span data-ttu-id="5aa7c-244">请考虑图4： `WWGUZv(f2yM:Bd`中所示的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-244">Consider the password shown in Figure 4: `WWGUZv(f2yM:Bd`.</span></span> <span data-ttu-id="5aa7c-245">尝试将其提交到内存！</span><span class="sxs-lookup"><span data-stu-id="5aa7c-245">Try committing that to memory!</span></span> <span data-ttu-id="5aa7c-246">不用说，在向用户发送此类随机生成的密码后，她需要将密码更改为更容易记住的内容。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-246">Needless to say, after a user is sent a randomly-generated password of this sort, she'll want to change the password to something more memorable.</span></span>

<span data-ttu-id="5aa7c-247">使用 "ChangePassword" 控件创建一个界面，以便用户可以更改其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-247">Use the ChangePassword control to create an interface for a user to change her password.</span></span> <span data-ttu-id="5aa7c-248">与 PasswordRecovery 控件非常类似，ChangePassword 控件包含两个视图：更改密码和成功。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-248">Much like the PasswordRecovery control, the ChangePassword control consists of two views: Change Password and Success.</span></span> <span data-ttu-id="5aa7c-249">"更改密码" 视图会提示用户输入其旧密码和新密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-249">The Change Password view prompts the user for their old and new passwords.</span></span> <span data-ttu-id="5aa7c-250">提供正确的旧密码和满足最小长度和非字母数字字符要求的新密码后，ChangePassword 控件会更新用户的密码并显示 "成功" 视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-250">Upon supplying the correct old password and a new password that meets the minimum length and non-alphanumeric character requirements, the ChangePassword control updates the user's password and displays the Success view.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-251">ChangePassword 控件通过调用 `MembershipUser` 对象的[`ChangePassword` 方法](https://msdn.microsoft.com/library/system.web.security.membershipuser.changepassword.aspx)来修改用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-251">The ChangePassword control modifies the user's password by invoking the `MembershipUser` object's [`ChangePassword` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.changepassword.aspx).</span></span> <span data-ttu-id="5aa7c-252">ChangePassword 方法接受两个 `String` 输入参数- *oldPassword*和*newPassword*，并更新用户与*newPassword*的帐户，假设提供的*oldPassword*是正确的。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-252">The ChangePassword method accepts two `String` input parameters - *oldPassword* and *newPassword*- and updates the user's account with the *newPassword*, assuming the supplied *oldPassword* is correct.</span></span>

<span data-ttu-id="5aa7c-253">打开 `ChangePassword.aspx` 页面，向页面添加一个 ChangePassword 控件，并将其命名为 `ChangePwd`。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-253">Open the `ChangePassword.aspx` page and add a ChangePassword control to the page, naming it `ChangePwd`.</span></span> <span data-ttu-id="5aa7c-254">此时，设计视图应显示 "更改密码" 视图（见图6）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-254">At this point, the Design view should show the Change Password view (see Figure 6).</span></span> <span data-ttu-id="5aa7c-255">与 PasswordRecovery 控件一样，可以通过控件的智能标记在视图之间切换。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-255">Like with the PasswordRecovery control, you can toggle between the views via the control's Smart Tag.</span></span> <span data-ttu-id="5aa7c-256">此外，这些视图的外观可以通过各种样式属性进行自定义，也可以通过将它们转换为模板进行自定义。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-256">Furthermore, these views' appearances are customizable through the assorted style properties or by converting them to a template.</span></span>

<span data-ttu-id="5aa7c-257">[![向页面添加 ChangePassword 控件](recovering-and-changing-passwords-vb/_static/image17.png)](recovering-and-changing-passwords-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-257">[![Add a ChangePassword Control to the Page](recovering-and-changing-passwords-vb/_static/image17.png)](recovering-and-changing-passwords-vb/_static/image16.png)</span></span>

<span data-ttu-id="5aa7c-258">**图 6**：将 ChangePassword 控件添加到页面（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-258">**Figure 6**: Add a ChangePassword Control to the Page  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image18.png))</span></span>

<span data-ttu-id="5aa7c-259">ChangePassword 控件可以更新当前已登录用户的密码*或*其他指定用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-259">The ChangePassword control can update the currently logged in user's password *or* the password of another, specified user.</span></span> <span data-ttu-id="5aa7c-260">如图6所示，默认的 "更改密码" 视图仅呈现三个 TextBox 控件：一个用于旧密码，两个用于新密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-260">As Figure 6 shows, the default Change Password view renders just three TextBox controls: one for the old password and two for the new password.</span></span> <span data-ttu-id="5aa7c-261">此默认接口用于更新当前已登录用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-261">This default interface is used to update the currently logged on user's password.</span></span>

<span data-ttu-id="5aa7c-262">若要使用 ChangePassword 控件更新其他用户的密码，请将控件的[`DisplayUserName` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.changepassword.displayusername.aspx)设置为 True。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-262">To use the ChangePassword control to update another user's password, set the control's [`DisplayUserName` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.changepassword.displayusername.aspx) to True.</span></span> <span data-ttu-id="5aa7c-263">这样做会向页面添加第四个文本框，并提示输入要更改密码的用户的用户名。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-263">Doing so adds a fourth TextBox to the page, prompting for the username of the user whose password to change.</span></span>

<span data-ttu-id="5aa7c-264">如果希望注销用户更改其密码，而无需登录，将 `DisplayUserName` 设置为 "True" 会很有用。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-264">Setting `DisplayUserName` to True is useful if you want to let a logged out user change her password without having to log in.</span></span> <span data-ttu-id="5aa7c-265">从个人角度来看，在要求用户更改其密码之前，不会有任何问题需要用户登录。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-265">Personally, I think there's nothing wrong with requiring a user to login before allowing her to change her password.</span></span> <span data-ttu-id="5aa7c-266">因此，将 `DisplayUserName` 设置为 False （默认值）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-266">Therefore, leave `DisplayUserName` set to False (its default).</span></span> <span data-ttu-id="5aa7c-267">然而，在做出此决定的过程中，我们实际上会阻止匿名用户访问此页。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-267">In making this decision, however, we essentially are barring anonymous users from reaching this page.</span></span> <span data-ttu-id="5aa7c-268">更新站点的 URL 授权规则，以便拒绝匿名用户访问 `ChangePassword.aspx`。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-268">Update the site's URL authorization rules so as to deny anonymous users from visiting `ChangePassword.aspx`.</span></span> <span data-ttu-id="5aa7c-269">如果需要刷新 URL 授权规则语法上的内存，请返回到<a id="_msoanchor_4"> </a>[*基于用户的授权*](../membership/user-based-authorization-vb.md)教程。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-269">If you need to refresh your memory on the URL authorization rule syntax, refer back to the <a id="_msoanchor_4"></a>[*User-Based Authorization*](../membership/user-based-authorization-vb.md) tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-270">可能看起来 `DisplayUserName` 属性对允许管理员更改其他用户的密码很有用。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-270">It may seem that the `DisplayUserName` property is useful for allowing administrators to change other users' passwords.</span></span> <span data-ttu-id="5aa7c-271">但是，即使将 `DisplayUserName` 设置为 True，也必须知道并输入正确的旧密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-271">However, even when `DisplayUserName` is set to True the correct old password must be known and entered.</span></span> <span data-ttu-id="5aa7c-272">我们将讨论允许管理员在步骤3中更改用户密码的方法。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-272">We will talk about techniques for allowing administrators to change users' passwords in Step 3.</span></span>

<span data-ttu-id="5aa7c-273">通过浏览器访问 `ChangePassword.aspx` 页面并更改密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-273">Visit the `ChangePassword.aspx` page through a browser and change your password.</span></span> <span data-ttu-id="5aa7c-274">请注意，如果输入的新密码无法满足成员身份配置中指定的密码长度和非字母数字字符要求，则会显示一条错误消息（请参阅图7）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-274">Note that an error message is displayed if you enter a new password that fails to meet the password length and non-alphanumeric character requirements specified in the Membership configuration (see Figure 7).</span></span>

<span data-ttu-id="5aa7c-275">[![向页面添加 ChangePassword 控件](recovering-and-changing-passwords-vb/_static/image20.png)](recovering-and-changing-passwords-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-275">[![Add a ChangePassword Control to the Page](recovering-and-changing-passwords-vb/_static/image20.png)](recovering-and-changing-passwords-vb/_static/image19.png)</span></span>

<span data-ttu-id="5aa7c-276">**图 7**：将 ChangePassword 控件添加到页面（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-276">**Figure 7**: Add a ChangePassword Control to the Page  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image21.png))</span></span>

<span data-ttu-id="5aa7c-277">输入正确的旧密码和有效的新密码后，已登录用户的密码已更改，并显示 "成功" 视图。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-277">Upon entering the correct old password and a valid new password, the logged on user's password is changed and the Success view displayed.</span></span>

### <a name="sending-a-confirmation-email"></a><span data-ttu-id="5aa7c-278">发送确认电子邮件</span><span class="sxs-lookup"><span data-stu-id="5aa7c-278">Sending a Confirmation Email</span></span>

<span data-ttu-id="5aa7c-279">默认情况下，ChangePassword 控件不会将电子邮件发送到刚更新了其密码的用户。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-279">By default, the ChangePassword control does not send an email message to the user whose password was just updated.</span></span> <span data-ttu-id="5aa7c-280">如果要发送电子邮件，只需配置该控件的 `MailDefinition` 属性。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-280">If you'd like to send an email, simply configure the control's `MailDefinition` property.</span></span> <span data-ttu-id="5aa7c-281">让我们配置 ChangePassword 控件，以便向用户发送包含其新密码的 HTML 格式电子邮件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-281">Let's configure the ChangePassword control so that the user is sent an HTML-formatted email that contains their new password.</span></span>

<span data-ttu-id="5aa7c-282">首先在名为 `ChangePassword.htm``EmailTemplates` 文件夹中创建一个新文件。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-282">Start by creating a new file in the `EmailTemplates` folder named `ChangePassword.htm`.</span></span> <span data-ttu-id="5aa7c-283">添加以下标记：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-283">Add the following markup:</span></span>

[!code-html[Main](recovering-and-changing-passwords-vb/samples/sample4.html)]

<span data-ttu-id="5aa7c-284">接下来，将 ChangePassword 控件的 `MailDefinition` 属性的 `BodyFileName`、`IsBodyHtml`和 `Subject` 属性分别设置为 ~/EmailTemplates/ChangePassword.htm、True，并且密码已更改！。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-284">Next, set the ChangePassword control's `MailDefinition` property's `BodyFileName`, `IsBodyHtml`, and `Subject` properties to ~/EmailTemplates/ChangePassword.htm, True, and Your password has changed!, respectively.</span></span>

<span data-ttu-id="5aa7c-285">进行这些更改后，重新访问页面并再次更改密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-285">After making these changes, revisit the page and change your password again.</span></span> <span data-ttu-id="5aa7c-286">此时，ChangePassword 控件会向用户的电子邮件地址发送一封自定义的 HTML 格式的电子邮件，如图8所示。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-286">This time, the ChangePassword control sends a customized, HTML-formatted email to the user's email address on file (see Figure 8).</span></span>

<span data-ttu-id="5aa7c-287">[![电子邮件通知用户其密码已更改](recovering-and-changing-passwords-vb/_static/image23.png)](recovering-and-changing-passwords-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-287">[![An Email Message Informs the User That Their Password has Changed](recovering-and-changing-passwords-vb/_static/image23.png)](recovering-and-changing-passwords-vb/_static/image22.png)</span></span>

<span data-ttu-id="5aa7c-288">**图 8**：电子邮件通知用户其密码已更改（[单击查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-288">**Figure 8**: An Email Message Informs the User That Their Password has Changed  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image24.png))</span></span>

## <a name="step-3-allowing-administrators-to-change-users-passwords"></a><span data-ttu-id="5aa7c-289">步骤3：允许管理员更改用户密码</span><span class="sxs-lookup"><span data-stu-id="5aa7c-289">Step 3: Allowing Administrators to Change Users' Passwords</span></span>

<span data-ttu-id="5aa7c-290">支持用户帐户的应用程序中的一项常见功能是使管理用户能够更改其他用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-290">A common feature in applications that support user accounts is the ability for an administrative user to change other users' passwords.</span></span> <span data-ttu-id="5aa7c-291">有时，此功能是必需的，因为系统不能让用户更改自己的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-291">Sometimes this functionality is required because the system lacks the ability for users to change their own passwords.</span></span> <span data-ttu-id="5aa7c-292">在这种情况下，使用户恢复忘记的密码的唯一方法是让管理员为其分配新密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-292">In such a case, the only way for a user to recover their forgotten password would be for the administrator to assign them a new password.</span></span> <span data-ttu-id="5aa7c-293">然而，对于 PasswordRecovery 和 ChangePassword 控件，管理用户无需忙于更改用户密码，因为用户能够自行完成此操作。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-293">With the PasswordRecovery and ChangePassword controls, however, administrative users need not busy themselves with changing users' passwords, as users are capable of doing this themselves.</span></span>

<span data-ttu-id="5aa7c-294">但是，如果您的客户端一定管理用户应能够更改其他用户的密码，该怎么办？</span><span class="sxs-lookup"><span data-stu-id="5aa7c-294">But what if your client insists that administrative users should be able to change other users' passwords?</span></span> <span data-ttu-id="5aa7c-295">遗憾的是，添加此功能可能是一种工作。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-295">Unfortunately, adding this functionality can be a bit of work.</span></span> <span data-ttu-id="5aa7c-296">若要更改用户的密码，必须向 `MembershipUser` 对象的 `ChangePassword` 方法提供旧密码和新密码，但管理员无需知道用户密码即可修改该用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-296">To change a user's password, both the old and new password must be supplied to the `MembershipUser` object's `ChangePassword` method, but an administrator shouldn't have to know a user's password in order to modify it.</span></span>

<span data-ttu-id="5aa7c-297">一种解决方法是先重置用户的密码，然后使用如下代码将其更改为新密码：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-297">One workaround is to first reset the user's password and then change it to the new password using code like the following:</span></span>

[!code-vb[Main](recovering-and-changing-passwords-vb/samples/sample5.vb)]

<span data-ttu-id="5aa7c-298">此代码首先检索有关*用户名*的信息，这是管理员希望更改其密码的用户。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-298">This code starts by retrieving information about *username*, which is the user whose password the administrator wishes to change.</span></span> <span data-ttu-id="5aa7c-299">接下来，调用 `ResetPassword` 方法，该方法为用户分配新的随机密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-299">Next, the `ResetPassword` method is invoked, which assigns and the user a new, random password.</span></span> <span data-ttu-id="5aa7c-300">此随机生成的密码由方法返回，并存储在变量 `resetPwd`中。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-300">This randomly-generated password is returned by the method and stored in the variable `resetPwd`.</span></span> <span data-ttu-id="5aa7c-301">现在我们知道了用户的密码，可以通过调用 `ChangePassword`对其进行更改。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-301">Now that we know the user's password, we can change it via a call to `ChangePassword`.</span></span>

<span data-ttu-id="5aa7c-302">问题在于，此代码仅在设置了成员身份系统配置时才适用，因此 `RequiresQuestionAndAnswer` 为 False。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-302">The problem is that this code only works if the Membership system configuration is set such that `RequiresQuestionAndAnswer` is False.</span></span> <span data-ttu-id="5aa7c-303">如果 `RequiresQuestionAndAnswer` 为 True，与我们的应用程序一样，则需要将 `ResetPassword` 方法传递到安全答案，否则将引发异常。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-303">If `RequiresQuestionAndAnswer` is True, as it is with our application, then the `ResetPassword` method needs to be passed the security answer, otherwise it will throw an exception.</span></span>

<span data-ttu-id="5aa7c-304">如果成员身份框架配置为需要安全问题和答案，但你的客户端一定管理员能够更改用户的密码，则有三个选项：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-304">If the Membership framework is configured to require a security question and answer, and yet your client insists that administrators be able to change users' passwords, you have three options:</span></span>

- <span data-ttu-id="5aa7c-305">将你的双手掷到你的空气中，并告诉客户端这只是一个无法完成的事情。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-305">Throw your hands in the air and tell your client that this is just one thing that cannot be done.</span></span>
- <span data-ttu-id="5aa7c-306">将 `RequiresQuestionAndAnswer` 设置为 False。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-306">Set `RequiresQuestionAndAnswer` to False.</span></span> <span data-ttu-id="5aa7c-307">这会导致应用程序不太安全。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-307">This results in a less secure application.</span></span> <span data-ttu-id="5aa7c-308">假设恶意用户已获得对另一个用户的电子邮件收件箱的访问权限。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-308">Imagine that a nefarious user has gained access to another user's email inbox.</span></span> <span data-ttu-id="5aa7c-309">可能是被泄露的用户离开了其办公桌去吃午餐，或者他们的工作站没有锁定，或者他们的电子邮件来自公共终端并且未注销。在任一情况下，恶意用户都可以访问 `RecoverPassword.aspx` 页面，并输入用户的用户名。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-309">Perhaps the compromised user has left their desk to go to lunch and didn't lock their workstation, or maybe they accessed their email from a public terminal and didn't sign out. In either case, the nefarious user can visit the `RecoverPassword.aspx` page and enter the user's username.</span></span> <span data-ttu-id="5aa7c-310">然后，系统会通过电子邮件发送恢复的密码，而不提示您提供安全答案。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-310">The system will then email the recovered password without prompting for the security answer.</span></span>
- <span data-ttu-id="5aa7c-311">绕过成员身份框架创建的抽象层，并直接使用 SQL Server 数据库。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-311">Bypass the abstraction layer created by the Membership framework and work directly with the SQL Server database.</span></span> <span data-ttu-id="5aa7c-312">成员身份架构包含一个名为 `aspnet_Membership_SetPassword` 的存储过程，该过程设置用户的密码，不需要安全答案或旧密码即可完成其任务。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-312">The Membership schema includes a stored procedure named `aspnet_Membership_SetPassword` that sets a user's password and does not require the security answer or old password in order to accomplish its task.</span></span>

<span data-ttu-id="5aa7c-313">这些选项中的任何一个都不是很有吸引力，但这也是开发人员的生命周期。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-313">None of these options are particularly appealing, but that's how the life of a developer goes sometimes.</span></span>

<span data-ttu-id="5aa7c-314">接下来，我实现了第三种方法，即编写绕过 `Membership` 和 `MembershipUser` 类的代码，并直接对 `SecurityTutorials` 数据库进行操作。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-314">I went ahead and implemented the third approach, writing code that bypasses the `Membership` and `MembershipUser` classes and operates directly against the `SecurityTutorials` database.</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-315">通过直接处理数据库，成员身份框架提供的封装会被损坏。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-315">By working directly with the database, the encapsulation provided by the Membership framework is shattered.</span></span> <span data-ttu-id="5aa7c-316">此决策将我们与 `SqlMembershipProvider`联系起来，使代码变得更小。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-316">This decision ties us to the `SqlMembershipProvider`, making our code less portable.</span></span> <span data-ttu-id="5aa7c-317">此外，如果成员身份架构发生更改，则在未来版本的 ASP.NET 中，此代码可能无法按预期工作。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-317">Furthermore, this code may not work as expected in future versions of ASP.NET if the Membership schema changes.</span></span> <span data-ttu-id="5aa7c-318">此方法是一种解决方法，如大多数解决方法，并不是最佳做法的示例。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-318">This approach is a workaround and, like most workarounds, is not an example of best practices.</span></span>

<span data-ttu-id="5aa7c-319">此代码有一些不严重位，并且非常长。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-319">The code has some unattractive bits and is quite lengthy.</span></span> <span data-ttu-id="5aa7c-320">因此，在本教程中，我不想对其进行深入研究。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-320">Therefore, I don't want to clutter this tutorial with an in-depth examination of it.</span></span> <span data-ttu-id="5aa7c-321">如果对了解详细信息感兴趣，请下载本教程的代码，并访问 `~/Administration/ManageUsers.aspx` 页面。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-321">If you are interested in learning more, download the code for this tutorial and visit the `~/Administration/ManageUsers.aspx` page.</span></span> <span data-ttu-id="5aa7c-322">在<a id="_msoanchor_5"> </a>[前面的教程](building-an-interface-to-select-one-user-account-from-many-vb.md)中创建的此页列出了每个用户。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-322">This page, which we created in the <a id="_msoanchor_5"></a>[preceding tutorial](building-an-interface-to-select-one-user-account-from-many-vb.md), lists each user.</span></span> <span data-ttu-id="5aa7c-323">我已经更新了 GridView，使其包含指向 `UserInformation.aspx` 页面的链接，并通过查询字符串传递选定用户的用户名。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-323">I've updated the GridView to include a link to the `UserInformation.aspx` page, passing the selected user's username through the querystring.</span></span> <span data-ttu-id="5aa7c-324">"`UserInformation.aspx`" 页将显示有关所选用户和用于更改其密码的文本框的信息（请参阅图9）。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-324">The `UserInformation.aspx` page displays information about the selected user and TextBoxes for changing their password (see Figure 9).</span></span>

<span data-ttu-id="5aa7c-325">输入新密码后，在第二个文本框中确认该密码，然后单击 "更新用户" 按钮，将调用回发可以和 `aspnet_Membership_SetPassword` 存储过程，从而更新用户的密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-325">After entering the new password, confirming it in the second TextBox, and clicking the Update User Button, a postback ensues and the `aspnet_Membership_SetPassword` stored procedure is invoked, updating the user's password.</span></span> <span data-ttu-id="5aa7c-326">我鼓励这些读者对此功能感兴趣，以更熟悉代码，并尝试扩展功能，将电子邮件发送到用户的密码已更改。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-326">I encourage those readers interested in this functionality to become more familiar with the code and try extending the functionality to include sending an email to the user whose password was changed.</span></span>

<span data-ttu-id="5aa7c-327">[![管理员可以更改用户的密码](recovering-and-changing-passwords-vb/_static/image26.png)](recovering-and-changing-passwords-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-327">[![An Administrator May Change a User's Password](recovering-and-changing-passwords-vb/_static/image26.png)](recovering-and-changing-passwords-vb/_static/image25.png)</span></span>

<span data-ttu-id="5aa7c-328">**图 9**：管理员可以更改用户的密码（[单击以查看完全大小的图像](recovering-and-changing-passwords-vb/_static/image27.png)）</span><span class="sxs-lookup"><span data-stu-id="5aa7c-328">**Figure 9**: An Administrator May Change a User's Password  ([Click to view full-size image](recovering-and-changing-passwords-vb/_static/image27.png))</span></span>

> [!NOTE]
> <span data-ttu-id="5aa7c-329">如果成员身份框架配置为以明文或哈希格式存储密码，则当前仅适用于 `UserInformation.aspx` 页。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-329">The `UserInformation.aspx` page currently only works if the Membership framework is configured to store passwords in Clear or Hashed format.</span></span> <span data-ttu-id="5aa7c-330">尽管邀请你添加此功能，但它缺少加密新密码的代码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-330">It lacks the code to encrypt the new password, although you are invited to add this functionality.</span></span> <span data-ttu-id="5aa7c-331">我建议添加所需的代码的方法是使用反编译程序等[反射](http://www.aisto.com/roeder/dotnet/)器来检查 .NET Framework 中方法的源代码：首先检查 `SqlMembershipProvider` 类的 `ChangePassword` 方法。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-331">The way I recommend adding the necessary code is to use a decompiler like [Reflector](http://www.aisto.com/roeder/dotnet/) to examine the source code for methods in the .NET Framework; start by examining the `SqlMembershipProvider` class's `ChangePassword` method.</span></span> <span data-ttu-id="5aa7c-332">这是我用来编写用于创建密码哈希的代码的方法。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-332">This is the technique I used to write the code for creating a hash of the password.</span></span>

## <a name="summary"></a><span data-ttu-id="5aa7c-333">摘要</span><span class="sxs-lookup"><span data-stu-id="5aa7c-333">Summary</span></span>

<span data-ttu-id="5aa7c-334">ASP.NET 提供了两个控件来帮助用户管理其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-334">ASP.NET offers two controls to help users manage their password.</span></span> <span data-ttu-id="5aa7c-335">PasswordRecovery 控件对于忘记了密码的用户非常有用。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-335">The PasswordRecovery control is useful for those who have forgotten their passwords.</span></span> <span data-ttu-id="5aa7c-336">根据成员身份框架的配置，用户可以通过电子邮件发送其现有密码或随机生成的新密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-336">Depending on the Membership framework's configuration, the user is either emailed their existing password or a new, randomly-generated password.</span></span> <span data-ttu-id="5aa7c-337">通过 ChangePassword 控件，用户可以更新其密码。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-337">The ChangePassword control enables a user to update their password.</span></span>

<span data-ttu-id="5aa7c-338">与登录名和 CreateUserWizard 控件一样，PasswordRecovery 和 ChangePassword 控件呈现丰富的用户界面，而无需编写声明性标记或代码行的舔。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-338">Like the Login and CreateUserWizard controls, the PasswordRecovery and ChangePassword controls render a rich user interface without having to write a lick of declarative markup or line of code.</span></span> <span data-ttu-id="5aa7c-339">如果默认用户界面不能满足您的需要，则可以通过各种样式属性对其进行自定义。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-339">If the default user interface doesn't meet your needs, you can customize it through a variety of style properties.</span></span> <span data-ttu-id="5aa7c-340">或者，控件的接口可能会转换为模板，以获得更精细的控制。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-340">Alternatively, the controls' interfaces may be converted into templates, for an even finer degree of control.</span></span> <span data-ttu-id="5aa7c-341">在后台，这些控件使用成员资格 API，调用 `MembershipUser` 对象的 `ResetPassword` 和 `ChangePassword` 方法。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-341">Behind the scenes these controls use the Membership API, invoking the `MembershipUser` object's `ResetPassword` and `ChangePassword` methods.</span></span>

<span data-ttu-id="5aa7c-342">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="5aa7c-342">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="5aa7c-343">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="5aa7c-343">Further Reading</span></span>

<span data-ttu-id="5aa7c-344">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="5aa7c-344">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="5aa7c-345">ChangePassword 控件快速入门</span><span class="sxs-lookup"><span data-stu-id="5aa7c-345">ChangePassword Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/changepassword.aspx)
- [<span data-ttu-id="5aa7c-346">PasswordRecovery 控件快速入门</span><span class="sxs-lookup"><span data-stu-id="5aa7c-346">PasswordRecovery Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/passwordrecovery.aspx)
- [<span data-ttu-id="5aa7c-347">在 ASP.NET 中发送电子邮件</span><span class="sxs-lookup"><span data-stu-id="5aa7c-347">Sending Email in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)
- [<span data-ttu-id="5aa7c-348">`System.Net.Mail` 常见问题</span><span class="sxs-lookup"><span data-stu-id="5aa7c-348">`System.Net.Mail` FAQs</span></span>](http://www.systemnetmail.com/)

### <a name="about-the-author"></a><span data-ttu-id="5aa7c-349">关于作者</span><span class="sxs-lookup"><span data-stu-id="5aa7c-349">About the Author</span></span>

<span data-ttu-id="5aa7c-350">Scott Mitchell，创始人的多个 ASP/ASP 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-350">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="5aa7c-351">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-351">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="5aa7c-352">他的最新书籍是， *[在24小时内，sam ASP.NET 2.0](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* 。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-352">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="5aa7c-353">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-353">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="5aa7c-354">特别感谢</span><span class="sxs-lookup"><span data-stu-id="5aa7c-354">Special Thanks To</span></span>

<span data-ttu-id="5aa7c-355">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-355">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="5aa7c-356">本教程的主管评审者包括 Michael Emmings 和 Suchi Banerjee。</span><span class="sxs-lookup"><span data-stu-id="5aa7c-356">Lead reviewers for this tutorial include Michael Emmings and Suchi Banerjee.</span></span> <span data-ttu-id="5aa7c-357">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="5aa7c-357">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="5aa7c-358">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-358">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="5aa7c-359">[上一页](building-an-interface-to-select-one-user-account-from-many-vb.md)
> [下一页](unlocking-and-approving-user-accounts-vb.md)</span><span class="sxs-lookup"><span data-stu-id="5aa7c-359">[Previous](building-an-interface-to-select-one-user-account-from-many-vb.md)
[Next](unlocking-and-approving-user-accounts-vb.md)</span></span>
