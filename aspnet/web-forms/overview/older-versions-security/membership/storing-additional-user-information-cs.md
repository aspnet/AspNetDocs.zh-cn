---
uid: web-forms/overview/older-versions-security/membership/storing-additional-user-information-cs
title: 存储其他用户信息（C#） |Microsoft Docs
author: rick-anderson
description: 在本教程中，我们将通过构建一个非常基本的留言簿应用程序来回答这个问题。 在此过程中，我们将查看 modeli 的不同选项 。
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 1642132a-1ca5-4872-983f-ab59fc8865d3
msc.legacyurl: /web-forms/overview/older-versions-security/membership/storing-additional-user-information-cs
msc.type: authoredcontent
ms.openlocfilehash: 24b96e86bc93e03d2639b73e35ed1fd1271bac5a
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74641457"
---
# <a name="storing-additional-user-information-c"></a><span data-ttu-id="b7477-104">存储其他用户信息 (C#)</span><span class="sxs-lookup"><span data-stu-id="b7477-104">Storing Additional User Information (C#)</span></span>

<span data-ttu-id="b7477-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="b7477-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="b7477-106">[下载代码](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_08_CS.zip)或[下载 PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial08_ExtraUserInfo_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="b7477-106">[Download Code](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_08_CS.zip) or [Download PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial08_ExtraUserInfo_cs.pdf)</span></span>

> <span data-ttu-id="b7477-107">在本教程中，我们将通过构建一个非常基本的留言簿应用程序来回答这个问题。</span><span class="sxs-lookup"><span data-stu-id="b7477-107">In this tutorial we will answer this question by building a very rudimentary guestbook application.</span></span> <span data-ttu-id="b7477-108">在此过程中，我们将查看用于在数据库中对用户信息建模的不同选项，然后查看如何将此数据与成员资格框架创建的用户帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="b7477-108">In doing so, we will look at different options for modeling user information in a database, and then see how to associate this data with the user accounts created by the Membership framework.</span></span>

## <a name="introduction"></a><span data-ttu-id="b7477-109">简介</span><span class="sxs-lookup"><span data-stu-id="b7477-109">Introduction</span></span>

<span data-ttu-id="b7477-110">ASP.NET.NET 的成员身份框架为管理用户提供了一个灵活的界面。</span><span class="sxs-lookup"><span data-stu-id="b7477-110">ASP.NET's Membership framework offers a flexible interface for managing users.</span></span> <span data-ttu-id="b7477-111">成员资格 API 包括用于验证凭据、检索当前已登录用户的信息、创建新的用户帐户以及删除用户帐户的方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-111">The Membership API includes methods for validating credentials, retrieving information about the currently logged on user, creating a new user account, and deleting a user account, among others.</span></span> <span data-ttu-id="b7477-112">成员身份框架中的每个用户帐户只包含验证凭据和执行与用户帐户相关的重要任务所需的属性。</span><span class="sxs-lookup"><span data-stu-id="b7477-112">Each user account in the Membership framework contains only the properties needed for validating credentials and performing essential user account-related tasks.</span></span> <span data-ttu-id="b7477-113">这是由[`MembershipUser` 类](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)的方法和属性出现的，该类对成员身份框架中的用户帐户建模。</span><span class="sxs-lookup"><span data-stu-id="b7477-113">This is evidenced by the methods and properties of the [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), which models a user account in the Membership framework.</span></span> <span data-ttu-id="b7477-114">此类具有一些属性，如[`UserName`](https://msdn.microsoft.com/library/system.web.security.membershipuser.username.aspx)、 [`Email`](https://msdn.microsoft.com/library/system.web.security.membershipuser.email.aspx)和[`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx)，以及[`GetPassword`](https://msdn.microsoft.com/library/system.web.security.membershipuser.getpassword.aspx)和[`UnlockUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)等方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-114">This class has properties like [`UserName`](https://msdn.microsoft.com/library/system.web.security.membershipuser.username.aspx), [`Email`](https://msdn.microsoft.com/library/system.web.security.membershipuser.email.aspx), and [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx), and methods like [`GetPassword`](https://msdn.microsoft.com/library/system.web.security.membershipuser.getpassword.aspx) and [`UnlockUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span>

<span data-ttu-id="b7477-115">通常，应用程序需要存储成员身份框架中未包含的其他用户信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-115">Oftentimes, applications need to store additional user information not included in the Membership framework.</span></span> <span data-ttu-id="b7477-116">例如，在线零售商可能需要让每个用户存储其发货和帐单地址、支付信息、交货首选项和联系电话号码。</span><span class="sxs-lookup"><span data-stu-id="b7477-116">For example, an online retailer might need to let each user store her shipping and billing addresses, payment information, delivery preferences, and contact phone number.</span></span> <span data-ttu-id="b7477-117">而且，系统中的每个订单都与特定的用户帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="b7477-117">Furthermore, each order in the system is associated with a particular user account.</span></span>

<span data-ttu-id="b7477-118">`MembershipUser` 类不包括 `PhoneNumber` 或 `DeliveryPreferences` 或 `PastOrders`之类的属性。</span><span class="sxs-lookup"><span data-stu-id="b7477-118">The `MembershipUser` class does not include properties like `PhoneNumber` or `DeliveryPreferences` or `PastOrders`.</span></span> <span data-ttu-id="b7477-119">那么，我们如何跟踪应用程序所需的用户信息并将其与成员身份框架集成？</span><span class="sxs-lookup"><span data-stu-id="b7477-119">So how do we track the user information needed by the application and have it integrate with the Membership framework?</span></span> <span data-ttu-id="b7477-120">在本教程中，我们将通过构建一个非常基本的留言簿应用程序来回答这个问题。</span><span class="sxs-lookup"><span data-stu-id="b7477-120">In this tutorial we will answer this question by building a very rudimentary guestbook application.</span></span> <span data-ttu-id="b7477-121">在此过程中，我们将查看用于在数据库中对用户信息建模的不同选项，然后查看如何将此数据与成员资格框架创建的用户帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="b7477-121">In doing so, we will look at different options for modeling user information in a database, and then see how to associate this data with the user accounts created by the Membership framework.</span></span> <span data-ttu-id="b7477-122">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="b7477-122">Let's get started!</span></span>

## <a name="step-1-creating-the-guestbook-applications-data-model"></a><span data-ttu-id="b7477-123">步骤1：创建留言簿应用程序的数据模型</span><span class="sxs-lookup"><span data-stu-id="b7477-123">Step 1: Creating the Guestbook Application's Data Model</span></span>

<span data-ttu-id="b7477-124">有多种方法可用于在数据库中捕获用户信息，并将其与成员身份框架创建的用户帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="b7477-124">There are a variety of techniques that can be employed to capture user information in a database and associate it with the user accounts created by the Membership framework.</span></span> <span data-ttu-id="b7477-125">为了说明这些方法，我们需要增加教程 web 应用程序，使其能够捕获某些用户相关数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-125">In order to illustrate these techniques, we will need to augment the tutorial web application so that it captures some sort of user-related data.</span></span> <span data-ttu-id="b7477-126">（目前，应用程序的数据模型仅包含 `SqlMembershipProvider`所需的应用程序服务表。）</span><span class="sxs-lookup"><span data-stu-id="b7477-126">(Currently, the application's data model contains only the application services tables needed by the `SqlMembershipProvider`.)</span></span>

<span data-ttu-id="b7477-127">让我们创建一个非常简单的留言簿应用程序，在该应用程序中，经过身份验证的用户可以留下评论。</span><span class="sxs-lookup"><span data-stu-id="b7477-127">Let's create a very simple guestbook application where an authenticated user can leave a comment.</span></span> <span data-ttu-id="b7477-128">除了存储留言簿评论外，让每位用户都可以存储他的 "城市"、"主页" 和 "签名"。</span><span class="sxs-lookup"><span data-stu-id="b7477-128">In addition to storing guestbook comments, let's allow each user to store his home town, homepage, and signature.</span></span> <span data-ttu-id="b7477-129">如果提供了，则用户的 "住宅"、"主页" 和 "签名" 将显示在其在留言簿中留下的每个邮件上。</span><span class="sxs-lookup"><span data-stu-id="b7477-129">If provided, the user's home town, homepage, and signature will appear on each message he has left in the guestbook.</span></span>

### <a name="adding-theguestbookcommentstable"></a><span data-ttu-id="b7477-130">添加`GuestbookComments`表</span><span class="sxs-lookup"><span data-stu-id="b7477-130">Adding the`GuestbookComments`Table</span></span>

<span data-ttu-id="b7477-131">为了捕获留言簿评论，我们需要创建一个名为 `GuestbookComments` 的数据库表，该表中的列如 `CommentId`、`Subject`、`Body`和 `CommentDate`。</span><span class="sxs-lookup"><span data-stu-id="b7477-131">In order to capture the guestbook comments, we need to create a database table named `GuestbookComments` that has columns like `CommentId`, `Subject`, `Body`, and `CommentDate`.</span></span> <span data-ttu-id="b7477-132">还需要让 `GuestbookComments` 表中的每条记录都引用留下注释的用户。</span><span class="sxs-lookup"><span data-stu-id="b7477-132">We also need to have each record in the `GuestbookComments` table reference the user who left the comment.</span></span>

<span data-ttu-id="b7477-133">若要将此表添加到数据库，请在 Visual Studio 中转到数据库资源管理器，并向下钻取到 `SecurityTutorials` 数据库。</span><span class="sxs-lookup"><span data-stu-id="b7477-133">To add this table to our database, go to the Database Explorer in Visual Studio and drill down into the `SecurityTutorials` database.</span></span> <span data-ttu-id="b7477-134">右键单击 "表" 文件夹，然后选择 "添加新表"。</span><span class="sxs-lookup"><span data-stu-id="b7477-134">Right-click on the Tables folder and choose Add New Table.</span></span> <span data-ttu-id="b7477-135">这将打开一个接口，该接口允许我们定义新表的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-135">This brings up an interface that allows us to define the columns for the new table.</span></span>

<span data-ttu-id="b7477-136">[![向 SecurityTutorials 数据库添加新表](storing-additional-user-information-cs/_static/image2.png)](storing-additional-user-information-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-136">[![Add a New Table to the SecurityTutorials Database](storing-additional-user-information-cs/_static/image2.png)](storing-additional-user-information-cs/_static/image1.png)</span></span>

<span data-ttu-id="b7477-137">**图 1**：将新表添加到 `SecurityTutorials` 数据库（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-137">**Figure 1**: Add a New Table to the `SecurityTutorials` Database  ([Click to view full-size image](storing-additional-user-information-cs/_static/image3.png))</span></span>

<span data-ttu-id="b7477-138">接下来，定义 `GuestbookComments`的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-138">Next, define the `GuestbookComments`'s columns.</span></span> <span data-ttu-id="b7477-139">首先添加一个名为 `uniqueidentifier`的名为 `CommentId` 的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-139">Start by adding a column named `CommentId` of type `uniqueidentifier`.</span></span> <span data-ttu-id="b7477-140">此列将唯一标识留言簿中的每个注释，因此不允许 `NULL` 并将其标记为表的主键。</span><span class="sxs-lookup"><span data-stu-id="b7477-140">This column will uniquely identify each comment in the guestbook, so disallow `NULL` s and mark it as the table's primary key.</span></span> <span data-ttu-id="b7477-141">我们 `INSERT` `uniqueidentifier` 可以通过将列的默认值设置为 `NEWID()`，而不是为每个 `INSERT`上的 "`CommentId`" 字段提供值。</span><span class="sxs-lookup"><span data-stu-id="b7477-141">Rather than providing a value for the `CommentId` field on each `INSERT`, we can indicate that a new `uniqueidentifier` value should be automatically generated for this field on `INSERT` by setting the column's default value to `NEWID()`.</span></span> <span data-ttu-id="b7477-142">添加此第一个字段，将其标记为主键并设置其默认值后，屏幕应类似于图2中所示的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="b7477-142">After adding this first field, marking it as the primary key, and settings its default value, your screen should look similar to the screen shot shown in Figure 2.</span></span>

<span data-ttu-id="b7477-143">[![添加名为 CommentId 的主列](storing-additional-user-information-cs/_static/image5.png)](storing-additional-user-information-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-143">[![Add a Primary Column Named CommentId](storing-additional-user-information-cs/_static/image5.png)](storing-additional-user-information-cs/_static/image4.png)</span></span>

<span data-ttu-id="b7477-144">**图 2**：添加名为 `CommentId` 的主列（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-144">**Figure 2**: Add a Primary Column Named `CommentId` ([Click to view full-size image](storing-additional-user-information-cs/_static/image6.png))</span></span>

<span data-ttu-id="b7477-145">接下来，添加一个名为 `Subject` 类型为 `nvarchar(50)` 的列和一个名为 `nvarchar(MAX)`类型 `Body` 的列，这两列中不允许使用 `NULL`。</span><span class="sxs-lookup"><span data-stu-id="b7477-145">Next, add a column named `Subject` of type `nvarchar(50)` and a column named `Body` of type `nvarchar(MAX)`, disallowing `NULL` s in both columns.</span></span> <span data-ttu-id="b7477-146">然后，添加一个名为 `datetime`的名为 `CommentDate` 的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-146">Following that, add a column named `CommentDate` of type `datetime`.</span></span> <span data-ttu-id="b7477-147">禁止 `NULL`，并将 `CommentDate` 列的默认值设置为 "`getdate()`"。</span><span class="sxs-lookup"><span data-stu-id="b7477-147">Disallow `NULL` s and set the `CommentDate` column's default value to `getdate()`.</span></span>

<span data-ttu-id="b7477-148">剩下的就是添加一个将用户帐户与每个留言簿注释相关联的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-148">All that remains is to add a column that associates a user account with each guestbook comment.</span></span> <span data-ttu-id="b7477-149">一种选择是添加 `nvarchar(256)`类型为 `UserName` 的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-149">One option would be to add a column named `UserName` of type `nvarchar(256)`.</span></span> <span data-ttu-id="b7477-150">当使用 `SqlMembershipProvider`以外的成员资格提供程序时，这是一个合适的选择。</span><span class="sxs-lookup"><span data-stu-id="b7477-150">This is a suitable choice when using a Membership provider other than the `SqlMembershipProvider`.</span></span> <span data-ttu-id="b7477-151">但使用 `SqlMembershipProvider`时，正如本系列教程中所述，`aspnet_Users` 表中的 `UserName` 列不一定是唯一的。</span><span class="sxs-lookup"><span data-stu-id="b7477-151">But when using the `SqlMembershipProvider`, as we are in this tutorial series, the `UserName` column in the `aspnet_Users` table is not guaranteed to be unique.</span></span> <span data-ttu-id="b7477-152">`aspnet_Users` 表的主键 `UserId`，其类型为 `uniqueidentifier`。</span><span class="sxs-lookup"><span data-stu-id="b7477-152">The `aspnet_Users` table's primary key is `UserId` and is of type `uniqueidentifier`.</span></span> <span data-ttu-id="b7477-153">因此，`GuestbookComments` 表需要一个类型为 `UserId` 的列 `uniqueidentifier` （不允许 `NULL` 值）。</span><span class="sxs-lookup"><span data-stu-id="b7477-153">Therefore, the `GuestbookComments` table needs a column named `UserId` of type `uniqueidentifier` (disallowing `NULL` values).</span></span> <span data-ttu-id="b7477-154">继续并添加此列。</span><span class="sxs-lookup"><span data-stu-id="b7477-154">Go ahead and add this column.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-155">正如我们在 SQL Server 教程中[*创建成员身份架构*](creating-the-membership-schema-in-sql-server-cs.md)中讨论的那样，成员身份框架旨在使具有不同用户帐户的多个 web 应用程序共享相同的用户存储区。</span><span class="sxs-lookup"><span data-stu-id="b7477-155">As we discussed in the [*Creating the Membership Schema in SQL Server*](creating-the-membership-schema-in-sql-server-cs.md) tutorial, the Membership framework is designed to enable multiple web applications with different user accounts to share the same user store.</span></span> <span data-ttu-id="b7477-156">它通过将用户帐户分区到不同的应用程序中来实现此功能。</span><span class="sxs-lookup"><span data-stu-id="b7477-156">It does this by partitioning user accounts into different applications.</span></span> <span data-ttu-id="b7477-157">虽然在应用程序中保证每个用户名都是唯一的，但使用相同的用户存储可以在不同的应用程序中使用相同的用户名。</span><span class="sxs-lookup"><span data-stu-id="b7477-157">And while each username is guaranteed to be unique within an application, the same username may be used in different applications using the same user store.</span></span> <span data-ttu-id="b7477-158">`UserName` 和 `ApplicationId` 字段的 `aspnet_Users` 表中有一个复合的 `UNIQUE` 约束，但不只是 `UserName` 字段上有一个。</span><span class="sxs-lookup"><span data-stu-id="b7477-158">There is a composite `UNIQUE` constraint in the `aspnet_Users` table on the `UserName` and `ApplicationId` fields, but not one on just the `UserName` field.</span></span> <span data-ttu-id="b7477-159">因此，aspnet\_Users "表有可能有两个（或更多） `UserName` 值相同的记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-159">Consequently, it is possible for the aspnet\_Users table to have two (or more) records with the same `UserName` value.</span></span> <span data-ttu-id="b7477-160">但 `aspnet_Users` 表的 `UserId` 字段有 `UNIQUE` 约束（因为它是主键）。</span><span class="sxs-lookup"><span data-stu-id="b7477-160">There is, however, a `UNIQUE` constraint on the `aspnet_Users` table's `UserId` field (since it is the primary key).</span></span> <span data-ttu-id="b7477-161">`UNIQUE` 约束很重要，因为如果没有此约束，则无法在 `GuestbookComments` 和 `aspnet_Users` 表之间建立外键约束。</span><span class="sxs-lookup"><span data-stu-id="b7477-161">A `UNIQUE` constraint is important because without it we cannot establish a foreign key constraint between the `GuestbookComments` and `aspnet_Users` tables.</span></span>

<span data-ttu-id="b7477-162">添加 `UserId` 列后，通过单击工具栏中的 "保存" 图标来保存表。</span><span class="sxs-lookup"><span data-stu-id="b7477-162">After adding the `UserId` column, save the table by clicking on the Save icon in the Toolbar.</span></span> <span data-ttu-id="b7477-163">将新表命名 `GuestbookComments`。</span><span class="sxs-lookup"><span data-stu-id="b7477-163">Name the new table `GuestbookComments`.</span></span>

<span data-ttu-id="b7477-164">我们有一个在 `GuestbookComments` 表中出席的最后一个问题：我们需要在 `GuestbookComments.UserId` 列与 `aspnet_Users.UserId` 列之间创建一个[外键约束](https://msdn.microsoft.com/library/ms175464.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-164">We have one last issue to attend to with the `GuestbookComments` table: we need to create a [foreign key constraint](https://msdn.microsoft.com/library/ms175464.aspx) between the `GuestbookComments.UserId` column and the `aspnet_Users.UserId` column.</span></span> <span data-ttu-id="b7477-165">若要实现此目的，请单击工具栏中的 "关系" 图标以启动 "外键关系" 对话框。</span><span class="sxs-lookup"><span data-stu-id="b7477-165">To achieve this, click the Relationship icon in the Toolbar to launch the Foreign Key Relationships dialog box.</span></span> <span data-ttu-id="b7477-166">（或者，您可以通过转到 "表设计器" 菜单并选择 "关系" 来启动此对话框。）</span><span class="sxs-lookup"><span data-stu-id="b7477-166">(Alternatively, you can launch this dialog box by going to the Table Designer menu and choosing Relationships.)</span></span>

<span data-ttu-id="b7477-167">单击 "外键关系" 对话框左下角的 "添加" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b7477-167">Click the Add button in the lower left corner of the Foreign Key Relationships dialog box.</span></span> <span data-ttu-id="b7477-168">这将添加新的 foreign key 约束，但我们仍需要定义参与关系的表。</span><span class="sxs-lookup"><span data-stu-id="b7477-168">This will add a new foreign key constraint, although we still need to define the tables that participate in the relationship.</span></span>

<span data-ttu-id="b7477-169">[![使用 "外键关系" 对话框管理表的外键约束](storing-additional-user-information-cs/_static/image8.png)](storing-additional-user-information-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-169">[![Use the Foreign Key Relationships Dialog Box to Manage a Table's Foreign Key Constraints](storing-additional-user-information-cs/_static/image8.png)](storing-additional-user-information-cs/_static/image7.png)</span></span>

<span data-ttu-id="b7477-170">**图 3**：使用 "外键关系" 对话框管理表的外键约束（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-170">**Figure 3**: Use the Foreign Key Relationships Dialog Box to Manage a Table's Foreign Key Constraints  ([Click to view full-size image](storing-additional-user-information-cs/_static/image9.png))</span></span>

<span data-ttu-id="b7477-171">接下来，单击右侧 "表和列规范" 行中的省略号图标。</span><span class="sxs-lookup"><span data-stu-id="b7477-171">Next, click the ellipses icon in the "Table and Columns Specifications" row on the right.</span></span> <span data-ttu-id="b7477-172">这将启动 "表和列" 对话框，通过该对话框可以从 `GuestbookComments` 表中指定主键表和列和外键列。</span><span class="sxs-lookup"><span data-stu-id="b7477-172">This will launch the Tables and Columns dialog box, from which we can specify the primary key table and column and the foreign key column from the `GuestbookComments` table.</span></span> <span data-ttu-id="b7477-173">特别是，选择 `aspnet_Users`，并将其 `UserId` 为主键表和列，并将 `GuestbookComments` 表中的 `UserId` 用作外键列（参见图4）。</span><span class="sxs-lookup"><span data-stu-id="b7477-173">In particular, select `aspnet_Users` and `UserId` as the primary key table and column, and `UserId` from the `GuestbookComments` table as the foreign key column (see Figure 4).</span></span> <span data-ttu-id="b7477-174">定义主键和外键表和列后，单击 "确定" 以返回到 "外键关系" 对话框。</span><span class="sxs-lookup"><span data-stu-id="b7477-174">After defining the primary and foreign key tables and columns, click OK to return to the Foreign Key Relationships dialog box.</span></span>

<span data-ttu-id="b7477-175">[![在 "aspnet_Users" 表和 "GuesbookComments" 表之间建立外键约束](storing-additional-user-information-cs/_static/image11.png)](storing-additional-user-information-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-175">[![Establish a Foreign Key Constraint Between the aspnet_Users and GuesbookComments Tables](storing-additional-user-information-cs/_static/image11.png)](storing-additional-user-information-cs/_static/image10.png)</span></span>

<span data-ttu-id="b7477-176">**图 4**：建立 `aspnet_Users` 和 `GuesbookComments` 表之间的外键约束（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-176">**Figure 4**: Establish a Foreign Key Constraint Between the `aspnet_Users` and `GuesbookComments` Tables  ([Click to view full-size image](storing-additional-user-information-cs/_static/image12.png))</span></span>

<span data-ttu-id="b7477-177">此时，已建立外键约束。</span><span class="sxs-lookup"><span data-stu-id="b7477-177">At this point the foreign key constraint has been established.</span></span> <span data-ttu-id="b7477-178">此约束的存在确保两个表之间的[关系完整性](http://en.wikipedia.org/wiki/Referential_integrity)，方法是确保不会有引用不存在的用户帐户的留言簿条目。</span><span class="sxs-lookup"><span data-stu-id="b7477-178">The presence of this constraint ensures [relational integrity](http://en.wikipedia.org/wiki/Referential_integrity) between the two tables by guaranteeing that there will never be a guestbook entry referring to a non-existent user account.</span></span> <span data-ttu-id="b7477-179">默认情况下，如果存在相应的子记录，则 foreign key 约束将禁止删除父记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-179">By default, a foreign key constraint will disallow a parent record to be deleted if there are corresponding child records.</span></span> <span data-ttu-id="b7477-180">也就是说，如果用户发出一个或多个留言簿注释，然后我们尝试删除该用户帐户，则删除将失败，除非首先删除他的留言簿评论。</span><span class="sxs-lookup"><span data-stu-id="b7477-180">That is, if a user makes one or more guestbook comments, and then we attempt to delete that user account, the delete will fail unless his guestbook comments are deleted first.</span></span>

<span data-ttu-id="b7477-181">外键约束可以配置为在删除父记录时自动删除关联的子记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-181">Foreign key constraints can be configured to automatically delete the associated child records when a parent record is deleted.</span></span> <span data-ttu-id="b7477-182">换句话说，我们可以设置此 foreign key 约束，以便在删除用户的用户帐户时自动删除用户的留言簿条目。</span><span class="sxs-lookup"><span data-stu-id="b7477-182">In other words, we can setup this foreign key constraint so that a user's guestbook entries are automatically deleted when her user account is deleted.</span></span> <span data-ttu-id="b7477-183">若要实现此目的，请展开 "INSERT 和 UPDATE 规范" 部分，并将 "删除规则" 属性设置为 Cascade。</span><span class="sxs-lookup"><span data-stu-id="b7477-183">To accomplish this, expand the "INSERT And UPDATE Specification" section and set the "Delete Rule" property to Cascade.</span></span>

<span data-ttu-id="b7477-184">[![配置用于级联删除的外键约束](storing-additional-user-information-cs/_static/image14.png)](storing-additional-user-information-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-184">[![Configure the Foreign Key Constraint to Cascade Deletes](storing-additional-user-information-cs/_static/image14.png)](storing-additional-user-information-cs/_static/image13.png)</span></span>

<span data-ttu-id="b7477-185">**图 5**：将外键约束配置为级联删除（[单击以查看完全大小的映像](storing-additional-user-information-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-185">**Figure 5**: Configure the Foreign Key Constraint to Cascade Deletes  ([Click to view full-size image](storing-additional-user-information-cs/_static/image15.png))</span></span>

<span data-ttu-id="b7477-186">若要保存外键约束，请单击 "关闭" 按钮退出外键关系。</span><span class="sxs-lookup"><span data-stu-id="b7477-186">To save the foreign key constraint, click the Close button to exit out of the Foreign Key Relationships.</span></span> <span data-ttu-id="b7477-187">然后单击工具栏中的 "保存" 图标以保存表和此关系。</span><span class="sxs-lookup"><span data-stu-id="b7477-187">Then click the Save icon in the Toolbar to save the table and the this relationship.</span></span>

### <a name="storing-the-users-home-town-homepage-and-signature"></a><span data-ttu-id="b7477-188">存储用户的家庭城镇、主页和签名</span><span class="sxs-lookup"><span data-stu-id="b7477-188">Storing the User's Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="b7477-189">`GuestbookComments` 表说明了如何存储与用户帐户共享一对多关系的信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-189">The `GuestbookComments` table illustrates how to store information that shares a one-to-many relationship with user accounts.</span></span> <span data-ttu-id="b7477-190">由于每个用户帐户可能具有任意数量的关联注释，因此可以通过创建一个表来存储注释集，使其包含一组注释，其中包含一个链接回每个注释给特定用户的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-190">Since each user account may have an arbitrary number of associated comments, this relationship is modeled by creating a table to hold the set of comments that includes a column that links back each comment to a particular user.</span></span> <span data-ttu-id="b7477-191">使用 `SqlMembershipProvider`时，最好是通过创建一个类型为 `UserId` 的列 `uniqueidentifier`，并在此列和 `aspnet_Users.UserId`之间创建一个外键约束，来建立此链接。</span><span class="sxs-lookup"><span data-stu-id="b7477-191">When using the `SqlMembershipProvider`, this link is best established by creating a column named `UserId` of type `uniqueidentifier` and a foreign key constraint between this column and `aspnet_Users.UserId`.</span></span>

<span data-ttu-id="b7477-192">现在，我们需要将三列与每个用户帐户相关联，以存储用户的 "住宅"、"主页" 和 "签名"，这些列将显示在他的留言簿评论中。</span><span class="sxs-lookup"><span data-stu-id="b7477-192">We now need to associate three columns with each user account to store the user's home town, homepage, and signature, which will appear in his guestbook comments.</span></span> <span data-ttu-id="b7477-193">可以通过多种不同的方法来实现此目的：</span><span class="sxs-lookup"><span data-stu-id="b7477-193">There are number of different ways to accomplish this:</span></span>

- <span data-ttu-id="b7477-194">向<strong>`aspnet_Users`</strong><strong>或</strong><strong>`aspnet_Membership`</strong><strong>表</strong>中<strong>添加新列</strong>。</span><span class="sxs-lookup"><span data-stu-id="b7477-194"><strong>Add new columns to the</strong><strong>`aspnet_Users`</strong><strong>or</strong><strong>`aspnet_Membership`</strong><strong>tables.</strong></span></span> <span data-ttu-id="b7477-195">我不建议使用此方法，因为它会修改 `SqlMembershipProvider`使用的架构。</span><span class="sxs-lookup"><span data-stu-id="b7477-195">I would not recommend this approach because it modifies the schema used by the `SqlMembershipProvider`.</span></span> <span data-ttu-id="b7477-196">这一决定可能会 haunt 您的路上。</span><span class="sxs-lookup"><span data-stu-id="b7477-196">This decision may come back to haunt you down the road.</span></span> <span data-ttu-id="b7477-197">例如，如果 ASP.NET 的未来版本使用不同的 `SqlMembershipProvider` 架构。</span><span class="sxs-lookup"><span data-stu-id="b7477-197">For example, what if a future version of ASP.NET uses a different `SqlMembershipProvider` schema.</span></span> <span data-ttu-id="b7477-198">Microsoft 可能会包含一种工具，用于将 ASP.NET 2.0 `SqlMembershipProvider` 的数据迁移到新的架构，但如果修改了 ASP.NET 2.0 `SqlMembershipProvider` 架构，则可能无法进行此类转换。</span><span class="sxs-lookup"><span data-stu-id="b7477-198">Microsoft may include a tool to migrate the ASP.NET 2.0 `SqlMembershipProvider` data to the new schema, but if you have modified the ASP.NET 2.0 `SqlMembershipProvider` schema, such a conversion may not be possible.</span></span>

- <span data-ttu-id="b7477-199">**使用 ASP。NET 的配置文件框架，定义家庭城镇、主页和签名的配置文件属性。**</span><span class="sxs-lookup"><span data-stu-id="b7477-199">**Use ASP.NET's Profile framework, defining a profile property for the home town, homepage, and signature.**</span></span> <span data-ttu-id="b7477-200">ASP.NET 包含一个配置文件框架，用于存储其他特定于用户的数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-200">ASP.NET includes a Profile framework that is designed to store additional user-specific data.</span></span> <span data-ttu-id="b7477-201">与成员身份框架一样，配置文件框架是在提供程序模型的顶层生成的。</span><span class="sxs-lookup"><span data-stu-id="b7477-201">Like the Membership framework, the Profile framework is built atop the provider model.</span></span> <span data-ttu-id="b7477-202">.NET Framework 附带 `SqlProfileProvider` 成功将配置文件数据存储在 SQL Server 数据库中。</span><span class="sxs-lookup"><span data-stu-id="b7477-202">The .NET Framework ships with a `SqlProfileProvider` sthat stores profile data in a SQL Server database.</span></span> <span data-ttu-id="b7477-203">事实上，数据库已具有 `SqlProfileProvider` （`aspnet_Profile`）所用的表，因为在<a id="_msoanchor_2"> </a> [*SQL Server 教程中创建成员身份架构*](creating-the-membership-schema-in-sql-server-cs.md)时添加了应用程序服务。</span><span class="sxs-lookup"><span data-stu-id="b7477-203">In fact, our database already has the table used by the `SqlProfileProvider` (`aspnet_Profile`), as it was added when we added the application services back in the <a id="_msoanchor_2"></a>[*Creating the Membership Schema in SQL Server*](creating-the-membership-schema-in-sql-server-cs.md) tutorial.</span></span>   
  <span data-ttu-id="b7477-204">配置文件框架的主要优点是它允许开发人员定义 `Web.config` 中的配置文件属性–无需编写任何代码来序列化与基础数据存储区中的配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-204">The main benefit of the Profile framework is that it allows for developers to define the profile properties in `Web.config` – no code needs to be written to serialize the profile data to and from the underlying data store.</span></span> <span data-ttu-id="b7477-205">简而言之，定义一组配置文件属性并在代码中使用它们非常简单。</span><span class="sxs-lookup"><span data-stu-id="b7477-205">In short, it is incredibly easy to define a set of profile properties and to work with them in code.</span></span> <span data-ttu-id="b7477-206">但是，当涉及到版本控制时，配置文件系统会给您带来很大的需要，因此，如果您有一个应用程序，该应用程序在以后要添加新的用户特定属性，或要删除或修改现有的特定属性，则配置文件框架可能不是 最佳选项。</span><span class="sxs-lookup"><span data-stu-id="b7477-206">However, the Profile system leaves a lot to be desired when it comes to versioning, so if you have an application where you expect new user-specific properties to be added at a later time, or existing ones to be removed or modified, then the Profile framework may not be the best option.</span></span> <span data-ttu-id="b7477-207">此外，`SqlProfileProvider` 将配置文件属性以高度非规范化的方式存储，使其成为无法直接对配置文件数据运行查询（例如，有多少用户拥有纽约的用户）。</span><span class="sxs-lookup"><span data-stu-id="b7477-207">Moreover, the `SqlProfileProvider` stores the profile properties in a highly denormalized fashion, making it next to impossible to run queries directly against the profile data (such as, how many users have a home town of New York).</span></span>   
  <span data-ttu-id="b7477-208">有关配置文件框架的详细信息，请参阅本教程末尾的 "进一步阅读" 一节。</span><span class="sxs-lookup"><span data-stu-id="b7477-208">For more information on the Profile framework, consult the "Further Readings" section at the end of this tutorial.</span></span>

- <span data-ttu-id="b7477-209"><strong>将这三列添加到数据库中的新表，并在此表和`aspnet_Users`之间建立一对一关系</strong> <strong>。</strong></span><span class="sxs-lookup"><span data-stu-id="b7477-209"><strong>Add these three columns to a new table in the database and establish a one-to-one relationship between this table and</strong><strong>`aspnet_Users`</strong><strong>.</strong></span></span> <span data-ttu-id="b7477-210">此方法所涉及的工作比分析框架要多得多，但在数据库中建模附加用户属性的方式提供了最大的灵活性。</span><span class="sxs-lookup"><span data-stu-id="b7477-210">This approach involves a bit more work than with the Profile framework, but offers maximum flexibility in how the additional user properties are modeled in the database.</span></span> <span data-ttu-id="b7477-211">这是我们将在本教程中使用的选项。</span><span class="sxs-lookup"><span data-stu-id="b7477-211">This is the option we will use in this tutorial.</span></span>

<span data-ttu-id="b7477-212">我们将创建一个名为 `UserProfiles` 的新表，以保存每个用户的 home 镇、主页和签名。</span><span class="sxs-lookup"><span data-stu-id="b7477-212">We will create a new table called `UserProfiles` to save the home town, homepage, and signature for each user.</span></span> <span data-ttu-id="b7477-213">右键单击 "数据库资源管理器" 窗口中的 "表" 文件夹，然后选择创建新表。</span><span class="sxs-lookup"><span data-stu-id="b7477-213">Right-click on the Tables folder in the Database Explorer window and choose to create a new table.</span></span> <span data-ttu-id="b7477-214">将第一列命名 `UserId` 并将其类型设置为 `uniqueidentifier`。</span><span class="sxs-lookup"><span data-stu-id="b7477-214">Name the first column `UserId` and set its type to `uniqueidentifier`.</span></span> <span data-ttu-id="b7477-215">禁止 `NULL` 值并将列标记为主键。</span><span class="sxs-lookup"><span data-stu-id="b7477-215">Disallow `NULL` values and mark the column as a primary key.</span></span> <span data-ttu-id="b7477-216">接下来，添加名为的列：类型为 `nvarchar(50)`的 `HomeTown`;`nvarchar(100)`类型的 `HomepageUrl`;`nvarchar(500)`类型的和签名。</span><span class="sxs-lookup"><span data-stu-id="b7477-216">Next, add columns named: `HomeTown` of type `nvarchar(50)`; `HomepageUrl` of type `nvarchar(100)`; and Signature of type `nvarchar(500)`.</span></span> <span data-ttu-id="b7477-217">这三列中的每一列都可以接受 `NULL` 值。</span><span class="sxs-lookup"><span data-stu-id="b7477-217">Each of these three columns can accept a `NULL` value.</span></span>

<span data-ttu-id="b7477-218">[![创建 UserProfiles 表](storing-additional-user-information-cs/_static/image17.png)](storing-additional-user-information-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-218">[![Create the UserProfiles Table](storing-additional-user-information-cs/_static/image17.png)](storing-additional-user-information-cs/_static/image16.png)</span></span>

<span data-ttu-id="b7477-219">**图 6**：创建 `UserProfiles` 表（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-219">**Figure 6**: Create the `UserProfiles` Table  ([Click to view full-size image](storing-additional-user-information-cs/_static/image18.png))</span></span>

<span data-ttu-id="b7477-220">保存该表并将其命名为 `UserProfiles`。</span><span class="sxs-lookup"><span data-stu-id="b7477-220">Save the table and name it `UserProfiles`.</span></span> <span data-ttu-id="b7477-221">最后，在 `UserProfiles` 表的 `UserId` 字段与 `aspnet_Users.UserId` 字段之间建立外键约束。</span><span class="sxs-lookup"><span data-stu-id="b7477-221">Lastly, establish a foreign key constraint between the `UserProfiles` table's `UserId` field and the `aspnet_Users.UserId` field.</span></span> <span data-ttu-id="b7477-222">与 `GuestbookComments` 和 `aspnet_Users` 表之间的外键约束一样，请将此约束删除。</span><span class="sxs-lookup"><span data-stu-id="b7477-222">As we did with the foreign key constraint between the `GuestbookComments` and `aspnet_Users` tables, have this constraint cascade deletes.</span></span> <span data-ttu-id="b7477-223">由于 `UserProfiles` 中的 `UserId` 字段是主键，这可确保每个用户帐户的 `UserProfiles` 表中不会有多条记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-223">Since the `UserId` field in `UserProfiles` is the primary key, this ensures that there will be no more than one record in the `UserProfiles` table for each user account.</span></span> <span data-ttu-id="b7477-224">这种关系称为一对一关系。</span><span class="sxs-lookup"><span data-stu-id="b7477-224">This type of relationship is referred to as one-to-one.</span></span>

<span data-ttu-id="b7477-225">现在，我们已经创建了数据模型，接下来可以使用它了。</span><span class="sxs-lookup"><span data-stu-id="b7477-225">Now that we have the data model created, we are ready to use it.</span></span> <span data-ttu-id="b7477-226">在步骤2和步骤3中，我们将看看当前登录的用户可以如何查看和编辑其家庭城镇、主页和签名信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-226">In Steps 2 and 3 we will look at how the currently logged on user can view and edit their home town, homepage, and signature information.</span></span> <span data-ttu-id="b7477-227">在步骤4中，我们将为经过身份验证的用户创建用于向留言簿提交新评论并查看现有评论的界面。</span><span class="sxs-lookup"><span data-stu-id="b7477-227">In Step 4 we will create the interface for authenticated users to submit new comments to the guestbook and view the existing ones.</span></span>

## <a name="step-2-displaying-the-users-home-town-homepage-and-signature"></a><span data-ttu-id="b7477-228">步骤2：显示用户的 "住宅"、"主页" 和 "签名"</span><span class="sxs-lookup"><span data-stu-id="b7477-228">Step 2: Displaying the User's Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="b7477-229">有多种方式允许当前登录的用户查看和编辑其 home、主页和签名信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-229">There are a variety of ways to allow the currently logged on user to view and edit his home town, homepage, and signature information.</span></span> <span data-ttu-id="b7477-230">我们可以使用文本框和标签控件手动创建用户界面，也可以使用其中一个数据 Web 控件（如 DetailsView 控件）。</span><span class="sxs-lookup"><span data-stu-id="b7477-230">We could manually create the user interface with TextBox and Label controls or we could use one of the data Web controls, such as the DetailsView control.</span></span> <span data-ttu-id="b7477-231">若要执行数据库 `SELECT` 和 `UPDATE` 语句，我们可以在页面的代码隐藏类中编写 ADO.NET 代码，或者在 SqlDataSource 中使用声明性方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-231">To perform the database `SELECT` and `UPDATE` statements we could write ADO.NET code in our page's code-behind class or, alternatively, employ a declarative approach with the SqlDataSource.</span></span> <span data-ttu-id="b7477-232">理想情况下，我们的应用程序将包含分层体系结构，可以通过编程方式从页面的代码隐藏类调用，或通过 ObjectDataSource 控件以声明方式调用。</span><span class="sxs-lookup"><span data-stu-id="b7477-232">Ideally our application would contain a tiered architecture, which we could either invoke programmatically from the page's code-behind class or declaratively via the ObjectDataSource control.</span></span>

<span data-ttu-id="b7477-233">由于本教程系列重点介绍 forms 身份验证、授权、用户帐户和角色，因此将不会全面讨论这些不同的数据访问选项，或者为什么使用分层体系结构直接执行 SQL 语句从 "ASP.NET" 页。</span><span class="sxs-lookup"><span data-stu-id="b7477-233">Since this tutorial series focuses on forms authentication, authorization, user accounts, and roles, there will not be a thorough discussion of these different data access options or why a tiered architecture is preferred over executing SQL statements directly from the ASP.NET page.</span></span> <span data-ttu-id="b7477-234">我将逐步介绍如何使用 DetailsView 和 SqlDataSource –最快捷、最简单的选项，但讨论的概念肯定适用于替代 Web 控件和数据访问逻辑。</span><span class="sxs-lookup"><span data-stu-id="b7477-234">I am going to walk through using a DetailsView and SqlDataSource – the quickest and easiest option – but the concepts discussed can certainly be applied to alternative Web controls and data access logic.</span></span> <span data-ttu-id="b7477-235">有关使用 ASP.NET 中的数据的详细信息，请参阅使用 *[ASP.NET 2.0 教程系列中的数据](../../data-access/index.md)* 。</span><span class="sxs-lookup"><span data-stu-id="b7477-235">For more information on working with data in ASP.NET, refer to my *[Working with Data in ASP.NET 2.0](../../data-access/index.md)* tutorial series.</span></span>

<span data-ttu-id="b7477-236">打开 `Membership` 文件夹中的 "`AdditionalUserInfo.aspx`" 页，向页面添加 "DetailsView" 控件，并将其 `ID` 属性设置为 `UserProfile` 并清除其 `Width` 和 `Height` 属性。</span><span class="sxs-lookup"><span data-stu-id="b7477-236">Open the `AdditionalUserInfo.aspx` page in the `Membership` folder and add a DetailsView control to the page, setting its `ID` property to `UserProfile` and clearing out its `Width` and `Height` properties.</span></span> <span data-ttu-id="b7477-237">展开 DetailsView 的智能标记，然后选择将其绑定到新的数据源控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-237">Expand the DetailsView's Smart Tag and choose to bind it to a new data source control.</span></span> <span data-ttu-id="b7477-238">这将启动 "数据源配置向导" （参见图7）。</span><span class="sxs-lookup"><span data-stu-id="b7477-238">This will launch the DataSource Configuration Wizard (see Figure 7).</span></span> <span data-ttu-id="b7477-239">第一个步骤要求您指定数据源类型。</span><span class="sxs-lookup"><span data-stu-id="b7477-239">The first step asks you to specify the data source type.</span></span> <span data-ttu-id="b7477-240">由于我们要直接连接到 `SecurityTutorials` 数据库，因此请选择 "数据库" 图标，将 "`ID`" 指定为 "`UserProfileDataSource`"。</span><span class="sxs-lookup"><span data-stu-id="b7477-240">Since we are going to connect directly to the `SecurityTutorials` database, choose the Database icon, specifying the `ID` as `UserProfileDataSource`.</span></span>

<span data-ttu-id="b7477-241">[![添加一个名为 UserProfileDataSource 的新 SqlDataSource 控件](storing-additional-user-information-cs/_static/image20.png)](storing-additional-user-information-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-241">[![Add a New SqlDataSource Control Named UserProfileDataSource](storing-additional-user-information-cs/_static/image20.png)](storing-additional-user-information-cs/_static/image19.png)</span></span>

<span data-ttu-id="b7477-242">**图 7**：添加名为 `UserProfileDataSource` 的新 SqlDataSource 控件（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-242">**Figure 7**: Add a New SqlDataSource Control Named `UserProfileDataSource` ([Click to view full-size image](storing-additional-user-information-cs/_static/image21.png))</span></span>

<span data-ttu-id="b7477-243">下一屏幕将提示数据库使用。</span><span class="sxs-lookup"><span data-stu-id="b7477-243">The next screen prompts for the database to use.</span></span> <span data-ttu-id="b7477-244">已在 `Web.config` 中为 `SecurityTutorials` 数据库定义了一个连接字符串。</span><span class="sxs-lookup"><span data-stu-id="b7477-244">We have already defined a connection string in `Web.config` for the `SecurityTutorials` database.</span></span> <span data-ttu-id="b7477-245">此连接字符串名称– `SecurityTutorialsConnectionString` –应在下拉列表中。</span><span class="sxs-lookup"><span data-stu-id="b7477-245">This connection string name – `SecurityTutorialsConnectionString` – should be in the drop-down list.</span></span> <span data-ttu-id="b7477-246">选择此选项，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="b7477-246">Select this option and click Next.</span></span>

<span data-ttu-id="b7477-247">[![从下拉列表中选择 "SecurityTutorialsConnectionString"](storing-additional-user-information-cs/_static/image23.png)](storing-additional-user-information-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-247">[![Choose SecurityTutorialsConnectionString from the Drop-Down List](storing-additional-user-information-cs/_static/image23.png)](storing-additional-user-information-cs/_static/image22.png)</span></span>

<span data-ttu-id="b7477-248">**图 8**：从下拉列表中选择 "`SecurityTutorialsConnectionString`" （[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-248">**Figure 8**: Choose `SecurityTutorialsConnectionString` from the Drop-Down List  ([Click to view full-size image](storing-additional-user-information-cs/_static/image24.png))</span></span>

<span data-ttu-id="b7477-249">后续屏幕会要求我们指定要查询的表和列。</span><span class="sxs-lookup"><span data-stu-id="b7477-249">The subsequent screen asks us to specify the table and columns to query.</span></span> <span data-ttu-id="b7477-250">从下拉列表中选择 `UserProfiles` 表，然后检查所有列。</span><span class="sxs-lookup"><span data-stu-id="b7477-250">Choose the `UserProfiles` table from the drop-down list and check all of the columns.</span></span>

<span data-ttu-id="b7477-251">[![返回 UserProfiles 表中的所有列](storing-additional-user-information-cs/_static/image26.png)](storing-additional-user-information-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-251">[![Bring Back All of the Columns from the UserProfiles Table](storing-additional-user-information-cs/_static/image26.png)](storing-additional-user-information-cs/_static/image25.png)</span></span>

<span data-ttu-id="b7477-252">**图 9**：取回 `UserProfiles` 表中的所有列（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image27.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-252">**Figure 9**: Bring Back All of the Columns from the `UserProfiles` Table  ([Click to view full-size image](storing-additional-user-information-cs/_static/image27.png))</span></span>

<span data-ttu-id="b7477-253">图9中的当前查询将返回 `UserProfiles`中的*所有*记录，但我们只对当前登录的用户记录感兴趣。</span><span class="sxs-lookup"><span data-stu-id="b7477-253">The current query in Figure 9 returns *all* of the records in `UserProfiles`, but we are only interested in the currently logged on user's record.</span></span> <span data-ttu-id="b7477-254">若要添加 `WHERE` 子句，请单击 "`WHERE`" 按钮以显示 "添加 `WHERE` 子句" 对话框（请参阅图10）。</span><span class="sxs-lookup"><span data-stu-id="b7477-254">To add a `WHERE` clause, click the `WHERE` button to bring up the Add `WHERE` Clause dialog box (see Figure 10).</span></span> <span data-ttu-id="b7477-255">您可以在此处选择要筛选的列、运算符和筛选器参数的源。</span><span class="sxs-lookup"><span data-stu-id="b7477-255">Here you can select the column to filter on, the operator, and the source of the filter parameter.</span></span> <span data-ttu-id="b7477-256">选择 "`UserId`" 作为列，选择 "=" 作为运算符。</span><span class="sxs-lookup"><span data-stu-id="b7477-256">Select `UserId` as the column and "=" as the Operator.</span></span>

<span data-ttu-id="b7477-257">遗憾的是，没有内置参数源来返回当前登录用户的 `UserId` 值。</span><span class="sxs-lookup"><span data-stu-id="b7477-257">Unfortunately there is no built-in parameter source to return the currently logged on user's `UserId` value.</span></span> <span data-ttu-id="b7477-258">我们需要以编程方式获取此值。</span><span class="sxs-lookup"><span data-stu-id="b7477-258">We will need to grab this value programmatically.</span></span> <span data-ttu-id="b7477-259">因此，将 "源" 下拉列表设置为 "无"，单击 "添加" 按钮添加参数，然后单击 "确定"。</span><span class="sxs-lookup"><span data-stu-id="b7477-259">Therefore, set the Source drop-down list to "None," click the Add button to add the parameter, and then click OK.</span></span>

<span data-ttu-id="b7477-260">[![在 UserId 列上添加筛选器参数](storing-additional-user-information-cs/_static/image29.png)](storing-additional-user-information-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-260">[![Add a Filter Parameter on the UserId Column](storing-additional-user-information-cs/_static/image29.png)](storing-additional-user-information-cs/_static/image28.png)</span></span>

<span data-ttu-id="b7477-261">**图 10**：在 `UserId` 列上添加筛选器参数（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image30.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-261">**Figure 10**: Add a Filter Parameter on the `UserId` Column  ([Click to view full-size image](storing-additional-user-information-cs/_static/image30.png))</span></span>

<span data-ttu-id="b7477-262">单击 "确定" 后，将返回到图9中所示的屏幕。</span><span class="sxs-lookup"><span data-stu-id="b7477-262">After clicking OK you will be returned to the screen shown in Figure 9.</span></span> <span data-ttu-id="b7477-263">但这一次，屏幕底部的 SQL 查询应包含一个 `WHERE` 子句。</span><span class="sxs-lookup"><span data-stu-id="b7477-263">This time, however, the SQL query at the bottom of the screen should include a `WHERE` clause.</span></span> <span data-ttu-id="b7477-264">单击 "下一步" 转到 "测试查询" 屏幕。</span><span class="sxs-lookup"><span data-stu-id="b7477-264">Click Next to move on to the "Test Query" screen.</span></span> <span data-ttu-id="b7477-265">可在此处运行查询并查看结果。</span><span class="sxs-lookup"><span data-stu-id="b7477-265">Here you can run the query and see the results.</span></span> <span data-ttu-id="b7477-266">单击“完成”按钮以完成向导。</span><span class="sxs-lookup"><span data-stu-id="b7477-266">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="b7477-267">完成数据源配置向导后，Visual Studio 将基于在向导中指定的设置创建 SqlDataSource 控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-267">Upon completing the DataSource Configuration Wizard, Visual Studio creates the SqlDataSource control based on the settings specified in the wizard.</span></span> <span data-ttu-id="b7477-268">此外，它还会针对 SqlDataSource 的 `SelectCommand`返回的每个列，手动将 BoundFields 添加到 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="b7477-268">Moreover, it manually adds BoundFields to the DetailsView for each column returned by the SqlDataSource's `SelectCommand`.</span></span> <span data-ttu-id="b7477-269">不需要在 DetailsView 中显示 "`UserId`" 字段，因为用户无需知道此值。</span><span class="sxs-lookup"><span data-stu-id="b7477-269">There's no need to show the `UserId` field in the DetailsView, since the user does not need to know this value.</span></span> <span data-ttu-id="b7477-270">您可以直接从 DetailsView 控件的声明性标记中删除此字段，或单击其智能标记中的 "编辑字段" 链接。</span><span class="sxs-lookup"><span data-stu-id="b7477-270">You can remove this field directly from the DetailsView control's declarative markup or by clicking the "Edit Fields" link from its Smart Tag.</span></span>

<span data-ttu-id="b7477-271">此时，页面的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7477-271">At this point your page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample1.aspx)]

<span data-ttu-id="b7477-272">在选择数据之前，我们需要以编程方式将 SqlDataSource 控件的 `UserId` 参数设置为当前已登录用户的 `UserId`。</span><span class="sxs-lookup"><span data-stu-id="b7477-272">We need to programmatically set the SqlDataSource control's `UserId` parameter to the currently logged in user's `UserId` before the data is selected.</span></span> <span data-ttu-id="b7477-273">为此，可以创建 SqlDataSource 的 `Selecting` 事件的事件处理程序，并在其中添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="b7477-273">This can be accomplished by creating an event handler for the SqlDataSource's `Selecting` event and adding the following code there:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample2.cs)]

<span data-ttu-id="b7477-274">上面的代码首先通过调用 `Membership` 类的 `GetUser` 方法来获取对当前已登录用户的引用。</span><span class="sxs-lookup"><span data-stu-id="b7477-274">The above code starts by obtaining a reference to the currently logged on user by calling the `Membership` class's `GetUser` method.</span></span> <span data-ttu-id="b7477-275">这会返回 `MembershipUser` 对象，该对象的 `ProviderUserKey` 属性包含 `UserId`。</span><span class="sxs-lookup"><span data-stu-id="b7477-275">This returns a `MembershipUser` object, whose `ProviderUserKey` property contains the `UserId`.</span></span> <span data-ttu-id="b7477-276">然后，将 `UserId` 值分配给 SqlDataSource 的 `@UserId` 参数。</span><span class="sxs-lookup"><span data-stu-id="b7477-276">The `UserId` value is then assigned to the SqlDataSource's `@UserId` parameter.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-277">`Membership.GetUser()` 方法返回有关当前已登录用户的信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-277">The `Membership.GetUser()` method returns information about the currently logged on user.</span></span> <span data-ttu-id="b7477-278">如果匿名用户正在访问该页面，它将返回值 `null`。</span><span class="sxs-lookup"><span data-stu-id="b7477-278">If an anonymous user is visiting the page, it will return a value of `null`.</span></span> <span data-ttu-id="b7477-279">在这种情况下，当尝试读取 `ProviderUserKey` 属性时，这将导致 `NullReferenceException` 以下代码行。</span><span class="sxs-lookup"><span data-stu-id="b7477-279">In such a case, this will lead to a `NullReferenceException` on the following line of code when attempting to read the `ProviderUserKey` property.</span></span> <span data-ttu-id="b7477-280">当然，我们不必担心在 `AdditionalUserInfo.aspx` 页中返回 `null` 值 `Membership.GetUser()`，因为我们在上一教程中配置了 URL 授权，以便只有经过身份验证的用户才能访问此文件夹中的 ASP.NET 资源。</span><span class="sxs-lookup"><span data-stu-id="b7477-280">Of course, we don't have to worry about `Membership.GetUser()` returning a `null` value in the `AdditionalUserInfo.aspx` page because we configured URL authorization in a previous tutorial so that only authenticated users could access the ASP.NET resources in this folder.</span></span> <span data-ttu-id="b7477-281">如果需要在允许匿名访问的页面中访问有关当前已登录用户的信息，请确保从 `GetUser()` 方法返回非`null MembershipUser` 对象，然后再引用其属性。</span><span class="sxs-lookup"><span data-stu-id="b7477-281">If you need to access information about the currently logged on user in a page where anonymous access is permitted, make sure to check that a non-`null MembershipUser` object is returned from the `GetUser()` method before referencing its properties.</span></span>

<span data-ttu-id="b7477-282">如果通过浏览器访问 `AdditionalUserInfo.aspx` 页面，您将看到一个空白页面，因为我们尚未向 `UserProfiles` 表中添加任何行。</span><span class="sxs-lookup"><span data-stu-id="b7477-282">If you visit the `AdditionalUserInfo.aspx` page through a browser you will see a blank page because we have yet to add any rows to the `UserProfiles` table.</span></span> <span data-ttu-id="b7477-283">在步骤6中，我们将介绍如何自定义 CreateUserWizard 控件，以便在创建新的用户帐户时自动将新行添加到 `UserProfiles` 表。</span><span class="sxs-lookup"><span data-stu-id="b7477-283">In Step 6 we will look at how to customize the CreateUserWizard control to automatically add a new row to the `UserProfiles` table when a new user account is created.</span></span> <span data-ttu-id="b7477-284">但现在，我们需要手动在表中创建一条记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-284">For now, however, we will need to manually create a record in the table.</span></span>

<span data-ttu-id="b7477-285">在 Visual Studio 中导航到数据库资源管理器，然后展开 "表" 文件夹。</span><span class="sxs-lookup"><span data-stu-id="b7477-285">Navigate to the Database Explorer in Visual Studio and expand the Tables folder.</span></span> <span data-ttu-id="b7477-286">右键单击 `aspnet_Users` 表，然后选择 "显示表数据" 以查看表中的记录;对 `UserProfiles` 表执行相同的操作。</span><span class="sxs-lookup"><span data-stu-id="b7477-286">Right-click on the `aspnet_Users` table and choose "Show Table Data" to see the records in the table; do the same thing for the `UserProfiles` table.</span></span> <span data-ttu-id="b7477-287">图11在垂直平铺时显示这些结果。</span><span class="sxs-lookup"><span data-stu-id="b7477-287">Figure 11 shows these results when tiled vertically.</span></span> <span data-ttu-id="b7477-288">在数据库中，当前有 `aspnet_Users` Bruce、Fred 和 Tito 的记录，但 `UserProfiles` 表中没有记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-288">In my database there are currently `aspnet_Users` records for Bruce, Fred, and Tito, but no records in the `UserProfiles` table.</span></span>

<span data-ttu-id="b7477-289">[![显示 aspnet_Users 表和 UserProfiles 表的内容](storing-additional-user-information-cs/_static/image32.png)](storing-additional-user-information-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-289">[![The Contents of the aspnet_Users and UserProfiles Tables are Displayed](storing-additional-user-information-cs/_static/image32.png)](storing-additional-user-information-cs/_static/image31.png)</span></span>

<span data-ttu-id="b7477-290">**图 11**：显示了 `aspnet_Users` 和 `UserProfiles` 表的内容（[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image33.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-290">**Figure 11**: The Contents of the `aspnet_Users` and `UserProfiles` Tables are Displayed  ([Click to view full-size image](storing-additional-user-information-cs/_static/image33.png))</span></span>

<span data-ttu-id="b7477-291">通过手动键入 `HomeTown`、`HomepageUrl`和 `Signature` 字段的值，将新记录添加到 `UserProfiles` 表。</span><span class="sxs-lookup"><span data-stu-id="b7477-291">Add a new record to the `UserProfiles` table by manually typing in values for the `HomeTown`, `HomepageUrl`, and `Signature` fields.</span></span> <span data-ttu-id="b7477-292">若要在新的 `UserProfiles` 记录中获得有效 `UserId` 值，最简单的方法是从 `aspnet_Users` 表的特定用户帐户中选择 `UserId` 字段，并将其复制并粘贴到 `UserId` 中的 `UserProfiles`字段。</span><span class="sxs-lookup"><span data-stu-id="b7477-292">The easiest way to get a valid `UserId` value in the new `UserProfiles` record is to select the `UserId` field from a particular user account in the `aspnet_Users` table and copy and paste it into the `UserId` field in `UserProfiles`.</span></span> <span data-ttu-id="b7477-293">图12显示了为 Bruce 添加了新记录后的 `UserProfiles` 表。</span><span class="sxs-lookup"><span data-stu-id="b7477-293">Figure 12 shows the `UserProfiles` table after a new record has been added for Bruce.</span></span>

<span data-ttu-id="b7477-294">[![已将记录添加到 Bruce 的 UserProfiles](storing-additional-user-information-cs/_static/image35.png)](storing-additional-user-information-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-294">[![A Record was Added to UserProfiles for Bruce](storing-additional-user-information-cs/_static/image35.png)](storing-additional-user-information-cs/_static/image34.png)</span></span>

<span data-ttu-id="b7477-295">**图 12**：已将记录添加到 Bruce 的 `UserProfiles` （[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image36.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-295">**Figure 12**: A Record was Added to `UserProfiles` for Bruce  ([Click to view full-size image](storing-additional-user-information-cs/_static/image36.png))</span></span>

<span data-ttu-id="b7477-296">返回到以 Bruce 身份登录的 "`AdditionalUserInfo.aspx`" 页。</span><span class="sxs-lookup"><span data-stu-id="b7477-296">Return to the `AdditionalUserInfo.aspx` page, logged in as Bruce.</span></span> <span data-ttu-id="b7477-297">如图13所示，将显示 Bruce 的设置。</span><span class="sxs-lookup"><span data-stu-id="b7477-297">As Figure 13 shows, Bruce's settings are displayed.</span></span>

<span data-ttu-id="b7477-298">[![当前访问的用户显示其设置](storing-additional-user-information-cs/_static/image38.png)](storing-additional-user-information-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-298">[![The Currently Visiting User is Shown His Settings](storing-additional-user-information-cs/_static/image38.png)](storing-additional-user-information-cs/_static/image37.png)</span></span>

<span data-ttu-id="b7477-299">**图 13**：当前正在访问的用户显示其设置（[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image39.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-299">**Figure 13**: The Currently Visiting User is Shown His Settings  ([Click to view full-size image](storing-additional-user-information-cs/_static/image39.png))</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-300">继续在 `UserProfiles` 表中为每个成员身份用户手动添加记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-300">Go ahead and manually add records in the `UserProfiles` table for each Membership user.</span></span> <span data-ttu-id="b7477-301">在步骤6中，我们将介绍如何自定义 CreateUserWizard 控件，以便在创建新的用户帐户时自动将新行添加到 `UserProfiles` 表。</span><span class="sxs-lookup"><span data-stu-id="b7477-301">In Step 6 we will look at how to customize the CreateUserWizard control to automatically add a new row to the `UserProfiles` table when a new user account is created.</span></span>

## <a name="step-3-allowing-the-user-to-edit-his-home-town-homepage-and-signature"></a><span data-ttu-id="b7477-302">步骤3：允许用户编辑其家庭城镇、主页和签名</span><span class="sxs-lookup"><span data-stu-id="b7477-302">Step 3: Allowing the User to Edit His Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="b7477-303">此时，当前登录的用户可以查看其 "住宅"、"主页" 和 "签名" 设置，但他们无法修改它们。</span><span class="sxs-lookup"><span data-stu-id="b7477-303">At this point the currently logged in user can view their home town, homepage, and signature setting, but they cannot yet modify them.</span></span> <span data-ttu-id="b7477-304">让我们更新 DetailsView 控件以便可以编辑数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-304">Let's update the DetailsView control so that the data can be edited.</span></span>

<span data-ttu-id="b7477-305">我们需要做的第一件事是为 SqlDataSource 添加 `UpdateCommand`，并指定要执行的 `UPDATE` 语句及其相应的参数。</span><span class="sxs-lookup"><span data-stu-id="b7477-305">The first thing we need to do is add an `UpdateCommand` for the SqlDataSource, specifying the `UPDATE` statement to execute and its corresponding parameters.</span></span> <span data-ttu-id="b7477-306">选择 "SqlDataSource"，属性窗口然后单击 "UpdateQuery" 属性旁边的省略号，打开 "命令和参数编辑器" 对话框。</span><span class="sxs-lookup"><span data-stu-id="b7477-306">Select the SqlDataSource and, from the Properties window, click on the ellipses next to the UpdateQuery property to bring up the Command and Parameter Editor dialog box.</span></span> <span data-ttu-id="b7477-307">在文本框中输入以下 `UPDATE` 语句：</span><span class="sxs-lookup"><span data-stu-id="b7477-307">Enter the following `UPDATE` statement into the textbox:</span></span>

[!code-sql[Main](storing-additional-user-information-cs/samples/sample3.sql)]

<span data-ttu-id="b7477-308">接下来，单击 "刷新参数" 按钮，该按钮将在 SqlDataSource 控件的 `UpdateParameters` 集合中为 `UPDATE` 语句中的每个参数创建一个参数。</span><span class="sxs-lookup"><span data-stu-id="b7477-308">Next, click the "Refresh Parameters" button, which will create a parameter in the SqlDataSource control's `UpdateParameters` collection for each of the parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="b7477-309">保留设置为 "无" 的所有参数的源，然后单击 "确定" 按钮完成对话框。</span><span class="sxs-lookup"><span data-stu-id="b7477-309">Leave the source for all of the parameters set to None and click the OK button to complete the dialog box.</span></span>

<span data-ttu-id="b7477-310">[![指定 SqlDataSource 的 UpdateCommand 和 UpdateParameters](storing-additional-user-information-cs/_static/image41.png)](storing-additional-user-information-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-310">[![Specify the SqlDataSource's UpdateCommand and UpdateParameters](storing-additional-user-information-cs/_static/image41.png)](storing-additional-user-information-cs/_static/image40.png)</span></span>

<span data-ttu-id="b7477-311">**图 14**：指定 SqlDataSource 的 `UpdateCommand` 和 `UpdateParameters` （[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image42.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-311">**Figure 14**: Specify the SqlDataSource's `UpdateCommand` and `UpdateParameters` ([Click to view full-size image](storing-additional-user-information-cs/_static/image42.png))</span></span>

<span data-ttu-id="b7477-312">由于我们对 SqlDataSource 控件进行了添加，DetailsView 控件现在可以支持编辑。</span><span class="sxs-lookup"><span data-stu-id="b7477-312">Due to the additions we made to the SqlDataSource control, the DetailsView control can now support editing.</span></span> <span data-ttu-id="b7477-313">在 DetailsView 的智能标记中，选中 "启用编辑" 复选框。</span><span class="sxs-lookup"><span data-stu-id="b7477-313">From the DetailsView's Smart Tag, check the "Enable Editing" checkbox.</span></span> <span data-ttu-id="b7477-314">这会将 CommandField 添加到控件的 `Fields` 集合，并将其 `ShowEditButton` 属性设置为 True。</span><span class="sxs-lookup"><span data-stu-id="b7477-314">This adds a CommandField to the control's `Fields` collection with its `ShowEditButton` property set to True.</span></span> <span data-ttu-id="b7477-315">当 DetailsView 显示为只读模式，并在编辑模式下显示 "更新" 和 "取消" 按钮时，此按钮将呈现 "编辑" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b7477-315">This renders an Edit button when the DetailsView is displayed in read-only mode and Update and Cancel buttons when displayed in edit mode.</span></span> <span data-ttu-id="b7477-316">但不要求用户单击 "编辑"，而是可以通过将 DetailsView 控件的[`DefaultMode` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.defaultmode.aspx)设置为 `Edit`，将 detailsview 渲染为 "始终可编辑" 状态。</span><span class="sxs-lookup"><span data-stu-id="b7477-316">Rather than requiring the user to click Edit, though, we can have the DetailsView render in an "always editable" state by setting the DetailsView control's [`DefaultMode` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.defaultmode.aspx) to `Edit`.</span></span>

<span data-ttu-id="b7477-317">进行这些更改后，DetailsView 控件的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7477-317">With these changes, your DetailsView control's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample4.aspx)]

<span data-ttu-id="b7477-318">请注意，CommandField 和 `DefaultMode` 属性的添加。</span><span class="sxs-lookup"><span data-stu-id="b7477-318">Note the addition of the CommandField and the `DefaultMode` property.</span></span>

<span data-ttu-id="b7477-319">继续在浏览器中测试此页。</span><span class="sxs-lookup"><span data-stu-id="b7477-319">Go ahead and test this page through a browser.</span></span> <span data-ttu-id="b7477-320">当使用 `UserProfiles`中的相应记录访问用户时，用户的设置将显示在可编辑的界面中。</span><span class="sxs-lookup"><span data-stu-id="b7477-320">When visiting with a user that has a corresponding record in `UserProfiles`, the user's settings are displayed in an editable interface.</span></span>

<span data-ttu-id="b7477-321">[![DetailsView 呈现可编辑接口](storing-additional-user-information-cs/_static/image44.png)](storing-additional-user-information-cs/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-321">[![The DetailsView Renders an Editable Interface](storing-additional-user-information-cs/_static/image44.png)](storing-additional-user-information-cs/_static/image43.png)</span></span>

<span data-ttu-id="b7477-322">**图 15**： DetailsView 呈现一个可编辑界面（[单击以查看完全尺寸的图像](storing-additional-user-information-cs/_static/image45.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-322">**Figure 15**: The DetailsView Renders an Editable Interface  ([Click to view full-size image](storing-additional-user-information-cs/_static/image45.png))</span></span>

<span data-ttu-id="b7477-323">尝试更改这些值，然后单击 "更新" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b7477-323">Try changing the values and clicking the Update button.</span></span> <span data-ttu-id="b7477-324">好像没有发生任何变化。</span><span class="sxs-lookup"><span data-stu-id="b7477-324">It appears as if nothing happens.</span></span> <span data-ttu-id="b7477-325">存在回发，并将值保存到数据库中，但不存在保存的视觉反馈。</span><span class="sxs-lookup"><span data-stu-id="b7477-325">There is a postback and the values are saved to the database, but there's no visual feedback that the save occurred.</span></span>

<span data-ttu-id="b7477-326">若要解决此情况，请返回到 Visual Studio，并在 DetailsView 上方添加标签控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-326">To remedy this, return to Visual Studio and add a Label control above the DetailsView.</span></span> <span data-ttu-id="b7477-327">将其 `ID` 设置为 `SettingsUpdatedMessage`，其 `Text` 属性设置为 "已更新设置"，并将其 `Visible` 和 `EnableViewState` 属性设置为 `false`。</span><span class="sxs-lookup"><span data-stu-id="b7477-327">Set its `ID` to `SettingsUpdatedMessage`, its `Text` property to "Your settings have been updated," and its `Visible` and `EnableViewState` properties to `false`.</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample5.aspx)]

<span data-ttu-id="b7477-328">每当更新 DetailsView 时，都需要显示 `SettingsUpdatedMessage` 标签。</span><span class="sxs-lookup"><span data-stu-id="b7477-328">We need to display the `SettingsUpdatedMessage` Label whenever the DetailsView is updated.</span></span> <span data-ttu-id="b7477-329">为此，请为 DetailsView 的 `ItemUpdated` 事件创建事件处理程序，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="b7477-329">To accomplish this, create an event handler for the DetailsView's `ItemUpdated` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample6.cs)]

<span data-ttu-id="b7477-330">通过浏览器返回 `AdditionalUserInfo.aspx` 页面并更新数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-330">Return to the `AdditionalUserInfo.aspx` page through a browser and update the data.</span></span> <span data-ttu-id="b7477-331">此时将显示有用的状态消息。</span><span class="sxs-lookup"><span data-stu-id="b7477-331">This time, a helpful status message is displayed.</span></span>

<span data-ttu-id="b7477-332">[更新设置时，会显示一条短消息 ![](storing-additional-user-information-cs/_static/image47.png)](storing-additional-user-information-cs/_static/image46.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-332">[![A Short Message is Displayed When the Settings are Updated](storing-additional-user-information-cs/_static/image47.png)](storing-additional-user-information-cs/_static/image46.png)</span></span>

<span data-ttu-id="b7477-333">**图 16**：更新设置时显示一条短消息（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image48.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-333">**Figure 16**: A Short Message is Displayed When the Settings are Updated  ([Click to view full-size image](storing-additional-user-information-cs/_static/image48.png))</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-334">DetailsView 控件的编辑界面会有很大的需要。</span><span class="sxs-lookup"><span data-stu-id="b7477-334">The DetailsView control's editing interface leaves a lot to be desired.</span></span> <span data-ttu-id="b7477-335">它使用标准大小的文本框，但签名字段可能是一个多行文本框。</span><span class="sxs-lookup"><span data-stu-id="b7477-335">It uses standard-sized textboxes, but the Signature field should probably be a multi-line textbox.</span></span> <span data-ttu-id="b7477-336">应使用 RegularExpressionValidator 来确保主页 URL （如果输入）以 "http://" 或 "https://" 开头。</span><span class="sxs-lookup"><span data-stu-id="b7477-336">A RegularExpressionValidator should be used to ensure that the homepage URL, if entered, starts with "http://" or "https://".</span></span> <span data-ttu-id="b7477-337">此外，由于 DetailsView 控件的 `DefaultMode` 属性设置为 `Edit`，因此 "取消" 按钮不会执行任何操作。</span><span class="sxs-lookup"><span data-stu-id="b7477-337">Moreover, since the DetailsView control has its `DefaultMode` property set to `Edit`, the Cancel button does not do anything.</span></span> <span data-ttu-id="b7477-338">应将其删除，或者单击时，将用户重定向到其他某个页面（如 `~/Default.aspx`）。</span><span class="sxs-lookup"><span data-stu-id="b7477-338">It should either be removed or, when clicked, redirect the user to some other page (such as `~/Default.aspx`).</span></span> <span data-ttu-id="b7477-339">我将这些增强功能留给读者演练。</span><span class="sxs-lookup"><span data-stu-id="b7477-339">I leave these enhancements as an exercise for the reader.</span></span>

### <a name="adding-a-link-to-theadditionaluserinfoaspxpage-in-the-master-page"></a><span data-ttu-id="b7477-340">将链接添加到母版页中的 "`AdditionalUserInfo.aspx`" 页</span><span class="sxs-lookup"><span data-stu-id="b7477-340">Adding a Link to the`AdditionalUserInfo.aspx`Page in the Master Page</span></span>

<span data-ttu-id="b7477-341">目前，该网站不提供任何指向 `AdditionalUserInfo.aspx` 页面的链接。</span><span class="sxs-lookup"><span data-stu-id="b7477-341">Currently, the website does not provide any links to the `AdditionalUserInfo.aspx` page.</span></span> <span data-ttu-id="b7477-342">只需要在浏览器的地址栏中直接输入页面的 URL 即可。</span><span class="sxs-lookup"><span data-stu-id="b7477-342">The only way to reach it is to enter the page's URL directly into the browser's Address bar.</span></span> <span data-ttu-id="b7477-343">让我们在 `Site.master` 母版页中添加指向此页面的链接。</span><span class="sxs-lookup"><span data-stu-id="b7477-343">Let's add a link to this page in the `Site.master` master page.</span></span>

<span data-ttu-id="b7477-344">回忆一下，母版页包含其 `LoginContent` ContentPlaceHolder 中的登录视图 Web 控件，该控件为经过身份验证和匿名访问者显示不同标记。</span><span class="sxs-lookup"><span data-stu-id="b7477-344">Recall that the master page contains a LoginView Web control in its `LoginContent` ContentPlaceHolder that displays different markup for authenticated and anonymous visitors.</span></span> <span data-ttu-id="b7477-345">更新登录视图控件的 `LoggedInTemplate` 以包含指向 `AdditionalUserInfo.aspx` 页面的链接。</span><span class="sxs-lookup"><span data-stu-id="b7477-345">Update the LoginView control's `LoggedInTemplate` to include a link to the `AdditionalUserInfo.aspx` page.</span></span> <span data-ttu-id="b7477-346">进行这些更改后，登录视图控件的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7477-346">After making these changes the LoginView control's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample7.aspx)]

<span data-ttu-id="b7477-347">请注意，向 `LoggedInTemplate`添加 `lnkUpdateSettings` 超链接控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-347">Note the addition of the `lnkUpdateSettings` HyperLink control to the `LoggedInTemplate`.</span></span> <span data-ttu-id="b7477-348">设置此链接后，经过身份验证的用户可以快速跳转到页面，以查看和修改其家庭城镇、主页和签名设置。</span><span class="sxs-lookup"><span data-stu-id="b7477-348">With this link in place, authenticated users can quickly jump to the page to view and modify their home town, homepage, and signature settings.</span></span>

## <a name="step-4-adding-new-guestbook-comments"></a><span data-ttu-id="b7477-349">步骤4：添加新的留言簿评论</span><span class="sxs-lookup"><span data-stu-id="b7477-349">Step 4: Adding New Guestbook Comments</span></span>

<span data-ttu-id="b7477-350">在 "`Guestbook.aspx`" 页中，经过身份验证的用户可以查看留言簿并留下评论。</span><span class="sxs-lookup"><span data-stu-id="b7477-350">The `Guestbook.aspx` page is where authenticated users can view the guestbook and leave a comment.</span></span> <span data-ttu-id="b7477-351">首先，让我们创建一个添加新的留言簿评论的界面。</span><span class="sxs-lookup"><span data-stu-id="b7477-351">Let's start with creating the interface to add new guestbook comments.</span></span>

<span data-ttu-id="b7477-352">在 Visual Studio 中打开 "`Guestbook.aspx`" 页，并构造一个包含两个 TextBox 控件的用户界面，一个用于新注释主题，另一个用于正文。</span><span class="sxs-lookup"><span data-stu-id="b7477-352">Open the `Guestbook.aspx` page in Visual Studio and construct a user interface consisting of two TextBox controls, one for the new comment's subject and one for its body.</span></span> <span data-ttu-id="b7477-353">将第一个 TextBox 控件的 `ID` 属性设置为 `Subject`，其 `Columns` 属性设置为 40;将第二个 `ID` 设置为 `Body`，其 `TextMode` `MultiLine`，并将其 `Width` 和 `Rows` 属性分别设置为 "95%" 和8。</span><span class="sxs-lookup"><span data-stu-id="b7477-353">Set the first TextBox control's `ID` property to `Subject` and its `Columns` property to 40; set second's `ID` to `Body`, its `TextMode` to `MultiLine`, and its `Width` and `Rows` properties to "95%" and 8, respectively.</span></span> <span data-ttu-id="b7477-354">若要完成用户界面，请添加一个名为 `PostCommentButton` 的按钮 Web 控件，并将其 `Text` 属性设置为 "发布评论"。</span><span class="sxs-lookup"><span data-stu-id="b7477-354">To complete the user interface, add a Button Web control named `PostCommentButton` and set its `Text` property to "Post Your Comment".</span></span>

<span data-ttu-id="b7477-355">由于每个留言簿评论都需要主题和正文，因此请为每个文本框添加 RequiredFieldValidator。</span><span class="sxs-lookup"><span data-stu-id="b7477-355">Since each guestbook comment requires a subject and body, add a RequiredFieldValidator for each of the TextBoxes.</span></span> <span data-ttu-id="b7477-356">将这些控件的 `ValidationGroup` 属性设置为 "EnterComment";同样，将 `PostCommentButton` 控件的 `ValidationGroup` 属性设置为 "EnterComment"。</span><span class="sxs-lookup"><span data-stu-id="b7477-356">Set the `ValidationGroup` property of these controls to "EnterComment"; likewise, set the `PostCommentButton` control's `ValidationGroup` property to "EnterComment".</span></span> <span data-ttu-id="b7477-357">有关 ASP 的详细信息。NET 的验证控件，请查看[ASP.NET 中的窗体验证](http://www.4guysfromrolla.com/webtech/090200-1.shtml)，[二级 ASP.NET 2.0 中的验证控件](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)，以及[W3Schools](http://www.w3schools.com/)上的[验证服务器控件教程](http://www.w3schools.com/aspnet/aspnet_refvalidationcontrols.asp)。</span><span class="sxs-lookup"><span data-stu-id="b7477-357">For more information on ASP.NET's validation controls, check out [Form Validation in ASP.NET](http://www.4guysfromrolla.com/webtech/090200-1.shtml), [Dissecting the Validation Controls in ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx), and the [Validation Server Controls Tutorial](http://www.w3schools.com/aspnet/aspnet_refvalidationcontrols.asp) on [W3Schools](http://www.w3schools.com/).</span></span>

<span data-ttu-id="b7477-358">在精心编写用户界面后，页面的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7477-358">After crafting the user interface your page's declarative markup should look something like the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample8.aspx)]

<span data-ttu-id="b7477-359">完成用户界面后，下一任务是在单击 `PostCommentButton` 时，将新记录插入到 `GuestbookComments` 表中。</span><span class="sxs-lookup"><span data-stu-id="b7477-359">With the user interface complete, our next task is to insert a new record into the `GuestbookComments` table when the `PostCommentButton` is clicked.</span></span> <span data-ttu-id="b7477-360">可以通过多种方式完成此操作：我们可以在按钮 `Click` 事件处理程序中编写 ADO.NET 代码;我们可以将 SqlDataSource 控件添加到页面，配置其 `InsertCommand`，然后从 `Click` 事件处理程序调用其 `Insert` 方法;或者，我们可以生成负责插入新的留言簿注释并从 `Click` 事件处理程序调用此功能的中间层。</span><span class="sxs-lookup"><span data-stu-id="b7477-360">This can be accomplished in a number of ways: we can write ADO.NET code in the Button's `Click` event handler; we can add a SqlDataSource control to the page, configure its `InsertCommand`, and then call its `Insert` method from the `Click` event handler; or we could build a middle tier that was responsible for inserting new guestbook comments, and invoke this functionality from the `Click` event handler.</span></span> <span data-ttu-id="b7477-361">由于我们已在步骤3中介绍了如何使用 SqlDataSource，因此请在此处使用 ADO.NET 代码。</span><span class="sxs-lookup"><span data-stu-id="b7477-361">Since we looked at using a SqlDataSource in Step 3, let's use ADO.NET code here.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-362">用于以编程方式访问 Microsoft SQL Server 数据库中的数据的 ADO.NET 类位于 `System.Data.SqlClient` 命名空间中。</span><span class="sxs-lookup"><span data-stu-id="b7477-362">The ADO.NET classes used to programmatically access data from a Microsoft SQL Server database are located in the `System.Data.SqlClient` namespace.</span></span> <span data-ttu-id="b7477-363">可能需要将该命名空间导入页面的代码隐藏类（即 `using System.Data.SqlClient;`）中。</span><span class="sxs-lookup"><span data-stu-id="b7477-363">You may need to import this namespace into your page's code-behind class (i.e., `using System.Data.SqlClient;`).</span></span>

<span data-ttu-id="b7477-364">为 `PostCommentButton`的 `Click` 事件创建事件处理程序并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="b7477-364">Create an event handler for the `PostCommentButton`'s `Click` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample9.cs)]

<span data-ttu-id="b7477-365">`Click` 事件处理程序首先检查用户提供的数据是否有效。</span><span class="sxs-lookup"><span data-stu-id="b7477-365">The `Click` event handler starts by checking that the user-supplied data is valid.</span></span> <span data-ttu-id="b7477-366">如果不是，则在插入记录之前，事件处理程序将退出。</span><span class="sxs-lookup"><span data-stu-id="b7477-366">If it is not, the event handler exits before inserting a record.</span></span> <span data-ttu-id="b7477-367">假设提供的数据有效，将检索当前登录用户的 `UserId` 值并将其存储在 `currentUserId` 本地变量中。</span><span class="sxs-lookup"><span data-stu-id="b7477-367">Assuming the supplied data is valid, the currently logged on user's `UserId` value is retrieved and stored in the `currentUserId` local variable.</span></span> <span data-ttu-id="b7477-368">此值是必需的，因为我们必须在向 `GuestbookComments`中插入记录时提供 `UserId` 值。</span><span class="sxs-lookup"><span data-stu-id="b7477-368">This value is needed because we must supply a `UserId` value when inserting a record into `GuestbookComments`.</span></span>

<span data-ttu-id="b7477-369">之后，将从 `Web.config` 检索 `SecurityTutorials` 数据库的连接字符串，并指定 `INSERT` SQL 语句。</span><span class="sxs-lookup"><span data-stu-id="b7477-369">Following that, the connection string for the `SecurityTutorials` database is retrieved from `Web.config` and the `INSERT` SQL statement is specified.</span></span> <span data-ttu-id="b7477-370">然后创建并打开一个 `SqlConnection` 对象。</span><span class="sxs-lookup"><span data-stu-id="b7477-370">A `SqlConnection` object is then created and opened.</span></span> <span data-ttu-id="b7477-371">接下来，将构造一个 `SqlCommand` 对象，并为 `INSERT` 查询中使用的参数指定值。</span><span class="sxs-lookup"><span data-stu-id="b7477-371">Next, a `SqlCommand` object is constructed and the values for the parameters used in the `INSERT` query are assigned.</span></span> <span data-ttu-id="b7477-372">然后执行 `INSERT` 语句，并关闭连接。</span><span class="sxs-lookup"><span data-stu-id="b7477-372">The `INSERT` statement is then executed and the connection closed.</span></span> <span data-ttu-id="b7477-373">在事件处理程序结束时，将清除 "`Subject`" 和 "`Body`" 文本框的 `Text` 属性，以便不会在回发期间保留用户的值。</span><span class="sxs-lookup"><span data-stu-id="b7477-373">At the end of the event handler, the `Subject` and `Body` TextBoxes' `Text` properties are cleared out so that the user's values are not persisted across the postback.</span></span>

<span data-ttu-id="b7477-374">继续在浏览器中测试此页。</span><span class="sxs-lookup"><span data-stu-id="b7477-374">Go ahead and test out this page in a browser.</span></span> <span data-ttu-id="b7477-375">由于此页面位于 `Membership` 文件夹中，匿名访问者无法访问该文件夹。</span><span class="sxs-lookup"><span data-stu-id="b7477-375">Since this page is in the `Membership` folder it is not accessible to anonymous visitors.</span></span> <span data-ttu-id="b7477-376">因此，你需要先登录（如果尚未这样做）。</span><span class="sxs-lookup"><span data-stu-id="b7477-376">Therefore, you will need to first log on (if you have not already).</span></span> <span data-ttu-id="b7477-377">在 "`Subject`" 和 "`Body`" 文本框中输入一个值，然后单击 "`PostCommentButton`" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b7477-377">Enter a value into the `Subject` and `Body` TextBoxes and click the `PostCommentButton` button.</span></span> <span data-ttu-id="b7477-378">这会导致将新记录添加到 `GuestbookComments`。</span><span class="sxs-lookup"><span data-stu-id="b7477-378">This will cause a new record to be added to `GuestbookComments`.</span></span> <span data-ttu-id="b7477-379">在回发时，会从文本框中擦除提供的主题和正文。</span><span class="sxs-lookup"><span data-stu-id="b7477-379">On postback, the subject and body you provided are wiped from the TextBoxes.</span></span>

<span data-ttu-id="b7477-380">单击 "`PostCommentButton`" 按钮后，就不会向留言簿添加注释。</span><span class="sxs-lookup"><span data-stu-id="b7477-380">After clicking the `PostCommentButton` button there is no visual feedback that the comment was added to the guestbook.</span></span> <span data-ttu-id="b7477-381">我们仍需要更新此页以显示现有的留言簿评论，我们将在步骤5中执行此操作。</span><span class="sxs-lookup"><span data-stu-id="b7477-381">We still need to update this page to display the existing guestbook comments, which we will do in Step 5.</span></span> <span data-ttu-id="b7477-382">完成此项后，只需注释即可显示在注释列表中，提供足够的视觉反馈。</span><span class="sxs-lookup"><span data-stu-id="b7477-382">Once we accomplish that, the just-added comment will appear in the list of comments, providing adequate visual feedback.</span></span> <span data-ttu-id="b7477-383">现在，请通过检查 `GuestbookComments` 表的内容来确认是否已保存留言簿注释。</span><span class="sxs-lookup"><span data-stu-id="b7477-383">For now, confirm that your guestbook comment was saved by examining the contents of the `GuestbookComments` table.</span></span>

<span data-ttu-id="b7477-384">图17显示了两个注释后，`GuestbookComments` 表的内容。</span><span class="sxs-lookup"><span data-stu-id="b7477-384">Figure 17 shows the contents of the `GuestbookComments` table after two comments have been left.</span></span>

<span data-ttu-id="b7477-385">[![你可以在 GuestbookComments 表中查看留言簿注释](storing-additional-user-information-cs/_static/image50.png)](storing-additional-user-information-cs/_static/image49.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-385">[![You Can See the Guestbook Comments in the GuestbookComments Table](storing-additional-user-information-cs/_static/image50.png)](storing-additional-user-information-cs/_static/image49.png)</span></span>

<span data-ttu-id="b7477-386">**图 17**：你可以在 `GuestbookComments` 表中查看留言簿注释（[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image51.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-386">**Figure 17**: You Can See the Guestbook Comments in the `GuestbookComments` Table  ([Click to view full-size image](storing-additional-user-information-cs/_static/image51.png))</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-387">如果用户尝试插入包含潜在危险标记的留言簿注释（如 HTML – ASP.NET 将引发 `HttpRequestValidationException`。</span><span class="sxs-lookup"><span data-stu-id="b7477-387">If a user attempts to insert a guestbook comment that contains potentially dangerous markup – such as HTML – ASP.NET will throw an `HttpRequestValidationException`.</span></span> <span data-ttu-id="b7477-388">若要了解有关此异常的详细信息、引发原因以及如何允许用户提交潜在的危险值，请参阅[请求验证白皮书](../../../../whitepapers/request-validation.md)。</span><span class="sxs-lookup"><span data-stu-id="b7477-388">To learn more about this exception, why it's thrown, and how to permit users to submit potentially dangerous values, consult the [Request Validation Whitepaper](../../../../whitepapers/request-validation.md).</span></span>

## <a name="step-5-listing-the-existing-guestbook-comments"></a><span data-ttu-id="b7477-389">步骤5：列出现有留言簿评论</span><span class="sxs-lookup"><span data-stu-id="b7477-389">Step 5: Listing the Existing Guestbook Comments</span></span>

<span data-ttu-id="b7477-390">除了留下注释外，访问 `Guestbook.aspx` 页面的用户还应能够查看留言簿的现有评论。</span><span class="sxs-lookup"><span data-stu-id="b7477-390">In addition to leaving comments, a user visiting the `Guestbook.aspx` page should also be able to view the guestbook's existing comments.</span></span> <span data-ttu-id="b7477-391">若要实现此目的，请将名为 `CommentList` 的 ListView 控件添加到页面底部。</span><span class="sxs-lookup"><span data-stu-id="b7477-391">To accomplish this, add a ListView control named `CommentList` to the bottom of the page.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-392">ListView 控件是 ASP.NET 版本3.5 的新控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-392">The ListView control is new to ASP.NET version 3.5.</span></span> <span data-ttu-id="b7477-393">它旨在以非常可自定义且灵活的布局显示项列表，但仍提供内置的编辑、插入、删除、分页和排序功能，如 GridView。</span><span class="sxs-lookup"><span data-stu-id="b7477-393">It is designed to display a list of items in a very customizable and flexible layout, yet still offer built-in editing, inserting, deleting, paging, and sorting functionality like the GridView.</span></span> <span data-ttu-id="b7477-394">如果使用的是 ASP.NET 2.0，则需改为使用 DataList 或 Repeater 控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-394">If you are using ASP.NET 2.0, you will need to use the DataList or Repeater control instead.</span></span> <span data-ttu-id="b7477-395">有关使用 ListView 的详细信息，请参阅[Scott Guthrie](https://weblogs.asp.net/scottgu/)的博客文章[： listview 控件](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)和我的文章，[使用 ListView 控件显示数据](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-395">For more information on using the ListView, see [Scott Guthrie](https://weblogs.asp.net/scottgu/)'s blog entry, [The asp:ListView Control](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx), and my article, [Displaying Data with the ListView Control](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx).</span></span>

<span data-ttu-id="b7477-396">打开 ListView 的智能标记，然后从 "选择数据源" 下拉列表中将控件绑定到新的数据源。</span><span class="sxs-lookup"><span data-stu-id="b7477-396">Open the ListView's Smart Tag and, from the Choose Data Source drop-down list, bind the control to a new data source.</span></span> <span data-ttu-id="b7477-397">正如我们在步骤2中看到的那样，这将启动 "数据源配置向导"。</span><span class="sxs-lookup"><span data-stu-id="b7477-397">As we saw in Step 2, this will launch the Data Source Configuration Wizard.</span></span> <span data-ttu-id="b7477-398">选择数据库图标，将生成的 `CommentsDataSource`SqlDataSource 命名为，然后单击 "确定"。</span><span class="sxs-lookup"><span data-stu-id="b7477-398">Select the Database icon, name the resulting SqlDataSource `CommentsDataSource`, and click OK.</span></span> <span data-ttu-id="b7477-399">接下来，从下拉列表中选择 `SecurityTutorialsConnectionString` 连接字符串，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="b7477-399">Next, select the `SecurityTutorialsConnectionString` connection string from the drop-down list and click Next.</span></span>

<span data-ttu-id="b7477-400">在步骤2的这一步中，我们通过从下拉列表中选择 `UserProfiles` 表并选择要返回的列来指定要查询的数据（参见图9）。</span><span class="sxs-lookup"><span data-stu-id="b7477-400">At this point in Step 2 we specified the data to query by picking the `UserProfiles` table from the drop-down list and selecting the columns to return (refer back to Figure 9).</span></span> <span data-ttu-id="b7477-401">但这一次，我们想要创建一个 SQL 语句，该语句不仅提取来自 `GuestbookComments`的记录，还会提取注释者的 home、home、签名和用户名。</span><span class="sxs-lookup"><span data-stu-id="b7477-401">This time, however, we want to craft a SQL statement that pulls back not only the records from `GuestbookComments`, but also the commenter's home town, homepage, signature, and username.</span></span> <span data-ttu-id="b7477-402">因此，请选择 "指定自定义 SQL 语句或存储过程" 单选按钮，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="b7477-402">Therefore, select the "Specify a custom SQL statement or stored procedure" radio button and click Next.</span></span>

<span data-ttu-id="b7477-403">这将显示 "定义自定义语句或存储过程" 屏幕。</span><span class="sxs-lookup"><span data-stu-id="b7477-403">This will bring up the "Define Custom Statements or Stored Procedures" screen.</span></span> <span data-ttu-id="b7477-404">单击 "查询生成器" 按钮以图形方式生成查询。</span><span class="sxs-lookup"><span data-stu-id="b7477-404">Click the Query Builder button to graphically build the query.</span></span> <span data-ttu-id="b7477-405">查询生成器首先提示我们指定要查询的表。</span><span class="sxs-lookup"><span data-stu-id="b7477-405">The Query Builder starts by prompting us to specify the tables we want to query from.</span></span> <span data-ttu-id="b7477-406">选择 `GuestbookComments`、`UserProfiles`和 `aspnet_Users` 表，然后单击 "确定"。</span><span class="sxs-lookup"><span data-stu-id="b7477-406">Select the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` tables and click OK.</span></span> <span data-ttu-id="b7477-407">这会将所有三个表添加到设计图面。</span><span class="sxs-lookup"><span data-stu-id="b7477-407">This will add all three tables to the design surface.</span></span> <span data-ttu-id="b7477-408">由于 `GuestbookComments`、`UserProfiles`和 `aspnet_Users` 表之间存在外键约束，因此查询生成器会自动 `JOIN` 这些表。</span><span class="sxs-lookup"><span data-stu-id="b7477-408">Since there are foreign key constraints amongst the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` tables, the Query Builder automatically `JOIN` s these tables.</span></span>

<span data-ttu-id="b7477-409">剩下的就是指定要返回的列。</span><span class="sxs-lookup"><span data-stu-id="b7477-409">All that remains is to specify the columns to return.</span></span> <span data-ttu-id="b7477-410">从 "`GuestbookComments`" 表中，选择 "`Subject`"、"`Body`" 和 "`CommentDate`" 列;从 `UserProfiles` 表中返回 `HomeTown`、`HomepageUrl`和 `Signature` 列;并从 `aspnet_Users`返回 `UserName`。</span><span class="sxs-lookup"><span data-stu-id="b7477-410">From the `GuestbookComments` table select the `Subject`, `Body`, and `CommentDate` columns; return the `HomeTown`, `HomepageUrl`, and `Signature` columns from the `UserProfiles` table; and return `UserName` from `aspnet_Users`.</span></span> <span data-ttu-id="b7477-411">此外，将 "`ORDER BY CommentDate DESC`" 添加到 `SELECT` 查询的末尾，以便先返回最新的帖子。</span><span class="sxs-lookup"><span data-stu-id="b7477-411">Also, add "`ORDER BY CommentDate DESC`" to the end of the `SELECT` query so that the most recent posts are returned first.</span></span> <span data-ttu-id="b7477-412">进行这些选择后，查询生成器界面应类似于图18中的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="b7477-412">After making these selections, your Query Builder interface should look similar to the screen shot in Figure 18.</span></span>

<span data-ttu-id="b7477-413">[![构造的查询联接了 GuestbookComments、UserProfiles 和 aspnet_Users 表](storing-additional-user-information-cs/_static/image53.png)](storing-additional-user-information-cs/_static/image52.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-413">[![The Constructed Query JOINs the GuestbookComments, UserProfiles, and aspnet_Users Tables](storing-additional-user-information-cs/_static/image53.png)](storing-additional-user-information-cs/_static/image52.png)</span></span>

<span data-ttu-id="b7477-414">**图 18**：构造的查询 `JOIN` `GuestbookComments`、`UserProfiles`和 `aspnet_Users` 表（[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image54.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-414">**Figure 18**: The Constructed Query `JOIN` s the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` Tables  ([Click to view full-size image](storing-additional-user-information-cs/_static/image54.png))</span></span>

<span data-ttu-id="b7477-415">单击 "确定" 以关闭查询生成器窗口，并返回到 "定义自定义语句或存储过程" 屏幕。</span><span class="sxs-lookup"><span data-stu-id="b7477-415">Click OK to close the Query Builder window and return to the "Define Custom Statements or Stored Procedures" screen.</span></span> <span data-ttu-id="b7477-416">单击 "下一步" 以转到 "测试查询" 屏幕，你可以通过单击 "测试查询" 按钮查看查询结果。</span><span class="sxs-lookup"><span data-stu-id="b7477-416">Click Next to advance to the "Test Query" screen, where you may view the query results by clicking the Test Query button.</span></span> <span data-ttu-id="b7477-417">准备就绪后，单击 "完成" 以完成 "配置数据源" 向导。</span><span class="sxs-lookup"><span data-stu-id="b7477-417">When you're ready, click Finish to complete the Configure Data Source wizard.</span></span>

<span data-ttu-id="b7477-418">完成步骤2中的 "配置数据源" 向导时，会更新关联的 DetailsView 控件的 `Fields` 集合，使其包含 `SelectCommand`返回的每个列的 BoundField。</span><span class="sxs-lookup"><span data-stu-id="b7477-418">When we completed the Configure Data Source wizard in Step 2, the associated DetailsView control's `Fields` collection was updated to include a BoundField for each column returned by the `SelectCommand`.</span></span> <span data-ttu-id="b7477-419">但 ListView 仍保持不变;我们仍需要定义其布局。</span><span class="sxs-lookup"><span data-stu-id="b7477-419">The ListView, however, remains unchanged; we still need to define its layout.</span></span> <span data-ttu-id="b7477-420">ListView 的布局可以通过其声明性标记或其智能标记中的 "配置 ListView" 选项手动构造。</span><span class="sxs-lookup"><span data-stu-id="b7477-420">The ListView's layout can be constructed manually through its declarative markup or from the "Configure ListView" option in its Smart Tag.</span></span> <span data-ttu-id="b7477-421">我通常更喜欢手动定义标记，但使用最适合您的任何方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-421">I usually prefer defining the markup by hand, but use whatever method is most natural to you.</span></span>

<span data-ttu-id="b7477-422">对于我的 ListView 控件，我最终使用了以下 `LayoutTemplate`、`ItemTemplate`和 `ItemSeparatorTemplate`：</span><span class="sxs-lookup"><span data-stu-id="b7477-422">I ended up using the following `LayoutTemplate`, `ItemTemplate`, and `ItemSeparatorTemplate` for my ListView control:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample10.aspx)]

<span data-ttu-id="b7477-423">`LayoutTemplate` 定义控件发出的标记，而 `ItemTemplate` 呈现 SqlDataSource 返回的每个项。</span><span class="sxs-lookup"><span data-stu-id="b7477-423">The `LayoutTemplate` defines the markup emitted by the control, while the `ItemTemplate` renders each item returned by the SqlDataSource.</span></span> <span data-ttu-id="b7477-424">`ItemTemplate`的结果标记放置在 `LayoutTemplate`的 `itemPlaceholder` 控件中。</span><span class="sxs-lookup"><span data-stu-id="b7477-424">The `ItemTemplate`'s resulting markup is placed in the `LayoutTemplate`'s `itemPlaceholder` control.</span></span> <span data-ttu-id="b7477-425">除了 `itemPlaceholder`之外，`LayoutTemplate` 还包括一个 DataPager 控件，该控件限制 ListView 只显示每个页面10个留言簿评论（默认值），并呈现分页接口。</span><span class="sxs-lookup"><span data-stu-id="b7477-425">In addition to the `itemPlaceholder`, the `LayoutTemplate` includes a DataPager control, which limits the ListView to showing just 10 guestbook comments per page (the default) and renders a paging interface.</span></span>

<span data-ttu-id="b7477-426">我的 `ItemTemplate` 会在 `<h4>` 元素中显示每个留言簿评论的主题，正文位于该主题下。</span><span class="sxs-lookup"><span data-stu-id="b7477-426">My `ItemTemplate` displays each guestbook comment's subject in an `<h4>` element with the body situated below the subject.</span></span> <span data-ttu-id="b7477-427">请注意，用于显示正文的语法采用 `Eval("Body")` databinding 语句返回的数据，将其转换为字符串，并将换行符替换为 `<br />` 元素。</span><span class="sxs-lookup"><span data-stu-id="b7477-427">Note that syntax used for displaying the body takes the data returned by the `Eval("Body")` databinding statement, converts it to a string, and replaces line breaks with the `<br />` element.</span></span> <span data-ttu-id="b7477-428">需要进行此转换，以便在提交注释时显示所输入的换行符，因为 HTML 将忽略空格。</span><span class="sxs-lookup"><span data-stu-id="b7477-428">This conversion is needed in order to show the line breaks entered when submitting the comment since whitespace is ignored by HTML.</span></span> <span data-ttu-id="b7477-429">用户的签名显示在正文的下方，以斜体显示，后跟用户的主城市、指向其主页的链接、注释的日期和时间，以及离开评论的人员的用户名。</span><span class="sxs-lookup"><span data-stu-id="b7477-429">The user's signature is displayed beneath the body in italics, followed by the user's home town, a link to his homepage, the date and time the comment was made, and the username of the person who left the comment.</span></span>

<span data-ttu-id="b7477-430">花点时间查看浏览器中的页面。</span><span class="sxs-lookup"><span data-stu-id="b7477-430">Take a moment to view the page through a browser.</span></span> <span data-ttu-id="b7477-431">应该会看到你在此处显示的步骤5中已添加到留言簿的注释。</span><span class="sxs-lookup"><span data-stu-id="b7477-431">You should see the comments that you added to the guestbook in Step 5 displayed here.</span></span>

<span data-ttu-id="b7477-432">[![留言簿现在显示留言簿的评论](storing-additional-user-information-cs/_static/image56.png)](storing-additional-user-information-cs/_static/image55.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-432">[![Guestbook.aspx Now Displays the Guestbook's Comments](storing-additional-user-information-cs/_static/image56.png)](storing-additional-user-information-cs/_static/image55.png)</span></span>

<span data-ttu-id="b7477-433">**图 19**： `Guestbook.aspx` 现在显示留言簿的注释（[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image57.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-433">**Figure 19**: `Guestbook.aspx` Now Displays the Guestbook's Comments  ([Click to view full-size image](storing-additional-user-information-cs/_static/image57.png))</span></span>

<span data-ttu-id="b7477-434">尝试向留言簿添加新评论。</span><span class="sxs-lookup"><span data-stu-id="b7477-434">Try adding a new comment to the guestbook.</span></span> <span data-ttu-id="b7477-435">单击 "`PostCommentButton`" 按钮将回发页面，并将注释添加到数据库中，但不会更新 ListView 控件以显示新注释。</span><span class="sxs-lookup"><span data-stu-id="b7477-435">Upon clicking the `PostCommentButton` button the page posts back and the comment is added to the database, but the ListView control is not updated to show the new comment.</span></span> <span data-ttu-id="b7477-436">这可以通过以下方法之一来解决：</span><span class="sxs-lookup"><span data-stu-id="b7477-436">This can be fixed by either:</span></span>

- <span data-ttu-id="b7477-437">更新 `PostCommentButton` 按钮 `Click` 事件处理程序，以便在将新注释插入数据库后调用 ListView 控件的 `DataBind()` 方法，或</span><span class="sxs-lookup"><span data-stu-id="b7477-437">Updating the `PostCommentButton` button's `Click` event handler so that it invokes the ListView control's `DataBind()` method after inserting the new comment into the database, or</span></span>
- <span data-ttu-id="b7477-438">将 ListView 控件的 `EnableViewState` 属性设置为 `false`。</span><span class="sxs-lookup"><span data-stu-id="b7477-438">Setting the ListView control's `EnableViewState` property to `false`.</span></span> <span data-ttu-id="b7477-439">此方法的工作方式是，通过禁用控件的视图状态，它必须在每次回发时重新绑定到基础数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-439">This approach works because by disabling the control's view state, it must rebind to the underlying data on every postback.</span></span>

<span data-ttu-id="b7477-440">本教程中的可下载的教程网站演示了这两种方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-440">The tutorial website downloadable from this tutorial illustrates both techniques.</span></span> <span data-ttu-id="b7477-441">要 `false` 的 ListView 控件的 `EnableViewState` 属性以及以编程方式将数据重新绑定到 ListView 所需的代码存在于 `Click` 事件处理程序中，但已被注释掉。</span><span class="sxs-lookup"><span data-stu-id="b7477-441">The ListView control's `EnableViewState` property to `false` and the code needed to programmatically rebind the data to the ListView is present in the `Click` event handler, but is commented out.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-442">目前，"`AdditionalUserInfo.aspx`" 页允许用户查看和编辑其主城市、主页和签名设置。</span><span class="sxs-lookup"><span data-stu-id="b7477-442">Currently the `AdditionalUserInfo.aspx` page allows the user to view and edit their home town, homepage, and signature settings.</span></span> <span data-ttu-id="b7477-443">更新 `AdditionalUserInfo.aspx` 以显示已登录用户的留言簿注释可能很好。</span><span class="sxs-lookup"><span data-stu-id="b7477-443">It might be nice to update `AdditionalUserInfo.aspx` to display the logged in user's guestbook comments.</span></span> <span data-ttu-id="b7477-444">也就是说，除了检查和修改信息，用户还可以访问 "`AdditionalUserInfo.aspx`" 页面，查看她在过去做出了哪些留言簿评论。</span><span class="sxs-lookup"><span data-stu-id="b7477-444">That is, in addition to examining and modifying her information, a user can visit the `AdditionalUserInfo.aspx` page to see what guestbook comments she's made in the past.</span></span> <span data-ttu-id="b7477-445">对于感兴趣的读者来说，我将其作为练习。</span><span class="sxs-lookup"><span data-stu-id="b7477-445">I leave this as an exercise for the interested reader.</span></span>

## <a name="step-6-customizing-the-createuserwizard-control-to-include-an-interface-for-the-home-town-homepage-and-signature"></a><span data-ttu-id="b7477-446">步骤6：自定义 CreateUserWizard 控件，使其包含家庭城镇、主页和签名的接口</span><span class="sxs-lookup"><span data-stu-id="b7477-446">Step 6: Customizing the CreateUserWizard Control to Include an Interface for the Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="b7477-447">`Guestbook.aspx` 页使用的 `SELECT` 查询使用 `INNER JOIN` 来合并 `GuestbookComments`、`UserProfiles`和 `aspnet_Users` 表中的相关记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-447">The `SELECT` query used by the `Guestbook.aspx` page uses an `INNER JOIN` to combine the related records amongst the `GuestbookComments`, `UserProfiles`, and `aspnet_Users` tables.</span></span> <span data-ttu-id="b7477-448">如果在 `UserProfiles` 中没有记录的用户发出留言簿注释，则注释将不会显示在 ListView 中，因为 `INNER JOIN` 仅当存在匹配的 `UserProfiles` 和 `aspnet_Users`中的记录时，才会返回 `GuestbookComments` 记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-448">If a user that has no record in `UserProfiles` makes a guestbook comment, the comment won't be displayed in the ListView because the `INNER JOIN` only returns `GuestbookComments` records when there are matching records in `UserProfiles` and `aspnet_Users`.</span></span> <span data-ttu-id="b7477-449">如步骤3中所示，如果用户在中没有记录 `UserProfiles` 她无法在 `AdditionalUserInfo.aspx` 页中查看或编辑她的设置。</span><span class="sxs-lookup"><span data-stu-id="b7477-449">And as we saw in Step 3, if a user does not have a record in `UserProfiles` she cannot view or edit her settings in the `AdditionalUserInfo.aspx` page.</span></span>

<span data-ttu-id="b7477-450">不用说，由于我们的设计决策，成员资格系统中的每个用户帐户在 `UserProfiles` 表中都有匹配的记录，这一点很重要。</span><span class="sxs-lookup"><span data-stu-id="b7477-450">Needless to say, due to our design decisions it is important that every user account in the Membership system have a matching record in the `UserProfiles` table.</span></span> <span data-ttu-id="b7477-451">我们想要在每次通过 CreateUserWizard 创建新的成员资格用户帐户时，将相应的记录添加到 `UserProfiles`。</span><span class="sxs-lookup"><span data-stu-id="b7477-451">What we want is for a corresponding record to be added to `UserProfiles` whenever a new Membership user account is created through the CreateUserWizard.</span></span>

<span data-ttu-id="b7477-452">如创建[*用户帐户*](creating-user-accounts-cs.md)教程中所述，在创建新的成员资格用户帐户后，CreateUserWizard 控件会引发其[`CreatedUser` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-452">As discussed in the [*Creating User Accounts*](creating-user-accounts-cs.md) tutorial, after the new Membership user account is created the CreateUserWizard control raises its [`CreatedUser` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx).</span></span> <span data-ttu-id="b7477-453">我们可以为此事件创建事件处理程序，获取刚刚创建的用户的 UserId，然后使用 `HomeTown`、`HomepageUrl`和 `Signature` 列的默认值将记录插入到 `UserProfiles` 表中。</span><span class="sxs-lookup"><span data-stu-id="b7477-453">We can create an event handler for this event, get the UserId for the just-created user, and then insert a record into the `UserProfiles` table with default values for the `HomeTown`, `HomepageUrl`, and `Signature` columns.</span></span> <span data-ttu-id="b7477-454">另外，还可以通过自定义 CreateUserWizard 控件的界面以包括其他文本框来提示用户输入这些值。</span><span class="sxs-lookup"><span data-stu-id="b7477-454">What's more, it is possible to prompt the user for these values by customizing the CreateUserWizard control's interface to include additional TextBoxes.</span></span>

<span data-ttu-id="b7477-455">首先，让我们看看如何使用默认值向 `CreatedUser` 事件处理程序中的 `UserProfiles` 表中添加新行。</span><span class="sxs-lookup"><span data-stu-id="b7477-455">Let's first look at how to add a new row to the `UserProfiles` table in the `CreatedUser` event handler with default values.</span></span> <span data-ttu-id="b7477-456">接下来，我们将了解如何自定义 CreateUserWizard 控件的用户界面，以包含其他窗体字段以收集新用户的 "住宅"、"主页" 和 "签名"。</span><span class="sxs-lookup"><span data-stu-id="b7477-456">Following that, we will see how to customize the CreateUserWizard control's user interface to include additional form fields to collect the new user's home town, homepage, and signature.</span></span>

### <a name="adding-a-default-row-touserprofiles"></a><span data-ttu-id="b7477-457">向`UserProfiles` 添加默认行</span><span class="sxs-lookup"><span data-stu-id="b7477-457">Adding a Default Row to`UserProfiles`</span></span>

<span data-ttu-id="b7477-458">在[*创建用户帐户*](creating-user-accounts-cs.md)教程中，我们向 `Membership` 文件夹中的 `CreatingUserAccounts.aspx` 页添加了 CreateUserWizard 控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-458">In the [*Creating User Accounts*](creating-user-accounts-cs.md) tutorial we added a CreateUserWizard control to the `CreatingUserAccounts.aspx` page in the `Membership` folder.</span></span> <span data-ttu-id="b7477-459">为了使 CreateUserWizard 控件在创建用户帐户时向 `UserProfiles` 表添加一条记录，我们需要更新 CreateUserWizard 控件的功能。</span><span class="sxs-lookup"><span data-stu-id="b7477-459">In order to have the CreateUserWizard control add a record to `UserProfiles` table upon user account creation, we need to update the CreateUserWizard control's functionality.</span></span> <span data-ttu-id="b7477-460">我们改为将新的 CreateUserWizard 控件添加到 `EnhancedCreateUserWizard.aspx` 页面，并在其中进行本教程的修改，而不是对 `CreatingUserAccounts.aspx` 页面进行这些更改。</span><span class="sxs-lookup"><span data-stu-id="b7477-460">Rather than making these changes to the `CreatingUserAccounts.aspx` page, let's instead add a new CreateUserWizard control to `EnhancedCreateUserWizard.aspx` page and make the modifications for this tutorial there.</span></span>

<span data-ttu-id="b7477-461">在 Visual Studio 中打开 `EnhancedCreateUserWizard.aspx` 页面，并将 "CreateUserWizard" 控件从 "工具箱" 拖到页面上。</span><span class="sxs-lookup"><span data-stu-id="b7477-461">Open the `EnhancedCreateUserWizard.aspx` page in Visual Studio and drag a CreateUserWizard control from the Toolbox onto the page.</span></span> <span data-ttu-id="b7477-462">将 CreateUserWizard 控件的 `ID` 属性设置为 `NewUserWizard`。</span><span class="sxs-lookup"><span data-stu-id="b7477-462">Set the CreateUserWizard control's `ID` property to `NewUserWizard`.</span></span> <span data-ttu-id="b7477-463">如我们在<a id="_msoanchor_5"> </a>[*创建用户帐户*](creating-user-accounts-cs.md)教程中所述，CreateUserWizard 的默认用户界面将提示访问者提供所需的信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-463">As we discussed in the <a id="_msoanchor_5"></a>[*Creating User Accounts*](creating-user-accounts-cs.md) tutorial, the CreateUserWizard's default user interface prompts the visitor for the necessary information.</span></span> <span data-ttu-id="b7477-464">提供此信息后，控件将在成员身份框架中创建新的用户帐户，所有这些都无需编写一行代码即可。</span><span class="sxs-lookup"><span data-stu-id="b7477-464">Once this information has been supplied, the control internally creates a new user account in the Membership framework, all without us having to write a single line of code.</span></span>

<span data-ttu-id="b7477-465">CreateUserWizard 控件在其工作流中引发了许多事件。</span><span class="sxs-lookup"><span data-stu-id="b7477-465">The CreateUserWizard control raises a number of events during its workflow.</span></span> <span data-ttu-id="b7477-466">在访问者提供请求信息并提交窗体后，CreateUserWizard 控件最初会激发其[`CreatingUser` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-466">After a visitor supplies the request information and submits the form, the CreateUserWizard control initially fires its [`CreatingUser` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx).</span></span> <span data-ttu-id="b7477-467">如果在创建过程中出现问题，则激发[`CreateUserError` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx);但是，如果已成功创建用户，则会引发[`CreatedUser` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-467">If there is a problem during the create process, the [`CreateUserError` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx) is fired; however, if the user is successfully created, then the [`CreatedUser` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx) is raised.</span></span> <span data-ttu-id="b7477-468"><a id="_msoanchor_6"></a>在[*创建用户帐户*](creating-user-accounts-cs.md)教程中，我们为 `CreatingUser` 事件创建了一个事件处理程序，以确保所提供的用户名不包含任何前导空格或尾随空格，并且该用户名未出现在密码中的任何位置。</span><span class="sxs-lookup"><span data-stu-id="b7477-468">In the <a id="_msoanchor_6"></a>[*Creating User Accounts*](creating-user-accounts-cs.md) tutorial we created an event handler for the `CreatingUser` event to ensure that the supplied username did not contain any leading or trailing spaces, and that the username did not appear anywhere in the password.</span></span>

<span data-ttu-id="b7477-469">若要为刚创建的用户添加 `UserProfiles` 表中的行，则需要为 `CreatedUser` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="b7477-469">In order to add a row in the `UserProfiles` table for the just-created user, we need to create an event handler for the `CreatedUser` event.</span></span> <span data-ttu-id="b7477-470">当 `CreatedUser` 事件激发时，已在成员身份框架中创建用户帐户，从而使我们能够检索帐户的 UserId 值。</span><span class="sxs-lookup"><span data-stu-id="b7477-470">By the time the `CreatedUser` event has fired, the user account has already been created in the Membership framework, enabling us to retrieve the account's UserId value.</span></span>

<span data-ttu-id="b7477-471">为 `NewUserWizard`的 `CreatedUser` 事件创建事件处理程序并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="b7477-471">Create an event handler for the `NewUserWizard`'s `CreatedUser` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample11.cs)]

<span data-ttu-id="b7477-472">上述代码将检索刚刚添加的用户帐户的 UserId。</span><span class="sxs-lookup"><span data-stu-id="b7477-472">The above code beings by retrieving the UserId of the just-added user account.</span></span> <span data-ttu-id="b7477-473">这是通过使用 `Membership.GetUser(username)` 方法返回特定用户的信息，然后使用 `ProviderUserKey` 属性检索其 UserId 来实现的。</span><span class="sxs-lookup"><span data-stu-id="b7477-473">This is accomplished by using the `Membership.GetUser(username)` method to return information about a particular user, and then using the `ProviderUserKey` property to retrieve their UserId.</span></span> <span data-ttu-id="b7477-474">用户在 CreateUserWizard 控件中输入的用户名通过其[`UserName` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx)提供。</span><span class="sxs-lookup"><span data-stu-id="b7477-474">The username entered by the user in the CreateUserWizard control is available via its [`UserName` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx).</span></span>

<span data-ttu-id="b7477-475">接下来，从 `Web.config` 检索连接字符串，并指定 `INSERT` 语句。</span><span class="sxs-lookup"><span data-stu-id="b7477-475">Next, the connection string is retrieved from `Web.config` and the `INSERT` statement is specified.</span></span> <span data-ttu-id="b7477-476">必要的 ADO.NET 对象将实例化并执行命令。</span><span class="sxs-lookup"><span data-stu-id="b7477-476">The necessary ADO.NET objects are instantiated and the command executed.</span></span> <span data-ttu-id="b7477-477">该代码将[`DBNull`](https://msdn.microsoft.com/library/system.dbnull.aspx)实例分配给 `@HomeTown`、`@HomepageUrl`和 `@Signature` 参数，这会对 `NULL`、`HomeTown`和 `HomepageUrl`字段插入数据库 `Signature` 值的影响。</span><span class="sxs-lookup"><span data-stu-id="b7477-477">The code assigns a [`DBNull`](https://msdn.microsoft.com/library/system.dbnull.aspx) instance to the `@HomeTown`, `@HomepageUrl`, and `@Signature` parameters, which has the effect of inserting database `NULL` values for the `HomeTown`, `HomepageUrl`, and `Signature` fields.</span></span>

<span data-ttu-id="b7477-478">通过浏览器访问 `EnhancedCreateUserWizard.aspx` 页面，然后创建新的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="b7477-478">Visit the `EnhancedCreateUserWizard.aspx` page through a browser and create a new user account.</span></span> <span data-ttu-id="b7477-479">完成此操作后，返回到 Visual Studio 并检查 `aspnet_Users` 和 `UserProfiles` 表的内容（如图12所示）。</span><span class="sxs-lookup"><span data-stu-id="b7477-479">After doing so, return to Visual Studio and examine the contents of the `aspnet_Users` and `UserProfiles` tables (like we did back in Figure 12).</span></span> <span data-ttu-id="b7477-480">你应该会在 `aspnet_Users` 中看到新用户帐户，并在相应的 `UserProfiles` 行中看到 `NULL` 值 `HomeTown`、`HomepageUrl`和 `Signature`。</span><span class="sxs-lookup"><span data-stu-id="b7477-480">You should see the new user account in `aspnet_Users` and a corresponding `UserProfiles` row (with `NULL` values for `HomeTown`, `HomepageUrl`, and `Signature`).</span></span>

<span data-ttu-id="b7477-481">[已添加新用户帐户和 UserProfiles 记录 ![](storing-additional-user-information-cs/_static/image59.png)](storing-additional-user-information-cs/_static/image58.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-481">[![A New User Account and UserProfiles Record Have Been Added](storing-additional-user-information-cs/_static/image59.png)](storing-additional-user-information-cs/_static/image58.png)</span></span>

<span data-ttu-id="b7477-482">**图 20**：添加了新的用户帐户和 `UserProfiles` 记录（[单击查看完全大小的映像](storing-additional-user-information-cs/_static/image60.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-482">**Figure 20**: A New User Account and `UserProfiles` Record Have Been Added  ([Click to view full-size image](storing-additional-user-information-cs/_static/image60.png))</span></span>

<span data-ttu-id="b7477-483">在访问者提供了新的帐户信息并单击 "创建用户" 按钮后，将创建用户帐户，并将一行添加到 `UserProfiles` 表。</span><span class="sxs-lookup"><span data-stu-id="b7477-483">After the visitor has supplied his new account information and clicked the "Create User" button, the user account is created and a row added to the `UserProfiles` table.</span></span> <span data-ttu-id="b7477-484">然后，CreateUserWizard 将显示其 `CompleteWizardStep`，它将显示一条成功消息和一个 "继续" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b7477-484">The CreateUserWizard then displays its `CompleteWizardStep`, which displays a success message and a Continue button.</span></span> <span data-ttu-id="b7477-485">单击 "继续" 按钮会导致回发，但不会执行任何操作，而是使用户停留在 `EnhancedCreateUserWizard.aspx` 页面上。</span><span class="sxs-lookup"><span data-stu-id="b7477-485">Clicking the Continue button causes a postback, but no action is taken, leaving the user stuck on the `EnhancedCreateUserWizard.aspx` page.</span></span>

<span data-ttu-id="b7477-486">通过 CreateUserWizard 控件的[`ContinueDestinationPageUrl` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx)单击 "继续" 按钮时，可以指定用于将用户发送到的 URL。</span><span class="sxs-lookup"><span data-stu-id="b7477-486">We can specify a URL to send the user to when the Continue button is clicked via the CreateUserWizard control's [`ContinueDestinationPageUrl` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx).</span></span> <span data-ttu-id="b7477-487">将 `ContinueDestinationPageUrl` 属性设置为 "~/Membership/AdditionalUserInfo.aspx"。</span><span class="sxs-lookup"><span data-stu-id="b7477-487">Set the `ContinueDestinationPageUrl` property to "~/Membership/AdditionalUserInfo.aspx".</span></span> <span data-ttu-id="b7477-488">这会使新用户 `AdditionalUserInfo.aspx`，用户可以在其中查看和更新其设置。</span><span class="sxs-lookup"><span data-stu-id="b7477-488">This takes the new user to `AdditionalUserInfo.aspx`, where they can view and update their settings.</span></span>

### <a name="customizing-the-createuserwizards-interface-to-prompt-for-the-new-users-home-town-homepage-and-signature"></a><span data-ttu-id="b7477-489">自定义 CreateUserWizard 的界面，以提示输入新用户的家庭城镇、主页和签名</span><span class="sxs-lookup"><span data-stu-id="b7477-489">Customizing the CreateUserWizard's Interface to Prompt for the New User's Home Town, Homepage, and Signature</span></span>

<span data-ttu-id="b7477-490">CreateUserWizard 控件的默认接口足以满足只收集核心用户帐户信息（如用户名、密码和电子邮件）的简单帐户创建方案。</span><span class="sxs-lookup"><span data-stu-id="b7477-490">The CreateUserWizard control's default interface is sufficient for simple account creation scenarios where only core user account information like username, password, and email need be collected.</span></span> <span data-ttu-id="b7477-491">但是，如果我们希望在创建帐户时提示访问者输入她的住宅、主页和签名，该怎么办？</span><span class="sxs-lookup"><span data-stu-id="b7477-491">But what if we wanted to prompt the visitor to enter her home town, homepage, and signature while creating her account?</span></span> <span data-ttu-id="b7477-492">可以自定义 CreateUserWizard 控件的接口，以便在注册时收集其他信息，该信息可在 `CreatedUser` 事件处理程序中使用，以将其他记录插入到基础数据库中。</span><span class="sxs-lookup"><span data-stu-id="b7477-492">It is possible to customize the CreateUserWizard control's interface to collect additional information at signup, and this information may be used in the `CreatedUser` event handler to insert additional records into the underlying database.</span></span>

<span data-ttu-id="b7477-493">CreateUserWizard 控件扩展了 ASP.NET 向导控件，该控件允许页开发人员定义一系列排序 `WizardSteps`。</span><span class="sxs-lookup"><span data-stu-id="b7477-493">The CreateUserWizard control extends the ASP.NET Wizard control, which is a control that allows a page developer to define a series of ordered `WizardSteps`.</span></span> <span data-ttu-id="b7477-494">向导控件将呈现活动步骤并提供导航界面，使访问者可以在这些步骤中完成操作。</span><span class="sxs-lookup"><span data-stu-id="b7477-494">The Wizard control renders the active step and provides a navigation interface that allows the visitor to move through these steps.</span></span> <span data-ttu-id="b7477-495">向导控件非常适合用于将较长的任务分解为几个简短的步骤。</span><span class="sxs-lookup"><span data-stu-id="b7477-495">The Wizard control is ideal for breaking down a long task into several short steps.</span></span> <span data-ttu-id="b7477-496">有关向导控件的详细信息，请参阅[使用 ASP.NET 2.0 向导控件创建分步用户界面](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-496">For more information on the Wizard control, see [Creating a Step-by-Step User Interface with the ASP.NET 2.0 Wizard Control](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx).</span></span>

<span data-ttu-id="b7477-497">CreateUserWizard 控件的默认标记定义了两个 `WizardSteps`： `CreateUserWizardStep` 和 `CompleteWizardStep`。</span><span class="sxs-lookup"><span data-stu-id="b7477-497">The CreateUserWizard control's default markup defines two `WizardSteps`: `CreateUserWizardStep` and `CompleteWizardStep`.</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample12.aspx)]

<span data-ttu-id="b7477-498">第一个 `WizardStep``CreateUserWizardStep`，它会呈现提示输入用户名、密码、电子邮件等的接口。</span><span class="sxs-lookup"><span data-stu-id="b7477-498">The first `WizardStep`, `CreateUserWizardStep`, renders the interface that prompts for the username, password, email, and so on.</span></span> <span data-ttu-id="b7477-499">在访问者提供此信息并单击 "创建用户" 后，将显示 "`CompleteWizardStep`"，其中显示了 "成功" 消息和 "继续" 按钮。</span><span class="sxs-lookup"><span data-stu-id="b7477-499">After the visitor supplies this information and clicks "Create User", she is shown the `CompleteWizardStep`, which shows the success message and a Continue button.</span></span>

<span data-ttu-id="b7477-500">若要自定义 CreateUserWizard 控件的接口以包含其他窗体字段，可以：</span><span class="sxs-lookup"><span data-stu-id="b7477-500">To customize the CreateUserWizard control's interface to include additional form fields, we can:</span></span>

- <span data-ttu-id="b7477-501"><strong>创建一个或多个新</strong>的<strong>`WizardStep`</strong> <strong>，以包含其他用户界面元素</strong>。</span><span class="sxs-lookup"><span data-stu-id="b7477-501"><strong>Create one or more new</strong><strong>`WizardStep`</strong><strong>s to contain the additional user interface elements</strong>.</span></span> <span data-ttu-id="b7477-502">若要将新 `WizardStep` 添加到 CreateUserWizard，请单击其智能标记中的 "添加/删除 `WizardSteps`" 链接以启动 `WizardStep` 集合编辑器。</span><span class="sxs-lookup"><span data-stu-id="b7477-502">To add a new `WizardStep` to the CreateUserWizard, click the "Add/Remove `WizardSteps`" link from its Smart Tag to launch the `WizardStep` Collection Editor.</span></span> <span data-ttu-id="b7477-503">在该处，你可以在向导中添加、删除或重新排序步骤。</span><span class="sxs-lookup"><span data-stu-id="b7477-503">From there you can add, remove, or reorder the steps in the wizard.</span></span> <span data-ttu-id="b7477-504">本教程将使用这种方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-504">This is the approach we will use for this tutorial.</span></span>

- <span data-ttu-id="b7477-505"><strong>将</strong><strong>`CreateUserWizardStep`</strong>转换为<strong>可编辑</strong><strong>`WizardStep`</strong> <strong>。</strong></span><span class="sxs-lookup"><span data-stu-id="b7477-505"><strong>Convert the</strong><strong>`CreateUserWizardStep`</strong><strong>into an editable</strong><strong>`WizardStep`</strong><strong>.</strong></span></span> <span data-ttu-id="b7477-506">这会将 `CreateUserWizardStep` 替换为等效的 `WizardStep`，其标记定义了与 `CreateUserWizardStep`的匹配的用户界面。</span><span class="sxs-lookup"><span data-stu-id="b7477-506">This replaces the `CreateUserWizardStep` with an equivalent `WizardStep` whose markup defines a user interface that matches the `CreateUserWizardStep`'s.</span></span> <span data-ttu-id="b7477-507">通过将 `CreateUserWizardStep` 转换为 `WizardStep` 我们可以重新定位控件或向此步骤添加其他用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="b7477-507">By converting the `CreateUserWizardStep` into a `WizardStep` we can reposition the controls or add additional user interface elements to this step.</span></span> <span data-ttu-id="b7477-508">若要将 `CreateUserWizardStep` 或 `CompleteWizardStep` 转换为可编辑 `WizardStep`，请在控件的智能标记中单击 "自定义创建用户步骤" 或 "自定义完整步骤" 链接。</span><span class="sxs-lookup"><span data-stu-id="b7477-508">To convert the `CreateUserWizardStep` or `CompleteWizardStep` into an editable `WizardStep`, click the "Customize Create User Step" or "Customize Complete Step" link from the control's Smart Tag.</span></span>

- <span data-ttu-id="b7477-509">**使用上述两个选项的某种组合。**</span><span class="sxs-lookup"><span data-stu-id="b7477-509">**Use some combination of the above two options.**</span></span>

<span data-ttu-id="b7477-510">需要注意的一个重要事项是，CreateUserWizard 控件在其 `CreateUserWizardStep`中单击 "创建用户" 按钮时执行其用户帐户创建过程。</span><span class="sxs-lookup"><span data-stu-id="b7477-510">One important thing to keep in mind is that the CreateUserWizard control executes its user account creation process when the "Create User" button is clicked from within its `CreateUserWizardStep`.</span></span> <span data-ttu-id="b7477-511">如果 `CreateUserWizardStep` 之后还有其他 `WizardStep`，就不是那么重要。</span><span class="sxs-lookup"><span data-stu-id="b7477-511">It doesn't matter if there are additional `WizardStep` s after the `CreateUserWizardStep` or not.</span></span>

<span data-ttu-id="b7477-512">将自定义 `WizardStep` 添加到 CreateUserWizard 控件以收集其他用户输入时，可以将自定义 `WizardStep` 置于 `CreateUserWizardStep`之前或之后。</span><span class="sxs-lookup"><span data-stu-id="b7477-512">When adding a custom `WizardStep` to the CreateUserWizard control to collect additional user input, the custom `WizardStep` can be placed before or after the `CreateUserWizardStep`.</span></span> <span data-ttu-id="b7477-513">如果在 `CreateUserWizardStep` 之前，则从自定义 `WizardStep` 收集的其他用户输入可用于 `CreatedUser` 事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="b7477-513">If it comes before the `CreateUserWizardStep` then the additional user input collected from the custom `WizardStep` is available for the `CreatedUser` event handler.</span></span> <span data-ttu-id="b7477-514">但是，如果自定义 `WizardStep` 晚于 `CreateUserWizardStep` 然后在自定义 `WizardStep` 显示时，则已创建新用户帐户，并且已激发 `CreatedUser` 事件。</span><span class="sxs-lookup"><span data-stu-id="b7477-514">However, if the custom `WizardStep` comes after `CreateUserWizardStep` then by the time the custom `WizardStep` is displayed the new user account has already been created and the `CreatedUser` event has already fired.</span></span>

<span data-ttu-id="b7477-515">图21显示了在 `CreateUserWizardStep`之前添加的 `WizardStep` 的工作流。</span><span class="sxs-lookup"><span data-stu-id="b7477-515">Figure 21 shows the workflow when the added `WizardStep` precedes the `CreateUserWizardStep`.</span></span> <span data-ttu-id="b7477-516">由于在 `CreatedUser` 事件引发时，已收集了其他用户信息，因此我们只需更新 `CreatedUser` 事件处理程序来检索这些输入，并将这些输入用于 `INSERT` 语句的参数值（而不是 `DBNull.Value`）。</span><span class="sxs-lookup"><span data-stu-id="b7477-516">Since the additional user information has been collected by the time the `CreatedUser` event fires, all we have to do is update the `CreatedUser` event handler to retrieve these inputs and use those for the `INSERT` statement's parameter values (rather than `DBNull.Value`).</span></span>

<span data-ttu-id="b7477-517">[如果在 Createuserwizardstep.contenttemplate 之前附加 WizardStep，![CreateUserWizard 工作流](storing-additional-user-information-cs/_static/image62.png)](storing-additional-user-information-cs/_static/image61.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-517">[![The CreateUserWizard Workflow When an Additional WizardStep Precedes the CreateUserWizardStep](storing-additional-user-information-cs/_static/image62.png)](storing-additional-user-information-cs/_static/image61.png)</span></span>

<span data-ttu-id="b7477-518">**图 21**： CreateUserWizard 工作流在 `CreateUserWizardStep` 之前 `WizardStep` （[单击查看完全大小的图像](storing-additional-user-information-cs/_static/image63.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-518">**Figure 21**: The CreateUserWizard Workflow When an Additional `WizardStep` Precedes the `CreateUserWizardStep` ([Click to view full-size image](storing-additional-user-information-cs/_static/image63.png))</span></span>

<span data-ttu-id="b7477-519">但是，如果将自定义 `WizardStep` 放置在 `CreateUserWizardStep`*之后*，则在用户有机会进入她的 home、home 或 signature 之前，会发生 "创建用户帐户" 过程。</span><span class="sxs-lookup"><span data-stu-id="b7477-519">If the custom `WizardStep` is placed *after* the `CreateUserWizardStep`, however, the create user account process occurs before the user has had a chance to enter her home town, homepage, or signature.</span></span> <span data-ttu-id="b7477-520">在这种情况下，在创建用户帐户后，需要将此附加信息插入到数据库中，如图22所示。</span><span class="sxs-lookup"><span data-stu-id="b7477-520">In such a case, this additional information needs to be inserted into the database after the user account has been created, as Figure 22 illustrates.</span></span>

<span data-ttu-id="b7477-521">[Createuserwizardstep.contenttemplate 后的其他 WizardStep ![CreateUserWizard 工作流](storing-additional-user-information-cs/_static/image65.png)](storing-additional-user-information-cs/_static/image64.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-521">[![The CreateUserWizard Workflow When an Additional WizardStep Comes After the CreateUserWizardStep](storing-additional-user-information-cs/_static/image65.png)](storing-additional-user-information-cs/_static/image64.png)</span></span>

<span data-ttu-id="b7477-522">**图 22**： `CreateUserWizardStep` 上出现其他 `WizardStep` 时的 CreateUserWizard 工作流（[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image66.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-522">**Figure 22**: The CreateUserWizard Workflow When an Additional `WizardStep` Comes After the `CreateUserWizardStep` ([Click to view full-size image](storing-additional-user-information-cs/_static/image66.png))</span></span>

<span data-ttu-id="b7477-523">图22中显示的工作流将等待在步骤2完成之后，将记录插入到 `UserProfiles` 表中。</span><span class="sxs-lookup"><span data-stu-id="b7477-523">The workflow shown in Figure 22 waits to insert a record into the `UserProfiles` table until after Step 2 completes.</span></span> <span data-ttu-id="b7477-524">不过，如果访问者在步骤1后关闭她的浏览器，则会在创建用户帐户时达到状态，但不会将任何记录添加到 `UserProfiles`。</span><span class="sxs-lookup"><span data-stu-id="b7477-524">If the visitor closes her browser after step 1, however, we will have reached a state where a user account was created, but no record was added to `UserProfiles`.</span></span> <span data-ttu-id="b7477-525">一种解决方法是将具有 `NULL` 或默认值的记录插入到 `CreatedUser` 事件处理程序中的 `UserProfiles` （在步骤1之后触发），然后在步骤2完成后更新此记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-525">One workaround is to have a record with `NULL` or default values inserted into `UserProfiles` in the `CreatedUser` event handler (which fires after step 1), and then update this record after step 2 completes.</span></span> <span data-ttu-id="b7477-526">这可确保将为用户帐户添加 `UserProfiles` 记录，即使用户在中间退出注册过程也是如此。</span><span class="sxs-lookup"><span data-stu-id="b7477-526">This ensures that a `UserProfiles` record will be added for the user account even if the user quits the registration process midway through.</span></span>

<span data-ttu-id="b7477-527">在本教程中，我们将创建一个在 `CreateUserWizardStep` 之后但在 `CompleteWizardStep`之前发生的新 `WizardStep`。</span><span class="sxs-lookup"><span data-stu-id="b7477-527">For this tutorial let's create a new `WizardStep` that occurs after the `CreateUserWizardStep` but before the `CompleteWizardStep`.</span></span> <span data-ttu-id="b7477-528">首先，让我们准备好 WizardStep 并进行配置，然后查看代码。</span><span class="sxs-lookup"><span data-stu-id="b7477-528">Let's first get the WizardStep in place and configured and then we'll look at the code.</span></span>

<span data-ttu-id="b7477-529">在 CreateUserWizard 控件的智能标记中，选择 "添加/删除 `WizardStep` s"，这将打开 "`WizardStep` 集合编辑器" 对话框。</span><span class="sxs-lookup"><span data-stu-id="b7477-529">From the CreateUserWizard control's Smart Tag, select the "Add/Remove `WizardStep` s", which brings up the `WizardStep` Collection Editor dialog.</span></span> <span data-ttu-id="b7477-530">添加新的 `WizardStep`，并将其 `ID` 设置为 `UserSettings`，并将其 `Title` 为 "你的设置"，并将其 `StepType` 设置为 `Step`。</span><span class="sxs-lookup"><span data-stu-id="b7477-530">Add a new `WizardStep`, setting its `ID` to `UserSettings`, its `Title` to "Your Settings" and its `StepType` to `Step`.</span></span> <span data-ttu-id="b7477-531">然后将其定位到 `CreateUserWizardStep` （"注册新帐户"）之前和 `CompleteWizardStep` （"完成"）之前，如图23所示。</span><span class="sxs-lookup"><span data-stu-id="b7477-531">Then position it so that it comes after the `CreateUserWizardStep` ("Sign Up for Your New Account") and before the `CompleteWizardStep` ("Complete"), as shown in Figure 23.</span></span>

<span data-ttu-id="b7477-532">[![将新的 WizardStep 添加到 CreateUserWizard 控件](storing-additional-user-information-cs/_static/image68.png)](storing-additional-user-information-cs/_static/image67.png)</span><span class="sxs-lookup"><span data-stu-id="b7477-532">[![Add a New WizardStep to the CreateUserWizard Control](storing-additional-user-information-cs/_static/image68.png)](storing-additional-user-information-cs/_static/image67.png)</span></span>

<span data-ttu-id="b7477-533">**图 23**：向 CreateUserWizard 控件添加新的 `WizardStep` （[单击以查看完全大小的图像](storing-additional-user-information-cs/_static/image69.png)）</span><span class="sxs-lookup"><span data-stu-id="b7477-533">**Figure 23**: Add a New `WizardStep` to the CreateUserWizard Control  ([Click to view full-size image](storing-additional-user-information-cs/_static/image69.png))</span></span>

<span data-ttu-id="b7477-534">单击 "确定" 以关闭 "`WizardStep` 集合编辑器" 对话框。</span><span class="sxs-lookup"><span data-stu-id="b7477-534">Click OK to close the `WizardStep` Collection Editor dialog.</span></span> <span data-ttu-id="b7477-535">新 `WizardStep` 由 CreateUserWizard 控件的更新声明性标记出现：</span><span class="sxs-lookup"><span data-stu-id="b7477-535">The new `WizardStep` is evidenced by the CreateUserWizard control's updated declarative markup:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample13.aspx)]

<span data-ttu-id="b7477-536">请注意新的 `<asp:WizardStep>` 元素。</span><span class="sxs-lookup"><span data-stu-id="b7477-536">Note the new `<asp:WizardStep>` element.</span></span> <span data-ttu-id="b7477-537">需要在此处添加用户界面以收集新用户的 "住宅"、"主页" 和 "签名"。</span><span class="sxs-lookup"><span data-stu-id="b7477-537">We need to add the user interface to collect the new user's home town, homepage, and signature here.</span></span> <span data-ttu-id="b7477-538">可在声明性语法中或通过设计器输入此内容。</span><span class="sxs-lookup"><span data-stu-id="b7477-538">You can enter this content in the declarative syntax or through the Designer.</span></span> <span data-ttu-id="b7477-539">若要使用设计器，请从智能标记的下拉列表中选择 "设置" 步骤，以查看设计器中的步骤。</span><span class="sxs-lookup"><span data-stu-id="b7477-539">To use the Designer, select the "Your Settings" step from the drop-down list in the Smart Tag to see the step in the Designer.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-540">通过智能标记的下拉列表选择一个步骤，可更新 CreateUserWizard 控件的[`ActiveStepIndex` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.activestepindex.aspx)，该属性指定起始步骤的索引。</span><span class="sxs-lookup"><span data-stu-id="b7477-540">Selecting a step through the Smart Tag's drop-down list updates the CreateUserWizard control's [`ActiveStepIndex` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.activestepindex.aspx), which specifies the index of the starting step.</span></span> <span data-ttu-id="b7477-541">因此，如果使用此下拉列表来编辑设计器中的 "设置" 步骤，请确保将其设置回 "注册新帐户"，以便在用户首次访问 `EnhancedCreateUserWizard.aspx` 页面时显示此步骤。</span><span class="sxs-lookup"><span data-stu-id="b7477-541">Therefore, if you use this drop-down list to edit the "Your Settings" step in the Designer, be sure to set it back to "Sign Up for Your New Account" so that this step is shown when users first visit the `EnhancedCreateUserWizard.aspx` page.</span></span>

<span data-ttu-id="b7477-542">在 "设置" 步骤中创建一个用户界面，其中包含三个名为 `HomeTown`、`HomepageUrl`和 `Signature`的 TextBox 控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-542">Create a user interface within the "Your Settings" step that contains three TextBox controls named `HomeTown`, `HomepageUrl`, and `Signature`.</span></span> <span data-ttu-id="b7477-543">构造此接口后，CreateUserWizard 的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7477-543">After constructing this interface, the CreateUserWizard's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample14.aspx)]

<span data-ttu-id="b7477-544">继续下一步，通过浏览器访问此页，创建新的用户帐户，并指定 home、home 和签名的值。</span><span class="sxs-lookup"><span data-stu-id="b7477-544">Go ahead and visit this page through a browser and create a new user account, specifying values for the home town, homepage, and signature.</span></span> <span data-ttu-id="b7477-545">完成后 `CreateUserWizardStep` 在成员身份框架中创建用户帐户，并运行 `CreatedUser` 事件处理程序，该事件处理程序会将新行添加到 `UserProfiles`，但对于 `HomeTown`、`HomepageUrl`和 `Signature`，数据库 `NULL` 值为。</span><span class="sxs-lookup"><span data-stu-id="b7477-545">After completing the `CreateUserWizardStep` the user account is created in the Membership framework and the `CreatedUser` event handler runs, which adds a new row to `UserProfiles`, but with a database `NULL` value for `HomeTown`, `HomepageUrl`, and `Signature`.</span></span> <span data-ttu-id="b7477-546">为 home、home 和 signature 输入的值永远不会使用。</span><span class="sxs-lookup"><span data-stu-id="b7477-546">The values entered for the home town, homepage, and signature are never used.</span></span> <span data-ttu-id="b7477-547">Net 结果是一个新的用户帐户，其中包含尚未指定其 `HomeTown`、`HomepageUrl`和 `Signature` 字段的 `UserProfiles` 记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-547">The net result is a new user account with a `UserProfiles` record whose `HomeTown`, `HomepageUrl`, and `Signature` fields have yet to be specified.</span></span>

<span data-ttu-id="b7477-548">我们需要在 "你的设置" 步骤后执行代码，该步骤使用用户输入的 "住宅"、"honepage" 和 "签名" 值，并更新相应的 `UserProfiles` 记录。</span><span class="sxs-lookup"><span data-stu-id="b7477-548">We need to execute code after the "Your Settings" step that takes the home town, honepage, and signature values entered by the user and updates the appropriate `UserProfiles` record.</span></span> <span data-ttu-id="b7477-549">用户每次在向导控件中的步骤间移动时，都会激发向导的[`ActiveStepChanged` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.activestepchanged.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7477-549">Each time the user moves between steps in a Wizard control, the Wizard's [`ActiveStepChanged` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.activestepchanged.aspx) fires.</span></span> <span data-ttu-id="b7477-550">我们可以创建此事件的事件处理程序，并在 "设置" 步骤完成后更新 `UserProfiles` 表。</span><span class="sxs-lookup"><span data-stu-id="b7477-550">We can create an event handler for this event and update the `UserProfiles` table when the "Your Settings" step has completed.</span></span>

<span data-ttu-id="b7477-551">为 CreateUserWizard 的 `ActiveStepChanged` 事件添加事件处理程序，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="b7477-551">Add an event handler for the CreateUserWizard's `ActiveStepChanged` event and add the following code:</span></span>

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample15.cs)]

<span data-ttu-id="b7477-552">上述代码首先确定是否已到达 "完成" 步骤。</span><span class="sxs-lookup"><span data-stu-id="b7477-552">The above code starts by determining if we have just reached the "Complete" step.</span></span> <span data-ttu-id="b7477-553">由于 "完成" 步骤会在 "您的设置" 步骤之后立即发生，因此当访问者达到 "完成" 步骤时，意味着她刚刚完成了 "您的设置" 步骤。</span><span class="sxs-lookup"><span data-stu-id="b7477-553">Since the "Complete" step occurs immediately after the "Your Settings" step, then when the visitor reaches "Complete" step that means she just finished the "Your Settings" step.</span></span>

<span data-ttu-id="b7477-554">在这种情况下，我们需要以编程方式引用 `UserSettings WizardStep`中的 TextBox 控件。</span><span class="sxs-lookup"><span data-stu-id="b7477-554">In such a case, we need to programmatically reference the TextBox controls within the `UserSettings WizardStep`.</span></span> <span data-ttu-id="b7477-555">首先使用 `FindControl` 方法以编程方式引用 `UserSettings WizardStep`，然后再次从 `WizardStep`中引用文本框来完成此操作。</span><span class="sxs-lookup"><span data-stu-id="b7477-555">This is accomplished by first using the `FindControl` method to programmatically referencing the `UserSettings WizardStep`, and then again to reference the TextBoxes from within the `WizardStep`.</span></span> <span data-ttu-id="b7477-556">引用文本框后，便可以执行 `UPDATE` 语句了。</span><span class="sxs-lookup"><span data-stu-id="b7477-556">Once the TextBoxes have been referenced, we're ready to execute the `UPDATE` statement.</span></span> <span data-ttu-id="b7477-557">`UPDATE` 语句与 `CreatedUser` 事件处理程序中的 `INSERT` 语句具有相同数目的参数，但此处我们使用的是用户提供的 home 城镇、主页和签名值。</span><span class="sxs-lookup"><span data-stu-id="b7477-557">The `UPDATE` statement has the same number of parameters as the `INSERT` statement in the `CreatedUser` event handler, but here we use the home town, homepage, and signature values supplied by the user.</span></span>

<span data-ttu-id="b7477-558">完成此事件处理程序后，通过浏览器访问 `EnhancedCreateUserWizard.aspx` 页面，然后创建新的用户帐户，以指定 home、主页和签名的值。</span><span class="sxs-lookup"><span data-stu-id="b7477-558">With this event handler in place, visit the `EnhancedCreateUserWizard.aspx` page through a browser and create a new user account specifying values for the home town, homepage, and signature.</span></span> <span data-ttu-id="b7477-559">创建新帐户后，应重定向到 "`AdditionalUserInfo.aspx`" 页，其中显示刚刚输入的 "住宅"、"主页" 和 "签名" 信息。</span><span class="sxs-lookup"><span data-stu-id="b7477-559">After creating the new account you should be redirected to the `AdditionalUserInfo.aspx` page, where the just-entered home town, homepage, and signature information is displayed.</span></span>

> [!NOTE]
> <span data-ttu-id="b7477-560">网站当前有两个页面，访问者可以在其中创建新帐户： `CreatingUserAccounts.aspx` 和 `EnhancedCreateUserWizard.aspx`。</span><span class="sxs-lookup"><span data-stu-id="b7477-560">Our website currently has two pages from which a visitor can create a new account: `CreatingUserAccounts.aspx` and `EnhancedCreateUserWizard.aspx`.</span></span> <span data-ttu-id="b7477-561">网站的 "站点地图" 和 "登录" 页指向 "`CreatingUserAccounts.aspx`" 页，但 "`CreatingUserAccounts.aspx`" 页不会提示用户输入其 home 城镇、主页和签名信息，也不会将相应的行添加到 `UserProfiles`中。</span><span class="sxs-lookup"><span data-stu-id="b7477-561">The website's sitemap and login page point to the `CreatingUserAccounts.aspx` page, but the `CreatingUserAccounts.aspx` page does not prompt the user for their home town, homepage, and signature information and does not add a corresponding row to `UserProfiles`.</span></span> <span data-ttu-id="b7477-562">因此，请更新 `CreatingUserAccounts.aspx` 页面，使其提供此功能，或更新站点地图和登录页以引用 `EnhancedCreateUserWizard.aspx` 而不是 `CreatingUserAccounts.aspx`。</span><span class="sxs-lookup"><span data-stu-id="b7477-562">Therefore, either update the `CreatingUserAccounts.aspx` page so that it offers this functionality or update the sitemap and login page to reference `EnhancedCreateUserWizard.aspx` instead of `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="b7477-563">如果选择后一种方法，请确保更新 `Membership` 文件夹的 `Web.config` 文件，以便允许匿名用户访问 `EnhancedCreateUserWizard.aspx` 页面。</span><span class="sxs-lookup"><span data-stu-id="b7477-563">If you choose the latter option, be sure to update the `Membership` folder's `Web.config` file so as to allow anonymous users access to the `EnhancedCreateUserWizard.aspx` page.</span></span>

## <a name="summary"></a><span data-ttu-id="b7477-564">总结</span><span class="sxs-lookup"><span data-stu-id="b7477-564">Summary</span></span>

<span data-ttu-id="b7477-565">在本教程中，我们将介绍与成员身份框架中的用户帐户相关的数据建模方法。</span><span class="sxs-lookup"><span data-stu-id="b7477-565">In this tutorial we looked at techniques for modeling data that is related to user accounts within the Membership framework.</span></span> <span data-ttu-id="b7477-566">具体而言，我们了解到与用户帐户共享一对多关系的建模实体，以及共享一对一关系的数据。</span><span class="sxs-lookup"><span data-stu-id="b7477-566">In particular, we looked at modeling entities that share a one-to-many relationship with user accounts as well as data that shares a one-to-one relationship.</span></span> <span data-ttu-id="b7477-567">此外，我们还看到了如何显示、插入和更新此相关信息，其中有一些示例使用 SqlDataSource 控件和其他使用 ADO.NET 代码的示例。</span><span class="sxs-lookup"><span data-stu-id="b7477-567">Furthermore, we saw how this related information could be displayed, inserted, and updated, with some examples using the SqlDataSource control and others using ADO.NET code.</span></span>

<span data-ttu-id="b7477-568">本教程介绍了用户帐户。</span><span class="sxs-lookup"><span data-stu-id="b7477-568">This tutorial completes our look at user accounts.</span></span> <span data-ttu-id="b7477-569">从下一教程开始，我们将关注角色。</span><span class="sxs-lookup"><span data-stu-id="b7477-569">Starting with the next tutorial we will turn our attention to roles.</span></span> <span data-ttu-id="b7477-570">在接下来的几个教程中，我们将探讨角色框架，了解如何创建新角色，如何为用户分配角色，如何确定用户所属的角色，以及如何应用基于角色的授权。</span><span class="sxs-lookup"><span data-stu-id="b7477-570">Over the next several tutorials we will look at the Roles framework, see how to create new roles, how to assign roles to users, how to determine what roles a user belongs to, and how to apply role-based authorization.</span></span>

<span data-ttu-id="b7477-571">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="b7477-571">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="b7477-572">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="b7477-572">Further Reading</span></span>

<span data-ttu-id="b7477-573">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="b7477-573">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="b7477-574">在 ASP.NET 2.0 中访问和更新数据</span><span class="sxs-lookup"><span data-stu-id="b7477-574">Accessing and Updating Data in ASP.NET 2.0</span></span>](http://aspnet.4guysfromrolla.com/articles/011106-1.aspx)
- [<span data-ttu-id="b7477-575">ASP.NET 2.0 向导控件</span><span class="sxs-lookup"><span data-stu-id="b7477-575">ASP.NET 2.0 Wizard Control</span></span>](https://weblogs.asp.net/scottgu/archive/2006/02/21/438732.aspx)
- [<span data-ttu-id="b7477-576">使用 ASP.NET 2.0 向导控件创建分步用户界面</span><span class="sxs-lookup"><span data-stu-id="b7477-576">Creating a Step-by-Step User Interface with the ASP.NET 2.0 Wizard Control</span></span>](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)
- [<span data-ttu-id="b7477-577">创建自定义数据源控件参数</span><span class="sxs-lookup"><span data-stu-id="b7477-577">Creating Custom DataSource Control Parameters</span></span>](http://aspnet.4guysfromrolla.com/articles/110106-1.aspx)
- [<span data-ttu-id="b7477-578">自定义 CreateUserWizard 控件</span><span class="sxs-lookup"><span data-stu-id="b7477-578">Customizing the CreateUserWizard Control</span></span>](http://aspnet.4guysfromrolla.com/articles/070506-1.aspx)
- [<span data-ttu-id="b7477-579">DetailsView 控件快速入门</span><span class="sxs-lookup"><span data-stu-id="b7477-579">DetailsView Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/data/detailsview.aspx)
- [<span data-ttu-id="b7477-580">用 ListView 控件显示数据</span><span class="sxs-lookup"><span data-stu-id="b7477-580">Displaying Data with the ListView Control</span></span>](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx)
- [<span data-ttu-id="b7477-581">二级 ASP.NET 2.0 中的验证控件</span><span class="sxs-lookup"><span data-stu-id="b7477-581">Dissecting the Validation Controls in ASP.NET 2.0</span></span>](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)
- [<span data-ttu-id="b7477-582">编辑插入和删除数据</span><span class="sxs-lookup"><span data-stu-id="b7477-582">Editing Insert and Deleting Data</span></span>](../../data-access/editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)
- [<span data-ttu-id="b7477-583">ASP.NET 中的窗体验证</span><span class="sxs-lookup"><span data-stu-id="b7477-583">Form Validation in ASP.NET</span></span>](http://www.4guysfromrolla.com/webtech/090200-1.shtml)
- [<span data-ttu-id="b7477-584">正在收集自定义用户注册信息</span><span class="sxs-lookup"><span data-stu-id="b7477-584">Gathering Custom User Registration Information</span></span>](https://weblogs.asp.net/scottgu/archive/2006/07/05/Tip_2F00_Trick_3A00_-Gathering-Custom-User-Registration-Information.aspx)
- [<span data-ttu-id="b7477-585">ASP.NET 2.0 中的配置文件</span><span class="sxs-lookup"><span data-stu-id="b7477-585">Profiles in ASP.NET 2.0</span></span>](http://www.odetocode.com/Articles/440.aspx)
- [<span data-ttu-id="b7477-586">Asp： ListView 控件</span><span class="sxs-lookup"><span data-stu-id="b7477-586">The asp:ListView Control</span></span>](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)
- [<span data-ttu-id="b7477-587">用户配置文件快速入门</span><span class="sxs-lookup"><span data-stu-id="b7477-587">User Profiles QuickStart</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/profile/default.aspx)

### <a name="about-the-author"></a><span data-ttu-id="b7477-588">关于作者</span><span class="sxs-lookup"><span data-stu-id="b7477-588">About the Author</span></span>

<span data-ttu-id="b7477-589">Scott Mitchell，创始人的多个 ASP/ASP 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="b7477-589">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="b7477-590">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="b7477-590">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="b7477-591">他的最新书籍是， *[在24小时内，sam ASP.NET 2.0](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* 。</span><span class="sxs-lookup"><span data-stu-id="b7477-591">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="b7477-592">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="b7477-592">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="b7477-593">特别感谢 。</span><span class="sxs-lookup"><span data-stu-id="b7477-593">Special Thanks To…</span></span>

<span data-ttu-id="b7477-594">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="b7477-594">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="b7477-595">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="b7477-595">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="b7477-596">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)放置一行。</span><span class="sxs-lookup"><span data-stu-id="b7477-596">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="b7477-597">[上一页](user-based-authorization-cs.md)
> [下一页](creating-the-membership-schema-in-sql-server-vb.md)</span><span class="sxs-lookup"><span data-stu-id="b7477-597">[Previous](user-based-authorization-cs.md)
[Next](creating-the-membership-schema-in-sql-server-vb.md)</span></span>
