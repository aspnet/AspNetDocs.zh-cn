---
uid: web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
title: 正在验证用户凭据对成员身份用户存储区 (C#) |Microsoft Docs
author: rick-anderson
description: 在本教程中，我们将说明如何验证用户的凭据针对的成员身份用户存储中使用的编程方法和 Login 控件...
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 61aa4e08-aa81-4aeb-8ebe-19ba7a65e04c
msc.legacyurl: /web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
msc.type: authoredcontent
ms.openlocfilehash: 469fc9c52bd3d1e5dd69b80399b250ba46f72405
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/06/2019
ms.locfileid: "65131817"
---
# <a name="validating-user-credentials-against-the-membership-user-store-c"></a><span data-ttu-id="50956-103">针对成员身份用户存储验证用户凭据 (C#)</span><span class="sxs-lookup"><span data-stu-id="50956-103">Validating User Credentials Against the Membership User Store (C#)</span></span>

<span data-ttu-id="50956-104">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="50956-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="50956-105">[下载代码](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip)或[下载 PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="50956-105">[Download Code](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip) or [Download PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)</span></span>

> <span data-ttu-id="50956-106">在本教程中，我们将说明如何验证根据使用的编程方法和 Login 控件的成员身份用户存储区的用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-106">In this tutorial we will examine how to validate a user's credentials against the Membership user store using both programmatic means and the Login control.</span></span> <span data-ttu-id="50956-107">我们还将介绍如何自定义登录控件的外观和行为。</span><span class="sxs-lookup"><span data-stu-id="50956-107">We will also look at how to customize the login control's appearance and behavior.</span></span>

## <a name="introduction"></a><span data-ttu-id="50956-108">介绍</span><span class="sxs-lookup"><span data-stu-id="50956-108">Introduction</span></span>

<span data-ttu-id="50956-109">在中<a id="Tutorial05"> </a>[前面的教程](creating-user-accounts-cs.md)探讨了如何在成员资格框架中创建新的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="50956-109">In the <a id="Tutorial05"></a>[preceding tutorial](creating-user-accounts-cs.md) we looked at how to create a new user account in the Membership framework.</span></span> <span data-ttu-id="50956-110">我们首先介绍了以编程方式创建用户帐户通过`Membership`类的`CreateUser`方法，并使用 CreateUserWizard Web 控件然后检查。</span><span class="sxs-lookup"><span data-stu-id="50956-110">We first looked at programmatically creating user accounts via the `Membership` class's `CreateUser` method, and then examined using the CreateUserWizard Web control.</span></span> <span data-ttu-id="50956-111">但是，登录页当前验证提供的凭据与硬编码的用户名和密码对的列表。</span><span class="sxs-lookup"><span data-stu-id="50956-111">However, the login page currently validates the supplied credentials against a hard-coded list of username and password pairs.</span></span> <span data-ttu-id="50956-112">我们需要更新登录页面的逻辑，以便验证针对成员资格框架的用户存储的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-112">We need to update the login page's logic so that it validates credentials against the Membership framework's user store.</span></span>

<span data-ttu-id="50956-113">更像创建用户帐户，可以验证凭据以编程方式或以声明方式。</span><span class="sxs-lookup"><span data-stu-id="50956-113">Much like with creating user accounts, credentials can be validated programmatically or declaratively.</span></span> <span data-ttu-id="50956-114">成员资格 API 包括用于以编程方式验证用户的凭据对用户存储区的方法。</span><span class="sxs-lookup"><span data-stu-id="50956-114">The Membership API includes a method for programmatically validating a user's credentials against the user store.</span></span> <span data-ttu-id="50956-115">和 ASP.NET 附带了登录 Web 控件，用于呈现具有文本框用于用户名和密码和一个按钮，用于登录的用户界面。</span><span class="sxs-lookup"><span data-stu-id="50956-115">And ASP.NET ships with the Login Web control, which renders a user interface with textboxes for the username and password and a button to log in.</span></span>

<span data-ttu-id="50956-116">在本教程中，我们将说明如何验证根据使用的编程方法和 Login 控件的成员身份用户存储区的用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-116">In this tutorial we will examine how to validate a user's credentials against the Membership user store using both programmatic means and the Login control.</span></span> <span data-ttu-id="50956-117">我们还将介绍如何自定义登录控件的外观和行为。</span><span class="sxs-lookup"><span data-stu-id="50956-117">We will also look at how to customize the login control's appearance and behavior.</span></span> <span data-ttu-id="50956-118">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="50956-118">Let's get started!</span></span>

## <a name="step-1-validating-credentials-against-the-membership-user-store"></a><span data-ttu-id="50956-119">步骤 1：针对成员身份用户存储验证凭据</span><span class="sxs-lookup"><span data-stu-id="50956-119">Step 1: Validating Credentials Against the Membership User Store</span></span>

<span data-ttu-id="50956-120">对于使用 forms 身份验证的网站，用户登录到网站访问登录页并输入其凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-120">For web sites that use forms authentication, a user logs on to the website by visiting a login page and entering their credentials.</span></span> <span data-ttu-id="50956-121">然后，对用户存储比较这些凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-121">These credentials are then compared against the user store.</span></span> <span data-ttu-id="50956-122">如果它们是有效，然后向用户授予窗体身份验证票证，这是一个安全标记，指示的标识和访问者的真实性。</span><span class="sxs-lookup"><span data-stu-id="50956-122">If they are valid, then the user is granted a forms authentication ticket, which is a security token that indicates the identity and authenticity of the visitor.</span></span>

<span data-ttu-id="50956-123">若要验证对成员资格框架用户，请使用`Membership`类的[`ValidateUser`方法](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="50956-123">To validate a user against the Membership framework, use the `Membership` class's [`ValidateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx).</span></span> <span data-ttu-id="50956-124">`ValidateUser`方法采用两个输入参数的*`username`* 并*`password`* -并返回指示凭据有效的布尔值。</span><span class="sxs-lookup"><span data-stu-id="50956-124">The `ValidateUser` method takes in two input parameters - *`username`* and *`password`* - and returns a Boolean value indicating whether the credentials were valid.</span></span> <span data-ttu-id="50956-125">与处理方式一样`CreateUser`方法在上一教程中，我们探讨`ValidateUser`方法委托实际验证到已配置的成员资格提供程序。</span><span class="sxs-lookup"><span data-stu-id="50956-125">Like with the `CreateUser` method we examined in the previous tutorial, the `ValidateUser` method delegates the actual validation to the configured Membership provider.</span></span>

<span data-ttu-id="50956-126">`SqlMembershipProvider`验证所提供的凭据通过获取指定的用户的密码通过`aspnet_Membership_GetPasswordWithFormat`存储过程。</span><span class="sxs-lookup"><span data-stu-id="50956-126">The `SqlMembershipProvider` validates the supplied credentials by obtaining the specified user's password via the `aspnet_Membership_GetPasswordWithFormat` stored procedure.</span></span> <span data-ttu-id="50956-127">请记住，`SqlMembershipProvider`存储用户的密码使用三种格式之一： 清除，加密的或进行哈希处理。</span><span class="sxs-lookup"><span data-stu-id="50956-127">Recall that the `SqlMembershipProvider` stores users' passwords using one of three formats: clear, encrypted, or hashed.</span></span> <span data-ttu-id="50956-128">`aspnet_Membership_GetPasswordWithFormat`存储的过程返回的密码以其原始格式。</span><span class="sxs-lookup"><span data-stu-id="50956-128">The `aspnet_Membership_GetPasswordWithFormat` stored procedure returns the password in its raw format.</span></span> <span data-ttu-id="50956-129">对于加密或哈希密码，`SqlMembershipProvider`转换*`password`* 值传递到`ValidateUser`方法转换成其等效加密或哈希处理状态，然后将其与从已返回的内容数据库。</span><span class="sxs-lookup"><span data-stu-id="50956-129">For encrypted or hashed passwords, the `SqlMembershipProvider` transforms the *`password`* value passed into the `ValidateUser` method into its equivalent encrypted or hashed state and then compares it with what was returned from the database.</span></span> <span data-ttu-id="50956-130">如果在数据库中存储的密码与用户输入的格式化的密码匹配，凭据有效。</span><span class="sxs-lookup"><span data-stu-id="50956-130">If the password stored in the database matches the formatted password entered by the user, the credentials are valid.</span></span>

<span data-ttu-id="50956-131">让我们更新我们的登录页面 (~ /`Login.aspx`)，以便验证成员资格框架用户存储区对提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-131">Let's update our login page (~/`Login.aspx`) so that it validates the supplied credentials against the Membership framework user store.</span></span> <span data-ttu-id="50956-132">我们创建了此登录页回到<a id="Tutorial02"> </a> [*概述的窗体身份验证*](../introduction/an-overview-of-forms-authentication-cs.md)教程中，使用两个文本框输入用户名和密码，创建一个接口记住我复选框，并登录按钮 （请参阅图 1）。</span><span class="sxs-lookup"><span data-stu-id="50956-132">We created this login page back in the <a id="Tutorial02"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, creating an interface with two TextBoxes for the username and password, a Remember Me checkbox, and a Login button (see Figure 1).</span></span> <span data-ttu-id="50956-133">代码验证输入的凭据与硬编码的用户名和密码对 （Scott/密码、 Jisun/密码和 Sam/密码） 的列表。</span><span class="sxs-lookup"><span data-stu-id="50956-133">The code validates the entered credentials against a hard-coded list of username and password pairs (Scott/password, Jisun/password, and Sam/password).</span></span> <span data-ttu-id="50956-134">在中<a id="Tutorial03"> </a> [*窗体身份验证配置和高级主题*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md)教程，我们更新了登录页面的代码以在窗体中存储的其他信息身份验证票证`UserData`属性。</span><span class="sxs-lookup"><span data-stu-id="50956-134">In the <a id="Tutorial03"></a>[*Forms Authentication Configuration and Advanced Topics*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md) tutorial we updated the login page's code to store additional information in the forms authentication ticket's `UserData` property.</span></span>

<span data-ttu-id="50956-135">[![登录页面的接口包含两个文本框、 CheckBoxList 和一个按钮](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="50956-135">[![The Login Page's Interface Includes Two TextBoxes, a CheckBoxList, and a Button](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)</span></span>

<span data-ttu-id="50956-136">**图 1**:登录页面的接口包括两个文本框、 CheckBoxList 和一个按钮 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="50956-136">**Figure 1**: The Login Page's Interface Includes Two TextBoxes, a CheckBoxList, and a Button  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png))</span></span>

<span data-ttu-id="50956-137">登录页的用户界面可保持不变，但我们需要将登录按钮为`Click`验证成员资格框架用户存储区对用户代码与事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="50956-137">The login page's user interface can remain unchanged, but we need to replace the Login button's `Click` event handler with code that validates the user against the Membership framework user store.</span></span> <span data-ttu-id="50956-138">更新事件处理程序，使其代码如下所示：</span><span class="sxs-lookup"><span data-stu-id="50956-138">Update the event handler so that its code appears as follows:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample1.cs)]

<span data-ttu-id="50956-139">此代码是非常简单。</span><span class="sxs-lookup"><span data-stu-id="50956-139">This code is remarkably simple.</span></span> <span data-ttu-id="50956-140">我们首先调用`Membership.ValidateUser`方法，传入提供的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="50956-140">We start by calling the `Membership.ValidateUser` method, passing in the supplied username and password.</span></span> <span data-ttu-id="50956-141">如果该方法返回 true，则用户登录到的站点通过`FormsAuthentication`类的 RedirectFromLoginPage 方法。</span><span class="sxs-lookup"><span data-stu-id="50956-141">If that method returns true, then the user is signed into the site via the `FormsAuthentication` class's RedirectFromLoginPage method.</span></span> <span data-ttu-id="50956-142">(如中所述<a id="Tutorial2"> </a> [*概述的窗体身份验证*](../introduction/an-overview-of-forms-authentication-cs.md)教程中，`FormsAuthentication.RedirectFromLoginPage`创建窗体身份验证票证，然后将用户重定向适当的页。）如果凭据无效，但是，`InvalidCredentialsMessage`显示标签，则通知用户其用户名或密码不正确。</span><span class="sxs-lookup"><span data-stu-id="50956-142">(As we discussed in the <a id="Tutorial2"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, the `FormsAuthentication.RedirectFromLoginPage` creates the forms authentication ticket and then redirects the user to the appropriate page.) If the credentials are invalid, however, the `InvalidCredentialsMessage` Label is displayed, informing the user that their username or password was incorrect.</span></span>

<span data-ttu-id="50956-143">就这么简单！</span><span class="sxs-lookup"><span data-stu-id="50956-143">That's all there is to it!</span></span>

<span data-ttu-id="50956-144">若要测试登录页按预期方式工作，请尝试使用在前面的教程中创建的用户帐户之一登录。</span><span class="sxs-lookup"><span data-stu-id="50956-144">To test that the login page works as expected, attempt to login with one of the user accounts you created in the preceding tutorial.</span></span> <span data-ttu-id="50956-145">或者，如果尚未创建一个帐户，请继续并创建一个从`~/Membership/CreatingUserAccounts.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="50956-145">Or, if you have not yet created an account, go ahead and create one from the `~/Membership/CreatingUserAccounts.aspx` page.</span></span>

> [!NOTE]
> <span data-ttu-id="50956-146">当用户输入其凭据并将在登录页表单提交时，通过 Internet 到 web 服务器中传输凭据，包括她的密码，*纯文本*。</span><span class="sxs-lookup"><span data-stu-id="50956-146">When the user enters her credentials and submits the login page form, the credentials, including her password, are transmitted over the Internet to the web server in *plain text*.</span></span> <span data-ttu-id="50956-147">这意味着任何探查的网络流量的黑客可以看到的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="50956-147">That means any hacker sniffing the network traffic can see the username and password.</span></span> <span data-ttu-id="50956-148">若要防止此情况，是必须使用加密的网络流量[安全套接字层 (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer)。</span><span class="sxs-lookup"><span data-stu-id="50956-148">To prevent this, it is essential to encrypt the network traffic by using [Secure Socket Layers (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer).</span></span> <span data-ttu-id="50956-149">这将确保从那一刻起，它们将保留在浏览器，直到 web 服务器接收加密的凭据 （以及整个页面的 HTML 标记）。</span><span class="sxs-lookup"><span data-stu-id="50956-149">This will ensure that the credentials (as well as the entire page's HTML markup) are encrypted from the moment they leave the browser until they are received by the web server.</span></span>

### <a name="how-the-membership-framework-handles-invalid-login-attempts"></a><span data-ttu-id="50956-150">成员资格框架如何处理无效的登录尝试次数</span><span class="sxs-lookup"><span data-stu-id="50956-150">How the Membership Framework Handles Invalid Login Attempts</span></span>

<span data-ttu-id="50956-151">当在访问者达到登录页，并提交其凭据时，其浏览器发出 HTTP 请求到登录页。</span><span class="sxs-lookup"><span data-stu-id="50956-151">When a visitor reaches the login page and submits their credentials, their browser makes an HTTP request to the login page.</span></span> <span data-ttu-id="50956-152">如果凭据有效，HTTP 响应将包括在 cookie 中的身份验证票证。</span><span class="sxs-lookup"><span data-stu-id="50956-152">If the credentials are valid, the HTTP response includes the authentication ticket in a cookie.</span></span> <span data-ttu-id="50956-153">因此，黑客试图进入你的站点无法创建彻底将 HTTP 请求发送到包含有效的用户名和密码猜测的登录页的程序。</span><span class="sxs-lookup"><span data-stu-id="50956-153">Therefore, a hacker attempting to break into your site could create a program that exhaustively sends HTTP requests to the login page with a valid username and a guess at the password.</span></span> <span data-ttu-id="50956-154">如果密码猜测值正确无误，请登录页将返回身份验证票证 cookie，此时该程序知道它有偶然发现有效的用户名/密码对。</span><span class="sxs-lookup"><span data-stu-id="50956-154">If the password guess is correct, the login page will return the authentication ticket cookie, at which point the program knows it has stumbled upon a valid username/password pair.</span></span> <span data-ttu-id="50956-155">通过暴力破解此类程序可能能够发现用户的密码，尤其是在弱密码时。</span><span class="sxs-lookup"><span data-stu-id="50956-155">Through brute force, such a program might be able to stumble upon a user's password, especially if the password is weak.</span></span>

<span data-ttu-id="50956-156">若要防止此类暴力破解攻击，成员资格框架锁定用户是否存在一定数量的一段时间内的失败登录尝试。</span><span class="sxs-lookup"><span data-stu-id="50956-156">To prevent such brute force attacks, the Membership framework locks out a user if there are a certain number of unsuccessful login attempts within a certain period of time.</span></span> <span data-ttu-id="50956-157">确切的参数是可通过以下两个成员资格提供程序配置设置配置：</span><span class="sxs-lookup"><span data-stu-id="50956-157">The exact parameters are configurable through the following two Membership provider configuration settings:</span></span>

- <span data-ttu-id="50956-158">`maxInvalidPasswordAttempts` -指定多少次无效密码尝试在该帐户锁定前的时间段内只允许用户。默认值为 5。</span><span class="sxs-lookup"><span data-stu-id="50956-158">`maxInvalidPasswordAttempts` - specifies how many invalid password attempts are allowed for the user within the time period before the account is locked out. The default value is 5.</span></span>
- <span data-ttu-id="50956-159">`passwordAttemptWindow` -指示以分钟为单位指定无效的登录尝试次数将在此期间导致帐户被锁定的时间段。默认值为 10。</span><span class="sxs-lookup"><span data-stu-id="50956-159">`passwordAttemptWindow` - indicates the time period in minutes during which the specified number of invalid login attempts will cause the account to be locked out. The default value is 10.</span></span>

<span data-ttu-id="50956-160">如果用户已锁定，她不能登录直到管理员解除锁定她的帐户。</span><span class="sxs-lookup"><span data-stu-id="50956-160">If a user has been locked out, she cannot login until an administrator unlocks her account.</span></span> <span data-ttu-id="50956-161">当用户锁定`ValidateUser`方法将*始终*返回`false`，即使在提供有效凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-161">When a user is locked out, the `ValidateUser` method will *always* return `false`, even if valid credentials are supplied.</span></span> <span data-ttu-id="50956-162">虽然此行为可以减少黑客通过暴力破解方法将为你的站点中断的可能性，则它可能出现锁定只是忘记了密码或意外大写锁定或有错误的类型化一天的有效用户。</span><span class="sxs-lookup"><span data-stu-id="50956-162">While this behavior lessens the likelihood that a hacker will break into your site through brute force methods, it can end up locking out a valid user who has simply forgotten her password or accidentally has the Caps Lock on or is having a bad typing day.</span></span>

<span data-ttu-id="50956-163">遗憾的是，没有内置工具用于解锁用户帐户。</span><span class="sxs-lookup"><span data-stu-id="50956-163">Unfortunately, there is no built-in tool for unlocking a user account.</span></span> <span data-ttu-id="50956-164">若要解锁帐户，可以修改数据库直接-更改`IsLockedOut`字段中`aspnet_Membership`相应的用户帐户中的表或创建一个基于 web 的界面，其中列出了锁定的并且可以选择解锁帐户。</span><span class="sxs-lookup"><span data-stu-id="50956-164">In order to unlock an account, you can modify the database directly - change the `IsLockedOut` field in the `aspnet_Membership` table for the appropriate user account - or create a web-based interface that lists locked out accounts with options to unlock them.</span></span> <span data-ttu-id="50956-165">我们将检查创建的管理接口，用于在以后的教程中实现常见的用户帐户和角色相关任务。</span><span class="sxs-lookup"><span data-stu-id="50956-165">We will examine creating administrative interfaces for accomplishing common user account- and role-related tasks in a future tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="50956-166">一个缺点`ValidateUser`方法是，所提供的凭据无效时，它不提供任何说明，解释原因。</span><span class="sxs-lookup"><span data-stu-id="50956-166">One downside of the `ValidateUser` method is that when the supplied credentials are invalid, it does not provide any explanation as to why.</span></span> <span data-ttu-id="50956-167">凭据可能无效，原因是未匹配的用户名/密码对在用户存储中，或因为用户尚未批准，或者因为用户锁定。在步骤 4 中，我们将了解如何在其登录尝试失败时向用户显示更详细的消息。</span><span class="sxs-lookup"><span data-stu-id="50956-167">The credentials may be invalid because there is no matching username/password pair in the user store, or because the user has not yet been approved, or because the user has been locked out. In Step 4 we will see how to show a more detailed message to the user when their login attempt fails.</span></span>

## <a name="step-2-collecting-credentials-through-the-login-web-control"></a><span data-ttu-id="50956-168">步骤 2：通过登录 Web 控件收集凭据</span><span class="sxs-lookup"><span data-stu-id="50956-168">Step 2: Collecting Credentials through the Login Web Control</span></span>

<span data-ttu-id="50956-169">[登录 Web 控件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)呈现非常类似于我们在回复中创建的一个默认用户界面<a id="SKM5"> </a> [*概述的窗体身份验证*](../introduction/an-overview-of-forms-authentication-cs.md)教程。</span><span class="sxs-lookup"><span data-stu-id="50956-169">The [Login Web control](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx) renders a default user interface very similar to the one we created back in the <a id="SKM5"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial.</span></span> <span data-ttu-id="50956-170">使用登录控件为我们节省的无需创建要收集访问者的凭据的接口的工作。</span><span class="sxs-lookup"><span data-stu-id="50956-170">Using the Login control saves us the work of having to create the interface to collect the visitor�s credentials.</span></span> <span data-ttu-id="50956-171">此外，登录控件会自动登录用户 （假设已提交的凭据有效），从而节省了我们无需编写任何代码。</span><span class="sxs-lookup"><span data-stu-id="50956-171">Moreover, the Login control automatically signs in the user (assuming the submitted credentials are valid), thereby saving us from having to write any code.</span></span>

<span data-ttu-id="50956-172">让我们更新`Login.aspx`、 替换手动创建的接口和与登录控件编写代码。</span><span class="sxs-lookup"><span data-stu-id="50956-172">Let's update `Login.aspx`, replacing the manually created interface and code with a Login control.</span></span> <span data-ttu-id="50956-173">首先删除现有标记和代码中`Login.aspx`。</span><span class="sxs-lookup"><span data-stu-id="50956-173">Start by removing the existing markup and code in `Login.aspx`.</span></span> <span data-ttu-id="50956-174">可能会删除彻底，或只需注释掉。注释掉声明性标记，可以使用与其周围`<%--`和`--%>`分隔符。</span><span class="sxs-lookup"><span data-stu-id="50956-174">You may delete it outright, or simply comment it out. To comment out declarative markup, surround it with the `<%--` and `--%>` delimiters.</span></span> <span data-ttu-id="50956-175">可以手动输入这些分隔符，或如图 2 所示，可以选择要添加注释，然后单击工具栏中的选定的行图标注释的文本。</span><span class="sxs-lookup"><span data-stu-id="50956-175">You can enter these delimiters manually, or, as Figure 2 shows, you may select the text to comment out and then click the Comment out the selected lines icon in the Toolbar.</span></span> <span data-ttu-id="50956-176">同样，可以使用注释掉的选定的行图标注释掉的代码隐藏类中的所选代码。</span><span class="sxs-lookup"><span data-stu-id="50956-176">Similarly, you can use the Comment out the selected lines icon to comment out the selected code in the code-behind class.</span></span>

<span data-ttu-id="50956-177">[![注释掉的现有声明性标记和 login.aspx 的情况中的源代码](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="50956-177">[![Comment Out the Existing Declarative Markup and Source Code in Login.aspx](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)</span></span>

<span data-ttu-id="50956-178">**图 2**:注释掉现有声明性标记和中的源代码`Login.aspx`([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="50956-178">**Figure 2**: Comment Out the Existing Declarative Markup and Source Code in `Login.aspx` ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))</span></span>

> [!NOTE]
> <span data-ttu-id="50956-179">在 Visual Studio 2005 中查看的声明性标记时，注释掉的选定的行图标不可用。</span><span class="sxs-lookup"><span data-stu-id="50956-179">The Comment out the selected lines icon is not available when viewing the declarative markup in Visual Studio 2005.</span></span> <span data-ttu-id="50956-180">如果不使用 Visual Studio 2008 将需要手动添加`<%--`和`--%>`分隔符。</span><span class="sxs-lookup"><span data-stu-id="50956-180">If you are not using Visual Studio 2008 you will need to manually add the `<%--` and `--%>` delimiters.</span></span>

<span data-ttu-id="50956-181">接下来，从工具箱拖到页上将登录控件，然后设置其`ID`属性设置为`myLogin`。</span><span class="sxs-lookup"><span data-stu-id="50956-181">Next, drag a Login control from the Toolbox on to the page and set its `ID` property to `myLogin`.</span></span> <span data-ttu-id="50956-182">此时您的屏幕应类似于图 3。</span><span class="sxs-lookup"><span data-stu-id="50956-182">At this point your screen should look similar to Figure 3.</span></span> <span data-ttu-id="50956-183">请注意，登录名控件的默认接口包括用于用户名和密码，下次记住我复选框，和一个日志中按钮的文本框控件。</span><span class="sxs-lookup"><span data-stu-id="50956-183">Note that the Login control's default interface includes TextBox controls for the username and password, a Remember me next time CheckBox, and a Log In Button.</span></span> <span data-ttu-id="50956-184">此外，还有`RequiredFieldValidator`的两个文本框控件。</span><span class="sxs-lookup"><span data-stu-id="50956-184">There are also `RequiredFieldValidator` controls for the two TextBoxes.</span></span>

<span data-ttu-id="50956-185">[![将登录控件添加到页面](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="50956-185">[![Add a Login Control to the Page](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)</span></span>

<span data-ttu-id="50956-186">**图 3**:将登录控件添加到页 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="50956-186">**Figure 3**: Add a Login Control to the Page  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))</span></span>

<span data-ttu-id="50956-187">大功告成 ！</span><span class="sxs-lookup"><span data-stu-id="50956-187">And we're done!</span></span> <span data-ttu-id="50956-188">单击登录控件的登录按钮时，会发生回发和登录控件将调用`Membership.ValidateUser`方法，传入的输入的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="50956-188">When the Login control's Log In button is clicked, a postback will occur and the Login control will call the `Membership.ValidateUser` method, passing in the entered username and password.</span></span> <span data-ttu-id="50956-189">如果凭据无效，该登录名控件将显示一条消息表明此类。</span><span class="sxs-lookup"><span data-stu-id="50956-189">If the credentials are invalid, the Login control displays a message stating such.</span></span> <span data-ttu-id="50956-190">但是，如果凭据有效，然后登录控件创建窗体身份验证票证，并将用户重定向到相应的页面。</span><span class="sxs-lookup"><span data-stu-id="50956-190">If, however, the credentials are valid, then the Login control creates the forms authentication ticket and redirects the user to the appropriate page.</span></span>

<span data-ttu-id="50956-191">Login 控件使用四个因素来确定合适的页面重定向到用户成功登录后：</span><span class="sxs-lookup"><span data-stu-id="50956-191">The Login control uses four factors to determine the appropriate page to redirect the user to upon a successful login:</span></span>

- <span data-ttu-id="50956-192">Login 控件是否登录页上定义的`loginUrl`设置在窗体身份验证配置中，此设置的默认值是 `Login.aspx`</span><span class="sxs-lookup"><span data-stu-id="50956-192">Whether the Login control is on the login page as defined by `loginUrl` setting in the forms authentication configuration; this setting's default value is `Login.aspx`</span></span>
- <span data-ttu-id="50956-193">是否存在`ReturnUrl`查询字符串参数</span><span class="sxs-lookup"><span data-stu-id="50956-193">The presence of a `ReturnUrl` querystring parameter</span></span>
- <span data-ttu-id="50956-194">登录名控件的值[`DestinationUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)</span><span class="sxs-lookup"><span data-stu-id="50956-194">The value of the Login control's [`DestinationUrl` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)</span></span>
- <span data-ttu-id="50956-195">`defaultUrl`中窗体身份验证配置设置指定的值; 此设置的默认值为 `Default.aspx`</span><span class="sxs-lookup"><span data-stu-id="50956-195">The `defaultUrl` value specified in the forms authentication configuration settings; this setting's default value is `Default.aspx`</span></span>

<span data-ttu-id="50956-196">图 4 展示了如何登录控件使用以下四个参数以获得其相应的页决策。</span><span class="sxs-lookup"><span data-stu-id="50956-196">Figure 4 depicts the how the Login control uses these four parameters to arrive at its appropriate page decision.</span></span>

<span data-ttu-id="50956-197">[![将登录控件添加到页面](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="50956-197">[![Add a Login Control to the Page](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)</span></span>

<span data-ttu-id="50956-198">**图 4**:将登录控件添加到页 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="50956-198">**Figure 4**: Add a Login Control to the Page  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))</span></span>

<span data-ttu-id="50956-199">请花费片刻时间测试登录控件通过访问的站点通过浏览器并作为成员资格框架中的现有用户登录。</span><span class="sxs-lookup"><span data-stu-id="50956-199">Take a moment to test out the Login control by visiting the site through a browser and logging in as an existing user in the Membership framework.</span></span>

<span data-ttu-id="50956-200">登录名控件的呈现的接口是高度可配置。</span><span class="sxs-lookup"><span data-stu-id="50956-200">The Login control's rendered interface is highly configurable.</span></span> <span data-ttu-id="50956-201">有多种会影响它的外观; 的属性更重要的是，Login 控件可转换为精确地对布局控件的模板的用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="50956-201">There are a number of properties that influence its appearance; what's more, the Login control can be converted into a template for precise control over the layout the user interface elements.</span></span> <span data-ttu-id="50956-202">此步骤的其余部分探讨如何自定义外观和布局。</span><span class="sxs-lookup"><span data-stu-id="50956-202">The remainder of this step examines how to customize the appearance and layout.</span></span>

### <a name="customizing-the-login-controls-appearance"></a><span data-ttu-id="50956-203">自定义登录控件的外观</span><span class="sxs-lookup"><span data-stu-id="50956-203">Customizing the Login Control's Appearance</span></span>

<span data-ttu-id="50956-204">登录名控件的默认属性设置呈现以标题 （日志） 的用户界面，为用户名和密码输入，记住我的 TextBox 和 Label 控件下次复选框和一个登录按钮。</span><span class="sxs-lookup"><span data-stu-id="50956-204">The Login control's default property settings render a user interface with a title ( Log In ), TextBox and Label controls for the username and password inputs, a Remember me next time CheckBox, and a Log In button.</span></span> <span data-ttu-id="50956-205">这些元素的外观是所有可配置通过登录名控件的许多属性。</span><span class="sxs-lookup"><span data-stu-id="50956-205">The appearances of these elements are all configurable through the Login control's numerous properties.</span></span> <span data-ttu-id="50956-206">此外，可以通过设置的属性或两个添加附加用户界面元素-例如，若要创建新的用户帐户的页面的链接。</span><span class="sxs-lookup"><span data-stu-id="50956-206">Furthermore, additional user interface elements - such as a link to a page to create a new user account - can be added by setting a property or two.</span></span>

<span data-ttu-id="50956-207">让我们花一些时间才能 gussy 向上我们登录控件的外观。</span><span class="sxs-lookup"><span data-stu-id="50956-207">Let's spend a few moments to gussy up the appearance of our Login control.</span></span> <span data-ttu-id="50956-208">由于`Login.aspx`的页面已具有显示登录页顶部的文本、 登录控件的标题是多余。</span><span class="sxs-lookup"><span data-stu-id="50956-208">Since the `Login.aspx` page already has text at the top of the page that says Login, the Login control's title is superfluous.</span></span> <span data-ttu-id="50956-209">因此，清除[`TitleText`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx)值，以便删除登录名控件的标题。</span><span class="sxs-lookup"><span data-stu-id="50956-209">Therefore, clear out the [`TitleText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx) value in order to remove the Login control's title.</span></span>

<span data-ttu-id="50956-210">用户名: 和密码：可以通过自定义的两个 TextBox 控件左侧标签[ `UserNameLabelText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx)并[`PasswordLabelText`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx)分别。</span><span class="sxs-lookup"><span data-stu-id="50956-210">The User Name: and Password: Labels to the left of the two TextBox controls can be customized through the [`UserNameLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) and [`PasswordLabelText` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx), respectively.</span></span> <span data-ttu-id="50956-211">让我们更改的用户名称：若要读取 Username 的标签:。</span><span class="sxs-lookup"><span data-stu-id="50956-211">Let's change the User Name: Label to read Username:.</span></span> <span data-ttu-id="50956-212">是通过可配置的标签和文本框样式[ `LabelStyle` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx)并[`TextBoxStyle`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx)分别。</span><span class="sxs-lookup"><span data-stu-id="50956-212">The Label and TextBox styles are configurable through the [`LabelStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx) and [`TextBoxStyle` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx), respectively.</span></span>

<span data-ttu-id="50956-213">记住我可以通过登录控件设置下一步时间复选框的文本属性[ `RememberMeText property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx)，并且其默认检查状态是可通过配置[ `RememberMeSet property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (默认为 False）。</span><span class="sxs-lookup"><span data-stu-id="50956-213">The Remember me next time CheckBox's Text property can be set through the Login control's [`RememberMeText property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx), and its default checked state is configurable through the [`RememberMeSet property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (which defaults to False).</span></span> <span data-ttu-id="50956-214">继续操作并设置`RememberMeSet`将默认情况下选中属性设置为 True，以便记住我下次复选框。</span><span class="sxs-lookup"><span data-stu-id="50956-214">Go ahead and set the `RememberMeSet` property to True so that the Remember me next time CheckBox will be checked by default.</span></span>

<span data-ttu-id="50956-215">Login 控件提供了两个调整其用户界面控件的布局的属性。</span><span class="sxs-lookup"><span data-stu-id="50956-215">The Login control offers two properties for adjusting the layout of its user interface controls.</span></span> <span data-ttu-id="50956-216">[ `TextLayout property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx)指示是否用户名: 和密码：标签显示的其对应的文本框 （默认值），或更高版本其左侧。</span><span class="sxs-lookup"><span data-stu-id="50956-216">The [`TextLayout property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx) indicates whether the Username: and Password: Labels appear to the left of their corresponding TextBoxes (the default), or above them.</span></span> <span data-ttu-id="50956-217">[ `Orientation property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx)指示的用户名和密码输入是否垂直位置 （上下一个） 或水平。</span><span class="sxs-lookup"><span data-stu-id="50956-217">The [`Orientation property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx) indicates whether the username and password inputs are situated vertically (one above the other) or horizontally.</span></span> <span data-ttu-id="50956-218">我打算保留这两个属性设置为其默认值，但我建议您尝试将这两个属性设置为其非默认值，以查看产生的效果。</span><span class="sxs-lookup"><span data-stu-id="50956-218">I am going to leave these two properties set to their defaults, but I encourage you to try setting these two properties to their non-default values to see the resulting effect.</span></span>

> [!NOTE]
> <span data-ttu-id="50956-219">在下一步部分中，配置登录名控件的布局中，我们将介绍如何使用模板来定义精确布局控件的用户界面元素的布局。</span><span class="sxs-lookup"><span data-stu-id="50956-219">In the next section, Configuring the Login Control's Layout, we will look at using templates to define the precise layout of the Layout control's user interface elements.</span></span>

<span data-ttu-id="50956-220">通过设置登录名控件的属性设置进行总结[ `CreateUserText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx)和[`CreateUserUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx)为 Not 尚未注册？</span><span class="sxs-lookup"><span data-stu-id="50956-220">Wrap up the Login control's property settings by setting the [`CreateUserText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx) and [`CreateUserUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx) to Not registered yet?</span></span> <span data-ttu-id="50956-221">创建一个帐户 ！</span><span class="sxs-lookup"><span data-stu-id="50956-221">Create an account!</span></span> <span data-ttu-id="50956-222">和`~/Membership/CreatingUserAccounts.aspx`分别。</span><span class="sxs-lookup"><span data-stu-id="50956-222">and `~/Membership/CreatingUserAccounts.aspx`, respectively.</span></span> <span data-ttu-id="50956-223">这将超链接添加到登录控件的接口中创建指向页面<a id="SKM6"> </a>[前面的教程](creating-user-accounts-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="50956-223">This adds a hyperlink to the Login control's interface pointing to the page we created in the <a id="SKM6"></a>[preceding tutorial](creating-user-accounts-cs.md).</span></span> <span data-ttu-id="50956-224">Login 控件[ `HelpPageText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx)并[`HelpPageUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx)并[ `PasswordRecoveryText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx)和[ `PasswordRecoveryUrl` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx)即可在同样的方式呈现帮助页和密码恢复页的链接。</span><span class="sxs-lookup"><span data-stu-id="50956-224">The Login control's [`HelpPageText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx) and [`HelpPageUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx) and [`PasswordRecoveryText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx) and [`PasswordRecoveryUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx) work in the same manner, rendering links to a help page and a password recovery page.</span></span>

<span data-ttu-id="50956-225">这些属性更改后，请登录控件的声明性标记和外观应类似于图 5 中所示。</span><span class="sxs-lookup"><span data-stu-id="50956-225">After making these property changes, your Login control's declarative markup and appearance should look similar to that shown in Figure 5.</span></span>

<span data-ttu-id="50956-226">[![登录名控件的属性值指示其外观](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="50956-226">[![The Login Control's Properties' Values Dictate Its Appearance](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)</span></span>

<span data-ttu-id="50956-227">**图 5**:登录名控件的属性值指示其外观 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="50956-227">**Figure 5**: The Login Control's Properties' Values Dictate Its Appearance  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))</span></span>

### <a name="configuring-the-login-controls-layout"></a><span data-ttu-id="50956-228">配置登录名控件的布局</span><span class="sxs-lookup"><span data-stu-id="50956-228">Configuring the Login Control's Layout</span></span>

<span data-ttu-id="50956-229">登录 Web 控件的默认用户界面布局中对应的 HTML 界面`<table>`。</span><span class="sxs-lookup"><span data-stu-id="50956-229">The Login Web control's default user interface lays out the interface in an HTML `<table>`.</span></span> <span data-ttu-id="50956-230">但是，如果我们需要更好地控制呈现的输出？</span><span class="sxs-lookup"><span data-stu-id="50956-230">But what if we need finer control over the rendered output?</span></span> <span data-ttu-id="50956-231">我们想要替换的也许`<table>`使用一系列`<div>`标记。</span><span class="sxs-lookup"><span data-stu-id="50956-231">Maybe we want to replace the `<table>` with a series of `<div>` tags.</span></span> <span data-ttu-id="50956-232">或者，如果我们的应用程序需要其他凭据进行身份验证？</span><span class="sxs-lookup"><span data-stu-id="50956-232">Or what if our application requires additional credentials for authentication?</span></span> <span data-ttu-id="50956-233">很多财务网站，例如，要求用户提供不仅用户名和密码，但还个人标识号 (PIN) 或其他标识信息。</span><span class="sxs-lookup"><span data-stu-id="50956-233">Many financial websites, for instance, require users to supply not only a username and password, but also a Personal Identification Number (PIN), or other identifying information.</span></span> <span data-ttu-id="50956-234">无论原因可能包括，则可以登录控件转换为模板，在其中我们可以显式定义接口的声明性标记。</span><span class="sxs-lookup"><span data-stu-id="50956-234">Whatever the reasons may be, it is possible to convert the Login control into a template, from which we can explicitly define the interface's declarative markup.</span></span>

<span data-ttu-id="50956-235">我们需要做两件事，以更新要收集其他凭据的登录控件：</span><span class="sxs-lookup"><span data-stu-id="50956-235">We need to do two things in order to update the Login control to collect additional credentials:</span></span>

1. <span data-ttu-id="50956-236">更新登录名控件的界面，包括 Web 控件包装要收集的其他凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-236">Update the Login control's interface to include Web control(s) to collect the additional credentials.</span></span>
2. <span data-ttu-id="50956-237">重写登录控件内部身份验证逻辑，以便用户只能进行身份验证，如果其用户名和密码有效，并且也是有效的其其他凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-237">Override the Login control's internal authentication logic so that a user is only authenticated if their username and password is valid and their additional credentials are valid, too.</span></span>

<span data-ttu-id="50956-238">若要完成的第一个任务，我们需要登录控件转换为模板并添加所需的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="50956-238">To accomplish the first task, we need to convert the Login control into a template and add the necessary Web controls.</span></span> <span data-ttu-id="50956-239">与第二个任务，则可以通过创建控件的事件处理程序取代登录控件的身份验证逻辑[`Authenticate`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)。</span><span class="sxs-lookup"><span data-stu-id="50956-239">As for the second task, the Login control's authentication logic can be superseded by creating an event handler for the control's [`Authenticate` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).</span></span>

<span data-ttu-id="50956-240">让我们更新登录控件，使其提示用户输入其用户名、 密码和电子邮件地址，并仅验证用户身份如果提供的电子邮件地址与在文件上的其电子邮件地址相匹配。</span><span class="sxs-lookup"><span data-stu-id="50956-240">Let's update the Login control so that it prompts users for their username, password, and email address and only authenticates the user if the email address supplied matches their email address on file.</span></span> <span data-ttu-id="50956-241">我们首先需要将登录名控件的界面转换为模板。</span><span class="sxs-lookup"><span data-stu-id="50956-241">We first need to convert the Login control's interface to a template.</span></span> <span data-ttu-id="50956-242">从登录名控件的智能标记，选择转换为模板选项。</span><span class="sxs-lookup"><span data-stu-id="50956-242">From the Login control's Smart Tag, choose the Convert to template option.</span></span>

<span data-ttu-id="50956-243">[![将登录控件转换为模板](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="50956-243">[![Convert the Login Control to a Template](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)</span></span>

<span data-ttu-id="50956-244">**图 6**:将登录控件转换为模板 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="50956-244">**Figure 6**: Convert the Login Control to a Template  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))</span></span>

> [!NOTE]
> <span data-ttu-id="50956-245">若要还原到其预先 template 版本登录控件，单击该控件的智能标记中的重置链接。</span><span class="sxs-lookup"><span data-stu-id="50956-245">To revert the Login control to its pre-template version, click the Reset link from the control's Smart Tag.</span></span>

<span data-ttu-id="50956-246">将登录控件转换为模板将添加`LayoutTemplate`到控件的声明性标记的 HTML 元素和定义用户界面的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="50956-246">Converting the Login control to a template adds a `LayoutTemplate` to the control's declarative markup with HTML elements and Web controls defining the user interface.</span></span> <span data-ttu-id="50956-247">如图 7 所示，将控件转换为模板中删除多个属性从属性窗口中，如`TitleText`， `CreateUserUrl`，依此类推，因为使用模板时，将忽略这些属性值。</span><span class="sxs-lookup"><span data-stu-id="50956-247">As Figure 7 shows, converting the control to a template removes a number of properties from the Properties window, such as `TitleText`, `CreateUserUrl`, and so forth, since these property values are ignored when using a template.</span></span>

<span data-ttu-id="50956-248">[![更少的属性都是可用的时登录控件转换为模板](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="50956-248">[![Fewer Properties are Available When the Login Control is Converted to a Template](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)</span></span>

<span data-ttu-id="50956-249">**图 7**:更少的属性都是可用的时登录控件转换为模板 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="50956-249">**Figure 7**: Fewer Properties are Available When the Login Control is Converted to a Template  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png))</span></span>

<span data-ttu-id="50956-250">中的 HTML 标记`LayoutTemplate`可根据需要修改。</span><span class="sxs-lookup"><span data-stu-id="50956-250">The HTML markup in the `LayoutTemplate` may be modified as needed.</span></span> <span data-ttu-id="50956-251">同样，随意向模板添加任何新的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="50956-251">Likewise, feel free to add any new Web controls to the template.</span></span> <span data-ttu-id="50956-252">但是，很重要，该登录名控件的核心 Web 控件保留在该模板，并保留其分配`ID`值。</span><span class="sxs-lookup"><span data-stu-id="50956-252">However, it is important that Login control's core Web controls remain in the template and keep their assigned `ID` values.</span></span> <span data-ttu-id="50956-253">具体而言，不要删除或重命名`UserName`或`Password`文本框中，`RememberMe`复选框，`LoginButton`按钮，`FailureText`标签，或`RequiredFieldValidator`控件。</span><span class="sxs-lookup"><span data-stu-id="50956-253">In particular, do not remove or rename the `UserName` or `Password` TextBoxes, the `RememberMe` CheckBox, the `LoginButton` Button, the `FailureText` Label, or the `RequiredFieldValidator` controls.</span></span>

<span data-ttu-id="50956-254">若要收集的访问者的电子邮件地址，我们需要向模板添加一个文本框。</span><span class="sxs-lookup"><span data-stu-id="50956-254">To collect the visitor's email address, we need to add a TextBox to the template.</span></span> <span data-ttu-id="50956-255">添加以下声明性标记表行之间 (`<tr>`)，其中包含`Password`文本框和接下来保存记住我的表行的时间复选框：</span><span class="sxs-lookup"><span data-stu-id="50956-255">Add the following declarative markup between the table row (`<tr>`) that contains the `Password` TextBox and the table row that holds the Remember me next time CheckBox:</span></span>

[!code-aspx[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample2.aspx)]

<span data-ttu-id="50956-256">添加后`Email`文本框中，请访问通过浏览器页面。</span><span class="sxs-lookup"><span data-stu-id="50956-256">After adding the `Email` TextBox, visit the page through a browser.</span></span> <span data-ttu-id="50956-257">如图 8 所示，登录名控件的用户界面现在包括第三个文本框。</span><span class="sxs-lookup"><span data-stu-id="50956-257">As Figure 8 shows, the Login control's user interface now includes a third textbox.</span></span>

<span data-ttu-id="50956-258">[![Login 控件现在包括用户的电子邮件地址的文本框](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="50956-258">[![The Login Control Now Includes a Textbox for the User's Email Address](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)</span></span>

<span data-ttu-id="50956-259">**图 8**:Login 控件现在包括用户的电子邮件地址的文本框中 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="50956-259">**Figure 8**: The Login Control Now Includes a Textbox for the User's Email Address  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png))</span></span>

<span data-ttu-id="50956-260">此时，Login 控件仍在使用`Membership.ValidateUser`方法来验证所提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-260">At this point, the Login control is still using the `Membership.ValidateUser` method to validate the supplied credentials.</span></span> <span data-ttu-id="50956-261">相应地，在输入值`Email`文本框中不存在任何上用户可以登录。</span><span class="sxs-lookup"><span data-stu-id="50956-261">Correspondingly, the value entered into the `Email` TextBox has no bearing on whether the user can log in.</span></span> <span data-ttu-id="50956-262">在步骤 3 中，我们将介绍如何重写登录控件的身份验证逻辑，以便凭据仅被视为有效的用户名和密码有效且提供的电子邮件地址与在文件上的电子邮件地址匹配如果。</span><span class="sxs-lookup"><span data-stu-id="50956-262">In Step 3 we will look at how to override the Login control's authentication logic so that the credentials are only considered valid if the username and password are valid and the supplied email address matches up with the email address on file.</span></span>

## <a name="step-3-modifying-the-login-controls-authentication-logic"></a><span data-ttu-id="50956-263">步骤 3：修改登录名控件的身份验证逻辑</span><span class="sxs-lookup"><span data-stu-id="50956-263">Step 3: Modifying the Login Control's Authentication Logic</span></span>

<span data-ttu-id="50956-264">时访问者提供其凭据并单击登录按钮，为在回发时，才会和登录名来控制其身份验证工作流中的进行处理时。</span><span class="sxs-lookup"><span data-stu-id="50956-264">When a visitor supplies her credentials and clicks the Log In button, a postback ensues and the Login control progresses through its authentication workflow.</span></span> <span data-ttu-id="50956-265">工作流开始时引发[`LoggingIn`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx)。</span><span class="sxs-lookup"><span data-stu-id="50956-265">The workflow starts by raising the [`LoggingIn` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx).</span></span> <span data-ttu-id="50956-266">与此事件关联的任何事件处理程序可通过设置取消操作中的日志`e.Cancel`属性设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="50956-266">Any event handlers associated with this event may cancel the log in operation by setting the `e.Cancel` property to `true`.</span></span>

<span data-ttu-id="50956-267">如果在操作中的日志不会被取消，工作流执行过程通过引发[`Authenticate`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)。</span><span class="sxs-lookup"><span data-stu-id="50956-267">If the log in operation is not cancelled, the workflow progresses by raising the [`Authenticate` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).</span></span> <span data-ttu-id="50956-268">如果没有事件处理程序`Authenticate`事件，然后它负责确定提供的凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="50956-268">If there is an event handler for the `Authenticate` event, then it is responsible for determining whether the supplied credentials are valid or not.</span></span> <span data-ttu-id="50956-269">如果不指定任何事件处理程序，则该登录名控件使用`Membership.ValidateUser`方法，以确定所提供的凭据的有效性。</span><span class="sxs-lookup"><span data-stu-id="50956-269">If no event handler is specified, the Login control uses the `Membership.ValidateUser` method to determine the validity of the credentials.</span></span>

<span data-ttu-id="50956-270">如果提供的凭据是否有效，则创建窗体身份验证票证时， [ `LoggedIn`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx)引发，并且用户重定向到相应的页。</span><span class="sxs-lookup"><span data-stu-id="50956-270">If the supplied credentials are valid, then the forms authentication ticket is created, the [`LoggedIn` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx) is raised, and the user is redirected to the appropriate page.</span></span> <span data-ttu-id="50956-271">如果，但是，凭据被视为无效，则[`LoginError`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx)引发并且显示一条消息，通知用户其凭据无效。</span><span class="sxs-lookup"><span data-stu-id="50956-271">If, however, the credentials are deemed invalid, then the [`LoginError` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx) is raised and a message is displayed informing the user that their credentials were invalid.</span></span> <span data-ttu-id="50956-272">默认情况下，在失败时该登录名控件只需设置其`FailureText`标签控件 Text 属性绑定到 （您登录尝试未成功失败消息。</span><span class="sxs-lookup"><span data-stu-id="50956-272">By default, on failure the Login control simply sets its `FailureText` Label control's Text property to a failure message ( Your login attempt was not successful.</span></span> <span data-ttu-id="50956-273">请重试）。</span><span class="sxs-lookup"><span data-stu-id="50956-273">Please try again ).</span></span> <span data-ttu-id="50956-274">但是，如果登录名控件的[`FailureAction`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx)设置为`RedirectToLoginPage`，然后登录控件问题`Response.Redirect`追加查询字符串参数的登录页到`loginfailure=1`（这将导致该登录名控件以显示失败消息）。</span><span class="sxs-lookup"><span data-stu-id="50956-274">However, if the Login control's [`FailureAction` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx) is set to `RedirectToLoginPage`, then the Login control issues a `Response.Redirect` to the login page appending the querystring parameter `loginfailure=1` (which causes the Login control to display the failure message).</span></span>

<span data-ttu-id="50956-275">图 9 提供身份验证工作流流程图。</span><span class="sxs-lookup"><span data-stu-id="50956-275">Figure 9 offers a flow chart of the authentication workflow.</span></span>

<span data-ttu-id="50956-276">[![登录名控件的身份验证工作流](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="50956-276">[![The Login Control's Authentication Workflow](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)</span></span>

<span data-ttu-id="50956-277">**图 9**:登录名控件的身份验证工作流 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="50956-277">**Figure 9**: The Login Control's Authentication Workflow  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))</span></span>

> [!NOTE]
> <span data-ttu-id="50956-278">如果想知道何时将使用`FailureAction`的`RedirectToLogin`页选项，请考虑以下方案。</span><span class="sxs-lookup"><span data-stu-id="50956-278">If you are wondering when you would use the `FailureAction`'s `RedirectToLogin` page option, consider the following scenario.</span></span> <span data-ttu-id="50956-279">现在我们`Site.master`母版页当前已显示的文本，大家好，stranger 时由匿名用户访问过的左侧列中，但假设我们想要该文本替换为登录控件。</span><span class="sxs-lookup"><span data-stu-id="50956-279">Right now our `Site.master` master page currently has the text, Hello, stranger displayed in the left column when visited by an anonymous user, but imagine that we wanted to replace that text with a Login control.</span></span> <span data-ttu-id="50956-280">这将允许匿名用户可以从任意页上的站点，而无需直接访问登录页登录。</span><span class="sxs-lookup"><span data-stu-id="50956-280">This would allow an anonymous user to log in from any page on the site, instead of requiring them to visit the login page directly.</span></span> <span data-ttu-id="50956-281">但是，如果用户不能通过登录控件呈现母版页的登录，可能会有用重定向到登录页 (`Login.aspx`) 因为该页面可能包含其他说明、 链接和其他帮助-例如，若要创建的链接新的帐户或检索的丢失密码的未被添加到母版页。</span><span class="sxs-lookup"><span data-stu-id="50956-281">However, if a user was unable to log in via the Login control rendered by the master page, it might make sense to redirect them to the login page (`Login.aspx`) because that page likely includes additional instructions, links, and other help - such as links to create a new account or retrieve a lost password - that were not added to the master page.</span></span>

### <a name="creating-theauthenticateevent-handler"></a><span data-ttu-id="50956-282">创建`Authenticate`事件处理程序</span><span class="sxs-lookup"><span data-stu-id="50956-282">Creating the`Authenticate`Event Handler</span></span>

<span data-ttu-id="50956-283">若要插入到我们的自定义身份验证逻辑中，我们需要创建登录控件的事件处理程序`Authenticate`事件。</span><span class="sxs-lookup"><span data-stu-id="50956-283">In order to plug in our custom authentication logic, we need to create an event handler for the Login control's `Authenticate` event.</span></span> <span data-ttu-id="50956-284">创建的事件处理程序`Authenticate`事件将生成以下事件处理程序定义：</span><span class="sxs-lookup"><span data-stu-id="50956-284">Creating an event handler for the `Authenticate` event will generate the following event handler definition:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample3.cs)]

<span data-ttu-id="50956-285">正如您所看到的`Authenticate`事件处理程序传递类型的对象[ `AuthenticateEventArgs` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx)作为其第二个输入参数。</span><span class="sxs-lookup"><span data-stu-id="50956-285">As you can see, the `Authenticate` event handler is passed an object of type [`AuthenticateEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx) as its second input parameter.</span></span> <span data-ttu-id="50956-286">`AuthenticateEventArgs`类包含名为的布尔属性`Authenticated`，用于指定所提供的凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="50956-286">The `AuthenticateEventArgs` class contains a Boolean property named `Authenticated` that is used to specify whether the supplied credentials are valid.</span></span> <span data-ttu-id="50956-287">我们的任务，然后，是编写代码，用于确定所提供的凭据是否有效，并设置`e.Authenticate`属性相应地。</span><span class="sxs-lookup"><span data-stu-id="50956-287">Our task, then, is to write code here that determines whether the supplied credentials are valid or not, and to set the `e.Authenticate` property accordingly.</span></span>

### <a name="determining-and-validating-the-supplied-credentials"></a><span data-ttu-id="50956-288">确定并验证所提供的凭据</span><span class="sxs-lookup"><span data-stu-id="50956-288">Determining and Validating the Supplied Credentials</span></span>

<span data-ttu-id="50956-289">使用登录控件[ `UserName` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx)并[`Password`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx)来确定用户输入的用户名和密码凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-289">Use the Login control's [`UserName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx) and [`Password` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx) to determine the username and password credentials entered by the user.</span></span> <span data-ttu-id="50956-290">若要确定任何其他 Web 控件中输入的值 (如`Email`我们在上一步中添加的文本框)，使用*`LoginControlID`* `.FindControl`("*`controlID`*") 以获取以编程方式引用到模板中的 Web 控件的`ID`属性等于*`controlID`*。</span><span class="sxs-lookup"><span data-stu-id="50956-290">In order to determine the values entered into any additional Web controls (such as the `Email` TextBox we added in the previous step), use *`LoginControlID`*`.FindControl`("*`controlID`*") to obtain a programmatic reference to the Web control in the template whose `ID` property is equal to *`controlID`*.</span></span> <span data-ttu-id="50956-291">例如，若要获取对引用`Email`文本框中，使用以下代码：</span><span class="sxs-lookup"><span data-stu-id="50956-291">For example, to get a reference to the `Email` TextBox, use the following code:</span></span>

`TextBox EmailTextBox = myLogin.FindControl("Email") as TextBox;`

<span data-ttu-id="50956-292">若要验证用户的凭据，我们需要做两件事：</span><span class="sxs-lookup"><span data-stu-id="50956-292">In order to validate the user's credentials we need to do two things:</span></span>

1. <span data-ttu-id="50956-293">请确保提供的用户名和密码有效</span><span class="sxs-lookup"><span data-stu-id="50956-293">Ensure that the provided username and password are valid</span></span>
2. <span data-ttu-id="50956-294">确保输入的电子邮件地址与在用户尝试登录的文件中的电子邮件地址相匹配</span><span class="sxs-lookup"><span data-stu-id="50956-294">Ensure that email address entered matches the email address on file for the user attempting to log in</span></span>

<span data-ttu-id="50956-295">若要完成第一次检查我们只需使用`Membership.ValidateUser`像我们在步骤 1 中看到的方法。</span><span class="sxs-lookup"><span data-stu-id="50956-295">To accomplish the first check we can simply use the `Membership.ValidateUser` method like we saw in Step 1.</span></span> <span data-ttu-id="50956-296">第二个检查中，我们需要确定用户的电子邮件地址，以便我们可以将其它们输入到 TextBox 控件的电子邮件地址进行比较。</span><span class="sxs-lookup"><span data-stu-id="50956-296">For the second check, we need to determine the user's email address so that we can compare it to the email address they entered into the TextBox control.</span></span> <span data-ttu-id="50956-297">若要获取特定用户的信息，请使用`Membership`类的[`GetUser`方法](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="50956-297">To get information about a particular user, use the `Membership` class's [`GetUser` method](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx).</span></span>

<span data-ttu-id="50956-298">`GetUser`方法有许多重载。</span><span class="sxs-lookup"><span data-stu-id="50956-298">The `GetUser` method has a number of overloads.</span></span> <span data-ttu-id="50956-299">如果使用未传入任何参数，则返回有关当前已登录用户的信息。</span><span class="sxs-lookup"><span data-stu-id="50956-299">If used without passing in any parameters, it returns information about the currently logged in user.</span></span> <span data-ttu-id="50956-300">若要获取特定用户的信息，请调用`GetUser`传递其用户名中。</span><span class="sxs-lookup"><span data-stu-id="50956-300">To get information about a particular user, call `GetUser` passing in their username.</span></span> <span data-ttu-id="50956-301">无论哪种方式`GetUser`返回[`MembershipUser`对象](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)，其中包含属性，如`UserName`， `Email`， `IsApproved`， `IsOnline`，依次类推。</span><span class="sxs-lookup"><span data-stu-id="50956-301">Either way, `GetUser` returns a [`MembershipUser` object](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), which has properties like `UserName`, `Email`, `IsApproved`, `IsOnline`, and so on.</span></span>

<span data-ttu-id="50956-302">下面的代码实现这些两个检查。</span><span class="sxs-lookup"><span data-stu-id="50956-302">The following code implements these two checks.</span></span> <span data-ttu-id="50956-303">如果两者都通过，然后`e.Authenticate`设置为`true`，否则它分配`false`。</span><span class="sxs-lookup"><span data-stu-id="50956-303">If both pass, then `e.Authenticate` is set to `true`, otherwise it is assigned `false`.</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample4.cs)]

<span data-ttu-id="50956-304">利用此代码，尝试以输入正确的用户名、 密码和电子邮件地址的有效用户身份登录。</span><span class="sxs-lookup"><span data-stu-id="50956-304">With this code in place, attempt to log in as a valid user, entering the correct username, password, and email address.</span></span> <span data-ttu-id="50956-305">重试，但这次特意使用不正确的电子邮件地址 （请参阅图 10）。</span><span class="sxs-lookup"><span data-stu-id="50956-305">Try it again, but this time purposefully use an incorrect email address (see Figure 10).</span></span> <span data-ttu-id="50956-306">最后，它尝试使用不存在用户名的第三个时间。</span><span class="sxs-lookup"><span data-stu-id="50956-306">Finally, try it a third time using a non-existent username.</span></span> <span data-ttu-id="50956-307">在第一种情况下您应已成功登录到站点，但在最后两个情况下应会看到登录控件的凭据无效消息。</span><span class="sxs-lookup"><span data-stu-id="50956-307">In the first case you should be successfully logged on to the site, but in the last two cases you should see the Login control's invalid credentials message.</span></span>

<span data-ttu-id="50956-308">[![提供不正确的电子邮件地址时，Tito 无法登录。](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="50956-308">[![Tito Cannot Log In When Supplying an Incorrect Email Address](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)</span></span>

<span data-ttu-id="50956-309">**图 10**:Tito 无法日志中时提供不正确的电子邮件地址 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="50956-309">**Figure 10**: Tito Cannot Log In When Supplying an Incorrect Email Address  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))</span></span>

> [!NOTE]
> <span data-ttu-id="50956-310">步骤 1 中的如何成员资格框架处理无效登录尝试部分中所述时`Membership.ValidateUser`方法调用并传递凭据无效，它跟踪的无效的登录尝试并锁定用户，如果它们超出某一特定指定的时间范围内的无效尝试的阈值。</span><span class="sxs-lookup"><span data-stu-id="50956-310">As discussed in the How the Membership Framework Handles Invalid Login Attempts section in Step 1, when the `Membership.ValidateUser` method is called and passed invalid credentials, it keeps track of the invalid login attempt and locks out the user if they exceed a certain threshold of invalid attempts within a specified time window.</span></span> <span data-ttu-id="50956-311">因为我们自定义身份验证逻辑调用`ValidateUser`方法中，有效的用户名不正确的密码将无效的登录尝试使计数器递增，但此计数器中的用户名和密码是否有效，这种情况不会增加，但电子邮件地址不正确。</span><span class="sxs-lookup"><span data-stu-id="50956-311">Since our custom authentication logic calls the `ValidateUser` method, an incorrect password for a valid username will increment the invalid login attempt counter, but this counter is not incremented in the case where the username and password are valid, but the email address is incorrect.</span></span> <span data-ttu-id="50956-312">很可能，此行为很合适，因为不太可能黑客会知道用户名和密码，但必须使用暴力破解技术来确定用户的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="50956-312">Chances are, this behavior is suitable, since it's unlikely that a hacker will know the username and password, but have to use brute force techniques to determine the user's email address.</span></span>

## <a name="step-4-improving-the-login-controls-invalid-credentials-message"></a><span data-ttu-id="50956-313">步骤 4：提高登录控件的凭据无效消息</span><span class="sxs-lookup"><span data-stu-id="50956-313">Step 4: Improving the Login Control's Invalid Credentials Message</span></span>

<span data-ttu-id="50956-314">当用户尝试使用无效凭据登录时，登录名，将显示一条消息说明的登录尝试不成功。</span><span class="sxs-lookup"><span data-stu-id="50956-314">When a user attempts to log on with invalid credentials, the Login control displays a message explaining that the login attempt was unsuccessful.</span></span> <span data-ttu-id="50956-315">具体而言，该控件显示由指定的消息及其[`FailureText`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx)，其中包含默认值为您的登录尝试未成功。</span><span class="sxs-lookup"><span data-stu-id="50956-315">In particular, the control displays the message specified by its [`FailureText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx), which has a default value of Your login attempt was not successful.</span></span> <span data-ttu-id="50956-316">请重试。</span><span class="sxs-lookup"><span data-stu-id="50956-316">Please try again.</span></span>

<span data-ttu-id="50956-317">回想一下，原因有很多原因，用户的凭据可能无效：</span><span class="sxs-lookup"><span data-stu-id="50956-317">Recall that there are many reasons why a user's credentials may be invalid:</span></span>

- <span data-ttu-id="50956-318">用户名可能不存在</span><span class="sxs-lookup"><span data-stu-id="50956-318">The username may not exist</span></span>
- <span data-ttu-id="50956-319">用户名已存在，但密码为无效</span><span class="sxs-lookup"><span data-stu-id="50956-319">The username exists, but the password is invalid</span></span>
- <span data-ttu-id="50956-320">用户名和密码有效，但用户尚未批准</span><span class="sxs-lookup"><span data-stu-id="50956-320">The username and password are valid, but the user is not yet approved</span></span>
- <span data-ttu-id="50956-321">用户名和密码是否有效，但用户被锁定在扩展 （最可能是因为它们超出了指定的时间范围内的无效的登录尝试次数）</span><span class="sxs-lookup"><span data-stu-id="50956-321">The username and password are valid, but the user is locked out (most likely because they exceeded the number of invalid login attempts within the specified time frame)</span></span>

<span data-ttu-id="50956-322">和使用自定义身份验证逻辑时可能会由于其他原因。</span><span class="sxs-lookup"><span data-stu-id="50956-322">And there may be other reasons when using custom authentication logic.</span></span> <span data-ttu-id="50956-323">例如，代码，我们编写了在步骤 3 中，用户名和密码可能有效，但可能不正确的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="50956-323">For example, with the code we wrote in Step 3, the username and password may be valid, but the email address may be incorrect.</span></span>

<span data-ttu-id="50956-324">无论原因的凭据是无效登录名控件显示相同的错误消息。</span><span class="sxs-lookup"><span data-stu-id="50956-324">Regardless of why the credentials are invalid, the Login control displays the same error message.</span></span> <span data-ttu-id="50956-325">这种反馈的缺乏容易混淆的帐户尚未批准或已锁定用户的用户。借助极少量的工作，不过，我们可以登录控件显示更合适的消息。</span><span class="sxs-lookup"><span data-stu-id="50956-325">This lack of feedback can be confusing for a user whose account has not yet been approved or who has been locked out. With a little bit of work, though, we can have the Login control display a more appropriate message.</span></span>

<span data-ttu-id="50956-326">每当用户尝试使用无效凭据登录控件引发登录其`LoginError`事件。</span><span class="sxs-lookup"><span data-stu-id="50956-326">Whenever a user attempts to login with invalid credentials the Login control raises its `LoginError` event.</span></span> <span data-ttu-id="50956-327">请继续并创建此事件的事件处理程序并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="50956-327">Go ahead and create an event handler for this event, and add the following code:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample5.cs)]

<span data-ttu-id="50956-328">上面的代码首先会设置登录名控件的`FailureText`属性设置为默认值 （您的登录尝试未成功。</span><span class="sxs-lookup"><span data-stu-id="50956-328">The above code starts by setting the Login control's `FailureText` property to the default value ( Your login attempt was not successful.</span></span> <span data-ttu-id="50956-329">请重试）。</span><span class="sxs-lookup"><span data-stu-id="50956-329">Please try again ).</span></span> <span data-ttu-id="50956-330">然后检查以查看是否提供的用户名将映射到现有的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="50956-330">It then checks to see if the username supplied maps to an existing user account.</span></span> <span data-ttu-id="50956-331">如果因此，它会查询得到`MembershipUser`对象的`IsLockedOut`和`IsApproved`属性来确定帐户是否已被锁定，或尚未批准。</span><span class="sxs-lookup"><span data-stu-id="50956-331">If so, it consults the resulting `MembershipUser` object's `IsLockedOut` and `IsApproved` properties to determine if the account has been locked out or has not yet been approved.</span></span> <span data-ttu-id="50956-332">在任一情况下，`FailureText`属性更新为相应的值。</span><span class="sxs-lookup"><span data-stu-id="50956-332">In either case, the `FailureText` property is updated to a corresponding value.</span></span>

<span data-ttu-id="50956-333">若要测试此代码，有意尝试记录作为现有用户，但使用了错误的密码。</span><span class="sxs-lookup"><span data-stu-id="50956-333">To test this code, purposefully attempt to log in as an existing user, but use an incorrect password.</span></span> <span data-ttu-id="50956-334">在 10 分钟时间范围内的行中执行操作这五次，该帐户将被锁定。如图 11 所示，后续登录尝试将始终失败 （即使使用正确的密码），但现在将显示更具描述性的显示你的帐户已锁定由于无效的登录尝试次数太多。</span><span class="sxs-lookup"><span data-stu-id="50956-334">Do this five times in a row within a 10 minute time frame and the account will be locked out. As Figure 11 shows, subsequent login attempts will always fail (even with the correct password), but will now display the more descriptive Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="50956-335">请与管理员联系以具有您的帐户解锁的消息。</span><span class="sxs-lookup"><span data-stu-id="50956-335">Please contact the administrator to have your account unlocked message.</span></span>

<span data-ttu-id="50956-336">[![Tito 执行无效的登录尝试次数太多，并且已被锁定](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="50956-336">[![Tito Performed Too Many Invalid Login Attempts and Has Been Locked Out](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)</span></span>

<span data-ttu-id="50956-337">**图 11**:Tito 执行太多个无效登录尝试，并具有已锁定 ([单击此项可查看原尺寸图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="50956-337">**Figure 11**: Tito Performed Too Many Invalid Login Attempts and Has Been Locked Out  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))</span></span>

## <a name="summary"></a><span data-ttu-id="50956-338">总结</span><span class="sxs-lookup"><span data-stu-id="50956-338">Summary</span></span>

<span data-ttu-id="50956-339">先前本教程中，我们登录页验证的用户名/密码对的硬编码列表针对提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-339">Prior this tutorial, our login page validated the supplied credentials against a hard-coded list of username/password pairs.</span></span> <span data-ttu-id="50956-340">在本教程中，我们更新了页面来验证凭据对成员资格框架。</span><span class="sxs-lookup"><span data-stu-id="50956-340">In this tutorial, we updated the page to validate credentials against the Membership framework.</span></span> <span data-ttu-id="50956-341">在步骤 1 中我们介绍了使用`Membership.ValidateUser`方法以编程方式。</span><span class="sxs-lookup"><span data-stu-id="50956-341">In Step 1 we looked at using the `Membership.ValidateUser` method programmatically.</span></span> <span data-ttu-id="50956-342">在步骤 2 中我们替换为我们的手动创建的用户界面和代码登录控件。</span><span class="sxs-lookup"><span data-stu-id="50956-342">In Step 2 we replaced our manually created user interface and code with the Login control.</span></span>

<span data-ttu-id="50956-343">Login 控件呈现标准登录名的用户界面，并会自动验证成员资格框架针对用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="50956-343">The Login control renders a standard login user interface and automatically validates the user's credentials against the Membership framework.</span></span> <span data-ttu-id="50956-344">此外，在发生时有效的凭据，登录控件让用户登录通过窗体身份验证。</span><span class="sxs-lookup"><span data-stu-id="50956-344">Moreover, in the event of valid credentials, the Login control signs the user in via forms authentication.</span></span> <span data-ttu-id="50956-345">简单地说，完全正常运行的登录名的用户体验通过只需将登录控件拖到一个页面、 没有额外的声明性标记或所需的代码是可用。</span><span class="sxs-lookup"><span data-stu-id="50956-345">In short, a fully functional login user experience is available by simply dragging the Login control onto a page, no extra declarative markup or code necessary.</span></span> <span data-ttu-id="50956-346">什么是多个，登录控件是高度可自定义，允许精细地控制呈现的用户界面和身份验证逻辑。</span><span class="sxs-lookup"><span data-stu-id="50956-346">What's more, the Login control is highly customizable, allowing for a fine degree of control over both the rendered user interface and authentication logic.</span></span>

<span data-ttu-id="50956-347">此时我们的网站访问者可以创建新的用户帐户和日志到站点，但我们还未查看限制对页基于经过身份验证的用户的访问。</span><span class="sxs-lookup"><span data-stu-id="50956-347">At this point visitors to our website can create a new user account and log into the site, but we have yet to look at restricting access to pages based on the authenticated user.</span></span> <span data-ttu-id="50956-348">目前，任何用户经过身份验证或匿名的可以在我们的网站上查看的任何页面。</span><span class="sxs-lookup"><span data-stu-id="50956-348">Currently, any user, authenticated or anonymous, can view any page on our site.</span></span> <span data-ttu-id="50956-349">以及控制对我们网页基于用户的用户的访问，我们可能有它的功能取决于用户的特定页。</span><span class="sxs-lookup"><span data-stu-id="50956-349">Along with controlling access to our site's pages on a user-by-user basis, we might have certain pages whose functionality depends on the user.</span></span> <span data-ttu-id="50956-350">下一步的教程讨论如何限制访问和在页根据登录用户的功能。</span><span class="sxs-lookup"><span data-stu-id="50956-350">The next tutorial looks at how to limit access and in-page functionality based on the logged in user.</span></span>

<span data-ttu-id="50956-351">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="50956-351">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="50956-352">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="50956-352">Further Reading</span></span>

<span data-ttu-id="50956-353">在本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="50956-353">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="50956-354">显示自定义消息到锁定和未经批准的用户</span><span class="sxs-lookup"><span data-stu-id="50956-354">Displaying Custom Messages to Locked Out and Non-Approved Users</span></span>](http://aspnet.4guysfromrolla.com/articles/050306-1.aspx)
- [<span data-ttu-id="50956-355">检查 ASP.NET 2.0 的成员资格、 角色和配置文件</span><span class="sxs-lookup"><span data-stu-id="50956-355">Examining ASP.NET 2.0's Membership, Roles, and Profile</span></span>](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [<span data-ttu-id="50956-356">如何：创建 ASP.NET 登录页</span><span class="sxs-lookup"><span data-stu-id="50956-356">How To: Create an ASP.NET Login Page</span></span>](https://msdn.microsoft.com/library/ms178331.aspx)
- [<span data-ttu-id="50956-357">登录控制技术文档</span><span class="sxs-lookup"><span data-stu-id="50956-357">Login Control Technical Documentation</span></span>](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)
- [<span data-ttu-id="50956-358">使用登录控件</span><span class="sxs-lookup"><span data-stu-id="50956-358">Using the Login Controls</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/login.aspx)

### <a name="about-the-author"></a><span data-ttu-id="50956-359">关于作者</span><span class="sxs-lookup"><span data-stu-id="50956-359">About the Author</span></span>

<span data-ttu-id="50956-360">自 1998 年以来，Scott Mitchell，多部 asp/ASP.NET 书籍的作者及 4GuysFromRolla.com 的已从事 Microsoft Web 技术工作。</span><span class="sxs-lookup"><span data-stu-id="50956-360">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="50956-361">Scott 是独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="50956-361">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="50956-362">他最新著作是 *[Sams Teach 自己 ASP.NET 2.0 24 小时内](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*。</span><span class="sxs-lookup"><span data-stu-id="50956-362">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="50956-363">可以在达到 Scott [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com)或通过他的博客[ http://ScottOnWriting.NET ](http://scottonwriting.net/)。</span><span class="sxs-lookup"><span data-stu-id="50956-363">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="50956-364">特别感谢</span><span class="sxs-lookup"><span data-stu-id="50956-364">Special Thanks To</span></span>

<span data-ttu-id="50956-365">很多有用的审阅者已评审本系列教程。</span><span class="sxs-lookup"><span data-stu-id="50956-365">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="50956-366">本教程中的潜在顾客审阅者是 Teresa Murphy 和 Michael Olivero。</span><span class="sxs-lookup"><span data-stu-id="50956-366">Lead reviewers for this tutorial were Teresa Murphy and Michael Olivero.</span></span> <span data-ttu-id="50956-367">是否有兴趣查看我即将推出的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="50956-367">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="50956-368">如果是这样，给我在行[ mitchell@4GuysFromRolla.com ](mailto:mitchell@4guysfromrolla.com)。</span><span class="sxs-lookup"><span data-stu-id="50956-368">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="50956-369">[上一页](creating-user-accounts-cs.md)
> [下一页](user-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="50956-369">[Previous](creating-user-accounts-cs.md)
[Next](user-based-authorization-cs.md)</span></span>
