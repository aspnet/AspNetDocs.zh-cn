---
uid: web-forms/overview/older-versions-security/membership/user-based-authorization-cs
title: 基于用户的授权（C#） |Microsoft Docs
author: rick-anderson
description: 在本教程中，我们将探讨如何通过多种方法来限制对页面的访问和限制页面级功能。
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 3c815a9e-2296-4b9b-b945-776d54989daa
msc.legacyurl: /web-forms/overview/older-versions-security/membership/user-based-authorization-cs
msc.type: authoredcontent
ms.openlocfilehash: 059dbf42956268884dcfdade696491ac39e32da9
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78463586"
---
# <a name="user-based-authorization-c"></a><span data-ttu-id="25c2f-103">基于用户的身份验证 (C#)</span><span class="sxs-lookup"><span data-stu-id="25c2f-103">User-Based Authorization (C#)</span></span>

<span data-ttu-id="25c2f-104">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="25c2f-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="25c2f-105">[下载代码](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_07_CS.zip)或[下载 PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial07_UserAuth_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="25c2f-105">[Download Code](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_07_CS.zip) or [Download PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial07_UserAuth_cs.pdf)</span></span>

> <span data-ttu-id="25c2f-106">在本教程中，我们将探讨如何通过多种方法来限制对页面的访问和限制页面级功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-106">In this tutorial we will look at limiting access to pages and restricting page-level functionality through a variety of techniques.</span></span>

## <a name="introduction"></a><span data-ttu-id="25c2f-107">简介</span><span class="sxs-lookup"><span data-stu-id="25c2f-107">Introduction</span></span>

<span data-ttu-id="25c2f-108">大多数提供用户帐户的 web 应用程序都在部分中执行操作，以限制某些访问者访问站点内的某些页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-108">Most web applications that offer user accounts do so in part to restrict certain visitors from accessing certain pages within the site.</span></span> <span data-ttu-id="25c2f-109">例如，在大多数在线 messageboard 网站中，所有用户（匿名和身份验证）都能够查看 messageboard 的文章，但只有经过身份验证的用户可以访问网页来创建新帖子。</span><span class="sxs-lookup"><span data-stu-id="25c2f-109">In most online messageboard sites, for example, all users - anonymous and authenticated - are able to view the messageboard's posts, but only authenticated users can visit the web page to create a new post.</span></span> <span data-ttu-id="25c2f-110">可能有一些只有特定用户（或一组特定用户）可以访问的管理页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-110">And there may be administrative pages that are only accessible to a particular user (or a particular set of users).</span></span> <span data-ttu-id="25c2f-111">而且，页级别功能可能会因用户而异。</span><span class="sxs-lookup"><span data-stu-id="25c2f-111">Moreover, page-level functionality can differ on a user-by-user basis.</span></span> <span data-ttu-id="25c2f-112">查看文章列表时，经过身份验证的用户会显示一个用于分级每个帖子的界面，而此界面对匿名访问者不可用。</span><span class="sxs-lookup"><span data-stu-id="25c2f-112">When viewing a list of posts, authenticated users are shown an interface for rating each post, whereas this interface is not available to anonymous visitors.</span></span>

<span data-ttu-id="25c2f-113">ASP.NET 可以轻松定义基于用户的授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-113">ASP.NET makes it easy to define user-based authorization rules.</span></span> <span data-ttu-id="25c2f-114">在 `Web.config`中，只需一些标记，就可以锁定特定网页或整个目录，以便只能访问指定的用户子集。</span><span class="sxs-lookup"><span data-stu-id="25c2f-114">With just a bit of markup in `Web.config`, specific web pages or entire directories can be locked down so that they are only accessible to a specified subset of users.</span></span> <span data-ttu-id="25c2f-115">可以基于当前登录的用户通过编程方式或声明性方式打开或关闭页面级功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-115">Page-level functionality can be turned on or off based on the currently logged in user through programmatic and declarative means.</span></span>

<span data-ttu-id="25c2f-116">在本教程中，我们将探讨如何通过多种方法来限制对页面的访问和限制页面级功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-116">In this tutorial we will look at limiting access to pages and restricting page-level functionality through a variety of techniques.</span></span> <span data-ttu-id="25c2f-117">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="25c2f-117">Let's get started!</span></span>

## <a name="a-look-at-the-url-authorization-workflow"></a><span data-ttu-id="25c2f-118">查看 URL 授权工作流</span><span class="sxs-lookup"><span data-stu-id="25c2f-118">A Look at the URL Authorization Workflow</span></span>

<span data-ttu-id="25c2f-119">如[*表单身份验证概述*](../introduction/an-overview-of-forms-authentication-cs.md)教程中所述，当 ASP.NET 运行时处理 ASP.NET 资源的请求时，请求会在其生命周期内引发许多事件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-119">As discussed in the [*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, when the ASP.NET runtime processes a request for an ASP.NET resource the request raises a number of events during its lifecycle.</span></span> <span data-ttu-id="25c2f-120">*HTTP 模块*是托管类，其代码是为了响应请求生命周期中的特定事件而执行的。</span><span class="sxs-lookup"><span data-stu-id="25c2f-120">*HTTP Modules* are managed classes whose code is executed in response to a particular event in the request lifecycle.</span></span> <span data-ttu-id="25c2f-121">ASP.NET 附带了多个 HTTP 模块，这些模块在幕后执行基本任务。</span><span class="sxs-lookup"><span data-stu-id="25c2f-121">ASP.NET ships with a number of HTTP Modules that perform essential tasks behind the scenes.</span></span>

<span data-ttu-id="25c2f-122">[`FormsAuthenticationModule`](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)一个这样的 HTTP 模块。</span><span class="sxs-lookup"><span data-stu-id="25c2f-122">One such HTTP Module is [`FormsAuthenticationModule`](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx).</span></span> <span data-ttu-id="25c2f-123">如前面的教程中所述，`FormsAuthenticationModule` 的主要功能是确定当前请求的标识。</span><span class="sxs-lookup"><span data-stu-id="25c2f-123">As discussed in previous tutorials, the primary function of the `FormsAuthenticationModule` is to determine the identity of the current request.</span></span> <span data-ttu-id="25c2f-124">这可以通过检查 forms 身份验证票证来完成，该票证可以位于 cookie 中或嵌入在 URL 中。</span><span class="sxs-lookup"><span data-stu-id="25c2f-124">This is accomplished by inspecting the forms authentication ticket, which is either located in a cookie or embedded within the URL.</span></span> <span data-ttu-id="25c2f-125">此标识发生在[`AuthenticateRequest` 事件](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)期间。</span><span class="sxs-lookup"><span data-stu-id="25c2f-125">This identification takes place during the [`AuthenticateRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx).</span></span>

<span data-ttu-id="25c2f-126">另一个重要的 HTTP 模块是[`UrlAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)，这是为了响应[`AuthorizeRequest` 事件](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)（在 `AuthenticateRequest` 事件之后发生）。</span><span class="sxs-lookup"><span data-stu-id="25c2f-126">Another important HTTP Module is the [`UrlAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx), which is raised in response to the [`AuthorizeRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx) (which happens after the `AuthenticateRequest` event).</span></span> <span data-ttu-id="25c2f-127">`UrlAuthorizationModule` 检查 `Web.config` 中的配置标记，以确定当前标识是否有权访问指定的页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-127">The `UrlAuthorizationModule` examines configuration markup in `Web.config` to determine whether the current identity has authority to visit the specified page.</span></span> <span data-ttu-id="25c2f-128">此过程称为*URL 授权*。</span><span class="sxs-lookup"><span data-stu-id="25c2f-128">This process is referred to as *URL authorization*.</span></span>

<span data-ttu-id="25c2f-129">我们将在步骤1中检查 URL 授权规则的语法，但首先我们来看看 `UrlAuthorizationModule` 的作用，具体取决于请求是否已获授权。</span><span class="sxs-lookup"><span data-stu-id="25c2f-129">We'll examine the syntax for the URL authorization rules in Step 1, but first let's look at what the `UrlAuthorizationModule` does depending on whether the request is authorized or not.</span></span> <span data-ttu-id="25c2f-130">如果 `UrlAuthorizationModule` 确定请求已获得授权，则不执行任何操作，请求会在其生命周期中继续执行。</span><span class="sxs-lookup"><span data-stu-id="25c2f-130">If the `UrlAuthorizationModule` determines that the request is authorized, then it does nothing, and the request continues through its lifecycle.</span></span> <span data-ttu-id="25c2f-131">但是，如果请求*未*获授权，则 `UrlAuthorizationModule` 中止生命周期，并指示 `Response` 对象返回 " [HTTP 401" 未经授权](http://www.checkupdown.com/status/E401.html)状态。</span><span class="sxs-lookup"><span data-stu-id="25c2f-131">However, if the request is *not* authorized, then the `UrlAuthorizationModule` aborts the lifecycle and instructs the `Response` object to return an [HTTP 401 Unauthorized](http://www.checkupdown.com/status/E401.html) status.</span></span> <span data-ttu-id="25c2f-132">使用窗体身份验证时，此 HTTP 401 状态绝不会返回给客户端，因为如果 `FormsAuthenticationModule` 检测到 HTTP 401 状态，则会将其修改为[http 302 重定向](http://www.checkupdown.com/status/E302.html)到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-132">When using forms authentication this HTTP 401 status is never returned to the client because if the `FormsAuthenticationModule` detects an HTTP 401 status is modifies it to an [HTTP 302 Redirect](http://www.checkupdown.com/status/E302.html) to the login page.</span></span>

<span data-ttu-id="25c2f-133">图1说明了 ASP.NET 管道、`FormsAuthenticationModule`的工作流，以及未授权请求到达时的 `UrlAuthorizationModule`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-133">Figure 1 illustrates the workflow of the ASP.NET pipeline, the `FormsAuthenticationModule`, and the `UrlAuthorizationModule` when an unauthorized request arrives.</span></span> <span data-ttu-id="25c2f-134">具体而言，图1显示了 `ProtectedPage.aspx`的匿名访问者发出的请求，该请求是拒绝匿名用户访问的页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-134">In particular, Figure 1 shows a request by an anonymous visitor for `ProtectedPage.aspx`, which is a page that denies access to anonymous users.</span></span> <span data-ttu-id="25c2f-135">由于访问者是匿名的，`UrlAuthorizationModule` 中止请求并返回 HTTP 401 未经授权状态。</span><span class="sxs-lookup"><span data-stu-id="25c2f-135">Since the visitor is anonymous, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="25c2f-136">然后，`FormsAuthenticationModule` 将401状态转换为302重定向到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-136">The `FormsAuthenticationModule` then converts the 401 status into a 302 Redirect to login page.</span></span> <span data-ttu-id="25c2f-137">通过登录页对用户进行身份验证后，会将其重定向到 `ProtectedPage.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-137">After the user is authenticated via the login page, he is redirected to `ProtectedPage.aspx`.</span></span> <span data-ttu-id="25c2f-138">这次 `FormsAuthenticationModule` 会根据用户的身份验证票证来确定用户身份。</span><span class="sxs-lookup"><span data-stu-id="25c2f-138">This time the `FormsAuthenticationModule` identifies the user based on his authentication ticket.</span></span> <span data-ttu-id="25c2f-139">现在，访问者已经过身份验证，`UrlAuthorizationModule` 允许访问该页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-139">Now that the visitor is authenticated, the `UrlAuthorizationModule` permits access to the page.</span></span>

<span data-ttu-id="25c2f-140">[![Forms 身份验证和 URL 授权工作流](user-based-authorization-cs/_static/image2.png)](user-based-authorization-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-140">[![The Forms Authentication and URL Authorization Workflow](user-based-authorization-cs/_static/image2.png)](user-based-authorization-cs/_static/image1.png)</span></span>

<span data-ttu-id="25c2f-141">**图 1**： Forms 身份验证和 URL 授权工作流（[单击以查看完全大小的图像](user-based-authorization-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-141">**Figure 1**: The Forms Authentication and URL Authorization Workflow  ([Click to view full-size image](user-based-authorization-cs/_static/image3.png))</span></span>

<span data-ttu-id="25c2f-142">图1描述了匿名访问者尝试访问匿名用户无法使用的资源时所发生的交互。</span><span class="sxs-lookup"><span data-stu-id="25c2f-142">Figure 1 depicts the interaction that occurs when an anonymous visitor attempts to access a resource that is not available to anonymous users.</span></span> <span data-ttu-id="25c2f-143">在这种情况下，匿名访问者将重定向到登录页，其中包含她尝试访问 querystring 中指定的页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-143">In such a case, the anonymous visitor is redirected to the login page with the page she attempted to visit specified in the querystring.</span></span> <span data-ttu-id="25c2f-144">用户成功登录后，她将自动重定向回最初尝试查看的资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-144">Once the user has successfully logged on, she will be automatically redirected back to the resource she was initially attempting to view.</span></span>

<span data-ttu-id="25c2f-145">如果匿名用户发出了未经授权的请求，则此工作流非常简单，访问者可以轻松了解发生的情况和原因。</span><span class="sxs-lookup"><span data-stu-id="25c2f-145">When the unauthorized request is made by an anonymous user, this workflow is straightforward and is easy for the visitor to understand what has happened and why.</span></span> <span data-ttu-id="25c2f-146">但请记住，`FormsAuthenticationModule` 会将*任何*未经授权的用户重定向到登录页，即使请求由经过身份验证的用户发出。</span><span class="sxs-lookup"><span data-stu-id="25c2f-146">But keep in mind that the `FormsAuthenticationModule` will redirect *any* unauthorized user to the login page, even if the request is made by an authenticated user.</span></span> <span data-ttu-id="25c2f-147">如果经过身份验证的用户尝试访问她缺少授权的页面，这可能会导致用户体验混乱。</span><span class="sxs-lookup"><span data-stu-id="25c2f-147">This can result in a confusing user experience if an authenticated user attempts to visit a page for which she lacks authority.</span></span>

<span data-ttu-id="25c2f-148">假设我们的网站已配置了其 URL 授权规则，以便 ASP.NET 页面 `OnlyTito.aspx` 仅 accessibly 为 Tito。</span><span class="sxs-lookup"><span data-stu-id="25c2f-148">Imagine that our website had its URL authorization rules configured such that the ASP.NET page `OnlyTito.aspx` was accessibly only to Tito.</span></span> <span data-ttu-id="25c2f-149">现在，假设 Sam 访问该站点，登录，然后尝试访问 `OnlyTito.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-149">Now, imagine that Sam visits the site, logs on, and then attempts to visit `OnlyTito.aspx`.</span></span> <span data-ttu-id="25c2f-150">`UrlAuthorizationModule` 将暂停请求生命周期，并返回 HTTP 401 "未经授权" 状态，`FormsAuthenticationModule` 该状态将检测并将 Sam 重定向到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-150">The `UrlAuthorizationModule` will halt the request lifecycle and return an HTTP 401 Unauthorized status, which the `FormsAuthenticationModule` will detect and then redirect Sam to the login page.</span></span> <span data-ttu-id="25c2f-151">尽管 Sam 已登录，但她可能会想知道为什么会将她发回登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-151">Since Sam has already logged in, though, she may wonder why she has been sent back to the login page.</span></span> <span data-ttu-id="25c2f-152">她可能会因为某种原因而丢失了她的登录凭据，或输入了无效的凭据。</span><span class="sxs-lookup"><span data-stu-id="25c2f-152">She might reason that her login credentials were lost somehow, or that she entered invalid credentials.</span></span> <span data-ttu-id="25c2f-153">如果 Sam 从登录页重新输入她的凭据，她将再次登录（再次）并重定向到 `OnlyTito.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-153">If Sam reenters her credentials from the login page she will be logged on (again) and redirected to `OnlyTito.aspx`.</span></span> <span data-ttu-id="25c2f-154">`UrlAuthorizationModule` 将检测 Sam 是否无法访问此页，她将返回到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-154">The `UrlAuthorizationModule` will detect that Sam cannot visit this page and she will be returned to the login page.</span></span>

<span data-ttu-id="25c2f-155">图2演示了这种混乱的工作流。</span><span class="sxs-lookup"><span data-stu-id="25c2f-155">Figure 2 depicts this confusing workflow.</span></span>

<span data-ttu-id="25c2f-156">[![默认工作流可能导致混乱的循环](user-based-authorization-cs/_static/image5.png)](user-based-authorization-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-156">[![The Default Workflow Can Lead to a Confusing Cycle](user-based-authorization-cs/_static/image5.png)](user-based-authorization-cs/_static/image4.png)</span></span>

<span data-ttu-id="25c2f-157">**图 2**：默认工作流可能会产生混乱的循环（[单击查看完全大小的图像](user-based-authorization-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-157">**Figure 2**: The Default Workflow Can Lead to a Confusing Cycle  ([Click to view full-size image](user-based-authorization-cs/_static/image6.png))</span></span>

<span data-ttu-id="25c2f-158">图2中所示的工作流可以快速 befuddle，甚至是最精通计算机的访问者。</span><span class="sxs-lookup"><span data-stu-id="25c2f-158">The workflow illustrated in Figure 2 can quickly befuddle even the most computer savvy visitor.</span></span> <span data-ttu-id="25c2f-159">在步骤2中，我们将探讨防止这种混乱循环的方法。</span><span class="sxs-lookup"><span data-stu-id="25c2f-159">We will look at ways to prevent this confusing cycle in Step 2.</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-160">ASP.NET 使用两种机制来确定当前用户是否可以访问特定网页： URL 授权和文件授权。</span><span class="sxs-lookup"><span data-stu-id="25c2f-160">ASP.NET uses two mechanisms to determine whether the current user can access a particular web page: URL authorization and file authorization.</span></span> <span data-ttu-id="25c2f-161">文件授权由[`FileAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx)实现，它通过咨询请求的文件 acl 来确定权威。</span><span class="sxs-lookup"><span data-stu-id="25c2f-161">File authorization is implemented by the [`FileAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx), which determines authority by consulting the requested file(s) ACLs.</span></span> <span data-ttu-id="25c2f-162">文件授权最常用于 Windows 身份验证，因为 Acl 是适用于 Windows 帐户的权限。</span><span class="sxs-lookup"><span data-stu-id="25c2f-162">File authorization is most commonly used with Windows authentication because ACLs are permissions that apply to Windows accounts.</span></span> <span data-ttu-id="25c2f-163">使用 forms 身份验证时，所有操作系统和文件系统级请求均由同一 Windows 帐户执行，而不考虑访问站点的用户。</span><span class="sxs-lookup"><span data-stu-id="25c2f-163">When using forms authentication, all operating system- and file system-level requests are executed by the same Windows account, regardless of the user visiting the site.</span></span> <span data-ttu-id="25c2f-164">由于本教程系列重点介绍 forms 身份验证，因此我们不会讨论文件授权。</span><span class="sxs-lookup"><span data-stu-id="25c2f-164">Since this tutorial series focuses on forms authentication, we will not be discussing file authorization.</span></span>

### <a name="the-scope-of-url-authorization"></a><span data-ttu-id="25c2f-165">URL 授权的范围</span><span class="sxs-lookup"><span data-stu-id="25c2f-165">The Scope of URL Authorization</span></span>

<span data-ttu-id="25c2f-166">`UrlAuthorizationModule` 是托管代码，是 ASP.NET 运行时的一部分。</span><span class="sxs-lookup"><span data-stu-id="25c2f-166">The `UrlAuthorizationModule` is managed code that is part of the ASP.NET runtime.</span></span> <span data-ttu-id="25c2f-167">在 Microsoft [Internet Information Services （iis）](https://www.iis.net/) web 服务器版本7之前，IIS 的 HTTP 管道与 ASP.NET 运行时的管道之间存在不同的障碍。</span><span class="sxs-lookup"><span data-stu-id="25c2f-167">Prior to version 7 of Microsoft's [Internet Information Services (IIS)](https://www.iis.net/) web server, there was a distinct barrier between IIS's HTTP pipeline and the ASP.NET runtime's pipeline.</span></span> <span data-ttu-id="25c2f-168">简而言之，在 IIS 6 及更早版本中，ASP。仅当请求从 IIS 委托到 ASP.NET 运行时时，才会执行网络的 `UrlAuthorizationModule`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-168">In short, in IIS 6 and earlier, ASP.NET's `UrlAuthorizationModule` only executes when a request is delegated from IIS to the ASP.NET runtime.</span></span> <span data-ttu-id="25c2f-169">默认情况下，IIS 会处理静态内容本身（如 HTML 页面和 CSS、JavaScript 和映像文件），并仅在请求扩展名为 `.aspx`、`.asmx`或 `.ashx` 的页面时，将请求发送到 ASP.NET 运行时。</span><span class="sxs-lookup"><span data-stu-id="25c2f-169">By default, IIS processes static content itself - like HTML pages and CSS, JavaScript, and image files - and only hands off requests to the ASP.NET runtime when a page with an extension of `.aspx`, `.asmx`, or `.ashx` is requested.</span></span>

<span data-ttu-id="25c2f-170">但是，IIS 7 允许集成的 IIS 和 ASP.NET 管道。</span><span class="sxs-lookup"><span data-stu-id="25c2f-170">IIS 7, however, allows for integrated IIS and ASP.NET pipelines.</span></span> <span data-ttu-id="25c2f-171">使用几个配置设置，你可以设置 IIS 7 来为*所有*请求调用 `UrlAuthorizationModule`，这意味着可以为任何类型的文件定义 URL 授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-171">With a few configuration settings you can setup IIS 7 to invoke the `UrlAuthorizationModule` for *all* requests, meaning that URL authorization rules can be defined for files of any type.</span></span> <span data-ttu-id="25c2f-172">此外，IIS 7 包含自己的 URL 授权引擎。</span><span class="sxs-lookup"><span data-stu-id="25c2f-172">Additionally, IIS 7 includes its own URL authorization engine.</span></span> <span data-ttu-id="25c2f-173">有关 ASP.NET 集成和 IIS 7 的本机 URL 授权功能的详细信息，请参阅[了解 IIS7 Url 授权](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization)。</span><span class="sxs-lookup"><span data-stu-id="25c2f-173">For more information on ASP.NET integration and IIS 7's native URL authorization functionality, see [Understanding IIS7 URL Authorization](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization).</span></span> <span data-ttu-id="25c2f-174">若要深入了解 ASP.NET 和 IIS 7 集成，请选择 Shahram Khosravi 书籍、*专业 IIS 7 和 ASP.NET 集成编程*（ISBN：978-0470152539）的副本。</span><span class="sxs-lookup"><span data-stu-id="25c2f-174">For a more in-depth look at ASP.NET and IIS 7 integration, pick up a copy of Shahram Khosravi's book, *Professional IIS 7 and ASP.NET Integrated Programming* (ISBN: 978-0470152539).</span></span>

<span data-ttu-id="25c2f-175">简而言之，在 IIS 7 之前的版本中，URL 授权规则仅适用于 ASP.NET 运行时所处理的资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-175">In a nutshell, in versions prior to IIS 7, URL authorization rules are only applied to resources handled by the ASP.NET runtime.</span></span> <span data-ttu-id="25c2f-176">但使用 IIS 7，可以使用 IIS 的本机 URL 授权功能或集成 ASP。将网络 `UrlAuthorizationModule` 到 IIS 的 HTTP 管道，从而将此功能扩展到所有请求。</span><span class="sxs-lookup"><span data-stu-id="25c2f-176">But with IIS 7 it is possible to use IIS's native URL authorization feature or to integrate ASP.NET's `UrlAuthorizationModule` into IIS's HTTP pipeline, thereby extending this functionality to all requests.</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-177">ASP 的方式有一些细微的差异。NET 的 `UrlAuthorizationModule` 和 IIS 7 的 URL 授权功能处理授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-177">There are some subtle yet important differences in how ASP.NET's `UrlAuthorizationModule` and IIS 7's URL authorization feature process the authorization rules.</span></span> <span data-ttu-id="25c2f-178">本教程不会检查 IIS 7 的 URL 授权功能，也不会检查如何对与 `UrlAuthorizationModule`进行的授权规则进行分析。</span><span class="sxs-lookup"><span data-stu-id="25c2f-178">This tutorial does not examine IIS 7's URL authorization functionality or the differences in how it parses authorization rules compared to the `UrlAuthorizationModule`.</span></span> <span data-ttu-id="25c2f-179">有关这些主题的详细信息，请参阅 MSDN 上或[www.iis.net](https://www.iis.net/)上的 IIS 7 文档。</span><span class="sxs-lookup"><span data-stu-id="25c2f-179">For more information on these topics, refer to the IIS 7 documentation on MSDN or at [www.iis.net](https://www.iis.net/).</span></span>

## <a name="step-1-defining-url-authorization-rules-inwebconfig"></a><span data-ttu-id="25c2f-180">步骤1：在`Web.config` 中定义 URL 授权规则</span><span class="sxs-lookup"><span data-stu-id="25c2f-180">Step 1: Defining URL Authorization Rules in`Web.config`</span></span>

<span data-ttu-id="25c2f-181">`UrlAuthorizationModule` 根据应用程序配置中定义的 URL 授权规则，确定是授予还是拒绝特定标识的请求资源的访问权限。</span><span class="sxs-lookup"><span data-stu-id="25c2f-181">The `UrlAuthorizationModule` determines whether to grant or deny access to a requested resource for a particular identity based on the URL authorization rules defined in the application's configuration.</span></span> <span data-ttu-id="25c2f-182">授权规则在[`<authorization>` 元素](https://msdn.microsoft.com/library/8d82143t.aspx)中以 `<allow>` 和 `<deny>` 子元素的形式进行拼写。</span><span class="sxs-lookup"><span data-stu-id="25c2f-182">The authorization rules are spelled out in the [`<authorization>` element](https://msdn.microsoft.com/library/8d82143t.aspx) in the form of `<allow>` and `<deny>` child elements.</span></span> <span data-ttu-id="25c2f-183">每个 `<allow>` 和 `<deny>` 子元素可以指定：</span><span class="sxs-lookup"><span data-stu-id="25c2f-183">Each `<allow>` and `<deny>` child element can specify:</span></span>

- <span data-ttu-id="25c2f-184">特定用户</span><span class="sxs-lookup"><span data-stu-id="25c2f-184">A particular user</span></span>
- <span data-ttu-id="25c2f-185">以逗号分隔的用户列表</span><span class="sxs-lookup"><span data-stu-id="25c2f-185">A comma-delimited list of users</span></span>
- <span data-ttu-id="25c2f-186">所有匿名用户，由问号（？）表示</span><span class="sxs-lookup"><span data-stu-id="25c2f-186">All anonymous users, denoted by a question mark (?)</span></span>
- <span data-ttu-id="25c2f-187">所有用户，由星号（\*）表示</span><span class="sxs-lookup"><span data-stu-id="25c2f-187">All users, denoted by an asterisk (\*)</span></span>

<span data-ttu-id="25c2f-188">以下标记说明了如何使用 URL 授权规则允许用户 Tito 和 Scott，并拒绝所有其他用户：</span><span class="sxs-lookup"><span data-stu-id="25c2f-188">The following markup illustrates how to use the URL authorization rules to allow users Tito and Scott and deny all others:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample1.xml)]

<span data-ttu-id="25c2f-189">`<allow>` 元素定义了允许的用户-Tito 和 Scott-但 `<deny>` 元素会指示*所有*用户被拒绝。</span><span class="sxs-lookup"><span data-stu-id="25c2f-189">The `<allow>` element defines what users are permitted - Tito and Scott - while the `<deny>` element instructs that *all* users are denied.</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-190">`<allow>` 和 `<deny>` 元素还可以指定角色的授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-190">The `<allow>` and `<deny>` elements can also specify authorization rules for roles.</span></span> <span data-ttu-id="25c2f-191">我们将在将来的教程中检查基于角色的授权。</span><span class="sxs-lookup"><span data-stu-id="25c2f-191">We will examine role-based authorization in a future tutorial.</span></span>

<span data-ttu-id="25c2f-192">以下设置授予 Sam 以外的任何人的访问权限：</span><span class="sxs-lookup"><span data-stu-id="25c2f-192">The following setting grants access to anyone other than Sam (including anonymous visitors):</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample2.xml)]

<span data-ttu-id="25c2f-193">若要仅允许经过身份验证的用户，请使用以下配置，这将拒绝对所有匿名用户的访问：</span><span class="sxs-lookup"><span data-stu-id="25c2f-193">To allow only authenticated users, use the following configuration, which denies access to all anonymous users:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample3.xml)]

<span data-ttu-id="25c2f-194">授权规则在 `Web.config` 中的 `<system.web>` 元素内定义，并应用于 web 应用程序中的所有 ASP.NET 资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-194">The authorization rules are defined within the `<system.web>` element in `Web.config` and apply to all of the ASP.NET resources in the web application.</span></span> <span data-ttu-id="25c2f-195">通常，应用程序的不同部分具有不同的授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-195">Oftentimes, an application has different authorization rules for different sections.</span></span> <span data-ttu-id="25c2f-196">例如，在电子商务网站上，所有访问者都可能细读产品，请参阅产品评论，搜索目录，等等。</span><span class="sxs-lookup"><span data-stu-id="25c2f-196">For example, at an eCommerce site, all visitors may peruse the products, see product reviews, search the catalog, and so on.</span></span> <span data-ttu-id="25c2f-197">但是，只有经过身份验证的用户可以访问结帐或页面来管理一个发货历史记录。</span><span class="sxs-lookup"><span data-stu-id="25c2f-197">However, only authenticated users may reach the checkout or the pages to manage one's shipping history.</span></span> <span data-ttu-id="25c2f-198">而且，只能通过选择用户（如站点管理员）访问站点的某些部分。</span><span class="sxs-lookup"><span data-stu-id="25c2f-198">Moreover, there may be portions of the site that are only accessible by select users, such as site administrators.</span></span>

<span data-ttu-id="25c2f-199">ASP.NET 使为站点中的不同文件和文件夹定义不同的授权规则变得简单。</span><span class="sxs-lookup"><span data-stu-id="25c2f-199">ASP.NET makes it easy to define different authorization rules for different files and folders in the site.</span></span> <span data-ttu-id="25c2f-200">根文件夹的 `Web.config` 文件中指定的授权规则适用于站点中的所有 ASP.NET 资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-200">The authorization rules specified in the root folder's `Web.config` file apply to all ASP.NET resources in the site.</span></span> <span data-ttu-id="25c2f-201">但是，可以通过使用 `<authorization>` 部分添加 `Web.config` 来覆盖特定文件夹的默认授权设置。</span><span class="sxs-lookup"><span data-stu-id="25c2f-201">However, these default authorization settings can be overridden for a particular folder by adding a `Web.config` with an `<authorization>` section.</span></span>

<span data-ttu-id="25c2f-202">让我们更新网站，以便只有经过身份验证的用户可以访问 `Membership` 文件夹中的 ASP.NET 页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-202">Let's update our website so that only authenticated users can visit the ASP.NET pages in the `Membership` folder.</span></span> <span data-ttu-id="25c2f-203">若要实现此目的，我们需要将 `Web.config` 文件添加到 `Membership` 文件夹中，并将其授权设置设置为 "拒绝匿名用户"。</span><span class="sxs-lookup"><span data-stu-id="25c2f-203">To accomplish this we need to add a `Web.config` file to the `Membership` folder and set its authorization settings to deny anonymous users.</span></span> <span data-ttu-id="25c2f-204">右键单击解决方案资源管理器中的 "`Membership`" 文件夹，从上下文菜单中选择 "添加新项" 菜单，然后添加名为 "`Web.config`" 的新 Web 配置文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-204">Right-click the `Membership` folder in the Solution Explorer, choose the Add New Item menu from the context menu, and add a new Web Configuration File named `Web.config`.</span></span>

<span data-ttu-id="25c2f-205">[![将 Web.config 文件添加到成员资格文件夹](user-based-authorization-cs/_static/image8.png)](user-based-authorization-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-205">[![Add a Web.config File to the Membership Folder](user-based-authorization-cs/_static/image8.png)](user-based-authorization-cs/_static/image7.png)</span></span>

<span data-ttu-id="25c2f-206">**图 3**：将 `Web.config` 文件添加到 `Membership` 文件夹（[单击查看完全大小的图像](user-based-authorization-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-206">**Figure 3**: Add a `Web.config` File to the `Membership` Folder  ([Click to view full-size image](user-based-authorization-cs/_static/image9.png))</span></span>

<span data-ttu-id="25c2f-207">此时，你的项目应包含两个 `Web.config` 文件：一个位于根目录中，另一个位于 `Membership` 文件夹中。</span><span class="sxs-lookup"><span data-stu-id="25c2f-207">At this point your project should contain two `Web.config` files: one in the root directory and one in the `Membership` folder.</span></span>

<span data-ttu-id="25c2f-208">[![应用程序现在应包含两个 web.config 文件](user-based-authorization-cs/_static/image11.png)](user-based-authorization-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-208">[![Your Application Should Now Contain Two Web.config Files](user-based-authorization-cs/_static/image11.png)](user-based-authorization-cs/_static/image10.png)</span></span>

<span data-ttu-id="25c2f-209">**图 4**：应用程序现在应包含两个 `Web.config` 文件（[单击以查看完全大小的图像](user-based-authorization-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-209">**Figure 4**: Your Application Should Now Contain Two `Web.config` Files  ([Click to view full-size image](user-based-authorization-cs/_static/image12.png))</span></span>

<span data-ttu-id="25c2f-210">更新 `Membership` 文件夹中的配置文件，使其禁止匿名用户访问。</span><span class="sxs-lookup"><span data-stu-id="25c2f-210">Update the configuration file in the `Membership` folder so that it prohibits access to anonymous users.</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample4.xml)]

<span data-ttu-id="25c2f-211">就这么简单！</span><span class="sxs-lookup"><span data-stu-id="25c2f-211">That's all there is to it!</span></span>

<span data-ttu-id="25c2f-212">若要测试此更改，请在浏览器中访问主页，并确保已注销。由于 ASP.NET 应用程序的默认行为是允许所有访问者，而且由于未对根目录的 `Web.config` 文件进行任何授权修改，因此，我们能够以匿名访问者身份访问根目录中的文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-212">To test out this change, visit the homepage in a browser and make sure you are logged out. Since the default behavior of an ASP.NET application is to allow all visitors, and since we didn't make any authorization modifications to the root directory's `Web.config` file, we are able to visit the files in the root directory as an anonymous visitor.</span></span>

<span data-ttu-id="25c2f-213">单击左栏中的 "创建用户帐户" 链接。</span><span class="sxs-lookup"><span data-stu-id="25c2f-213">Click on the Creating User Accounts link found in the left column.</span></span> <span data-ttu-id="25c2f-214">这会转到 `~/Membership/CreatingUserAccounts.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-214">This will take you to the `~/Membership/CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="25c2f-215">由于 `Membership` 文件夹中的 `Web.config` 文件定义了禁止匿名访问的授权规则，`UrlAuthorizationModule` 中止请求并返回 HTTP 401 未经授权状态。</span><span class="sxs-lookup"><span data-stu-id="25c2f-215">Since the `Web.config` file in the `Membership` folder defines authorization rules to prohibit anonymous access, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="25c2f-216">`FormsAuthenticationModule` 将其修改为302重定向状态，并将我们发送到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-216">The `FormsAuthenticationModule` modifies this to a 302 Redirect status, sending us to the login page.</span></span> <span data-ttu-id="25c2f-217">请注意，我们尝试访问的页（`CreatingUserAccounts.aspx`）通过 `ReturnUrl` querystring 参数传递到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-217">Note that the page we were attempting to access (`CreatingUserAccounts.aspx`) is passed to the login page via the `ReturnUrl` querystring parameter.</span></span>

<span data-ttu-id="25c2f-218">[![因为 URL 授权规则禁止匿名访问，所以我们将重定向到登录页](user-based-authorization-cs/_static/image14.png)](user-based-authorization-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-218">[![Since the URL Authorization Rules Prohibit Anonymous Access, We are Redirected to the Login Page](user-based-authorization-cs/_static/image14.png)](user-based-authorization-cs/_static/image13.png)</span></span>

<span data-ttu-id="25c2f-219">**图 5**：由于 URL 授权规则禁止匿名访问，我们将重定向到登录页（[单击以查看完全大小的映像](user-based-authorization-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-219">**Figure 5**: Since the URL Authorization Rules Prohibit Anonymous Access, We are Redirected to the Login Page  ([Click to view full-size image](user-based-authorization-cs/_static/image15.png))</span></span>

<span data-ttu-id="25c2f-220">成功登录后，会重定向到 "`CreatingUserAccounts.aspx`" 页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-220">Upon successfully logging in, we are redirected to the `CreatingUserAccounts.aspx` page.</span></span> <span data-ttu-id="25c2f-221">这次 `UrlAuthorizationModule` 允许访问页面，因为我们不再是匿名的。</span><span class="sxs-lookup"><span data-stu-id="25c2f-221">This time the `UrlAuthorizationModule` permits access to the page because we are no longer anonymous.</span></span>

### <a name="applying-url-authorization-rules-to-a-specific-location"></a><span data-ttu-id="25c2f-222">将 URL 授权规则应用于特定位置</span><span class="sxs-lookup"><span data-stu-id="25c2f-222">Applying URL Authorization Rules to a Specific Location</span></span>

<span data-ttu-id="25c2f-223">`Web.config` 的 `<system.web>` 部分中定义的授权设置适用于该目录及其子目录中的所有 ASP.NET 资源（除非另一个 `Web.config` 文件重写）。</span><span class="sxs-lookup"><span data-stu-id="25c2f-223">The authorization settings defined in the `<system.web>` section of `Web.config` apply to all of the ASP.NET resources in that directory and its subdirectories (until otherwise overridden by another `Web.config` file).</span></span> <span data-ttu-id="25c2f-224">然而，在某些情况下，我们可能希望给定目录中的所有 ASP.NET 资源具有特定的授权配置，但只有一个或两个特定页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-224">In some cases, though, we may want all ASP.NET resources in a given directory to have a particular authorization configuration except for one or two specific pages.</span></span> <span data-ttu-id="25c2f-225">这可以通过将 `<location>` 元素添加到 `Web.config`中来实现，将其指向授权规则不同的文件，并在其中定义其唯一的授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-225">This can be achieved by adding a `<location>` element in `Web.config`, pointing it to the file whose authorization rules differ, and defining its unique authorization rules therein.</span></span>

<span data-ttu-id="25c2f-226">为了说明如何使用 `<location>` 元素覆盖特定资源的配置设置，我们自定义授权设置，以便只有 Tito 可以访问 `CreatingUserAccounts.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-226">To illustrate using the `<location>` element to override the configuration settings for a specific resource, let's customize the authorization settings so that only Tito can visit `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="25c2f-227">若要实现此目的，请将 `<location>` 元素添加到 `Membership` 文件夹的 `Web.config` 文件，并更新其标记，使其类似于以下内容：</span><span class="sxs-lookup"><span data-stu-id="25c2f-227">To accomplish this, add a `<location>` element to the `Membership` folder's `Web.config` file and update its markup so that it looks like the following:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample5.xml)]

<span data-ttu-id="25c2f-228">`<system.web>` 中的 `<authorization>` 元素定义了 `Membership` 文件夹及其子文件夹中 ASP.NET 资源的默认 URL 授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-228">The `<authorization>` element in `<system.web>` defines the default URL authorization rules for ASP.NET resources in the `Membership` folder and its subfolders.</span></span> <span data-ttu-id="25c2f-229">`<location>` 元素允许我们覆盖特定资源的这些规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-229">The `<location>` element allows us to override these rules for a particular resource.</span></span> <span data-ttu-id="25c2f-230">在上述标记中，`<location>` 元素引用 `CreatingUserAccounts.aspx` 页，并指定它的授权规则，例如允许 Tito，但拒绝其他所有人。</span><span class="sxs-lookup"><span data-stu-id="25c2f-230">In the above markup the `<location>` element references the `CreatingUserAccounts.aspx` page and specifies its authorization rules such as to allow Tito, but deny everyone else.</span></span>

<span data-ttu-id="25c2f-231">若要测试此授权更改，请先以匿名用户身份访问该网站。</span><span class="sxs-lookup"><span data-stu-id="25c2f-231">To test out this authorization change, start by visiting the website as an anonymous user.</span></span> <span data-ttu-id="25c2f-232">如果你尝试访问 `Membership` 文件夹中的任何页面（如 `UserBasedAuthorization.aspx`），`UrlAuthorizationModule` 将拒绝该请求，你会被重定向到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-232">If you attempt to visit any page in the `Membership` folder, such as `UserBasedAuthorization.aspx`, the `UrlAuthorizationModule` will deny the request and you will be redirected to the login page.</span></span> <span data-ttu-id="25c2f-233">以 "Scott" 的身份登录后，可以访问 `Membership` 文件夹中*除 `CreatingUserAccounts.aspx`之外*的任何页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-233">After logging in as, say, Scott, you can visit any page in the `Membership` folder *except* for `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="25c2f-234">尝试访问 `CreatingUserAccounts.aspx` 作为任何人（但 Tito 登录）将导致未经授权的访问尝试，并将你重定向回登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-234">Attempting to visit `CreatingUserAccounts.aspx` logged on as anyone but Tito will result in an unauthorized access attempt, redirecting you back to the login page.</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-235">`<location>` 元素必须出现在配置的 `<system.web>` 元素之外。</span><span class="sxs-lookup"><span data-stu-id="25c2f-235">The `<location>` element must appear outside of the configuration's `<system.web>` element.</span></span> <span data-ttu-id="25c2f-236">需要为要重写其授权设置的每个资源使用单独的 `<location>` 元素。</span><span class="sxs-lookup"><span data-stu-id="25c2f-236">You need to use a separate `<location>` element for each resource whose authorization settings you want to override.</span></span>

### <a name="a-look-at-how-theurlauthorizationmoduleuses-the-authorization-rules-to-grant-or-deny-access"></a><span data-ttu-id="25c2f-237">介绍`UrlAuthorizationModule`如何使用授权规则来授予或拒绝访问权限</span><span class="sxs-lookup"><span data-stu-id="25c2f-237">A Look at How the`UrlAuthorizationModule`Uses the Authorization Rules to Grant or Deny Access</span></span>

<span data-ttu-id="25c2f-238">`UrlAuthorizationModule` 通过一次分析 URL 授权规则（从第一个标识符开始并向下工作），确定是否为特定 URL 授权特定标识。</span><span class="sxs-lookup"><span data-stu-id="25c2f-238">The `UrlAuthorizationModule` determines whether to authorize a particular identity for a particular URL by analyzing the URL authorization rules one at a time, starting from the first one and working its way down.</span></span> <span data-ttu-id="25c2f-239">一旦找到匹配项，就会向用户授予或拒绝访问权限，具体取决于是否在 `<allow>` 或 `<deny>` 元素中找到了匹配项。</span><span class="sxs-lookup"><span data-stu-id="25c2f-239">As soon as a match is found, the user is granted or denied access, depending on if the match was found in an `<allow>` or `<deny>` element.</span></span> <span data-ttu-id="25c2f-240"><strong>如果未找到匹配项，则会向用户授予访问权限。</strong></span><span class="sxs-lookup"><span data-stu-id="25c2f-240"><strong>If no match is found, the user is granted access.</strong></span></span> <span data-ttu-id="25c2f-241">因此，如果要限制访问，则必须使用 `<deny>` 元素作为 URL 授权配置中的最后一个元素。</span><span class="sxs-lookup"><span data-stu-id="25c2f-241">Consequently, if you want to restrict access, it is imperative that you use a `<deny>` element as the last element in the URL authorization configuration.</span></span> <span data-ttu-id="25c2f-242"><strong>如果省略</strong><strong>`<deny>`</strong><strong>元素，则会向所有用户授予访问权限。</strong></span><span class="sxs-lookup"><span data-stu-id="25c2f-242"><strong>If you omit a</strong><strong>`<deny>`</strong><strong>element, all users will be granted access.</strong></span></span>

<span data-ttu-id="25c2f-243">为了更好地了解 `UrlAuthorizationModule` 用来确定机构的过程，请考虑我们在此步骤中前面讨论的示例 URL 授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-243">To better understand the process used by the `UrlAuthorizationModule` to determine authority, consider the example URL authorization rules we looked at earlier in this step.</span></span> <span data-ttu-id="25c2f-244">第一个规则是允许访问 Tito 和 Scott 的 `<allow>` 元素。</span><span class="sxs-lookup"><span data-stu-id="25c2f-244">The first rule is an `<allow>` element that allows access to Tito and Scott.</span></span> <span data-ttu-id="25c2f-245">第二个规则是拒绝所有人的访问的 `<deny>` 元素。</span><span class="sxs-lookup"><span data-stu-id="25c2f-245">The second rules is a `<deny>` element that denies access to everyone.</span></span> <span data-ttu-id="25c2f-246">如果匿名用户访问，`UrlAuthorizationModule` 会询问，匿名是 Scott 还是 Tito？</span><span class="sxs-lookup"><span data-stu-id="25c2f-246">If an anonymous user visits, the `UrlAuthorizationModule` starts by asking, Is anonymous either Scott or Tito?</span></span> <span data-ttu-id="25c2f-247">当然，答案是不是的，因此它会前进到第二个规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-247">The answer, obviously, is No, so it proceeds to the second rule.</span></span> <span data-ttu-id="25c2f-248">每个人集中都是匿名的吗？</span><span class="sxs-lookup"><span data-stu-id="25c2f-248">Is anonymous in the set of everybody?</span></span> <span data-ttu-id="25c2f-249">由于此处的答案是肯定的，`<deny>` 规则已生效，访问者将重定向到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-249">Since the answer here is Yes, the `<deny>` rule is put in effect and the visitor is redirected to the login page.</span></span> <span data-ttu-id="25c2f-250">同样，如果 Jisun 正在访问，则 `UrlAuthorizationModule` 首先会询问，是 Jisun 还是 Tito？</span><span class="sxs-lookup"><span data-stu-id="25c2f-250">Similarly, if Jisun is visiting, the `UrlAuthorizationModule` starts by asking, Is Jisun either Scott or Tito?</span></span> <span data-ttu-id="25c2f-251">由于她不是，`UrlAuthorizationModule` 继续第二个问题，每个人都在 Jisun？</span><span class="sxs-lookup"><span data-stu-id="25c2f-251">Since she is not, the `UrlAuthorizationModule` proceeds to the second question, Is Jisun in the set of everybody?</span></span> <span data-ttu-id="25c2f-252">她是，我们也被拒绝访问。</span><span class="sxs-lookup"><span data-stu-id="25c2f-252">She is, so she, too, is denied access.</span></span> <span data-ttu-id="25c2f-253">最后，如果 Tito 访问，`UrlAuthorizationModule` 提出的第一个问题是赞成答案，因此 Tito 被授予访问权限。</span><span class="sxs-lookup"><span data-stu-id="25c2f-253">Finally, if Tito visits, the first question posed by the `UrlAuthorizationModule` is an affirmative answer, so Tito is granted access.</span></span>

<span data-ttu-id="25c2f-254">由于 `UrlAuthorizationModule` 处理从上到下的授权规则，在任何匹配时停止，因此，在不太具体的规则之前有更具体的规则是非常重要的。</span><span class="sxs-lookup"><span data-stu-id="25c2f-254">Since the `UrlAuthorizationModule` processes the authorization rules from the top down, stopping at any match, it is important to have the more specific rules come before the less specific ones.</span></span> <span data-ttu-id="25c2f-255">也就是说，若要定义禁止 Jisun 和匿名用户的授权规则，但允许所有其他经过身份验证的用户，请从最具体的规则开始，其中一个规则会影响 Jisun，然后继续执行不太具体的规则-这些规则允许所有其他操作经过身份验证的用户，但拒绝所有匿名用户。</span><span class="sxs-lookup"><span data-stu-id="25c2f-255">That is, to define authorization rules that forbid Jisun and anonymous users, but allow all other authenticated users, you would start with the most specific rule - the one impacting Jisun - and then proceed to the less specific rules - those allowing all other authenticated users, but denying all anonymous users.</span></span> <span data-ttu-id="25c2f-256">以下 URL 授权规则通过首先拒绝 Jisun 并拒绝任何匿名用户来实现此策略。</span><span class="sxs-lookup"><span data-stu-id="25c2f-256">The following URL authorization rules implements this policy by first denying Jisun, and then denying any anonymous user.</span></span> <span data-ttu-id="25c2f-257">除 Jisun 以外的任何经过身份验证的用户都将被授予访问权限，因为 `<deny>` 这两个语句都不匹配。</span><span class="sxs-lookup"><span data-stu-id="25c2f-257">Any authenticated user other than Jisun will be granted access because neither of these `<deny>` statements will match.</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample6.xml)]

## <a name="step-2-fixing-the-workflow-for-unauthorized-authenticated-users"></a><span data-ttu-id="25c2f-258">步骤2：针对未经授权的经过身份验证的用户修复工作流</span><span class="sxs-lookup"><span data-stu-id="25c2f-258">Step 2: Fixing the Workflow for Unauthorized, Authenticated Users</span></span>

<span data-ttu-id="25c2f-259">正如我们在本教程前面的 "查看 URL 授权工作流" 一节中讨论的那样，无论何时，如果未经授权的请求发生，`UrlAuthorizationModule` 都将中止请求并返回 HTTP 401 未经授权状态。</span><span class="sxs-lookup"><span data-stu-id="25c2f-259">As we discussed earlier in this tutorial in the A Look at the URL Authorization Workflow section, anytime an unauthorized request transpires, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="25c2f-260">此401状态由 `FormsAuthenticationModule` 修改为将用户发送到登录页的302重定向状态。</span><span class="sxs-lookup"><span data-stu-id="25c2f-260">This 401 status is modified by the `FormsAuthenticationModule` into a 302 Redirect status that sends the user to the login page.</span></span> <span data-ttu-id="25c2f-261">此工作流在任何未经授权的请求上发生，即使用户已进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="25c2f-261">This workflow occurs on any unauthorized request, even if the user is authenticated.</span></span>

<span data-ttu-id="25c2f-262">将经过身份验证的用户返回到登录页可能会将它们混淆，因为它们已经登录系统。</span><span class="sxs-lookup"><span data-stu-id="25c2f-262">Returning an authenticated user to the login page is likely to confuse them since they have already logged into the system.</span></span> <span data-ttu-id="25c2f-263">使用少许工作，我们可以通过将发出未经授权的请求的经过身份验证的用户重定向到说明他们尝试访问受限页面的页面，来改进此工作流。</span><span class="sxs-lookup"><span data-stu-id="25c2f-263">With a little bit of work we can improve this workflow by redirecting authenticated users who make unauthorized requests to a page that explains that they have attempted to access a restricted page.</span></span>

<span data-ttu-id="25c2f-264">首先，在 web 应用程序的根文件夹中创建一个名为 `UnauthorizedAccess.aspx`的新 "ASP.NET" 页;请不要忘记将此页面与 `Site.master` 母版页关联。</span><span class="sxs-lookup"><span data-stu-id="25c2f-264">Start by creating a new ASP.NET page in the web application's root folder named `UnauthorizedAccess.aspx`; don't forget to associate this page with the `Site.master` master page.</span></span> <span data-ttu-id="25c2f-265">创建此页后，删除引用 `LoginContent` ContentPlaceHolder 的内容控件，以便显示母版页的默认内容。</span><span class="sxs-lookup"><span data-stu-id="25c2f-265">After creating this page, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the master page's default content will be displayed.</span></span> <span data-ttu-id="25c2f-266">接下来，添加一条说明该情况的消息，即用户尝试访问受保护的资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-266">Next, add a message that explains the situation, namely that the user attempted to access a protected resource.</span></span> <span data-ttu-id="25c2f-267">添加此类消息后，`UnauthorizedAccess.aspx` 页的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="25c2f-267">After adding such a message, the `UnauthorizedAccess.aspx` page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample7.aspx)]

<span data-ttu-id="25c2f-268">现在，我们需要更改工作流，以便在经过身份验证的用户执行未经授权的请求时，会将其发送到 `UnauthorizedAccess.aspx` 页，而不是登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-268">We now need to alter the workflow so that if an unauthorized request is performed by an authenticated user they are sent to the `UnauthorizedAccess.aspx` page instead of the login page.</span></span> <span data-ttu-id="25c2f-269">将未经授权的请求重定向到登录页的逻辑隐藏在 `FormsAuthenticationModule` 类的私有方法中，因此我们无法自定义此行为。</span><span class="sxs-lookup"><span data-stu-id="25c2f-269">The logic that redirects unauthorized requests to the login page is buried within a private method of the `FormsAuthenticationModule` class, so we cannot customize this behavior.</span></span> <span data-ttu-id="25c2f-270">然而，我们可以执行的操作是将自己的逻辑添加到登录页，以便在需要时将用户重定向到 `UnauthorizedAccess.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-270">What we can do, however, is add our own logic to the login page that redirects the user to `UnauthorizedAccess.aspx`, if needed.</span></span>

<span data-ttu-id="25c2f-271">当 `FormsAuthenticationModule` 将未经授权的访问者重定向到登录页时，它会将请求的未经授权 URL 附加到名为 `ReturnUrl`的 querystring。</span><span class="sxs-lookup"><span data-stu-id="25c2f-271">When the `FormsAuthenticationModule` redirects an unauthorized visitor to the login page it appends the requested, unauthorized URL to the querystring with the name `ReturnUrl`.</span></span> <span data-ttu-id="25c2f-272">例如，如果未经授权的用户尝试访问 `OnlyTito.aspx`，则 `FormsAuthenticationModule` 会将它们重定向到 `Login.aspx?ReturnUrl=OnlyTito.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-272">For example, if an unauthorized user attempted to visit `OnlyTito.aspx`, the `FormsAuthenticationModule` would redirect them to `Login.aspx?ReturnUrl=OnlyTito.aspx`.</span></span> <span data-ttu-id="25c2f-273">因此，如果使用包含 `ReturnUrl` 参数的查询字符串的已验证用户访问登录页，则我们知道此未经身份验证的用户刚刚试图访问她无权查看的页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-273">Therefore, if the login page is reached by an authenticated user with a querystring that includes the `ReturnUrl` parameter, then we know that this unauthenticated user just attempted to visit a page she is not authorized to view.</span></span> <span data-ttu-id="25c2f-274">在这种情况下，我们希望将她重定向到 `UnauthorizedAccess.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-274">In such a case, we want to redirect her to `UnauthorizedAccess.aspx`.</span></span>

<span data-ttu-id="25c2f-275">若要实现此目的，请将以下代码添加到登录页的 `Page_Load` 事件处理程序中：</span><span class="sxs-lookup"><span data-stu-id="25c2f-275">To accomplish this, add the following code to the login page's `Page_Load` event handler:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample8.cs)]

<span data-ttu-id="25c2f-276">上述代码将经过身份验证的未经授权用户重定向到 `UnauthorizedAccess.aspx` 页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-276">The above code redirects authenticated, unauthorized users to the `UnauthorizedAccess.aspx` page.</span></span> <span data-ttu-id="25c2f-277">若要查看此逻辑操作，请访问站点作为匿名访问者，并单击左栏中的 "创建用户帐户" 链接。</span><span class="sxs-lookup"><span data-stu-id="25c2f-277">To see this logic in action, visit the site as an anonymous visitor and click on the Creating User Accounts link in the left column.</span></span> <span data-ttu-id="25c2f-278">这会转到 "`~/Membership/CreatingUserAccounts.aspx`" 页面，该页面在步骤1中配置为仅允许访问 Tito。</span><span class="sxs-lookup"><span data-stu-id="25c2f-278">This will take you to the `~/Membership/CreatingUserAccounts.aspx` page, which in Step 1 we configured to only permit access to Tito.</span></span> <span data-ttu-id="25c2f-279">由于禁止匿名用户，`FormsAuthenticationModule` 会将我们重定向回登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-279">Since anonymous users are prohibited, the `FormsAuthenticationModule` redirects us back to the login page.</span></span>

<span data-ttu-id="25c2f-280">此时，我们是匿名的，因此 `Request.IsAuthenticated` 返回 `false`，并且我们不会重定向到 `UnauthorizedAccess.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-280">At this point we are anonymous, so `Request.IsAuthenticated` returns `false` and we are not redirected to `UnauthorizedAccess.aspx`.</span></span> <span data-ttu-id="25c2f-281">相反，将显示登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-281">Instead, the login page is displayed.</span></span> <span data-ttu-id="25c2f-282">以除 Tito 以外的用户身份登录，如 Bruce。</span><span class="sxs-lookup"><span data-stu-id="25c2f-282">Log in as a user other than Tito, such as Bruce.</span></span> <span data-ttu-id="25c2f-283">输入相应凭据后，登录页将重新定向到 `~/Membership/CreatingUserAccounts.aspx`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-283">After entering the appropriate credentials, the login page redirects us back to `~/Membership/CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="25c2f-284">但是，由于只有 Tito 可以访问此页，因此我们无权查看它并立即返回到登录页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-284">However, since this page is only accessible to Tito, we are unauthorized to view it and are promptly returned to the login page.</span></span> <span data-ttu-id="25c2f-285">但是，这一次 `Request.IsAuthenticated` 返回 `true` （并且 `ReturnUrl` querystring 参数存在），因此我们将重定向到 `UnauthorizedAccess.aspx` 页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-285">This time, however, `Request.IsAuthenticated` returns `true` (and the `ReturnUrl` querystring parameter exists), so we are redirected to the `UnauthorizedAccess.aspx` page.</span></span>

<span data-ttu-id="25c2f-286">[![经过身份验证，未授权的用户会重定向到 UnauthorizedAccess](user-based-authorization-cs/_static/image17.png)](user-based-authorization-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-286">[![Authenticated, Unauthorized Users are Redirected to UnauthorizedAccess.aspx](user-based-authorization-cs/_static/image17.png)](user-based-authorization-cs/_static/image16.png)</span></span>

<span data-ttu-id="25c2f-287">**图 6**：经过身份验证的未经授权的用户将重定向到 `UnauthorizedAccess.aspx` （[单击查看完全大小的图像](user-based-authorization-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-287">**Figure 6**: Authenticated, Unauthorized Users are Redirected to `UnauthorizedAccess.aspx` ([Click to view full-size image](user-based-authorization-cs/_static/image18.png))</span></span>

<span data-ttu-id="25c2f-288">此自定义工作流提供了一个更为明智的、更简单的用户体验，方法是将图2中所示的周期短路。</span><span class="sxs-lookup"><span data-stu-id="25c2f-288">This customized workflow presents a more sensible and straightforward user experience by short circuiting the cycle depicted in Figure 2.</span></span>

## <a name="step-3-limiting-functionality-based-on-the-currently-logged-in-user"></a><span data-ttu-id="25c2f-289">步骤3：基于当前登录的用户限制功能</span><span class="sxs-lookup"><span data-stu-id="25c2f-289">Step 3: Limiting Functionality Based on the Currently Logged In User</span></span>

<span data-ttu-id="25c2f-290">通过 URL 授权，可轻松指定粗授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-290">URL authorization makes it easy to specify coarse authorization rules.</span></span> <span data-ttu-id="25c2f-291">如我们在步骤1中所述，使用 URL 授权，我们可以简洁地说明允许哪些标识，哪些标识被拒绝查看某个文件夹中的特定页面或所有页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-291">As we saw in Step 1, with URL authorization we can succinctly state what identities are permitted and which ones are denied from viewing a particular page or all pages in a folder.</span></span> <span data-ttu-id="25c2f-292">但是，在某些情况下，我们可能希望允许所有用户访问某个页面，但会根据访问该页面的用户限制其功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-292">In certain scenarios, however, we may want to allow all users to visit a page, but limit the page's functionality based on the user visiting it.</span></span>

<span data-ttu-id="25c2f-293">请考虑电子商务网站的情况，该网站允许经过身份验证的访问者查看其产品。</span><span class="sxs-lookup"><span data-stu-id="25c2f-293">Consider the case of an eCommerce website that allows authenticated visitors to review their products.</span></span> <span data-ttu-id="25c2f-294">匿名用户访问产品页时，他们将只看到产品信息，而不会有机会进行评审。</span><span class="sxs-lookup"><span data-stu-id="25c2f-294">When an anonymous user visits a product's page, they would see just the product information and would not be given the opportunity to leave a review.</span></span> <span data-ttu-id="25c2f-295">但是，访问同一页面的经过身份验证的用户将看到查看界面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-295">However, an authenticated user visiting the same page would see the reviewing interface.</span></span> <span data-ttu-id="25c2f-296">如果经过身份验证的用户尚未查看此产品，则该界面会使他们提交审核;否则，会向他们显示先前提交的评审。</span><span class="sxs-lookup"><span data-stu-id="25c2f-296">If the authenticated user had not yet reviewed this product, the interface would enable them to submit a review; otherwise it would show them their previously-submitted review.</span></span> <span data-ttu-id="25c2f-297">为了使此方案更进一步，"产品" 页可能会显示其他信息并为那些适用于电子商务公司的用户提供扩展功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-297">To take this scenario a step further, the product page might show additional information and offer extended features for those users that work for the eCommerce company.</span></span> <span data-ttu-id="25c2f-298">例如，"产品" 页可能会列出库存库存，并包括在由员工访问时用于编辑产品价格和说明的选项。</span><span class="sxs-lookup"><span data-stu-id="25c2f-298">For example, the product page might list the inventory in stock and include options to edit the product's price and description when visited by an employee.</span></span>

<span data-ttu-id="25c2f-299">可以通过声明方式或编程方式（或通过这两种方式的某个组合）来实现此类精细授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-299">Such fine grain authorization rules can be implemented either declaratively or programmatically (or through some combination of the two).</span></span> <span data-ttu-id="25c2f-300">在下一部分中，我们将了解如何通过登录视图控件实现精细的授权。</span><span class="sxs-lookup"><span data-stu-id="25c2f-300">In the next section we will see how to implement fine grain authorization via the LoginView control.</span></span> <span data-ttu-id="25c2f-301">接下来，我们将探讨编程技术。</span><span class="sxs-lookup"><span data-stu-id="25c2f-301">Following that, we will explore programmatic techniques.</span></span> <span data-ttu-id="25c2f-302">但在查看应用精细授权规则之前，首先需要创建一个页面，该页面的功能依赖于用户访问它。</span><span class="sxs-lookup"><span data-stu-id="25c2f-302">Before we can look at applying fine grain authorization rules, however, we first need to create a page whose functionality depends on the user visiting it.</span></span>

<span data-ttu-id="25c2f-303">让我们创建一个页面，其中列出了 GridView 中特定目录中的文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-303">Let's create a page that lists the files in a particular directory within a GridView.</span></span> <span data-ttu-id="25c2f-304">除了列出每个文件的名称、大小和其他信息外，GridView 还将包括两个 LinkButtons 列：一个标题为 "视图"，一个标题为 "删除"。</span><span class="sxs-lookup"><span data-stu-id="25c2f-304">Along with listing each file's name, size, and other information, the GridView will include two columns of LinkButtons: one titled View and one titled Delete.</span></span> <span data-ttu-id="25c2f-305">如果单击视图 LinkButton，将显示所选文件的内容;如果单击删除 LinkButton，则该文件将被删除。</span><span class="sxs-lookup"><span data-stu-id="25c2f-305">If the View LinkButton is clicked, the contents of the selected file will be displayed; if the Delete LinkButton is clicked, the file will be deleted.</span></span> <span data-ttu-id="25c2f-306">首先，创建此页面，使其 "查看" 和 "删除" 功能可供所有用户使用。</span><span class="sxs-lookup"><span data-stu-id="25c2f-306">Let's initially create this page such that its view and delete functionality is available to all users.</span></span> <span data-ttu-id="25c2f-307">在中，使用登录视图控件和以编程方式限制功能部分，我们将了解如何根据访问页面的用户启用或禁用这些功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-307">In the Using the LoginView Control and Programmatically Limiting Functionality sections we will see how to enable or disable these features based on the user visiting the page.</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-308">我们即将生成的 ASP.NET 页使用 GridView 控件显示文件列表。</span><span class="sxs-lookup"><span data-stu-id="25c2f-308">The ASP.NET page we are about to build uses a GridView control to display a list of files.</span></span> <span data-ttu-id="25c2f-309">由于本教程系列重点介绍 forms 身份验证、授权、用户帐户和角色，我不希望花太多时间讨论 GridView 控件的内部工作原理。</span><span class="sxs-lookup"><span data-stu-id="25c2f-309">Since this tutorial series focuses on forms authentication, authorization, user accounts, and roles, I do not want to spend too much time discussing the inner workings of the GridView control.</span></span> <span data-ttu-id="25c2f-310">虽然本教程提供了有关设置此页面的具体分步说明，但它并不深入探讨某些选择的原因，或特定属性对呈现的输出的影响。</span><span class="sxs-lookup"><span data-stu-id="25c2f-310">While this tutorial provides specific step-by-step instructions for setting up this page, it does not delve into the details of why certain choices were made, or what effect particular properties have on the rendered output.</span></span> <span data-ttu-id="25c2f-311">若要全面检查 GridView 控件，请参阅 *[ASP.NET 2.0 教程系列中的使用数据](../../data-access/index.md)* 。</span><span class="sxs-lookup"><span data-stu-id="25c2f-311">For a thorough examination of the GridView control, consult my *[Working with Data in ASP.NET 2.0](../../data-access/index.md)* tutorial series.</span></span>

<span data-ttu-id="25c2f-312">首先打开 `Membership` 文件夹中的 `UserBasedAuthorization.aspx` 文件，然后将 GridView 控件添加到名为 `FilesGrid`的页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-312">Start by opening the `UserBasedAuthorization.aspx` file in the `Membership` folder and adding a GridView control to the page named `FilesGrid`.</span></span> <span data-ttu-id="25c2f-313">从 GridView 的智能标记中，单击 "编辑列" 链接以启动 "字段" 对话框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-313">From the GridView's Smart Tag, click the Edit Columns link to launch the Fields dialog box.</span></span> <span data-ttu-id="25c2f-314">在此处，取消选中左下角的 "自动生成字段" 复选框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-314">From here, uncheck the Auto-generate fields checkbox in the lower left corner.</span></span> <span data-ttu-id="25c2f-315">接下来，从左上角添加 "选择" 按钮、"删除" 按钮和两个 BoundFields （"选择" 和 "删除" 按钮可在 CommandField 类型下找到）。</span><span class="sxs-lookup"><span data-stu-id="25c2f-315">Next, add a Select button, a Delete button, and two BoundFields from the upper left corner (the Select and Delete buttons can be found under the CommandField type).</span></span> <span data-ttu-id="25c2f-316">将 "选择" 按钮的 `SelectText` 属性设置为 "查看"，并将第一个 BoundField 的 `HeaderText` 和 `DataField` 属性设置为 "名称"。</span><span class="sxs-lookup"><span data-stu-id="25c2f-316">Set the Select button's `SelectText` property to View and the first BoundField's `HeaderText` and `DataField` properties to Name.</span></span> <span data-ttu-id="25c2f-317">将第二个 BoundField 的 `HeaderText` 属性设置为大小（以字节为单位），将其 `DataField` 属性设置为 Length，将其 `DataFormatString` `HtmlEncode` {0:N0} 属性设置为 "False"。</span><span class="sxs-lookup"><span data-stu-id="25c2f-317">Set the second BoundField's `HeaderText` property to Size in Bytes, its `DataField` property to Length, its `DataFormatString` property to {0:N0} and its `HtmlEncode` property to False.</span></span>

<span data-ttu-id="25c2f-318">配置 GridView 列后，单击 "确定" 以关闭 "字段" 对话框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-318">After configuring the GridView's columns, click OK to close the Fields dialog box.</span></span> <span data-ttu-id="25c2f-319">在属性窗口中，将 GridView 的 `DataKeyNames` 属性设置为 "`FullName`"。</span><span class="sxs-lookup"><span data-stu-id="25c2f-319">From the Properties window, set the GridView's `DataKeyNames` property to `FullName`.</span></span> <span data-ttu-id="25c2f-320">此时，GridView 的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="25c2f-320">At this point the GridView's declarative markup should look like the following:</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample9.aspx)]

<span data-ttu-id="25c2f-321">创建 GridView 标记后，就可以编写代码来检索特定目录中的文件，并将它们绑定到 GridView。</span><span class="sxs-lookup"><span data-stu-id="25c2f-321">With the GridView's markup created, we're ready to write the code that will retrieve the files in a particular directory and bind them to the GridView.</span></span> <span data-ttu-id="25c2f-322">将以下代码添加到页面的 `Page_Load` 事件处理程序中：</span><span class="sxs-lookup"><span data-stu-id="25c2f-322">Add the following code to the page's `Page_Load` event handler:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample10.cs)]

<span data-ttu-id="25c2f-323">上面的代码使用[`DirectoryInfo` 类](https://msdn.microsoft.com/library/system.io.directoryinfo.aspx)获取应用程序根文件夹中的文件列表。</span><span class="sxs-lookup"><span data-stu-id="25c2f-323">The above code uses the [`DirectoryInfo` class](https://msdn.microsoft.com/library/system.io.directoryinfo.aspx) to obtain a list of the files in the application's root folder.</span></span> <span data-ttu-id="25c2f-324">[`GetFiles()` 方法](https://msdn.microsoft.com/library/system.io.directoryinfo.getfiles.aspx)将目录中的所有文件作为[`FileInfo` 对象](https://msdn.microsoft.com/library/system.io.fileinfo.aspx)的数组返回，然后将其绑定到 GridView。</span><span class="sxs-lookup"><span data-stu-id="25c2f-324">The [`GetFiles()` method](https://msdn.microsoft.com/library/system.io.directoryinfo.getfiles.aspx) returns all of the files in the directory as an array of [`FileInfo` objects](https://msdn.microsoft.com/library/system.io.fileinfo.aspx), which is then bound to the GridView.</span></span> <span data-ttu-id="25c2f-325">`FileInfo` 对象具有多个属性，如 `Name`、`Length`和 `IsReadOnly`，等等。</span><span class="sxs-lookup"><span data-stu-id="25c2f-325">The `FileInfo` object has an assortment of properties, such as `Name`, `Length`, and `IsReadOnly`, among others.</span></span> <span data-ttu-id="25c2f-326">从其声明性标记中可以看到，GridView 只显示 `Name` 和 `Length` 属性。</span><span class="sxs-lookup"><span data-stu-id="25c2f-326">As you can see from its declarative markup, the GridView displays just the `Name` and `Length` properties.</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-327">`DirectoryInfo` 和 `FileInfo` 类在[`System.IO` 命名空间](https://msdn.microsoft.com/library/system.io.aspx)中找到。</span><span class="sxs-lookup"><span data-stu-id="25c2f-327">The `DirectoryInfo` and `FileInfo` classes are found in the [`System.IO` namespace](https://msdn.microsoft.com/library/system.io.aspx).</span></span> <span data-ttu-id="25c2f-328">因此，您需要将这些类名称作为命名空间名称的开头，或者将命名空间导入类文件（通过 `using System.IO`）。</span><span class="sxs-lookup"><span data-stu-id="25c2f-328">Therefore, you will either need to preface these class names with their namespace names or have the namespace imported into the class file (via `using System.IO`).</span></span>

<span data-ttu-id="25c2f-329">请花点时间通过浏览器访问此页。</span><span class="sxs-lookup"><span data-stu-id="25c2f-329">Take a moment to visit this page through a browser.</span></span> <span data-ttu-id="25c2f-330">它将显示驻留在应用程序的根目录中的文件的列表。</span><span class="sxs-lookup"><span data-stu-id="25c2f-330">It will display the list of files residing in the application's root directory.</span></span> <span data-ttu-id="25c2f-331">单击任意视图或删除 LinkButtons 将导致回发，但不会执行任何操作，因为我们尚未创建必要的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="25c2f-331">Clicking any of the View or Delete LinkButtons will cause a postback, but no action will occur because we've yet to create the necessary event handlers.</span></span>

<span data-ttu-id="25c2f-332">[![GridView 列出 Web 应用程序的根目录中的文件](user-based-authorization-cs/_static/image20.png)](user-based-authorization-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-332">[![The GridView Lists the Files in the Web Application's Root Directory](user-based-authorization-cs/_static/image20.png)](user-based-authorization-cs/_static/image19.png)</span></span>

<span data-ttu-id="25c2f-333">**图 7**： GridView 列出了 Web 应用程序的根目录中的文件（[单击以查看完全大小的映像](user-based-authorization-cs/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-333">**Figure 7**: The GridView Lists the Files in the Web Application's Root Directory  ([Click to view full-size image](user-based-authorization-cs/_static/image21.png))</span></span>

<span data-ttu-id="25c2f-334">我们需要一种方法来显示所选文件的内容。</span><span class="sxs-lookup"><span data-stu-id="25c2f-334">We need a means to display the contents of the selected file.</span></span> <span data-ttu-id="25c2f-335">返回到 Visual Studio，并将名为 `FileContents` 的文本框添加到 GridView 之上。</span><span class="sxs-lookup"><span data-stu-id="25c2f-335">Return to Visual Studio and add a TextBox named `FileContents` above the GridView.</span></span> <span data-ttu-id="25c2f-336">将其 `TextMode` 属性设置为 `MultiLine` 及其 `Columns`，并将 `Rows` 属性分别设置为95% 和10。</span><span class="sxs-lookup"><span data-stu-id="25c2f-336">Set its `TextMode` property to `MultiLine` and its `Columns` and `Rows` properties to 95% and 10, respectively.</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample11.aspx)]

<span data-ttu-id="25c2f-337">接下来，为 GridView 的[`SelectedIndexChanged` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.selectedindexchanged.aspx)创建事件处理程序并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="25c2f-337">Next, create an event handler for the GridView's [`SelectedIndexChanged` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.selectedindexchanged.aspx) and add the following code:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample12.cs)]

<span data-ttu-id="25c2f-338">此代码使用 GridView 的 `SelectedValue` 属性来确定所选文件的完整文件名。</span><span class="sxs-lookup"><span data-stu-id="25c2f-338">This code uses the GridView's `SelectedValue` property to determine the full file name of the selected file.</span></span> <span data-ttu-id="25c2f-339">在内部，引用 `DataKeys` 集合以获取 `SelectedValue`，因此，必须将 GridView 的 `DataKeyNames` 属性设置为 Name，如此步骤中前面所述。</span><span class="sxs-lookup"><span data-stu-id="25c2f-339">Internally, the `DataKeys` collection is referenced in order to obtain the `SelectedValue`, so it is imperative that you set the GridView's `DataKeyNames` property to Name, as described earlier in this step.</span></span> <span data-ttu-id="25c2f-340">[`File` 类](https://msdn.microsoft.com/library/system.io.file.aspx)用于将所选文件的内容读入字符串中，然后将其分配给 `FileContents` 文本框的 `Text` 属性，从而在页面上显示所选文件的内容。</span><span class="sxs-lookup"><span data-stu-id="25c2f-340">The [`File` class](https://msdn.microsoft.com/library/system.io.file.aspx) is used to read the selected file's contents into a string, which is then assigned to the `FileContents` TextBox's `Text` property, thereby displaying the contents of the selected file on the page.</span></span>

<span data-ttu-id="25c2f-341">[![在文本框中显示所选文件的内容](user-based-authorization-cs/_static/image23.png)](user-based-authorization-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-341">[![The Selected File's Contents are Displayed in the TextBox](user-based-authorization-cs/_static/image23.png)](user-based-authorization-cs/_static/image22.png)</span></span>

<span data-ttu-id="25c2f-342">**图 8**：在文本框中显示所选文件的内容（[单击以查看完全尺寸的图像](user-based-authorization-cs/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-342">**Figure 8**: The Selected File's Contents are Displayed in the TextBox  ([Click to view full-size image](user-based-authorization-cs/_static/image24.png))</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-343">如果查看包含 HTML 标记的文件的内容，然后尝试查看或删除文件，则将收到 `HttpRequestValidationException` 错误。</span><span class="sxs-lookup"><span data-stu-id="25c2f-343">If you view the contents of a file that contains HTML markup, and then attempt to view or delete a file, you will receive an `HttpRequestValidationException` error.</span></span> <span data-ttu-id="25c2f-344">出现这种情况的原因是，在回发时，文本框的内容将发送回 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="25c2f-344">This occurs because on postback the TextBox's contents are sent back to the web server.</span></span> <span data-ttu-id="25c2f-345">默认情况下，只要检测到潜在的危险回发内容（如 HTML 标记），ASP.NET 就会引发 `HttpRequestValidationException` 错误。</span><span class="sxs-lookup"><span data-stu-id="25c2f-345">By default, ASP.NET raises an `HttpRequestValidationException` error whenever potentially dangerous postback content, such as HTML markup, is detected.</span></span> <span data-ttu-id="25c2f-346">若要禁用此错误，请通过将 `ValidateRequest="false"` 添加到 `@Page` 指令来关闭对该页的请求验证。</span><span class="sxs-lookup"><span data-stu-id="25c2f-346">To disable this error from occurring, turn off request validation for the page by adding `ValidateRequest="false"` to the `@Page` directive.</span></span> <span data-ttu-id="25c2f-347">有关请求验证的优点以及禁用它时应采取的措施的详细信息，请阅读[请求验证-阻止脚本攻击](https://asp.net/learn/whitepapers/request-validation/)。</span><span class="sxs-lookup"><span data-stu-id="25c2f-347">For more information on the benefits of request validation as well as what precautions you should take when disabling it, read [Request Validation - Preventing Script Attacks](https://asp.net/learn/whitepapers/request-validation/).</span></span>

<span data-ttu-id="25c2f-348">最后，使用以下代码为 GridView 的[`RowDeleting` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx)添加事件处理程序：</span><span class="sxs-lookup"><span data-stu-id="25c2f-348">Finally, add an event handler with the following code for the GridView's [`RowDeleting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx):</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample13.cs)]

<span data-ttu-id="25c2f-349">该代码只是在 "`FileContents`" 文本框中显示要删除的文件的完整名称，*而无需*实际删除该文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-349">The code simply displays the full name of the file to delete in the `FileContents` TextBox *without* actually deleting the file.</span></span>

<span data-ttu-id="25c2f-350">[单击 "删除" 按钮 ![实际上不会删除该文件](user-based-authorization-cs/_static/image26.png)](user-based-authorization-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-350">[![Clicking the Delete Button Does Not Actually Delete the File](user-based-authorization-cs/_static/image26.png)](user-based-authorization-cs/_static/image25.png)</span></span>

<span data-ttu-id="25c2f-351">**图 9**：单击 "删除" 按钮并不会实际删除该文件（[单击查看完全尺寸的图像](user-based-authorization-cs/_static/image27.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-351">**Figure 9**: Clicking the Delete Button Does Not Actually Delete the File  ([Click to view full-size image](user-based-authorization-cs/_static/image27.png))</span></span>

<span data-ttu-id="25c2f-352">在步骤1中，我们配置了 URL 授权规则，禁止匿名用户查看 `Membership` 文件夹中的页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-352">In Step 1 we configured the URL authorization rules to prohibit anonymous users from viewing the pages in the `Membership` folder.</span></span> <span data-ttu-id="25c2f-353">为了更好地展示精细的身份验证，让匿名用户可以访问 `UserBasedAuthorization.aspx` 页面，但功能有限。</span><span class="sxs-lookup"><span data-stu-id="25c2f-353">In order to better exhibit fine grain authentication, let's allow anonymous users to visit the `UserBasedAuthorization.aspx` page, but with limited functionality.</span></span> <span data-ttu-id="25c2f-354">若要打开此页面，使其可供所有用户访问，请将以下 `<location>` 元素添加到 `Membership` 文件夹中的 `Web.config` 文件：</span><span class="sxs-lookup"><span data-stu-id="25c2f-354">To open this page up to be accessed by all users, add the following `<location>` element to the `Web.config` file in the `Membership` folder:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample14.xml)]

<span data-ttu-id="25c2f-355">添加此 `<location>` 元素后，通过注销站点来测试新的 URL 授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-355">After adding this `<location>` element, test the new URL authorization rules by logging out of the site.</span></span> <span data-ttu-id="25c2f-356">作为匿名用户，你应该可以访问 `UserBasedAuthorization.aspx` 页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-356">As an anonymous user you should be permitted to visit the `UserBasedAuthorization.aspx` page.</span></span>

<span data-ttu-id="25c2f-357">目前，任何经过身份验证或匿名的用户都可以访问 `UserBasedAuthorization.aspx` 页面并查看或删除文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-357">Currently, any authenticated or anonymous user can visit the `UserBasedAuthorization.aspx` page and view or delete files.</span></span> <span data-ttu-id="25c2f-358">让我们这样做是为了让只有经过身份验证的用户可以查看文件的内容，并且只有 Tito 可以删除文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-358">Let's make it so that only authenticated users can view contents of a file and only Tito can delete a file.</span></span> <span data-ttu-id="25c2f-359">可以通过声明方式、编程方式或通过这两种方法的组合应用此类精细授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-359">Such fine grain authorization rules can be applied declaratively, programmatically, or through a combination of both methods.</span></span> <span data-ttu-id="25c2f-360">让我们使用声明性方法来限制谁可以查看文件的内容;我们将使用编程方法来限制可以删除文件的用户。</span><span class="sxs-lookup"><span data-stu-id="25c2f-360">Let's use the declarative approach to limit who can view the contents of a file; we'll use the programmatic approach to limit who can delete a file.</span></span>

### <a name="using-the-loginview-control"></a><span data-ttu-id="25c2f-361">使用登录视图控件</span><span class="sxs-lookup"><span data-stu-id="25c2f-361">Using the LoginView Control</span></span>

<span data-ttu-id="25c2f-362">正如我们在过去的教程中看到的那样，登录视图控件适用于为经过身份验证的用户和匿名用户显示不同的界面，并提供一种简单的方法来隐藏匿名用户无法访问的功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-362">As we've seen in past tutorials, the LoginView control is useful for displaying different interfaces for authenticated and anonymous users, and offers an easy way to hide functionality that is not accessible to anonymous users.</span></span> <span data-ttu-id="25c2f-363">由于匿名用户无法查看或删除文件，因此当经过身份验证的用户访问页面时，只需显示 "`FileContents`" 文本框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-363">Since anonymous users cannot view or delete files, we only need to show the `FileContents` TextBox when the page is visited by an authenticated user.</span></span> <span data-ttu-id="25c2f-364">若要实现此目的，请将登录视图控件添加到页面上，将其命名为 `LoginViewForFileContentsTextBox`，并将 `FileContents` 文本框的声明性标记移到登录视图控件的 `LoggedInTemplate`中。</span><span class="sxs-lookup"><span data-stu-id="25c2f-364">To achieve this, add a LoginView control to the page, name it `LoginViewForFileContentsTextBox`, and move the `FileContents` TextBox's declarative markup into the LoginView control's `LoggedInTemplate`.</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample15.aspx)]

<span data-ttu-id="25c2f-365">无法再从代码隐藏类直接访问登录视图模板中的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-365">The Web controls in the LoginView's templates are no longer directly accessible from the code-behind class.</span></span> <span data-ttu-id="25c2f-366">例如，`FilesGrid` GridView 的 `SelectedIndexChanged` 和 `RowDeleting` 事件处理程序当前引用 `FileContents` TextBox 控件，其代码如下所示：</span><span class="sxs-lookup"><span data-stu-id="25c2f-366">For example, the `FilesGrid` GridView's `SelectedIndexChanged` and `RowDeleting` event handlers currently reference the `FileContents` TextBox control with code like:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample16.cs)]

<span data-ttu-id="25c2f-367">但是，此代码不再有效。</span><span class="sxs-lookup"><span data-stu-id="25c2f-367">However, this code is no longer valid.</span></span> <span data-ttu-id="25c2f-368">通过将 `FileContents` 文本框移动到 `LoggedInTemplate` 无法直接访问文本框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-368">By moving the `FileContents` TextBox into the `LoggedInTemplate` the TextBox cannot be directly accessed.</span></span> <span data-ttu-id="25c2f-369">相反，我们必须使用 `FindControl("controlId")` 方法以编程方式引用控件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-369">Instead, we must use the `FindControl("controlId")` method to programmatically reference the control.</span></span> <span data-ttu-id="25c2f-370">更新 `FilesGrid` 事件处理程序以引用文本框，如下所示：</span><span class="sxs-lookup"><span data-stu-id="25c2f-370">Update the `FilesGrid` event handlers to reference the TextBox like so:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample17.cs)]

<span data-ttu-id="25c2f-371">将文本框移到登录视图的 `LoggedInTemplate` 并更新页面的代码以使用 `FindControl("controlId")` 模式引用 TextBox 后，请以匿名用户身份访问该页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-371">After moving the TextBox to the LoginView's `LoggedInTemplate` and updating the page's code to reference the TextBox using the `FindControl("controlId")` pattern, visit the page as an anonymous user.</span></span> <span data-ttu-id="25c2f-372">如图10所示，不显示 "`FileContents`" 文本框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-372">As Figure 10 shows, the `FileContents` TextBox is not displayed.</span></span> <span data-ttu-id="25c2f-373">但仍会显示视图 LinkButton。</span><span class="sxs-lookup"><span data-stu-id="25c2f-373">However, the View LinkButton is still displayed.</span></span>

<span data-ttu-id="25c2f-374">[![登录视图控件仅为经过身份验证的用户呈现 FileContents TextBox](user-based-authorization-cs/_static/image29.png)](user-based-authorization-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-374">[![The LoginView Control Only Renders the FileContents TextBox for Authenticated Users](user-based-authorization-cs/_static/image29.png)](user-based-authorization-cs/_static/image28.png)</span></span>

<span data-ttu-id="25c2f-375">**图 10**：登录视图控件仅为经过身份验证的用户渲染 `FileContents` 文本框（[单击查看完全大小的图像](user-based-authorization-cs/_static/image30.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-375">**Figure 10**: The LoginView Control Only Renders the `FileContents` TextBox for Authenticated Users  ([Click to view full-size image](user-based-authorization-cs/_static/image30.png))</span></span>

<span data-ttu-id="25c2f-376">隐藏匿名用户的 "查看" 按钮的一种方法是将 GridView 字段转换为 TemplateField。</span><span class="sxs-lookup"><span data-stu-id="25c2f-376">One way to hide the View button for anonymous users is to convert the GridView field into a TemplateField.</span></span> <span data-ttu-id="25c2f-377">这会生成一个模板，其中包含视图 LinkButton 的声明性标记。</span><span class="sxs-lookup"><span data-stu-id="25c2f-377">This will generate a template that contains the declarative markup for the View LinkButton.</span></span> <span data-ttu-id="25c2f-378">然后，可以将登录视图控件添加到 TemplateField，并将 LinkButton 放在登录视图的 `LoggedInTemplate`中，从而隐藏了匿名访问者的 "查看" 按钮。</span><span class="sxs-lookup"><span data-stu-id="25c2f-378">We can then add a LoginView control to the TemplateField and place the LinkButton within the LoginView's `LoggedInTemplate`, thereby hiding the View button from anonymous visitors.</span></span> <span data-ttu-id="25c2f-379">若要实现此目的，请在 GridView 的智能标记中单击 "编辑列" 链接以启动 "字段" 对话框。</span><span class="sxs-lookup"><span data-stu-id="25c2f-379">To accomplish this, click on the Edit Columns link from the GridView's Smart Tag to launch the Fields dialog box.</span></span> <span data-ttu-id="25c2f-380">接下来，选择左下角列表中的 "选择" 按钮，然后单击 "将此字段转换为 TemplateField" 链接。</span><span class="sxs-lookup"><span data-stu-id="25c2f-380">Next, select the Select button from the list in the lower left corner and then click the Convert this field to a TemplateField link.</span></span> <span data-ttu-id="25c2f-381">这样做会修改该字段的声明性标记：</span><span class="sxs-lookup"><span data-stu-id="25c2f-381">Doing so will modify the field's declarative markup from:</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample18.aspx)]

 <span data-ttu-id="25c2f-382">到:</span><span class="sxs-lookup"><span data-stu-id="25c2f-382">To:</span></span> 

[!code-aspx[Main](user-based-authorization-cs/samples/sample19.aspx)]

<span data-ttu-id="25c2f-383">此时，我们可以将登录视图添加到 TemplateField 中。</span><span class="sxs-lookup"><span data-stu-id="25c2f-383">At this point, we can add a LoginView to the TemplateField.</span></span> <span data-ttu-id="25c2f-384">以下标记仅为经过身份验证的用户显示 LinkButton 视图。</span><span class="sxs-lookup"><span data-stu-id="25c2f-384">The following markup displays the View LinkButton only for authenticated users.</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample20.aspx)]

<span data-ttu-id="25c2f-385">如图11所示，最终结果并不是因为即使隐藏了列中的视图 LinkButtons，仍会显示视图列。</span><span class="sxs-lookup"><span data-stu-id="25c2f-385">As Figure 11 shows, the end result is not that pretty as the View column is still displayed even though the View LinkButtons within the column are hidden.</span></span> <span data-ttu-id="25c2f-386">在下一部分中，我们将介绍如何隐藏整个 GridView 列（而不仅仅是 LinkButton）。</span><span class="sxs-lookup"><span data-stu-id="25c2f-386">We will look at how to hide the entire GridView column (and not just the LinkButton) in the next section.</span></span>

<span data-ttu-id="25c2f-387">[![登录视图控件隐藏匿名访问者的视图 LinkButtons](user-based-authorization-cs/_static/image32.png)](user-based-authorization-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-387">[![The LoginView Control Hides the View LinkButtons for Anonymous Visitors](user-based-authorization-cs/_static/image32.png)](user-based-authorization-cs/_static/image31.png)</span></span>

<span data-ttu-id="25c2f-388">**图 11**：登录视图控件隐藏了匿名访问者的视图 LinkButtons （[单击查看完全大小的图像](user-based-authorization-cs/_static/image33.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-388">**Figure 11**: The LoginView Control Hides the View LinkButtons for Anonymous Visitors  ([Click to view full-size image](user-based-authorization-cs/_static/image33.png))</span></span>

### <a name="programmatically-limiting-functionality"></a><span data-ttu-id="25c2f-389">以编程方式限制功能</span><span class="sxs-lookup"><span data-stu-id="25c2f-389">Programmatically Limiting Functionality</span></span>

<span data-ttu-id="25c2f-390">在某些情况下，声明性技术不足以将功能限制到页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-390">In some circumstances, declarative techniques are insufficient for limiting functionality to a page.</span></span> <span data-ttu-id="25c2f-391">例如，某些页面功能的可用性可能依赖于超出用户访问页面的用户是否为匿名或通过身份验证的条件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-391">For example, the availability of certain page functionality may be dependent on criteria beyond whether the user visiting the page is anonymous or authenticated.</span></span> <span data-ttu-id="25c2f-392">在这种情况下，可以通过编程方式显示或隐藏各种用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="25c2f-392">In such cases, the various user interface elements can be displayed or hidden through programmatic means.</span></span>

<span data-ttu-id="25c2f-393">为了以编程方式限制功能，我们需要执行两项任务：</span><span class="sxs-lookup"><span data-stu-id="25c2f-393">In order to limit the functionality programmatically, we need to perform two tasks:</span></span>

1. <span data-ttu-id="25c2f-394">确定访问页的用户是否可以访问该功能，并</span><span class="sxs-lookup"><span data-stu-id="25c2f-394">Determine whether the user visiting the page can access the functionality, and</span></span>
2. <span data-ttu-id="25c2f-395">基于用户是否有权访问相关功能，以编程方式修改用户界面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-395">Programmatically modify the user interface based on whether the user has access to the functionality in question.</span></span>

<span data-ttu-id="25c2f-396">为了演示这两个任务的应用程序，让我们仅允许 Tito 删除 GridView 中的文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-396">To demonstrate the application of these two tasks, let's only allow Tito to delete files from the GridView.</span></span> <span data-ttu-id="25c2f-397">然后，我们的第一个任务是确定是否 Tito 访问页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-397">Our first task, then, is to determine whether it is Tito visiting the page.</span></span> <span data-ttu-id="25c2f-398">确定后，需要隐藏（或显示） GridView 的删除列。</span><span class="sxs-lookup"><span data-stu-id="25c2f-398">Once that has been determined, we need to hide (or show) the GridView's Delete column.</span></span> <span data-ttu-id="25c2f-399">GridView 的列可通过其 `Columns` 属性访问;仅当列 `Visible` 属性设置为 `true` （默认值）时，才会呈现该列。</span><span class="sxs-lookup"><span data-stu-id="25c2f-399">The GridView's columns are accessible through its `Columns` property; a column is only rendered if its `Visible` property is set to `true` (the default).</span></span>

<span data-ttu-id="25c2f-400">在将数据绑定到 GridView 之前，将以下代码添加到 `Page_Load` 事件处理程序：</span><span class="sxs-lookup"><span data-stu-id="25c2f-400">Add the following code to the `Page_Load` event handler prior to binding the data to the GridView:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample21.cs)]

<span data-ttu-id="25c2f-401">如我们在[*Forms 身份验证概述*](../introduction/an-overview-of-forms-authentication-cs.md)教程中所述，`User.Identity.Name` 返回标识的名称。</span><span class="sxs-lookup"><span data-stu-id="25c2f-401">As we discussed in the [*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, `User.Identity.Name` returns the identity's name.</span></span> <span data-ttu-id="25c2f-402">这对应于在登录控件中输入的用户名。</span><span class="sxs-lookup"><span data-stu-id="25c2f-402">This corresponds to the username entered in the Login control.</span></span> <span data-ttu-id="25c2f-403">如果 Tito 访问该页，则 GridView 的第二列的 `Visible` 属性设置为 `true`;否则，将其设置为 `false`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-403">If it is Tito visiting the page, the GridView's second column's `Visible` property is set to `true`; otherwise, it is set to `false`.</span></span> <span data-ttu-id="25c2f-404">最终的结果是，当 Tito 以外的其他人访问该页面时，另一个已通过身份验证的用户或匿名用户，则不会呈现删除列（见图12）;但是，当 Tito 访问该页面时，"删除" 列会出现（见图13）。</span><span class="sxs-lookup"><span data-stu-id="25c2f-404">The net result is that when someone other than Tito visits the page, either another authenticated user or an anonymous user, the Delete column is not rendered (see Figure 12); however, when Tito visits the page, the Delete column is present (see Figure 13).</span></span>

<span data-ttu-id="25c2f-405">[当 Tito 以外的其他人访问 Delete 列时，不会呈现该删除列（如 Bruce） ![](user-based-authorization-cs/_static/image35.png)](user-based-authorization-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-405">[![The Delete Column is Not Rendered When Visited By Someone Other Than Tito (Such as Bruce)](user-based-authorization-cs/_static/image35.png)](user-based-authorization-cs/_static/image34.png)</span></span>

<span data-ttu-id="25c2f-406">**图 12**：除 Tito 以外的其他人（如 Bruce）访问 Delete 列时，不会呈现该删除列（[单击以查看完全大小的图像](user-based-authorization-cs/_static/image36.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-406">**Figure 12**: The Delete Column is Not Rendered When Visited By Someone Other Than Tito (Such as Bruce)  ([Click to view full-size image](user-based-authorization-cs/_static/image36.png))</span></span>

<span data-ttu-id="25c2f-407">[![为 Tito 呈现 Delete 列](user-based-authorization-cs/_static/image38.png)](user-based-authorization-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-407">[![The Delete Column is Rendered for Tito](user-based-authorization-cs/_static/image38.png)](user-based-authorization-cs/_static/image37.png)</span></span>

<span data-ttu-id="25c2f-408">**图 13**：为 Tito 呈现删除列（[单击以查看完全大小的图像](user-based-authorization-cs/_static/image39.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-408">**Figure 13**: The Delete Column is Rendered for Tito  ([Click to view full-size image](user-based-authorization-cs/_static/image39.png))</span></span>

## <a name="step-4-applying-authorization-rules-to-classes-and-methods"></a><span data-ttu-id="25c2f-409">步骤4：将授权规则应用于类和方法</span><span class="sxs-lookup"><span data-stu-id="25c2f-409">Step 4: Applying Authorization Rules to Classes and Methods</span></span>

<span data-ttu-id="25c2f-410">在步骤3中，我们不允许匿名用户查看文件内容和禁止所有用户，但 Tito 删除文件。</span><span class="sxs-lookup"><span data-stu-id="25c2f-410">In Step 3 we disallowed anonymous users from viewing a file's contents and prohibited all users but Tito from deleting files.</span></span> <span data-ttu-id="25c2f-411">为实现此目的，通过声明性和编程技术隐藏了未经授权的访问者的关联用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="25c2f-411">This was accomplished by hiding the associated user interface elements for unauthorized visitors through declarative and programmatic techniques.</span></span> <span data-ttu-id="25c2f-412">对于我们的简单示例，正确地隐藏用户界面元素非常简单，但对于更复杂的站点，可能有许多不同的方法来执行相同的功能呢？</span><span class="sxs-lookup"><span data-stu-id="25c2f-412">For our simple example, properly hiding the user interface elements was straightforward, but what about more complex sites where there may be many different ways to perform the same functionality?</span></span> <span data-ttu-id="25c2f-413">在将此功能限制给未经授权的用户的情况下，如果我们忘记隐藏或禁用所有适用的用户界面元素，会发生什么情况呢？</span><span class="sxs-lookup"><span data-stu-id="25c2f-413">In limiting that functionality to unauthorized users, what happens if we forget to hide or disable all of the applicable user interface elements?</span></span>

<span data-ttu-id="25c2f-414">确保未经授权的用户无法访问特定功能的一种简单方法是使用[`PrincipalPermission` 特性](https://msdn.microsoft.com/library/system.security.permissions.principalpermissionattribute.aspx)来修饰该类或方法。</span><span class="sxs-lookup"><span data-stu-id="25c2f-414">An easy way to ensure that a particular piece of functionality cannot be accessed by an unauthorized user is to decorate that class or method with the [`PrincipalPermission` attribute](https://msdn.microsoft.com/library/system.security.permissions.principalpermissionattribute.aspx).</span></span> <span data-ttu-id="25c2f-415">当 .NET 运行时使用一个类或执行它的一个方法时，它会进行检查以确保当前安全上下文有权使用类或执行方法。</span><span class="sxs-lookup"><span data-stu-id="25c2f-415">When the .NET runtime uses a class or executes one of its methods, it checks to ensure that the current security context has permission to use the class or execute the method.</span></span> <span data-ttu-id="25c2f-416">`PrincipalPermission` 属性提供了一种机制，通过该机制可以定义这些规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-416">The `PrincipalPermission` attribute provides a mechanism through which we can define these rules.</span></span>

<span data-ttu-id="25c2f-417">接下来，我们将演示如何使用 GridView `SelectedIndexChanged` 上的 `PrincipalPermission` 属性，并 `RowDeleting` 事件处理程序禁止匿名用户和 Tito 以外的用户执行。</span><span class="sxs-lookup"><span data-stu-id="25c2f-417">Let's demonstrate using the `PrincipalPermission` attribute on the GridView's `SelectedIndexChanged` and `RowDeleting` event handlers to prohibit execution by anonymous users and users other than Tito, respectively.</span></span> <span data-ttu-id="25c2f-418">我们需要做的就是在每个函数定义的顶部添加适当的属性：</span><span class="sxs-lookup"><span data-stu-id="25c2f-418">All we need to do is add the appropriate attribute atop each function definition:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample22.cs)]

<span data-ttu-id="25c2f-419">`SelectedIndexChanged` 事件处理程序的属性规定，只有经过身份验证的用户才能执行事件处理程序，因为 `RowDeleting` 事件处理程序的属性将执行限制为 Tito。</span><span class="sxs-lookup"><span data-stu-id="25c2f-419">The attribute for the `SelectedIndexChanged` event handler dictates that only authenticated users can execute the event handler, where as the attribute on the `RowDeleting` event handler limits the execution to Tito.</span></span>

<span data-ttu-id="25c2f-420">如果用户不是 Tito 的用户尝试执行 `RowDeleting` 事件处理程序或未经身份验证的用户尝试执行 `SelectedIndexChanged` 事件处理程序，.NET 运行时将引发 `SecurityException`。</span><span class="sxs-lookup"><span data-stu-id="25c2f-420">If, somehow, a user other than Tito attempts to execute the `RowDeleting` event handler or a non-authenticated user attempts to execute the `SelectedIndexChanged` event handler, the .NET runtime will raise a `SecurityException`.</span></span>

<span data-ttu-id="25c2f-421">[![如果安全上下文无权执行此方法，则会引发 SecurityException](user-based-authorization-cs/_static/image41.png)](user-based-authorization-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="25c2f-421">[![If the Security Context is not Authorized to Execute the Method, a SecurityException is Thrown](user-based-authorization-cs/_static/image41.png)](user-based-authorization-cs/_static/image40.png)</span></span>

<span data-ttu-id="25c2f-422">**图 14**：如果安全上下文无权执行此方法，则会引发 `SecurityException` （[单击查看完全大小的映像](user-based-authorization-cs/_static/image42.png)）</span><span class="sxs-lookup"><span data-stu-id="25c2f-422">**Figure 14**: If the Security Context is not Authorized to Execute the Method, a `SecurityException` is Thrown  ([Click to view full-size image](user-based-authorization-cs/_static/image42.png))</span></span>

> [!NOTE]
> <span data-ttu-id="25c2f-423">若要允许多个安全上下文访问类或方法，请使用每个安全上下文的 `PrincipalPermission` 特性来修饰类或方法。</span><span class="sxs-lookup"><span data-stu-id="25c2f-423">To allow multiple security contexts to access a class or method, decorate the class or method with a `PrincipalPermission` attribute for each security context.</span></span> <span data-ttu-id="25c2f-424">也就是说，若要允许 Tito 和 Bruce 执行 `RowDeleting` 事件处理程序，请添加*两个*`PrincipalPermission` 属性：</span><span class="sxs-lookup"><span data-stu-id="25c2f-424">That is, to allow both Tito and Bruce to execute the `RowDeleting` event handler, add *two* `PrincipalPermission` attributes:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample23.cs)]

<span data-ttu-id="25c2f-425">除了 ASP.NET 页面以外，许多应用程序还具有一种体系结构，其中包括各种层，如业务逻辑和数据访问层。</span><span class="sxs-lookup"><span data-stu-id="25c2f-425">In addition to ASP.NET pages, many applications also have an architecture that includes various layers, such as Business Logic and Data Access Layers.</span></span> <span data-ttu-id="25c2f-426">这些层通常实现为类库，并提供用于执行业务逻辑和数据相关功能的类和方法。</span><span class="sxs-lookup"><span data-stu-id="25c2f-426">These layers are typically implemented as Class Libraries and offer classes and methods for performing business logic- and data-related functionality.</span></span> <span data-ttu-id="25c2f-427">`PrincipalPermission` 特性适用于将授权规则应用于这些层。</span><span class="sxs-lookup"><span data-stu-id="25c2f-427">The `PrincipalPermission` attribute is useful for applying authorization rules to these layers.</span></span>

<span data-ttu-id="25c2f-428">有关使用 `PrincipalPermission` 特性定义有关类和方法的授权规则的详细信息，请参阅[Scott Guthrie](https://weblogs.asp.net/scottgu/)的博客文章[使用 `PrincipalPermissionAttributes`将授权规则添加到业务层和数据层](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)。</span><span class="sxs-lookup"><span data-stu-id="25c2f-428">For more information on using the `PrincipalPermission` attribute to define authorization rules on classes and methods, refer to [Scott Guthrie](https://weblogs.asp.net/scottgu/)'s blog entry [Adding Authorization Rules to Business and Data Layers Using `PrincipalPermissionAttributes`](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx).</span></span>

## <a name="summary"></a><span data-ttu-id="25c2f-429">摘要</span><span class="sxs-lookup"><span data-stu-id="25c2f-429">Summary</span></span>

<span data-ttu-id="25c2f-430">在本教程中，我们介绍了如何应用基于用户的授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-430">In this tutorial we looked at how to apply user-based authorization rules.</span></span> <span data-ttu-id="25c2f-431">我们首先来看一下 ASP。NET 的 URL 授权框架。</span><span class="sxs-lookup"><span data-stu-id="25c2f-431">We started with a look at ASP.NET's URL authorization framework.</span></span> <span data-ttu-id="25c2f-432">对于每个请求，ASP.NET 引擎的 `UrlAuthorizationModule` 会检查在应用程序配置中定义的 URL 授权规则，以确定标识是否有权访问所请求的资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-432">On each request, the ASP.NET engine's `UrlAuthorizationModule` inspects the URL authorization rules defined in the application's configuration to determine whether the identity is authorized to access the requested resource.</span></span> <span data-ttu-id="25c2f-433">简而言之，使用 URL 授权，可以轻松地为特定页面或特定目录中的所有页面指定授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-433">In short, URL authorization makes it easy to specify authorization rules for a specific page or for all pages in a particular directory.</span></span>

<span data-ttu-id="25c2f-434">URL 授权框架逐页应用授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-434">The URL authorization framework applies authorization rules on a page-by-page basis.</span></span> <span data-ttu-id="25c2f-435">使用 URL 授权，请求标识有权访问特定资源。</span><span class="sxs-lookup"><span data-stu-id="25c2f-435">With URL authorization, either the requesting identity is authorized to access a particular resource or not.</span></span> <span data-ttu-id="25c2f-436">但在许多情况下，调用更精细的授权规则。</span><span class="sxs-lookup"><span data-stu-id="25c2f-436">Many scenarios, however, call for more fine grain authorization rules.</span></span> <span data-ttu-id="25c2f-437">我们可能需要让每个人都能访问某个页面，但要显示不同的数据或提供不同的功能，具体取决于访问页面的用户，而不是定义谁可以访问某个页面。</span><span class="sxs-lookup"><span data-stu-id="25c2f-437">Rather than defining who is permitted to access a page, we may need to let everyone access a page, but to show different data or offer different functionality depending on the user visiting the page.</span></span> <span data-ttu-id="25c2f-438">页面级授权通常涉及隐藏特定的用户界面元素，以防止未经授权的用户访问禁止的功能。</span><span class="sxs-lookup"><span data-stu-id="25c2f-438">Page-level authorization usually involves hiding specific user interface elements in order to prevent unauthorized users from accessing prohibited functionality.</span></span> <span data-ttu-id="25c2f-439">此外，还可以使用属性来限制对某些用户的类和其方法的访问。</span><span class="sxs-lookup"><span data-stu-id="25c2f-439">Additionally, it is possible to use attributes to restrict access to classes and execution of its methods for certain users.</span></span>

<span data-ttu-id="25c2f-440">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="25c2f-440">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="25c2f-441">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="25c2f-441">Further Reading</span></span>

<span data-ttu-id="25c2f-442">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="25c2f-442">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="25c2f-443">使用 `PrincipalPermissionAttributes` 将授权规则添加到业务层和数据层</span><span class="sxs-lookup"><span data-stu-id="25c2f-443">Adding Authorization Rules to Business and Data Layers Using `PrincipalPermissionAttributes`</span></span>](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)
- [<span data-ttu-id="25c2f-444">ASP.NET 授权</span><span class="sxs-lookup"><span data-stu-id="25c2f-444">ASP.NET Authorization</span></span>](https://msdn.microsoft.com/library/wce3kxhd.aspx)
- [<span data-ttu-id="25c2f-445">IIS6 和 IIS7 安全性之间的更改</span><span class="sxs-lookup"><span data-stu-id="25c2f-445">Changes Between IIS6 and IIS7 Security</span></span>](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/Changes-between-IIS6-and-IIS7-Security)
- [<span data-ttu-id="25c2f-446">配置特定文件和子目录</span><span class="sxs-lookup"><span data-stu-id="25c2f-446">Configuring Specific Files and Subdirectories</span></span>](https://msdn.microsoft.com/library/6hbkh9s7.aspx)
- [<span data-ttu-id="25c2f-447">限制基于用户的数据修改功能</span><span class="sxs-lookup"><span data-stu-id="25c2f-447">Limiting Data Modification Functionality Based on the User</span></span>](../../data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs.md)
- [<span data-ttu-id="25c2f-448">登录视图控件快速入门</span><span class="sxs-lookup"><span data-stu-id="25c2f-448">LoginView Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/loginview.aspx)
- [<span data-ttu-id="25c2f-449">了解 IIS7 URL 授权</span><span class="sxs-lookup"><span data-stu-id="25c2f-449">Understanding IIS7 URL Authorization</span></span>](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization)
- [<span data-ttu-id="25c2f-450">`UrlAuthorizationModule` 技术文档</span><span class="sxs-lookup"><span data-stu-id="25c2f-450">`UrlAuthorizationModule` Technical Documentation</span></span>](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)
- [<span data-ttu-id="25c2f-451">在 ASP.NET 2.0 中处理数据</span><span class="sxs-lookup"><span data-stu-id="25c2f-451">Working with Data in ASP.NET 2.0</span></span>](../../data-access/index.md)

### <a name="about-the-author"></a><span data-ttu-id="25c2f-452">关于作者</span><span class="sxs-lookup"><span data-stu-id="25c2f-452">About the Author</span></span>

<span data-ttu-id="25c2f-453">Scott Mitchell，创始人的多个 ASP/ASP 和4GuysFromRolla.com 的作者已使用 Microsoft Web 技术，1998。</span><span class="sxs-lookup"><span data-stu-id="25c2f-453">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="25c2f-454">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="25c2f-454">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="25c2f-455">他的最新书籍是， *[在24小时内，sam ASP.NET 2.0](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* 。</span><span class="sxs-lookup"><span data-stu-id="25c2f-455">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="25c2f-456">可以通过[http://ScottOnWriting.NET](http://scottonwriting.net/) [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com)或通过他的博客访问 Scott。</span><span class="sxs-lookup"><span data-stu-id="25c2f-456">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="25c2f-457">特别感谢</span><span class="sxs-lookup"><span data-stu-id="25c2f-457">Special Thanks To</span></span>

<span data-ttu-id="25c2f-458">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="25c2f-458">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="25c2f-459">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="25c2f-459">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="25c2f-460">如果是这样，请在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)放置一行。</span><span class="sxs-lookup"><span data-stu-id="25c2f-460">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="25c2f-461">[上一页](validating-user-credentials-against-the-membership-user-store-cs.md)
> [下一页](storing-additional-user-information-cs.md)</span><span class="sxs-lookup"><span data-stu-id="25c2f-461">[Previous](validating-user-credentials-against-the-membership-user-store-cs.md)
[Next](storing-additional-user-information-cs.md)</span></span>
