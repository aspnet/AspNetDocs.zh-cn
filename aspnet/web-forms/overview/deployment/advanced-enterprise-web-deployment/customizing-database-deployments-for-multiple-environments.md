---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/customizing-database-deployments-for-multiple-environments
title: 为多个环境自定义数据库部署 |Microsoft Docs
author: jrjlee
description: 本主题介绍如何在部署过程中将数据库的属性定制为特定的目标环境。 注意：本主题假设 。
ms.author: riande
ms.date: 05/04/2012
ms.assetid: a172979a-1318-4318-a9c6-4f9560d26267
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/customizing-database-deployments-for-multiple-environments
msc.type: authoredcontent
ms.openlocfilehash: 8ae8cb1a322afb95c5d2e8d5e73c7825c7b2fe5a
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78489032"
---
# <a name="customizing-database-deployments-for-multiple-environments"></a><span data-ttu-id="10053-104">自定义多个环境的数据库部署</span><span class="sxs-lookup"><span data-stu-id="10053-104">Customizing Database Deployments for Multiple Environments</span></span>

<span data-ttu-id="10053-105">作者： [Jason](https://github.com/jrjlee)</span><span class="sxs-lookup"><span data-stu-id="10053-105">by [Jason Lee](https://github.com/jrjlee)</span></span>

[<span data-ttu-id="10053-106">下载 PDF</span><span class="sxs-lookup"><span data-stu-id="10053-106">Download PDF</span></span>](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> <span data-ttu-id="10053-107">本主题介绍如何在部署过程中将数据库的属性定制为特定的目标环境。</span><span class="sxs-lookup"><span data-stu-id="10053-107">This topic describes how to tailor the properties of a database to specific target environments as part of the deployment process.</span></span>
> 
> > [!NOTE]
> > <span data-ttu-id="10053-108">本主题假设你要使用 Msbuild.exe 和 VSDBCMD 部署 Visual Studio 2010 数据库项目。</span><span class="sxs-lookup"><span data-stu-id="10053-108">The topic assumes that you're deploying a Visual Studio 2010 database project using MSBuild.exe and VSDBCMD.exe.</span></span> <span data-ttu-id="10053-109">有关选择此方法的原因的详细信息，请参阅[企业中的 Web 部署](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md)和[部署数据库项目](../web-deployment-in-the-enterprise/deploying-database-projects.md)。</span><span class="sxs-lookup"><span data-stu-id="10053-109">For more information on why you might choose this approach, see [Web Deployment in the Enterprise](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md) and [Deploying Database Projects](../web-deployment-in-the-enterprise/deploying-database-projects.md).</span></span>
> 
> 
> <span data-ttu-id="10053-110">将数据库项目部署到多个目标时，通常需要为每个目标环境自定义数据库部署属性。</span><span class="sxs-lookup"><span data-stu-id="10053-110">When you deploy a database project to multiple destinations, you'll often want to customize the database deployment properties for each target environment.</span></span> <span data-ttu-id="10053-111">例如，在测试环境中，您通常会在每次部署时重新创建数据库，而在过渡环境或生产环境中，您更有可能进行增量更新以保留数据。</span><span class="sxs-lookup"><span data-stu-id="10053-111">For example, in test environments you'd typically recreate the database on every deployment, whereas in staging or production environments you'd be a lot more likely to make incremental updates to preserve your data.</span></span>
> 
> <span data-ttu-id="10053-112">在 Visual Studio 2010 数据库项目中，部署设置包含在部署配置（sqldeployment）文件中。</span><span class="sxs-lookup"><span data-stu-id="10053-112">In a Visual Studio 2010 database project, deployment settings are contained within a deployment configuration (.sqldeployment) file.</span></span> <span data-ttu-id="10053-113">本主题将演示如何创建特定于环境的部署配置文件，并指定要用作 VSDBCMD 参数的配置文件。</span><span class="sxs-lookup"><span data-stu-id="10053-113">This topic will show you how to create environment-specific deployment configuration files and specify the one you want to use as a VSDBCMD parameter.</span></span>

<span data-ttu-id="10053-114">本主题介绍一系列教程的一部分，这些教程基于名为 Fabrikam，Inc. 的虚构公司的企业部署要求。本教程系列使用一个示例解决方案&#x2014;，该解决方案使用[联系人管理器解决方案](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;来表示具有真实复杂性级别的 web 应用程序，包括 ASP.NET MVC 3 应用程序、Windows Communication Foundation （WCF）服务和数据库项目。</span><span class="sxs-lookup"><span data-stu-id="10053-114">This topic forms part of a series of tutorials based around the enterprise deployment requirements of a fictional company named Fabrikam, Inc. This tutorial series uses a sample solution&#x2014;the [Contact Manager solution](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;to represent a web application with a realistic level of complexity, including an ASP.NET MVC 3 application, a Windows Communication Foundation (WCF) service, and a database project.</span></span>

<span data-ttu-id="10053-115">这些教程核心的部署方法基于[理解项目文件](../web-deployment-in-the-enterprise/understanding-the-project-file.md)中所述的拆分项目文件方法，其中，生成过程由两个项目文件&#x2014;控制，其中一个包含适用于每个目标环境的生成说明，另一个包含特定于环境的生成和部署设置。</span><span class="sxs-lookup"><span data-stu-id="10053-115">The deployment method at the heart of these tutorials is based on the split project file approach described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md), in which the build process is controlled by two project files&#x2014;one containing build instructions that apply to every destination environment, and one containing environment-specific build and deployment settings.</span></span> <span data-ttu-id="10053-116">在生成时，特定于环境的项目文件将合并到环境无关的项目文件中，以形成一组完整的生成说明。</span><span class="sxs-lookup"><span data-stu-id="10053-116">At build time, the environment-specific project file is merged into the environment-agnostic project file to form a complete set of build instructions.</span></span>

## <a name="task-overview"></a><span data-ttu-id="10053-117">任务概述</span><span class="sxs-lookup"><span data-stu-id="10053-117">Task Overview</span></span>

<span data-ttu-id="10053-118">本主题假定：</span><span class="sxs-lookup"><span data-stu-id="10053-118">This topic assumes that:</span></span>

- <span data-ttu-id="10053-119">按照[了解项目文件](../web-deployment-in-the-enterprise/understanding-the-project-file.md)中所述，使用拆分项目文件方法进行解决方案部署。</span><span class="sxs-lookup"><span data-stu-id="10053-119">You use the split project file approach to solution deployment, as described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md).</span></span>
- <span data-ttu-id="10053-120">从项目文件调用 VSDBCMD 来部署数据库项目，如[了解生成过程](../web-deployment-in-the-enterprise/understanding-the-build-process.md)中所述。</span><span class="sxs-lookup"><span data-stu-id="10053-120">You call VSDBCMD from the project file to deploy your database project, as described in [Understanding the Build Process](../web-deployment-in-the-enterprise/understanding-the-build-process.md).</span></span>

<span data-ttu-id="10053-121">若要创建支持在目标环境之间改变数据库部署属性的部署系统，需要：</span><span class="sxs-lookup"><span data-stu-id="10053-121">To create a deployment system that supports varying the database deployment properties between target environments, you'll need to:</span></span>

- <span data-ttu-id="10053-122">为每个目标环境创建部署配置（. sqldeployment）文件。</span><span class="sxs-lookup"><span data-stu-id="10053-122">Create a deployment configuration (.sqldeployment) file for each target environment.</span></span>
- <span data-ttu-id="10053-123">创建一个 VSDBCMD 命令，该命令将部署配置文件指定为命令行开关。</span><span class="sxs-lookup"><span data-stu-id="10053-123">Create a VSDBCMD command that specifies the deployment configuration file as a command-line switch.</span></span>
- <span data-ttu-id="10053-124">参数化 Microsoft 生成引擎（MSBuild）项目文件中的 VSDBCMD 命令，以便 VSDBCMD 选项适用于目标环境。</span><span class="sxs-lookup"><span data-stu-id="10053-124">Parameterize the VSDBCMD command in a Microsoft Build Engine (MSBuild) project file, so that the VSDBCMD options are appropriate to the target environment.</span></span>

<span data-ttu-id="10053-125">本主题将演示如何执行上述每个过程。</span><span class="sxs-lookup"><span data-stu-id="10053-125">This topic will show you how to perform each of these procedures.</span></span>

## <a name="creating-environment-specific-deployment-configuration-files"></a><span data-ttu-id="10053-126">创建环境特定的部署配置文件</span><span class="sxs-lookup"><span data-stu-id="10053-126">Creating Environment-Specific Deployment Configuration Files</span></span>

<span data-ttu-id="10053-127">默认情况下，数据库项目包含一个名为*sqldeployment*的部署配置文件。</span><span class="sxs-lookup"><span data-stu-id="10053-127">By default, a database project contains a single deployment configuration file named *Database.sqldeployment*.</span></span> <span data-ttu-id="10053-128">如果在 Visual Studio 2010 中打开此文件，可以看到可供你使用的不同部署选项：</span><span class="sxs-lookup"><span data-stu-id="10053-128">If you open this file in Visual Studio 2010, you can see the different deployment options that are available to you:</span></span>

- <span data-ttu-id="10053-129">**部署比较排序规则**。</span><span class="sxs-lookup"><span data-stu-id="10053-129">**Deployment comparison collation**.</span></span> <span data-ttu-id="10053-130">这使您可以选择是使用您的项目的数据库排序规则（*源*排序规则）还是目标服务器的数据库排序规则（*目标*排序规则）。</span><span class="sxs-lookup"><span data-stu-id="10053-130">This lets you choose whether to use the database collation of your project (the *source* collation) or the database collation of your destination server (the *target* collation).</span></span> <span data-ttu-id="10053-131">在大多数情况下，你需要在部署到开发或测试环境时使用源排序规则。</span><span class="sxs-lookup"><span data-stu-id="10053-131">In most cases, you'll want to use the source collation when you deploy to a development or test environment.</span></span> <span data-ttu-id="10053-132">部署到过渡环境或生产环境时，通常需要保持目标排序规则不变，以避免任何互操作性问题。</span><span class="sxs-lookup"><span data-stu-id="10053-132">When you deploy to a staging or production environment, you'll usually want to leave the target collation unchanged to avoid any interoperability issues.</span></span>
- <span data-ttu-id="10053-133">**部署数据库属性**。</span><span class="sxs-lookup"><span data-stu-id="10053-133">**Deploy database properties**.</span></span> <span data-ttu-id="10053-134">这允许您选择是否应用数据库属性（如*sqlsettings*文件中所定义）。</span><span class="sxs-lookup"><span data-stu-id="10053-134">This lets you choose whether to apply the database properties, as defined in the *Database.sqlsettings* file.</span></span> <span data-ttu-id="10053-135">首次部署数据库时，应该部署数据库属性。</span><span class="sxs-lookup"><span data-stu-id="10053-135">When you deploy a database for the first time, you should deploy the database properties.</span></span> <span data-ttu-id="10053-136">如果要更新现有数据库，则属性应该已准备就绪，并且你不需要再次部署它们。</span><span class="sxs-lookup"><span data-stu-id="10053-136">If you're updating an existing database, the properties should already be in place, and you shouldn't need to deploy them again.</span></span>
- <span data-ttu-id="10053-137">**始终重新创建数据库**。</span><span class="sxs-lookup"><span data-stu-id="10053-137">**Always re-create database**.</span></span> <span data-ttu-id="10053-138">这使你可以选择在每次部署时是否重新创建目标数据库，或进行增量更改，使目标数据库与你的架构保持同步。</span><span class="sxs-lookup"><span data-stu-id="10053-138">This lets you choose whether to re-create the target database every time you deploy or make incremental changes to bring the target database up to date with your schema.</span></span> <span data-ttu-id="10053-139">如果重新创建数据库，则会丢失现有数据库中的所有数据。</span><span class="sxs-lookup"><span data-stu-id="10053-139">If you re-create the database, you'll lose any data in the existing database.</span></span> <span data-ttu-id="10053-140">因此，通常应将此值设置为**false** ，以便部署到过渡环境或生产环境。</span><span class="sxs-lookup"><span data-stu-id="10053-140">As such, you should usually set this to **false** for deployments to staging or production environments.</span></span>
- <span data-ttu-id="10053-141">**如果可能发生数据丢失，则阻止增量部署**。</span><span class="sxs-lookup"><span data-stu-id="10053-141">**Block incremental deployment if data loss might occur**.</span></span> <span data-ttu-id="10053-142">这使你可以选择在对数据库架构进行更改将导致数据丢失的情况下是否应停止部署。</span><span class="sxs-lookup"><span data-stu-id="10053-142">This lets you choose whether deployment should stop if a change to the database schema will cause the loss of data.</span></span> <span data-ttu-id="10053-143">通常将此值设置为**true** ，以便部署到生产环境，从而使你能够干预和保护任何重要数据。</span><span class="sxs-lookup"><span data-stu-id="10053-143">You typically set this to **true** for a deployment to a production environment, to give you the opportunity to intervene and protect any important data.</span></span> <span data-ttu-id="10053-144">如果将 "**始终重新创建数据库**" 设置为 " **false**"，则此设置将不起作用。</span><span class="sxs-lookup"><span data-stu-id="10053-144">If you have set **Always re-create database** to **false**, this setting will have no effect.</span></span>
- <span data-ttu-id="10053-145">**在单用户模式下执行部署**。</span><span class="sxs-lookup"><span data-stu-id="10053-145">**Execute deployment in single-user mode**.</span></span> <span data-ttu-id="10053-146">在开发或测试环境中，这通常不是问题。</span><span class="sxs-lookup"><span data-stu-id="10053-146">This is not usually an issue in development or test environments.</span></span> <span data-ttu-id="10053-147">但是，通常应将此值设置为**true** ，以便部署到过渡环境或生产环境。</span><span class="sxs-lookup"><span data-stu-id="10053-147">However, you should typically set this to **true** for deployments to staging or production environments.</span></span> <span data-ttu-id="10053-148">这会阻止用户在部署过程中对数据库进行更改。</span><span class="sxs-lookup"><span data-stu-id="10053-148">This prevents users from making changes to the database while the deployment is underway.</span></span>
- <span data-ttu-id="10053-149">**在部署之前备份数据库**。</span><span class="sxs-lookup"><span data-stu-id="10053-149">**Back up database before deployment**.</span></span> <span data-ttu-id="10053-150">在部署到生产环境时，通常将此值设置为**true** ，以防止数据丢失。</span><span class="sxs-lookup"><span data-stu-id="10053-150">You typically set this to **true** when you deploy to a production environment, as a precaution against data loss.</span></span> <span data-ttu-id="10053-151">如果你的临时数据库包含大量数据，则在部署到过渡环境时，你可能还希望将其设置为**true** 。</span><span class="sxs-lookup"><span data-stu-id="10053-151">You may also want to set it to **true** when you deploy to a staging environment, if your staging database contains a lot of data.</span></span>
- <span data-ttu-id="10053-152">**为目标数据库中但不在数据库项目中的对象生成 DROP 语句**。</span><span class="sxs-lookup"><span data-stu-id="10053-152">**Generate DROP statements for objects that are in the target database but that are not in the database project**.</span></span> <span data-ttu-id="10053-153">在大多数情况下，这是对数据库进行增量更改的必不可少的组成部分。</span><span class="sxs-lookup"><span data-stu-id="10053-153">In most cases, this is an integral and essential part of making incremental changes to a database.</span></span> <span data-ttu-id="10053-154">如果将 "**始终重新创建数据库**" 设置为 " **false**"，则此设置将不起作用。</span><span class="sxs-lookup"><span data-stu-id="10053-154">If you have set **Always re-create database** to **false**, this setting will have no effect.</span></span>
- <span data-ttu-id="10053-155">**不要使用 ALTER ASSEMBLY 语句更新 CLR 类型**。</span><span class="sxs-lookup"><span data-stu-id="10053-155">**Do not use ALTER ASSEMBLY statements to update CLR types**.</span></span> <span data-ttu-id="10053-156">此设置确定 SQL Server 应如何将公共语言运行时（CLR）类型更新为较新的程序集版本。</span><span class="sxs-lookup"><span data-stu-id="10053-156">This setting determines how SQL Server should update common language runtime (CLR) types to newer assembly versions.</span></span> <span data-ttu-id="10053-157">在大多数情况下，此值应设置为**false** 。</span><span class="sxs-lookup"><span data-stu-id="10053-157">This should be set to **false** in most scenarios.</span></span>

<span data-ttu-id="10053-158">此表显示了不同目标环境的典型部署设置。</span><span class="sxs-lookup"><span data-stu-id="10053-158">This table shows typical deployment settings for different destination environments.</span></span> <span data-ttu-id="10053-159">但是，根据具体的要求，设置可能会有所不同。</span><span class="sxs-lookup"><span data-stu-id="10053-159">However, your settings may be different depending on your exact requirements.</span></span>

|  | <span data-ttu-id="10053-160">开发人员/测试</span><span class="sxs-lookup"><span data-stu-id="10053-160">Developer/Test</span></span> | <span data-ttu-id="10053-161">过渡/集成</span><span class="sxs-lookup"><span data-stu-id="10053-161">Staging/Integration</span></span> | <span data-ttu-id="10053-162">生产</span><span class="sxs-lookup"><span data-stu-id="10053-162">Production</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="10053-163">**部署比较排序规则**</span><span class="sxs-lookup"><span data-stu-id="10053-163">**Deployment comparison collation**</span></span> | <span data-ttu-id="10053-164">source</span><span class="sxs-lookup"><span data-stu-id="10053-164">Source</span></span> | <span data-ttu-id="10053-165">Target</span><span class="sxs-lookup"><span data-stu-id="10053-165">Target</span></span> | <span data-ttu-id="10053-166">Target</span><span class="sxs-lookup"><span data-stu-id="10053-166">Target</span></span> |
| <span data-ttu-id="10053-167">**部署数据库属性**</span><span class="sxs-lookup"><span data-stu-id="10053-167">**Deploy database properties**</span></span> | <span data-ttu-id="10053-168">True</span><span class="sxs-lookup"><span data-stu-id="10053-168">True</span></span> | <span data-ttu-id="10053-169">仅首次</span><span class="sxs-lookup"><span data-stu-id="10053-169">First time only</span></span> | <span data-ttu-id="10053-170">仅首次</span><span class="sxs-lookup"><span data-stu-id="10053-170">First time only</span></span> |
| <span data-ttu-id="10053-171">**始终重新创建数据库**</span><span class="sxs-lookup"><span data-stu-id="10053-171">**Always re-create database**</span></span> | <span data-ttu-id="10053-172">True</span><span class="sxs-lookup"><span data-stu-id="10053-172">True</span></span> | <span data-ttu-id="10053-173">False</span><span class="sxs-lookup"><span data-stu-id="10053-173">False</span></span> | <span data-ttu-id="10053-174">False</span><span class="sxs-lookup"><span data-stu-id="10053-174">False</span></span> |
| <span data-ttu-id="10053-175">**如果可能发生数据丢失，则阻止增量部署**</span><span class="sxs-lookup"><span data-stu-id="10053-175">**Block incremental deployment if data loss might occur**</span></span> | <span data-ttu-id="10053-176">False</span><span class="sxs-lookup"><span data-stu-id="10053-176">False</span></span> | <span data-ttu-id="10053-177">可能</span><span class="sxs-lookup"><span data-stu-id="10053-177">Maybe</span></span> | <span data-ttu-id="10053-178">True</span><span class="sxs-lookup"><span data-stu-id="10053-178">True</span></span> |
| <span data-ttu-id="10053-179">**在单用户模式下执行部署脚本**</span><span class="sxs-lookup"><span data-stu-id="10053-179">**Execute deployment script in single-user mode**</span></span> | <span data-ttu-id="10053-180">False</span><span class="sxs-lookup"><span data-stu-id="10053-180">False</span></span> | <span data-ttu-id="10053-181">True</span><span class="sxs-lookup"><span data-stu-id="10053-181">True</span></span> | <span data-ttu-id="10053-182">True</span><span class="sxs-lookup"><span data-stu-id="10053-182">True</span></span> |
| <span data-ttu-id="10053-183">**部署前备份数据库**</span><span class="sxs-lookup"><span data-stu-id="10053-183">**Back up database before deployment**</span></span> | <span data-ttu-id="10053-184">False</span><span class="sxs-lookup"><span data-stu-id="10053-184">False</span></span> | <span data-ttu-id="10053-185">可能</span><span class="sxs-lookup"><span data-stu-id="10053-185">Maybe</span></span> | <span data-ttu-id="10053-186">True</span><span class="sxs-lookup"><span data-stu-id="10053-186">True</span></span> |
| <span data-ttu-id="10053-187">**为目标数据库中但不在数据库项目中的对象生成 DROP 语句**</span><span class="sxs-lookup"><span data-stu-id="10053-187">**Generate DROP statements for objects that are in the target database but that are not in the database project**</span></span> | <span data-ttu-id="10053-188">False</span><span class="sxs-lookup"><span data-stu-id="10053-188">False</span></span> | <span data-ttu-id="10053-189">True</span><span class="sxs-lookup"><span data-stu-id="10053-189">True</span></span> | <span data-ttu-id="10053-190">True</span><span class="sxs-lookup"><span data-stu-id="10053-190">True</span></span> |
| <span data-ttu-id="10053-191">**不要使用 ALTER ASSEMBLY 语句更新 CLR 类型**</span><span class="sxs-lookup"><span data-stu-id="10053-191">**Do not use ALTER ASSEMBLY statements to update CLR types**</span></span> | <span data-ttu-id="10053-192">False</span><span class="sxs-lookup"><span data-stu-id="10053-192">False</span></span> | <span data-ttu-id="10053-193">False</span><span class="sxs-lookup"><span data-stu-id="10053-193">False</span></span> | <span data-ttu-id="10053-194">False</span><span class="sxs-lookup"><span data-stu-id="10053-194">False</span></span> |

> [!NOTE]
> <span data-ttu-id="10053-195">有关数据库部署属性和环境注意事项的详细信息，请参阅[数据库项目设置的概述](https://msdn.microsoft.com/library/aa833291(v=VS.100).aspx)、[如何：配置部署详细信息的属性](https://msdn.microsoft.com/library/dd172125.aspx)、[生成数据库并将其部署到隔离的开发环境](https://msdn.microsoft.com/library/dd193409.aspx)，以及[生成数据库并将其部署到过渡环境或生产环境](https://msdn.microsoft.com/library/dd193413.aspx)。</span><span class="sxs-lookup"><span data-stu-id="10053-195">For more information on database deployment properties and environment considerations, see [An Overview of Database Project Settings](https://msdn.microsoft.com/library/aa833291(v=VS.100).aspx), [How to: Configure Properties for Deployment Details](https://msdn.microsoft.com/library/dd172125.aspx), [Build and Deploy Database to an Isolated Development Environment](https://msdn.microsoft.com/library/dd193409.aspx), and [Build and Deploy Databases to a Staging or Production Environment](https://msdn.microsoft.com/library/dd193413.aspx).</span></span>

<span data-ttu-id="10053-196">若要支持将数据库项目部署到多个目标，应为每个目标环境创建一个部署配置文件。</span><span class="sxs-lookup"><span data-stu-id="10053-196">To support the deployment of a database project to multiple destinations, you should create a deployment configuration file for each target environment.</span></span>

<span data-ttu-id="10053-197">**创建环境特定的配置文件**</span><span class="sxs-lookup"><span data-stu-id="10053-197">**To create an environment-specific configuration file**</span></span>

1. <span data-ttu-id="10053-198">在 Visual Studio 2010 的 "**解决方案资源管理器**" 窗口中，右键单击数据库项目，然后单击 "**属性**"。</span><span class="sxs-lookup"><span data-stu-id="10053-198">In Visual Studio 2010, in the **Solution Explorer** window, right-click your database project, and then click **Properties**.</span></span>
2. <span data-ttu-id="10053-199">在 "数据库项目" 属性页上，在 **"部署" 选项卡**上的 "**部署配置文件**" 行中，单击 "**新建**"。</span><span class="sxs-lookup"><span data-stu-id="10053-199">On the database project properties page, on the **Deploy** tab, in the **Deployment configuration file** row, click **New**.</span></span>

    ![](customizing-database-deployments-for-multiple-environments/_static/image1.png)
3. <span data-ttu-id="10053-200">在 "**新建部署配置文件**" 对话框中，为文件指定一个有意义的名称（例如， **TestEnvironment. sqldeployment**），然后单击 "**保存**"。</span><span class="sxs-lookup"><span data-stu-id="10053-200">In the **New Deployment Configuration File** dialog box, give the file a meaningful name (for example, **TestEnvironment.sqldeployment**), and then click **Save**.</span></span>
4. <span data-ttu-id="10053-201">在 *[Filename] \* \* *. sqldeployment** 页上，设置部署属性以匹配目标环境的要求，然后保存该文件。</span><span class="sxs-lookup"><span data-stu-id="10053-201">On the *[Filename]\*\*\*.sqldeployment*\* page, set the deployment properties to match the requirements of your destination environment, and then save the file.</span></span>

    ![](customizing-database-deployments-for-multiple-environments/_static/image2.png)
5. <span data-ttu-id="10053-202">请注意，新文件将添加到数据库项目的 Properties 文件夹中。</span><span class="sxs-lookup"><span data-stu-id="10053-202">Notice that the new file is added to the Properties folder in your database project.</span></span>

    ![](customizing-database-deployments-for-multiple-environments/_static/image3.png)

## <a name="specifying-the-deployment-configuration-file-in-vsdbcmd"></a><span data-ttu-id="10053-203">在 VSDBCMD 中指定部署配置文件</span><span class="sxs-lookup"><span data-stu-id="10053-203">Specifying the Deployment Configuration File in VSDBCMD</span></span>

<span data-ttu-id="10053-204">在 Visual Studio 2010 中使用解决方案配置（如调试和发布）时，可以将部署配置文件与每个配置相关联。</span><span class="sxs-lookup"><span data-stu-id="10053-204">When you use solution configurations (like Debug and Release) within Visual Studio 2010, you can associate a deployment configuration file with each configuration.</span></span> <span data-ttu-id="10053-205">生成特定配置时，生成过程将生成特定于配置的部署清单文件，该文件指向配置特定的部署配置文件。</span><span class="sxs-lookup"><span data-stu-id="10053-205">When you build a particular configuration, the build process generates a configuration-specific deployment manifest file that points to the configuration-specific deployment configuration file.</span></span> <span data-ttu-id="10053-206">不过，这些教程中所述的部署方法的主要目的之一是使用户能够控制部署过程，而无需使用 Visual Studio 2010 和解决方案配置。</span><span class="sxs-lookup"><span data-stu-id="10053-206">However, one of the main aims of the approach to deployment described in these tutorials is to give people the ability to control the deployment process without using Visual Studio 2010 and solution configurations.</span></span> <span data-ttu-id="10053-207">在此方法中，无论目标部署环境如何，解决方案配置都是相同的。</span><span class="sxs-lookup"><span data-stu-id="10053-207">In this approach, the solution configuration is the same regardless of the target deployment environment.</span></span> <span data-ttu-id="10053-208">若要将数据库部署自适应特定目标环境，可以使用 VSDBCMD 命令行选项指定部署配置文件。</span><span class="sxs-lookup"><span data-stu-id="10053-208">To tailor your database deployment to a specific destination environment, you can use the VSDBCMD command-line options to specify your deployment configuration file.</span></span>

<span data-ttu-id="10053-209">若要在 VSDBCMD 中指定部署配置文件，请使用**p：/DeploymentConfigurationFile**开关并提供文件的完整路径。</span><span class="sxs-lookup"><span data-stu-id="10053-209">To specify a deployment configuration file in your VSDBCMD, use the **p:/DeploymentConfigurationFile** switch and provide the full path to your file.</span></span> <span data-ttu-id="10053-210">这会重写部署清单标识的部署配置文件。</span><span class="sxs-lookup"><span data-stu-id="10053-210">This will override the deployment configuration file that the deployment manifest identifies.</span></span> <span data-ttu-id="10053-211">例如，你可以使用此 VSDBCMD 命令将**ContactManager**数据库部署到测试环境：</span><span class="sxs-lookup"><span data-stu-id="10053-211">For example, you could use this VSDBCMD command to deploy the **ContactManager** database to a test environment:</span></span>

[!code-console[Main](customizing-database-deployments-for-multiple-environments/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="10053-212">请注意，在将文件复制到输出目录时，生成过程可能会重命名你的 sqldeployment 文件。</span><span class="sxs-lookup"><span data-stu-id="10053-212">Note that the build process may rename your .sqldeployment file when it copies the file to the output directory.</span></span>

<span data-ttu-id="10053-213">如果在预先部署或后期部署 SQL 脚本中使用 SQL 命令变量，则可以使用类似的方法将环境特定的 sqlcmdvars 文件与部署相关联。</span><span class="sxs-lookup"><span data-stu-id="10053-213">If you use SQL command variables in your pre-deployment or post-deployment SQL scripts, you can use a similar approach to associate an environment-specific .sqlcmdvars file with your deployment.</span></span> <span data-ttu-id="10053-214">在这种情况下，可以使用**p：/SqlCommandVariablesFile**开关来识别 sqlcmdvars 文件。</span><span class="sxs-lookup"><span data-stu-id="10053-214">In this case, you use the **p:/SqlCommandVariablesFile** switch to identify your .sqlcmdvars file.</span></span>

## <a name="running-the-vsdbcmd-command-from-an-msbuild-project-file"></a><span data-ttu-id="10053-215">从 MSBuild 项目文件运行 VSDBCMD 命令</span><span class="sxs-lookup"><span data-stu-id="10053-215">Running the VSDBCMD Command from an MSBuild Project File</span></span>

<span data-ttu-id="10053-216">可以通过使用 MSBuild 目标中的**Exec**任务，从 msbuild 项目文件调用 VSDBCMD 命令。</span><span class="sxs-lookup"><span data-stu-id="10053-216">You can invoke a VSDBCMD command from an MSBuild project file by using an **Exec** task within an MSBuild target.</span></span> <span data-ttu-id="10053-217">最简单的形式如下：</span><span class="sxs-lookup"><span data-stu-id="10053-217">In its simplest form, it would look like this:</span></span>

[!code-xml[Main](customizing-database-deployments-for-multiple-environments/samples/sample2.xml)]

- <span data-ttu-id="10053-218">在实践中，若要使您的项目文件易于阅读和重用，您需要创建用于存储各种命令行参数的属性。</span><span class="sxs-lookup"><span data-stu-id="10053-218">In practice, to make your project files easy to read and reuse, you'll want to create properties to store the various command-line parameters.</span></span> <span data-ttu-id="10053-219">这样，用户就可以更轻松地在特定于环境的项目文件中提供属性值或从 MSBuild 命令行重写默认值。</span><span class="sxs-lookup"><span data-stu-id="10053-219">This makes it easier for users to provide property values in an environment-specific project file or to override default values from the MSBuild command line.</span></span> <span data-ttu-id="10053-220">如果你使用[理解项目文件](../web-deployment-in-the-enterprise/understanding-the-project-file.md)中所述的拆分项目文件方法，则应相应地在两个文件之间划分生成说明和属性：</span><span class="sxs-lookup"><span data-stu-id="10053-220">If you use the split project file approach described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md), you should divide your build instructions and properties between the two files accordingly:</span></span>
- <span data-ttu-id="10053-221">环境特定的设置（如部署配置文件名、数据库连接字符串和目标数据库名称）应位于特定于环境的项目文件中。</span><span class="sxs-lookup"><span data-stu-id="10053-221">Environment-specific settings, like the deployment configuration filename, the database connection string, and the target database name, should go in the environment-specific project file.</span></span>
- <span data-ttu-id="10053-222">运行 VSDBCMD 命令的 MSBuild 目标与 VSDBCMD 可执行文件的位置（如可执行文件的位置）应在通用项目文件中。</span><span class="sxs-lookup"><span data-stu-id="10053-222">The MSBuild target that runs the VSDBCMD command, together with any universal properties like the location of the VSDBCMD executable, should go in the universal project file.</span></span>

<span data-ttu-id="10053-223">还应确保在调用 VSDBCMD 之前生成数据库项目，以便创建 deploymanifest 文件并使其可供使用。</span><span class="sxs-lookup"><span data-stu-id="10053-223">You should also ensure that you build the database project before you invoke VSDBCMD so that the .deploymanifest file is created and ready to use.</span></span> <span data-ttu-id="10053-224">有关此方法的完整示例，请参阅主题[了解生成过程](../web-deployment-in-the-enterprise/understanding-the-build-process.md)，该过程将指导你完成[Contact Manager 示例解决方案](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)中的项目文件。</span><span class="sxs-lookup"><span data-stu-id="10053-224">You can see a full example of this approach in the topic [Understanding the Build Process](../web-deployment-in-the-enterprise/understanding-the-build-process.md), which walks you through the project files in the [Contact Manager sample solution](../web-deployment-in-the-enterprise/the-contact-manager-solution.md).</span></span>

## <a name="conclusion"></a><span data-ttu-id="10053-225">结束语</span><span class="sxs-lookup"><span data-stu-id="10053-225">Conclusion</span></span>

<span data-ttu-id="10053-226">本主题介绍了如何在使用 MSBuild 和 VSDBCMD 部署数据库项目时，将数据库属性自适应不同的目标环境。</span><span class="sxs-lookup"><span data-stu-id="10053-226">This topic described how you can tailor database properties to different destination environments when you deploy database projects using MSBuild and VSDBCMD.</span></span> <span data-ttu-id="10053-227">当你需要将数据库项目部署为大型企业级解决方案的一部分时，此方法非常有用。</span><span class="sxs-lookup"><span data-stu-id="10053-227">This approach is useful when you need to deploy database projects as part of larger, enterprise-scale solutions.</span></span> <span data-ttu-id="10053-228">这些解决方案通常部署到多个目标，如沙盒开发或测试环境、过渡或集成平台以及生产或实时环境。</span><span class="sxs-lookup"><span data-stu-id="10053-228">These solutions are often deployed to multiple destinations, like sandboxed development or test environments, staging or integration platforms, and production or live environments.</span></span> <span data-ttu-id="10053-229">其中每个目标环境通常都需要一组唯一的数据库部署属性。</span><span class="sxs-lookup"><span data-stu-id="10053-229">Each of these target environments typically requires a unique set of database deployment properties.</span></span>

## <a name="further-reading"></a><span data-ttu-id="10053-230">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="10053-230">Further Reading</span></span>

<span data-ttu-id="10053-231">有关使用 VSDBCMD 部署数据库项目的详细信息，请参阅[部署数据库项目](../web-deployment-in-the-enterprise/deploying-database-projects.md)。</span><span class="sxs-lookup"><span data-stu-id="10053-231">For more information on deploying database projects using VSDBCMD.exe, see [Deploying Database Projects](../web-deployment-in-the-enterprise/deploying-database-projects.md).</span></span> <span data-ttu-id="10053-232">有关使用自定义 MSBuild 项目文件来控制部署过程的详细信息，请参阅[了解项目文件](../web-deployment-in-the-enterprise/understanding-the-project-file.md)和[了解生成过程](../web-deployment-in-the-enterprise/understanding-the-build-process.md)。</span><span class="sxs-lookup"><span data-stu-id="10053-232">For more information on using custom MSBuild project files to control the deployment process, see [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md) and [Understanding the Build Process](../web-deployment-in-the-enterprise/understanding-the-build-process.md).</span></span>

<span data-ttu-id="10053-233">MSDN 上的这些文章提供了有关数据库部署的更多常规指导：</span><span class="sxs-lookup"><span data-stu-id="10053-233">These articles on MSDN provide more general guidance on database deployment:</span></span>

- <span data-ttu-id="10053-234">[数据库项目设置概述](https://msdn.microsoft.com/library/aa833291(v=VS.100).aspx)</span><span class="sxs-lookup"><span data-stu-id="10053-234">[An Overview of Database Project Settings](https://msdn.microsoft.com/library/aa833291(v=VS.100).aspx)</span></span>
- [<span data-ttu-id="10053-235">如何：配置部署详细信息的属性</span><span class="sxs-lookup"><span data-stu-id="10053-235">How to: Configure Properties for Deployment Details</span></span>](https://msdn.microsoft.com/library/dd172125.aspx)
- [<span data-ttu-id="10053-236">生成数据库并将其部署到隔离开发环境</span><span class="sxs-lookup"><span data-stu-id="10053-236">Build and Deploy Databases to an Isolated Development Environment</span></span>](https://msdn.microsoft.com/library/dd193409.aspx)
- [<span data-ttu-id="10053-237">生成数据库并将其部署到过渡环境或生产环境</span><span class="sxs-lookup"><span data-stu-id="10053-237">Build and Deploy Databases to a Staging or Production Environment</span></span>](https://msdn.microsoft.com/library/dd193413.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="10053-238">[上一页](performing-a-what-if-deployment.md)
> [下一页](deploying-database-role-memberships-to-test-environments.md)</span><span class="sxs-lookup"><span data-stu-id="10053-238">[Previous](performing-a-what-if-deployment.md)
[Next](deploying-database-role-memberships-to-test-environments.md)</span></span>
