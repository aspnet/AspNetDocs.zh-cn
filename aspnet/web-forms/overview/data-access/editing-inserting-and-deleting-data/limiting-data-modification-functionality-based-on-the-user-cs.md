---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs
title: 限制基于用户的数据修改功能（C#） |Microsoft Docs
author: rick-anderson
description: 在允许用户编辑数据的 web 应用程序中，不同的用户帐户可能具有不同的数据编辑权限。 在本教程中，我们将探讨如何
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2b251c82-77cf-4e36-baa9-b648eddaa394
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs
msc.type: authoredcontent
ms.openlocfilehash: c3cacaddb7e9b493ba39718f41dcaab360d36fd9
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74580709"
---
# <a name="limiting-data-modification-functionality-based-on-the-user-c"></a><span data-ttu-id="0f30b-104">限制基于用户的数据修改功能 (C#)</span><span class="sxs-lookup"><span data-stu-id="0f30b-104">Limiting Data Modification Functionality Based on the User (C#)</span></span>

<span data-ttu-id="0f30b-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="0f30b-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="0f30b-106">[下载示例应用](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_23_CS.exe)或[下载 PDF](limiting-data-modification-functionality-based-on-the-user-cs/_static/datatutorial23cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="0f30b-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_23_CS.exe) or [Download PDF](limiting-data-modification-functionality-based-on-the-user-cs/_static/datatutorial23cs1.pdf)</span></span>

> <span data-ttu-id="0f30b-107">在允许用户编辑数据的 web 应用程序中，不同的用户帐户可能具有不同的数据编辑权限。</span><span class="sxs-lookup"><span data-stu-id="0f30b-107">In a web application that allows users to edit data, different user accounts may have different data-editing privileges.</span></span> <span data-ttu-id="0f30b-108">在本教程中，我们将检查如何根据访问用户动态调整数据修改功能。</span><span class="sxs-lookup"><span data-stu-id="0f30b-108">In this tutorial we'll examine how to dynamically adjust the data modification capabilities based on the visiting user.</span></span>

## <a name="introduction"></a><span data-ttu-id="0f30b-109">简介</span><span class="sxs-lookup"><span data-stu-id="0f30b-109">Introduction</span></span>

<span data-ttu-id="0f30b-110">许多 web 应用程序都支持用户帐户，并基于登录用户提供不同的选项、报表和功能。</span><span class="sxs-lookup"><span data-stu-id="0f30b-110">A number of web applications support user accounts and provide different options, reports, and functionality based on the logged in user.</span></span> <span data-ttu-id="0f30b-111">例如，在我们的教程中，我们可能希望允许供应商公司的用户登录到站点，并更新有关其产品的一般信息-每个单位的名称和数量，或许还包括供应商信息，如公司名称、地址、联系人信息，等等。</span><span class="sxs-lookup"><span data-stu-id="0f30b-111">For example, with our tutorials we might want to allow users from the supplier companies to log on to the site and update general information about their products - their name and quantity per unit, perhaps - along with supplier information, such as their company name, address, the contact person s information, and so on.</span></span> <span data-ttu-id="0f30b-112">此外，我们可能希望为公司中的人员包含某些用户帐户，以便他们能够登录和更新产品信息，如股票、重新排序级别等。</span><span class="sxs-lookup"><span data-stu-id="0f30b-112">Furthermore, we might want to include some user accounts for people from our company so that they can log on and update product information like units on stock, reorder level, and so forth.</span></span> <span data-ttu-id="0f30b-113">我们的 web 应用程序还可能允许匿名用户访问（没有登录的人员），但会将其限制为仅查看数据。</span><span class="sxs-lookup"><span data-stu-id="0f30b-113">Our web application might also allow anonymous users to visit (people who have not logged on), but would limit them to just viewing data.</span></span> <span data-ttu-id="0f30b-114">使用此类用户帐户系统时，我们希望 ASP.NET 页面中的数据 Web 控件能够提供适用于当前已登录用户的插入、编辑和删除功能。</span><span class="sxs-lookup"><span data-stu-id="0f30b-114">With such a user account system in place, we would want the data Web controls in our ASP.NET pages to offer the inserting, editing, and deleting capabilities appropriate for the currently logged on user.</span></span>

<span data-ttu-id="0f30b-115">在本教程中，我们将检查如何根据访问用户动态调整数据修改功能。</span><span class="sxs-lookup"><span data-stu-id="0f30b-115">In this tutorial we'll examine how to dynamically adjust the data modification capabilities based on the visiting user.</span></span> <span data-ttu-id="0f30b-116">具体而言，我们将创建一个页面，该页面将在可编辑的 DetailsView 中显示供应商信息，并使用一个 GridView 列出供应商提供的产品。</span><span class="sxs-lookup"><span data-stu-id="0f30b-116">In particular, we'll create a page that displays the suppliers information in an editable DetailsView along with a GridView that lists the products provided by the supplier.</span></span> <span data-ttu-id="0f30b-117">如果访问该页面的用户来自我们的公司，他们可以：查看任何供应商的信息;编辑其地址;和编辑供应商提供的任何产品的信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-117">If the user visiting the page is from our company, they can: view any supplier s information; edit their address; and edit the information for any product provided by the supplier.</span></span> <span data-ttu-id="0f30b-118">但是，如果用户来自特定的公司，则他们只能查看和编辑其自己的地址信息，并且只能编辑未标记为 "已停用" 的产品。</span><span class="sxs-lookup"><span data-stu-id="0f30b-118">If, however, the user is from a particular company, they can only view and edit their own address information and can only edit their products that have not been marked as discontinued.</span></span>

<span data-ttu-id="0f30b-119">[![公司的用户可以编辑任何供应商的信息](limiting-data-modification-functionality-based-on-the-user-cs/_static/image2.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-119">[![A User from Our Company Can Edit Any Supplier s Information](limiting-data-modification-functionality-based-on-the-user-cs/_static/image2.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image1.png)</span></span>

<span data-ttu-id="0f30b-120">**图 1**：我们的公司中的用户可以编辑任何供应商的信息（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-120">**Figure 1**: A User from Our Company Can Edit Any Supplier s Information ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image3.png))</span></span>

<span data-ttu-id="0f30b-121">[![特定供应商提供的用户只能查看和编辑其信息](limiting-data-modification-functionality-based-on-the-user-cs/_static/image5.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-121">[![A User from a Particular Supplier Can Only View and Edit their Information](limiting-data-modification-functionality-based-on-the-user-cs/_static/image5.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image4.png)</span></span>

<span data-ttu-id="0f30b-122">**图 2**：特定供应商提供的用户只能查看和编辑其信息（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-122">**Figure 2**: A User from a Particular Supplier Can Only View and Edit their Information ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image6.png))</span></span>

<span data-ttu-id="0f30b-123">让我们开始吧！</span><span class="sxs-lookup"><span data-stu-id="0f30b-123">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="0f30b-124">ASP.NET 2.0 s 成员资格系统提供了一种标准化的可扩展平台，用于创建、管理和验证用户帐户。</span><span class="sxs-lookup"><span data-stu-id="0f30b-124">ASP.NET 2.0 s membership system provides a standardized, extensible platform for creating, managing, and validating user accounts.</span></span> <span data-ttu-id="0f30b-125">由于对成员资格系统的检查超出了这些教程的范围，因此本教程会允许匿名访问者选择是来自特定供应商还是来自公司，而不是 "fakes" 成员资格。</span><span class="sxs-lookup"><span data-stu-id="0f30b-125">Since an examination of the membership system is beyond the scope of these tutorials, this tutorial instead "fakes" membership by allowing anonymous visitors to choose whether they are from a particular supplier or from our company.</span></span> <span data-ttu-id="0f30b-126">有关成员身份的详细信息，请参阅我的[检查 ASP.NET 2.0 s 成员资格、角色和配置文件](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)文章系列。</span><span class="sxs-lookup"><span data-stu-id="0f30b-126">For more on membership, refer to my [Examining ASP.NET 2.0 s Membership, Roles, and Profile](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx) article series.</span></span>

## <a name="step-1-allowing-the-user-to-specify-their-access-rights"></a><span data-ttu-id="0f30b-127">步骤1：允许用户指定其访问权限</span><span class="sxs-lookup"><span data-stu-id="0f30b-127">Step 1: Allowing the User to Specify their Access Rights</span></span>

<span data-ttu-id="0f30b-128">在实际的 web 应用程序中，用户的帐户信息将包括用户是否适用于公司或特定的供应商，并且用户登录到站点后，可以通过 ASP.NET 页面以编程方式访问此信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-128">In a real-world web application, a user s account information would include whether they worked for our company or for a particular supplier, and this information would be programmatically accessible from our ASP.NET pages once the user has logged on to the site.</span></span> <span data-ttu-id="0f30b-129">此信息可通过 ASP.NET 2.0 s 角色系统捕获，作为通过配置文件系统的用户级帐户信息，或通过某些自定义方式捕获。</span><span class="sxs-lookup"><span data-stu-id="0f30b-129">This information could be captured through ASP.NET 2.0 s roles system, as user-level account information through the profile system, or through some custom means.</span></span>

<span data-ttu-id="0f30b-130">由于本教程的目的是演示如何基于已登录用户调整数据修改功能，而不是展示 ASP.NET 2.0 s 的成员资格、角色和配置文件系统，因此我们将使用一种非常简单的机制来确定用户访问页面的功能-用户可从该 DropDownList 指示他们是否应该能够查看和编辑任何供应商信息，或者他们可以查看和编辑哪些特定的供应商信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-130">Since the aim of this tutorial is to demonstrate adjusting the data modification capabilities based on the logged on user, and is not meant to showcase ASP.NET 2.0 s membership, roles, and profile systems, we'll use a very simply mechanism to determine the capabilities for the user visiting the page - a DropDownList from which the user can indicate if they should be able to view and edit any of the suppliers information or, alternatively, what particular supplier s information they can view and edit.</span></span> <span data-ttu-id="0f30b-131">如果用户指示她可以查看和编辑所有供应商信息（默认值），则她可以逐页浏览所有供应商、编辑任何供应商的地址信息，并编辑所选供应商提供的任何产品的名称和数量。</span><span class="sxs-lookup"><span data-stu-id="0f30b-131">If the user indicates that she can view and edit all supplier information (the default), she can page through all suppliers, edit any supplier s address information, and edit the name and quantity per unit for any product provided by the selected supplier.</span></span> <span data-ttu-id="0f30b-132">但是，如果用户指示她只可以查看和编辑特定供应商，则她只可以查看该供应商的详细信息和产品，并且只能为*未*停用的产品更新名称和数量。</span><span class="sxs-lookup"><span data-stu-id="0f30b-132">If the user indicates that she can only view and edit a particular supplier, however, then she can only view the details and products for that one supplier and can only update the name and quantity per unit information for those products that are *not* discontinued.</span></span>

<span data-ttu-id="0f30b-133">本教程的第一步是创建此 DropDownList，并将其填充到系统中的供应商。</span><span class="sxs-lookup"><span data-stu-id="0f30b-133">Our first step in this tutorial, then, is to create this DropDownList and populate it with the suppliers in the system.</span></span> <span data-ttu-id="0f30b-134">打开 `EditInsertDelete` 文件夹中的 "`UserLevelAccess.aspx`" 页，添加其 `ID` 属性设置为 `Suppliers`的 DropDownList，并将此 DropDownList 绑定到名为 `AllSuppliersDataSource`的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="0f30b-134">Open the `UserLevelAccess.aspx` page in the `EditInsertDelete` folder, add a DropDownList whose `ID` property is set to `Suppliers`, and bind this DropDownList to a new ObjectDataSource named `AllSuppliersDataSource`.</span></span>

<span data-ttu-id="0f30b-135">[![创建一个名为 AllSuppliersDataSource 的新 ObjectDataSource](limiting-data-modification-functionality-based-on-the-user-cs/_static/image8.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-135">[![Create a New ObjectDataSource Named AllSuppliersDataSource](limiting-data-modification-functionality-based-on-the-user-cs/_static/image8.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image7.png)</span></span>

<span data-ttu-id="0f30b-136">**图 3**：创建名为 `AllSuppliersDataSource` 的新 ObjectDataSource （[单击以查看完全大小的映像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-136">**Figure 3**: Create a New ObjectDataSource Named `AllSuppliersDataSource` ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image9.png))</span></span>

<span data-ttu-id="0f30b-137">由于我们希望此 DropDownList 包含所有供应商，因此请将 ObjectDataSource 配置为调用 `SuppliersBLL` 类 `GetSuppliers()` 方法。</span><span class="sxs-lookup"><span data-stu-id="0f30b-137">Since we want this DropDownList to include all suppliers, configure the ObjectDataSource to invoke the `SuppliersBLL` class s `GetSuppliers()` method.</span></span> <span data-ttu-id="0f30b-138">此外，请确保将 ObjectDataSource `Update()` 方法映射到 `SuppliersBLL` 类 `UpdateSupplierAddress` 方法，因为此 ObjectDataSource 还将由我们在步骤2中添加的 DetailsView 使用。</span><span class="sxs-lookup"><span data-stu-id="0f30b-138">Also ensure that the ObjectDataSource s `Update()` method is mapped to the `SuppliersBLL` class s `UpdateSupplierAddress` method, as this ObjectDataSource will also be used by the DetailsView we'll be adding in Step 2.</span></span>

<span data-ttu-id="0f30b-139">完成 ObjectDataSource 向导后，通过配置 `Suppliers` DropDownList 来完成这些步骤，以便显示 `CompanyName` 数据字段并使用 `SupplierID` 数据字段作为每个 `ListItem`的值。</span><span class="sxs-lookup"><span data-stu-id="0f30b-139">After completing the ObjectDataSource wizard, complete the steps by configuring the `Suppliers` DropDownList such that it shows the `CompanyName` data field and uses the `SupplierID` data field as the value for each `ListItem`.</span></span>

<span data-ttu-id="0f30b-140">[![将供应商 DropDownList 配置为使用 "公司名称" 和 "供应商" 数据字段](limiting-data-modification-functionality-based-on-the-user-cs/_static/image11.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-140">[![Configure the Suppliers DropDownList to Use the CompanyName and SupplierID Data Fields](limiting-data-modification-functionality-based-on-the-user-cs/_static/image11.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image10.png)</span></span>

<span data-ttu-id="0f30b-141">**图 4**：将 `Suppliers` DropDownList 配置为使用 "`CompanyName`" 和 "`SupplierID` 数据" 字段（[单击以查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-141">**Figure 4**: Configure the `Suppliers` DropDownList to Use the `CompanyName` and `SupplierID` Data Fields ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image12.png))</span></span>

<span data-ttu-id="0f30b-142">此时，DropDownList 列出了数据库中供应商的公司名称。</span><span class="sxs-lookup"><span data-stu-id="0f30b-142">At this point, the DropDownList lists the company names of the suppliers in the database.</span></span> <span data-ttu-id="0f30b-143">但是，我们还需要在 DropDownList 中包含 "显示/编辑所有供应商" 选项。</span><span class="sxs-lookup"><span data-stu-id="0f30b-143">However, we also need to include a "Show/Edit ALL Suppliers" option to the DropDownList.</span></span> <span data-ttu-id="0f30b-144">若要实现此目的，请将 `Suppliers` DropDownList s `AppendDataBoundItems` 属性设置为 `true`，然后添加 `Text` 属性为 "显示/编辑所有供应商" 的 `ListItem`，其值为 `-1`。</span><span class="sxs-lookup"><span data-stu-id="0f30b-144">To accomplish this, set the `Suppliers` DropDownList s `AppendDataBoundItems` property to `true` and then add a `ListItem` whose `Text` property is "Show/Edit ALL Suppliers" and whose value is `-1`.</span></span> <span data-ttu-id="0f30b-145">这可以通过声明性标记直接添加，也可以通过设计器添加，方法是转到属性窗口并单击 DropDownList s `Items` 属性中的省略号。</span><span class="sxs-lookup"><span data-stu-id="0f30b-145">This can be added directly through the declarative markup or through the Designer by going to the Properties window and clicking on the ellipses in the DropDownList s `Items` property.</span></span>

> [!NOTE]
> <span data-ttu-id="0f30b-146">若要详细了解如何将 Select All 项添加到数据绑定 DropDownList，请参阅使用 DropDownList 教程返回到[*大纲/详细信息筛选*](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="0f30b-146">Refer back to the [*Master/Detail Filtering With a DropDownList*](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md) tutorial for a more detailed discussion on adding a Select All item to a databound DropDownList.</span></span>

<span data-ttu-id="0f30b-147">设置 `AppendDataBoundItems` 属性并添加 `ListItem` 后，DropDownList 的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="0f30b-147">After the `AppendDataBoundItems` property has been set and the `ListItem` added, the DropDownList s declarative markup should look like:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample1.aspx)]

<span data-ttu-id="0f30b-148">图5显示了通过浏览器查看当前进度的屏幕截图。</span><span class="sxs-lookup"><span data-stu-id="0f30b-148">Figure 5 shows a screen shot of our current progress, when viewed through a browser.</span></span>

<span data-ttu-id="0f30b-149">[![供应商 DropDownList 包含 "显示所有项"，每个供应商对应一个](limiting-data-modification-functionality-based-on-the-user-cs/_static/image14.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-149">[![The Suppliers DropDownList Contains a Show ALL ListItem, Plus One for Each Supplier](limiting-data-modification-functionality-based-on-the-user-cs/_static/image14.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image13.png)</span></span>

<span data-ttu-id="0f30b-150">**图 5**： `Suppliers` DropDownList 包含 "全部显示" `ListItem`，并为每个供应商提供一个（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-150">**Figure 5**: The `Suppliers` DropDownList Contains a Show ALL `ListItem`, Plus One for Each Supplier ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image15.png))</span></span>

<span data-ttu-id="0f30b-151">由于我们希望在用户更改其选择后立即更新用户界面，因此请将 `Suppliers` DropDownList s `AutoPostBack` 属性设置为 "`true`"。</span><span class="sxs-lookup"><span data-stu-id="0f30b-151">Since we want to update the user interface immediately after the user has changed their selection, set the `Suppliers` DropDownList s `AutoPostBack` property to `true`.</span></span> <span data-ttu-id="0f30b-152">在步骤2中，我们将创建一个 DetailsView 控件，该控件将基于 DropDownList 选择显示供应商的信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-152">In Step 2 we'll create a DetailsView control that will show the information for the supplier(s) based on the DropDownList selection.</span></span> <span data-ttu-id="0f30b-153">然后，在步骤3中，我们将为此 DropDownList `SelectedIndexChanged` 事件创建事件处理程序，我们将添加代码，用于根据所选供应商将相应的供应商信息绑定到 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="0f30b-153">Then, in Step 3, we'll create an event handler for this DropDownList s `SelectedIndexChanged` event, in which we'll add code that binds the appropriate supplier information to the DetailsView based upon the selected supplier.</span></span>

## <a name="step-2-adding-a-detailsview-control"></a><span data-ttu-id="0f30b-154">步骤2：添加 DetailsView 控件</span><span class="sxs-lookup"><span data-stu-id="0f30b-154">Step 2: Adding a DetailsView Control</span></span>

<span data-ttu-id="0f30b-155">让我们使用 DetailsView 来显示供应商信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-155">Let s use a DetailsView to show supplier information.</span></span> <span data-ttu-id="0f30b-156">对于可以查看和编辑所有供应商的用户，DetailsView 将支持分页，并允许用户一次单步执行一条记录的供应商信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-156">For the user who can view and edit all suppliers, the DetailsView will support paging, allowing the user to step through the supplier information one record at a time.</span></span> <span data-ttu-id="0f30b-157">但是，如果用户适用于特定的供应商，则 DetailsView 只显示该特定供应商的信息，而不包括寻呼接口。</span><span class="sxs-lookup"><span data-stu-id="0f30b-157">If the user works for a particular supplier, however, the DetailsView will show only that particular supplier s information and will not include a paging interface.</span></span> <span data-ttu-id="0f30b-158">在任一情况下，DetailsView 都需要允许用户编辑供应商的地址、城市和国家/地区字段。</span><span class="sxs-lookup"><span data-stu-id="0f30b-158">In either case, the DetailsView needs to allow the user to edit the supplier s address, city, and country fields.</span></span>

<span data-ttu-id="0f30b-159">将 DetailsView 添加到 `Suppliers` DropDownList 下的页，将其 `ID` 属性设置为 `SupplierDetails`，并将其绑定到在上一步中创建的 `AllSuppliersDataSource` ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="0f30b-159">Add a DetailsView to the page beneath the `Suppliers` DropDownList, set its `ID` property to `SupplierDetails`, and bind it to the `AllSuppliersDataSource` ObjectDataSource created in the previous step.</span></span> <span data-ttu-id="0f30b-160">接下来，选中 "启用分页" 和 "启用编辑" 复选框。</span><span class="sxs-lookup"><span data-stu-id="0f30b-160">Next, check the Enable Paging and Enable Editing checkboxes from the DetailsView s smart tag.</span></span>

> [!NOTE]
> <span data-ttu-id="0f30b-161">如果未在 DetailsView s 智能标记中看到 "启用编辑" 选项，则这是因为未将 ObjectDataSource `Update()` 方法映射到 `SuppliersBLL` 类 s `UpdateSupplierAddress` 方法。</span><span class="sxs-lookup"><span data-stu-id="0f30b-161">If you don t see an Enable Editing option in the DetailsView s smart tag it s because you did not map the ObjectDataSource s `Update()` method to the `SuppliersBLL` class s `UpdateSupplierAddress` method.</span></span> <span data-ttu-id="0f30b-162">请花点时间返回并进行此配置更改，之后 DetailsView s 智能标记中应显示 "启用编辑" 选项。</span><span class="sxs-lookup"><span data-stu-id="0f30b-162">Take a moment to go back and make this configuration change, after which the Enable Editing option should appear in the DetailsView s smart tag.</span></span>

<span data-ttu-id="0f30b-163">由于 `SuppliersBLL` 类 `UpdateSupplierAddress` 方法仅接受四个参数： `supplierID`、`address`、`city`和 `country` 修改 DetailsView s 的 BoundFields，以使 `CompanyName` 和 `Phone` BoundFields 为只读。</span><span class="sxs-lookup"><span data-stu-id="0f30b-163">Since the `SuppliersBLL` class s `UpdateSupplierAddress` method only accepts four parameters - `supplierID`, `address`, `city`, and `country` - modify the DetailsView s BoundFields so that the `CompanyName` and `Phone` BoundFields are read-only.</span></span> <span data-ttu-id="0f30b-164">此外，`SupplierID` 完全删除的 BoundField。</span><span class="sxs-lookup"><span data-stu-id="0f30b-164">Additionally, remove the `SupplierID` BoundField altogether.</span></span> <span data-ttu-id="0f30b-165">最后，`AllSuppliersDataSource` ObjectDataSource 当前将其 `OldValuesParameterFormatString` 属性设置为 "`original_{0}`"。</span><span class="sxs-lookup"><span data-stu-id="0f30b-165">Finally, the `AllSuppliersDataSource` ObjectDataSource currently has its `OldValuesParameterFormatString` property set to `original_{0}`.</span></span> <span data-ttu-id="0f30b-166">请花点时间从声明性语法中删除此属性设置，或将其设置为默认值 `{0}`。</span><span class="sxs-lookup"><span data-stu-id="0f30b-166">Take a moment to remove this property setting from the declarative syntax altogether, or set it to the default value, `{0}`.</span></span>

<span data-ttu-id="0f30b-167">配置 `SupplierDetails` DetailsView 并 `AllSuppliersDataSource` ObjectDataSource 后，我们将获得以下声明性标记：</span><span class="sxs-lookup"><span data-stu-id="0f30b-167">After configuring the `SupplierDetails` DetailsView and `AllSuppliersDataSource` ObjectDataSource, we will have the following declarative markup:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample2.aspx)]

<span data-ttu-id="0f30b-168">此时，DetailsView 可以分页到，并且所选供应商的地址信息可以更新，而不管 `Suppliers` DropDownList 中所做的选择（参见图6）。</span><span class="sxs-lookup"><span data-stu-id="0f30b-168">At this point the DetailsView can be paged through and the selected supplier s address information can be updated, regardless of the selection made in the `Suppliers` DropDownList (see Figure 6).</span></span>

<span data-ttu-id="0f30b-169">[![可以查看任何供应商信息，并更新其地址](limiting-data-modification-functionality-based-on-the-user-cs/_static/image17.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-169">[![Any Suppliers Information Can Be Viewed, and Its Address Updated](limiting-data-modification-functionality-based-on-the-user-cs/_static/image17.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image16.png)</span></span>

<span data-ttu-id="0f30b-170">**图 6**：可以查看所有供应商信息，并更新其地址（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-170">**Figure 6**: Any Suppliers Information Can Be Viewed, and Its Address Updated ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image18.png))</span></span>

## <a name="step-3-displaying-only-the-selected-supplier-s-information"></a><span data-ttu-id="0f30b-171">步骤3：仅显示所选供应商的信息</span><span class="sxs-lookup"><span data-stu-id="0f30b-171">Step 3: Displaying Only the Selected Supplier s Information</span></span>

<span data-ttu-id="0f30b-172">页面当前显示所有供应商的信息，无论是否从 `Suppliers` DropDownList 中选择了特定的供应商。</span><span class="sxs-lookup"><span data-stu-id="0f30b-172">Our page currently displays the information for all suppliers regardless of whether a particular supplier has been selected from the `Suppliers` DropDownList.</span></span> <span data-ttu-id="0f30b-173">为了只显示所选供应商的供应商信息，我们需要向页面中添加另一个 ObjectDataSource，其中一个用于检索有关特定供应商的信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-173">In order to display just the supplier information for the selected supplier we need to add another ObjectDataSource to our page, one that retrieves information about a particular supplier.</span></span>

<span data-ttu-id="0f30b-174">将新的 ObjectDataSource 添加到页面，并将其命名为 `SingleSupplierDataSource`。</span><span class="sxs-lookup"><span data-stu-id="0f30b-174">Add a new ObjectDataSource to the page, naming it `SingleSupplierDataSource`.</span></span> <span data-ttu-id="0f30b-175">在其智能标记中，单击 "配置数据源" 链接，并使其使用 `SuppliersBLL` 类 `GetSupplierBySupplierID(supplierID)` 方法。</span><span class="sxs-lookup"><span data-stu-id="0f30b-175">From its smart tag, click the Configure Data Source link and have it use the `SuppliersBLL` class s `GetSupplierBySupplierID(supplierID)` method.</span></span> <span data-ttu-id="0f30b-176">与 `AllSuppliersDataSource` ObjectDataSource 一样，将 `SingleSupplierDataSource` ObjectDataSource s `Update()` 方法映射到 `SuppliersBLL` 类 `UpdateSupplierAddress` 方法。</span><span class="sxs-lookup"><span data-stu-id="0f30b-176">As with the `AllSuppliersDataSource` ObjectDataSource, have the `SingleSupplierDataSource` ObjectDataSource s `Update()` method mapped to the `SuppliersBLL` class s `UpdateSupplierAddress` method.</span></span>

<span data-ttu-id="0f30b-177">[![将 SingleSupplierDataSource ObjectDataSource 配置为使用 GetSupplierBySupplierID （供应商）方法](limiting-data-modification-functionality-based-on-the-user-cs/_static/image20.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-177">[![Configure the SingleSupplierDataSource ObjectDataSource to Use the GetSupplierBySupplierID(supplierID) Method](limiting-data-modification-functionality-based-on-the-user-cs/_static/image20.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image19.png)</span></span>

<span data-ttu-id="0f30b-178">**图 7**：将 `SingleSupplierDataSource` ObjectDataSource 配置为使用 `GetSupplierBySupplierID(supplierID)` 方法（[单击查看完全大小的映像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-178">**Figure 7**: Configure the `SingleSupplierDataSource` ObjectDataSource to Use the `GetSupplierBySupplierID(supplierID)` Method ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image21.png))</span></span>

<span data-ttu-id="0f30b-179">接下来，系统将提示您指定 `GetSupplierBySupplierID(supplierID)` 方法 s `supplierID` 输入参数的参数源。</span><span class="sxs-lookup"><span data-stu-id="0f30b-179">Next, we re prompted to specify the parameter source for the `GetSupplierBySupplierID(supplierID)` method s `supplierID` input parameter.</span></span> <span data-ttu-id="0f30b-180">由于我们要显示从 DropDownList 中选择的供应商的信息，因此请使用 `Suppliers` DropDownList s `SelectedValue` 属性作为参数源。</span><span class="sxs-lookup"><span data-stu-id="0f30b-180">Since we want to show the information for the supplier selected from the DropDownList, use the `Suppliers` DropDownList s `SelectedValue` property as the parameter source.</span></span>

<span data-ttu-id="0f30b-181">[![使用供应商 DropDownList 作为供应商参数源](limiting-data-modification-functionality-based-on-the-user-cs/_static/image23.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-181">[![Use the Suppliers DropDownList as the supplierID Parameter Source](limiting-data-modification-functionality-based-on-the-user-cs/_static/image23.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image22.png)</span></span>

<span data-ttu-id="0f30b-182">**图 8**：使用 `Suppliers` DropDownList 作为 `supplierID` 参数源（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-182">**Figure 8**: Use the `Suppliers` DropDownList as the `supplierID` Parameter Source ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image24.png))</span></span>

<span data-ttu-id="0f30b-183">即使添加了此第二个 ObjectDataSource，DetailsView 控件当前也配置为始终使用 `AllSuppliersDataSource` ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="0f30b-183">Even with this second ObjectDataSource added, the DetailsView control is currently configured to always use the `AllSuppliersDataSource` ObjectDataSource.</span></span> <span data-ttu-id="0f30b-184">我们需要添加逻辑来调整 DetailsView 所使用的数据源，具体取决于所选的 `Suppliers` DropDownList 项。</span><span class="sxs-lookup"><span data-stu-id="0f30b-184">We need to add logic to adjust the data source used by the DetailsView depending on the `Suppliers` DropDownList item selected.</span></span> <span data-ttu-id="0f30b-185">为此，请为 DropDownList 供应商创建一个 `SelectedIndexChanged` 事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="0f30b-185">To accomplish this, create a `SelectedIndexChanged` event handler for the Suppliers DropDownList.</span></span> <span data-ttu-id="0f30b-186">通过双击设计器中的 DropDownList，可以轻松地创建此项。</span><span class="sxs-lookup"><span data-stu-id="0f30b-186">This can most easily be created by double-clicking the DropDownList in the Designer.</span></span> <span data-ttu-id="0f30b-187">此事件处理程序需要确定要使用的数据源，并必须将数据重新绑定到 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="0f30b-187">This event handler needs to determine what data source to use and must rebind the data to the DetailsView.</span></span> <span data-ttu-id="0f30b-188">这是通过以下代码完成的：</span><span class="sxs-lookup"><span data-stu-id="0f30b-188">This is accomplished with the following code:</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample3.cs)]

<span data-ttu-id="0f30b-189">此事件处理程序首先确定是否选择了 "显示/编辑所有供应商" 选项。</span><span class="sxs-lookup"><span data-stu-id="0f30b-189">The event handler begins by determining whether the "Show/Edit ALL Suppliers" option was selected.</span></span> <span data-ttu-id="0f30b-190">如果是，则它将 `SupplierDetails` DetailsView s `DataSourceID` 设置为 `AllSuppliersDataSource`，并通过将 `PageIndex` 属性设置为0，将用户返回到供应商组中的第一条记录。</span><span class="sxs-lookup"><span data-stu-id="0f30b-190">If it was, it sets the `SupplierDetails` DetailsView s `DataSourceID` to `AllSuppliersDataSource` and returns the user to the first record in the set of suppliers by setting the `PageIndex` property to 0.</span></span> <span data-ttu-id="0f30b-191">但是，如果用户从 DropDownList 中选择了特定的供应商，则将 `DataSourceID` DetailsView s 分配给 `SingleSuppliersDataSource`。</span><span class="sxs-lookup"><span data-stu-id="0f30b-191">If, however, the user has selected a particular supplier from the DropDownList, the DetailsView s `DataSourceID` is assigned to `SingleSuppliersDataSource`.</span></span> <span data-ttu-id="0f30b-192">无论使用何种数据源，都将 `SuppliersDetails` 模式恢复为只读模式，并通过调用 `SuppliersDetails` 控制 s `DataBind()` 方法将数据重新绑定到 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="0f30b-192">Regardless of what data source is used, the `SuppliersDetails` mode is reverted back to the read-only mode and the data is rebound to the DetailsView by a call to the `SuppliersDetails` control s `DataBind()` method.</span></span>

<span data-ttu-id="0f30b-193">使用此事件处理程序后，DetailsView 控件现在会显示选定的供应商，除非选择了 "显示/编辑所有供应商" 选项，在这种情况下，所有供应商都可以通过分页界面查看。</span><span class="sxs-lookup"><span data-stu-id="0f30b-193">With this event handler in place, the DetailsView control now shows the selected supplier, unless the "Show/Edit ALL Suppliers" option was selected, in which case all of the suppliers can be viewed through the paging interface.</span></span> <span data-ttu-id="0f30b-194">图9显示了选中 "显示/编辑所有供应商" 选项的页面;请注意，存在分页接口，允许用户访问和更新任何供应商。</span><span class="sxs-lookup"><span data-stu-id="0f30b-194">Figure 9 shows the page with the "Show/Edit ALL Suppliers" option selected; note that the paging interface is present, allowing the user to visit and update any supplier.</span></span> <span data-ttu-id="0f30b-195">图10显示了选定了 Ma Maison 供应商的页面。</span><span class="sxs-lookup"><span data-stu-id="0f30b-195">Figure 10 shows the page with the Ma Maison supplier selected.</span></span> <span data-ttu-id="0f30b-196">在这种情况下，仅可查看和编辑 Ma Maison 的信息。</span><span class="sxs-lookup"><span data-stu-id="0f30b-196">Only Ma Maison s information is viewable and editable in this case.</span></span>

<span data-ttu-id="0f30b-197">[![可以查看和编辑所有供应商信息](limiting-data-modification-functionality-based-on-the-user-cs/_static/image26.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-197">[![All of the Suppliers Information Can Be Viewed and Edited](limiting-data-modification-functionality-based-on-the-user-cs/_static/image26.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image25.png)</span></span>

<span data-ttu-id="0f30b-198">**图 9**：所有供应商信息都可以查看和编辑（[单击查看完全尺寸的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image27.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-198">**Figure 9**: All of the Suppliers Information Can Be Viewed and Edited ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image27.png))</span></span>

<span data-ttu-id="0f30b-199">[仅 ![可以查看和编辑所选供应商的信息](limiting-data-modification-functionality-based-on-the-user-cs/_static/image29.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-199">[![Only the Selected Supplier s Information Can Be Viewed and Edited](limiting-data-modification-functionality-based-on-the-user-cs/_static/image29.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image28.png)</span></span>

<span data-ttu-id="0f30b-200">**图 10**：只可以查看和编辑所选供应商的信息（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image30.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-200">**Figure 10**: Only the Selected Supplier s Information Can Be Viewed and Edited ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image30.png))</span></span>

> [!NOTE]
> <span data-ttu-id="0f30b-201">对于本教程，必须将 "DropDownList" 和 "DetailsView" 控制 `EnableViewState` 设置为 `true` （默认值），因为 DropDownList s `SelectedIndex` 和 DetailsView s `DataSourceID` 属性 s 更改必须在回发之间保留。</span><span class="sxs-lookup"><span data-stu-id="0f30b-201">For this tutorial, both the DropDownList and DetailsView control s `EnableViewState` must be set to `true` (the default) because the DropDownList s `SelectedIndex` and the DetailsView s `DataSourceID` property s changes must be remembered across postbacks.</span></span>

## <a name="step-4-listing-the-suppliers-products-in-an-editable-gridview"></a><span data-ttu-id="0f30b-202">步骤4：在可编辑的 GridView 中列出供应商产品</span><span class="sxs-lookup"><span data-stu-id="0f30b-202">Step 4: Listing the Suppliers Products in an Editable GridView</span></span>

<span data-ttu-id="0f30b-203">完成 DetailsView 后，下一步是包含可编辑的 GridView，其中列出了所选供应商提供的产品。</span><span class="sxs-lookup"><span data-stu-id="0f30b-203">With the DetailsView complete, our next step is to include an editable GridView that lists those products provided by the selected supplier.</span></span> <span data-ttu-id="0f30b-204">此 GridView 应该只允许对 `ProductName` 和 `QuantityPerUnit` 字段进行编辑。</span><span class="sxs-lookup"><span data-stu-id="0f30b-204">This GridView should allow edits to only the `ProductName` and `QuantityPerUnit` fields.</span></span> <span data-ttu-id="0f30b-205">而且，如果访问此页的用户来自特定的供应商，则只允许更新那些*不*停用的产品。</span><span class="sxs-lookup"><span data-stu-id="0f30b-205">Moreover, if the user visiting the page is from a particular supplier, it should only allow updates to those products that are *not* discontinued.</span></span> <span data-ttu-id="0f30b-206">为实现此目的，我们需要首先添加 `ProductsBLL` 类 `UpdateProducts` 方法的重载，该重载只采用 `ProductID`、`ProductName`和 `QuantityPerUnit` 字段作为输入。</span><span class="sxs-lookup"><span data-stu-id="0f30b-206">To accomplish this we'll need to first add an overload of the `ProductsBLL` class s `UpdateProducts` method that takes in just the `ProductID`, `ProductName`, and `QuantityPerUnit` fields as inputs.</span></span> <span data-ttu-id="0f30b-207">在许多教程中，我们提前完成了这一过程，因此，只需查看此处的代码即可 `ProductsBLL`：</span><span class="sxs-lookup"><span data-stu-id="0f30b-207">We ve stepped through this process beforehand in numerous tutorials, so let s just look at the code here, which should be added to `ProductsBLL`:</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample4.cs)]

<span data-ttu-id="0f30b-208">创建了此重载后，便可以添加 GridView 控件及其关联的 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="0f30b-208">With this overload created, we re ready to add the GridView control and its associated ObjectDataSource.</span></span> <span data-ttu-id="0f30b-209">向页面添加一个新的 GridView，将其 `ID` 属性设置为 `ProductsBySupplier`，并将其配置为使用名为 `ProductsBySupplierDataSource`的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="0f30b-209">Add a new GridView to the page, set its `ID` property to `ProductsBySupplier`, and configure it to use a new ObjectDataSource named `ProductsBySupplierDataSource`.</span></span> <span data-ttu-id="0f30b-210">由于我们希望此 GridView 按所选供应商列出这些产品，因此请使用 `ProductsBLL` 类 s `GetProductsBySupplierID(supplierID)` 方法。</span><span class="sxs-lookup"><span data-stu-id="0f30b-210">Since we want this GridView to list those products by the selected supplier, use the `ProductsBLL` class s `GetProductsBySupplierID(supplierID)` method.</span></span> <span data-ttu-id="0f30b-211">还将 `Update()` 方法映射到刚刚创建的新 `UpdateProduct` 重载。</span><span class="sxs-lookup"><span data-stu-id="0f30b-211">Also map the `Update()` method to the new `UpdateProduct` overload we just created.</span></span>

<span data-ttu-id="0f30b-212">[![将 ObjectDataSource 配置为使用刚创建的 UpdateProduct 重载](limiting-data-modification-functionality-based-on-the-user-cs/_static/image32.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-212">[![Configure the ObjectDataSource to Use the UpdateProduct Overload Just Created](limiting-data-modification-functionality-based-on-the-user-cs/_static/image32.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image31.png)</span></span>

<span data-ttu-id="0f30b-213">**图 11**：将 ObjectDataSource 配置为使用刚创建的 `UpdateProduct` 重载（[单击查看完全大小的映像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image33.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-213">**Figure 11**: Configure the ObjectDataSource to Use the `UpdateProduct` Overload Just Created ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image33.png))</span></span>

<span data-ttu-id="0f30b-214">系统将提示为 `GetProductsBySupplierID(supplierID)` 方法 s `supplierID` 输入参数选择参数源。</span><span class="sxs-lookup"><span data-stu-id="0f30b-214">We re prompted to select the parameter source for the `GetProductsBySupplierID(supplierID)` method s `supplierID` input parameter.</span></span> <span data-ttu-id="0f30b-215">由于我们希望在 DetailsView 中显示所选供应商的产品，因此，请使用 `SuppliersDetails` DetailsView 控件 s `SelectedValue` 属性作为参数源。</span><span class="sxs-lookup"><span data-stu-id="0f30b-215">Since we want to show the products for the supplier selected in the DetailsView, use the `SuppliersDetails` DetailsView control s `SelectedValue` property as the parameter source.</span></span>

<span data-ttu-id="0f30b-216">[![使用 SuppliersDetails DetailsView s SelectedValue 属性作为参数源](limiting-data-modification-functionality-based-on-the-user-cs/_static/image35.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-216">[![Use the SuppliersDetails DetailsView s SelectedValue Property as the Parameter Source](limiting-data-modification-functionality-based-on-the-user-cs/_static/image35.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image34.png)</span></span>

<span data-ttu-id="0f30b-217">**图 12**：使用 `SuppliersDetails` DetailsView s `SelectedValue` 属性作为参数源（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image36.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-217">**Figure 12**: Use the `SuppliersDetails` DetailsView s `SelectedValue` Property as the Parameter Source ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image36.png))</span></span>

<span data-ttu-id="0f30b-218">返回到 GridView，删除除 `ProductName`、`QuantityPerUnit`和 `Discontinued`之外的所有 GridView 字段，并将 `Discontinued` CheckBoxField 标记为只读。</span><span class="sxs-lookup"><span data-stu-id="0f30b-218">Returning to the GridView, remove all of the GridView fields except for `ProductName`, `QuantityPerUnit`, and `Discontinued`, marking the `Discontinued` CheckBoxField as read-only.</span></span> <span data-ttu-id="0f30b-219">另外，请检查 GridView s 智能标记的启用编辑选项。</span><span class="sxs-lookup"><span data-stu-id="0f30b-219">Also, check the Enable Editing option from the GridView s smart tag.</span></span> <span data-ttu-id="0f30b-220">进行这些更改后，GridView 和 ObjectDataSource 的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="0f30b-220">After these changes have been made, the declarative markup for the GridView and ObjectDataSource should look similar to the following:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample5.aspx)]

<span data-ttu-id="0f30b-221">与我们以前的 Objectdatasource 一样，这一 `OldValuesParameterFormatString` 属性设置为 `original_{0}`，这会在尝试更新产品的名称或数量时导致问题。</span><span class="sxs-lookup"><span data-stu-id="0f30b-221">As with our previous ObjectDataSources, this one s `OldValuesParameterFormatString` property is set to `original_{0}`, which will cause problems when attempting to update a product s name or quantity per unit.</span></span> <span data-ttu-id="0f30b-222">从声明性语法中删除此属性或将其设置为默认值 `{0}`。</span><span class="sxs-lookup"><span data-stu-id="0f30b-222">Remove this property from the declarative syntax altogether or set it to its default, `{0}`.</span></span>

<span data-ttu-id="0f30b-223">完成此配置后，我们的页面现在会列出在 GridView 中选择的供应商提供的产品（参见图13）。</span><span class="sxs-lookup"><span data-stu-id="0f30b-223">With this configuration complete, our page now lists the products provided by the supplier selected in the GridView (see Figure 13).</span></span> <span data-ttu-id="0f30b-224">当前可以更新每个单位的*任何*产品名称或数量。</span><span class="sxs-lookup"><span data-stu-id="0f30b-224">Currently *any* product s name or quantity per unit can be updated.</span></span> <span data-ttu-id="0f30b-225">但是，我们需要更新页面逻辑，以便对与特定供应商相关联的用户禁止使用此类功能。</span><span class="sxs-lookup"><span data-stu-id="0f30b-225">However, we need to update our page logic so that such functionality is prohibited for discontinued products for users associated with a particular supplier.</span></span> <span data-ttu-id="0f30b-226">我们将在步骤5中处理这最后一段。</span><span class="sxs-lookup"><span data-stu-id="0f30b-226">We'll tackle this final piece in Step 5.</span></span>

<span data-ttu-id="0f30b-227">[显示选定供应商提供的产品 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image38.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-227">[![The Products Provided by the Selected Supplier are Displayed](limiting-data-modification-functionality-based-on-the-user-cs/_static/image38.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image37.png)</span></span>

<span data-ttu-id="0f30b-228">**图 13**：显示了所选供应商提供的产品（[单击以查看完全尺寸的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image39.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-228">**Figure 13**: The Products Provided by the Selected Supplier are Displayed ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image39.png))</span></span>

> [!NOTE]
> <span data-ttu-id="0f30b-229">添加此可编辑的 GridView 后，应该更新 `Suppliers` DropDownList s `SelectedIndexChanged` 事件处理程序，以使 GridView 返回到只读状态。</span><span class="sxs-lookup"><span data-stu-id="0f30b-229">With the addition of this editable GridView the `Suppliers` DropDownList s `SelectedIndexChanged` event handler should be updated to return the GridView to a read-only state.</span></span> <span data-ttu-id="0f30b-230">否则，如果在编辑产品信息的过程中选择了不同的供应商，则新供应商的 GridView 中对应的索引也可以编辑。</span><span class="sxs-lookup"><span data-stu-id="0f30b-230">Otherwise, if a different supplier is selected while in the middle of editing product information, the corresponding index in the GridView for the new supplier will also be editable.</span></span> <span data-ttu-id="0f30b-231">若要防止出现这种情况，只需在 `SelectedIndexChanged` 事件处理程序中将 GridView s `EditIndex` 属性设置为 `-1`。</span><span class="sxs-lookup"><span data-stu-id="0f30b-231">To prevent this, simply set the GridView s `EditIndex` property to `-1` in the `SelectedIndexChanged` event handler.</span></span>

<span data-ttu-id="0f30b-232">另外，请记住，必须启用 GridView 的视图状态（默认行为）。</span><span class="sxs-lookup"><span data-stu-id="0f30b-232">Also, recall that it is important that the GridView s view state be enabled (the default behavior).</span></span> <span data-ttu-id="0f30b-233">如果将 GridView `EnableViewState` 属性设置为 "`false`"，则可能会遇到使并发用户无意中删除或编辑记录的风险。</span><span class="sxs-lookup"><span data-stu-id="0f30b-233">If you set the GridView s `EnableViewState` property to `false`, you run the risk of having concurrent users unintentionally deleting or editing records.</span></span> <span data-ttu-id="0f30b-234">有关详细信息，请参阅[ASP.NET 2.0 GridViews/DetailsView/FormViews 的并发问题，其中支持编辑和/或删除并禁用了其视图状态](http://scottonwriting.net/sowblog/posts/10054.aspx)。</span><span class="sxs-lookup"><span data-stu-id="0f30b-234">See [WARNING: Concurrency Issue with ASP.NET 2.0 GridViews/DetailsView/FormViews that Support Editing and/or Deleting and Whose View State is Disabled](http://scottonwriting.net/sowblog/posts/10054.aspx) for more information.</span></span>

## <a name="step-5-disallow-editing-for-discontinued-products-when-showedit-all-suppliers-is-not-selected"></a><span data-ttu-id="0f30b-235">步骤5：不选择 "显示/编辑所有供应商" 时不允许编辑已停用的产品</span><span class="sxs-lookup"><span data-stu-id="0f30b-235">Step 5: Disallow Editing for Discontinued Products When Show/Edit ALL Suppliers is Not Selected</span></span>

<span data-ttu-id="0f30b-236">尽管 `ProductsBySupplier` GridView 完全正常运行，但它目前对来自特定供应商的用户授予过多的访问权限。</span><span class="sxs-lookup"><span data-stu-id="0f30b-236">While the `ProductsBySupplier` GridView is fully functional, it currently grants too much access to those users who are from a particular supplier.</span></span> <span data-ttu-id="0f30b-237">根据我们的业务规则，此类用户应该不能更新废止的产品。</span><span class="sxs-lookup"><span data-stu-id="0f30b-237">Per our business rules, such users should not be able to update discontinued products.</span></span> <span data-ttu-id="0f30b-238">若要强制执行此方法，可以在用户从供应商处访问该页面时，隐藏（或禁用）这些 GridView 行中的 "编辑" 按钮。</span><span class="sxs-lookup"><span data-stu-id="0f30b-238">To enforce this, we can hide (or disable) the Edit button in those GridView rows with discontinued products when the page is being visited by a user from a supplier.</span></span>

<span data-ttu-id="0f30b-239">为 GridView `RowDataBound` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="0f30b-239">Create an event handler for the GridView s `RowDataBound` event.</span></span> <span data-ttu-id="0f30b-240">在此事件处理程序中，我们需要确定用户是否与特定的供应商相关联，在本教程中，可以通过检查供应商 DropDownList s `SelectedValue` 属性来确定该用户是否已与该供应商相关联，如果它不是-1，则用户与特定的供应商相关联。</span><span class="sxs-lookup"><span data-stu-id="0f30b-240">In this event handler we need to determine whether or not the user is associated with a particular supplier, which, for this tutorial, can be determined by checking the Suppliers DropDownList s `SelectedValue` property - if it s something other than -1, then the user is associated with a particular supplier.</span></span> <span data-ttu-id="0f30b-241">对于此类用户，我们需要确定产品是否已停止使用。</span><span class="sxs-lookup"><span data-stu-id="0f30b-241">For such users, we then need to determine whether or not the product is discontinued.</span></span> <span data-ttu-id="0f30b-242">我们可以通过 `e.Row.DataItem` 属性获取对绑定到 GridView 行的实际 `ProductRow` 实例的引用，如在[ *"GridView" 页脚教程中显示摘要信息*](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md)中所述。</span><span class="sxs-lookup"><span data-stu-id="0f30b-242">We can grab a reference to the actual `ProductRow` instance bound to the GridView row via the `e.Row.DataItem` property, as discussed in the [*Displaying Summary Information in the GridView s Footer*](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md) tutorial.</span></span> <span data-ttu-id="0f30b-243">如果产品已停止使用，我们可以使用上一教程中所述的技术，使用上一教程中所述的技术[ *，在 GridView*](adding-client-side-confirmation-when-deleting-cs.md)s CommandField 中获取对 "编辑" 按钮的编程参考。</span><span class="sxs-lookup"><span data-stu-id="0f30b-243">If the product is discontinued, we can grab a programmatic reference to the Edit button in the GridView s CommandField using the techniques discussed in the previous tutorial, [*Adding Client-Side Confirmation When Deleting*](adding-client-side-confirmation-when-deleting-cs.md).</span></span> <span data-ttu-id="0f30b-244">获得引用后，可以隐藏或禁用该按钮。</span><span class="sxs-lookup"><span data-stu-id="0f30b-244">Once we have a reference we can then hide or disable the button.</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample6.cs)]

<span data-ttu-id="0f30b-245">使用此事件处理程序时，如果以用户身份从特定供应商处访问此页，则不能编辑这些产品，因为对这些产品隐藏 "编辑" 按钮。</span><span class="sxs-lookup"><span data-stu-id="0f30b-245">With this event handler in place, when visiting this page as a user from a specific supplier those products that are discontinued are not editable, as the Edit button is hidden for these products.</span></span> <span data-ttu-id="0f30b-246">例如，Chef Anton s Gumbo Mix 是新奥尔良 Cajun 乐趣供应商停产的产品。</span><span class="sxs-lookup"><span data-stu-id="0f30b-246">For example, Chef Anton s Gumbo Mix is a discontinued product for the New Orleans Cajun Delights supplier.</span></span> <span data-ttu-id="0f30b-247">在访问此特定供应商的页面时，将隐藏该产品的 "编辑" 按钮（见图14）。</span><span class="sxs-lookup"><span data-stu-id="0f30b-247">When visiting the page for this particular supplier, the Edit button for this product is hidden from sight (see Figure 14).</span></span> <span data-ttu-id="0f30b-248">但是，当使用 "显示/编辑所有供应商" 进行访问时，可以使用 "编辑" 按钮（见图15）。</span><span class="sxs-lookup"><span data-stu-id="0f30b-248">However, when visiting using the "Show/Edit ALL Suppliers," the Edit button is available (see Figure 15).</span></span>

<span data-ttu-id="0f30b-249">[![对于特定于供应商的用户，将隐藏 Chef Anton s Gumbo 混合的 "编辑" 按钮](limiting-data-modification-functionality-based-on-the-user-cs/_static/image41.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-249">[![For Supplier-Specific Users the Edit Button for Chef Anton s Gumbo Mix is Hidden](limiting-data-modification-functionality-based-on-the-user-cs/_static/image41.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image40.png)</span></span>

<span data-ttu-id="0f30b-250">**图 14**：对于特定于供应商的用户，Chef Anton s Gumbo Mix 的 "编辑" 按钮已隐藏（[单击查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image42.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-250">**Figure 14**: For Supplier-Specific Users the Edit Button for Chef Anton s Gumbo Mix is Hidden ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image42.png))</span></span>

<span data-ttu-id="0f30b-251">[![显示/编辑所有供应商用户，则显示 Chef Anton s Gumbo 混合的 "编辑" 按钮](limiting-data-modification-functionality-based-on-the-user-cs/_static/image44.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="0f30b-251">[![For Show/Edit ALL Suppliers Users, the Edit Button for Chef Anton s Gumbo Mix is Displayed](limiting-data-modification-functionality-based-on-the-user-cs/_static/image44.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image43.png)</span></span>

<span data-ttu-id="0f30b-252">**图 15**：对于 "显示/编辑所有供应商用户"，将显示 "Chef Anton s Gumbo 混合" 编辑按钮（[单击以查看完全大小的图像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image45.png)）</span><span class="sxs-lookup"><span data-stu-id="0f30b-252">**Figure 15**: For Show/Edit ALL Suppliers Users, the Edit Button for Chef Anton s Gumbo Mix is Displayed ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image45.png))</span></span>

## <a name="checking-for-access-rights-in-the-business-logic-layer"></a><span data-ttu-id="0f30b-253">检查业务逻辑层中的访问权限</span><span class="sxs-lookup"><span data-stu-id="0f30b-253">Checking for Access Rights in the Business Logic Layer</span></span>

<span data-ttu-id="0f30b-254">在本教程中，"ASP.NET" 页处理有关用户可以查看的信息以及可更新的产品的所有逻辑。</span><span class="sxs-lookup"><span data-stu-id="0f30b-254">In this tutorial the ASP.NET page handles all logic with regards to what information the user can see and what products he can update.</span></span> <span data-ttu-id="0f30b-255">理想情况下，此逻辑也会出现在业务逻辑层中。</span><span class="sxs-lookup"><span data-stu-id="0f30b-255">Ideally, this logic would also be present at the Business Logic Layer.</span></span> <span data-ttu-id="0f30b-256">例如，`SuppliersBLL` 类 `GetSuppliers()` 方法（返回所有供应商）可能包含检查以确保当前登录的用户*不*与特定的供应商相关联。</span><span class="sxs-lookup"><span data-stu-id="0f30b-256">For example, the `SuppliersBLL` class s `GetSuppliers()` method (which returns all suppliers) might include a check to ensure that the currently logged on user is *not* associated with a specific supplier.</span></span> <span data-ttu-id="0f30b-257">同样，`UpdateSupplierAddress` 方法可能包括检查以确保当前登录的用户适用于我们的公司（因此可以更新所有供应商地址信息）或与要更新其数据的供应商相关联。</span><span class="sxs-lookup"><span data-stu-id="0f30b-257">Likewise, the `UpdateSupplierAddress` method could include a check to ensure that the currently logged on user either worked for our company (and therefore can update all suppliers address information) or is associated with the supplier whose data is being updated.</span></span>

<span data-ttu-id="0f30b-258">我在本教程中并未包括此类 BLL 层检查，因为在本教程中，用户的权限由 DropDownList 上的一个非层次，而 BLL 类无法访问。</span><span class="sxs-lookup"><span data-stu-id="0f30b-258">I did not include such BLL-layer checks here because in our tutorial the user s rights are determined by a DropDownList on the page, which the BLL classes cannot access.</span></span> <span data-ttu-id="0f30b-259">当使用 ASP.NET （如 Windows 身份验证）提供的成员资格系统或现成的身份验证方案之一时，可以从 BLL 访问当前登录的用户的信息和角色信息，从而进行此类访问可在表示层和 BLL 层上检查权限。</span><span class="sxs-lookup"><span data-stu-id="0f30b-259">When using the membership system or one of the out-of-the box authentication schemes provided by ASP.NET (such as Windows authentication), the currently logged on user s information and roles information can be accessed from the BLL, thereby making such access rights checks possible at both the presentation and BLL layers.</span></span>

## <a name="summary"></a><span data-ttu-id="0f30b-260">总结</span><span class="sxs-lookup"><span data-stu-id="0f30b-260">Summary</span></span>

<span data-ttu-id="0f30b-261">大多数提供用户帐户的站点都需要基于登录用户自定义数据修改接口。</span><span class="sxs-lookup"><span data-stu-id="0f30b-261">Most sites that provide user accounts need to customize the data modification interface based upon the logged in user.</span></span> <span data-ttu-id="0f30b-262">管理用户可以删除和编辑任何记录，而非管理用户可能被限制为仅更新或删除他们自行创建的记录。</span><span class="sxs-lookup"><span data-stu-id="0f30b-262">Administrative users may be able to delete and edit any record, whereas non-administrative users may be limited to only updating or deleting records they created themselves.</span></span> <span data-ttu-id="0f30b-263">无论方案是哪种情况，都可以通过扩展数据 Web 控件、ObjectDataSource 和业务逻辑层类来添加或拒绝基于登录用户的某些功能。</span><span class="sxs-lookup"><span data-stu-id="0f30b-263">Whatever the scenario may be, the data Web controls, ObjectDataSource, and Business Logic Layer classes can be extended to add or deny certain functionality based on the logged on user.</span></span> <span data-ttu-id="0f30b-264">在本教程中，我们了解了如何根据用户是否与特定的供应商相关联，或是否为公司工作，来限制可查看和可编辑的数据。</span><span class="sxs-lookup"><span data-stu-id="0f30b-264">In this tutorial we saw how to limit the viewable and editable data depending on whether the user was associated with a particular supplier or if they worked for our company.</span></span>

<span data-ttu-id="0f30b-265">本教程介绍了如何使用 GridView、DetailsView 和 FormView 控件来插入、更新和删除数据。</span><span class="sxs-lookup"><span data-stu-id="0f30b-265">This tutorial concludes our examination of inserting, updating, and deleting data using the GridView, DetailsView, and FormView controls.</span></span> <span data-ttu-id="0f30b-266">从下一教程开始，我们将重点介绍如何添加分页和排序支持。</span><span class="sxs-lookup"><span data-stu-id="0f30b-266">Starting with the next tutorial, we'll turn our attention to adding paging and sorting support.</span></span>

<span data-ttu-id="0f30b-267">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="0f30b-267">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="0f30b-268">关于作者</span><span class="sxs-lookup"><span data-stu-id="0f30b-268">About the Author</span></span>

<span data-ttu-id="0f30b-269">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已在使用 Microsoft Web 技术，自1998开始。</span><span class="sxs-lookup"><span data-stu-id="0f30b-269">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="0f30b-270">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="0f30b-270">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="0f30b-271">他的最新书籍是，[*在24小时内，sam ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="0f30b-271">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="0f30b-272">可以[mitchell@4GuysFromRolla.com访问。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="0f30b-272">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="0f30b-273">或通过他的博客，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="0f30b-273">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="0f30b-274">[上一页](adding-client-side-confirmation-when-deleting-cs.md)
> [下一页](an-overview-of-inserting-updating-and-deleting-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="0f30b-274">[Previous](adding-client-side-confirmation-when-deleting-cs.md)
[Next](an-overview-of-inserting-updating-and-deleting-data-vb.md)</span></span>
