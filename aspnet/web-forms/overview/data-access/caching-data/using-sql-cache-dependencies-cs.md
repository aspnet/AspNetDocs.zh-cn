---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
title: 使用 SQL 缓存依赖项 (C#) |Microsoft Docs
author: rick-anderson
description: 最简单的缓存策略是时间的允许缓存的数据在指定段后过期。 但是，此简单的方法意味着，缓存的数据 maintai...
ms.author: riande
ms.date: 05/30/2007
ms.assetid: 0e91842c-7f10-4aed-8c23-4ee3e2774014
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
msc.type: authoredcontent
ms.openlocfilehash: e70a21e2752c7c8fc8be332a98e1cf7e40b01412
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/17/2019
ms.locfileid: "59417684"
---
# <a name="using-sql-cache-dependencies-c"></a><span data-ttu-id="bc7fc-104">使用 SQL 缓存依赖项 (C#)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-104">Using SQL Cache Dependencies (C#)</span></span>

<span data-ttu-id="bc7fc-105">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="bc7fc-106">[下载代码](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip)或[下载 PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) or [Download PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span></span>

> <span data-ttu-id="bc7fc-107">最简单的缓存策略是时间的允许缓存的数据在指定段后过期。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-107">The simplest caching strategy is to allow cached data to expire after a specified period of time.</span></span> <span data-ttu-id="bc7fc-108">但此简单的方法意味着，则缓存的数据会保留对其基础的数据源，从而导致保存太长的陈旧数据或太即将过期的最新数据没有关联。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-108">But this simple approach means that the cached data maintains no association with its underlying data source, resulting in stale data that is held too long or current data that is expired too soon.</span></span> <span data-ttu-id="bc7fc-109">更好的方法是使用 SqlCacheDependency 类，以便数据保持缓存，直到其基础数据已修改的 SQL 数据库中。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-109">A better approach is to use the SqlCacheDependency class so that data remains cached until its underlying data has been modified in the SQL database.</span></span> <span data-ttu-id="bc7fc-110">本教程演示如何。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-110">This tutorial shows you how.</span></span>


## <a name="introduction"></a><span data-ttu-id="bc7fc-111">介绍</span><span class="sxs-lookup"><span data-stu-id="bc7fc-111">Introduction</span></span>

<span data-ttu-id="bc7fc-112">在中检查的缓存技术[使用 ObjectDataSource 缓存数据](caching-data-with-the-objectdatasource-cs.md)并[体系结构中缓存数据](caching-data-in-the-architecture-cs.md)教程使用基于时间的到期后指定逐出缓存中的数据时间段。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-112">The caching techniques examined in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) and [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorials used a time-based expiry to evict the data from the cache after a specified period.</span></span> <span data-ttu-id="bc7fc-113">这种方法是最简单的方法来平衡的数据失效针对缓存的性能提升。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-113">This approach is the simplest way to balance the performance gains of caching against data staleness.</span></span> <span data-ttu-id="bc7fc-114">通过选择的时间到期*x*秒，页面开发人员 concedes 享受仅缓存的性能优势*x*秒，但可以高枕无忧，她的数据永远不会将过时时间超过最大值*x*秒。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-114">By selecting a time expiry of *x* seconds, a page developer concedes to enjoy the performance benefits of caching for only *x* seconds, but can rest easy that her data will never be stale longer than a maximum of *x* seconds.</span></span> <span data-ttu-id="bc7fc-115">当然，对于静态数据， *x*中检查已作为可以扩展到 web 应用程序的生存期[在应用程序启动时缓存数据](caching-data-at-application-startup-cs.md)教程。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-115">Of course, for static data, *x* can be extended to the lifetime of the web application, as was examined in the [Caching Data at Application Startup](caching-data-at-application-startup-cs.md) tutorial.</span></span>

<span data-ttu-id="bc7fc-116">当缓存数据库数据，基于时间的到期选择通常其易于使用，但通常是不能满足需要的解决方案。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-116">When caching database data, a time-based expiry is often chosen for its ease of use but is frequently an inadequate solution.</span></span> <span data-ttu-id="bc7fc-117">理想情况下，数据库中，数据将保留缓存之前已在数据库中，在修改基础数据然后仅将逐出缓存。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-117">Ideally, the database data would remain cached until the underlying data has been modified in the database; only then would the cache be evicted.</span></span> <span data-ttu-id="bc7fc-118">这种方法最大缓存的性能优势，并最大程度减少过时的数据的持续时间。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-118">This approach maximizes the performance benefits of caching and minimizes the duration of stale data.</span></span> <span data-ttu-id="bc7fc-119">但是，为了享受这些权益有必须知道当基础数据库数据已被修改，逐出缓存中的相应项的位置中的某些系统。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-119">However, in order to enjoy these benefits there must be some system in place that knows when the underlying database data has been modified and evicts the corresponding items from the cache.</span></span> <span data-ttu-id="bc7fc-120">在 ASP.NET 2.0 之前页面开发人员是负责实现此系统。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-120">Prior to ASP.NET 2.0, page developers were responsible for implementing this system.</span></span>

<span data-ttu-id="bc7fc-121">ASP.NET 2.0 提供了[`SqlCacheDependency`类](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx)和必要的基础结构以确定何时发生了更改数据库中，以便相应缓存项可以被逐出。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-121">ASP.NET 2.0 provides a [`SqlCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) and the necessary infrastructure to determine when a change has occurred in the database so that the corresponding cached items can be evicted.</span></span> <span data-ttu-id="bc7fc-122">有两种技术用于确定基础数据已更改时： 通知和轮询。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-122">There are two techniques for determining when the underlying data has changed: notification and polling.</span></span> <span data-ttu-id="bc7fc-123">在讨论后通知和轮询之间的差异，我们将创建基础结构支持轮询，然后探讨如何使用所需`SqlCacheDependency`类中声明性和以编程方式方案。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-123">After discussing the differences between notification and polling, we'll create the infrastructure necessary to support polling and then explore how to use the `SqlCacheDependency` class in declarative and programmatically scenarios.</span></span>

## <a name="understanding-notification-and-polling"></a><span data-ttu-id="bc7fc-124">了解通知和轮询</span><span class="sxs-lookup"><span data-stu-id="bc7fc-124">Understanding Notification and Polling</span></span>

<span data-ttu-id="bc7fc-125">有两种技术可以用于确定数据库中的数据修改时： 通知和轮询。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-125">There are two techniques that can be used to determine when the data in a database has been modified: notification and polling.</span></span> <span data-ttu-id="bc7fc-126">通知，当自上次执行该查询以来已更改的特定查询的结果时数据库的自动警报 ASP.NET 运行时，逐出的哪个点与查询关联的缓存的项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-126">With notification, the database automatically alerts the ASP.NET runtime when the results of a particular query have been changed since the query was last executed, at which point the cached items associated with the query are evicted.</span></span> <span data-ttu-id="bc7fc-127">通过轮询，数据库服务器服务维护有关上次更新时间特定的表的信息。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-127">With polling, the database server maintains information about when particular tables have last been updated.</span></span> <span data-ttu-id="bc7fc-128">ASP.NET 运行时定期轮询数据库以检查表已发生的更改因为它们已输入到缓存。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-128">The ASP.NET runtime periodically polls the database to check what tables have changed since they were entered into the cache.</span></span> <span data-ttu-id="bc7fc-129">这些修改其数据的表具有逐出及其关联的缓存项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-129">Those tables whose data has been modified have their associated cache items evicted.</span></span>

<span data-ttu-id="bc7fc-130">通知选项需要较少的设置比轮询和是更精细，因为它跟踪的更改在查询级别而不是在表级别。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-130">The notification option requires less setup than polling and is more granular since it tracks changes at the query level rather than at the table level.</span></span> <span data-ttu-id="bc7fc-131">遗憾的是，通知只是 Microsoft SQL Server 2005 （即，非速成版） 的完整版本中提供的。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-131">Unfortunately, notifications are only available in the full editions of Microsoft SQL Server 2005 (i.e., the non-Express editions).</span></span> <span data-ttu-id="bc7fc-132">但是，轮询选项可用于从 7.0 的 Microsoft SQL Server 2005 的所有版本。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-132">However, the polling option can be used for all versions of Microsoft SQL Server from 7.0 to 2005.</span></span> <span data-ttu-id="bc7fc-133">由于这些教程使用的 SQL Server 2005 Express edition，我们将重点设置和使用轮询选项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-133">Since these tutorials use the Express edition of SQL Server 2005, we will focus on setting up and using the polling option.</span></span> <span data-ttu-id="bc7fc-134">请进一步阅读部分查阅本教程，了解更多 SQL Server 2005 的通知功能的资源的末尾。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-134">Consult the Further Reading section at the end of this tutorial for further resources on SQL Server 2005 s notification capabilities.</span></span>

<span data-ttu-id="bc7fc-135">使用轮询，必须配置数据库包含名为的表`AspNet_SqlCacheTablesForChangeNotification`具有三列- `tableName`， `notificationCreated`，和`changeId`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-135">With polling, the database must be configured to include a table named `AspNet_SqlCacheTablesForChangeNotification` that has three columns - `tableName`, `notificationCreated`, and `changeId`.</span></span> <span data-ttu-id="bc7fc-136">此表包含每个表都有可能需要在 web 应用程序中的 SQL 缓存依赖项中使用的数据行。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-136">This table contains a row for each table that has data that might need to be used in a SQL cache dependency in the web application.</span></span> <span data-ttu-id="bc7fc-137">`tableName`列指定时，表的名称`notificationCreated`指示的日期和时间向表添加行。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-137">The `tableName` column specifies the name of the table while `notificationCreated` indicates the date and time the row was added to the table.</span></span> <span data-ttu-id="bc7fc-138">`changeId`列的类型是`int`和初始值为 0。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-138">The `changeId` column is of type `int` and has an initial value of 0.</span></span> <span data-ttu-id="bc7fc-139">其值会递增与每次修改的表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-139">Its value is incremented with each modification to the table.</span></span>

<span data-ttu-id="bc7fc-140">除了`AspNet_SqlCacheTablesForChangeNotification`表，需要将数据库还在 SQL 缓存依赖项中包含每个可能出现的表上的触发器。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-140">In addition to the `AspNet_SqlCacheTablesForChangeNotification` table, the database also needs to include triggers on each of the tables that may appear in a SQL cache dependency.</span></span> <span data-ttu-id="bc7fc-141">这些触发器时插入、 更新或删除某行执行，并递增表 s`changeId`中的值`AspNet_SqlCacheTablesForChangeNotification`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-141">These triggers are executed whenever a row is inserted, updated, or deleted and increment the table s `changeId` value in `AspNet_SqlCacheTablesForChangeNotification`.</span></span>

<span data-ttu-id="bc7fc-142">ASP.NET 运行时跟踪当前`changeId`表时缓存数据使用`SqlCacheDependency`对象。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-142">The ASP.NET runtime tracks the current `changeId` for a table when caching data using a `SqlCacheDependency` object.</span></span> <span data-ttu-id="bc7fc-143">定期检查该数据库和任何`SqlCacheDependency`对象的`changeId`不同于数据库中的值不同以来逐出`changeId`值指示发生了对表的更改被缓存数据后。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-143">The database is periodically checked and any `SqlCacheDependency` objects whose `changeId` differs from the value in the database are evicted since a differing `changeId` value indicates that there has been a change to the table since the data was cached.</span></span>

## <a name="step-1-exploring-theaspnetregsqlexecommand-line-program"></a><span data-ttu-id="bc7fc-144">步骤 1：探索`aspnet_regsql.exe`命令行程序</span><span class="sxs-lookup"><span data-stu-id="bc7fc-144">Step 1: Exploring the`aspnet_regsql.exe`Command Line Program</span></span>

<span data-ttu-id="bc7fc-145">使用轮询方法时，数据库必须安装程序以包含上面所述的基础结构： 预定义的表 (`AspNet_SqlCacheTablesForChangeNotification`)，少量的存储的过程和触发器在每个可在 web 中的 SQL 缓存依赖项表应用程序。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-145">With the polling approach the database must be setup to contain the infrastructure described above: a predefined table (`AspNet_SqlCacheTablesForChangeNotification`), a handful of stored procedures, and triggers on each of the tables that may be used in SQL cache dependencies in the web application.</span></span> <span data-ttu-id="bc7fc-146">可以通过命令行程序创建这些表、 存储的过程和触发器`aspnet_regsql.exe`，它出现在`$WINDOWS$\Microsoft.NET\Framework\version`文件夹。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-146">These tables, stored procedures, and triggers can be created through the command line program `aspnet_regsql.exe`, which is found in the `$WINDOWS$\Microsoft.NET\Framework\version` folder.</span></span> <span data-ttu-id="bc7fc-147">若要创建`AspNet_SqlCacheTablesForChangeNotification`表和关联的存储的过程，从命令行运行以下命令：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-147">To create the `AspNet_SqlCacheTablesForChangeNotification` table and associated stored procedures, run the following from the command line:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="bc7fc-148">若要执行的指定的数据库登录名必须在这些命令[ `db_securityadmin` ](https://msdn.microsoft.com/library/ms188685.aspx)并[ `db_ddladmin` ](https://msdn.microsoft.com/library/ms190667.aspx)角色。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-148">To execute these commands the specified database login must be in the [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) and [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) roles.</span></span> <span data-ttu-id="bc7fc-149">若要检查发送到的数据库 T-SQL`aspnet_regsql.exe`命令行程序，请参阅[此博客文章](http://scottonwriting.net/sowblog/posts/10709.aspx)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-149">To examine the T-SQL sent to the database by the `aspnet_regsql.exe` command line program, refer to [this blog entry](http://scottonwriting.net/sowblog/posts/10709.aspx).</span></span>


<span data-ttu-id="bc7fc-150">例如，若要将轮询的基础结构添加到 Microsoft SQL Server 数据库名为`pubs`名为数据库服务器上`ScottsServer`使用 Windows 身份验证，导航到相应的目录并，请从命令行中，输入：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-150">For example, to add the infrastructure for polling to a Microsoft SQL Server database named `pubs` on a database server named `ScottsServer` using Windows Authentication, navigate to the appropriate directory and, from the command line, enter:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample2.cmd)]

<span data-ttu-id="bc7fc-151">添加数据库级别基础结构后，我们需要将触发器添加到将 SQL 缓存依赖项中使用这些表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-151">After the database-level infrastructure has been added, we need to add the triggers to those tables that will be used in SQL cache dependencies.</span></span> <span data-ttu-id="bc7fc-152">使用`aspnet_regsql.exe`命令行程序，但指定表名称使用`-t`切换，而不是使用`-ed`切换使用`-et`，如下所示：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-152">Use the `aspnet_regsql.exe` command line program again, but specify the table name using the `-t` switch and instead of using the `-ed` switch use `-et`, like so:</span></span>


[!code-html[Main](using-sql-cache-dependencies-cs/samples/sample3.html)]

<span data-ttu-id="bc7fc-153">若要添加到触发器`authors`并`titles`表上`pubs`上的数据库`ScottsServer`，使用：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-153">To add the triggers to the `authors` and `titles` tables on the `pubs` database on `ScottsServer`, use:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample4.cmd)]

<span data-ttu-id="bc7fc-154">本教程将添加到触发器`Products`， `Categories`，和`Suppliers`表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-154">For this tutorial add the triggers to the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="bc7fc-155">我们将介绍在步骤 3 中的特定命令行语法。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-155">We'll look at the particular command line syntax in Step 3.</span></span>

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inappdata"></a><span data-ttu-id="bc7fc-156">步骤 2：引用中的 Microsoft SQL Server 2005 Express Edition 数据库`App_Data`</span><span class="sxs-lookup"><span data-stu-id="bc7fc-156">Step 2: Referencing a Microsoft SQL Server 2005 Express Edition Database in`App_Data`</span></span>

<span data-ttu-id="bc7fc-157">`aspnet_regsql.exe`命令行程序需要数据库和服务器名称才能添加必要的轮询基础结构。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-157">The `aspnet_regsql.exe` command line program requires the database and server name in order to add the necessary polling infrastructure.</span></span> <span data-ttu-id="bc7fc-158">什么是 Microsoft SQL Server 2005 Express 数据库中驻留的数据库和服务器名称，但`App_Data`文件夹？</span><span class="sxs-lookup"><span data-stu-id="bc7fc-158">But what is the database and server name for a Microsoft SQL Server 2005 Express database that resides in the `App_Data` folder?</span></span> <span data-ttu-id="bc7fc-159">而不是无需发现的数据库和服务器名称是什么，我已找到的最简单方法是将附加到的数据库`localhost\SQLExpress`数据库实例和数据使用重命名[SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-159">Rather than having to discover what the database and server names are, I ve found that the simplest approach is to attach the database to the `localhost\SQLExpress` database instance and rename the data using [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span></span> <span data-ttu-id="bc7fc-160">如果必须在计算机上安装 SQL Server 2005 的完整版本之一，然后您可能已经在计算机上安装 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-160">If you have one of the full versions of SQL Server 2005 installed on your machine, then you likely already have SQL Server Management Studio installed on your computer.</span></span> <span data-ttu-id="bc7fc-161">如果您只有 Express edition，则可以下载免费[Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-161">If you only have the Express edition, you can download the free [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="bc7fc-162">首先关闭 Visual Studio。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-162">Start by closing Visual Studio.</span></span> <span data-ttu-id="bc7fc-163">接下来，打开 SQL Server Management Studio，然后选择要连接到`localhost\SQLExpress`使用 Windows 身份验证服务器。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-163">Next, open SQL Server Management Studio and choose to connect to the `localhost\SQLExpress` server using Windows Authentication.</span></span>


![将附加到 localhost\SQLExpress 服务器](using-sql-cache-dependencies-cs/_static/image1.gif)

<span data-ttu-id="bc7fc-165">**图 1**:将附加到`localhost\SQLExpress`服务器</span><span class="sxs-lookup"><span data-stu-id="bc7fc-165">**Figure 1**: Attach to the `localhost\SQLExpress` Server</span></span>


<span data-ttu-id="bc7fc-166">Management Studio 连接到服务器后，会显示服务器并可能对数据库、 安全性和等的子文件夹。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-166">After connecting to the server, Management Studio will show the server and have subfolders for the databases, security, and so forth.</span></span> <span data-ttu-id="bc7fc-167">右键单击数据库文件夹并选择附加选项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-167">Right-click on the Databases folder and choose the Attach option.</span></span> <span data-ttu-id="bc7fc-168">这将显示附加数据库对话框 （请参见图 2）。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-168">This will bring up the Attach Databases dialog box (see Figure 2).</span></span> <span data-ttu-id="bc7fc-169">单击添加按钮，然后选择`NORTHWND.MDF`database 文件夹中您的 web 应用程序 s`App_Data`文件夹。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-169">Click the Add button and select the `NORTHWND.MDF` database folder in your web application s `App_Data` folder.</span></span>


<span data-ttu-id="bc7fc-170">[![将附加 northwnd 不。MDF App_Data 文件夹中的数据库](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-170">[![Attach the NORTHWND.MDF Database from the App_Data Folder](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span></span>

<span data-ttu-id="bc7fc-171">**图 2**:附加`NORTHWND.MDF`数据库从`App_Data`文件夹 ([单击以查看实际尺寸的图像](using-sql-cache-dependencies-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-171">**Figure 2**: Attach the `NORTHWND.MDF` Database from the `App_Data` Folder ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image2.png))</span></span>


<span data-ttu-id="bc7fc-172">这会将数据库添加到数据库文件夹中。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-172">This will add the database to the Databases folder.</span></span> <span data-ttu-id="bc7fc-173">数据库名称可能是数据库文件的完整路径或完整路径前面带有[GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-173">The database name might be the full path to the database file or the full path prepended with a [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span></span> <span data-ttu-id="bc7fc-174">若要避免无需使用 aspnet 时此长时间的数据库名称键入\_regsql.exe 命令行工具，附加到更加用户友好名称只是在数据库上右键单击该数据库重命名并选择重命名。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-174">To avoid having to type in this lengthy database name when using the aspnet\_regsql.exe command line tool, rename the database to a more human-friendly name by right-clicking on database just attached and choosing Rename.</span></span> <span data-ttu-id="bc7fc-175">我已重命名为 DataTutorials 的我的数据库。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-175">I ve renamed my database to DataTutorials .</span></span>


![附加的数据库重命名为更多的用户友好名称](using-sql-cache-dependencies-cs/_static/image3.gif)

<span data-ttu-id="bc7fc-177">**图 3**:附加的数据库重命名为更多的用户友好名称</span><span class="sxs-lookup"><span data-stu-id="bc7fc-177">**Figure 3**: Rename the Attached Database to a More Human-Friendly Name</span></span>


## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a><span data-ttu-id="bc7fc-178">步骤 3：将轮询基础结构添加到 Northwind 数据库</span><span class="sxs-lookup"><span data-stu-id="bc7fc-178">Step 3: Adding the Polling Infrastructure to the Northwind Database</span></span>

<span data-ttu-id="bc7fc-179">现在，我们已附加`NORTHWND.MDF`数据库从`App_Data`文件夹中，我们准备就绪后，若要添加的轮询基础结构。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-179">Now that we have attached the `NORTHWND.MDF` database from the `App_Data` folder, we re ready to add the polling infrastructure.</span></span> <span data-ttu-id="bc7fc-180">假设你已重命名为 DataTutorials 的数据库，运行以下四个命令：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-180">Assuming that you ve renamed the database to DataTutorials, run the following four commands:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample5.cmd)]

<span data-ttu-id="bc7fc-181">后运行以下四个命令，右键单击 Management Studio 中的数据库名称，转到任务子菜单，并选择分离。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-181">After running these four commands, right-click on the database name in Management Studio, go to the Tasks submenu, and choose Detach.</span></span> <span data-ttu-id="bc7fc-182">然后关闭 Management Studio 并重新打开 Visual Studio。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-182">Then close Management Studio and reopen Visual Studio.</span></span>

<span data-ttu-id="bc7fc-183">一旦已重新打开 Visual Studio，深入了解通过服务器资源管理器数据库。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-183">Once Visual Studio has reopened, drill into the database through the Server Explorer.</span></span> <span data-ttu-id="bc7fc-184">请注意新表 (`AspNet_SqlCacheTablesForChangeNotification`)，新存储过程和触发器上`Products`， `Categories`，和`Suppliers`表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-184">Note the new table (`AspNet_SqlCacheTablesForChangeNotification`), the new stored procedures, and the triggers on the `Products`, `Categories`, and `Suppliers` tables.</span></span>


![Database 现在包括必要的轮询基础结构](using-sql-cache-dependencies-cs/_static/image4.gif)

<span data-ttu-id="bc7fc-186">**图 4**:Database 现在包括必要的轮询基础结构</span><span class="sxs-lookup"><span data-stu-id="bc7fc-186">**Figure 4**: The Database Now Includes the Necessary Polling Infrastructure</span></span>


## <a name="step-4-configuring-the-polling-service"></a><span data-ttu-id="bc7fc-187">步骤 4：配置轮询服务</span><span class="sxs-lookup"><span data-stu-id="bc7fc-187">Step 4: Configuring the Polling Service</span></span>

<span data-ttu-id="bc7fc-188">在创建后所需的表、 触发器和存储的过程在数据库中，最后一步是配置轮询服务，通过完成`Web.config`通过指定以毫秒为单位的轮询频率和使用数据库。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-188">After creating the needed tables, triggers, and stored procedures in the database, the final step is to configure the polling service, which is done through `Web.config` by specifying the databases to use and the polling frequency in milliseconds.</span></span> <span data-ttu-id="bc7fc-189">以下标记将每隔一秒一次轮询 Northwind 数据库。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-189">The following markup polls the Northwind database once every second.</span></span>


[!code-xml[Main](using-sql-cache-dependencies-cs/samples/sample6.xml)]

<span data-ttu-id="bc7fc-190">`name`中的值`<add>`元素 (NorthwindDB) 将与特定数据库相关联的可读名称。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-190">The `name` value in the `<add>` element ( NorthwindDB ) associates a human-readable name with a particular database.</span></span> <span data-ttu-id="bc7fc-191">在使用 SQL 缓存依赖项，我们将需要引用基于缓存的数据的表以及在此处定义的数据库名称。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-191">When working with SQL cache dependencies, we'll need to refer to the database name defined here as well as the table that the cached data is based on.</span></span> <span data-ttu-id="bc7fc-192">我们将了解如何使用`SqlCacheDependency`类以编程方式将与 SQL 缓存依赖项相关联的缓存在步骤 6 中的数据。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-192">We'll see how to use the `SqlCacheDependency` class to programmatically associate SQL cache dependencies with cached data in Step 6.</span></span>

<span data-ttu-id="bc7fc-193">轮询系统建立 SQL 缓存依赖项之后，将连接到数据库中定义`<databases>`元素每`pollTime`毫秒并执行`AspNet_SqlCachePollingStoredProcedure`存储过程。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-193">Once a SQL cache dependency has been established, the polling system will connect to the databases defined in the `<databases>` elements every `pollTime` milliseconds and execute the `AspNet_SqlCachePollingStoredProcedure` stored procedure.</span></span> <span data-ttu-id="bc7fc-194">在步骤 3 中使用此存储的过程-已添加回`aspnet_regsql.exe`命令行工具-将返回`tableName`并`changeId`中的每个记录的值`AspNet_SqlCacheTablesForChangeNotification`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-194">This stored procedure - which was added back in Step 3 using the `aspnet_regsql.exe` command line tool - returns the `tableName` and `changeId` values for each record in `AspNet_SqlCacheTablesForChangeNotification`.</span></span> <span data-ttu-id="bc7fc-195">从缓存逐出过时的 SQL 缓存依赖项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-195">Outdated SQL cache dependencies are evicted from the cache.</span></span>

<span data-ttu-id="bc7fc-196">`pollTime`设置引入了性能和数据过期时间之间的权衡。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-196">The `pollTime` setting introduces a tradeoff between performance and data staleness.</span></span> <span data-ttu-id="bc7fc-197">一个较小`pollTime`值将会增大到的数据库的请求数，但更多快速逐出缓存中的陈旧数据。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-197">A small `pollTime` value increases the number of requests to the database, but more quickly evicts stale data from the cache.</span></span> <span data-ttu-id="bc7fc-198">更大`pollTime`值可减少数据库请求数，但会增加后端数据的更改时和时逐出的相关的缓存项之间的延迟。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-198">A larger `pollTime` value reduces the number of database requests, but increases the delay between when the backend data changes and when the related cache items are evicted.</span></span> <span data-ttu-id="bc7fc-199">幸运的，数据库请求正在执行的简单存储的过程从简单的轻型表返回只需几行的 s。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-199">Fortunately, the database request is executing a simple stored procedure that s returning just a few rows from a simple, lightweight table.</span></span> <span data-ttu-id="bc7fc-200">执行试验不同，但`pollTime`值理想之间找到平衡数据库应用程序的访问和数据过期。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-200">But do experiment with different `pollTime` values to find an ideal balance between database access and data staleness for your application.</span></span> <span data-ttu-id="bc7fc-201">最小`pollTime`允许值为 500。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-201">The smallest `pollTime` value allowed is 500.</span></span>

> [!NOTE]
> <span data-ttu-id="bc7fc-202">上面的示例中提供了单个`pollTime`中的值`<sqlCacheDependency>`元素，但是您可以选择指定`pollTime`中的值`<add>`元素。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-202">The above example provides a single `pollTime` value in the `<sqlCacheDependency>` element, but you can optionally specify the `pollTime` value in the `<add>` element.</span></span> <span data-ttu-id="bc7fc-203">如果你有多个指定的数据库，并想要自定义每个数据库的轮询频率，这非常有用。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-203">This is useful if you have multiple databases specified and want to customize the polling frequency per database.</span></span>


## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a><span data-ttu-id="bc7fc-204">步骤 5：以声明方式使用 SQL 缓存依赖项</span><span class="sxs-lookup"><span data-stu-id="bc7fc-204">Step 5: Declaratively Working with SQL Cache Dependencies</span></span>

<span data-ttu-id="bc7fc-205">在步骤 1 到 4 中我们介绍了如何设置必要的数据库基础结构和配置轮询系统。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-205">In Steps 1 through 4 we looked at how to setup the necessary database infrastructure and configure the polling system.</span></span> <span data-ttu-id="bc7fc-206">使用此基础结构，我们现在可以添加项目数据缓存有关联 SQL 缓存依赖项的使用以编程方式或声明性技术。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-206">With this infrastructure in place, we can now add items to the data cache with an associated SQL cache dependency using either programmatic or declarative techniques.</span></span> <span data-ttu-id="bc7fc-207">在此步骤中，我们将介绍如何以声明方式使用 SQL 缓存依赖项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-207">In this step we'll examine how to declaratively work with SQL cache dependencies.</span></span> <span data-ttu-id="bc7fc-208">在步骤 6 中，我们将介绍编程方法。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-208">In Step 6 we'll look at the programmatic approach.</span></span>

<span data-ttu-id="bc7fc-209">[使用 ObjectDataSource 缓存数据](caching-data-with-the-objectdatasource-cs.md)教程探讨了 ObjectDataSource 的声明性缓存功能。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-209">The [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial explored the declarative caching capabilities of the ObjectDataSource.</span></span> <span data-ttu-id="bc7fc-210">通过轻松`EnableCaching`属性设置为`true`和`CacheDuration`属性设置为某个时间间隔，ObjectDataSource 自动将缓存从其基础对象返回指定间隔内的数据。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-210">By simply setting the `EnableCaching` property to `true` and the `CacheDuration` property to some time interval, the ObjectDataSource will automatically cache the data returned from its underlying object for the specified interval.</span></span> <span data-ttu-id="bc7fc-211">ObjectDataSource 还可以使用一个或多个 SQL 缓存依赖项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-211">The ObjectDataSource can also use one or more SQL cache dependencies.</span></span>

<span data-ttu-id="bc7fc-212">若要演示如何以声明方式使用 SQL 缓存依赖项，打开`SqlCacheDependencies.aspx`页中`Caching`文件夹，然后拖动 GridView 从工具箱拖到设计器。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-212">To demonstrate using SQL cache dependencies declaratively, open the `SqlCacheDependencies.aspx` page in the `Caching` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="bc7fc-213">设置 GridView s`ID`到`ProductsDeclarative`，并从其智能标记，选择要绑定到名为新 ObjectDataSource `ProductsDataSourceDeclarative`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-213">Set the GridView s `ID` to `ProductsDeclarative` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSourceDeclarative`.</span></span>


<span data-ttu-id="bc7fc-214">[![创建名为 ProductsDataSourceDeclarative 新 ObjectDataSource](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-214">[![Create a New ObjectDataSource Named ProductsDataSourceDeclarative](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span></span>

<span data-ttu-id="bc7fc-215">**图 5**:创建新对象数据源命名`ProductsDataSourceDeclarative`([单击以查看实际尺寸的图像](using-sql-cache-dependencies-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-215">**Figure 5**: Create a New ObjectDataSource Named `ProductsDataSourceDeclarative` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image4.png))</span></span>


<span data-ttu-id="bc7fc-216">配置要使用 ObjectDataSource`ProductsBLL`类，然后在选择选项卡中设置下拉列表`GetProducts()`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-216">Configure the ObjectDataSource to use the `ProductsBLL` class and set the drop-down list in the SELECT tab to `GetProducts()`.</span></span> <span data-ttu-id="bc7fc-217">在更新选项卡，选择`UpdateProduct`带有三个输入参数的重载`productName`， `unitPrice`，和`productID`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-217">In the UPDATE tab, choose the `UpdateProduct` overload with three input parameters - `productName`, `unitPrice`, and `productID`.</span></span> <span data-ttu-id="bc7fc-218">在 INSERT 和 DELETE 选项卡中设置为 （无） 下拉列表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-218">Set the drop-down lists to (None) in the INSERT and DELETE tabs.</span></span>


<span data-ttu-id="bc7fc-219">[![带有三个输入参数，请使用 UpdateProduct 重载](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-219">[![Use the UpdateProduct Overload with Three Input Parameters](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span></span>

<span data-ttu-id="bc7fc-220">**图 6**:使用三个输入参数使用 UpdateProduct 重载 ([单击此项可查看原尺寸图像](using-sql-cache-dependencies-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-220">**Figure 6**: Use the UpdateProduct Overload with Three Input Parameters ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image6.png))</span></span>


<span data-ttu-id="bc7fc-221">[![设置为 （无） 用于插入和删除选项卡的下拉列表](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-221">[![Set the Drop-Down List to (None) for the INSERT and DELETE Tabs](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span></span>

<span data-ttu-id="bc7fc-222">**图 7**:用于插入和删除选项卡或设置为 （无） 的下拉列表 ([单击此项可查看原尺寸图像](using-sql-cache-dependencies-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-222">**Figure 7**: Set the Drop-Down List to (None) for the INSERT and DELETE Tabs ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image8.png))</span></span>


<span data-ttu-id="bc7fc-223">完成配置数据源向导后，Visual Studio 将创建 BoundFields 和 CheckBoxFields 在 GridView 中每个数据字段。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-223">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="bc7fc-224">删除所有字段，但`ProductName`， `CategoryName`，和`UnitPrice`，并根据需要设置这些字段的格式。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-224">Remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="bc7fc-225">从 GridView s 智能标记，选中启用分页、 启用排序和启用编辑复选框。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-225">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="bc7fc-226">Visual Studio 将设置 ObjectDataSource s`OldValuesParameterFormatString`属性设置为`original_{0}`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-226">Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="bc7fc-227">为了使 GridView 的编辑功能才能正常工作，或者此属性完全从声明性语法或删除的设置回其默认值， `{0}`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-227">In order for the GridView s edit feature to work properly, either remove this property entirely from the declarative syntax or set it back to its default value, `{0}`.</span></span>

<span data-ttu-id="bc7fc-228">最后，添加一个标签 Web 控件上方的 GridView 并设置其`ID`属性设置为`ODSEvents`并将其`EnableViewState`属性设置为`false`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-228">Finally, add a Label Web control above the GridView and set its `ID` property to `ODSEvents` and its `EnableViewState` property to `false`.</span></span> <span data-ttu-id="bc7fc-229">进行这些更改后，在页面 s 声明性标记应类似于以下。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-229">After making these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="bc7fc-230">请注意，我已进行了大量不需要为了演示 SQL 缓存依赖项功能的 GridView 字段的美观自定义设置。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-230">Note that I ve made a number of aesthetic customizations to the GridView fields that are not necessary to demonstrate the SQL cache dependency functionality.</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample7.aspx)]

<span data-ttu-id="bc7fc-231">接下来，创建事件处理程序的 ObjectDataSource s`Selecting`事件并在其添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-231">Next, create an event handler for the ObjectDataSource s `Selecting` event and in it add the following code:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample8.cs)]

<span data-ttu-id="bc7fc-232">请记住，ObjectDataSource 的`Selecting`仅从其基础对象检索数据时，会触发事件。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-232">Recall that the ObjectDataSource s `Selecting` event fires only when retrieving data from its underlying object.</span></span> <span data-ttu-id="bc7fc-233">如果 ObjectDataSource 从其自己的缓存访问数据，不激发此事件。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-233">If the ObjectDataSource accesses the data from its own cache, this event is not fired.</span></span>

<span data-ttu-id="bc7fc-234">现在，请访问此页上的通过浏览器。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-234">Now, visit this page through a browser.</span></span> <span data-ttu-id="bc7fc-235">自我们 ve 尚未来实现任何缓存，每个页上，对此进行排序，或编辑的网格页的时间，应显示的文本、 选择事件触发，如图 8 所示。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-235">Since we ve yet to implement any caching, each time you page, sort, or edit the grid the page should display the text, �Selecting event fired, as Figure 8 shows.</span></span>


<span data-ttu-id="bc7fc-236">[![每个时间分页 GridView 编辑，或者按，就会触发 ObjectDataSource 的选择事件](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-236">[![The ObjectDataSource s Selecting Event Fires Each Time the GridView is Paged, Edited, or Sorted](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span></span>

<span data-ttu-id="bc7fc-237">**图 8**:ObjectDataSource s`Selecting`事件将触发每个时间分页 GridView、 编辑或按 ([单击以查看实际尺寸的图像](using-sql-cache-dependencies-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-237">**Figure 8**: The ObjectDataSource s `Selecting` Event Fires Each Time the GridView is Paged, Edited, or Sorted ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image10.png))</span></span>


<span data-ttu-id="bc7fc-238">中可以看到[使用 ObjectDataSource 缓存数据](caching-data-with-the-objectdatasource-cs.md)教程中，设置`EnableCaching`属性设置为`true`ObjectDataSource 来缓存其数据以便通过指定的持续时间将导致其`CacheDuration`属性。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-238">As we saw in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial, setting the `EnableCaching` property to `true` causes the ObjectDataSource to cache its data for the duration specified by its `CacheDuration` property.</span></span> <span data-ttu-id="bc7fc-239">ObjectDataSource 还有[`SqlCacheDependency`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx)，从而将一个或多个 SQL 缓存依赖项添加到缓存的数据使用模式：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-239">The ObjectDataSource also has a [`SqlCacheDependency` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), which adds one or more SQL cache dependencies to the cached data using the pattern:</span></span>


[!code-css[Main](using-sql-cache-dependencies-cs/samples/sample9.css)]

<span data-ttu-id="bc7fc-240">其中*databaseName*中指定的数据库的名称`name`的属性`<add>`中的元素`Web.config`，和*tableName*是数据库表的名称。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-240">Where *databaseName* is the name of the database as specified in the `name` attribute of the `<add>` element in `Web.config`, and *tableName* is the name of the database table.</span></span> <span data-ttu-id="bc7fc-241">例如，若要无限期地缓存数据对象数据源基于创建针对 Northwind s SQL 缓存依赖项`Products`表中，设置 ObjectDataSource s`EnableCaching`属性设置为`true`并将其`SqlCacheDependency`属性NorthwindDB:Products。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-241">For example, to create an ObjectDataSource that caches data indefinitely based on a SQL cache dependency against the Northwind s `Products` table, set the ObjectDataSource s `EnableCaching` property to `true` and its `SqlCacheDependency` property to NorthwindDB:Products .</span></span>

> [!NOTE]
> <span data-ttu-id="bc7fc-242">可以使用 SQL 缓存依赖项*并*通过设置基于时间的到期`EnableCaching`到`true`，`CacheDuration`为时间间隔，和`SqlCacheDependency`到数据库和表名称。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-242">You can use a SQL cache dependency *and* a time-based expiry by setting `EnableCaching` to `true`, `CacheDuration` to the time interval, and `SqlCacheDependency` to the database and table name(s).</span></span> <span data-ttu-id="bc7fc-243">ObjectDataSource 会逐出其数据到达的基于时间的过期时间时或当轮询系统就会注意，基础数据库数据已更改，以先发生者为准。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-243">The ObjectDataSource will evict its data when the time-based expiry is reached or when the polling system notes that the underlying database data has changed, whichever happens first.</span></span>


<span data-ttu-id="bc7fc-244">在 GridView`SqlCacheDependencies.aspx`显示来自两个表的数据`Products`并`Categories`(产品 s`CategoryName`通过检索字段`JOIN`上`Categories`)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-244">The GridView in `SqlCacheDependencies.aspx` displays data from two tables - `Products` and `Categories` (the product s `CategoryName` field is retrieved via a `JOIN` on `Categories`).</span></span> <span data-ttu-id="bc7fc-245">因此，我们想要指定两个 SQL 缓存依赖项：NorthwindDB:Products;NorthwindDB:Categories。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-245">Therefore, we want to specify two SQL cache dependencies: NorthwindDB:Products;NorthwindDB:Categories .</span></span>


<span data-ttu-id="bc7fc-246">[![配置对象数据源来支持缓存产品和类别上使用 SQL 缓存依赖项](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-246">[![Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on Products and Categories](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span></span>

<span data-ttu-id="bc7fc-247">**图 9**:在配置为支持缓存使用 SQL 缓存依赖项 ObjectDataSource`Products`并`Categories`([单击以查看实际尺寸的图像](using-sql-cache-dependencies-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-247">**Figure 9**: Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on `Products` and `Categories` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image12.png))</span></span>


<span data-ttu-id="bc7fc-248">配置对象数据源来支持缓存之后, 重新访问通过浏览器页面。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-248">After configuring the ObjectDataSource to support caching, revisit the page through a browser.</span></span> <span data-ttu-id="bc7fc-249">同样，激发的文本选择事件应显示在第一次的页面访问，但应消失时分页、 排序，或单击编辑或取消按钮。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-249">Again, the text �Selecting event fired should appear on the first page visit, but should go away when paging, sorting, or clicking the Edit or Cancel buttons.</span></span> <span data-ttu-id="bc7fc-250">这是因为数据加载到 ObjectDataSource 的缓存后，它会一直保留直到`Products`或`Categories`表有修改或通过 GridView 数据进行了更新。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-250">This is because after the data is loaded into the ObjectDataSource s cache, it remains there until the `Products` or `Categories` tables are modified or the data is updated through the GridView.</span></span>

<span data-ttu-id="bc7fc-251">通过网格分页并记下缺少选择事件触发后的文本，打开一个新的浏览器窗口并导航到编辑、 插入和删除部分中的基础知识教程 (`~/EditInsertDelete/Basics.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-251">After paging through the grid and noting the lack of the �Selecting event fired text, open a new browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="bc7fc-252">更新的名称或产品的价格。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-252">Update the name or price of a product.</span></span> <span data-ttu-id="bc7fc-253">然后，从第一个浏览器窗口中，查看不同的数据页、 排序网格中，或单击行的编辑按钮。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-253">Then, from to the first browser window, view a different page of data, sort the grid, or click a row s Edit button.</span></span> <span data-ttu-id="bc7fc-254">这一次，选择事件触发应重新出现，因为基础数据库的数据已被修改 （请参阅图 10）。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-254">This time, the �Selecting event fired should reappear, as the underlying database data has been modified (see Figure 10).</span></span> <span data-ttu-id="bc7fc-255">如果未显示的文本，不会等待一段时间，然后重试。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-255">If the text does not appear, wait a few moments and try again.</span></span> <span data-ttu-id="bc7fc-256">请记住，轮询服务正在检查的更改`Products`表每个`pollTime`毫秒，以便更新基础数据时和时逐出缓存的数据之间存在延迟。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-256">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>


<span data-ttu-id="bc7fc-257">[![修改 Products 表逐出缓存的产品数据](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-257">[![Modifying the Products Table Evicts the Cached Product Data](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span></span>

<span data-ttu-id="bc7fc-258">**图 10**:修改 Products 表逐出缓存产品数据 ([单击此项可查看原尺寸图像](using-sql-cache-dependencies-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-258">**Figure 10**: Modifying the Products Table Evicts the Cached Product Data ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image14.png))</span></span>


## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a><span data-ttu-id="bc7fc-259">步骤 6：以编程方式使用`SqlCacheDependency`类</span><span class="sxs-lookup"><span data-stu-id="bc7fc-259">Step 6: Programmatically Working with the`SqlCacheDependency`Class</span></span>

<span data-ttu-id="bc7fc-260">[体系结构中缓存数据](caching-data-in-the-architecture-cs.md)教程介绍了使用单独的缓存层中而不是紧密耦合使用 ObjectDataSource 缓存体系结构的好处。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-260">The [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial looked at the benefits of using a separate Caching Layer in the architecture as opposed to tightly coupling the caching with the ObjectDataSource.</span></span> <span data-ttu-id="bc7fc-261">在该教程中我们创建`ProductsCL`类，以演示如何以编程方式使用数据缓存。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-261">In that tutorial we created a `ProductsCL` class to demonstrate programmatically working with the data cache.</span></span> <span data-ttu-id="bc7fc-262">若要利用缓存层中的 SQL 缓存依赖项，请使用`SqlCacheDependency`类。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-262">To utilize SQL cache dependencies in the Caching Layer, use the `SqlCacheDependency` class.</span></span>

<span data-ttu-id="bc7fc-263">使用轮询系统`SqlCacheDependency`对象必须与一个特定的数据库和表对相关联。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-263">With the polling system, a `SqlCacheDependency` object must be associated with a particular database and table pair.</span></span> <span data-ttu-id="bc7fc-264">下面的代码，例如，创建`SqlCacheDependency`对象，基于 Northwind 数据库的`Products`表：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-264">The following code, for example, creates a `SqlCacheDependency` object based on the Northwind database s `Products` table:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample10.cs)]

<span data-ttu-id="bc7fc-265">两个输入参数`SqlCacheDependency`s 构造函数分别是数据库和表名称。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-265">The two input parameters to the `SqlCacheDependency` s constructor are the database and table names, respectively.</span></span> <span data-ttu-id="bc7fc-266">使用 ObjectDataSource s 喜欢`SqlCacheDependency`属性，使用的数据库名称是在中指定的值相同`name`的属性`<add>`中的元素`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-266">Like with the ObjectDataSource s `SqlCacheDependency` property, the database name used is the same as the value specified in the `name` attribute of the `<add>` element in `Web.config`.</span></span> <span data-ttu-id="bc7fc-267">表名是数据库表的实际名称。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-267">The table name is the actual name of the database table.</span></span>

<span data-ttu-id="bc7fc-268">若要将相关联`SqlCacheDependency`添加到数据缓存的项，请使用其中一个`Insert`接受依赖关系的方法重载。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-268">To associate a `SqlCacheDependency` with an item added to the data cache, use one of the `Insert` method overloads that accepts a dependency.</span></span> <span data-ttu-id="bc7fc-269">下面的代码添加*值*到无限期的持续时间的数据缓存，但将其与`SqlCacheDependency`上`Products`表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-269">The following code adds *value* to the data cache for an indefinite duration, but associates it with a `SqlCacheDependency` on the `Products` table.</span></span> <span data-ttu-id="bc7fc-270">简单地说，*值*将保留在缓存中，直到被逐出，否则由于内存约束或轮询系统已检测到因为`Products`表已更改自缓存。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-270">In short, *value* will remain in the cache until it is evicted due to memory constraints or because the polling system has detected that the `Products` table has changed since it was cached.</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample11.cs)]

<span data-ttu-id="bc7fc-271">缓存层 s`ProductsCL`类当前缓存中的数据`Products`表可使用 60 秒的基于时间的到期。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-271">The Caching Layer s `ProductsCL` class currently caches data from the `Products` table using a time-based expiry of 60 seconds.</span></span> <span data-ttu-id="bc7fc-272">让我们来更新此类，以便它改为使用 SQL 缓存依赖项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-272">Let s update this class so that it uses SQL cache dependencies instead.</span></span> <span data-ttu-id="bc7fc-273">`ProductsCL`类的`AddCacheItem`方法，它负责将数据添加到缓存，当前包含以下代码：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-273">The `ProductsCL` class s `AddCacheItem` method, which is responsible for adding the data to the cache, currently contains the following code:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample12.cs)]

<span data-ttu-id="bc7fc-274">更新此代码以使用`SqlCacheDependency`对象而不是`MasterCacheKeyArray`缓存依赖项：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-274">Update this code to use a `SqlCacheDependency` object instead of the `MasterCacheKeyArray` cache dependency:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample13.cs)]

<span data-ttu-id="bc7fc-275">若要测试此功能，向下的现有页添加 GridView `ProductsDeclarative` GridView。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-275">To test this functionality, add a GridView to the page beneath the existing `ProductsDeclarative` GridView.</span></span> <span data-ttu-id="bc7fc-276">设置此新 GridView s`ID`到`ProductsProgrammatic`并通过其智能标记，请将其绑定到名为新 ObjectDataSource `ProductsDataSourceProgrammatic`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-276">Set this new GridView s `ID` to `ProductsProgrammatic` and, through its smart tag, bind it to a new ObjectDataSource named `ProductsDataSourceProgrammatic`.</span></span> <span data-ttu-id="bc7fc-277">配置要使用 ObjectDataSource`ProductsCL`类，设置下拉列表中选择和更新选项卡添加到`GetProducts`和`UpdateProduct`分别。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-277">Configure the ObjectDataSource to use the `ProductsCL` class, setting the drop-down lists in the SELECT and UPDATE tabs to `GetProducts` and `UpdateProduct`, respectively.</span></span>


<span data-ttu-id="bc7fc-278">[![配置对象数据源以使用 ProductsCL 类](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-278">[![Configure the ObjectDataSource to Use the ProductsCL Class](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span></span>

<span data-ttu-id="bc7fc-279">**图 11**:配置为使用 ObjectDataSource`ProductsCL`类 ([单击以查看实际尺寸的图像](using-sql-cache-dependencies-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-279">**Figure 11**: Configure the ObjectDataSource to Use the `ProductsCL` Class ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image16.png))</span></span>


<span data-ttu-id="bc7fc-280">[![从选择的选项卡的下拉列表中选择 GetProducts 方法](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-280">[![Select the GetProducts Method from the SELECT Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span></span>

<span data-ttu-id="bc7fc-281">**图 12**:选择`GetProducts`从下拉列表中的选择选项卡 s 方法 ([单击以查看实际尺寸的图像](using-sql-cache-dependencies-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-281">**Figure 12**: Select the `GetProducts` Method from the SELECT Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image18.png))</span></span>


<span data-ttu-id="bc7fc-282">[![从更新选项卡的下拉列表中选择 UpdateProduct 方法](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-282">[![Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span></span>

<span data-ttu-id="bc7fc-283">**图 13**:从更新选项卡的下拉列表中选择 UpdateProduct 方法 ([单击此项可查看原尺寸图像](using-sql-cache-dependencies-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="bc7fc-283">**Figure 13**: Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image20.png))</span></span>


<span data-ttu-id="bc7fc-284">完成配置数据源向导后，Visual Studio 将创建 BoundFields 和 CheckBoxFields 在 GridView 中每个数据字段。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-284">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="bc7fc-285">像使用第一个 GridView 添加到此页中，删除所有字段，但`ProductName`， `CategoryName`，和`UnitPrice`，并根据需要设置这些字段的格式。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-285">Like with the first GridView added to this page, remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="bc7fc-286">从 GridView s 智能标记，选中启用分页、 启用排序和启用编辑复选框。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-286">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="bc7fc-287">如同`ProductsDataSourceDeclarative`ObjectDataSource、 Visual Studio 将设置`ProductsDataSourceProgrammatic`ObjectDataSource s`OldValuesParameterFormatString`属性设置为`original_{0}`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-287">As with the `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio will set the `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="bc7fc-288">为了使 GridView 的编辑功能，若要正常工作，请将此属性设置回`{0}`（或从声明性语法中完全删除属性赋值）。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-288">In order for the GridView s edit feature to work properly, set this property back to `{0}` (or remove the property assignment from the declarative syntax altogether).</span></span>

<span data-ttu-id="bc7fc-289">完成这些任务后, 所得的 GridView 和 ObjectDataSource 声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-289">After completing these tasks, the resulting GridView and ObjectDataSource declarative markup should look like the following:</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample14.aspx)]

<span data-ttu-id="bc7fc-290">若要测试 SQL 缓存依赖项中缓存层中设置断点`ProductCL`类的`AddCacheItem`方法，然后开始调试。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-290">To test the SQL cache dependency in the Caching Layer set a breakpoint in the `ProductCL` class s `AddCacheItem` method and then start debugging.</span></span> <span data-ttu-id="bc7fc-291">当你首次访问`SqlCacheDependencies.aspx`，如第一次请求数据并将其放入缓存，应会命中断点。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-291">When you first visit `SqlCacheDependencies.aspx`, the breakpoint should be hit as the data is requested for the first time and placed into the cache.</span></span> <span data-ttu-id="bc7fc-292">接下来，移到 GridView 中的另一页或排序的列之一。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-292">Next, move to another page in the GridView or sort one of the columns.</span></span> <span data-ttu-id="bc7fc-293">这将导致 GridView 来重新查询其数据，但应以来在缓存中找到数据`Products`尚未修改数据库表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-293">This causes the GridView to requery its data, but the data should be found in the cache since the `Products` database table has not been modified.</span></span> <span data-ttu-id="bc7fc-294">如果在缓存中重复未找到数据，请确保有足够的内存，可在计算机上，然后重试。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-294">If the data is repeatedly not found in the cache, make sure there is sufficient memory available on your computer and try again.</span></span>

<span data-ttu-id="bc7fc-295">在 GridView 中的若干页进行分页后, 打开第二个浏览器窗口并导航到编辑、 插入和删除部分中的基础知识教程 (`~/EditInsertDelete/Basics.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-295">After paging through a few pages of the GridView, open a second browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="bc7fc-296">更新 Products 表中的记录，然后，从第一个浏览器窗口中，查看新的页或单击一个排序的标头。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-296">Update a record from the Products table and then, from the first browser window, view a new page or click on one of the sorting headers.</span></span>

<span data-ttu-id="bc7fc-297">在此方案中您将看到两个条件之一： 任一断点将被命中，，该值指示缓存的数据已被逐出由于中在数据库中，更改或者，将不会命中断点，这意味着，`SqlCacheDependencies.aspx`现在显示过时的数据。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-297">In this scenario you will see one of two things: either the breakpoint will be hit, indicating that the cached data was evicted due to the change in the database; or, the breakpoint will not be hit, meaning that `SqlCacheDependencies.aspx` is now showing stale data.</span></span> <span data-ttu-id="bc7fc-298">如果未命中断点，它可能是因为数据已更改的轮询服务不尚未触发。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-298">If the breakpoint is not hit, it is likely because the polling service has not yet fired since the data was changed.</span></span> <span data-ttu-id="bc7fc-299">请记住，轮询服务正在检查的更改`Products`表每个`pollTime`毫秒，以便更新基础数据时和时逐出缓存的数据之间存在延迟。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-299">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

> [!NOTE]
> <span data-ttu-id="bc7fc-300">这种延迟是更有可能在编辑通过 GridView 中的产品之一时显示`SqlCacheDependencies.aspx`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-300">This delay is more likely to appear when editing one of the products through the GridView in `SqlCacheDependencies.aspx`.</span></span> <span data-ttu-id="bc7fc-301">在中[体系结构中缓存数据](caching-data-in-the-architecture-cs.md)教程中我们添加了`MasterCacheKeyArray`缓存依赖关系，以确保通过正在编辑的数据`ProductsCL`类的`UpdateProduct`方法已从缓存逐出。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-301">In the [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial we added the `MasterCacheKeyArray` cache dependency to ensure that the data being edited through the `ProductsCL` class s `UpdateProduct` method was evicted from the cache.</span></span> <span data-ttu-id="bc7fc-302">但是，我们替换为此缓存依赖项修改时`AddCacheItem`方法之前在此步骤中的，因此`ProductsCL`类将继续显示缓存的数据，直到轮询系统就会注意到更改`Products`表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-302">However, we replaced this cache dependency when modifying the `AddCacheItem` method earlier in this step and therefore the `ProductsCL` class will continue to show the cached data until the polling system notes the change to the `Products` table.</span></span> <span data-ttu-id="bc7fc-303">我们将了解如何重新引入`MasterCacheKeyArray`缓存在步骤 7 中的依赖关系。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-303">We'll see how to reintroduce the `MasterCacheKeyArray` cache dependency in Step 7.</span></span>


## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a><span data-ttu-id="bc7fc-304">步骤 7：将多个依赖项与缓存的项相关联</span><span class="sxs-lookup"><span data-stu-id="bc7fc-304">Step 7: Associating Multiple Dependencies with a Cached Item</span></span>

<span data-ttu-id="bc7fc-305">请记住，`MasterCacheKeyArray`缓存依赖项用于确保*所有*更新中其关联的任何单个项时，与产品相关的数据从缓存中逐出。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-305">Recall that the `MasterCacheKeyArray` cache dependency is used to ensure that *all* product-related data is evicted from the cache when any single item associated within it is updated.</span></span> <span data-ttu-id="bc7fc-306">例如，`GetProductsByCategoryID(categoryID)`方法缓存`ProductsDataTables`实例为每个唯一*categoryID*值。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-306">For example, the `GetProductsByCategoryID(categoryID)` method caches `ProductsDataTables` instances for each unique *categoryID* value.</span></span> <span data-ttu-id="bc7fc-307">如果其中某个对象被逐出，`MasterCacheKeyArray`缓存依赖项可确保其他人也会删除。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-307">If one of these objects is evicted, the `MasterCacheKeyArray` cache dependency ensures that the others are also removed.</span></span> <span data-ttu-id="bc7fc-308">不缓存此依赖项，修改缓存的数据的可能性是存在的其他缓存的产品数据可能会过期。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-308">Without this cache dependency, when the cached data is modified the possibility exists that other cached product data may be out of date.</span></span> <span data-ttu-id="bc7fc-309">因此，它非常重要，我们维护`MasterCacheKeyArray`缓存依赖项时使用 SQL 缓存依赖项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-309">Consequently, it s important that we maintain the `MasterCacheKeyArray` cache dependency when using SQL cache dependencies.</span></span> <span data-ttu-id="bc7fc-310">但是，数据缓存 s`Insert`方法只允许单个依赖关系对象。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-310">However, the data cache s `Insert` method only allows for a single dependency object.</span></span>

<span data-ttu-id="bc7fc-311">此外，使用 SQL 缓存依赖项时我们可能需要将作为依赖项的多个数据库表相关联。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-311">Furthermore, when working with SQL cache dependencies we may need to associate multiple database tables as dependencies.</span></span> <span data-ttu-id="bc7fc-312">例如，`ProductsDataTable`缓存在`ProductsCL`类包含用于每个产品类别和供应商名称，但`AddCacheItem`方法仅使用一个依赖项上`Products`。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-312">For example, the `ProductsDataTable` cached in the `ProductsCL` class contains the category and supplier names for each product, but the `AddCacheItem` method only uses a dependency on `Products`.</span></span> <span data-ttu-id="bc7fc-313">在此情况下，如果用户更新的类别或供应商的名称将保留在缓存中缓存的产品数据和超时的后果。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-313">In this situation, if the user updates the name of a category or supplier, the cached product data will remain in the cache and be out of date.</span></span> <span data-ttu-id="bc7fc-314">因此，我们想要使缓存的产品数据依赖于不仅`Products`表，但在`Categories`和`Suppliers`以及表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-314">Therefore, we want to make the cached product data dependent on not only the `Products` table, but on the `Categories` and `Suppliers` tables as well.</span></span>

<span data-ttu-id="bc7fc-315">[ `AggregateCacheDependency`类](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx)提供了一种将多个依赖项的缓存项与相关联。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-315">The [`AggregateCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) provides a means for associating multiple dependencies with a cache item.</span></span> <span data-ttu-id="bc7fc-316">首先创建`AggregateCacheDependency`实例。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-316">Start by creating an `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="bc7fc-317">接下来，添加的依赖项使用一套`AggregateCacheDependency`s`Add`方法。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-317">Next, add the set of dependencies using the `AggregateCacheDependency` s `Add` method.</span></span> <span data-ttu-id="bc7fc-318">此后将项插入到数据缓存，当传入`AggregateCacheDependency`实例。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-318">When inserting the item into the data cache thereafter, pass in the `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="bc7fc-319">当*任何*的`AggregateCacheDependency`实例 s 依赖项更改，将逐出缓存的项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-319">When *any* of the `AggregateCacheDependency` instance s dependencies change, the cached item will be evicted.</span></span>

<span data-ttu-id="bc7fc-320">下面显示了有关更新的代码`ProductsCL`类的`AddCacheItem`方法。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-320">The following shows the updated code for the `ProductsCL` class s `AddCacheItem` method.</span></span> <span data-ttu-id="bc7fc-321">该方法将创建`MasterCacheKeyArray`缓存依赖项一起`SqlCacheDependency`对象的`Products`， `Categories`，和`Suppliers`表。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-321">The method creates the `MasterCacheKeyArray` cache dependency along with `SqlCacheDependency` objects for the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="bc7fc-322">这些所有合并成一个`AggregateCacheDependency`名为对象`aggregateDependencies`，后者再传递到`Insert`方法。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-322">These are all combined into one `AggregateCacheDependency` object named `aggregateDependencies`, which is then passed into the `Insert` method.</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample15.cs)]

<span data-ttu-id="bc7fc-323">测试出此新代码。现在将变为`Products`， `Categories`，或`Suppliers`表会导致被逐出缓存的数据。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-323">Test this new code out. Now changes to the `Products`, `Categories`, or `Suppliers` tables cause the cached data to be evicted.</span></span> <span data-ttu-id="bc7fc-324">此外，`ProductsCL`类 s`UpdateProduct`方法，称为编辑通过 GridView 产品时，逐出`MasterCacheKeyArray`缓存依赖项，这会导致缓存`ProductsDataTable`逐出和下一步重新检索的数据请求。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-324">Moreover, the `ProductsCL` class s `UpdateProduct` method, which is called when editing a product through the GridView, evicts the `MasterCacheKeyArray` cache dependency, which causes the cached `ProductsDataTable` to be evicted and the data to be re-retrieved on the next request.</span></span>

> [!NOTE]
> <span data-ttu-id="bc7fc-325">SQL 缓存依赖项也可以用于[输出缓存](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-325">SQL cache dependencies can also be used with [output caching](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span></span> <span data-ttu-id="bc7fc-326">有关此功能的演示，请参阅：[使用 ASP.NET 输出缓存随 SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-326">For a demonstration of this functionality, see: [Using ASP.NET Output Caching with SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span></span>


## <a name="summary"></a><span data-ttu-id="bc7fc-327">总结</span><span class="sxs-lookup"><span data-stu-id="bc7fc-327">Summary</span></span>

<span data-ttu-id="bc7fc-328">除非在数据库中修改，否则，当缓存数据库数据，数据将理想情况下会保留在缓存中。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-328">When caching database data, the data will ideally remain in the cache until it is modified in the database.</span></span> <span data-ttu-id="bc7fc-329">使用 ASP.NET 2.0 中，可以创建并在声明性和编程方案中使用 SQL 缓存依赖项。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-329">With ASP.NET 2.0, SQL cache dependencies can be created and used in both declarative and programmatic scenarios.</span></span> <span data-ttu-id="bc7fc-330">使用此方法的挑战之一就是发现修改的数据时。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-330">One of the challenges with this approach is in discovering when the data has been modified.</span></span> <span data-ttu-id="bc7fc-331">完整版本的 Microsoft SQL Server 2005 提供的查询结果发生更改时可以发出警报应用程序的通知功能。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-331">The full versions of Microsoft SQL Server 2005 provide notification capabilities that can alert an application when a query result has changed.</span></span> <span data-ttu-id="bc7fc-332">对于 Express 版本的 SQL Server 2005 和较旧版本的 SQL Server，必须改为使用轮询系统。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-332">For the Express Edition of SQL Server 2005 and older versions of SQL Server, a polling system must be used instead.</span></span> <span data-ttu-id="bc7fc-333">幸运的是，设置必要的轮询基础结构是非常简单。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-333">Fortunately, setting up the necessary polling infrastructure is fairly straightforward.</span></span>

<span data-ttu-id="bc7fc-334">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="bc7fc-334">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="bc7fc-335">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="bc7fc-335">Further Reading</span></span>

<span data-ttu-id="bc7fc-336">在本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="bc7fc-336">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="bc7fc-337">Microsoft SQL Server 2005 中使用查询通知</span><span class="sxs-lookup"><span data-stu-id="bc7fc-337">Using Query Notifications in Microsoft SQL Server 2005</span></span>](https://msdn.microsoft.com/library/ms175110.aspx)
- [<span data-ttu-id="bc7fc-338">创建查询通知</span><span class="sxs-lookup"><span data-stu-id="bc7fc-338">Creating a Query Notification</span></span>](https://msdn.microsoft.com/library/ms188669.aspx)
- <span data-ttu-id="bc7fc-339">[在缓存中使用的 ASP.NET`SqlCacheDependency`类](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-339">[Caching in ASP.NET with the `SqlCacheDependency` Class](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span></span>
- <span data-ttu-id="bc7fc-340">[ASP.NET SQL Server 注册工具 (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-340">[ASP.NET SQL Server Registration Tool (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span></span>
- [<span data-ttu-id="bc7fc-341">概述 `SqlCacheDependency`</span><span class="sxs-lookup"><span data-stu-id="bc7fc-341">Overview of `SqlCacheDependency`</span></span>](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a><span data-ttu-id="bc7fc-342">关于作者</span><span class="sxs-lookup"><span data-stu-id="bc7fc-342">About the Author</span></span>

<span data-ttu-id="bc7fc-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)的七个部 asp/ASP.NET 书籍并创办了作者[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年以来一直致力于 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="bc7fc-344">Scott 是独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-344">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="bc7fc-345">他最新著作是[ *Sams Teach 自己 ASP.NET 2.0 24 小时内*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-345">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="bc7fc-346">他可以到达[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-346">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="bc7fc-347">或通过他的博客，其中，请参阅[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-347">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="bc7fc-348">特别感谢</span><span class="sxs-lookup"><span data-stu-id="bc7fc-348">Special Thanks To</span></span>

<span data-ttu-id="bc7fc-349">很多有用的审阅者已评审本系列教程。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-349">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="bc7fc-350">本教程中的潜在顾客审阅者是 Marko Rangel、 Teresa Murphy 和 Hilton Giesenow。</span><span class="sxs-lookup"><span data-stu-id="bc7fc-350">Lead reviewers for this tutorial were Marko Rangel, Teresa Murphy, and Hilton Giesenow.</span></span> <span data-ttu-id="bc7fc-351">是否有兴趣查看我即将推出的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="bc7fc-351">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="bc7fc-352">如果是这样，给我在行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-352">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="bc7fc-353">[上一页](caching-data-at-application-startup-cs.md)
> [下一页](caching-data-with-the-objectdatasource-vb.md)</span><span class="sxs-lookup"><span data-stu-id="bc7fc-353">[Previous](caching-data-at-application-startup-cs.md)
[Next](caching-data-with-the-objectdatasource-vb.md)</span></span>
