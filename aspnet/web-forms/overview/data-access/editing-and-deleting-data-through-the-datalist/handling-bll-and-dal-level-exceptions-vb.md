---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/handling-bll-and-dal-level-exceptions-vb
title: 处理 BLL 和 DAL 级别的异常（VB） |Microsoft Docs
author: rick-anderson
description: 在本教程中，我们将了解如何 tactfully 在可编辑的 DataList 更新工作流过程中处理异常。
ms.author: riande
ms.date: 10/30/2006
ms.assetid: ca665073-b379-4239-9404-f597663ca65e
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/handling-bll-and-dal-level-exceptions-vb
msc.type: authoredcontent
ms.openlocfilehash: 319ab44f2e65afc77f6f89ca8aa58c529f40d05c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74624280"
---
# <a name="handling-bll--and-dal-level-exceptions-vb"></a><span data-ttu-id="925a2-103">处理 BLL 和 DAL 级别的异常 (VB)</span><span class="sxs-lookup"><span data-stu-id="925a2-103">Handling BLL- and DAL-Level Exceptions (VB)</span></span>

<span data-ttu-id="925a2-104">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="925a2-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="925a2-105">[下载示例应用](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_38_VB.exe)或[下载 PDF](handling-bll-and-dal-level-exceptions-vb/_static/datatutorial38vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="925a2-105">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_38_VB.exe) or [Download PDF](handling-bll-and-dal-level-exceptions-vb/_static/datatutorial38vb1.pdf)</span></span>

> <span data-ttu-id="925a2-106">在本教程中，我们将了解如何 tactfully 在可编辑的 DataList 更新工作流过程中处理异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-106">In this tutorial, we'll see how to tactfully handle exceptions raised during an editable DataList's updating workflow.</span></span>

## <a name="introduction"></a><span data-ttu-id="925a2-107">简介</span><span class="sxs-lookup"><span data-stu-id="925a2-107">Introduction</span></span>

<span data-ttu-id="925a2-108">在 DataList 教程中[编辑和删除数据的概述](an-overview-of-editing-and-deleting-data-in-the-datalist-cs.md)中，我们创建了一个 datalist，其中提供了简单的编辑和删除功能。</span><span class="sxs-lookup"><span data-stu-id="925a2-108">In the [Overview of Editing and Deleting Data in the DataList](an-overview-of-editing-and-deleting-data-in-the-datalist-cs.md) tutorial, we created a DataList that offered simple editing and deleting capabilities.</span></span> <span data-ttu-id="925a2-109">虽然完全正常运行，但它不是用户友好的，因为编辑或删除过程中出现的任何错误都将导致未经处理的异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-109">While fully functional, it was hardly user-friendly, as any error that occurred during the editing or deleting process resulted in an unhandled exception.</span></span> <span data-ttu-id="925a2-110">例如，如果省略产品名称，或者在编辑产品时输入价格值 "非常经济实惠"，则会引发异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-110">For example, omitting the product s name or, when editing a product, entering a price value of Very affordable!, throws an exception.</span></span> <span data-ttu-id="925a2-111">由于未在代码中捕获此异常，因此它冒泡到 ASP.NET 运行时，然后在网页中显示异常详细信息。</span><span class="sxs-lookup"><span data-stu-id="925a2-111">Since this exception is not caught in code, it bubbles up to the ASP.NET runtime, which then displays the exception s details in the web page.</span></span>

<span data-ttu-id="925a2-112">正如我们在[ASP.NET 页中处理 BLL 和 DAL 级别的异常](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md)中看到的那样，如果从业务逻辑或数据访问层的深度引发异常，则会将异常详细信息返回到 ObjectDataSource，然后返回到 GridView。</span><span class="sxs-lookup"><span data-stu-id="925a2-112">As we saw in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial, if an exception is raised from the depths of the Business Logic or Data Access Layers, the exception details are returned to the ObjectDataSource and then to the GridView.</span></span> <span data-ttu-id="925a2-113">我们了解到如何通过为 ObjectDataSource 或 GridView 创建 `Updated` 或 `RowUpdated` 事件处理程序来适当地处理这些异常，从而检查是否有异常，然后指示是否已处理异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-113">We saw how to gracefully handle these exceptions by creating `Updated` or `RowUpdated` event handlers for the ObjectDataSource or GridView, checking for an exception, and then indicating that the exception was handled.</span></span>

<span data-ttu-id="925a2-114">不过，DataList 教程不使用 ObjectDataSource 来更新和删除数据。</span><span class="sxs-lookup"><span data-stu-id="925a2-114">Our DataList tutorials, however, aren't using the ObjectDataSource for updating and deleting data.</span></span> <span data-ttu-id="925a2-115">相反，我们正在直接处理 BLL。</span><span class="sxs-lookup"><span data-stu-id="925a2-115">Instead, we are working directly against the BLL.</span></span> <span data-ttu-id="925a2-116">为了检测源自 BLL 或 DAL 的异常，我们需要在 ASP.NET 页面的代码隐藏内实现异常处理代码。</span><span class="sxs-lookup"><span data-stu-id="925a2-116">In order to detect exceptions originating from the BLL or DAL, we need to implement exception handling code within the code-behind of our ASP.NET page.</span></span> <span data-ttu-id="925a2-117">在本教程中，我们将了解如何使用更多 tactfully 处理在可编辑的 DataList s 更新工作流期间引发的异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-117">In this tutorial, we'll see how to more tactfully handle exceptions raised during an editable DataList s updating workflow.</span></span>

> [!NOTE]
> <span data-ttu-id="925a2-118">在 DataList 教程中*编辑和删除数据的概述*中，我们讨论了用于编辑和删除 datalist 中的数据的不同方法，这是使用 ObjectDataSource 进行更新和删除所涉及的一些技巧。</span><span class="sxs-lookup"><span data-stu-id="925a2-118">In the *An Overview of Editing and Deleting Data in the DataList* tutorial we discussed different techniques for editing and deleting data from the DataList, Some techniques involved using an ObjectDataSource for updating and deleting.</span></span> <span data-ttu-id="925a2-119">如果使用这些方法，则可以通过 ObjectDataSource `Updated` 或 `Deleted` 事件处理程序来处理 BLL 或 DAL 中的异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-119">If you employ these techniques, you can handle exceptions from the BLL or DAL through the ObjectDataSource s `Updated` or `Deleted` event handlers.</span></span>

## <a name="step-1-creating-an-editable-datalist"></a><span data-ttu-id="925a2-120">步骤1：创建可编辑的 DataList</span><span class="sxs-lookup"><span data-stu-id="925a2-120">Step 1: Creating an Editable DataList</span></span>

<span data-ttu-id="925a2-121">在担心如何处理更新工作流中发生的异常之前，让我们先创建一个可编辑的 DataList。</span><span class="sxs-lookup"><span data-stu-id="925a2-121">Before we worry about handling exceptions that occur during the updating workflow, let s first create an editable DataList.</span></span> <span data-ttu-id="925a2-122">打开 `EditDeleteDataList` 文件夹中的 "`ErrorHandling.aspx`" 页，将 DataList 添加到设计器，将其 `ID` 属性设置为 "`Products`"，然后添加名为 "`ProductsDataSource`" 的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="925a2-122">Open the `ErrorHandling.aspx` page in the `EditDeleteDataList` folder, add a DataList to the Designer, set its `ID` property to `Products`, and add a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="925a2-123">将 ObjectDataSource 配置为使用 `ProductsBLL` 类 `GetProducts()` 方法来选择记录;将插入、更新和删除选项卡中的下拉列表设置为 "（无）"。</span><span class="sxs-lookup"><span data-stu-id="925a2-123">Configure the ObjectDataSource to use the `ProductsBLL` class s `GetProducts()` method for selecting records; set the drop-down lists in the INSERT, UPDATE, and DELETE tabs to (None).</span></span>

<span data-ttu-id="925a2-124">[![使用 GetProducts （）方法返回产品信息](handling-bll-and-dal-level-exceptions-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="925a2-124">[![Return the Product Information Using the GetProducts() Method](handling-bll-and-dal-level-exceptions-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-vb/_static/image1.png)</span></span>

<span data-ttu-id="925a2-125">**图 1**：使用 `GetProducts()` 方法返回产品信息（[单击以查看完全大小的图像](handling-bll-and-dal-level-exceptions-vb/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="925a2-125">**Figure 1**: Return the Product Information Using the `GetProducts()` Method ([Click to view full-size image](handling-bll-and-dal-level-exceptions-vb/_static/image3.png))</span></span>

<span data-ttu-id="925a2-126">完成 ObjectDataSource 向导后，Visual Studio 将自动为 DataList 创建 `ItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="925a2-126">After completing the ObjectDataSource wizard, Visual Studio will automatically create an `ItemTemplate` for the DataList.</span></span> <span data-ttu-id="925a2-127">将此项替换为显示每个产品的名称和价格的 `ItemTemplate`，并包括 "编辑" 按钮。</span><span class="sxs-lookup"><span data-stu-id="925a2-127">Replace this with an `ItemTemplate` that displays each product s name and price and includes an Edit button.</span></span> <span data-ttu-id="925a2-128">接下来，创建一个具有 "名称"、"价格" 和 "更新" 和 "取消" 按钮的 TextBox Web 控件的 `EditItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="925a2-128">Next, create an `EditItemTemplate` with a TextBox Web control for name and price and Update and Cancel buttons.</span></span> <span data-ttu-id="925a2-129">最后，将 DataList s `RepeatColumns` 属性设置为2。</span><span class="sxs-lookup"><span data-stu-id="925a2-129">Finally, set the DataList s `RepeatColumns` property to 2.</span></span>

<span data-ttu-id="925a2-130">进行这些更改后，页的声明性标记应如下所示。</span><span class="sxs-lookup"><span data-stu-id="925a2-130">After these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="925a2-131">仔细检查以确保 "编辑"、"取消" 和 "更新" 按钮的 `CommandName` 属性分别设置为 "编辑"、"取消" 和 "更新"。</span><span class="sxs-lookup"><span data-stu-id="925a2-131">Double-check to make certain that the Edit, Cancel, and Update buttons have their `CommandName` properties set to Edit, Cancel, and Update, respectively.</span></span>

[!code-aspx[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample1.aspx)]

> [!NOTE]
> <span data-ttu-id="925a2-132">对于本教程，必须启用 DataList 的视图状态。</span><span class="sxs-lookup"><span data-stu-id="925a2-132">For this tutorial the DataList s view state must be enabled.</span></span>

<span data-ttu-id="925a2-133">花点时间通过浏览器查看进度（参见图2）。</span><span class="sxs-lookup"><span data-stu-id="925a2-133">Take a moment to view our progress through a browser (see Figure 2).</span></span>

<span data-ttu-id="925a2-134">[每个产品 ![都包含 "编辑" 按钮](handling-bll-and-dal-level-exceptions-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="925a2-134">[![Each Product Includes an Edit Button](handling-bll-and-dal-level-exceptions-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-vb/_static/image4.png)</span></span>

<span data-ttu-id="925a2-135">**图 2**：每个产品都包含一个 "编辑" 按钮（[单击以查看完全大小的图像](handling-bll-and-dal-level-exceptions-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="925a2-135">**Figure 2**: Each Product Includes an Edit Button ([Click to view full-size image](handling-bll-and-dal-level-exceptions-vb/_static/image6.png))</span></span>

<span data-ttu-id="925a2-136">目前，"编辑" 按钮仅导致回发，它尚未使产品变为可编辑状态。</span><span class="sxs-lookup"><span data-stu-id="925a2-136">Currently, the Edit button only causes a postback it doesn t yet make the product editable.</span></span> <span data-ttu-id="925a2-137">若要启用编辑，需要为 DataList s `EditCommand`、`CancelCommand`和 `UpdateCommand` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="925a2-137">To enable editing, we need to create event handlers for the DataList s `EditCommand`, `CancelCommand`, and `UpdateCommand` events.</span></span> <span data-ttu-id="925a2-138">`EditCommand` 和 `CancelCommand` 事件只更新 DataList s `EditItemIndex` 属性，然后将数据重新绑定到 DataList：</span><span class="sxs-lookup"><span data-stu-id="925a2-138">The `EditCommand` and `CancelCommand` events simply update the DataList s `EditItemIndex` property and rebind the data to the DataList:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample2.vb)]

<span data-ttu-id="925a2-139">`UpdateCommand` 事件处理程序更复杂一些。</span><span class="sxs-lookup"><span data-stu-id="925a2-139">The `UpdateCommand` event handler is a bit more involved.</span></span> <span data-ttu-id="925a2-140">它需要从 `DataKeys` 集合中读取所编辑的产品 `ProductID`，并从 `EditItemTemplate`中的文本框中读取产品的名称和价格，然后在将 DataList 返回到其预编辑状态之前调用 `ProductsBLL` 类 s `UpdateProduct` 方法。</span><span class="sxs-lookup"><span data-stu-id="925a2-140">It needs to read in the edited product s `ProductID` from the `DataKeys` collection along with the product s name and price from the TextBoxes in the `EditItemTemplate`, and then call the `ProductsBLL` class s `UpdateProduct` method before returning the DataList to its pre-editing state.</span></span>

<span data-ttu-id="925a2-141">现在，让我们在 DataList 教程中*编辑和删除数据的概述*中，只使用 `UpdateCommand` 事件处理程序中的完全相同的代码。</span><span class="sxs-lookup"><span data-stu-id="925a2-141">For now, let s just use the exact same code from the `UpdateCommand` event handler in the *Overview of Editing and Deleting Data in the DataList* tutorial.</span></span> <span data-ttu-id="925a2-142">在步骤2中，我们将添加代码来适当地处理异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-142">We'll add the code to gracefully handle exceptions in step 2.</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample3.vb)]

<span data-ttu-id="925a2-143">如果输入的输入无效，可能采用格式不正确的单位价格的形式，则无效的单位价格值（如-$5.00）或省略产品的名称，将引发异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-143">In the face of invalid input which can be in the form of an improperly formatted unit price, an illegal unit price value like -$5.00, or the omission of the product s name an exception will be raised.</span></span> <span data-ttu-id="925a2-144">由于 `UpdateCommand` 事件处理程序此时不包括任何异常处理代码，因此，该异常将向上冒泡到 ASP.NET 运行时，它将显示给最终用户（请参阅图3）。</span><span class="sxs-lookup"><span data-stu-id="925a2-144">Since the `UpdateCommand` event handler does not include any exception handling code at this point, the exception will bubble up to the ASP.NET runtime, where it will be displayed to the end user (see Figure 3).</span></span>

![发生未经处理的异常时，最终用户会看到错误页](handling-bll-and-dal-level-exceptions-vb/_static/image7.png)

<span data-ttu-id="925a2-146">**图 3**：当发生未处理的异常时，最终用户会看到错误页</span><span class="sxs-lookup"><span data-stu-id="925a2-146">**Figure 3**: When an Unhandled Exception Occurs, the End User Sees an Error Page</span></span>

## <a name="step-2-gracefully-handling-exceptions-in-the-updatecommand-event-handler"></a><span data-ttu-id="925a2-147">步骤2：在 UpdateCommand 事件处理程序中正常处理异常</span><span class="sxs-lookup"><span data-stu-id="925a2-147">Step 2: Gracefully Handling Exceptions in the UpdateCommand Event Handler</span></span>

<span data-ttu-id="925a2-148">在更新工作流期间，`UpdateCommand` 事件处理程序、BLL 或 DAL 中可能出现异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-148">During the updating workflow, exceptions can occur in the `UpdateCommand` event handler, the BLL, or the DAL.</span></span> <span data-ttu-id="925a2-149">例如，如果用户输入的价格太大，则 `UpdateCommand` 事件处理程序中的 `Decimal.Parse` 语句将引发 `FormatException` 异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-149">For example, if a user enters a price of Too expensive, the `Decimal.Parse` statement in the `UpdateCommand` event handler will throw a `FormatException` exception.</span></span> <span data-ttu-id="925a2-150">如果用户省略产品名称，或者价格有负值，则 DAL 会引发异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-150">If the user omits the product s name or if the price has a negative value, the DAL will raise an exception.</span></span>

<span data-ttu-id="925a2-151">发生异常时，我们希望在页面本身中显示信息性消息。</span><span class="sxs-lookup"><span data-stu-id="925a2-151">When an exception occurs, we want to display an informative message within the page itself.</span></span> <span data-ttu-id="925a2-152">将标签 Web 控件添加到页面，其 `ID` 设置为 `ExceptionDetails`。</span><span class="sxs-lookup"><span data-stu-id="925a2-152">Add a Label Web control to the page whose `ID` is set to `ExceptionDetails`.</span></span> <span data-ttu-id="925a2-153">通过将标签文本的 `CssClass` 属性分配给在 `Styles.css` 文件中定义的 `Warning` CSS 类，将其配置为显示为红色、特大、粗体和斜体。</span><span class="sxs-lookup"><span data-stu-id="925a2-153">Configure the Label s text to display in a red, extra-large, bold and italic font by assigning its `CssClass` property to the `Warning` CSS class, which is defined in the `Styles.css` file.</span></span>

<span data-ttu-id="925a2-154">出现错误时，只需显示标签一次。</span><span class="sxs-lookup"><span data-stu-id="925a2-154">When an error occurs, we only want the Label to be displayed once.</span></span> <span data-ttu-id="925a2-155">也就是说，在后续回发中，标签的警告消息将会消失。</span><span class="sxs-lookup"><span data-stu-id="925a2-155">That is, on subsequent postbacks, the Label s warning message should disappear.</span></span> <span data-ttu-id="925a2-156">这可以通过以下方式完成：清除标签 s `Text` 属性，或将其 `Visible` 属性设置为在 `Page_Load` 事件处理程序中 `False` （如我们在[ASP.NET 页教程中处理 BLL 和 DAL 级别的异常](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md)）或禁用标签的视图状态支持。</span><span class="sxs-lookup"><span data-stu-id="925a2-156">This can be accomplished by either clearing out the Label s `Text` property or settings its `Visible` property to `False` in the `Page_Load` event handler (as we did back in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) tutorial) or by disabling the Label s view state support.</span></span> <span data-ttu-id="925a2-157">使用后一种方法。</span><span class="sxs-lookup"><span data-stu-id="925a2-157">Let s use the latter option.</span></span>

[!code-aspx[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample4.aspx)]

<span data-ttu-id="925a2-158">引发异常时，会将异常的详细信息分配给 `ExceptionDetails` 标签控件 `Text` 属性。</span><span class="sxs-lookup"><span data-stu-id="925a2-158">When an exception is raised, we'll assign the details of the exception to the `ExceptionDetails` Label control s `Text` property.</span></span> <span data-ttu-id="925a2-159">由于其视图状态处于禁用状态，因此在后续回发中，`Text` 属性的编程更改将丢失，恢复为默认文本（空字符串），从而隐藏警告消息。</span><span class="sxs-lookup"><span data-stu-id="925a2-159">Since its view state is disabled, on subsequent postbacks the `Text` property s programmatic changes will be lost, reverting back to the default text (an empty string), thereby hiding the warning message.</span></span>

<span data-ttu-id="925a2-160">若要确定何时引发错误以便在页面上显示有用的消息，需要将 `Try ... Catch` 块添加到 `UpdateCommand` 事件处理程序中。</span><span class="sxs-lookup"><span data-stu-id="925a2-160">To determine when an error has been raised in order to display a helpful message on the page, we need to add a `Try ... Catch` block to the `UpdateCommand` event handler.</span></span> <span data-ttu-id="925a2-161">`Try` 部分包含可能导致异常的代码，而 `Catch` 块包含在出现异常时执行的代码。</span><span class="sxs-lookup"><span data-stu-id="925a2-161">The `Try` portion contains code that may lead to an exception, while the `Catch` block contains code that is executed in the face of an exception.</span></span> <span data-ttu-id="925a2-162">有关 `Try ... Catch` 块的详细信息，请查看 .NET Framework 文档中的 "[异常处理基础知识](https://msdn.microsoft.com/library/2w8f0bss.aspx)" 部分。</span><span class="sxs-lookup"><span data-stu-id="925a2-162">Check out the [Exception Handling Fundamentals](https://msdn.microsoft.com/library/2w8f0bss.aspx) section in the .NET Framework documentation for more information on the `Try ... Catch` block.</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample5.vb)]

<span data-ttu-id="925a2-163">当 `Try` 块内的代码引发任何类型的异常时，将开始执行 `Catch` 的代码块。</span><span class="sxs-lookup"><span data-stu-id="925a2-163">When an exception of any type is thrown by code within the `Try` block, the `Catch` block s code will begin executing.</span></span> <span data-ttu-id="925a2-164">`DbException`、`NoNullAllowedException`、`ArgumentException`等引发的异常的类型取决于首先被错误的具体内容。</span><span class="sxs-lookup"><span data-stu-id="925a2-164">The type of exception that is thrown `DbException`, `NoNullAllowedException`, `ArgumentException`, and so on depends on what, exactly, precipitated the error in the first place.</span></span> <span data-ttu-id="925a2-165">如果数据库级别出现问题，则会引发 `DbException`。</span><span class="sxs-lookup"><span data-stu-id="925a2-165">If there s a problem at the database level, a `DbException` will be thrown.</span></span> <span data-ttu-id="925a2-166">如果为 `UnitPrice`、`UnitsInStock`、`UnitsOnOrder`或 `ReorderLevel` 字段输入了非法值，将引发 `ArgumentException`，因为我们添加了代码来验证 `ProductsDataTable` 类中的这些字段值（请参阅[创建业务逻辑层](../introduction/creating-a-business-logic-layer-vb.md)教程）。</span><span class="sxs-lookup"><span data-stu-id="925a2-166">If an illegal value is entered for the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, or `ReorderLevel` fields, an `ArgumentException` will be thrown, as we added code to validate these field values in the `ProductsDataTable` class (see the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-vb.md) tutorial).</span></span>

<span data-ttu-id="925a2-167">我们可以通过基于所捕获异常的类型来对最终用户提供更有帮助的说明。</span><span class="sxs-lookup"><span data-stu-id="925a2-167">We can provide a more helpful explanation to the end user by basing the message text on the type of exception caught.</span></span> <span data-ttu-id="925a2-168">以下代码在[ASP.NET 页教程的处理 BLL 和 DAL 级别异常](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md)中完全相同的窗体中提供了这一级别的详细信息：</span><span class="sxs-lookup"><span data-stu-id="925a2-168">The following code which was used in a nearly identical form back in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) tutorial provides this level of detail:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample6.vb)]

<span data-ttu-id="925a2-169">若要完成本教程，只需从传入的 `Exception` 实例（`ex`）中 `Catch` 块调用 `DisplayExceptionDetails` 方法。</span><span class="sxs-lookup"><span data-stu-id="925a2-169">To complete this tutorial, simply call the `DisplayExceptionDetails` method from the `Catch` block passing in the caught `Exception` instance (`ex`).</span></span>

<span data-ttu-id="925a2-170">使用 `Try ... Catch` 块后，将向用户显示更丰富的错误消息，如图4和5所示。</span><span class="sxs-lookup"><span data-stu-id="925a2-170">With the `Try ... Catch` block in place, users are presented with a more informative error message, as Figures 4 and 5 show.</span></span> <span data-ttu-id="925a2-171">请注意，在遇到异常的情况下，DataList 仍处于编辑模式。</span><span class="sxs-lookup"><span data-stu-id="925a2-171">Note that in the face of an exception the DataList remains in edit mode.</span></span> <span data-ttu-id="925a2-172">这是因为，一旦发生异常，控制流立即被重定向到 `Catch` 块，绕过将 DataList 返回到其预编辑状态的代码。</span><span class="sxs-lookup"><span data-stu-id="925a2-172">This is because once the exception occurs, the control flow is immediately redirected to the `Catch` block, bypassing the code that returns the DataList to its pre-editing state.</span></span>

<span data-ttu-id="925a2-173">[![如果用户省略了必填字段，则显示一条错误消息](handling-bll-and-dal-level-exceptions-vb/_static/image9.png)](handling-bll-and-dal-level-exceptions-vb/_static/image8.png)</span><span class="sxs-lookup"><span data-stu-id="925a2-173">[![An Error Message is Displayed if a User Omits a Required Field](handling-bll-and-dal-level-exceptions-vb/_static/image9.png)](handling-bll-and-dal-level-exceptions-vb/_static/image8.png)</span></span>

<span data-ttu-id="925a2-174">**图 4**：如果用户省略了必填字段，将显示一条错误消息（[单击查看完全大小的图像](handling-bll-and-dal-level-exceptions-vb/_static/image10.png)）</span><span class="sxs-lookup"><span data-stu-id="925a2-174">**Figure 4**: An Error Message is Displayed if a User Omits a Required Field ([Click to view full-size image](handling-bll-and-dal-level-exceptions-vb/_static/image10.png))</span></span>

<span data-ttu-id="925a2-175">[在输入负价格时，会显示一条错误消息 ![](handling-bll-and-dal-level-exceptions-vb/_static/image12.png)](handling-bll-and-dal-level-exceptions-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="925a2-175">[![An Error Message is Displayed When Entering a Negative Price](handling-bll-and-dal-level-exceptions-vb/_static/image12.png)](handling-bll-and-dal-level-exceptions-vb/_static/image11.png)</span></span>

<span data-ttu-id="925a2-176">**图 5**：输入负价格时显示错误消息（[单击查看全尺寸图像](handling-bll-and-dal-level-exceptions-vb/_static/image13.png)）</span><span class="sxs-lookup"><span data-stu-id="925a2-176">**Figure 5**: An Error Message is Displayed When Entering a Negative Price ([Click to view full-size image](handling-bll-and-dal-level-exceptions-vb/_static/image13.png))</span></span>

## <a name="summary"></a><span data-ttu-id="925a2-177">总结</span><span class="sxs-lookup"><span data-stu-id="925a2-177">Summary</span></span>

<span data-ttu-id="925a2-178">GridView 和 ObjectDataSource 提供了后端事件处理程序，这些处理程序包括有关在更新和删除工作流期间引发的任何异常的信息，以及可设置为指示异常是否已被设置的属性。妥善.</span><span class="sxs-lookup"><span data-stu-id="925a2-178">The GridView and ObjectDataSource provide post-level event handlers that include information about any exceptions that were raised during the updating and deleting workflow, as well as properties that can be set to indicate whether or not the exception has been handled.</span></span> <span data-ttu-id="925a2-179">但是，在使用 DataList 并直接使用 BLL 时，这些功能不可用。</span><span class="sxs-lookup"><span data-stu-id="925a2-179">These features, however, are unavailable when working with the DataList and using the BLL directly.</span></span> <span data-ttu-id="925a2-180">相反，我们负责实现异常处理。</span><span class="sxs-lookup"><span data-stu-id="925a2-180">Instead, we are responsible for implementing exception handling.</span></span>

<span data-ttu-id="925a2-181">在本教程中，我们介绍了如何通过将 `Try ... Catch` 块添加到 `UpdateCommand` 事件处理程序，将异常处理添加到可编辑的 DataList s 更新工作流。</span><span class="sxs-lookup"><span data-stu-id="925a2-181">In this tutorial we saw how to add exception handling to an editable DataList s updating workflow by adding a `Try ... Catch` block to the `UpdateCommand` event handler.</span></span> <span data-ttu-id="925a2-182">如果在更新工作流的过程中引发了异常，则将执行 `Catch` 块代码，并在 `ExceptionDetails` 标签中显示有用的信息。</span><span class="sxs-lookup"><span data-stu-id="925a2-182">If an exception is raised during the updating workflow, the `Catch` block s code executes, displaying helpful information in the `ExceptionDetails` Label.</span></span>

<span data-ttu-id="925a2-183">此时，DataList 不会执行任何操作来防止异常发生在第一位。</span><span class="sxs-lookup"><span data-stu-id="925a2-183">At this point, the DataList makes no effort to prevent exceptions from happening in the first place.</span></span> <span data-ttu-id="925a2-184">尽管我们知道负价格将导致异常，但我们尚未添加任何功能来主动阻止用户输入此类无效输入。</span><span class="sxs-lookup"><span data-stu-id="925a2-184">Even though we know that a negative price will result in an exception, we haven't yet added any functionality to proactively prevent a user from entering such invalid input.</span></span> <span data-ttu-id="925a2-185">在下一教程中，我们将了解如何通过在 `EditItemTemplate`中添加验证控件来帮助减少因无效用户输入而导致的异常。</span><span class="sxs-lookup"><span data-stu-id="925a2-185">In our next tutorial we'll see how to help reduce the exceptions caused by invalid user input by adding validation controls in the `EditItemTemplate`.</span></span>

<span data-ttu-id="925a2-186">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="925a2-186">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="925a2-187">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="925a2-187">Further Reading</span></span>

<span data-ttu-id="925a2-188">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="925a2-188">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="925a2-189">异常的设计准则</span><span class="sxs-lookup"><span data-stu-id="925a2-189">Design Guidelines for Exceptions</span></span>](https://msdn.microsoft.com/library/ms298399.aspx)
- <span data-ttu-id="925a2-190">[错误日志记录模块和处理程序（ELMAH）](http://workspaces.gotdotnet.com/elmah) （用于记录错误的开源库）</span><span class="sxs-lookup"><span data-stu-id="925a2-190">[Error Logging Modules and Handlers (ELMAH)](http://workspaces.gotdotnet.com/elmah) (an open-source library for logging errors)</span></span>
- <span data-ttu-id="925a2-191">[.NET Framework 2.0 的企业库](https://www.microsoft.com/downloads/details.aspx?familyid=5A14E870-406B-4F2A-B723-97BA84AE80B5&amp;displaylang=en)（包括异常管理应用程序块）</span><span class="sxs-lookup"><span data-stu-id="925a2-191">[Enterprise Library for .NET Framework 2.0](https://www.microsoft.com/downloads/details.aspx?familyid=5A14E870-406B-4F2A-B723-97BA84AE80B5&amp;displaylang=en) (includes the Exception Management Application Block)</span></span>

## <a name="about-the-author"></a><span data-ttu-id="925a2-192">关于作者</span><span class="sxs-lookup"><span data-stu-id="925a2-192">About the Author</span></span>

<span data-ttu-id="925a2-193">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已在使用 Microsoft Web 技术，自1998开始。</span><span class="sxs-lookup"><span data-stu-id="925a2-193">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="925a2-194">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="925a2-194">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="925a2-195">他的最新书籍是，[*在24小时内，sam ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="925a2-195">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="925a2-196">可以[mitchell@4GuysFromRolla.com访问。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="925a2-196">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="925a2-197">或通过他的博客，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="925a2-197">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="925a2-198">特别感谢</span><span class="sxs-lookup"><span data-stu-id="925a2-198">Special Thanks To</span></span>

<span data-ttu-id="925a2-199">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="925a2-199">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="925a2-200">本教程的主管审查人员是 Ken Pespisa。</span><span class="sxs-lookup"><span data-stu-id="925a2-200">Lead reviewer for this tutorial was Ken Pespisa.</span></span> <span data-ttu-id="925a2-201">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="925a2-201">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="925a2-202">如果是这样，请在mitchell@4GuysFromRolla.com放置一行[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="925a2-202">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="925a2-203">[上一页](performing-batch-updates-vb.md)
> [下一页](adding-validation-controls-to-the-datalist-s-editing-interface-vb.md)</span><span class="sxs-lookup"><span data-stu-id="925a2-203">[Previous](performing-batch-updates-vb.md)
[Next](adding-validation-controls-to-the-datalist-s-editing-interface-vb.md)</span></span>
