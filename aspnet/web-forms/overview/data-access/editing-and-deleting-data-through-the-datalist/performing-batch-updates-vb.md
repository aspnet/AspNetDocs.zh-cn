---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
title: 执行批量更新（VB） |Microsoft Docs
author: rick-anderson
description: 了解如何创建完全可编辑的 DataList，其中所有项都处于编辑模式，并且可以通过单击上的 "全部更新" 按钮来保存其值。
ms.author: riande
ms.date: 10/30/2006
ms.assetid: 8dac22a7-91de-4e3b-888f-a4c438b03851
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
msc.type: authoredcontent
ms.openlocfilehash: e54c9fc12da278492b54164cf657eea142a3dae6
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78494750"
---
# <a name="performing-batch-updates-vb"></a><span data-ttu-id="95fcc-103">执行批量更新 (VB)</span><span class="sxs-lookup"><span data-stu-id="95fcc-103">Performing Batch Updates (VB)</span></span>

<span data-ttu-id="95fcc-104">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="95fcc-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="95fcc-105">[下载示例应用](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_37_VB.exe)或[下载 PDF](performing-batch-updates-vb/_static/datatutorial37vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="95fcc-105">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_37_VB.exe) or [Download PDF](performing-batch-updates-vb/_static/datatutorial37vb1.pdf)</span></span>

> <span data-ttu-id="95fcc-106">了解如何创建完全可编辑的 DataList，其中所有项都处于编辑模式，并且可以通过单击页面上的 "全部更新" 按钮来保存其值。</span><span class="sxs-lookup"><span data-stu-id="95fcc-106">Learn how to create a fully-editable DataList where all of its items are in edit mode and whose values can be saved by clicking an "Update All" button on the page.</span></span>

## <a name="introduction"></a><span data-ttu-id="95fcc-107">简介</span><span class="sxs-lookup"><span data-stu-id="95fcc-107">Introduction</span></span>

<span data-ttu-id="95fcc-108">在[前面的教程](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md)中，我们探讨了如何创建项级 DataList。</span><span class="sxs-lookup"><span data-stu-id="95fcc-108">In the [preceding tutorial](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md) we examined how to create an item-level DataList.</span></span> <span data-ttu-id="95fcc-109">与标准的可编辑 GridView 类似，DataList 中的每一项都包含一个编辑按钮，单击此按钮将使该项可编辑。</span><span class="sxs-lookup"><span data-stu-id="95fcc-109">Like the standard editable GridView, each item in the DataList included an Edit button that, when clicked, would make the item editable.</span></span> <span data-ttu-id="95fcc-110">尽管此项级编辑适用于仅偶尔更新的数据，但某些用例方案需要用户编辑多个记录。</span><span class="sxs-lookup"><span data-stu-id="95fcc-110">While this item-level editing works well for data that is only updated occasionally, certain use case scenarios require the user to edit many records.</span></span> <span data-ttu-id="95fcc-111">如果用户需要编辑数十个记录，并强制单击 "编辑"，进行更改，然后单击每个记录的 "更新"，则单击的量会妨碍她的工作效率。</span><span class="sxs-lookup"><span data-stu-id="95fcc-111">If a user needs to edit dozens of records and is forced to click Edit, make their changes, and click Update for each one, the amount of clicking can hamper her productivity.</span></span> <span data-ttu-id="95fcc-112">在这种情况下，更好的选择是提供一个完全可编辑的 DataList，其中的*所有*项目都处于编辑模式，并且可以通过单击页面上的 "全部更新" 按钮来编辑其值（请参阅图1）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-112">In such situations, a better option is to provide a fully-editable DataList, one where *all* of its items are in edit mode and whose values can be edited by clicking an Update All button on the page (see Figure 1).</span></span>

<span data-ttu-id="95fcc-113">[可以修改完全可编辑的 DataList 中的每个项 ![](performing-batch-updates-vb/_static/image2.png)](performing-batch-updates-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="95fcc-113">[![Each Item in a Fully Editable DataList can be Modified](performing-batch-updates-vb/_static/image2.png)](performing-batch-updates-vb/_static/image1.png)</span></span>

<span data-ttu-id="95fcc-114">**图 1**：可以修改完全可编辑的 DataList 中的每个项（[单击以查看完全大小的图像](performing-batch-updates-vb/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="95fcc-114">**Figure 1**: Each Item in a Fully Editable DataList can be Modified ([Click to view full-size image](performing-batch-updates-vb/_static/image3.png))</span></span>

<span data-ttu-id="95fcc-115">在本教程中，我们将探讨如何使用户能够使用完全可编辑的 DataList 更新供应商地址信息。</span><span class="sxs-lookup"><span data-stu-id="95fcc-115">In this tutorial we'll examine how to enable users to update suppliers address information using a fully editable DataList.</span></span>

## <a name="step-1-create-the-editable-user-interface-in-the-datalist-s-itemtemplate"></a><span data-ttu-id="95fcc-116">步骤1：在 DataList s ItemTemplate 中创建可编辑的用户界面</span><span class="sxs-lookup"><span data-stu-id="95fcc-116">Step 1: Create the Editable User Interface in the DataList s ItemTemplate</span></span>

<span data-ttu-id="95fcc-117">在前面的教程中，我们将创建一个标准的项级可编辑 DataList，其中使用了两个模板：</span><span class="sxs-lookup"><span data-stu-id="95fcc-117">In the preceding tutorial, where we creating a standard, item-level editable DataList, we used two templates:</span></span>

- <span data-ttu-id="95fcc-118">`ItemTemplate` 包含了只读用户界面（用于显示每个产品名称和价格的标签 Web 控件）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-118">`ItemTemplate` contained the read-only user interface (the Label Web controls for displaying each product s name and price).</span></span>
- <span data-ttu-id="95fcc-119">`EditItemTemplate` 包含编辑模式用户界面（两个 TextBox Web 控件）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-119">`EditItemTemplate` contained the edit mode user interface (the two TextBox Web controls).</span></span>

<span data-ttu-id="95fcc-120">DataList s `EditItemIndex` 属性决定使用 `EditItemTemplate`呈现哪些 `DataListItem` （如果有）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-120">The DataList s `EditItemIndex` property dictates what `DataListItem` (if any) is rendered using the `EditItemTemplate`.</span></span> <span data-ttu-id="95fcc-121">具体而言，`DataListItem` 的 `ItemIndex` 值与 DataList s `EditItemIndex` 属性匹配，则使用 `EditItemTemplate`进行呈现。</span><span class="sxs-lookup"><span data-stu-id="95fcc-121">In particular, the `DataListItem` whose `ItemIndex` value matches the DataList s `EditItemIndex` property is rendered using the `EditItemTemplate`.</span></span> <span data-ttu-id="95fcc-122">当一次只能编辑一个项，但在创建完全可编辑的 DataList 时，此模型的效果很好。</span><span class="sxs-lookup"><span data-stu-id="95fcc-122">This model works well when only one item can be edited at a time, but falls apart when creating a fully-editable DataList.</span></span>

<span data-ttu-id="95fcc-123">对于完全可编辑的 DataList，我们希望*所有 `DataListItem` 都*使用可编辑界面进行呈现。</span><span class="sxs-lookup"><span data-stu-id="95fcc-123">For a fully editable DataList, we want *all* of the `DataListItem` s to render using the editable interface.</span></span> <span data-ttu-id="95fcc-124">实现此目的的最简单方法是在 `ItemTemplate`中定义可编辑接口。</span><span class="sxs-lookup"><span data-stu-id="95fcc-124">The simplest way to accomplish this is to define the editable interface in the `ItemTemplate`.</span></span> <span data-ttu-id="95fcc-125">对于修改供应商地址信息，可编辑界面将供应商名称包含为文本，然后是地址、城市和国家/地区值的文本框。</span><span class="sxs-lookup"><span data-stu-id="95fcc-125">For modifying the suppliers address information, the editable interface contains the supplier name as text and then TextBoxes for the address, city, and country values.</span></span>

<span data-ttu-id="95fcc-126">首先打开 "`BatchUpdate.aspx`" 页，添加 "DataList" 控件，并将其 `ID` 属性设置为 "`Suppliers`"。</span><span class="sxs-lookup"><span data-stu-id="95fcc-126">Start by opening the `BatchUpdate.aspx` page, add a DataList control, and set its `ID` property to `Suppliers`.</span></span> <span data-ttu-id="95fcc-127">从 DataList s 智能标记中，选择添加名为 `SuppliersDataSource`的新 ObjectDataSource 控件。</span><span class="sxs-lookup"><span data-stu-id="95fcc-127">From the DataList s smart tag, opt to add a new ObjectDataSource control named `SuppliersDataSource`.</span></span>

<span data-ttu-id="95fcc-128">[![创建一个名为 SuppliersDataSource 的新 ObjectDataSource](performing-batch-updates-vb/_static/image5.png)](performing-batch-updates-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="95fcc-128">[![Create a New ObjectDataSource Named SuppliersDataSource](performing-batch-updates-vb/_static/image5.png)](performing-batch-updates-vb/_static/image4.png)</span></span>

<span data-ttu-id="95fcc-129">**图 2**：创建名为 `SuppliersDataSource` 的新 ObjectDataSource （[单击以查看完全大小的映像](performing-batch-updates-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="95fcc-129">**Figure 2**: Create a New ObjectDataSource Named `SuppliersDataSource` ([Click to view full-size image](performing-batch-updates-vb/_static/image6.png))</span></span>

<span data-ttu-id="95fcc-130">将 ObjectDataSource 配置为使用 `SuppliersBLL` 类 `GetSuppliers()` 方法检索数据（参见图3）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-130">Configure the ObjectDataSource to retrieve data using the `SuppliersBLL` class s `GetSuppliers()` method (see Figure 3).</span></span> <span data-ttu-id="95fcc-131">与前面的教程不同，我们将直接使用业务逻辑层，而不是通过 ObjectDataSource 更新供应商信息。</span><span class="sxs-lookup"><span data-stu-id="95fcc-131">As with the preceding tutorial, rather than updating the supplier information through the ObjectDataSource, we'll work directly with the Business Logic Layer.</span></span> <span data-ttu-id="95fcc-132">因此，请在 "更新" 选项卡中将下拉列表设置为 "（无）" （参见图4）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-132">Therefore, set the drop-down list to (None) in the UPDATE tab (see Figure 4).</span></span>

<span data-ttu-id="95fcc-133">[![使用 GetSuppliers （）方法检索供应商信息](performing-batch-updates-vb/_static/image8.png)](performing-batch-updates-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="95fcc-133">[![Retrieve Supplier Information Using the GetSuppliers() Method](performing-batch-updates-vb/_static/image8.png)](performing-batch-updates-vb/_static/image7.png)</span></span>

<span data-ttu-id="95fcc-134">**图 3**：使用 `GetSuppliers()` 方法检索供应商信息（[单击以查看完全大小的图像](performing-batch-updates-vb/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="95fcc-134">**Figure 3**: Retrieve Supplier Information Using the `GetSuppliers()` Method ([Click to view full-size image](performing-batch-updates-vb/_static/image9.png))</span></span>

<span data-ttu-id="95fcc-135">[![在 "更新" 选项卡中将下拉列表设置为 "（无）"](performing-batch-updates-vb/_static/image11.png)](performing-batch-updates-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="95fcc-135">[![Set the Drop-Down List to (None) in the UPDATE Tab](performing-batch-updates-vb/_static/image11.png)](performing-batch-updates-vb/_static/image10.png)</span></span>

<span data-ttu-id="95fcc-136">**图 4**：在 "更新" 选项卡中将下拉列表设置为 "（无）" （[单击查看完全大小的图像](performing-batch-updates-vb/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="95fcc-136">**Figure 4**: Set the Drop-Down List to (None) in the UPDATE Tab ([Click to view full-size image](performing-batch-updates-vb/_static/image12.png))</span></span>

<span data-ttu-id="95fcc-137">完成向导后，Visual Studio 会自动生成 DataList s `ItemTemplate` 以显示标签 Web 控件中由数据源返回的每个数据字段。</span><span class="sxs-lookup"><span data-stu-id="95fcc-137">After completing the wizard, Visual Studio automatically generates the DataList s `ItemTemplate` to display each data field returned by the data source in a Label Web control.</span></span> <span data-ttu-id="95fcc-138">我们需要修改此模板，使其改为提供编辑界面。</span><span class="sxs-lookup"><span data-stu-id="95fcc-138">We need to modify this template so that it provides the editing interface instead.</span></span> <span data-ttu-id="95fcc-139">通过使用 DataList s 智能标记中的 "编辑模板" 选项或直接通过声明性语法，可以通过设计器自定义 `ItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="95fcc-139">The `ItemTemplate` can be customized through the Designer using the Edit Templates option from the DataList s smart tag or directly through the declarative syntax.</span></span>

<span data-ttu-id="95fcc-140">花点时间创建一个编辑界面，该界面将供应商姓名显示为文本，但包含供应商地址、城市和国家/地区值的文本框。</span><span class="sxs-lookup"><span data-stu-id="95fcc-140">Take a moment to create an editing interface that displays the supplier s name as text, but includes TextBoxes for the supplier s address, city, and country values.</span></span> <span data-ttu-id="95fcc-141">进行这些更改后，页的声明性语法应类似于以下形式：</span><span class="sxs-lookup"><span data-stu-id="95fcc-141">After making these changes, your page s declarative syntax should look similar to the following:</span></span>

[!code-aspx[Main](performing-batch-updates-vb/samples/sample1.aspx)]

> [!NOTE]
> <span data-ttu-id="95fcc-142">与前面的教程一样，本教程中的 DataList 必须启用其视图状态。</span><span class="sxs-lookup"><span data-stu-id="95fcc-142">As with the preceding tutorial, the DataList in this tutorial must have its view state enabled.</span></span>

<span data-ttu-id="95fcc-143">在 `ItemTemplate` I m 使用两个新的 CSS 类 `SupplierPropertyLabel` 和 `SupplierPropertyValue`，已添加到 `Styles.css` 类并配置为使用与 `ProductPropertyLabel` 和 `ProductPropertyValue` CSS 类相同的样式设置。</span><span class="sxs-lookup"><span data-stu-id="95fcc-143">In the `ItemTemplate` I m using two new CSS classes, `SupplierPropertyLabel` and `SupplierPropertyValue`, which have been added to the `Styles.css` class and configured to use the same style settings as the `ProductPropertyLabel` and `ProductPropertyValue` CSS classes.</span></span>

[!code-css[Main](performing-batch-updates-vb/samples/sample2.css)]

<span data-ttu-id="95fcc-144">进行这些更改后，请通过浏览器访问此页。</span><span class="sxs-lookup"><span data-stu-id="95fcc-144">After making these changes, visit this page through a browser.</span></span> <span data-ttu-id="95fcc-145">如图5所示，每个 DataList 项都将供应商名称显示为文本，并使用文本框显示地址、城市和国家/地区。</span><span class="sxs-lookup"><span data-stu-id="95fcc-145">As Figure 5 shows, each DataList item displays the supplier name as text and uses TextBoxes to display the address, city, and country.</span></span>

<span data-ttu-id="95fcc-146">[DataList 中的每个供应商都可编辑 ![](performing-batch-updates-vb/_static/image14.png)](performing-batch-updates-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="95fcc-146">[![Each Supplier in the DataList is Editable](performing-batch-updates-vb/_static/image14.png)](performing-batch-updates-vb/_static/image13.png)</span></span>

<span data-ttu-id="95fcc-147">**图 5**： DataList 中的每个供应商都是可编辑的（[单击以查看完全大小的图像](performing-batch-updates-vb/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="95fcc-147">**Figure 5**: Each Supplier in the DataList is Editable ([Click to view full-size image](performing-batch-updates-vb/_static/image15.png))</span></span>

## <a name="step-2-adding-an-update-all-button"></a><span data-ttu-id="95fcc-148">步骤2：添加 "全部更新" 按钮</span><span class="sxs-lookup"><span data-stu-id="95fcc-148">Step 2: Adding an Update All Button</span></span>

<span data-ttu-id="95fcc-149">虽然图5中的每个供应商都在文本框中显示 "地址"、"城市" 和 "国家/地区" 字段，但目前没有可用的 "更新" 按钮。</span><span class="sxs-lookup"><span data-stu-id="95fcc-149">While each supplier in Figure 5 has its address, city, and country fields displayed in a TextBox, there currently is no Update button available.</span></span> <span data-ttu-id="95fcc-150">通常，页面上只会有一个 "全部更新" 按钮，在单击该按钮时，会更新 DataList 中的*所有*记录，而不是每项使用 "更新" 按钮。</span><span class="sxs-lookup"><span data-stu-id="95fcc-150">Rather than having an Update button per item, with fully editable DataLists there is typically a single Update All button on the page that, when clicked, updates *all* of the records in the DataList.</span></span> <span data-ttu-id="95fcc-151">在本教程中，我们将添加两个 "全部更新" 按钮-一个位于页面顶部，另一个按钮位于底部（尽管单击任一按钮都将具有相同的效果）。</span><span class="sxs-lookup"><span data-stu-id="95fcc-151">For this tutorial, let s add two Update All buttons - one at the top of the page and one at the bottom (although clicking either button will have the same effect).</span></span>

<span data-ttu-id="95fcc-152">首先将一个按钮 Web 控件添加到 DataList 上方，然后将其 `ID` 属性设置为 `UpdateAll1`。</span><span class="sxs-lookup"><span data-stu-id="95fcc-152">Start by adding a Button Web control above the DataList and set its `ID` property to `UpdateAll1`.</span></span> <span data-ttu-id="95fcc-153">接下来，将第二个按钮 Web 控件添加到 DataList 下，并将其 `ID` 设置为 `UpdateAll2`。</span><span class="sxs-lookup"><span data-stu-id="95fcc-153">Next, add the second Button Web control beneath the DataList, setting its `ID` to `UpdateAll2`.</span></span> <span data-ttu-id="95fcc-154">设置两个按钮的 `Text` 属性以更新所有按钮。</span><span class="sxs-lookup"><span data-stu-id="95fcc-154">Set the `Text` properties for the two Buttons to Update All.</span></span> <span data-ttu-id="95fcc-155">最后，为两个按钮 `Click` 事件创建事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="95fcc-155">Lastly, create event handlers for both Buttons `Click` events.</span></span> <span data-ttu-id="95fcc-156">我们不是在每个事件处理程序中复制更新逻辑，而是将该逻辑重构为第三个方法，`UpdateAllSupplierAddresses`，让事件处理程序只调用此第三种方法。</span><span class="sxs-lookup"><span data-stu-id="95fcc-156">Rather than duplicating the update logic in each of the event handlers, let s refactor that logic to a third method, `UpdateAllSupplierAddresses`, having the event handlers simply invoking this third method.</span></span>

[!code-vb[Main](performing-batch-updates-vb/samples/sample3.vb)]

<span data-ttu-id="95fcc-157">图6显示了 "更新所有" 按钮添加后的页面。</span><span class="sxs-lookup"><span data-stu-id="95fcc-157">Figure 6 shows the page after the Update All buttons have been added.</span></span>

<span data-ttu-id="95fcc-158">[已将两个更新全部按钮添加到页面中 ![](performing-batch-updates-vb/_static/image17.png)](performing-batch-updates-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="95fcc-158">[![Two Update All Buttons have been Added to the Page](performing-batch-updates-vb/_static/image17.png)](performing-batch-updates-vb/_static/image16.png)</span></span>

<span data-ttu-id="95fcc-159">**图 6**：已将两个 "更新" 按钮添加到页面（[单击查看完全尺寸的图像](performing-batch-updates-vb/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="95fcc-159">**Figure 6**: Two Update All Buttons have been Added to the Page ([Click to view full-size image](performing-batch-updates-vb/_static/image18.png))</span></span>

## <a name="step-3-updating-all-of-the-suppliers-address-information"></a><span data-ttu-id="95fcc-160">步骤3：更新所有供应商地址信息</span><span class="sxs-lookup"><span data-stu-id="95fcc-160">Step 3: Updating All of the Suppliers Address Information</span></span>

<span data-ttu-id="95fcc-161">所有 DataList 项都显示编辑界面，并添加了 "全部更新" 按钮，剩下的就是编写代码来执行批更新。</span><span class="sxs-lookup"><span data-stu-id="95fcc-161">With all of the DataList s items displaying the editing interface and with the addition of the Update All buttons, all that remains is writing the code to perform the batch update.</span></span> <span data-ttu-id="95fcc-162">具体而言，我们需要遍历 DataList 项，并为每个项调用 `SuppliersBLL` 类的 `UpdateSupplierAddress` 方法。</span><span class="sxs-lookup"><span data-stu-id="95fcc-162">Specifically, we need to loop through the DataList s items and call the `SuppliersBLL` class s `UpdateSupplierAddress` method for each one.</span></span>

<span data-ttu-id="95fcc-163">构成 DataList 的 `DataListItem` 实例的集合可以通过 DataList s [`Items` 属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.items.aspx)进行访问。</span><span class="sxs-lookup"><span data-stu-id="95fcc-163">The collection of `DataListItem` instances that makeup the DataList can be accessed via the DataList s [`Items` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.items.aspx).</span></span> <span data-ttu-id="95fcc-164">引用 `DataListItem`后，可以从 `DataKeys` 集合中获取相应的 `SupplierID`，并以编程方式引用 `ItemTemplate` 中的 TextBox Web 控件，如以下代码所示：</span><span class="sxs-lookup"><span data-stu-id="95fcc-164">With a reference to a `DataListItem`, we can grab the corresponding `SupplierID` from the `DataKeys` collection and programmatically reference the TextBox Web controls within the `ItemTemplate` as the following code illustrates:</span></span>

[!code-vb[Main](performing-batch-updates-vb/samples/sample4.vb)]

<span data-ttu-id="95fcc-165">当用户单击其中一个 "全部更新" 按钮时，`UpdateAllSupplierAddresses` 方法将循环访问 `Suppliers` DataList 中的每个 `DataListItem`，并调用 `SuppliersBLL` 类 `UpdateSupplierAddress` 方法，并传入相应的值。</span><span class="sxs-lookup"><span data-stu-id="95fcc-165">When the user clicks one of the Update All buttons, the `UpdateAllSupplierAddresses` method iterates through each `DataListItem` in the `Suppliers` DataList and calls the `SuppliersBLL` class s `UpdateSupplierAddress` method, passing in the corresponding values.</span></span> <span data-ttu-id="95fcc-166">"地址"、"城市" 或 "国家/地区" 传递的非输入值是 `Nothing` `UpdateSupplierAddress` 的值（而不是空字符串），这会导致数据库 `NULL` 基础记录 s 字段。</span><span class="sxs-lookup"><span data-stu-id="95fcc-166">A non-entered value for address, city, or country passes is a value of `Nothing` to `UpdateSupplierAddress` (rather than a blank string), which results in a database `NULL` for the underlying record s fields.</span></span>

> [!NOTE]
> <span data-ttu-id="95fcc-167">作为增强功能，您可能需要将状态标签 Web 控件添加到在执行批更新之后提供了一些确认消息的页面。</span><span class="sxs-lookup"><span data-stu-id="95fcc-167">As an enhancement, you may want to add a status Label Web control to the page that provides some confirmation message after the batch update is performed.</span></span>

## <a name="updating-only-those-addresses-that-have-been-modified"></a><span data-ttu-id="95fcc-168">仅更新那些已修改的地址</span><span class="sxs-lookup"><span data-stu-id="95fcc-168">Updating Only Those Addresses That Have Been Modified</span></span>

<span data-ttu-id="95fcc-169">用于本教程的批处理更新算法将为 DataList 中的*每个*供应商调用 `UpdateSupplierAddress` 方法，而不考虑其地址信息是否已更改。</span><span class="sxs-lookup"><span data-stu-id="95fcc-169">The batch update algorithm used for this tutorial calls the `UpdateSupplierAddress` method for *every* supplier in the DataList, regardless of whether their address information has been changed.</span></span> <span data-ttu-id="95fcc-170">尽管此类直接更新并不是性能问题，但如果您对数据库表进行了审核更改，它们可能会导致不需要的记录。</span><span class="sxs-lookup"><span data-stu-id="95fcc-170">While such blind updates aren't usually a performance issue, they can lead to superfluous records if you re auditing changes to the database table.</span></span> <span data-ttu-id="95fcc-171">例如，如果使用触发器将所有 `UPDATE` `Suppliers` s 记录到审核表，则每次用户单击 "全部更新" 按钮时，系统将为系统中的每个供应商创建一个新的审核记录，而不管用户是否进行了任何更改。</span><span class="sxs-lookup"><span data-stu-id="95fcc-171">For example, if you use triggers to record all `UPDATE` s to the `Suppliers` table to an auditing table, every time a user clicks the Update All button a new audit record will be created for each supplier in the system, regardless of whether the user made any changes.</span></span>

<span data-ttu-id="95fcc-172">ADO.NET DataTable 和 DataAdapter 类的设计目的是支持批更新，在这种情况下，仅修改、删除和新记录会导致任何数据库通信。</span><span class="sxs-lookup"><span data-stu-id="95fcc-172">The ADO.NET DataTable and DataAdapter classes are designed to support batch updates where only modified, deleted, and new records results in any database communication.</span></span> <span data-ttu-id="95fcc-173">DataTable 中的每一行都有一个[`RowState` 属性](https://msdn.microsoft.com/library/system.data.datarow.rowstate.aspx)，该属性指示行是添加到 DataTable、从其删除、修改还是保持不变。</span><span class="sxs-lookup"><span data-stu-id="95fcc-173">Each row in the DataTable has a [`RowState` property](https://msdn.microsoft.com/library/system.data.datarow.rowstate.aspx) that indicates whether the row has been added to the DataTable, deleted from it, modified, or remains unchanged.</span></span> <span data-ttu-id="95fcc-174">最初填充 DataTable 时，所有行都将被标记为保持不变。</span><span class="sxs-lookup"><span data-stu-id="95fcc-174">When a DataTable is initially populated, all rows are marked unchanged.</span></span> <span data-ttu-id="95fcc-175">更改任意行的列的值会将该行标记为已修改。</span><span class="sxs-lookup"><span data-stu-id="95fcc-175">Changing the value of any of the row s columns marks the row as modified.</span></span>

<span data-ttu-id="95fcc-176">在 `SuppliersBLL` 类中，我们将通过先将单个供应商记录读入 `SuppliersDataTable`，然后使用以下代码设置 `Address`、`City`和 `Country` 列值，来更新指定的供应商地址信息：</span><span class="sxs-lookup"><span data-stu-id="95fcc-176">In the `SuppliersBLL` class we update the specified supplier s address information by first reading in the single supplier record into a `SuppliersDataTable` and then set the `Address`, `City`, and `Country` column values using the following code:</span></span>

[!code-vb[Main](performing-batch-updates-vb/samples/sample5.vb)]

<span data-ttu-id="95fcc-177">此代码 naively 将传入的地址、城市和国家/地区值分配到 `SuppliersDataTable` 中的 `SuppliersRow`，无论这些值是否已更改。</span><span class="sxs-lookup"><span data-stu-id="95fcc-177">This code naively assigns the passed-in address, city, and country values to the `SuppliersRow` in the `SuppliersDataTable` regardless of whether or not the values have changed.</span></span> <span data-ttu-id="95fcc-178">这些修改将导致 `SuppliersRow` 的 `RowState` 属性标记为已修改。</span><span class="sxs-lookup"><span data-stu-id="95fcc-178">These modifications cause the `SuppliersRow` s `RowState` property to be marked as modified.</span></span> <span data-ttu-id="95fcc-179">调用数据访问层的 `Update` 方法时，它会看到 `SupplierRow` 已被修改，因此会将 `UPDATE` 命令发送到数据库。</span><span class="sxs-lookup"><span data-stu-id="95fcc-179">When the Data Access Layer s `Update` method is called, it sees that the `SupplierRow` has been modified and therefore sends an `UPDATE` command to the database.</span></span>

<span data-ttu-id="95fcc-180">但是，假设我们向此方法添加了代码，以便仅分配传入的地址、城市和国家/地区值，因为它们不同于 `SuppliersRow` 的现有值。</span><span class="sxs-lookup"><span data-stu-id="95fcc-180">Imagine, however, that we added code to this method to only assign the passed-in address, city, and country values if they differ from the `SuppliersRow` s existing values.</span></span> <span data-ttu-id="95fcc-181">如果地址、城市和国家/地区与现有数据相同，则不会进行更改，并且 `SupplierRow` 的 `RowState` 将被标记为 "未更改"。</span><span class="sxs-lookup"><span data-stu-id="95fcc-181">In the case where the address, city, and country are the same as the existing data, no changes will be made and the `SupplierRow` s `RowState` will be left marked as unchanged.</span></span> <span data-ttu-id="95fcc-182">最终的结果是，当调用 DAL s `Update` 方法时，不会进行任何数据库调用，因为 `SuppliersRow` 尚未修改。</span><span class="sxs-lookup"><span data-stu-id="95fcc-182">The net result is that when the DAL s `Update` method is called, no database call will be made because the `SuppliersRow` has not been modified.</span></span>

<span data-ttu-id="95fcc-183">若要执行此更改，请将以下代码替换为传入的地址、城市和国家/地区值，并将其替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="95fcc-183">To enact this change, replace the statements that blindly assign the passed-in address, city, and country values with the following code:</span></span>

[!code-vb[Main](performing-batch-updates-vb/samples/sample6.vb)]

<span data-ttu-id="95fcc-184">使用此添加的代码，DAL s `Update` 方法仅将 `UPDATE` 语句发送到数据库，以获取与地址相关的值已更改的那些记录。</span><span class="sxs-lookup"><span data-stu-id="95fcc-184">With this added code, the DAL s `Update` method sends an `UPDATE` statement to the database for only those records whose address-related values have changed.</span></span>

<span data-ttu-id="95fcc-185">此外，我们还可以跟踪传入地址字段与数据库数据之间是否存在任何差异，如果没有，只需绕过对 DAL s `Update` 方法的调用。</span><span class="sxs-lookup"><span data-stu-id="95fcc-185">Alternatively, we could keep track of whether there are any differences between the passed-in address fields and the database data and, if there are none, simply bypass the call to the DAL s `Update` method.</span></span> <span data-ttu-id="95fcc-186">如果你重新使用 DB 直接方法，则此方法非常适用，因为 DB 直接方法不会传递一个 `SuppliersRow` 实例，该实例的 `RowState` 可以进行检查以确定是否确实需要数据库调用。</span><span class="sxs-lookup"><span data-stu-id="95fcc-186">This approach works well if you re using the DB direct method, since the DB direct method isn t passed a `SuppliersRow` instance whose `RowState` can be checked to determine whether a database call is actually needed.</span></span>

> [!NOTE]
> <span data-ttu-id="95fcc-187">每次调用 `UpdateSupplierAddress` 方法时，对数据库进行调用以检索有关已更新记录的信息。</span><span class="sxs-lookup"><span data-stu-id="95fcc-187">Each time the `UpdateSupplierAddress` method is invoked, a call is made to the database to retrieve information about the updated record.</span></span> <span data-ttu-id="95fcc-188">如果数据有任何更改，则会对数据库进行另一次调用以更新表行。</span><span class="sxs-lookup"><span data-stu-id="95fcc-188">Then, if there are any changes in data, another call to the database is made to update the table row.</span></span> <span data-ttu-id="95fcc-189">此工作流可以通过创建 `UpdateSupplierAddress` 方法重载来进行优化，该重载接受 `BatchUpdate.aspx` 页中*所有*更改的 `EmployeesDataTable` 实例。</span><span class="sxs-lookup"><span data-stu-id="95fcc-189">This workflow could be optimized by creating an `UpdateSupplierAddress` method overload that accepts an `EmployeesDataTable` instance that has *all* of the changes from the `BatchUpdate.aspx` page.</span></span> <span data-ttu-id="95fcc-190">然后，它可以调用数据库以获取 `Suppliers` 表中的所有记录。</span><span class="sxs-lookup"><span data-stu-id="95fcc-190">Then, it could make one call to the database to get all of the records from the `Suppliers` table.</span></span> <span data-ttu-id="95fcc-191">然后，可以枚举这两个结果集，并且只能更新发生更改的记录。</span><span class="sxs-lookup"><span data-stu-id="95fcc-191">The two resultsets could then be enumerated and only those records where changes have occurred could be updated.</span></span>

## <a name="summary"></a><span data-ttu-id="95fcc-192">摘要</span><span class="sxs-lookup"><span data-stu-id="95fcc-192">Summary</span></span>

<span data-ttu-id="95fcc-193">在本教程中，我们了解了如何创建完全可编辑的 DataList，使用户能够快速修改多个供应商的地址信息。</span><span class="sxs-lookup"><span data-stu-id="95fcc-193">In this tutorial we saw how to create a fully editable DataList, allowing a user to quickly modify the address information for multiple suppliers.</span></span> <span data-ttu-id="95fcc-194">首先，我们为 DataList s `ItemTemplate`中的供应商地址、城市和国家/地区值定义了编辑界面。</span><span class="sxs-lookup"><span data-stu-id="95fcc-194">We started by defining the editing interface a TextBox Web control for the supplier s address, city, and country values in the DataList s `ItemTemplate`.</span></span> <span data-ttu-id="95fcc-195">接下来，我们添加了 "更新" DataList 上方和下方的所有按钮。</span><span class="sxs-lookup"><span data-stu-id="95fcc-195">Next, we added Update All buttons above and below the DataList.</span></span> <span data-ttu-id="95fcc-196">用户进行了更改，并单击了 "全部更新" 按钮之一后，会枚举 `DataListItem`，并对 `SuppliersBLL` 类 `UpdateSupplierAddress` 方法进行调用。</span><span class="sxs-lookup"><span data-stu-id="95fcc-196">After a user has made his changes and clicked one of the Update All buttons, the `DataListItem` s are enumerated and a call to the `SuppliersBLL` class s `UpdateSupplierAddress` method is made.</span></span>

<span data-ttu-id="95fcc-197">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="95fcc-197">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="95fcc-198">关于作者</span><span class="sxs-lookup"><span data-stu-id="95fcc-198">About the Author</span></span>

<span data-ttu-id="95fcc-199">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已在使用 Microsoft Web 技术，自1998开始。</span><span class="sxs-lookup"><span data-stu-id="95fcc-199">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="95fcc-200">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="95fcc-200">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="95fcc-201">他的最新书籍是，[*在24小时内，sam ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="95fcc-201">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="95fcc-202">可以[mitchell@4GuysFromRolla.com访问。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="95fcc-202">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="95fcc-203">或通过他的博客，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="95fcc-203">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="95fcc-204">特别感谢</span><span class="sxs-lookup"><span data-stu-id="95fcc-204">Special Thanks To</span></span>

<span data-ttu-id="95fcc-205">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="95fcc-205">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="95fcc-206">本教程的领导评审者是 Zack 和 Ken Pespisa。</span><span class="sxs-lookup"><span data-stu-id="95fcc-206">Lead reviewers for this tutorial were Zack Jones and Ken Pespisa.</span></span> <span data-ttu-id="95fcc-207">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="95fcc-207">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="95fcc-208">如果是这样，请在mitchell@4GuysFromRolla.com放置一行[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="95fcc-208">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="95fcc-209">[上一页](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md)
> [下一页](handling-bll-and-dal-level-exceptions-vb.md)</span><span class="sxs-lookup"><span data-stu-id="95fcc-209">[Previous](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md)
[Next](handling-bll-and-dal-level-exceptions-vb.md)</span></span>
