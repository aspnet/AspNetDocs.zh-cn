---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: 实现乐观并发使用 SqlDataSource (C#) |Microsoft Docs
author: rick-anderson
description: 在本教程中我们会查看的乐观并发控制 essentials，然后探索如何实现使用 SqlDataSource 控件。
ms.author: riande
ms.date: 02/20/2007
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 6569f8e8f11bb67bc0723908225c7fd663a845b3
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/25/2019
ms.locfileid: "58423952"
---
<a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="17d6a-103">使用 SqlDataSource 实现乐观并发 (C#)</span><span class="sxs-lookup"><span data-stu-id="17d6a-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>
====================
<span data-ttu-id="17d6a-104">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="17d6a-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="17d6a-105">[下载示例应用程序](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe)或[下载 PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="17d6a-105">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="17d6a-106">在本教程中我们会查看的乐观并发控制 essentials，然后探索如何实现使用 SqlDataSource 控件。</span><span class="sxs-lookup"><span data-stu-id="17d6a-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>


## <a name="introduction"></a><span data-ttu-id="17d6a-107">介绍</span><span class="sxs-lookup"><span data-stu-id="17d6a-107">Introduction</span></span>

<span data-ttu-id="17d6a-108">在前面的教程中，我们将探讨如何添加插入、 更新和删除 SqlDataSource 控件的功能。</span><span class="sxs-lookup"><span data-stu-id="17d6a-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="17d6a-109">简单地说，要提供这些功能我们需要指定相应`INSERT`， `UPDATE`，或`DELETE`控件 s 中的 SQL 语句`InsertCommand`， `UpdateCommand`，或`DeleteCommand`属性以及相应中的参数`InsertParameters`， `UpdateParameters`，和`DeleteParameters`集合。</span><span class="sxs-lookup"><span data-stu-id="17d6a-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="17d6a-110">尽管可以手动指定这些属性和集合，配置数据源向导 s 高级的按钮提供了生成`INSERT`， `UPDATE`，和`DELETE`语句复选框，将自动创建这些语句基于`SELECT`语句。</span><span class="sxs-lookup"><span data-stu-id="17d6a-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="17d6a-111">与生成一起`INSERT`， `UPDATE`，和`DELETE`语句复选框，高级 SQL 生成选项对话框中包括使用开放式并发选项 （请参阅图 1）。</span><span class="sxs-lookup"><span data-stu-id="17d6a-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="17d6a-112">选中之后，`WHERE`子句中自动生成`UPDATE`和`DELETE`语句经过修改，以仅执行更新或删除如果自用户上次到网格中加载数据以来尚未修改基础数据库数据。</span><span class="sxs-lookup"><span data-stu-id="17d6a-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn't been modified since the user last loaded the data into the grid.</span></span>


![可以添加乐观并发支持从高级 SQL 生成选项对话框](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="17d6a-114">**图 1**:可以添加乐观并发支持从高级 SQL 生成选项对话框</span><span class="sxs-lookup"><span data-stu-id="17d6a-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>


<span data-ttu-id="17d6a-115">回到[实现乐观并发](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md)教程中，我们探讨乐观并发控制和如何将其添加到对象数据源的基础知识。</span><span class="sxs-lookup"><span data-stu-id="17d6a-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="17d6a-116">在本教程中我们将进行修饰的乐观并发控制 essentials 上，然后了解如何使用 SqlDataSource 实现。</span><span class="sxs-lookup"><span data-stu-id="17d6a-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="17d6a-117">简要概述乐观并发</span><span class="sxs-lookup"><span data-stu-id="17d6a-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="17d6a-118">Web 应用程序允许多个用户同时使用，以编辑或删除相同的数据，存在一个用户可能会意外覆盖另一个 s 更改的可能性。</span><span class="sxs-lookup"><span data-stu-id="17d6a-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="17d6a-119">在中[实现乐观并发](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md)教程中，我提供了下面的示例：</span><span class="sxs-lookup"><span data-stu-id="17d6a-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="17d6a-120">想象一下，两个用户，Jisun 和 Sam，同时也已访问的应用程序允许访问者以更新和删除产品通过 GridView 控件中页。</span><span class="sxs-lookup"><span data-stu-id="17d6a-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="17d6a-121">同时单击编辑按钮 Chai 时间大致相同。</span><span class="sxs-lookup"><span data-stu-id="17d6a-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="17d6a-122">Jisun 更改为 Chai 茶的产品名称，并单击更新按钮。</span><span class="sxs-lookup"><span data-stu-id="17d6a-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="17d6a-123">最终结果是`UPDATE`语句发送到数据库，这会设置*所有*的产品 s 可更新字段 (即使 Jisun 仅更新一个字段， `ProductName`)。</span><span class="sxs-lookup"><span data-stu-id="17d6a-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="17d6a-124">在此时间点，数据库包含值 Chai 茶，类别饮料，供应商特殊液体等用于此特定产品。</span><span class="sxs-lookup"><span data-stu-id="17d6a-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="17d6a-125">但是，Sam 的屏幕上 GridView 仍显示产品名称可编辑的 GridView 行中为 Chai。</span><span class="sxs-lookup"><span data-stu-id="17d6a-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="17d6a-126">几秒钟后 Jisun 的更改已提交，Sam 调味品到更新类别，并单击更新。</span><span class="sxs-lookup"><span data-stu-id="17d6a-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="17d6a-127">这会导致`UPDATE`语句发送到的数据库的产品名称设置为 Chai，`CategoryID`到相应的调味品类别 ID 和等等。</span><span class="sxs-lookup"><span data-stu-id="17d6a-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="17d6a-128">Jisun 的更改到的产品名称已被覆盖。</span><span class="sxs-lookup"><span data-stu-id="17d6a-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="17d6a-129">图 2 说明了这种交互。</span><span class="sxs-lookup"><span data-stu-id="17d6a-129">Figure 2 illustrates this interaction.</span></span>


<span data-ttu-id="17d6a-130">[![两个用户同时更新记录时那里一个用户 s 可能更改覆盖其他 s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="17d6a-131">**图 2**:当两个用户同时更新的记录那里 s 可能覆盖对其他更改的一个用户 s ([单击此项可查看原尺寸图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>


<span data-ttu-id="17d6a-132">若要防止这种情况下打开的窗体[并发控制](http://en.wikipedia.org/wiki/Concurrency_control)必须实现。</span><span class="sxs-lookup"><span data-stu-id="17d6a-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="17d6a-133">[乐观并发](http://en.wikipedia.org/wiki/Optimistic_concurrency_control)焦点本教程适用于假设可能偶尔会，并发冲突那里时，大多数情况下不会产生此类冲突。</span><span class="sxs-lookup"><span data-stu-id="17d6a-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise.</span></span> <span data-ttu-id="17d6a-134">因此，如果确实会发生冲突，乐观并发控制只需将通知用户其更改-无法进行保存，因为另一个用户已修改相同的数据。</span><span class="sxs-lookup"><span data-stu-id="17d6a-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="17d6a-135">对于其中假定将是许多并发冲突或者如果此类冲突不容许的应用程序，然后悲观并发控制可以改用。</span><span class="sxs-lookup"><span data-stu-id="17d6a-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="17d6a-136">回头[实现乐观并发](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md)教程，了解在保守式并发控制的更深入讨论。</span><span class="sxs-lookup"><span data-stu-id="17d6a-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>


<span data-ttu-id="17d6a-137">乐观并发控制的工作原理是确保要更新或删除的记录具有相同的值，像以前那样也随之更新或删除进程启动时。</span><span class="sxs-lookup"><span data-stu-id="17d6a-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="17d6a-138">例如，单击编辑按钮可编辑的 GridView 中后，记录的值将从数据库读取并显示在文本框和其他 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="17d6a-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="17d6a-139">GridView 情况保存这些原始值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="17d6a-140">更高版本之后用户使她的更改，并单击更新按钮，,`UPDATE`使用语句必须考虑原始值加上的新值并仅更新底层数据库记录，如果原始值的用户已开始编辑是仍在数据库中的值相同的。</span><span class="sxs-lookup"><span data-stu-id="17d6a-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="17d6a-141">图 3 描绘了这一序列的事件。</span><span class="sxs-lookup"><span data-stu-id="17d6a-141">Figure 3 depicts this sequence of events.</span></span>


<span data-ttu-id="17d6a-142">[![若要成功执行 Update 或 Delete，对于原始值必须等于当前的数据库值](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="17d6a-143">**图 3**:适用于更新或删除直至成功，原始值必须为等于当前的数据库值 ([单击此项可查看原尺寸图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>


<span data-ttu-id="17d6a-144">有多种方法实现乐观并发 (请参阅[Peter A.Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)的[乐观并发更新逻辑](http://www.eggheadcafe.com/articles/20050719.asp)的简要介绍一下使用多种)。</span><span class="sxs-lookup"><span data-stu-id="17d6a-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="17d6a-145">使用 SqlDataSource （以及 ADO.NET 类型化数据集在我们的数据访问层中使用） 的方法增强`WHERE`子句，以包括所有原始值的比较。</span><span class="sxs-lookup"><span data-stu-id="17d6a-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="17d6a-146">以下`UPDATE`语句，例如，更新的名称和产品的价格仅当当前的数据库值是否等于更新 GridView 中的记录时最初检索到的值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="17d6a-147">`@ProductName`并`@UnitPrice`参数包含由用户输入的新值，而`@original_ProductName`和`@original_UnitPrice`包含最初加载到了 GridView 时单击编辑按钮的值：</span><span class="sxs-lookup"><span data-stu-id="17d6a-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="17d6a-148">我们将看到在本教程中，启用乐观并发控制使用 SqlDataSource 是像选中一个复选框一样简单。</span><span class="sxs-lookup"><span data-stu-id="17d6a-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="17d6a-149">步骤 1：创建 SqlDataSource 支持乐观并发</span><span class="sxs-lookup"><span data-stu-id="17d6a-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="17d6a-150">首先打开`OptimisticConcurrency.aspx`页上从`SqlDataSource`文件夹。</span><span class="sxs-lookup"><span data-stu-id="17d6a-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="17d6a-151">将一个 SqlDataSource 控件从工具箱拖到设计器中，设置其`ID`属性设置为`ProductsDataSourceWithOptimisticConcurrency`。</span><span class="sxs-lookup"><span data-stu-id="17d6a-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="17d6a-152">接下来，单击控件 s 智能标记中的配置数据源链接。</span><span class="sxs-lookup"><span data-stu-id="17d6a-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="17d6a-153">从向导中的第一个屏幕，选择要使用`NORTHWINDConnectionString`单击下一步。</span><span class="sxs-lookup"><span data-stu-id="17d6a-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>


<span data-ttu-id="17d6a-154">[![选择以使用 NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="17d6a-155">**图 4**:选择与工作`NORTHWINDConnectionString`([单击以查看实际尺寸的图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>


<span data-ttu-id="17d6a-156">此示例中我们将添加一个 GridView，使用户能够编辑`Products`表。</span><span class="sxs-lookup"><span data-stu-id="17d6a-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="17d6a-157">因此，从配置 Select 语句屏幕中，选择`Products`表从下拉列表，然后选择`ProductID`， `ProductName`， `UnitPrice`，和`Discontinued`列，如图 5 中所示。</span><span class="sxs-lookup"><span data-stu-id="17d6a-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>


<span data-ttu-id="17d6a-158">[![在产品表中，返回 ProductID、 ProductName、 UnitPrice 和已停止使用的列](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="17d6a-159">**图 5**:从`Products`表中，返回`ProductID`， `ProductName`， `UnitPrice`，并`Discontinued`列 ([单击以查看实际尺寸的图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>


<span data-ttu-id="17d6a-160">列后，单击高级按钮以打开高级 SQL 生成选项对话框。</span><span class="sxs-lookup"><span data-stu-id="17d6a-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="17d6a-161">检查生成`INSERT`， `UPDATE`，和`DELETE`语句并使用乐观并发复选框，然后单击确定 （回头参考图 1 屏幕截图）。</span><span class="sxs-lookup"><span data-stu-id="17d6a-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="17d6a-162">通过单击下一步，完成该向导，然后完成。</span><span class="sxs-lookup"><span data-stu-id="17d6a-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="17d6a-163">完成配置数据源向导后，请花费片刻时间来检查生成`DeleteCommand`并`UpdateCommand`属性和`DeleteParameters`和`UpdateParameters`集合。</span><span class="sxs-lookup"><span data-stu-id="17d6a-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="17d6a-164">若要执行此操作的最简单方法是单击左下角以查看页面 s 声明性语法中的源选项卡。</span><span class="sxs-lookup"><span data-stu-id="17d6a-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="17d6a-165">可以在其中找到`UpdateCommand`的值：</span><span class="sxs-lookup"><span data-stu-id="17d6a-165">There you will find an `UpdateCommand` value of:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="17d6a-166">使用中的七个参数`UpdateParameters`集合：</span><span class="sxs-lookup"><span data-stu-id="17d6a-166">With seven parameters in the `UpdateParameters` collection:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="17d6a-167">同样，`DeleteCommand`属性和`DeleteParameters`集合应如下所示：</span><span class="sxs-lookup"><span data-stu-id="17d6a-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="17d6a-168">有益补充`WHERE`子句`UpdateCommand`和`DeleteCommand`属性 （并将其他参数添加到各自的参数集合），选择使用乐观并发选项调整其他两个属性：</span><span class="sxs-lookup"><span data-stu-id="17d6a-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="17d6a-169">更改[`ConflictDetection`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx)从`OverwriteChanges`（默认值） 到 `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="17d6a-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="17d6a-170">更改[`OldValuesParameterFormatString`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx)从{0}（默认值） 到原始图像\_{0} 。</span><span class="sxs-lookup"><span data-stu-id="17d6a-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="17d6a-171">当数据 Web 控件调用 SqlDataSource s`Update()`或`Delete()`方法，它将传入的原始值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="17d6a-172">如果 SqlDataSource s`ConflictDetection`属性设置为`CompareAllValues`，这些原始值添加到该命令。</span><span class="sxs-lookup"><span data-stu-id="17d6a-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="17d6a-173">`OldValuesParameterFormatString`属性提供了用于这些原始值参数的命名模式。</span><span class="sxs-lookup"><span data-stu-id="17d6a-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="17d6a-174">配置数据源向导将使用原始\_{0}并将在每个原始参数`UpdateCommand`并`DeleteCommand`属性并`UpdateParameters`和`DeleteParameters`集合相应地。</span><span class="sxs-lookup"><span data-stu-id="17d6a-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="17d6a-175">因为我们不使用 SqlDataSource 控件 s 插入功能，可以删除`InsertCommand`属性并将其`InsertParameters`集合。</span><span class="sxs-lookup"><span data-stu-id="17d6a-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>


## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="17d6a-176">正确处理`NULL`值</span><span class="sxs-lookup"><span data-stu-id="17d6a-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="17d6a-177">遗憾的是，增强`UPDATE`并`DELETE`语句自动生成的配置数据源向导使用乐观并发时不要*不*记录，其中包含与工作`NULL`值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="17d6a-178">要了解原因，请考虑我们 SqlDataSource 的`UpdateCommand`:</span><span class="sxs-lookup"><span data-stu-id="17d6a-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="17d6a-179">`UnitPrice`中的列`Products`表可以有`NULL`值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="17d6a-180">如果特定的记录都`NULL`值`UnitPrice`，则`WHERE`子句部分`[UnitPrice] = @original_UnitPrice`会*始终*计算结果为 False，因为`NULL = NULL`始终返回 False。</span><span class="sxs-lookup"><span data-stu-id="17d6a-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="17d6a-181">因此，它包含的记录`NULL`值不能编辑或删除，作为`UPDATE`并`DELETE`语句`WHERE`子句不会返回任何行来更新或删除。</span><span class="sxs-lookup"><span data-stu-id="17d6a-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won't return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="17d6a-182">此 bug 第一次报告给 Microsoft 在 2004 年 6 月的中[SqlDataSource 生成错误的 SQL 语句](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937)和据说计划在下一版本的 ASP.NET 中予以解决。</span><span class="sxs-lookup"><span data-stu-id="17d6a-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>


<span data-ttu-id="17d6a-183">若要解决此问题，我们必须手动更新`WHERE`子句中同时`UpdateCommand`并`DeleteCommand`属性**所有**列可以具有`NULL`值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="17d6a-184">一般情况下，更改`[ColumnName] = @original_ColumnName`到：</span><span class="sxs-lookup"><span data-stu-id="17d6a-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="17d6a-185">此修改可直接通过声明性标记中，通过从属性窗口的 UpdateQuery 或 DeleteQuery 选项或通过更新和删除自定义 SQL 语句或存储的过程中配置数据的选项中指定的选项卡源向导。</span><span class="sxs-lookup"><span data-stu-id="17d6a-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="17d6a-186">同样，必须进行此修改*每个*中的列`UpdateCommand`并`DeleteCommand`s`WHERE`子句可以包含`NULL`值。</span><span class="sxs-lookup"><span data-stu-id="17d6a-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="17d6a-187">将此应用到我们的示例生成以下修改`UpdateCommand`和`DeleteCommand`值：</span><span class="sxs-lookup"><span data-stu-id="17d6a-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="17d6a-188">步骤 2：添加 GridView 编辑和删除选项</span><span class="sxs-lookup"><span data-stu-id="17d6a-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="17d6a-189">使用 SqlDataSource 配置为支持乐观并发，所有的就是将数据 Web 控件添加到页面，它利用此并发控制。</span><span class="sxs-lookup"><span data-stu-id="17d6a-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="17d6a-190">对于本教程，让我们来添加一个 GridView，提供了这两个编辑和删除的功能。</span><span class="sxs-lookup"><span data-stu-id="17d6a-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="17d6a-191">若要完成此操作，将 GridView 从工具箱拖到设计器和组及其`ID`到`Products`。</span><span class="sxs-lookup"><span data-stu-id="17d6a-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="17d6a-192">从 GridView s 智能标记，将其绑定到`ProductsDataSourceWithOptimisticConcurrency`SqlDataSource 控件添加在步骤 1 中。</span><span class="sxs-lookup"><span data-stu-id="17d6a-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="17d6a-193">最后，检查从智能标记的启用编辑和启用删除选项。</span><span class="sxs-lookup"><span data-stu-id="17d6a-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>


<span data-ttu-id="17d6a-194">[![将 GridView 绑定到 SqlDataSource 和支持编辑和删除](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="17d6a-195">**图 6**:将 GridView 绑定到 SqlDataSource 和启用编辑和删除 ([单击此项可查看原尺寸图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>


<span data-ttu-id="17d6a-196">添加 GridView 后, 通过删除来配置它的外观`ProductID`更改 BoundField `ProductName` BoundField s`HeaderText`属性设置为产品和更新`UnitPrice`BoundField，以便其`HeaderText`属性只需价格。</span><span class="sxs-lookup"><span data-stu-id="17d6a-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="17d6a-197">理想情况下，我们 d 增强编辑界面要包括的 RequiredFieldValidator`ProductName`值和为 CompareValidator`UnitPrice`值 （以确保它 s 格式正确的数字值）。</span><span class="sxs-lookup"><span data-stu-id="17d6a-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="17d6a-198">请参阅[自定义数据修改界面](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md)教程，了解更深入了解如何自定义编辑界面的 GridView s。</span><span class="sxs-lookup"><span data-stu-id="17d6a-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="17d6a-199">必须启用 s 视图状态，因为 GridView 从 SqlDataSource 到传递的原始值是的 GridView 视图中存储状态。</span><span class="sxs-lookup"><span data-stu-id="17d6a-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>


<span data-ttu-id="17d6a-200">以后进行这些修改到 GridView，GridView 和 SqlDataSource 声明性标记看起来应类似于下面：</span><span class="sxs-lookup"><span data-stu-id="17d6a-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="17d6a-201">若要查看操作中的乐观并发控制，打开两个浏览器窗口，并加载`OptimisticConcurrency.aspx`在这两页。</span><span class="sxs-lookup"><span data-stu-id="17d6a-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="17d6a-202">单击两个浏览器中的第一个产品的编辑按钮。</span><span class="sxs-lookup"><span data-stu-id="17d6a-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="17d6a-203">在一个浏览器中更改产品名称并单击更新。</span><span class="sxs-lookup"><span data-stu-id="17d6a-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="17d6a-204">在浏览器将回发和 GridView 将返回到其预先编辑模式，其中显示刚编辑的记录的新产品名称。</span><span class="sxs-lookup"><span data-stu-id="17d6a-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="17d6a-205">在第二个浏览器窗口中，更改 （但保留其原始值形式的产品名称） 的价格，并单击更新。</span><span class="sxs-lookup"><span data-stu-id="17d6a-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="17d6a-206">在回发时，网格将返回到其预先编辑模式，但对价格的更改不会记录。</span><span class="sxs-lookup"><span data-stu-id="17d6a-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="17d6a-207">第二个浏览器中显示相同的值的第一个新的产品名称与旧的价格。</span><span class="sxs-lookup"><span data-stu-id="17d6a-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="17d6a-208">在第二个浏览器窗口中所做的更改已丢失。</span><span class="sxs-lookup"><span data-stu-id="17d6a-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="17d6a-209">此外，所做的更改已丢失而安静模式，因为没有任何异常或消息，指示只发生了并发冲突。</span><span class="sxs-lookup"><span data-stu-id="17d6a-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>


<span data-ttu-id="17d6a-210">[![第二个浏览器窗口中的更改是以无提示方式丢失](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="17d6a-211">**图 7**:在第二个浏览器窗口已以无提示方式丢失的更改 ([单击此项可查看原尺寸图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>


<span data-ttu-id="17d6a-212">为什么未提交的第二个浏览器的更改的原因是因为`UPDATE`语句的`WHERE`子句筛选出所有记录，因此未影响任何行。</span><span class="sxs-lookup"><span data-stu-id="17d6a-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="17d6a-213">让我们来看一下`UPDATE`再次语句：</span><span class="sxs-lookup"><span data-stu-id="17d6a-213">Let s look at the `UPDATE` statement again:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="17d6a-214">当第二个浏览器窗口中更新的记录时，原始产品名称中指定`WHERE`子句没有 t 匹配会与现有的产品名称 （因为它进行了更改的第一个浏览器）。</span><span class="sxs-lookup"><span data-stu-id="17d6a-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="17d6a-215">因此，该语句`[ProductName] = @original_ProductName`将返回 False，和`UPDATE`不会影响任何记录。</span><span class="sxs-lookup"><span data-stu-id="17d6a-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="17d6a-216">Delete 的工作方式相同的方式。</span><span class="sxs-lookup"><span data-stu-id="17d6a-216">Delete works in the same manner.</span></span> <span data-ttu-id="17d6a-217">使用两个打开的浏览器窗口，首先编辑使用其中一个，给定的产品，然后保存其更改。</span><span class="sxs-lookup"><span data-stu-id="17d6a-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="17d6a-218">在保存后所做的更改在一个浏览器中，单击同一中的其他产品的删除按钮。</span><span class="sxs-lookup"><span data-stu-id="17d6a-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="17d6a-219">由于原始值 don t 中匹配`DELETE`语句的`WHERE`子句中，删除以静默方式失败。</span><span class="sxs-lookup"><span data-stu-id="17d6a-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>


<span data-ttu-id="17d6a-220">从最终用户 s 的角度在第二个浏览器窗口中，单击网格中的更新按钮返回到预先编辑模式，但他们的更改已丢失。</span><span class="sxs-lookup"><span data-stu-id="17d6a-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="17d6a-221">但是，这里 s 他们的更改不坚持没有可视反馈。</span><span class="sxs-lookup"><span data-stu-id="17d6a-221">However, there s no visual feedback that their changes didn't stick.</span></span> <span data-ttu-id="17d6a-222">理想情况下，如果用户的更改都将丢失到并发冲突，我们 d 通知他们并，这样一来，保留在编辑模式下的网格。</span><span class="sxs-lookup"><span data-stu-id="17d6a-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="17d6a-223">让我们来看看如何实现此目的。</span><span class="sxs-lookup"><span data-stu-id="17d6a-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="17d6a-224">步骤 3：确定当发生并发冲突</span><span class="sxs-lookup"><span data-stu-id="17d6a-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="17d6a-225">由于并发冲突，拒绝了一个具有所做的更改就好了并发冲突发生时向用户发出警报。</span><span class="sxs-lookup"><span data-stu-id="17d6a-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="17d6a-226">向用户发出警报，让的标签 Web 控件添加到名为页面顶部`ConcurrencyViolationMessage`其`Text`属性将显示以下消息：已尝试更新或删除已由另一个用户同时更新的记录。</span><span class="sxs-lookup"><span data-stu-id="17d6a-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="17d6a-227">请查看其他用户更改然后重做你的更新或删除。</span><span class="sxs-lookup"><span data-stu-id="17d6a-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="17d6a-228">设置标签控件 s`CssClass`属性设置为警告，这是一个 CSS 类中定义`Styles.css`以红色、 斜体、 粗体和大字体显示文本。</span><span class="sxs-lookup"><span data-stu-id="17d6a-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="17d6a-229">最后，设置标签 s`Visible`并`EnableViewState`属性设置为`false`。</span><span class="sxs-lookup"><span data-stu-id="17d6a-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="17d6a-230">这将隐藏除仅位置显式设置这些回发的标签及其`Visible`属性设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="17d6a-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>


<span data-ttu-id="17d6a-231">[![将标签控件添加到页后，可以显示该警告](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="17d6a-232">**图 8**:将标签控件添加到显示该警告的页 ([单击此项可查看原尺寸图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>


<span data-ttu-id="17d6a-233">当执行更新或删除，GridView s`RowUpdated`和`RowDeleted`其数据源控件已执行的请求的更新或删除后，会激发事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="17d6a-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="17d6a-234">我们可以确定多少行受影响的从这些事件处理程序执行的操作。</span><span class="sxs-lookup"><span data-stu-id="17d6a-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="17d6a-235">如果受影响的零行，我们想要显示`ConcurrencyViolationMessage`标签。</span><span class="sxs-lookup"><span data-stu-id="17d6a-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="17d6a-236">为两者创建事件处理程序`RowUpdated`和`RowDeleted`事件，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="17d6a-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>


[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="17d6a-237">在这两个事件处理程序中，我们检查`e.AffectedRows`属性，如果它等于 0，设置`ConcurrencyViolationMessage`标签 s`Visible`属性设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="17d6a-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="17d6a-238">在中`RowUpdated`事件处理程序，我们还指示 GridView 继续处于编辑模式下通过设置`KeepInEditMode`属性设为 true。</span><span class="sxs-lookup"><span data-stu-id="17d6a-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="17d6a-239">在此过程中，我们需要重新绑定到网格的数据，以便其他用户的数据加载到编辑界面。</span><span class="sxs-lookup"><span data-stu-id="17d6a-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="17d6a-240">这通过调用 GridView s 实现`DataBind()`方法。</span><span class="sxs-lookup"><span data-stu-id="17d6a-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="17d6a-241">如图 9 所示，使用这些两个事件处理程序中，每次发生并发冲突时显示非常明显的消息。</span><span class="sxs-lookup"><span data-stu-id="17d6a-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>


<span data-ttu-id="17d6a-242">[![在遇到并发冲突时显示一条消息](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="17d6a-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="17d6a-243">**图 9**:在遇到并发冲突时显示一条消息 ([单击此项可查看原尺寸图像](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="17d6a-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="17d6a-244">总结</span><span class="sxs-lookup"><span data-stu-id="17d6a-244">Summary</span></span>

<span data-ttu-id="17d6a-245">创建 web 应用程序时其中多个并发用户可能正在编辑相同的数据，务必要考虑并发控制选项。</span><span class="sxs-lookup"><span data-stu-id="17d6a-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="17d6a-246">默认情况下，ASP.NET 数据 Web 控件和数据源控件不使用任何并发控制。</span><span class="sxs-lookup"><span data-stu-id="17d6a-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="17d6a-247">正如我们看到在本教程中，实现乐观并发控制使用 SqlDataSource 是相当快速和方便。</span><span class="sxs-lookup"><span data-stu-id="17d6a-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="17d6a-248">SqlDataSource 处理大部分先为你添加扩充`WHERE`自动生成的子句`UPDATE`并`DELETE`但没有语句是在处理一些微妙之处`NULL`值列，如中所述正确处理`NULL`值部分。</span><span class="sxs-lookup"><span data-stu-id="17d6a-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="17d6a-249">本教程最后，我们检查 SqlDataSource。</span><span class="sxs-lookup"><span data-stu-id="17d6a-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="17d6a-250">我们提供剩余的教程将返回到使用 ObjectDataSource 和分层体系结构处理数据。</span><span class="sxs-lookup"><span data-stu-id="17d6a-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="17d6a-251">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="17d6a-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="17d6a-252">关于作者</span><span class="sxs-lookup"><span data-stu-id="17d6a-252">About the Author</span></span>

<span data-ttu-id="17d6a-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)的七个部 asp/ASP.NET 书籍并创办了作者[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年以来一直致力于 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="17d6a-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="17d6a-254">Scott 是独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="17d6a-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="17d6a-255">他最新著作是[ *Sams Teach 自己 ASP.NET 2.0 24 小时内*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="17d6a-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="17d6a-256">他可以到达[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="17d6a-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="17d6a-257">或通过他的博客，其中，请参阅[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="17d6a-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="17d6a-258">[上一页](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
> [下一页](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="17d6a-258">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
