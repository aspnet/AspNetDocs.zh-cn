---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/configuring-the-data-access-layer-s-connection-and-command-level-settings-cs
title: 配置数据访问层的连接和命令级别设置（C#） |Microsoft Docs
author: rick-anderson
description: 类型化数据集中的 Tableadapter 自动处理与数据库的连接、发出命令，并使用结果填充 DataTable 。
ms.author: riande
ms.date: 08/03/2007
ms.assetid: cd330dd9-6254-4305-9351-dd727384c83b
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/configuring-the-data-access-layer-s-connection-and-command-level-settings-cs
msc.type: authoredcontent
ms.openlocfilehash: 8fe7a5a2e410b47c8c2be62851f2b7b775d60209
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78444386"
---
# <a name="configuring-the-data-access-layers-connection--and-command-level-settings-c"></a><span data-ttu-id="7d714-103">配置数据访问层的连接和命令级别的设置 (C#)</span><span class="sxs-lookup"><span data-stu-id="7d714-103">Configuring the Data Access Layer's Connection- and Command-Level Settings (C#)</span></span>

<span data-ttu-id="7d714-104">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="7d714-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="7d714-105">[下载代码](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_72_CS.zip)或[下载 PDF](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/datatutorial72cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="7d714-105">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_72_CS.zip) or [Download PDF](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/datatutorial72cs1.pdf)</span></span>

> <span data-ttu-id="7d714-106">类型化数据集中的 Tableadapter 自动处理与数据库的连接、发出命令，并使用结果填充 DataTable。</span><span class="sxs-lookup"><span data-stu-id="7d714-106">The TableAdapters within a Typed DataSet automatically take care of connecting to the database, issuing commands, and populating a DataTable with the results.</span></span> <span data-ttu-id="7d714-107">但在某些情况下，我们希望自己处理这些详细信息，在本教程中，我们将了解如何访问 TableAdapter 中的数据库连接和命令级别设置。</span><span class="sxs-lookup"><span data-stu-id="7d714-107">There are occasions however when we want to take care of these details ourselves, and in this tutorial we learn how to access the database connection- and command-level settings in the TableAdapter.</span></span>

## <a name="introduction"></a><span data-ttu-id="7d714-108">简介</span><span class="sxs-lookup"><span data-stu-id="7d714-108">Introduction</span></span>

<span data-ttu-id="7d714-109">在本系列教程中，我们使用了类型化的数据集来实现分层体系结构的数据访问层和业务对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-109">Throughout the tutorial series we have used Typed DataSets to implement the Data Access Layer and business objects of our layered architecture.</span></span> <span data-ttu-id="7d714-110">如[第一个教程](../introduction/creating-a-data-access-layer-cs.md)中所述，类型化数据集的数据表用作数据存储库，而 tableadapter 充当包装器，用于与数据库进行通信以检索和修改基础数据。</span><span class="sxs-lookup"><span data-stu-id="7d714-110">As discussed in the [first tutorial](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet s DataTables serve as repositories of data whereas the TableAdapters act as wrappers to communicate with the database to retrieve and modify the underlying data.</span></span> <span data-ttu-id="7d714-111">Tableadapter 封装了处理数据库所涉及的复杂性，使我们不必编写代码来连接到数据库、发出命令，或将结果填充到 DataTable。</span><span class="sxs-lookup"><span data-stu-id="7d714-111">The TableAdapters encapsulate the complexity involved in working with the database and saves us from having to write code to connect to the database, issue a command, or populate the results into a DataTable.</span></span>

<span data-ttu-id="7d714-112">但有时，当我们需要 burrow 到 TableAdapter 的深度并编写直接与 ADO.NET 对象结合使用的代码时。</span><span class="sxs-lookup"><span data-stu-id="7d714-112">There are times, however, when we need to burrow into the depths of the TableAdapter and write code that works directly with the ADO.NET objects.</span></span> <span data-ttu-id="7d714-113">例如，在[事务中包装数据库的修改](../working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs.md)教程中，我们将方法添加到了用于开始、提交和回滚 ADO.NET 事务的 TableAdapter。</span><span class="sxs-lookup"><span data-stu-id="7d714-113">In the [Wrapping Database Modifications within a Transaction](../working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs.md) tutorial, for example, we added methods to the TableAdapter for beginning, committing, and rolling back ADO.NET transactions.</span></span> <span data-ttu-id="7d714-114">这些方法使用了内部手动创建的 `SqlTransaction` 对象，该对象已分配给 TableAdapter s `SqlCommand` 对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-114">These methods used an internal, manually-created `SqlTransaction` object that was assigned to the TableAdapter s `SqlCommand` objects.</span></span>

<span data-ttu-id="7d714-115">在本教程中，我们将检查如何访问 TableAdapter 中的数据库连接和命令级别设置。</span><span class="sxs-lookup"><span data-stu-id="7d714-115">In this tutorial we will examine how to access the database connection- and command-level settings in the TableAdapter.</span></span> <span data-ttu-id="7d714-116">具体而言，我们将向 `ProductsTableAdapter` 添加功能，以便能够访问基础连接字符串和命令超时设置。</span><span class="sxs-lookup"><span data-stu-id="7d714-116">In particular, we will add functionality to the `ProductsTableAdapter` that enables access to the underlying connection string and command timeout settings.</span></span>

## <a name="working-with-data-using-adonet"></a><span data-ttu-id="7d714-117">使用 ADO.NET 处理数据</span><span class="sxs-lookup"><span data-stu-id="7d714-117">Working with Data Using ADO.NET</span></span>

<span data-ttu-id="7d714-118">Microsoft .NET 框架包含专门用于处理数据的类的很多。</span><span class="sxs-lookup"><span data-stu-id="7d714-118">The Microsoft .NET Framework contains a plethora of classes designed specifically to work with data.</span></span> <span data-ttu-id="7d714-119">在[`System.Data` 命名空间](https://msdn.microsoft.com/library/system.data.aspx)中找到的这些类称为*ADO.NET*类。</span><span class="sxs-lookup"><span data-stu-id="7d714-119">These classes, found within the [`System.Data` namespace](https://msdn.microsoft.com/library/system.data.aspx), are referred to as the *ADO.NET* classes.</span></span> <span data-ttu-id="7d714-120">ADO.NET 伞下的某些类与特定*数据访问接口*相关联。</span><span class="sxs-lookup"><span data-stu-id="7d714-120">Some of the classes under the ADO.NET umbrella are tied to a particular *data provider*.</span></span> <span data-ttu-id="7d714-121">你可以将数据访问接口看作是一种信道，它允许信息在 ADO.NET 类和基础数据存储之间流动。</span><span class="sxs-lookup"><span data-stu-id="7d714-121">You can think of a data provider as a communication channel that allows information to flow between the ADO.NET classes and the underlying data store.</span></span> <span data-ttu-id="7d714-122">有一些通用化提供程序，如 OleDb 和 ODBC，以及专门为特定数据库系统设计的提供程序。</span><span class="sxs-lookup"><span data-stu-id="7d714-122">There are generalized providers, like OleDb and ODBC, as well as providers that are specially designed for a particular database system.</span></span> <span data-ttu-id="7d714-123">例如，虽然可以使用 OleDb 访问接口连接到 Microsoft SQL Server 数据库，但 SqlClient 提供程序的工作效率要高得多，因为它专门针对 SQL Server 设计和优化。</span><span class="sxs-lookup"><span data-stu-id="7d714-123">For example, while it is possible to connect to a Microsoft SQL Server database using the OleDb provider, the SqlClient provider is much more efficient as it was designed and optimized specifically for SQL Server.</span></span>

<span data-ttu-id="7d714-124">以编程方式访问数据时，通常使用以下模式：</span><span class="sxs-lookup"><span data-stu-id="7d714-124">When programmatically accessing data, the following pattern is commonly used:</span></span>

- <span data-ttu-id="7d714-125">建立与数据库的连接。</span><span class="sxs-lookup"><span data-stu-id="7d714-125">Establish a connection to the database.</span></span>
- <span data-ttu-id="7d714-126">发出命令。</span><span class="sxs-lookup"><span data-stu-id="7d714-126">Issue a command.</span></span>
- <span data-ttu-id="7d714-127">对于 `SELECT` 查询，请使用生成的记录。</span><span class="sxs-lookup"><span data-stu-id="7d714-127">For `SELECT` queries, work with the resulting records.</span></span>

<span data-ttu-id="7d714-128">每个步骤都有单独的 ADO.NET 类。</span><span class="sxs-lookup"><span data-stu-id="7d714-128">There are separate ADO.NET classes for performing each of these steps.</span></span> <span data-ttu-id="7d714-129">例如，若要使用 SqlClient 提供程序连接到数据库，请使用[`SqlConnection` 类](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="7d714-129">To connect to a database using the SqlClient provider, for example, use the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection(VS.80).aspx).</span></span> <span data-ttu-id="7d714-130">若要向数据库发出 `INSERT`、`UPDATE`、`DELETE`或 `SELECT` 命令，请使用[`SqlCommand` 类](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.aspx)。</span><span class="sxs-lookup"><span data-stu-id="7d714-130">To issue an `INSERT`, `UPDATE`, `DELETE`, or `SELECT` command to the database, use the [`SqlCommand` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.aspx).</span></span>

<span data-ttu-id="7d714-131">除了在[事务教程内包装数据库修改](../working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs.md)之外，我们还无需编写任何低级别的 ADO.NET 代码，因为 tableadapter 自动生成的代码包括连接到数据库所需的功能、发出命令、检索数据和将数据填充到数据表。</span><span class="sxs-lookup"><span data-stu-id="7d714-131">Except for the [Wrapping Database Modifications within a Transaction](../working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs.md) tutorial, we have not had to write any low-level ADO.NET code ourselves because the TableAdapters auto-generated code includes the functionality needed to connect to the database, issue commands, retrieve data, and populate that data into DataTables.</span></span> <span data-ttu-id="7d714-132">不过，有时我们需要自定义这些低级别设置。</span><span class="sxs-lookup"><span data-stu-id="7d714-132">However, there may be times when we need to customize these low-level settings.</span></span> <span data-ttu-id="7d714-133">在接下来的几个步骤中，我们将探讨如何使用 Tableadapter 内部使用的 ADO.NET 对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-133">Over the next few steps we will examine how to tap into the ADO.NET objects used internally by the TableAdapters.</span></span>

## <a name="step-1-examining-with-the-connection-property"></a><span data-ttu-id="7d714-134">步骤1：通过连接属性进行检查</span><span class="sxs-lookup"><span data-stu-id="7d714-134">Step 1: Examining with the Connection Property</span></span>

<span data-ttu-id="7d714-135">每个 TableAdapter 类都有一个指定数据库连接信息的 `Connection` 属性。</span><span class="sxs-lookup"><span data-stu-id="7d714-135">Each TableAdapter class has a `Connection` property that specifies database connection information.</span></span> <span data-ttu-id="7d714-136">此属性的数据类型和 `ConnectionString` 值由在 "TableAdapter 配置向导" 中所做的选择决定。</span><span class="sxs-lookup"><span data-stu-id="7d714-136">This property s data type and `ConnectionString` value are determined by the selections made in the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="7d714-137">请记住，当我们首次将 TableAdapter 添加到类型化数据集时，此向导会向我们询问数据库源（请参阅图1）。</span><span class="sxs-lookup"><span data-stu-id="7d714-137">Recall that when we first add a TableAdapter to a Typed DataSet this wizard asks us for the database source (see Figure 1).</span></span> <span data-ttu-id="7d714-138">此第一步中的下拉列表包含在配置文件中指定的这些数据库以及服务器资源管理器的数据连接中的任何其他数据库。</span><span class="sxs-lookup"><span data-stu-id="7d714-138">The drop-down list in this first step includes those databases specified in the configuration file as well as any other databases in the Server Explorer s Data Connections.</span></span> <span data-ttu-id="7d714-139">如果下拉列表中不存在要使用的数据库，则可以通过单击 "新建连接" 按钮并提供所需的连接信息，来指定新的数据库连接。</span><span class="sxs-lookup"><span data-stu-id="7d714-139">If the database we want to use does not exist in the drop-down list, a new database connection can be specified by clicking the New Connection button and providing the needed connection information.</span></span>

<span data-ttu-id="7d714-140">[![TableAdapter 配置向导的第一步](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image2.png)](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="7d714-140">[![The First Step of the TableAdapter Configuration Wizard](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image2.png)](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image1.png)</span></span>

<span data-ttu-id="7d714-141">**图 1**： TableAdapter 配置向导的第一步（[单击查看完全大小的映像](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="7d714-141">**Figure 1**: The First Step of the TableAdapter Configuration Wizard ([Click to view full-size image](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image3.png))</span></span>

<span data-ttu-id="7d714-142">让我们花点时间来检查 TableAdapter s `Connection` 属性的代码。</span><span class="sxs-lookup"><span data-stu-id="7d714-142">Let s take a moment to inspect the code for the TableAdapter s `Connection` property.</span></span> <span data-ttu-id="7d714-143">如[创建数据访问层](../introduction/creating-a-data-access-layer-cs.md)教程中所述，我们可以通过转到 "类视图" 窗口查看自动生成的 TableAdapter 代码，向下钻取到相应的类，然后双击成员名称。</span><span class="sxs-lookup"><span data-stu-id="7d714-143">As noted in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial, we can view the auto-generated TableAdapter code by going to the Class View window, drilling down to the appropriate class, and then double-clicking the member name.</span></span>

<span data-ttu-id="7d714-144">转到 "视图" 菜单，然后选择 "类视图" （或通过键入 Ctrl + Shift + C），导航到 "类视图" 窗口。</span><span class="sxs-lookup"><span data-stu-id="7d714-144">Navigate to the Class View window by going to the View menu and choosing Class View (or by typing Ctrl+Shift+C).</span></span> <span data-ttu-id="7d714-145">在类视图窗口的上半部分，向下钻取到 `NorthwindTableAdapters` 命名空间，然后选择 `ProductsTableAdapter` 类。</span><span class="sxs-lookup"><span data-stu-id="7d714-145">From the top half of the Class View window, drill down to the `NorthwindTableAdapters` namespace and select the `ProductsTableAdapter` class.</span></span> <span data-ttu-id="7d714-146">这会在类视图的下半部分显示 `ProductsTableAdapter` 成员，如图2所示。</span><span class="sxs-lookup"><span data-stu-id="7d714-146">This will display the `ProductsTableAdapter` s members in the bottom half of the Class View, as shown in Figure 2.</span></span> <span data-ttu-id="7d714-147">双击 `Connection` 属性以查看其代码。</span><span class="sxs-lookup"><span data-stu-id="7d714-147">Double-click the `Connection` property to see its code.</span></span>

![双击 "类视图中的连接属性以查看其自动生成的代码](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image4.png)

<span data-ttu-id="7d714-149">**图 2**：双击 "类视图中的连接属性以查看其自动生成的代码</span><span class="sxs-lookup"><span data-stu-id="7d714-149">**Figure 2**: Double-Click the Connection Property in the Class View to View Its Auto-Generated Code</span></span>

<span data-ttu-id="7d714-150">TableAdapter s `Connection` 属性和其他与连接相关的代码如下所示：</span><span class="sxs-lookup"><span data-stu-id="7d714-150">The TableAdapter s `Connection` property and other connection-related code follows:</span></span>

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample1.cs)]

<span data-ttu-id="7d714-151">当 TableAdapter 类实例化时，成员变量 `_connection` 等于 `null`。</span><span class="sxs-lookup"><span data-stu-id="7d714-151">When the TableAdapter class is instantiated, the member variable `_connection` is equal to `null`.</span></span> <span data-ttu-id="7d714-152">访问 `Connection` 属性时，它首先检查 `_connection` 成员变量是否已实例化。</span><span class="sxs-lookup"><span data-stu-id="7d714-152">When the `Connection` property is accessed, it first checks to see if the `_connection` member variable has been instantiated.</span></span> <span data-ttu-id="7d714-153">如果没有，则调用 `InitConnection` 方法，该方法将 `_connection` 实例化，并将其 `ConnectionString` 属性设置为从 TableAdapter 配置向导第一步中指定的连接字符串值。</span><span class="sxs-lookup"><span data-stu-id="7d714-153">If it has not, the `InitConnection` method is invoked, which instantiates `_connection` and sets its `ConnectionString` property to the connection string value specified from the TableAdapter Configuration wizard s first step.</span></span>

<span data-ttu-id="7d714-154">还可以将 `Connection` 属性分配给 `SqlConnection` 对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-154">The `Connection` property can also be assigned to a `SqlConnection` object.</span></span> <span data-ttu-id="7d714-155">这样做会将新的 `SqlConnection` 对象与每个 TableAdapter `SqlCommand` 对象相关联。</span><span class="sxs-lookup"><span data-stu-id="7d714-155">Doing so associates the new `SqlConnection` object with each of the TableAdapter s `SqlCommand` objects.</span></span>

## <a name="step-2-exposing-connection-level-settings"></a><span data-ttu-id="7d714-156">步骤2：公开连接级设置</span><span class="sxs-lookup"><span data-stu-id="7d714-156">Step 2: Exposing Connection-Level Settings</span></span>

<span data-ttu-id="7d714-157">连接信息应保留在 TableAdapter 中，并且应用程序体系结构中的其他层不可访问。</span><span class="sxs-lookup"><span data-stu-id="7d714-157">The connection information should remain encapsulated within the TableAdapter and not be accessible to other layers in the application architecture.</span></span> <span data-ttu-id="7d714-158">但是，在某些情况下，可能需要为查询、用户或 ASP.NET 页访问或自定义 TableAdapter 连接级信息。</span><span class="sxs-lookup"><span data-stu-id="7d714-158">However, there may be scenarios when the TableAdapter s connection-level information needs to be accessible or customizable for a query, user, or ASP.NET page.</span></span>

<span data-ttu-id="7d714-159">让我们扩展 `Northwind` 数据集中的 `ProductsTableAdapter`，以包含一个 `ConnectionString` 属性，业务逻辑层可以使用该属性读取或更改 TableAdapter 使用的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="7d714-159">Let s extend the `ProductsTableAdapter` in the `Northwind` DataSet to include a `ConnectionString` property that can be used by the Business Logic Layer to read or change the connection string used by the TableAdapter.</span></span>

> [!NOTE]
> <span data-ttu-id="7d714-160">*连接字符串*是一个字符串，用于指定数据库连接信息，如要使用的访问接口、数据库的位置、身份验证凭据和其他与数据库相关的设置。</span><span class="sxs-lookup"><span data-stu-id="7d714-160">A *connection string* is a string that specifies database connection information, such as the provider to use, the location of the database, authentication credentials, and other database-related settings.</span></span> <span data-ttu-id="7d714-161">有关各种数据存储和提供程序所使用的连接字符串模式的列表，请参阅[ConnectionStrings.com](http://www.connectionstrings.com/)。</span><span class="sxs-lookup"><span data-stu-id="7d714-161">For a list of connection string patterns used by a variety of data stores and providers, see [ConnectionStrings.com](http://www.connectionstrings.com/).</span></span>

<span data-ttu-id="7d714-162">如[创建数据访问层](../introduction/creating-a-data-access-layer-cs.md)教程中所述，可通过使用分部类扩展类型化数据集的自动生成的类。</span><span class="sxs-lookup"><span data-stu-id="7d714-162">As discussed in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial, the Typed DataSet s auto-generated classes can be extended through the use of partial classes.</span></span> <span data-ttu-id="7d714-163">首先，在 "`~/App_Code/DAL`" 文件夹下名为 `ConnectionAndCommandSettings` 的项目中创建一个新的子文件夹。</span><span class="sxs-lookup"><span data-stu-id="7d714-163">First, create a new subfolder in the project named `ConnectionAndCommandSettings` underneath the `~/App_Code/DAL` folder.</span></span>

![添加一个名为 ConnectionAndCommandSettings 的子文件夹](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image5.png)

<span data-ttu-id="7d714-165">**图 3**：添加一个名为 `ConnectionAndCommandSettings` 的子文件夹</span><span class="sxs-lookup"><span data-stu-id="7d714-165">**Figure 3**: Add a Subfolder Named `ConnectionAndCommandSettings`</span></span>

<span data-ttu-id="7d714-166">添加一个名为 `ProductsTableAdapter.ConnectionAndCommandSettings.cs` 的新类文件，并输入以下代码：</span><span class="sxs-lookup"><span data-stu-id="7d714-166">Add a new class file named `ProductsTableAdapter.ConnectionAndCommandSettings.cs` and enter the following code:</span></span>

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample2.cs)]

<span data-ttu-id="7d714-167">此分部类向 `ProductsTableAdapter` 类添加一个名为 `ConnectionString` 的 `public` 属性，该属性允许任何层读取或更新 TableAdapter 基础连接的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="7d714-167">This partial class adds a `public` property named `ConnectionString` to the `ProductsTableAdapter` class that allows any layer to read or update the connection string for the TableAdapter s underlying connection.</span></span>

<span data-ttu-id="7d714-168">创建（并保存）此分部类后，打开 `ProductsBLL` 类。</span><span class="sxs-lookup"><span data-stu-id="7d714-168">With this partial class created (and saved), open the `ProductsBLL` class.</span></span> <span data-ttu-id="7d714-169">转到其中一个现有方法，在 `Adapter` 中键入，然后按 period 键以显示 IntelliSense。</span><span class="sxs-lookup"><span data-stu-id="7d714-169">Go to one of the existing methods and type in `Adapter` and then hit the period key to bring up IntelliSense.</span></span> <span data-ttu-id="7d714-170">你应会看到 IntelliSense 中提供的新 `ConnectionString` 属性，这意味着你可以通过编程方式从 BLL 读取或调整此值。</span><span class="sxs-lookup"><span data-stu-id="7d714-170">You should see the new `ConnectionString` property available in IntelliSense, meaning that you can programmatically read or adjust this value from the BLL.</span></span>

## <a name="exposing-the-entire-connection-object"></a><span data-ttu-id="7d714-171">公开整个连接对象</span><span class="sxs-lookup"><span data-stu-id="7d714-171">Exposing the Entire Connection Object</span></span>

<span data-ttu-id="7d714-172">此分部类只公开基础连接对象的一个属性： `ConnectionString`。</span><span class="sxs-lookup"><span data-stu-id="7d714-172">This partial class exposes just one property of the underlying connection object: `ConnectionString`.</span></span> <span data-ttu-id="7d714-173">如果要使整个连接对象在 TableAdapter 范围外可用，则可以选择更改 `Connection` 属性 "保护级别。</span><span class="sxs-lookup"><span data-stu-id="7d714-173">If you want to make the entire connection object available beyond the confines of the TableAdapter, you can alternatively change the `Connection` property s protection level.</span></span> <span data-ttu-id="7d714-174">我们在步骤1中检查的自动生成的代码表明，TableAdapter s `Connection` 属性被标记为 `internal`，这意味着它只能由同一程序集中的类访问。</span><span class="sxs-lookup"><span data-stu-id="7d714-174">The auto-generated code we examined in Step 1 showed that the TableAdapter s `Connection` property is marked as `internal`, meaning that it can only be accessed by classes in the same assembly.</span></span> <span data-ttu-id="7d714-175">不过，可以通过 TableAdapter s `ConnectionModifier` 属性更改此属性。</span><span class="sxs-lookup"><span data-stu-id="7d714-175">This can be changed, however, via the TableAdapter s `ConnectionModifier` property.</span></span>

<span data-ttu-id="7d714-176">打开 `Northwind` 数据集，在设计器中单击 `ProductsTableAdapter`，然后导航到 "属性窗口"。</span><span class="sxs-lookup"><span data-stu-id="7d714-176">Open the `Northwind` DataSet, click on the `ProductsTableAdapter` in the Designer, and navigate to the Properties window.</span></span> <span data-ttu-id="7d714-177">在这里，你将看到 `ConnectionModifier` 设置为其默认值，`Assembly`。</span><span class="sxs-lookup"><span data-stu-id="7d714-177">There you will see the `ConnectionModifier` set to its default value, `Assembly`.</span></span> <span data-ttu-id="7d714-178">若要使 `Connection` 属性在类型化数据集的程序集外部可用，请将 `ConnectionModifier` 属性更改为 "`Public`"。</span><span class="sxs-lookup"><span data-stu-id="7d714-178">To make the `Connection` property available outside of the Typed DataSet s assembly, change the `ConnectionModifier` property to `Public`.</span></span>

<span data-ttu-id="7d714-179">[![可以通过 ConnectionModifier 属性配置连接属性的可访问性级别](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image7.png)](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image6.png)</span><span class="sxs-lookup"><span data-stu-id="7d714-179">[![The Connection Property s Accessibility Level Can Be Configured via the ConnectionModifier Property](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image7.png)](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image6.png)</span></span>

<span data-ttu-id="7d714-180">**图 4**：可以通过 `ConnectionModifier` 属性配置 `Connection` 属性的可访问性级别（[单击以查看完全大小的映像](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image8.png)）</span><span class="sxs-lookup"><span data-stu-id="7d714-180">**Figure 4**: The `Connection` Property s Accessibility Level Can Be Configured via the `ConnectionModifier` Property ([Click to view full-size image](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image8.png))</span></span>

<span data-ttu-id="7d714-181">保存数据集，然后返回到 `ProductsBLL` 类。</span><span class="sxs-lookup"><span data-stu-id="7d714-181">Save the DataSet and then return to the `ProductsBLL` class.</span></span> <span data-ttu-id="7d714-182">与之前一样，请转到现有方法之一，键入 `Adapter`，然后按 period 键打开 IntelliSense。</span><span class="sxs-lookup"><span data-stu-id="7d714-182">As before, go to one of the existing methods and type in `Adapter` and then hit the period key to bring up IntelliSense.</span></span> <span data-ttu-id="7d714-183">此列表应包括一个 `Connection` 属性，这意味着现在可以通过编程方式从 BLL 中读取或分配任何连接级别设置。</span><span class="sxs-lookup"><span data-stu-id="7d714-183">The list should include a `Connection` property, meaning that you can now programmatically read or assign any connection-level settings from the BLL.</span></span>

## <a name="step-3-examining-the-command-related-properties"></a><span data-ttu-id="7d714-184">步骤3：检查与命令相关的属性</span><span class="sxs-lookup"><span data-stu-id="7d714-184">Step 3: Examining the Command-Related Properties</span></span>

<span data-ttu-id="7d714-185">TableAdapter 包含一个主查询，默认情况下，它具有自动生成的 `INSERT`、`UPDATE`和 `DELETE` 语句。</span><span class="sxs-lookup"><span data-stu-id="7d714-185">A TableAdapter consists of a main query that, by default, has auto-generated `INSERT`, `UPDATE`, and `DELETE` statements.</span></span> <span data-ttu-id="7d714-186">此主查询 `INSERT`、`UPDATE`和 `DELETE` 语句通过 `Adapter` 属性作为 ADO.NET 数据适配器对象在 TableAdapter 代码中实现。</span><span class="sxs-lookup"><span data-stu-id="7d714-186">This main query s `INSERT`, `UPDATE`, and `DELETE` statements are implemented in the TableAdapter s code as an ADO.NET data adapter object via the `Adapter` property.</span></span> <span data-ttu-id="7d714-187">与 `Connection` 属性一样，`Adapter` 属性的数据类型由所使用的数据访问接口确定。</span><span class="sxs-lookup"><span data-stu-id="7d714-187">Like with its `Connection` property, the `Adapter` property s data type is determined by the data provider used.</span></span> <span data-ttu-id="7d714-188">由于这些教程使用 SqlClient 提供程序，因此 `Adapter` 属性的类型[`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="7d714-188">Since these tutorials use the SqlClient provider, the `Adapter` property is of type [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter(VS.80).aspx).</span></span>

<span data-ttu-id="7d714-189">TableAdapter s `Adapter` 属性具有 `SqlCommand` 类型的三个属性，该属性用于发出 `INSERT`、`UPDATE`和 `DELETE` 语句：</span><span class="sxs-lookup"><span data-stu-id="7d714-189">The TableAdapter s `Adapter` property has three properties of type `SqlCommand` that it uses to issue the `INSERT`, `UPDATE`, and `DELETE` statements:</span></span>

- `InsertCommand`
- `UpdateCommand`
- `DeleteCommand`

<span data-ttu-id="7d714-190">`SqlCommand` 对象负责向数据库发送特定查询，并具有如下所示的属性： [`CommandText`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.commandtext.aspx)，其中包含要执行的即席 SQL 语句或存储过程;和[`Parameters`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.parameters.aspx)，它是 `SqlParameter` 对象的集合。</span><span class="sxs-lookup"><span data-stu-id="7d714-190">A `SqlCommand` object is responsible for sending a particular query to the database and has properties like: [`CommandText`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.commandtext.aspx), which contains the ad-hoc SQL statement or stored procedure to execute; and [`Parameters`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.parameters.aspx), which is a collection of `SqlParameter` objects.</span></span> <span data-ttu-id="7d714-191">正如我们在[创建数据访问层](../introduction/creating-a-data-access-layer-cs.md)教程中看到的那样，可以通过属性窗口自定义这些命令对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-191">As we saw back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial, these command objects can be customized through the Properties window.</span></span>

<span data-ttu-id="7d714-192">除了其主查询外，TableAdapter 还可以包含可变数量的方法，这些方法在调用时将指定的命令调度到数据库。</span><span class="sxs-lookup"><span data-stu-id="7d714-192">In addition to its main query, the TableAdapter can include a variable number of methods that, when invoked, dispatch a specified command to the database.</span></span> <span data-ttu-id="7d714-193">所有其他方法的主查询 command 对象和 command 对象均存储在 TableAdapter s `CommandCollection` 属性中。</span><span class="sxs-lookup"><span data-stu-id="7d714-193">The main query s command object and the command objects for all additional methods are stored in the TableAdapter s `CommandCollection` property.</span></span>

<span data-ttu-id="7d714-194">让我们花点时间查看 `ProductsTableAdapter` 在 `Northwind` DataSet 中为这两个属性及其支持的成员变量和帮助程序方法生成的代码：</span><span class="sxs-lookup"><span data-stu-id="7d714-194">Let s take a moment to look at the code generated by the `ProductsTableAdapter` in the `Northwind` DataSet for these two properties and their supporting member variables and helper methods:</span></span>

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample3.cs)]

<span data-ttu-id="7d714-195">`Adapter` 和 `CommandCollection` 属性的代码会充分模拟 `Connection` 属性的代码。</span><span class="sxs-lookup"><span data-stu-id="7d714-195">The code for the `Adapter` and `CommandCollection` properties closely mimics that of the `Connection` property.</span></span> <span data-ttu-id="7d714-196">有一些成员变量保存属性使用的对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-196">There are member variables that hold the objects used by the properties.</span></span> <span data-ttu-id="7d714-197">`get` 访问器的属性首先检查相应的成员变量是否 `null`。</span><span class="sxs-lookup"><span data-stu-id="7d714-197">The properties `get` accessors start by checking to see if the corresponding member variable is `null`.</span></span> <span data-ttu-id="7d714-198">如果是这样，将调用初始化方法，该方法创建成员变量的实例并分配与核心命令相关的属性。</span><span class="sxs-lookup"><span data-stu-id="7d714-198">If so, an initialization method is called which creates an instance of the member variable and assigns the core command-related properties.</span></span>

## <a name="step-4-exposing-command-level-settings"></a><span data-ttu-id="7d714-199">步骤4：公开命令级设置</span><span class="sxs-lookup"><span data-stu-id="7d714-199">Step 4: Exposing Command-Level Settings</span></span>

<span data-ttu-id="7d714-200">理想情况下，命令级信息应在数据访问层中保持封装。</span><span class="sxs-lookup"><span data-stu-id="7d714-200">Ideally, the command-level information should remain encapsulated within the Data Access Layer.</span></span> <span data-ttu-id="7d714-201">如果在体系结构的其他层中需要此信息，则可以通过分部类公开此信息，就像连接级设置一样。</span><span class="sxs-lookup"><span data-stu-id="7d714-201">Should this information be needed in other layers of the architecture, however, it can be exposed through a partial class, just like with the connection-level settings.</span></span>

<span data-ttu-id="7d714-202">由于 TableAdapter 只有单个 `Connection` 属性，因此用于公开连接级设置的代码非常简单。</span><span class="sxs-lookup"><span data-stu-id="7d714-202">Since the TableAdapter only has a single `Connection` property, the code for exposing connection-level settings is fairly straightforward.</span></span> <span data-ttu-id="7d714-203">由于 TableAdapter 可以具有多个命令对象（`InsertCommand`、`UpdateCommand`和 `DeleteCommand`）以及 `CommandCollection` 属性中的可变数目的命令对象，因此在修改命令级别设置时，会稍微复杂一些。</span><span class="sxs-lookup"><span data-stu-id="7d714-203">Things are a bit more complicated when modifying command-level settings because the TableAdapter can have multiple command objects - an `InsertCommand`, `UpdateCommand`, and `DeleteCommand`, along with a variable number of command objects in the `CommandCollection` property.</span></span> <span data-ttu-id="7d714-204">更新命令级别设置时，这些设置将需要传播到所有命令对象。</span><span class="sxs-lookup"><span data-stu-id="7d714-204">When updating command-level settings, these settings will need to be propagated to all of the command objects.</span></span>

<span data-ttu-id="7d714-205">例如，假设 TableAdapter 中存在一些需要很长时间执行的查询。</span><span class="sxs-lookup"><span data-stu-id="7d714-205">For example, imagine that there were certain queries in the TableAdapter that took an extraordinary long time to execute.</span></span> <span data-ttu-id="7d714-206">使用 TableAdapter 执行其中一个查询时，可能需要增加 command 对象的[`CommandTimeout` 属性](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.commandtimeout.aspx)。</span><span class="sxs-lookup"><span data-stu-id="7d714-206">When using the TableAdapter to execute one of those queries, we might want to increase the command object s [`CommandTimeout` property](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.commandtimeout.aspx).</span></span> <span data-ttu-id="7d714-207">此属性指定等待命令执行的秒数，默认值为30。</span><span class="sxs-lookup"><span data-stu-id="7d714-207">This property specifies the number of seconds to wait for the command to execute and defaults to 30.</span></span>

<span data-ttu-id="7d714-208">若要允许由 BLL 调整 `CommandTimeout` 属性，请使用在步骤2（`ProductsTableAdapter.ConnectionAndCommandSettings.cs`）中创建的分部类文件，将以下 `public` 方法添加到 `ProductsDataTable`：</span><span class="sxs-lookup"><span data-stu-id="7d714-208">To allow the `CommandTimeout` property to be adjusted by the BLL, add the following `public` method to the `ProductsDataTable` using the partial class file created in Step 2 (`ProductsTableAdapter.ConnectionAndCommandSettings.cs`):</span></span>

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample4.cs)]

<span data-ttu-id="7d714-209">可以从 BLL 或表示层调用此方法，以便为该 TableAdapter 实例发出的所有命令设置命令超时。</span><span class="sxs-lookup"><span data-stu-id="7d714-209">This method could be invoked from the BLL or Presentation Layer to set the command timeout for all commands issues by that TableAdapter instance.</span></span>

> [!NOTE]
> <span data-ttu-id="7d714-210">`Adapter` 和 `CommandCollection` 属性标记为 `private`，这意味着只能从 TableAdapter 内的代码访问这些属性。</span><span class="sxs-lookup"><span data-stu-id="7d714-210">The `Adapter` and `CommandCollection` properties are marked as `private`, meaning they can only be accessed from code within the TableAdapter.</span></span> <span data-ttu-id="7d714-211">与 `Connection` 属性不同，这些访问修饰符是不可配置的。</span><span class="sxs-lookup"><span data-stu-id="7d714-211">Unlike the `Connection` property, these access modifiers are not configurable.</span></span> <span data-ttu-id="7d714-212">因此，如果需要向体系结构中的其他层公开命令级属性，则必须使用上述分部类方法来提供读取或写入 `private` 命令对象的 `public` 方法或属性。</span><span class="sxs-lookup"><span data-stu-id="7d714-212">Therefore, if you need to expose command-level properties to other layers in the architecture you must use the partial class approach discussed above to provide a `public` method or property that reads or writes to the `private` command objects.</span></span>

## <a name="summary"></a><span data-ttu-id="7d714-213">摘要</span><span class="sxs-lookup"><span data-stu-id="7d714-213">Summary</span></span>

<span data-ttu-id="7d714-214">类型化数据集中的 Tableadapter 用于封装数据访问详细信息和复杂性。</span><span class="sxs-lookup"><span data-stu-id="7d714-214">The TableAdapters within a Typed DataSet serve to encapsulate data access details and complexity.</span></span> <span data-ttu-id="7d714-215">使用 Tableadapter，不必担心编写 ADO.NET 代码来连接数据库、发出命令，或将结果填充到 DataTable。</span><span class="sxs-lookup"><span data-stu-id="7d714-215">Using TableAdapters, we do not have to worry about writing ADO.NET code to connect to the database, issue a command, or populate the results into a DataTable.</span></span> <span data-ttu-id="7d714-216">它将自动为我们自动处理。</span><span class="sxs-lookup"><span data-stu-id="7d714-216">It is all handled automatically for us.</span></span>

<span data-ttu-id="7d714-217">不过，有时我们需要自定义低级 ADO.NET 细节，例如更改连接字符串或默认连接或命令超时值。</span><span class="sxs-lookup"><span data-stu-id="7d714-217">However, there may be times when we need to customize the low-level ADO.NET specifics, such as changing the connection string or the default connection or command timeout values.</span></span> <span data-ttu-id="7d714-218">TableAdapter 具有自动生成的 `Connection`、`Adapter`和 `CommandCollection` 属性，但默认情况下这些属性为 `internal` 或 `private`。</span><span class="sxs-lookup"><span data-stu-id="7d714-218">The TableAdapter has auto-generated `Connection`, `Adapter`, and `CommandCollection` properties, but these are either `internal` or `private`, by default.</span></span> <span data-ttu-id="7d714-219">通过使用分部类扩展 TableAdapter 以包括 `public` 方法或属性，可以公开此内部信息。</span><span class="sxs-lookup"><span data-stu-id="7d714-219">This internal information can be exposed by extending the TableAdapter using partial classes to include `public` methods or properties.</span></span> <span data-ttu-id="7d714-220">或者，可以通过 TableAdapter s `ConnectionModifier` 属性配置 TableAdapter s `Connection` 属性访问修饰符。</span><span class="sxs-lookup"><span data-stu-id="7d714-220">Alternatively, the TableAdapter s `Connection` property access modifier can be configured through the TableAdapter s `ConnectionModifier` property.</span></span>

<span data-ttu-id="7d714-221">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="7d714-221">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="7d714-222">关于作者</span><span class="sxs-lookup"><span data-stu-id="7d714-222">About the Author</span></span>

<span data-ttu-id="7d714-223">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已在使用 Microsoft Web 技术，自1998开始。</span><span class="sxs-lookup"><span data-stu-id="7d714-223">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="7d714-224">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="7d714-224">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="7d714-225">他的最新书籍是，[*在24小时内，sam ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="7d714-225">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="7d714-226">可以[mitchell@4GuysFromRolla.com访问。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="7d714-226">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="7d714-227">或通过他的博客，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="7d714-227">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="7d714-228">特别感谢</span><span class="sxs-lookup"><span data-stu-id="7d714-228">Special Thanks To</span></span>

<span data-ttu-id="7d714-229">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="7d714-229">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="7d714-230">本教程的主管评审者是 Burnadette Leigh、S ren Jacob Lauritsen、Teresa Murphy 和 Hilton Geisenow。</span><span class="sxs-lookup"><span data-stu-id="7d714-230">Lead reviewers for this tutorial were Burnadette Leigh, S ren Jacob Lauritsen, Teresa Murphy, and Hilton Geisenow.</span></span> <span data-ttu-id="7d714-231">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="7d714-231">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="7d714-232">如果是这样，请在mitchell@4GuysFromRolla.com放置一行[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="7d714-232">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="7d714-233">[上一页](working-with-computed-columns-cs.md)
> [下一页](protecting-connection-strings-and-other-configuration-information-cs.md)</span><span class="sxs-lookup"><span data-stu-id="7d714-233">[Previous](working-with-computed-columns-cs.md)
[Next](protecting-connection-strings-and-other-configuration-information-cs.md)</span></span>
