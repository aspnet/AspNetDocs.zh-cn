---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/adding-additional-datatable-columns-cs
title: 添加其他 DataTable 列（C#） |Microsoft Docs
author: rick-anderson
description: 使用 TableAdapter 向导创建类型化数据集时，相应的 DataTable 包含主数据库查询返回的列。 但存在 。
ms.author: riande
ms.date: 07/18/2007
ms.assetid: 615f3361-f21f-4338-8bc1-fce8ae071de9
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/adding-additional-datatable-columns-cs
msc.type: authoredcontent
ms.openlocfilehash: a96f254aa54e7077456ac1a9bd6c5e2a17619d96
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78444494"
---
# <a name="adding-additional-datatable-columns-c"></a><span data-ttu-id="67770-104">添加其他 DataTable 列 (C#)</span><span class="sxs-lookup"><span data-stu-id="67770-104">Adding Additional DataTable Columns (C#)</span></span>

<span data-ttu-id="67770-105">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="67770-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="67770-106">[下载代码](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_70_CS.zip)或[下载 PDF](adding-additional-datatable-columns-cs/_static/datatutorial70cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="67770-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_70_CS.zip) or [Download PDF](adding-additional-datatable-columns-cs/_static/datatutorial70cs1.pdf)</span></span>

> <span data-ttu-id="67770-107">使用 TableAdapter 向导创建类型化数据集时，相应的 DataTable 包含主数据库查询返回的列。</span><span class="sxs-lookup"><span data-stu-id="67770-107">When using the TableAdapter Wizard to create a Typed DataSet, the corresponding DataTable contains the columns returned by the main database query.</span></span> <span data-ttu-id="67770-108">但在某些情况下，DataTable 需要包含其他列。</span><span class="sxs-lookup"><span data-stu-id="67770-108">But there are occasions when the DataTable needs to include additional columns.</span></span> <span data-ttu-id="67770-109">在本教程中，我们将了解在需要其他 DataTable 列时为何建议使用存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-109">In this tutorial we learn why stored procedures are recommended when we need additional DataTable columns.</span></span>

## <a name="introduction"></a><span data-ttu-id="67770-110">简介</span><span class="sxs-lookup"><span data-stu-id="67770-110">Introduction</span></span>

<span data-ttu-id="67770-111">将 TableAdapter 添加到类型化数据集时，相应的 DataTable 架构由 TableAdapter s 主查询确定。</span><span class="sxs-lookup"><span data-stu-id="67770-111">When adding a TableAdapter to a Typed DataSet, the corresponding DataTable s schema is determined by the TableAdapter s main query.</span></span> <span data-ttu-id="67770-112">例如，如果主查询返回数据字段*a*、 *b*和*c*，则 DataTable 将具有三个名为*A*、 *b*和*c*的对应列。除了其主查询外，TableAdapter 还可以包含其他查询，这些查询可能会根据某些参数返回数据的一个子集。</span><span class="sxs-lookup"><span data-stu-id="67770-112">For example, if the main query returns data fields *A*, *B*, and *C*, the DataTable will have three corresponding columns named *A*, *B*, and *C*. In addition to its main query, a TableAdapter can include additional queries that return, perhaps, a subset of the data based on some parameter.</span></span> <span data-ttu-id="67770-113">例如，除了返回有关所有产品的信息的 `ProductsTableAdapter` s 主查询，它还包含 `GetProductsByCategoryID(categoryID)` 和 `GetProductByProductID(productID)`等方法，这些方法基于提供的参数返回特定产品信息。</span><span class="sxs-lookup"><span data-stu-id="67770-113">For instance, in addition to the `ProductsTableAdapter` s main query, which returns information about all products, it also contains methods like `GetProductsByCategoryID(categoryID)` and `GetProductByProductID(productID)`, which return specific product information based on a supplied parameter.</span></span>

<span data-ttu-id="67770-114">如果所有 TableAdapter s 方法返回的数据字段与主查询中指定的数据字段相同或少，则使 DataTable s 架构反映 TableAdapter s 查询的模型可以很好地运行。</span><span class="sxs-lookup"><span data-stu-id="67770-114">The model of having the DataTable s schema reflect the TableAdapter s main query works well if all of the TableAdapter s methods return the same or fewer data fields than those specified in the main query.</span></span> <span data-ttu-id="67770-115">如果 TableAdapter 方法需要返回其他数据字段，则应相应地展开 DataTable 架构。</span><span class="sxs-lookup"><span data-stu-id="67770-115">If a TableAdapter method needs to return additional data fields, then we should expand the DataTable s schema accordingly.</span></span> <span data-ttu-id="67770-116">[使用带有详细信息 DataList 教程的主记录的项目符号列表的母版/详细信息](../filtering-scenarios-with-the-datalist-and-repeater/master-detail-using-a-bulleted-list-of-master-records-with-a-details-datalist-cs.md)，我们向 `CategoriesTableAdapter` 中添加了一个方法，该方法返回在主 `NumberOfProducts`查询中定义的 `CategoryID`、`CategoryName`和 `Description` 数据字段，以及一个报告与每个类别关联的产品数量的附加数据字段。</span><span class="sxs-lookup"><span data-stu-id="67770-116">In the [Master/Detail Using a Bulleted List of Master Records with a Details DataList](../filtering-scenarios-with-the-datalist-and-repeater/master-detail-using-a-bulleted-list-of-master-records-with-a-details-datalist-cs.md) tutorial we added a method to the `CategoriesTableAdapter` that returned the `CategoryID`, `CategoryName`, and `Description` data fields defined in the main query plus `NumberOfProducts`, an additional data field that reported the number of products associated with each category.</span></span> <span data-ttu-id="67770-117">我们将新列手动添加到 `CategoriesDataTable`，以便从此新方法捕获 `NumberOfProducts` 数据字段值。</span><span class="sxs-lookup"><span data-stu-id="67770-117">We manually added a new column to the `CategoriesDataTable` in order to capture the `NumberOfProducts` data field value from this new method.</span></span>

<span data-ttu-id="67770-118">如[上传文件](../working-with-binary-files/uploading-files-cs.md)教程中所述，对于使用即席 SQL 语句并具有其数据字段与主查询并不完全匹配的方法的 tableadapter，必须格外小心。</span><span class="sxs-lookup"><span data-stu-id="67770-118">As discussed in the [Uploading Files](../working-with-binary-files/uploading-files-cs.md) tutorial, great care must be taken with TableAdapters that use ad-hoc SQL statements and have methods whose data fields do not precisely match the main query.</span></span> <span data-ttu-id="67770-119">如果重新运行 TableAdapter 配置向导，它将更新所有 TableAdapter 的方法，使其数据字段列表与主查询匹配。</span><span class="sxs-lookup"><span data-stu-id="67770-119">If the TableAdapter Configuration wizard is re-run, it will update all of the TableAdapter s methods so that their data field list matches the main query.</span></span> <span data-ttu-id="67770-120">因此，具有自定义列列表的任何方法都将恢复到主查询的列列表中，而不会返回所需的数据。</span><span class="sxs-lookup"><span data-stu-id="67770-120">Consequently, any methods with customized column lists will revert to the main query s column list and not return the expected data.</span></span> <span data-ttu-id="67770-121">使用存储过程时不会出现此问题。</span><span class="sxs-lookup"><span data-stu-id="67770-121">This issue does not arise when using stored procedures.</span></span>

<span data-ttu-id="67770-122">在本教程中，我们将介绍如何扩展 DataTable 架构以包括其他列。</span><span class="sxs-lookup"><span data-stu-id="67770-122">In this tutorial we will look at how to extend a DataTable s schema to include additional columns.</span></span> <span data-ttu-id="67770-123">由于使用即席 SQL 语句时，TableAdapter 的易受攻击，因此，在本教程中，我们将使用存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-123">Due to the brittleness of the TableAdapter when using ad-hoc SQL statements, in this tutorial we will use stored procedures.</span></span> <span data-ttu-id="67770-124">有关将 TableAdapter 配置为使用存储过程的详细信息，请参阅[创建类型化数据集的 tableadapter 的新存储过程](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md)和[使用类型化数据集 s Tableadapter 教程的现有存储过程](https://data-access/tutorials/using-existing-stored-procedures-for-the-typed-dataset-amp-rsquo-s-tableadapters-cs)。</span><span class="sxs-lookup"><span data-stu-id="67770-124">Refer to the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) and [Using Existing Stored Procedures for the Typed DataSet s TableAdapters](https://data-access/tutorials/using-existing-stored-procedures-for-the-typed-dataset-amp-rsquo-s-tableadapters-cs) tutorials for more information on configuring a TableAdapter to use stored procedures.</span></span>

## <a name="step-1-adding-apricequartilecolumn-to-theproductsdatatable"></a><span data-ttu-id="67770-125">步骤1：将`PriceQuartile`列添加到`ProductsDataTable`</span><span class="sxs-lookup"><span data-stu-id="67770-125">Step 1: Adding a`PriceQuartile`Column to the`ProductsDataTable`</span></span>

<span data-ttu-id="67770-126">在*为类型化数据集 tableadapter 教程创建新存储过程*中，我们创建了一个名为 `NorthwindWithSprocs`的类型化数据集。</span><span class="sxs-lookup"><span data-stu-id="67770-126">In the *Creating New Stored Procedures for the Typed DataSet s TableAdapters* tutorial we created a Typed DataSet named `NorthwindWithSprocs`.</span></span> <span data-ttu-id="67770-127">此数据集当前包含两个数据表： `ProductsDataTable` 和 `EmployeesDataTable`。</span><span class="sxs-lookup"><span data-stu-id="67770-127">This DataSet currently contains two DataTables: `ProductsDataTable` and `EmployeesDataTable`.</span></span> <span data-ttu-id="67770-128">`ProductsTableAdapter` 具有以下三种方法：</span><span class="sxs-lookup"><span data-stu-id="67770-128">The `ProductsTableAdapter` has the following three methods:</span></span>

- <span data-ttu-id="67770-129">`GetProducts`-主查询，返回 `Products` 表中的所有记录</span><span class="sxs-lookup"><span data-stu-id="67770-129">`GetProducts` - the main query, which returns all records from the `Products` table</span></span>
- <span data-ttu-id="67770-130">`GetProductsByCategoryID(categoryID)`-返回具有指定*类别 id*的所有产品。</span><span class="sxs-lookup"><span data-stu-id="67770-130">`GetProductsByCategoryID(categoryID)` - returns all products with the specified *categoryID*.</span></span>
- <span data-ttu-id="67770-131">`GetProductByProductID(productID)`-返回具有指定*productID*的特定产品。</span><span class="sxs-lookup"><span data-stu-id="67770-131">`GetProductByProductID(productID)` - returns the particular product with the specified *productID*.</span></span>

<span data-ttu-id="67770-132">主查询和其他两个方法都返回相同的数据字段集，即 `Products` 表中的所有列。</span><span class="sxs-lookup"><span data-stu-id="67770-132">The main query and the two additional methods all return the same set of data fields, namely all of the columns from the `Products` table.</span></span> <span data-ttu-id="67770-133">没有相关子查询或 `JOIN` 从 `Categories` 或 `Suppliers` 表中提取相关数据。</span><span class="sxs-lookup"><span data-stu-id="67770-133">There are no correlated subqueries or `JOIN` s pulling related data from the `Categories` or `Suppliers` tables.</span></span> <span data-ttu-id="67770-134">因此，`ProductsDataTable` 的 `Products` 表中的每个字段都有对应的列。</span><span class="sxs-lookup"><span data-stu-id="67770-134">Therefore, the `ProductsDataTable` has a corresponding column for each field in the `Products` table.</span></span>

<span data-ttu-id="67770-135">对于本教程，让我们将方法添加到返回所有产品的名为 `GetProductsWithPriceQuartile` 的 `ProductsTableAdapter`。</span><span class="sxs-lookup"><span data-stu-id="67770-135">For this tutorial, let s add a method to the `ProductsTableAdapter` named `GetProductsWithPriceQuartile` that returns all of the products.</span></span> <span data-ttu-id="67770-136">除了标准产品数据字段，`GetProductsWithPriceQuartile` 还将包括一个 `PriceQuartile` 数据字段，该字段指示产品的价格为四分位。</span><span class="sxs-lookup"><span data-stu-id="67770-136">In addition to the standard product data fields, `GetProductsWithPriceQuartile` will also include a `PriceQuartile` data field that indicates under which quartile the product s price falls.</span></span> <span data-ttu-id="67770-137">例如，价格最昂贵25% 的产品将 `PriceQuartile` 值1，而其价格低于底部25% 的产品将具有值4。</span><span class="sxs-lookup"><span data-stu-id="67770-137">For example, those products whose prices are in the most expensive 25% will have a `PriceQuartile` value of 1, while those whose prices fall in the bottom 25% will have a value of 4.</span></span> <span data-ttu-id="67770-138">但是，在考虑创建返回此信息的存储过程之前，我们首先需要更新 `ProductsDataTable`，以在使用 `GetProductsWithPriceQuartile` 方法时包含一列来保存 `PriceQuartile` 结果。</span><span class="sxs-lookup"><span data-stu-id="67770-138">Before we worry about creating the stored procedure to return this information, however, we first need to update the `ProductsDataTable` to include a column to hold the `PriceQuartile` results when the `GetProductsWithPriceQuartile` method is used.</span></span>

<span data-ttu-id="67770-139">打开 `NorthwindWithSprocs` 数据集，然后右键单击 `ProductsDataTable`。</span><span class="sxs-lookup"><span data-stu-id="67770-139">Open the `NorthwindWithSprocs` DataSet and right-click on the `ProductsDataTable`.</span></span> <span data-ttu-id="67770-140">选择上下文菜单中的 "添加"，然后选择 "列"。</span><span class="sxs-lookup"><span data-stu-id="67770-140">Choose Add from the context-menu and then pick Column.</span></span>

<span data-ttu-id="67770-141">[![将新列添加到 ProductsDataTable](adding-additional-datatable-columns-cs/_static/image2.png)](adding-additional-datatable-columns-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="67770-141">[![Add a New Column to the ProductsDataTable](adding-additional-datatable-columns-cs/_static/image2.png)](adding-additional-datatable-columns-cs/_static/image1.png)</span></span>

<span data-ttu-id="67770-142">**图 1**：将新列添加到 `ProductsDataTable` （[单击以查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-142">**Figure 1**: Add a New Column to the `ProductsDataTable` ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image3.png))</span></span>

<span data-ttu-id="67770-143">这会将一个新列添加到 `System.String`类型的名为 Column1 的 DataTable。</span><span class="sxs-lookup"><span data-stu-id="67770-143">This will add a new column to the DataTable named Column1 of type `System.String`.</span></span> <span data-ttu-id="67770-144">需要将此列的名称更新为 PriceQuartile，并将其类型更新为 "`System.Int32`"，因为它将用于保存1到4之间的数字。</span><span class="sxs-lookup"><span data-stu-id="67770-144">We need to update this column s name to PriceQuartile and its type to `System.Int32` since it will be used to hold a number between 1 and 4.</span></span> <span data-ttu-id="67770-145">在 `ProductsDataTable` 中选择新添加的列，并从属性窗口将 `Name` 属性设置为 PriceQuartile，并将 `DataType` 属性设置为 `System.Int32`。</span><span class="sxs-lookup"><span data-stu-id="67770-145">Select the newly-added column in the `ProductsDataTable` and, from the Properties window, set the `Name` property to PriceQuartile and the `DataType` property to `System.Int32`.</span></span>

<span data-ttu-id="67770-146">[![设置新列的 "名称" 和 "数据类型" 属性](adding-additional-datatable-columns-cs/_static/image5.png)](adding-additional-datatable-columns-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="67770-146">[![Set the New Column s Name and DataType Properties](adding-additional-datatable-columns-cs/_static/image5.png)](adding-additional-datatable-columns-cs/_static/image4.png)</span></span>

<span data-ttu-id="67770-147">**图 2**：设置新列 `Name` 和 `DataType` 属性（[单击以查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-147">**Figure 2**: Set the New Column s `Name` and `DataType` Properties ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image6.png))</span></span>

<span data-ttu-id="67770-148">如图2所示，还可以设置其他属性，例如，如果列中的值必须是唯一的，则如果该列是自动递增列，是否允许数据库 `NULL` 值等。</span><span class="sxs-lookup"><span data-stu-id="67770-148">As Figure 2 shows, there are additional properties that can be set, such as whether the values in the column must be unique, if the column is an auto-increment column, whether or not database `NULL` values are allowed, and so on.</span></span> <span data-ttu-id="67770-149">将这些值设置为其默认值。</span><span class="sxs-lookup"><span data-stu-id="67770-149">Leave these values set to their defaults.</span></span>

## <a name="step-2-creating-thegetproductswithpricequartilemethod"></a><span data-ttu-id="67770-150">步骤2：创建`GetProductsWithPriceQuartile`方法</span><span class="sxs-lookup"><span data-stu-id="67770-150">Step 2: Creating the`GetProductsWithPriceQuartile`Method</span></span>

<span data-ttu-id="67770-151">现在，已将 `ProductsDataTable` 更新为包含 `PriceQuartile` 列，接下来可以创建 `GetProductsWithPriceQuartile` 方法。</span><span class="sxs-lookup"><span data-stu-id="67770-151">Now that the `ProductsDataTable` has been updated to include the `PriceQuartile` column, we are ready to create the `GetProductsWithPriceQuartile` method.</span></span> <span data-ttu-id="67770-152">首先右键单击 "TableAdapter"，然后从上下文菜单中选择 "添加查询"。</span><span class="sxs-lookup"><span data-stu-id="67770-152">Start by right-clicking on the TableAdapter and choosing Add Query from the context-menu.</span></span> <span data-ttu-id="67770-153">这将打开 "TableAdapter 查询配置向导"，该向导首先提示我们是要使用即席 SQL 语句还是新的或现有的存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-153">This brings up the TableAdapter Query Configuration wizard, which first prompts us as to whether we want to use ad-hoc SQL statements or a new or existing stored procedure.</span></span> <span data-ttu-id="67770-154">由于我们还没有返回价格分位数据的存储过程，因此允许 TableAdapter 为我们创建此存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-154">Since we don t yet have a stored procedure that returns the price quartile data, let s allow the TableAdapter to create this stored procedure for us.</span></span> <span data-ttu-id="67770-155">选择 "创建新存储过程" 选项，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="67770-155">Select the Create new stored procedure option and click Next.</span></span>

<span data-ttu-id="67770-156">[![指示 TableAdapter 向导为我们创建存储过程](adding-additional-datatable-columns-cs/_static/image8.png)](adding-additional-datatable-columns-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="67770-156">[![Instruct the TableAdapter Wizard to Create the Stored Procedure For Us](adding-additional-datatable-columns-cs/_static/image8.png)](adding-additional-datatable-columns-cs/_static/image7.png)</span></span>

<span data-ttu-id="67770-157">**图 3**：指示 TableAdapter 向导为我们创建存储过程（[单击查看完全大小的映像](adding-additional-datatable-columns-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-157">**Figure 3**: Instruct the TableAdapter Wizard to Create the Stored Procedure For Us ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image9.png))</span></span>

<span data-ttu-id="67770-158">在接下来的屏幕中，如图4所示，向导会询问要添加哪种类型的查询。</span><span class="sxs-lookup"><span data-stu-id="67770-158">In the subsequent screen, shown in Figure 4, the wizard asks us what type of query to add.</span></span> <span data-ttu-id="67770-159">由于 `GetProductsWithPriceQuartile` 方法将返回 `Products` 表中的所有列和记录，请选择 "选择返回行" 选项，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="67770-159">Since the `GetProductsWithPriceQuartile` method will return all columns and records from the `Products` table, select the SELECT which returns rows option and click Next.</span></span>

<span data-ttu-id="67770-160">[![查询将是返回多个行的 SELECT 语句](adding-additional-datatable-columns-cs/_static/image11.png)](adding-additional-datatable-columns-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="67770-160">[![Our Query will be a SELECT Statement that Returns Multiple Rows](adding-additional-datatable-columns-cs/_static/image11.png)](adding-additional-datatable-columns-cs/_static/image10.png)</span></span>

<span data-ttu-id="67770-161">**图 4**：查询将是返回多个行的 `SELECT` 语句（[单击以查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-161">**Figure 4**: Our Query will be a `SELECT` Statement that Returns Multiple Rows ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image12.png))</span></span>

<span data-ttu-id="67770-162">接下来，系统会提示输入 `SELECT` 查询。</span><span class="sxs-lookup"><span data-stu-id="67770-162">Next we are prompted for the `SELECT` query.</span></span> <span data-ttu-id="67770-163">在向导中输入以下查询：</span><span class="sxs-lookup"><span data-stu-id="67770-163">Enter the following query into the wizard:</span></span>

[!code-sql[Main](adding-additional-datatable-columns-cs/samples/sample1.sql)]

<span data-ttu-id="67770-164">上面的查询使用 SQL Server 2005 s new [`NTILE` 函数](https://msdn.microsoft.com/library/ms175126.aspx)将结果划分为四个组，其中的组由 `UnitPrice` 值以降序排序。</span><span class="sxs-lookup"><span data-stu-id="67770-164">The above query uses SQL Server 2005 s new [`NTILE` function](https://msdn.microsoft.com/library/ms175126.aspx) to divide the results into four groups where the groups are determined by the `UnitPrice` values sorted in descending order.</span></span>

<span data-ttu-id="67770-165">遗憾的是，查询生成器不知道如何分析 `OVER` 关键字，并将在分析上述查询时显示错误。</span><span class="sxs-lookup"><span data-stu-id="67770-165">Unfortunately, the Query Builder does not know how to parse the `OVER` keyword and will display an error when parsing the above query.</span></span> <span data-ttu-id="67770-166">因此，请在向导的文本框中直接输入以上查询，而不使用查询生成器。</span><span class="sxs-lookup"><span data-stu-id="67770-166">Therefore, enter the above query directly in the textbox in the wizard without using the Query Builder.</span></span>

> [!NOTE]
> <span data-ttu-id="67770-167">有关 NTILE 和 SQL Server 2005 s 其他排名函数的详细信息，请参阅[SQL Server 2005 联机丛书](https://msdn.microsoft.com/library/ms189798.aspx)中的 Microsoft SQL Server 2005 和[排名函数部分](https://msdn.microsoft.com/library/ms189798.aspx)[返回排名结果](http://www.4guysfromrolla.com/webtech/010406-1.shtml)。</span><span class="sxs-lookup"><span data-stu-id="67770-167">For more information on NTILE and SQL Server 2005 s other ranking functions, see [Returning Ranked Results with Microsoft SQL Server 2005](http://www.4guysfromrolla.com/webtech/010406-1.shtml) and the [Ranking Functions section](https://msdn.microsoft.com/library/ms189798.aspx) from the [SQL Server 2005 Books Online](https://msdn.microsoft.com/library/ms189798.aspx).</span></span>

<span data-ttu-id="67770-168">输入 `SELECT` 查询并单击 "下一步" 后，向导将要求我们提供要创建的存储过程的名称。</span><span class="sxs-lookup"><span data-stu-id="67770-168">After entering the `SELECT` query and clicking Next, the wizard asks us to provide a name for the stored procedure it will create.</span></span> <span data-ttu-id="67770-169">将新的存储过程命名为 `Products_SelectWithPriceQuartile`，然后单击 "下一步"。</span><span class="sxs-lookup"><span data-stu-id="67770-169">Name the new stored procedure `Products_SelectWithPriceQuartile` and click Next.</span></span>

<span data-ttu-id="67770-170">[![命名存储过程 Products_SelectWithPriceQuartile](adding-additional-datatable-columns-cs/_static/image14.png)](adding-additional-datatable-columns-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="67770-170">[![Name the Stored Procedure Products_SelectWithPriceQuartile](adding-additional-datatable-columns-cs/_static/image14.png)](adding-additional-datatable-columns-cs/_static/image13.png)</span></span>

<span data-ttu-id="67770-171">**图 5**：将存储过程命名 `Products_SelectWithPriceQuartile` （[单击以查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-171">**Figure 5**: Name the Stored Procedure `Products_SelectWithPriceQuartile` ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image15.png))</span></span>

<span data-ttu-id="67770-172">最后，系统将提示您命名 TableAdapter 方法。</span><span class="sxs-lookup"><span data-stu-id="67770-172">Lastly, we are prompted to name the TableAdapter methods.</span></span> <span data-ttu-id="67770-173">将 Fill 填充为 DataTable 并返回选中的 DataTable 复选框，并将方法命名 `FillWithPriceQuartile` 和 `GetProductsWithPriceQuartile`。</span><span class="sxs-lookup"><span data-stu-id="67770-173">Leave both the Fill a DataTable and Return a DataTable checkboxes checked and name the methods `FillWithPriceQuartile` and `GetProductsWithPriceQuartile`.</span></span>

<span data-ttu-id="67770-174">[![命名 TableAdapter s 方法，然后单击 "完成"](adding-additional-datatable-columns-cs/_static/image17.png)](adding-additional-datatable-columns-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="67770-174">[![Name the TableAdapter s Methods and Click Finish](adding-additional-datatable-columns-cs/_static/image17.png)](adding-additional-datatable-columns-cs/_static/image16.png)</span></span>

<span data-ttu-id="67770-175">**图 6**：命名 TableAdapter s 方法并单击 "完成" （[单击查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-175">**Figure 6**: Name the TableAdapter s Methods and Click Finish ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image18.png))</span></span>

<span data-ttu-id="67770-176">通过指定 `SELECT` 查询以及名为的存储过程和 TableAdapter 方法，单击 "完成" 以完成向导。</span><span class="sxs-lookup"><span data-stu-id="67770-176">With the `SELECT` query specified and the stored procedure and TableAdapter methods named, click Finish to complete the wizard.</span></span> <span data-ttu-id="67770-177">此时，你可能会收到一条警告或两条消息，指出不支持 `OVER` 的 SQL 构造或语句。</span><span class="sxs-lookup"><span data-stu-id="67770-177">At this point you may get a warning or two from the wizard saying that The `OVER` SQL construct or statement is not supported.</span></span> <span data-ttu-id="67770-178">可以忽略这些警告。</span><span class="sxs-lookup"><span data-stu-id="67770-178">These warnings can be ignored.</span></span>

<span data-ttu-id="67770-179">完成向导后，TableAdapter 应包括 `FillWithPriceQuartile` 和 `GetProductsWithPriceQuartile` 方法，数据库应包含名为 `Products_SelectWithPriceQuartile`的存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-179">After completing the wizard, the TableAdapter should include the `FillWithPriceQuartile` and `GetProductsWithPriceQuartile` methods and the database should include a stored procedure named `Products_SelectWithPriceQuartile`.</span></span> <span data-ttu-id="67770-180">请花点时间验证 TableAdapter 确实包含这一新方法，并且该存储过程已正确添加到数据库中。</span><span class="sxs-lookup"><span data-stu-id="67770-180">Take a moment to verify that the TableAdapter does indeed contain this new method and that the stored procedure has been correctly added to the database.</span></span> <span data-ttu-id="67770-181">检查数据库时，如果看不到存储过程，请尝试右键单击 "存储过程" 文件夹，然后选择 "刷新"。</span><span class="sxs-lookup"><span data-stu-id="67770-181">When checking the database, if you do not see the stored procedure try right-clicking on the Stored Procedures folder and choosing Refresh.</span></span>

![验证是否已将新方法添加到 TableAdapter](adding-additional-datatable-columns-cs/_static/image19.png)

<span data-ttu-id="67770-183">**图 7**：验证是否已将新方法添加到 TableAdapter</span><span class="sxs-lookup"><span data-stu-id="67770-183">**Figure 7**: Verify that a New Method Has Been Added to the TableAdapter</span></span>

<span data-ttu-id="67770-184">[![确保数据库包含 Products_SelectWithPriceQuartile 存储过程](adding-additional-datatable-columns-cs/_static/image21.png)](adding-additional-datatable-columns-cs/_static/image20.png)</span><span class="sxs-lookup"><span data-stu-id="67770-184">[![Ensure that the Database Contains the Products_SelectWithPriceQuartile Stored Procedure](adding-additional-datatable-columns-cs/_static/image21.png)](adding-additional-datatable-columns-cs/_static/image20.png)</span></span>

<span data-ttu-id="67770-185">**图 8**：确保数据库包含 `Products_SelectWithPriceQuartile` 存储过程（[单击查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image22.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-185">**Figure 8**: Ensure that the Database Contains the `Products_SelectWithPriceQuartile` Stored Procedure ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image22.png))</span></span>

> [!NOTE]
> <span data-ttu-id="67770-186">使用存储过程而不是即席 SQL 语句的一个优点是，重新运行 TableAdapter 配置向导不会修改存储过程列列表。</span><span class="sxs-lookup"><span data-stu-id="67770-186">One of the benefits of using stored procedures instead of ad-hoc SQL statements is that re-running the TableAdapter Configuration wizard will not modify the stored procedures column lists.</span></span> <span data-ttu-id="67770-187">若要验证此情况，请右键单击 TableAdapter，从上下文菜单中选择 "配置" 选项以启动向导，然后单击 "完成" 完成该向导。</span><span class="sxs-lookup"><span data-stu-id="67770-187">Verify this by right-clicking on the TableAdapter, choosing the Configure option from the context-menu to start the wizard, and then clicking Finish to complete it.</span></span> <span data-ttu-id="67770-188">接下来，请切换到数据库并查看 `Products_SelectWithPriceQuartile` 存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-188">Next, go to the database and view the `Products_SelectWithPriceQuartile` stored procedure.</span></span> <span data-ttu-id="67770-189">请注意，尚未修改其列列表。</span><span class="sxs-lookup"><span data-stu-id="67770-189">Note that its column list has not been modified.</span></span> <span data-ttu-id="67770-190">如果使用的是即席 SQL 语句，则重新运行 TableAdapter 配置向导会将此查询的列列表恢复为与主查询列列表相匹配，从而从 `GetProductsWithPriceQuartile` 方法所使用的查询中删除 NTILE 语句。</span><span class="sxs-lookup"><span data-stu-id="67770-190">Had we been using ad-hoc SQL statements, re-running the TableAdapter Configuration wizard would have reverted this query s column list to match the main query column list, thereby removing the NTILE statement from the query used by the `GetProductsWithPriceQuartile` method.</span></span>

<span data-ttu-id="67770-191">调用数据访问层的 `GetProductsWithPriceQuartile` 方法时，TableAdapter 执行 `Products_SelectWithPriceQuartile` 存储过程，并向每个返回的记录的 `ProductsDataTable` 添加一行。</span><span class="sxs-lookup"><span data-stu-id="67770-191">When the Data Access Layer s `GetProductsWithPriceQuartile` method is invoked, the TableAdapter executes the `Products_SelectWithPriceQuartile` stored procedure and adds a row to the `ProductsDataTable` for each returned record.</span></span> <span data-ttu-id="67770-192">存储过程返回的数据字段映射到 `ProductsDataTable` 的列。</span><span class="sxs-lookup"><span data-stu-id="67770-192">The data fields returned by the stored procedure are mapped to the `ProductsDataTable` s columns.</span></span> <span data-ttu-id="67770-193">由于存储过程中返回了 `PriceQuartile` 数据字段，因此它的值将分配给 `ProductsDataTable` s `PriceQuartile` 列。</span><span class="sxs-lookup"><span data-stu-id="67770-193">Since there is a `PriceQuartile` data field returned from the stored procedure, its value is assigned to the `ProductsDataTable` s `PriceQuartile` column.</span></span>

<span data-ttu-id="67770-194">对于那些查询未返回 `PriceQuartile` 数据字段的 TableAdapter 方法，`PriceQuartile` 列 s 值是由其 `DefaultValue` 属性指定的值。</span><span class="sxs-lookup"><span data-stu-id="67770-194">For those TableAdapter methods whose queries do not return a `PriceQuartile` data field, the `PriceQuartile` column s value is the value specified by its `DefaultValue` property.</span></span> <span data-ttu-id="67770-195">如图2所示，此值设置为默认值 `DBNull`。</span><span class="sxs-lookup"><span data-stu-id="67770-195">As Figure 2 shows, this value is set to `DBNull`, the default.</span></span> <span data-ttu-id="67770-196">如果希望使用不同的默认值，只需相应地设置 `DefaultValue` 属性即可。</span><span class="sxs-lookup"><span data-stu-id="67770-196">If you would prefer a different default value, simply set the `DefaultValue` property accordingly.</span></span> <span data-ttu-id="67770-197">只需确保 `DefaultValue` 值在给定列 s `DataType` （即 `PriceQuartile` 列的 `System.Int32`）时有效。</span><span class="sxs-lookup"><span data-stu-id="67770-197">Just make sure that the `DefaultValue` value is valid given the column s `DataType` (i.e., `System.Int32` for the `PriceQuartile` column).</span></span>

<span data-ttu-id="67770-198">此时，我们已执行将其他列添加到 DataTable 的必要步骤。</span><span class="sxs-lookup"><span data-stu-id="67770-198">At this point we have performed the necessary steps for adding an additional column to a DataTable.</span></span> <span data-ttu-id="67770-199">若要验证此附加列是否按预期运行，请创建一个 ASP.NET 页，其中显示每个产品的名称、价格和价格分位。</span><span class="sxs-lookup"><span data-stu-id="67770-199">To verify that this additional column works as expected, let s create an ASP.NET page that displays each product s name, price, and price quartile.</span></span> <span data-ttu-id="67770-200">但在执行此操作之前，我们首先需要更新业务逻辑层，使其包含一个方法，该方法向下调用 DAL s `GetProductsWithPriceQuartile` 方法。</span><span class="sxs-lookup"><span data-stu-id="67770-200">Before we do that, though, we first need to update the Business Logic Layer to include a method that calls down to the DAL s `GetProductsWithPriceQuartile` method.</span></span> <span data-ttu-id="67770-201">我们将在步骤3中更新 BLL，然后在步骤4中创建 ASP.NET 页。</span><span class="sxs-lookup"><span data-stu-id="67770-201">We will update the BLL next, in Step 3, and then create the ASP.NET page in Step 4.</span></span>

## <a name="step-3-augmenting-the-business-logic-layer"></a><span data-ttu-id="67770-202">步骤3：扩充业务逻辑层</span><span class="sxs-lookup"><span data-stu-id="67770-202">Step 3: Augmenting the Business Logic Layer</span></span>

<span data-ttu-id="67770-203">在使用表示层中的新 `GetProductsWithPriceQuartile` 方法之前，我们应该首先向 BLL 添加相应的方法。</span><span class="sxs-lookup"><span data-stu-id="67770-203">Before we use the new `GetProductsWithPriceQuartile` method from the Presentation Layer, we should first add a corresponding method to the BLL.</span></span> <span data-ttu-id="67770-204">打开 `ProductsBLLWithSprocs` 类文件，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="67770-204">Open the `ProductsBLLWithSprocs` class file and add the following code:</span></span>

[!code-csharp[Main](adding-additional-datatable-columns-cs/samples/sample2.cs)]

<span data-ttu-id="67770-205">与 `ProductsBLLWithSprocs`中的其他数据检索方法一样，`GetProductsWithPriceQuartile` 方法只调用 DAL s 对应的 `GetProductsWithPriceQuartile` 方法并返回其结果。</span><span class="sxs-lookup"><span data-stu-id="67770-205">Like the other data retrieval methods in `ProductsBLLWithSprocs`, the `GetProductsWithPriceQuartile` method simply calls the DAL s corresponding `GetProductsWithPriceQuartile` method and returns its results.</span></span>

## <a name="step-4-displaying-the-price-quartile-information-in-an-aspnet-web-page"></a><span data-ttu-id="67770-206">步骤4：在 ASP.NET 网页中显示价格分位信息</span><span class="sxs-lookup"><span data-stu-id="67770-206">Step 4: Displaying the Price Quartile Information in an ASP.NET Web Page</span></span>

<span data-ttu-id="67770-207">随着 BLL 添加完成，我们已准备好创建 ASP.NET 页，其中显示了每个产品的价格分位数。</span><span class="sxs-lookup"><span data-stu-id="67770-207">With the BLL addition complete we re ready to create an ASP.NET page that shows the price quartile for each product.</span></span> <span data-ttu-id="67770-208">打开 `AdvancedDAL` 文件夹中的 "`AddingColumns.aspx`" 页，然后将 GridView 从工具箱拖动到设计器上，并将其 `ID` 属性设置为 "`Products`"。</span><span class="sxs-lookup"><span data-stu-id="67770-208">Open the `AddingColumns.aspx` page in the `AdvancedDAL` folder and drag a GridView from the Toolbox onto the Designer, setting its `ID` property to `Products`.</span></span> <span data-ttu-id="67770-209">从 GridView s 智能标记中，将其绑定到名为 `ProductsDataSource`的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="67770-209">From the GridView s smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="67770-210">将 ObjectDataSource 配置为使用 `ProductsBLLWithSprocs` 类 `GetProductsWithPriceQuartile` 方法。</span><span class="sxs-lookup"><span data-stu-id="67770-210">Configure the ObjectDataSource to use the `ProductsBLLWithSprocs` class s `GetProductsWithPriceQuartile` method.</span></span> <span data-ttu-id="67770-211">由于这将是只读网格，因此请将 "更新"、"插入" 和 "删除" 选项卡中的下拉列表设置为 "（无）"。</span><span class="sxs-lookup"><span data-stu-id="67770-211">Since this will be a read-only grid, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>

<span data-ttu-id="67770-212">[![将 ObjectDataSource 配置为使用 ProductsBLLWithSprocs 类](adding-additional-datatable-columns-cs/_static/image24.png)](adding-additional-datatable-columns-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="67770-212">[![Configure the ObjectDataSource to Use the ProductsBLLWithSprocs Class](adding-additional-datatable-columns-cs/_static/image24.png)](adding-additional-datatable-columns-cs/_static/image23.png)</span></span>

<span data-ttu-id="67770-213">**图 9**：将 ObjectDataSource 配置为使用 `ProductsBLLWithSprocs` 类（[单击以查看完全大小的映像](adding-additional-datatable-columns-cs/_static/image25.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-213">**Figure 9**: Configure the ObjectDataSource to Use the `ProductsBLLWithSprocs` Class ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image25.png))</span></span>

<span data-ttu-id="67770-214">[![从 GetProductsWithPriceQuartile 方法检索产品信息](adding-additional-datatable-columns-cs/_static/image27.png)](adding-additional-datatable-columns-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="67770-214">[![Retrieve Product Information from the GetProductsWithPriceQuartile Method](adding-additional-datatable-columns-cs/_static/image27.png)](adding-additional-datatable-columns-cs/_static/image26.png)</span></span>

<span data-ttu-id="67770-215">**图 10**：从 `GetProductsWithPriceQuartile` 方法检索产品信息（[单击以查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image28.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-215">**Figure 10**: Retrieve Product Information from the `GetProductsWithPriceQuartile` Method ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image28.png))</span></span>

<span data-ttu-id="67770-216">完成 "配置数据源" 向导后，Visual Studio 将为方法返回的每个数据字段自动向 GridView 添加 BoundField 或 CheckBoxField。</span><span class="sxs-lookup"><span data-stu-id="67770-216">After completing the Configure Data Source wizard, Visual Studio will automatically add a BoundField or CheckBoxField to the GridView for each of the data fields returned by the method.</span></span> <span data-ttu-id="67770-217">其中一个数据字段是 `PriceQuartile`，这是我们添加到步骤1中的 `ProductsDataTable` 的列。</span><span class="sxs-lookup"><span data-stu-id="67770-217">One of these data fields is `PriceQuartile`, which is the column we added to the `ProductsDataTable` in Step 1.</span></span>

<span data-ttu-id="67770-218">编辑 GridView s 字段，删除除 `ProductName`、`UnitPrice`和 `PriceQuartile` BoundFields 以外的所有字段。</span><span class="sxs-lookup"><span data-stu-id="67770-218">Edit the GridView s fields, removing all but the `ProductName`, `UnitPrice`, and `PriceQuartile` BoundFields.</span></span> <span data-ttu-id="67770-219">将 `UnitPrice` BoundField 配置为将其值设置为货币格式，并分别使用 `UnitPrice` 和 `PriceQuartile` BoundFields 右对齐。</span><span class="sxs-lookup"><span data-stu-id="67770-219">Configure the `UnitPrice` BoundField to format its value as a currency and have the `UnitPrice` and `PriceQuartile` BoundFields right- and center-aligned, respectively.</span></span> <span data-ttu-id="67770-220">最后，将其余的 BoundFields `HeaderText` 属性分别更新为 "产品"、"价格" 和 "价格"。</span><span class="sxs-lookup"><span data-stu-id="67770-220">Finally, update the remaining BoundFields `HeaderText` properties to Product, Price, and Price Quartile, respectively.</span></span> <span data-ttu-id="67770-221">另外，请检查 GridView s 智能标记的 "启用排序" 复选框。</span><span class="sxs-lookup"><span data-stu-id="67770-221">Also, check the Enable Sorting checkbox from the GridView s smart tag.</span></span>

<span data-ttu-id="67770-222">进行这些修改后，GridView 和 ObjectDataSource 的声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="67770-222">After these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](adding-additional-datatable-columns-cs/samples/sample3.aspx)]

<span data-ttu-id="67770-223">图11在通过浏览器访问时显示此页。</span><span class="sxs-lookup"><span data-stu-id="67770-223">Figure 11 shows this page when visited through a browser.</span></span> <span data-ttu-id="67770-224">请注意，最初产品按其价格降序排序，每个产品分配有合适的 `PriceQuartile` 值。</span><span class="sxs-lookup"><span data-stu-id="67770-224">Note that, initially, the products are ordered by their price in descending order with each product assigned an appropriate `PriceQuartile` value.</span></span> <span data-ttu-id="67770-225">当然，此数据可以按其他条件进行排序，而价格按四位数的列值仍反映了产品对价格的排名（参见图12）。</span><span class="sxs-lookup"><span data-stu-id="67770-225">Of course this data can be sorted by other criteria with the Price Quartile column value still reflecting the product s ranking with respect to price (see Figure 12).</span></span>

<span data-ttu-id="67770-226">[![产品按其价格排序](adding-additional-datatable-columns-cs/_static/image30.png)](adding-additional-datatable-columns-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="67770-226">[![The Products are Ordered by their Prices](adding-additional-datatable-columns-cs/_static/image30.png)](adding-additional-datatable-columns-cs/_static/image29.png)</span></span>

<span data-ttu-id="67770-227">**图 11**：产品按其价格排序（[单击查看全尺寸图像](adding-additional-datatable-columns-cs/_static/image31.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-227">**Figure 11**: The Products are Ordered by their Prices ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image31.png))</span></span>

<span data-ttu-id="67770-228">[按产品名称对产品进行排序 ![](adding-additional-datatable-columns-cs/_static/image33.png)](adding-additional-datatable-columns-cs/_static/image32.png)</span><span class="sxs-lookup"><span data-stu-id="67770-228">[![The Products are Ordered by their Names](adding-additional-datatable-columns-cs/_static/image33.png)](adding-additional-datatable-columns-cs/_static/image32.png)</span></span>

<span data-ttu-id="67770-229">**图 12**：产品按其名称排序（[单击以查看完全大小的图像](adding-additional-datatable-columns-cs/_static/image34.png)）</span><span class="sxs-lookup"><span data-stu-id="67770-229">**Figure 12**: The Products are Ordered by their Names ([Click to view full-size image](adding-additional-datatable-columns-cs/_static/image34.png))</span></span>

> [!NOTE]
> <span data-ttu-id="67770-230">只需编写几行代码，就能增加 GridView，使其基于 `PriceQuartile` 值为产品行着色。</span><span class="sxs-lookup"><span data-stu-id="67770-230">With a few lines of code we could augment the GridView so that it colored the product rows based on their `PriceQuartile` value.</span></span> <span data-ttu-id="67770-231">我们可能会将第一个四分中的产品着色为浅绿色，第二个四阶绿色表示黄色，依此类推。</span><span class="sxs-lookup"><span data-stu-id="67770-231">We might color those products in the first quartile a light green, those in the second quartile a light yellow, and so forth.</span></span> <span data-ttu-id="67770-232">我建议您花点时间来添加此功能。</span><span class="sxs-lookup"><span data-stu-id="67770-232">I encourage you to take a moment to add this functionality.</span></span> <span data-ttu-id="67770-233">如果需要有关设置 GridView 格式的刷新器，请参阅[基于数据的自定义格式设置](../custom-formatting/custom-formatting-based-upon-data-cs.md)教程。</span><span class="sxs-lookup"><span data-stu-id="67770-233">If you need a refresher on formatting a GridView, consult the [Custom Formatting Based Upon Data](../custom-formatting/custom-formatting-based-upon-data-cs.md) tutorial.</span></span>

## <a name="an-alternative-approach---creating-another-tableadapter"></a><span data-ttu-id="67770-234">另一种方法-创建其他 TableAdapter</span><span class="sxs-lookup"><span data-stu-id="67770-234">An Alternative Approach - Creating Another TableAdapter</span></span>

<span data-ttu-id="67770-235">正如我们在本教程中看到的，在将方法添加到返回除主查询所述的数据字段以外的其他数据字段时，可以将相应的列添加到 DataTable。</span><span class="sxs-lookup"><span data-stu-id="67770-235">As we saw in this tutorial, when adding a method to a TableAdapter that returns data fields other than those spelled out by the main query, we can add corresponding columns to the DataTable.</span></span> <span data-ttu-id="67770-236">但是，这种方法只有在 TableAdapter 中有少量方法返回不同的数据字段，并且这些备用数据字段不会在主查询中发生太大变化时，此方法才有效。</span><span class="sxs-lookup"><span data-stu-id="67770-236">Such an approach, however, works well only if there are a small number of methods in the TableAdapter that return different data fields and if those alternate data fields do not vary too much from the main query.</span></span>

<span data-ttu-id="67770-237">您可以改为将其他 TableAdapter 添加到包含返回不同数据字段的第一个 TableAdapter 中的方法的数据集，而不是将列添加到 DataTable。</span><span class="sxs-lookup"><span data-stu-id="67770-237">Rather than adding columns to the DataTable, you can instead add another TableAdapter to the DataSet that contains the methods from the first TableAdapter that return different data fields.</span></span> <span data-ttu-id="67770-238">对于本教程，请不要将 `PriceQuartile` 列添加到 `ProductsDataTable` （其中它仅由 `GetProductsWithPriceQuartile` 方法使用），我们可以将其他 TableAdapter 添加到使用 `Products_SelectWithPriceQuartile` 存储过程作为其主要查询的数据集 `ProductsWithPriceQuartileTableAdapter`。</span><span class="sxs-lookup"><span data-stu-id="67770-238">For this tutorial, rather than add the `PriceQuartile` column to the `ProductsDataTable` (where it is only used by the `GetProductsWithPriceQuartile` method), we could have added an additional TableAdapter to the DataSet named `ProductsWithPriceQuartileTableAdapter` that used the `Products_SelectWithPriceQuartile` stored procedure as its main query.</span></span> <span data-ttu-id="67770-239">以 ASP.NET 的价格来获取产品信息所需的页面将使用 `ProductsWithPriceQuartileTableAdapter`，而不能继续使用 `ProductsTableAdapter`。</span><span class="sxs-lookup"><span data-stu-id="67770-239">ASP.NET pages that needed to get product information with the price quartile would use the `ProductsWithPriceQuartileTableAdapter`, while those that did not could continue to use the `ProductsTableAdapter`.</span></span>

<span data-ttu-id="67770-240">通过添加新的 TableAdapter，数据表保持 untarnished，并且其列精确镜像由 TableAdapter s 方法返回的数据字段。</span><span class="sxs-lookup"><span data-stu-id="67770-240">By adding a new TableAdapter, the DataTables remain untarnished and their columns precisely mirror the data fields returned by their TableAdapter s methods.</span></span> <span data-ttu-id="67770-241">但是，其他 Tableadapter 可能会引入重复的任务和功能。</span><span class="sxs-lookup"><span data-stu-id="67770-241">However, additional TableAdapters can introduce repetitive tasks and functionality.</span></span> <span data-ttu-id="67770-242">例如，如果那些显示 `PriceQuartile` 列的 ASP.NET 页面还需要提供插入、更新和删除支持，则 `ProductsWithPriceQuartileTableAdapter` 需要正确配置其 `InsertCommand`、`UpdateCommand`和 `DeleteCommand` 属性。</span><span class="sxs-lookup"><span data-stu-id="67770-242">For example, if those ASP.NET pages that displayed the `PriceQuartile` column also needed to provide insert, update, and delete support, the `ProductsWithPriceQuartileTableAdapter` would need to have its `InsertCommand`, `UpdateCommand`, and `DeleteCommand` properties properly configured.</span></span> <span data-ttu-id="67770-243">尽管这些属性会镜像 `ProductsTableAdapter`，但此配置会引入额外的步骤。</span><span class="sxs-lookup"><span data-stu-id="67770-243">While these properties would mirror the `ProductsTableAdapter` s, this configuration introduces an extra step.</span></span> <span data-ttu-id="67770-244">此外，现在有两种方法可用于更新、删除或向数据库添加产品-通过 `ProductsTableAdapter` 和 `ProductsWithPriceQuartileTableAdapter` 类。</span><span class="sxs-lookup"><span data-stu-id="67770-244">Moreover, there are now two ways to update, delete, or add a product to the database - through the `ProductsTableAdapter` and `ProductsWithPriceQuartileTableAdapter` classes.</span></span>

<span data-ttu-id="67770-245">本教程的下载内容包括 `NorthwindWithSprocs` 数据集中的 `ProductsWithPriceQuartileTableAdapter` 类，其中阐释了此替代方法。</span><span class="sxs-lookup"><span data-stu-id="67770-245">The download for this tutorial includes a `ProductsWithPriceQuartileTableAdapter` class in the `NorthwindWithSprocs` DataSet that illustrates this alternative approach.</span></span>

## <a name="summary"></a><span data-ttu-id="67770-246">摘要</span><span class="sxs-lookup"><span data-stu-id="67770-246">Summary</span></span>

<span data-ttu-id="67770-247">在大多数情况下，TableAdapter 中的所有方法都将返回相同的一组数据字段，但在某些时候，特定的方法或两个可能需要返回一个附加字段。</span><span class="sxs-lookup"><span data-stu-id="67770-247">In most scenarios, all of the methods in a TableAdapter will return the same set of data fields, but there are times when a particular method or two may need to return an additional field.</span></span> <span data-ttu-id="67770-248">例如，在[主/详细信息中，使用带有详细信息 DataList 教程的主记录的项目符号列表](../filtering-scenarios-with-the-datalist-and-repeater/master-detail-using-a-bulleted-list-of-master-records-with-a-details-datalist-cs.md)，我们向 `CategoriesTableAdapter` 添加了一种方法，除了主查询的数据字段外，还返回了报告与每个类别关联的产品数量的 `NumberOfProducts` 字段。</span><span class="sxs-lookup"><span data-stu-id="67770-248">For example, in the [Master/Detail Using a Bulleted List of Master Records with a Details DataList](../filtering-scenarios-with-the-datalist-and-repeater/master-detail-using-a-bulleted-list-of-master-records-with-a-details-datalist-cs.md) tutorial we added a method to the `CategoriesTableAdapter` that, in addition to the main query s data fields, returned a `NumberOfProducts` field that reported the number of products associated with each category.</span></span> <span data-ttu-id="67770-249">在本教程中，我们将介绍如何在 `ProductsTableAdapter` 中添加一个方法，该方法将返回 "`PriceQuartile`" 字段以及主查询数据字段。</span><span class="sxs-lookup"><span data-stu-id="67770-249">In this tutorial we looked at adding a method in the `ProductsTableAdapter` that returned a `PriceQuartile` field in addition to the main query s data fields.</span></span> <span data-ttu-id="67770-250">若要捕获由 TableAdapter s 方法返回的其他数据字段，需要将相应的列添加到 DataTable。</span><span class="sxs-lookup"><span data-stu-id="67770-250">To capture additional data fields returned by the TableAdapter s methods we need to add corresponding columns to the DataTable.</span></span>

<span data-ttu-id="67770-251">如果你计划手动将列添加到 DataTable，则建议 TableAdapter 使用存储过程。</span><span class="sxs-lookup"><span data-stu-id="67770-251">If you plan on manually adding columns to the DataTable, it is recommended that the TableAdapter use stored procedures.</span></span> <span data-ttu-id="67770-252">如果 TableAdapter 使用即席 SQL 语句，则每当 TableAdapter 配置向导运行时，数据字段列表中的所有方法都将恢复为主查询返回的数据字段。</span><span class="sxs-lookup"><span data-stu-id="67770-252">If the TableAdapter uses ad-hoc SQL statements, any time the TableAdapter Configuration wizard is run all of the methods data field lists revert to the data fields returned by the main query.</span></span> <span data-ttu-id="67770-253">此问题不会扩展到存储过程，这就是我们建议并在本教程中使用的原因。</span><span class="sxs-lookup"><span data-stu-id="67770-253">This problem does not extend to stored procedures, which is why they are recommended and were used in this tutorial.</span></span>

<span data-ttu-id="67770-254">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="67770-254">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="67770-255">关于作者</span><span class="sxs-lookup"><span data-stu-id="67770-255">About the Author</span></span>

<span data-ttu-id="67770-256">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已在使用 Microsoft Web 技术，自1998开始。</span><span class="sxs-lookup"><span data-stu-id="67770-256">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="67770-257">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="67770-257">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="67770-258">他的最新书籍是，[*在24小时内，sam ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="67770-258">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="67770-259">可以[mitchell@4GuysFromRolla.com访问。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="67770-259">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="67770-260">或通过他的博客，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="67770-260">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="67770-261">特别感谢</span><span class="sxs-lookup"><span data-stu-id="67770-261">Special Thanks To</span></span>

<span data-ttu-id="67770-262">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="67770-262">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="67770-263">本教程的主管评审者是 Randy Schmidt、Jacky Goor、Bernadette Leigh 和 Hilton Giesenow。</span><span class="sxs-lookup"><span data-stu-id="67770-263">Lead reviewers for this tutorial were Randy Schmidt, Jacky Goor, Bernadette Leigh, and Hilton Giesenow.</span></span> <span data-ttu-id="67770-264">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="67770-264">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="67770-265">如果是这样，请在mitchell@4GuysFromRolla.com放置一行[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="67770-265">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="67770-266">[上一页](updating-the-tableadapter-to-use-joins-cs.md)
> [下一页](working-with-computed-columns-cs.md)</span><span class="sxs-lookup"><span data-stu-id="67770-266">[Previous](updating-the-tableadapter-to-use-joins-cs.md)
[Next](working-with-computed-columns-cs.md)</span></span>
