---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/protecting-connection-strings-and-other-configuration-information-cs
title: 保护连接字符串和其他配置信息（C#） |Microsoft Docs
author: rick-anderson
description: ASP.NET 应用程序通常将配置信息存储在 web.config 文件中。 此信息中的某些信息是敏感的，并保证受到保护。 通过定义 。
ms.author: riande
ms.date: 08/03/2007
ms.assetid: ad8dd396-30f7-4abe-ac02-a0b84422e5be
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/protecting-connection-strings-and-other-configuration-information-cs
msc.type: authoredcontent
ms.openlocfilehash: 15970bee1e990d3a139673efe12486e08f79814c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/28/2019
ms.locfileid: "74573514"
---
# <a name="protecting-connection-strings-and-other-configuration-information-c"></a><span data-ttu-id="a4609-105">保护连接字符串和其他配置信息 (C#)</span><span class="sxs-lookup"><span data-stu-id="a4609-105">Protecting Connection Strings and Other Configuration Information (C#)</span></span>

<span data-ttu-id="a4609-106">作者： [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="a4609-106">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="a4609-107">[下载代码](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_73_CS.zip)或[下载 PDF](protecting-connection-strings-and-other-configuration-information-cs/_static/datatutorial73cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="a4609-107">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_73_CS.zip) or [Download PDF](protecting-connection-strings-and-other-configuration-information-cs/_static/datatutorial73cs1.pdf)</span></span>

> <span data-ttu-id="a4609-108">ASP.NET 应用程序通常将配置信息存储在 web.config 文件中。</span><span class="sxs-lookup"><span data-stu-id="a4609-108">An ASP.NET application typically stores configuration information in a Web.config file.</span></span> <span data-ttu-id="a4609-109">此信息中的某些信息是敏感的，并保证受到保护。</span><span class="sxs-lookup"><span data-stu-id="a4609-109">Some of this information is sensitive and warrants protection.</span></span> <span data-ttu-id="a4609-110">默认情况下，不会向网站访问者提供此文件，但管理员或黑客可能会获得对 Web 服务器的文件系统的访问权限，并查看文件的内容。</span><span class="sxs-lookup"><span data-stu-id="a4609-110">By default this file will not be served to a Web site visitor, but an administrator or a hacker may gain access to the Web server's file system and view the contents of the file.</span></span> <span data-ttu-id="a4609-111">在本教程中，我们将了解 ASP.NET 2.0 通过加密 Web.config 文件的各节来保护敏感信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-111">In this tutorial we learn that ASP.NET 2.0 allows us to protect sensitive information by encrypting sections of the Web.config file.</span></span>

## <a name="introduction"></a><span data-ttu-id="a4609-112">简介</span><span class="sxs-lookup"><span data-stu-id="a4609-112">Introduction</span></span>

<span data-ttu-id="a4609-113">ASP.NET 应用程序的配置信息通常存储在名为 `Web.config`的 XML 文件中。</span><span class="sxs-lookup"><span data-stu-id="a4609-113">Configuration information for ASP.NET applications is commonly stored in an XML file named `Web.config`.</span></span> <span data-ttu-id="a4609-114">在这些教程中，我们已更新了几次 `Web.config`。</span><span class="sxs-lookup"><span data-stu-id="a4609-114">Over the course of these tutorials we have updated the `Web.config` a handful of times.</span></span> <span data-ttu-id="a4609-115">例如，在[第一个教程](../introduction/creating-a-data-access-layer-cs.md)中创建 `Northwind` 类型化的数据集时，会自动将连接字符串信息添加到 `<connectionStrings>` 部分的 `Web.config` 中。</span><span class="sxs-lookup"><span data-stu-id="a4609-115">When creating the `Northwind` Typed DataSet in the [first tutorial](../introduction/creating-a-data-access-layer-cs.md), for example, connection string information was automatically added to `Web.config` in the `<connectionStrings>` section.</span></span> <span data-ttu-id="a4609-116">稍后，在[母版页和站点导航](../introduction/master-pages-and-site-navigation-cs.md)教程中，我们手动更新 `Web.config`，添加一个 `<pages>` 元素，该元素指示项目中的所有 ASP.NET 页面都应使用 `DataWebControls` 主题。</span><span class="sxs-lookup"><span data-stu-id="a4609-116">Later, in the [Master Pages and Site Navigation](../introduction/master-pages-and-site-navigation-cs.md) tutorial, we manually updated `Web.config`, adding a `<pages>` element indicating that all of the ASP.NET pages in our project should use the `DataWebControls` Theme.</span></span>

<span data-ttu-id="a4609-117">由于 `Web.config` 可能包含敏感数据（如连接字符串），因此 `Web.config` 的内容在未经授权的查看器中保持安全和隐藏非常重要。</span><span class="sxs-lookup"><span data-stu-id="a4609-117">Since `Web.config` may contain sensitive data such as connection strings, it is important that the contents of `Web.config` be kept safe and hidden from unauthorized viewers.</span></span> <span data-ttu-id="a4609-118">默认情况下，ASP.NET 引擎将处理对具有 `.config` 扩展的文件发出的任何 HTTP 请求，该引擎将返回图1所示的 "*此类型的页未提供*" 消息。</span><span class="sxs-lookup"><span data-stu-id="a4609-118">By default, any HTTP request to a file with the `.config` extension is handled by the ASP.NET engine, which returns the *This type of page is not served* message shown in Figure 1.</span></span> <span data-ttu-id="a4609-119">这意味着，访问者只需在浏览器的地址栏中输入 http://www.YourServer.com/Web.config ，就不能查看 `Web.config` 的文件内容。</span><span class="sxs-lookup"><span data-stu-id="a4609-119">This means that visitors cannot view your `Web.config` file s contents by simply entering http://www.YourServer.com/Web.config into their browser s Address bar.</span></span>

<span data-ttu-id="a4609-120">[![通过浏览器访问 web.config 返回了此类型的页未提供消息](protecting-connection-strings-and-other-configuration-information-cs/_static/image2.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="a4609-120">[![Visiting Web.config Through a Browser Returns a This type of page is not served Message](protecting-connection-strings-and-other-configuration-information-cs/_static/image2.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image1.png)</span></span>

<span data-ttu-id="a4609-121">**图 1**：通过浏览器访问 `Web.config` 返回此类型的页未提供消息（[单击以查看完全大小的图像](protecting-connection-strings-and-other-configuration-information-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="a4609-121">**Figure 1**: Visiting `Web.config` Through a Browser Returns a This type of page is not served Message ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image3.png))</span></span>

<span data-ttu-id="a4609-122">但是，如果攻击者能够找到允许她查看 `Web.config` 文件内容的其他攻击，该怎么办？</span><span class="sxs-lookup"><span data-stu-id="a4609-122">But what if an attacker is able to find some other exploit that allows her to view your `Web.config` file s contents?</span></span> <span data-ttu-id="a4609-123">攻击者使用此信息可以做什么，以及可以采取哪些步骤来进一步保护 `Web.config`中的敏感信息？</span><span class="sxs-lookup"><span data-stu-id="a4609-123">What could an attacker do with this information, and what steps can be taken to further protect the sensitive information within `Web.config`?</span></span> <span data-ttu-id="a4609-124">幸运的是，`Web.config` 中的大部分部分都不包含敏感信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-124">Fortunately, most sections in `Web.config` do not contain sensitive information.</span></span> <span data-ttu-id="a4609-125">如果攻击者知道您的 ASP.NET 页面所使用的默认主题的名称，攻击者会 perpetrate 哪些损害？</span><span class="sxs-lookup"><span data-stu-id="a4609-125">What harm can an attacker perpetrate if they know the name of the default Theme used by your ASP.NET pages?</span></span>

<span data-ttu-id="a4609-126">但是，某些 `Web.config` 部分包含敏感信息，这些信息可能包括连接字符串、用户名、密码、服务器名称、加密密钥等。</span><span class="sxs-lookup"><span data-stu-id="a4609-126">Certain `Web.config` sections, however, contain sensitive information that may include connection strings, user names, passwords, server names, encryption keys, and so forth.</span></span> <span data-ttu-id="a4609-127">此信息通常在以下 `Web.config` 部分中找到：</span><span class="sxs-lookup"><span data-stu-id="a4609-127">This information is typically found in the following `Web.config` sections:</span></span>

- `<appSettings>`
- `<connectionStrings>`
- `<identity>`
- `<sessionState>`

<span data-ttu-id="a4609-128">在本教程中，我们将介绍保护此类敏感配置信息的方法。</span><span class="sxs-lookup"><span data-stu-id="a4609-128">In this tutorial we will look at techniques for protecting such sensitive configuration information.</span></span> <span data-ttu-id="a4609-129">如我们所见，.NET Framework 版本2.0 包含一个受保护的配置系统，它使所选配置节以编程方式加密和解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-129">As we will see, the .NET Framework version 2.0 includes a protected configurations system that makes programmatically encrypting and decrypting selected configuration sections a breeze.</span></span>

> [!NOTE]
> <span data-ttu-id="a4609-130">本教程最后介绍了从 ASP.NET 应用程序连接到数据库的 Microsoft 建议。</span><span class="sxs-lookup"><span data-stu-id="a4609-130">This tutorial concludes with a look at Microsoft s recommendations for connecting to a database from an ASP.NET application.</span></span> <span data-ttu-id="a4609-131">除了对连接字符串进行加密以外，还可以通过确保以安全的方式连接到数据库来帮助强化系统。</span><span class="sxs-lookup"><span data-stu-id="a4609-131">In addition to encrypting your connection strings, you can help harden your system by ensuring that you are connecting to the database in a secure fashion.</span></span>

## <a name="step-1-exploring-aspnet-20-s-protected-configuration-options"></a><span data-ttu-id="a4609-132">步骤1：浏览 ASP.NET 2.0 s 受保护的配置选项</span><span class="sxs-lookup"><span data-stu-id="a4609-132">Step 1: Exploring ASP.NET 2.0 s Protected Configuration Options</span></span>

<span data-ttu-id="a4609-133">ASP.NET 2.0 包含用于加密和解密配置信息的受保护配置系统。</span><span class="sxs-lookup"><span data-stu-id="a4609-133">ASP.NET 2.0 includes a protected configuration system for encrypting and decrypting configuration information.</span></span> <span data-ttu-id="a4609-134">这包括 .NET Framework 中可用于以编程方式加密或解密配置信息的方法。</span><span class="sxs-lookup"><span data-stu-id="a4609-134">This includes methods in the .NET Framework that can be used to programmatically encrypt or decrypt configuration information.</span></span> <span data-ttu-id="a4609-135">受保护的配置系统使用[提供程序模型](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)，这允许开发人员选择使用哪种加密实现。</span><span class="sxs-lookup"><span data-stu-id="a4609-135">The protected configuration system uses the [provider model](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), which allows developers to choose what cryptographic implementation is used.</span></span>

<span data-ttu-id="a4609-136">.NET Framework 附带了两个受保护的配置提供程序：</span><span class="sxs-lookup"><span data-stu-id="a4609-136">The .NET Framework ships with two protected configuration providers:</span></span>

- <span data-ttu-id="a4609-137">[`RSAProtectedConfigurationProvider`](https://msdn.microsoft.com/library/system.configuration.rsaprotectedconfigurationprovider.aspx) -使用非对称[RSA 算法](http://en.wikipedia.org/wiki/Rsa)进行加密和解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-137">[`RSAProtectedConfigurationProvider`](https://msdn.microsoft.com/library/system.configuration.rsaprotectedconfigurationprovider.aspx) - uses the asymmetric [RSA algorithm](http://en.wikipedia.org/wiki/Rsa) for encryption and decryption.</span></span>
- <span data-ttu-id="a4609-138">[`DPAPIProtectedConfigurationProvider`](https://msdn.microsoft.com/system.configuration.dpapiprotectedconfigurationprovider.aspx) -使用 Windows[数据保护 API （DPAPI）](https://msdn.microsoft.com/library/ms995355.aspx)进行加密和解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-138">[`DPAPIProtectedConfigurationProvider`](https://msdn.microsoft.com/system.configuration.dpapiprotectedconfigurationprovider.aspx) - uses the Windows [Data Protection API (DPAPI)](https://msdn.microsoft.com/library/ms995355.aspx) for encryption and decryption.</span></span>

<span data-ttu-id="a4609-139">由于受保护的配置系统实现了提供程序的设计模式，因此，可以创建自己的受保护配置提供程序并将其插入应用程序。</span><span class="sxs-lookup"><span data-stu-id="a4609-139">Since the protected configuration system implements the provider design pattern, it is possible to create your own protected configuration provider and plug it into your application.</span></span> <span data-ttu-id="a4609-140">有关此过程的详细信息，请参阅[实现受保护的配置提供程序](https://msdn.microsoft.com/library/wfc2t3az(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="a4609-140">See [Implementing a Protected Configuration Provider](https://msdn.microsoft.com/library/wfc2t3az(VS.80).aspx) for more information on this process.</span></span>

<span data-ttu-id="a4609-141">RSA 和 DPAPI 提供程序使用密钥进行加密和解密例程，这些密钥可以存储在计算机或用户级别。</span><span class="sxs-lookup"><span data-stu-id="a4609-141">The RSA and DPAPI providers use keys for their encryption and decryption routines, and these keys can be stored at the machine- or user-level.</span></span> <span data-ttu-id="a4609-142">如果 web 应用程序在其自己的专用服务器上运行，或者如果服务器上有多个应用程序需要共享加密信息，则计算机级别的密钥非常适合使用。</span><span class="sxs-lookup"><span data-stu-id="a4609-142">Machine-level keys are ideal for scenarios where the web application runs on its own dedicated server or if there are multiple applications on a server that need to share encrypted information.</span></span> <span data-ttu-id="a4609-143">在共享托管环境中，用户级密钥是一种更安全的选项，在这种环境中，同一服务器上的其他应用程序应该无法对应用程序的受保护配置部分进行解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-143">User-level keys are a more secure option in shared hosting environments where other applications on the same server should not be able to decrypt your application s protected configuration sections.</span></span>

<span data-ttu-id="a4609-144">在本教程中，我们的示例将使用 DPAPI 提供程序和计算机级别的密钥。</span><span class="sxs-lookup"><span data-stu-id="a4609-144">In this tutorial our examples will use the DPAPI provider and machine-level keys.</span></span> <span data-ttu-id="a4609-145">具体而言，我们将在 `Web.config`中查看加密 `<connectionStrings>` 部分，尽管受保护的配置系统可用于对大多数 `Web.config` 部分进行加密。</span><span class="sxs-lookup"><span data-stu-id="a4609-145">Specifically, we will look at encrypting the `<connectionStrings>` section in `Web.config`, although the protected configuration system can be used to encrypt most any `Web.config` section.</span></span> <span data-ttu-id="a4609-146">有关使用用户级密钥或使用 RSA 提供程序的信息，请参阅本教程末尾的 "后续读取" 部分中的资源。</span><span class="sxs-lookup"><span data-stu-id="a4609-146">For information on using user-level keys or using the RSA provider, consult the resources in the Further Readings section at the end of this tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="a4609-147">`RSAProtectedConfigurationProvider` 和 `DPAPIProtectedConfigurationProvider` 提供程序在 `machine.config` 文件中注册，并且提供程序名称分别为 `RsaProtectedConfigurationProvider` 和 `DataProtectionConfigurationProvider`。</span><span class="sxs-lookup"><span data-stu-id="a4609-147">The `RSAProtectedConfigurationProvider` and `DPAPIProtectedConfigurationProvider` providers are registered in the `machine.config` file with the provider names `RsaProtectedConfigurationProvider` and `DataProtectionConfigurationProvider`, respectively.</span></span> <span data-ttu-id="a4609-148">加密或解密配置信息时，需要提供相应的提供程序名称（`RsaProtectedConfigurationProvider` 或 `DataProtectionConfigurationProvider`），而不是实际的类型名称（`RSAProtectedConfigurationProvider` 和 `DPAPIProtectedConfigurationProvider`）。</span><span class="sxs-lookup"><span data-stu-id="a4609-148">When encrypting or decrypting configuration information we will need to supply the appropriate provider name (`RsaProtectedConfigurationProvider` or `DataProtectionConfigurationProvider`) rather than the actual type name (`RSAProtectedConfigurationProvider` and `DPAPIProtectedConfigurationProvider`).</span></span> <span data-ttu-id="a4609-149">可以在 "`$WINDOWS$\Microsoft.NET\Framework\version\CONFIG`" 文件夹中找到 `machine.config` 文件。</span><span class="sxs-lookup"><span data-stu-id="a4609-149">You can find the `machine.config` file in the `$WINDOWS$\Microsoft.NET\Framework\version\CONFIG` folder.</span></span>

## <a name="step-2-programmatically-encrypting-and-decrypting-configuration-sections"></a><span data-ttu-id="a4609-150">步骤2：以编程方式加密和解密配置节</span><span class="sxs-lookup"><span data-stu-id="a4609-150">Step 2: Programmatically Encrypting and Decrypting Configuration Sections</span></span>

<span data-ttu-id="a4609-151">只需几行代码，我们就可以使用指定的提供程序对特定的配置节进行加密或解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-151">With a few lines of code we can encrypt or decrypt a particular configuration section using a specified provider.</span></span> <span data-ttu-id="a4609-152">这段代码在不久就会看到，只需以编程方式引用适当的配置节，调用其 `ProtectSection` 或 `UnprotectSection` 方法，然后调用 `Save` 方法来持久保存这些更改。</span><span class="sxs-lookup"><span data-stu-id="a4609-152">The code, as we will see shortly, simply needs to programmatically reference the appropriate configuration section, call its `ProtectSection` or `UnprotectSection` method, and then call the `Save` method to persist the changes.</span></span> <span data-ttu-id="a4609-153">此外，.NET Framework 还提供了一个有用的命令行实用程序，可以加密和解密配置信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-153">Moreover, the .NET Framework includes a helpful command line utility that can encrypt and decrypt configuration information.</span></span> <span data-ttu-id="a4609-154">我们将在步骤3中探索此命令行实用工具。</span><span class="sxs-lookup"><span data-stu-id="a4609-154">We will explore this command line utility in Step 3.</span></span>

<span data-ttu-id="a4609-155">为了说明如何以编程方式保护配置信息，让我们创建一个包含用于加密和解密 `Web.config`中 `<connectionStrings>` 节的按钮的 ASP.NET 页面。</span><span class="sxs-lookup"><span data-stu-id="a4609-155">To illustrate programmatically protecting configuration information, let s create an ASP.NET page that includes buttons for encrypting and decrypting the `<connectionStrings>` section in `Web.config`.</span></span>

<span data-ttu-id="a4609-156">首先打开 `AdvancedDAL` 文件夹中的 "`EncryptingConfigSections.aspx`" 页。</span><span class="sxs-lookup"><span data-stu-id="a4609-156">Start by opening the `EncryptingConfigSections.aspx` page in the `AdvancedDAL` folder.</span></span> <span data-ttu-id="a4609-157">将 "TextBox" 控件从工具箱拖到设计器上，将其 `ID` 属性设置为 `WebConfigContents`，其 `TextMode` 属性设置为 `MultiLine`，并将其 `Width` 和 `Rows` 属性分别设置为95% 和15。</span><span class="sxs-lookup"><span data-stu-id="a4609-157">Drag a TextBox control from the Toolbox onto the Designer, setting its `ID` property to `WebConfigContents`, its `TextMode` property to `MultiLine`, and its `Width` and `Rows` properties to 95% and 15, respectively.</span></span> <span data-ttu-id="a4609-158">此 TextBox 控件将显示 `Web.config` 的内容，以便我们能够快速查看内容是否已加密。</span><span class="sxs-lookup"><span data-stu-id="a4609-158">This TextBox control will display the contents of `Web.config` allowing us to quickly see if the contents are encrypted or not.</span></span> <span data-ttu-id="a4609-159">当然，在实际应用程序中，您永远不希望显示 `Web.config`的内容。</span><span class="sxs-lookup"><span data-stu-id="a4609-159">Of course, in a real application you would never want to display the contents of `Web.config`.</span></span>

<span data-ttu-id="a4609-160">在文本框下，添加名为 `EncryptConnStrings` 和 `DecryptConnStrings`的两个按钮控件。</span><span class="sxs-lookup"><span data-stu-id="a4609-160">Beneath the TextBox, add two Button controls named `EncryptConnStrings` and `DecryptConnStrings`.</span></span> <span data-ttu-id="a4609-161">设置其文本属性以对连接字符串进行加密和解密连接字符串。</span><span class="sxs-lookup"><span data-stu-id="a4609-161">Set their Text properties to Encrypt Connection Strings and Decrypt Connection Strings .</span></span>

<span data-ttu-id="a4609-162">此时，屏幕应类似于图2。</span><span class="sxs-lookup"><span data-stu-id="a4609-162">At this point your screen should look similar to Figure 2.</span></span>

<span data-ttu-id="a4609-163">[![向页面添加一个文本框和两个按钮 Web 控件](protecting-connection-strings-and-other-configuration-information-cs/_static/image5.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="a4609-163">[![Add a TextBox and Two Button Web Controls to the Page](protecting-connection-strings-and-other-configuration-information-cs/_static/image5.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image4.png)</span></span>

<span data-ttu-id="a4609-164">**图 2**：向页面添加文本框和两个按钮 Web 控件（[单击以查看完全大小的图像](protecting-connection-strings-and-other-configuration-information-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="a4609-164">**Figure 2**: Add a TextBox and Two Button Web Controls to the Page ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image6.png))</span></span>

<span data-ttu-id="a4609-165">接下来，需要编写代码，以便在第一次加载页面时加载和显示 "`WebConfigContents`" 文本框中 `Web.config` 的内容。</span><span class="sxs-lookup"><span data-stu-id="a4609-165">Next, we need to write code that loads and displays the contents of `Web.config` in the `WebConfigContents` TextBox when the page is first loaded.</span></span> <span data-ttu-id="a4609-166">将以下代码添加到页的代码隐藏类中。</span><span class="sxs-lookup"><span data-stu-id="a4609-166">Add the following code to the page s code-behind class.</span></span> <span data-ttu-id="a4609-167">此代码将添加一个名为 `DisplayWebConfig` 的方法，并在 `false``Page.IsPostBack` 时从 `Page_Load` 事件处理程序调用该方法：</span><span class="sxs-lookup"><span data-stu-id="a4609-167">This code adds a method named `DisplayWebConfig` and calls it from the `Page_Load` event handler when `Page.IsPostBack` is `false`:</span></span>

[!code-csharp[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample1.cs)]

<span data-ttu-id="a4609-168">`DisplayWebConfig` 方法使用[`File` 类](https://msdn.microsoft.com/library/system.io.file.aspx)打开应用程序的 `Web.config` 文件、 [`StreamReader` 类](https://msdn.microsoft.com/library/system.io.streamreader.aspx)以将其内容读入字符串中，并使用[`Path` 类](https://msdn.microsoft.com/library/system.io.path.aspx)生成 `Web.config` 文件的物理路径。</span><span class="sxs-lookup"><span data-stu-id="a4609-168">The `DisplayWebConfig` method uses the [`File` class](https://msdn.microsoft.com/library/system.io.file.aspx) to open the application s `Web.config` file, the [`StreamReader` class](https://msdn.microsoft.com/library/system.io.streamreader.aspx) to read its contents into a string, and the [`Path` class](https://msdn.microsoft.com/library/system.io.path.aspx) to generate the physical path to the `Web.config` file.</span></span> <span data-ttu-id="a4609-169">这三个类都位于[`System.IO` 命名空间](https://msdn.microsoft.com/library/system.io.aspx)中。</span><span class="sxs-lookup"><span data-stu-id="a4609-169">These three classes are all found in the [`System.IO` namespace](https://msdn.microsoft.com/library/system.io.aspx).</span></span> <span data-ttu-id="a4609-170">因此，您需要将 `using` `System.IO` 语句添加到代码隐藏类的顶部，或者使用 `System.IO.` 为这些类名称添加前缀。</span><span class="sxs-lookup"><span data-stu-id="a4609-170">Consequently, you will need to add a `using` `System.IO` statement to the top of the code-behind class or, alternatively, prefix these class names with `System.IO.` .</span></span>

<span data-ttu-id="a4609-171">接下来，我们需要为这两个按钮控件添加事件处理程序 `Click` 事件，并添加必要的代码，以便使用计算机级密钥和 DPAPI 提供程序加密和解密 `<connectionStrings>` 部分。</span><span class="sxs-lookup"><span data-stu-id="a4609-171">Next, we need to add event handlers for the two Button controls `Click` events and add the necessary code to encrypt and decrypt the `<connectionStrings>` section using a machine-level key with the DPAPI provider.</span></span> <span data-ttu-id="a4609-172">在设计器中，双击每个按钮以在代码隐藏类中添加 `Click` 事件处理程序，然后添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="a4609-172">From the Designer, double-click each of the Buttons to add a `Click` event handler in the code-behind class and then add the following code:</span></span>

[!code-csharp[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample2.cs)]

<span data-ttu-id="a4609-173">这两个事件处理程序中使用的代码几乎完全相同。</span><span class="sxs-lookup"><span data-stu-id="a4609-173">The code used in the two event handlers is nearly identical.</span></span> <span data-ttu-id="a4609-174">它们都首先通过[`WebConfigurationManager` 类](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.aspx)s [`OpenWebConfiguration` 方法](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.openwebconfiguration.aspx)获取有关当前应用程序 `Web.config` 文件的信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-174">They both start by getting information about the current application s `Web.config` file via the [`WebConfigurationManager` class](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.aspx) s [`OpenWebConfiguration` method](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.openwebconfiguration.aspx).</span></span> <span data-ttu-id="a4609-175">此方法返回指定虚拟路径的 web 配置文件。</span><span class="sxs-lookup"><span data-stu-id="a4609-175">This method returns the web configuration file for the specified virtual path.</span></span> <span data-ttu-id="a4609-176">接下来，通过[`Configuration` 类](https://msdn.microsoft.com/library/system.configuration.configuration.aspx)的[`GetSection(sectionName)` 方法](https://msdn.microsoft.com/library/system.configuration.configuration.getsection.aspx)访问 `Web.config` 文件 s `<connectionStrings>` 部分，该方法返回[`ConfigurationSection`](https://msdn.microsoft.com/library/system.configuration.configurationsection.aspx)对象。</span><span class="sxs-lookup"><span data-stu-id="a4609-176">Next, the `Web.config` file s `<connectionStrings>` section is accessed via the [`Configuration` class](https://msdn.microsoft.com/library/system.configuration.configuration.aspx) s [`GetSection(sectionName)` method](https://msdn.microsoft.com/library/system.configuration.configuration.getsection.aspx), which returns a [`ConfigurationSection`](https://msdn.microsoft.com/library/system.configuration.configurationsection.aspx) object.</span></span>

<span data-ttu-id="a4609-177">`ConfigurationSection` 对象包含一个[`SectionInformation` 属性](https://msdn.microsoft.com/library/system.configuration.configurationsection.sectioninformation.aspx)，该属性提供有关配置节的附加信息和功能。</span><span class="sxs-lookup"><span data-stu-id="a4609-177">The `ConfigurationSection` object includes a [`SectionInformation` property](https://msdn.microsoft.com/library/system.configuration.configurationsection.sectioninformation.aspx) that provides additional information and functionality regarding the configuration section.</span></span> <span data-ttu-id="a4609-178">如上面的代码所示，我们可以通过检查 `SectionInformation` 属性的 `IsProtected` 属性来确定配置节是否已加密。</span><span class="sxs-lookup"><span data-stu-id="a4609-178">As the code above shows, we can determine whether the configuration section is encrypted by checking the `SectionInformation` property s `IsProtected` property.</span></span> <span data-ttu-id="a4609-179">此外，可以通过 `SectionInformation` 属性 `ProtectSection(provider)` 和 `UnprotectSection` 方法对节进行加密或解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-179">Moreover, the section can be encrypted or decrypted via the `SectionInformation` property s `ProtectSection(provider)` and `UnprotectSection` methods.</span></span>

<span data-ttu-id="a4609-180">`ProtectSection(provider)` 方法接受字符串作为输入，该字符串指定要在加密时使用的受保护配置提供程序的名称。</span><span class="sxs-lookup"><span data-stu-id="a4609-180">The `ProtectSection(provider)` method accepts as input a string specifying the name of the protected configuration provider to use when encrypting.</span></span> <span data-ttu-id="a4609-181">在 `EncryptConnString` 按钮 s 事件处理程序中，我们将 DataProtectionConfigurationProvider 传递到 `ProtectSection(provider)` 方法，以便使用 DPAPI 提供程序。</span><span class="sxs-lookup"><span data-stu-id="a4609-181">In the `EncryptConnString` Button s event handler we pass DataProtectionConfigurationProvider into the `ProtectSection(provider)` method so that the DPAPI provider is used.</span></span> <span data-ttu-id="a4609-182">`UnprotectSection` 方法可以确定用于对配置节进行加密的访问接口，因此不需要任何输入参数。</span><span class="sxs-lookup"><span data-stu-id="a4609-182">The `UnprotectSection` method can determine the provider that was used to encrypt the configuration section and therefore does not require any input parameters.</span></span>

<span data-ttu-id="a4609-183">调用 `ProtectSection(provider)` 或 `UnprotectSection` 方法后，必须调用 `Configuration` 对象[`Save` 方法](https://msdn.microsoft.com/library/system.configuration.configuration.save.aspx)来保存更改。</span><span class="sxs-lookup"><span data-stu-id="a4609-183">After calling the `ProtectSection(provider)` or `UnprotectSection` method, you must call the `Configuration` object s [`Save` method](https://msdn.microsoft.com/library/system.configuration.configuration.save.aspx) to persist the changes.</span></span> <span data-ttu-id="a4609-184">加密或解密配置信息并保存更改后，我们会调用 `DisplayWebConfig` 将更新的 `Web.config` 内容加载到 TextBox 控件中。</span><span class="sxs-lookup"><span data-stu-id="a4609-184">Once the configuration information has been encrypted or decrypted and the changes saved, we call `DisplayWebConfig` to load the updated `Web.config` contents into the TextBox control.</span></span>

<span data-ttu-id="a4609-185">输入以上代码后，通过浏览器访问 `EncryptingConfigSections.aspx` 页面进行测试。</span><span class="sxs-lookup"><span data-stu-id="a4609-185">Once you have entered the above code, test it by visiting the `EncryptingConfigSections.aspx` page through a browser.</span></span> <span data-ttu-id="a4609-186">最初应该会看到一个页面，其中列出了以纯文本形式显示的 `<connectionStrings>` 部分 `Web.config` 的内容（请参阅图3）。</span><span class="sxs-lookup"><span data-stu-id="a4609-186">You should initially see a page that lists the contents of `Web.config` with the `<connectionStrings>` section displayed in plain-text (see Figure 3).</span></span>

<span data-ttu-id="a4609-187">[![向页面添加一个文本框和两个按钮 Web 控件](protecting-connection-strings-and-other-configuration-information-cs/_static/image8.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="a4609-187">[![Add a TextBox and Two Button Web Controls to the Page](protecting-connection-strings-and-other-configuration-information-cs/_static/image8.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image7.png)</span></span>

<span data-ttu-id="a4609-188">**图 3**：向页面添加文本框和两个按钮 Web 控件（[单击以查看完全大小的图像](protecting-connection-strings-and-other-configuration-information-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="a4609-188">**Figure 3**: Add a TextBox and Two Button Web Controls to the Page ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image9.png))</span></span>

<span data-ttu-id="a4609-189">现在，单击 "加密连接字符串" 按钮。</span><span class="sxs-lookup"><span data-stu-id="a4609-189">Now click the Encrypt Connection Strings button.</span></span> <span data-ttu-id="a4609-190">如果启用了请求验证，则从 "`WebConfigContents`" 文本框中回发的标记将生成一个 `HttpRequestValidationException`，其中显示消息 "从客户端检测到潜在危险的 `Request.Form` 值"。</span><span class="sxs-lookup"><span data-stu-id="a4609-190">If request validation is enabled, the markup posted back from the `WebConfigContents` TextBox will produce an `HttpRequestValidationException`, which displays the message, A potentially dangerous `Request.Form` value was detected from the client.</span></span> <span data-ttu-id="a4609-191">默认情况下，在 ASP.NET 2.0 中启用了请求验证，这将禁止包含未编码的 HTML 的回发，并旨在帮助防止脚本注入攻击。</span><span class="sxs-lookup"><span data-stu-id="a4609-191">Request validation, which is enabled by default in ASP.NET 2.0, prohibits postbacks that include un-encoded HTML and is designed to help prevent script-injection attacks.</span></span> <span data-ttu-id="a4609-192">可以在页面或应用程序级别禁用此检查。</span><span class="sxs-lookup"><span data-stu-id="a4609-192">This check can be disabled at the page- or application-level.</span></span> <span data-ttu-id="a4609-193">若要关闭此页，请在 `@Page` 指令中将 `ValidateRequest` 设置设置为 `false`。</span><span class="sxs-lookup"><span data-stu-id="a4609-193">To turn it off for this page, set the `ValidateRequest` setting to `false` in the `@Page` directive.</span></span> <span data-ttu-id="a4609-194">`@Page` 指令位于页面声明性标记的顶部。</span><span class="sxs-lookup"><span data-stu-id="a4609-194">The `@Page` directive is found at the top of the page s declarative markup.</span></span>

[!code-aspx[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample3.aspx)]

<span data-ttu-id="a4609-195">有关请求验证、其用途、如何在页级和应用程序级禁用它的详细信息，以及如何对标记进行 HTML 编码的详细信息，请参阅[请求验证-阻止脚本攻击](../../../../whitepapers/request-validation.md)。</span><span class="sxs-lookup"><span data-stu-id="a4609-195">For more information on request validation, its purpose, how to disable it at the page- and application-level, as well as how to HTML encode markup, see [Request Validation - Preventing Script Attacks](../../../../whitepapers/request-validation.md).</span></span>

<span data-ttu-id="a4609-196">为页面禁用请求验证后，请尝试再次单击 "加密连接字符串" 按钮。</span><span class="sxs-lookup"><span data-stu-id="a4609-196">After disabling request validation for the page, try clicking the Encrypt Connection Strings button again.</span></span> <span data-ttu-id="a4609-197">在回发时，将访问配置文件，并使用 DPAPI 提供程序对其 `<connectionStrings>` 部分进行加密。</span><span class="sxs-lookup"><span data-stu-id="a4609-197">On postback, the configuration file will be accessed and its `<connectionStrings>` section encrypted using the DPAPI provider.</span></span> <span data-ttu-id="a4609-198">然后，将更新文本框以显示新的 `Web.config` 内容。</span><span class="sxs-lookup"><span data-stu-id="a4609-198">The TextBox is then updated to display the new `Web.config` content.</span></span> <span data-ttu-id="a4609-199">如图4所示，`<connectionStrings>` 信息现在已加密。</span><span class="sxs-lookup"><span data-stu-id="a4609-199">As Figure 4 shows, the `<connectionStrings>` information is now encrypted.</span></span>

<span data-ttu-id="a4609-200">[![单击 "加密连接字符串" 按钮会对 &lt;connectionString&gt; 节进行加密](protecting-connection-strings-and-other-configuration-information-cs/_static/image11.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="a4609-200">[![Clicking the Encrypt Connection Strings Button Encrypts the &lt;connectionString&gt; Section](protecting-connection-strings-and-other-configuration-information-cs/_static/image11.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image10.png)</span></span>

<span data-ttu-id="a4609-201">**图 4**：单击 "加密连接字符串" 按钮将加密 `<connectionString>` 部分（[单击以查看完全大小的图像](protecting-connection-strings-and-other-configuration-information-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="a4609-201">**Figure 4**: Clicking the Encrypt Connection Strings Button Encrypts the `<connectionString>` Section ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image12.png))</span></span>

<span data-ttu-id="a4609-202">我的计算机上生成的加密 `<connectionStrings>` 部分如下所示，不过为了简洁起见，`<CipherData>` 元素中的某些内容已被删除：</span><span class="sxs-lookup"><span data-stu-id="a4609-202">The encrypted `<connectionStrings>` section generated on my computer follows, although some of the content in the `<CipherData>` element has been removed for brevity:</span></span>

[!code-xml[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample4.xml)]

> [!NOTE]
> <span data-ttu-id="a4609-203">`<connectionStrings>` 元素指定用于执行加密的提供程序（`DataProtectionConfigurationProvider`）。</span><span class="sxs-lookup"><span data-stu-id="a4609-203">The `<connectionStrings>` element specifies the provider used to perform the encryption (`DataProtectionConfigurationProvider`).</span></span> <span data-ttu-id="a4609-204">当单击 "解密连接字符串" 按钮时，`UnprotectSection` 方法将使用此信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-204">This information is used by the `UnprotectSection` method when the Decrypt Connection Strings button is clicked.</span></span>

<span data-ttu-id="a4609-205">从 `Web.config` 访问连接字符串信息时，可以通过从 SqlDataSource 控件编写的代码，或者从类型化数据集中的 Tableadapter 中自动生成的代码-它会自动解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-205">When the connection string information is accessed from `Web.config` - either by code we write, from a SqlDataSource control, or the auto-generated code from the TableAdapters in our Typed DataSets - it is automatically decrypted.</span></span> <span data-ttu-id="a4609-206">简而言之，我们不需要添加任何其他代码或逻辑来解密已加密的 `<connectionString>` 部分。</span><span class="sxs-lookup"><span data-stu-id="a4609-206">In short, we do not need to add any extra code or logic to decrypt the encrypted `<connectionString>` section.</span></span> <span data-ttu-id="a4609-207">为了说明这一点，请访问前面的教程之一，如基本报表部分（`~/BasicReporting/SimpleDisplay.aspx`）中的简单显示教程。</span><span class="sxs-lookup"><span data-stu-id="a4609-207">To demonstrate this, visit one of the earlier tutorials at this time, such as the Simple Display tutorial from the Basic Reporting section (`~/BasicReporting/SimpleDisplay.aspx`).</span></span> <span data-ttu-id="a4609-208">如图5所示，本教程的工作方式与预期的方式完全相同，指出加密的连接字符串信息通过 ASP.NET 页自动解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-208">As Figure 5 shows, the tutorial works exactly as we would expect it, indicating that the encrypted connection string information is being automatically decrypted by the ASP.NET page.</span></span>

<span data-ttu-id="a4609-209">[![，数据访问层会自动解密连接字符串信息](protecting-connection-strings-and-other-configuration-information-cs/_static/image14.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="a4609-209">[![The Data Access Layer Automatically Decrypts the Connection String Information](protecting-connection-strings-and-other-configuration-information-cs/_static/image14.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image13.png)</span></span>

<span data-ttu-id="a4609-210">**图 5**：数据访问层自动对连接字符串信息进行解密（[单击以查看完全大小的图像](protecting-connection-strings-and-other-configuration-information-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="a4609-210">**Figure 5**: The Data Access Layer Automatically Decrypts the Connection String Information ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image15.png))</span></span>

<span data-ttu-id="a4609-211">若要将 `<connectionStrings>` 部分恢复为其纯文本表示形式，请单击 "解密连接字符串" 按钮。</span><span class="sxs-lookup"><span data-stu-id="a4609-211">To revert the `<connectionStrings>` section back to its plain-text representation, click the Decrypt Connection Strings button.</span></span> <span data-ttu-id="a4609-212">在回发时，以纯文本形式显示 `Web.config` 中的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="a4609-212">On postback you should see the connection strings in `Web.config` in plain-text.</span></span> <span data-ttu-id="a4609-213">此时，屏幕应类似于第一次访问此页面时（请参阅图3）。</span><span class="sxs-lookup"><span data-stu-id="a4609-213">At this point your screen should look like it did when first visiting this page (see in Figure 3).</span></span>

## <a name="step-3-encrypting-configuration-sections-usingaspnet_regiisexe"></a><span data-ttu-id="a4609-214">步骤3：使用`aspnet_regiis.exe` 加密配置节</span><span class="sxs-lookup"><span data-stu-id="a4609-214">Step 3: Encrypting Configuration Sections Using`aspnet_regiis.exe`</span></span>

<span data-ttu-id="a4609-215">.NET Framework 包括 `$WINDOWS$\Microsoft.NET\Framework\version\` 文件夹中的各种命令行工具。</span><span class="sxs-lookup"><span data-stu-id="a4609-215">The .NET Framework includes a variety of command line tools in the `$WINDOWS$\Microsoft.NET\Framework\version\` folder.</span></span> <span data-ttu-id="a4609-216">例如，在[使用 Sql 缓存依赖项](../caching-data/using-sql-cache-dependencies-cs.md)教程中，我们介绍了如何使用 `aspnet_regsql.exe` 命令行工具添加 SQL 缓存依赖关系所需的基础结构。</span><span class="sxs-lookup"><span data-stu-id="a4609-216">In the [Using SQL Cache Dependencies](../caching-data/using-sql-cache-dependencies-cs.md) tutorial, for instance, we looked at using the `aspnet_regsql.exe` command line tool to add the infrastructure necessary for SQL cache dependencies.</span></span> <span data-ttu-id="a4609-217">此文件夹中的另一个有用的命令行工具是[ASP.NET IIS 注册工具（`aspnet_regiis.exe`）](https://msdn.microsoft.com/library/k6h9cz8h(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="a4609-217">Another useful command line tool in this folder is the [ASP.NET IIS Registration tool (`aspnet_regiis.exe`)](https://msdn.microsoft.com/library/k6h9cz8h(VS.80).aspx).</span></span> <span data-ttu-id="a4609-218">顾名思义，ASP.NET IIS 注册工具主要用于将 ASP.NET 2.0 应用程序注册到 Microsoft 的专业级 Web 服务器（IIS）。</span><span class="sxs-lookup"><span data-stu-id="a4609-218">As its name implies, the ASP.NET IIS Registration tool is primarily used to register an ASP.NET 2.0 application with Microsoft s professional-grade Web server, IIS.</span></span> <span data-ttu-id="a4609-219">除了与 IIS 相关的功能之外，还可以使用 ASP.NET IIS 注册工具对 `Web.config`中指定的配置节进行加密或解密。</span><span class="sxs-lookup"><span data-stu-id="a4609-219">In addition to its IIS-related features, the ASP.NET IIS Registration tool can also be used to encrypt or decrypt specified configuration sections in `Web.config`.</span></span>

<span data-ttu-id="a4609-220">以下语句显示了使用 `aspnet_regiis.exe` 命令行工具对配置节进行加密的一般语法：</span><span class="sxs-lookup"><span data-stu-id="a4609-220">The following statement shows the general syntax used to encrypt a configuration section with the `aspnet_regiis.exe` command line tool:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample5.cmd)]

<span data-ttu-id="a4609-221">*部分*是要加密的配置节（如 connectionStrings），*物理\_目录*是 web 应用程序根目录的完整物理路径，*提供程序*是要使用的受保护配置提供程序的名称（例如 DataProtectionConfigurationProvider）。</span><span class="sxs-lookup"><span data-stu-id="a4609-221">*section* is the configuration section to encrypt (like connectionStrings ), the *physical\_directory* is the full, physical path to the web application s root directory, and *provider* is the name of the protected configuration provider to use (such as DataProtectionConfigurationProvider ).</span></span> <span data-ttu-id="a4609-222">或者，如果 web 应用程序是在 IIS 中注册的，则可以使用以下语法输入虚拟路径而不是物理路径：</span><span class="sxs-lookup"><span data-stu-id="a4609-222">Alternatively, if the web application is registered in IIS you can enter the virtual path instead of the physical path using the following syntax:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample6.cmd)]

<span data-ttu-id="a4609-223">以下 `aspnet_regiis.exe` 示例使用具有计算机级密钥的 DPAPI 提供程序对 `<connectionStrings>` 部分进行加密：</span><span class="sxs-lookup"><span data-stu-id="a4609-223">The following `aspnet_regiis.exe` example encrypts the `<connectionStrings>` section using the DPAPI provider with a machine-level key:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample7.cmd)]

<span data-ttu-id="a4609-224">同样，`aspnet_regiis.exe` 命令行工具可用于解密配置节。</span><span class="sxs-lookup"><span data-stu-id="a4609-224">Similarly, the `aspnet_regiis.exe` command line tool can be used to decrypt configuration sections.</span></span> <span data-ttu-id="a4609-225">使用 `-pdf` （或代替 `-pe`，使用 `-pd`），而不是使用 `-pef` 开关。</span><span class="sxs-lookup"><span data-stu-id="a4609-225">Instead of using the `-pef` switch, use `-pdf` (or instead of `-pe`, use `-pd`).</span></span> <span data-ttu-id="a4609-226">另请注意，解密时不需要提供程序名称。</span><span class="sxs-lookup"><span data-stu-id="a4609-226">Also, note that the provider name is not necessary when decrypting.</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample8.cmd)]

> [!NOTE]
> <span data-ttu-id="a4609-227">由于我们使用的是使用特定于计算机的密钥的 DPAPI 提供程序，因此你必须从提供 web 页面的同一台计算机上运行 `aspnet_regiis.exe`。</span><span class="sxs-lookup"><span data-stu-id="a4609-227">Since we are using the DPAPI provider, which uses keys specific to the computer, you must run `aspnet_regiis.exe` from the same machine from which the web pages are being served.</span></span> <span data-ttu-id="a4609-228">例如，如果在本地开发计算机上运行此命令行程序，然后将加密的 Web.config 文件上传到生产服务器，则生产服务器将无法对连接字符串信息进行解密，因为它已加密使用特定于您的开发计算机的密钥。</span><span class="sxs-lookup"><span data-stu-id="a4609-228">For example, if you run this command line program from your local development machine and then upload the encrypted Web.config file to the production server, the production server will not be able to decrypt the connection string information since it was encrypted using keys specific to your development machine.</span></span> <span data-ttu-id="a4609-229">RSA 提供程序没有此限制，因为可以将 RSA 密钥导出到另一台计算机。</span><span class="sxs-lookup"><span data-stu-id="a4609-229">The RSA provider does not have this limitation as it is possible to export the RSA keys to another machine.</span></span>

## <a name="understanding-database-authentication-options"></a><span data-ttu-id="a4609-230">了解数据库身份验证选项</span><span class="sxs-lookup"><span data-stu-id="a4609-230">Understanding Database Authentication Options</span></span>

<span data-ttu-id="a4609-231">在任何应用程序都可以发出对 Microsoft SQL Server 数据库 `SELECT`、`INSERT`、`UPDATE`或 `DELETE` 查询之前，数据库必须首先识别请求者。</span><span class="sxs-lookup"><span data-stu-id="a4609-231">Before any application can issue `SELECT`, `INSERT`, `UPDATE`, or `DELETE` queries to a Microsoft SQL Server database, the database first must identify the requestor.</span></span> <span data-ttu-id="a4609-232">此过程称为*身份验证*，SQL Server 提供了两种身份验证方法：</span><span class="sxs-lookup"><span data-stu-id="a4609-232">This process is known as *authentication* and SQL Server provides two methods of authentication:</span></span>

- <span data-ttu-id="a4609-233">**Windows 身份验证**-用于运行应用程序的进程用于与数据库通信。</span><span class="sxs-lookup"><span data-stu-id="a4609-233">**Windows Authentication** - the process under which the application is running is used to communicate with the database.</span></span> <span data-ttu-id="a4609-234">当通过 Visual Studio 2005 s ASP.NET 开发服务器运行 ASP.NET 应用程序时，ASP.NET 应用程序会假定当前登录的用户的标识。</span><span class="sxs-lookup"><span data-stu-id="a4609-234">When running an ASP.NET application through Visual Studio 2005 s ASP.NET Development Server, the ASP.NET application assumes the identity of the currently logged on user.</span></span> <span data-ttu-id="a4609-235">对于 Microsoft Internet Information Server （IIS）上的 ASP.NET 应用程序，ASP.NET 应用程序通常假定 `domainName``\MachineName` 或 `domainName``\NETWORK SERVICE`的标识，尽管可以对此进行自定义。</span><span class="sxs-lookup"><span data-stu-id="a4609-235">For ASP.NET applications on Microsoft Internet Information Server (IIS), ASP.NET applications usually assume the identity of `domainName``\MachineName` or `domainName``\NETWORK SERVICE`, although this can be customized.</span></span>
- <span data-ttu-id="a4609-236">**SQL 身份验证**-提供用户 ID 和密码值作为身份验证凭据。</span><span class="sxs-lookup"><span data-stu-id="a4609-236">**SQL Authentication** - a user ID and password values are supplied as credentials for authentication.</span></span> <span data-ttu-id="a4609-237">通过 SQL 身份验证，在连接字符串中提供用户 ID 和密码。</span><span class="sxs-lookup"><span data-stu-id="a4609-237">With SQL authentication, the user ID and password are provided in the connection string.</span></span>

<span data-ttu-id="a4609-238">Windows 身份验证优于 SQL 身份验证，因为它更安全。</span><span class="sxs-lookup"><span data-stu-id="a4609-238">Windows authentication is preferred over SQL authentication because it is more secure.</span></span> <span data-ttu-id="a4609-239">使用 Windows 身份验证时，无用户名和密码即可使用连接字符串，如果 web 服务器和数据库服务器驻留在两个不同的计算机上，则不会通过网络以纯文本形式发送凭据。</span><span class="sxs-lookup"><span data-stu-id="a4609-239">With Windows authentication the connection string is free from a username and password and if the web server and database server reside on two different machines, the credentials are not sent over the network in plain-text.</span></span> <span data-ttu-id="a4609-240">但是，通过 SQL 身份验证，在连接字符串中对身份验证凭据进行硬编码，并以纯文本形式从 web 服务器传输到数据库服务器。</span><span class="sxs-lookup"><span data-stu-id="a4609-240">With SQL authentication, however, the authentication credentials are hard-coded in the connection string and are transmitted from the web server to the database server in plain-text.</span></span>

<span data-ttu-id="a4609-241">这些教程使用了 Windows 身份验证。</span><span class="sxs-lookup"><span data-stu-id="a4609-241">These tutorials have used Windows authentication.</span></span> <span data-ttu-id="a4609-242">可以通过检查连接字符串来判断正在使用的身份验证模式。</span><span class="sxs-lookup"><span data-stu-id="a4609-242">You can tell what authentication mode is being used by inspecting the connection string.</span></span> <span data-ttu-id="a4609-243">教程的 `Web.config` 中的连接字符串已：</span><span class="sxs-lookup"><span data-stu-id="a4609-243">The connection string in `Web.config` for our tutorials has been:</span></span>

`Data Source=.\SQLEXPRESS; AttachDbFilename=|DataDirectory|\NORTHWND.MDF; Integrated Security=True; User Instance=True`

<span data-ttu-id="a4609-244">集成安全性 = True，缺少用户名和密码表示正在使用 Windows 身份验证。</span><span class="sxs-lookup"><span data-stu-id="a4609-244">The Integrated Security=True and lack of a username and password indicate that Windows authentication is being used.</span></span> <span data-ttu-id="a4609-245">在某些连接字符串中，术语 "可信连接 = 是" 或 "集成安全性 = SSPI"，而不是集成安全性 = "True"，但所有这三个都表示使用 Windows 身份验证。</span><span class="sxs-lookup"><span data-stu-id="a4609-245">In some connection strings the term Trusted Connection=Yes or Integrated Security=SSPI is used instead of Integrated Security=True, but all three indicate the use of Windows authentication.</span></span>

<span data-ttu-id="a4609-246">下面的示例演示使用 SQL 身份验证的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="a4609-246">The following example shows a connection string that uses SQL authentication.</span></span> <span data-ttu-id="a4609-247">请注意嵌入在连接字符串中的凭据：</span><span class="sxs-lookup"><span data-stu-id="a4609-247">Note the credentials embedded within the connection string:</span></span>

`Server=serverName; Database=Northwind; uid=userID; pwd=password`

<span data-ttu-id="a4609-248">假设攻击者能够查看应用程序的 `Web.config` 文件。</span><span class="sxs-lookup"><span data-stu-id="a4609-248">Imagine that an attacker is able to view your application s `Web.config` file.</span></span> <span data-ttu-id="a4609-249">如果使用 SQL 身份验证连接到可通过 Internet 访问的数据库，则攻击者可以使用此连接字符串通过 SQL Management Studio 或从其自己的网站上的 ASP.NET 页连接到您的数据库。</span><span class="sxs-lookup"><span data-stu-id="a4609-249">If you use SQL authentication to connect to a database that is accessible over the Internet, the attacker can use this connection string to connect to your database through SQL Management Studio or from ASP.NET pages on their own website.</span></span> <span data-ttu-id="a4609-250">为了帮助减轻此威胁，请使用受保护的配置系统加密 `Web.config` 中的连接字符串信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-250">To help mitigate this threat, encrypt the connection string information in `Web.config` using the protected configuration system.</span></span>

> [!NOTE]
> <span data-ttu-id="a4609-251">有关 SQL Server 中可用的不同身份验证类型的详细信息，请参阅[构建安全的 ASP.NET 应用程序：身份验证、授权和安全通信](https://msdn.microsoft.com/library/aa302392.aspx)。</span><span class="sxs-lookup"><span data-stu-id="a4609-251">For more information on the different types of authentication available in SQL Server, see [Building Secure ASP.NET Applications: Authentication, Authorization, and Secure Communication](https://msdn.microsoft.com/library/aa302392.aspx).</span></span> <span data-ttu-id="a4609-252">若要进一步了解 Windows 和 SQL 身份验证语法之间的差异，请参阅[ConnectionStrings.com](http://www.connectionstrings.com/)。</span><span class="sxs-lookup"><span data-stu-id="a4609-252">For further connection string examples illustrating the differences between Windows and SQL authentication syntax, refer to [ConnectionStrings.com](http://www.connectionstrings.com/).</span></span>

## <a name="summary"></a><span data-ttu-id="a4609-253">总结</span><span class="sxs-lookup"><span data-stu-id="a4609-253">Summary</span></span>

<span data-ttu-id="a4609-254">默认情况下，不能通过浏览器访问 ASP.NET 应用程序中扩展名为 `.config` 的文件。</span><span class="sxs-lookup"><span data-stu-id="a4609-254">By default, files with a `.config` extension in an ASP.NET application cannot be accessed through a browser.</span></span> <span data-ttu-id="a4609-255">不会返回这些类型的文件，因为它们可能包含敏感信息，例如数据库连接字符串、用户名和密码等。</span><span class="sxs-lookup"><span data-stu-id="a4609-255">These types of files are not returned because they may contain sensitive information, such as database connection strings, usernames and passwords, and so on.</span></span> <span data-ttu-id="a4609-256">.NET 2.0 中的受保护配置系统通过允许加密指定的配置节来帮助进一步保护敏感信息。</span><span class="sxs-lookup"><span data-stu-id="a4609-256">The protected configuration system in .NET 2.0 helps further protect sensitive information by allowing specified configuration sections to be encrypted.</span></span> <span data-ttu-id="a4609-257">有两个内置的受保护配置提供程序：一个使用 RSA 算法，另一个使用 Windows 数据保护 API （DPAPI）。</span><span class="sxs-lookup"><span data-stu-id="a4609-257">There are two built-in protected configuration providers: one that uses the RSA algorithm and one that uses the Windows Data Protection API (DPAPI).</span></span>

<span data-ttu-id="a4609-258">在本教程中，我们介绍了如何使用 DPAPI 提供程序加密和解密配置设置。</span><span class="sxs-lookup"><span data-stu-id="a4609-258">In this tutorial we looked at how to encrypt and decrypt configuration settings using the DPAPI provider.</span></span> <span data-ttu-id="a4609-259">这可以通过编程方式完成，如我们在步骤2中看到的那样，还可以通过 `aspnet_regiis.exe` 命令行工具完成，如步骤3中所述。</span><span class="sxs-lookup"><span data-stu-id="a4609-259">This can be accomplished both programmatically, as we saw in Step 2, as well as through the `aspnet_regiis.exe` command line tool, which was covered in Step 3.</span></span> <span data-ttu-id="a4609-260">若要详细了解如何使用用户级密钥或使用 RSA 提供程序，请参阅进一步阅读部分中的资源。</span><span class="sxs-lookup"><span data-stu-id="a4609-260">For more information on using user-level keys or using the RSA provider instead, see the resources in the Further Reading section.</span></span>

<span data-ttu-id="a4609-261">很高兴编程！</span><span class="sxs-lookup"><span data-stu-id="a4609-261">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="a4609-262">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="a4609-262">Further Reading</span></span>

<span data-ttu-id="a4609-263">有关本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="a4609-263">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="a4609-264">构建安全的 ASP.NET 应用程序：身份验证、授权和安全通信</span><span class="sxs-lookup"><span data-stu-id="a4609-264">Building Secure ASP.NET Application: Authentication, Authorization, and Secure Communication</span></span>](https://msdn.microsoft.com/library/aa302392.aspx)
- [<span data-ttu-id="a4609-265">加密 ASP.NET 2.0 应用程序中的配置信息</span><span class="sxs-lookup"><span data-stu-id="a4609-265">Encrypting Configuration Information in ASP.NET 2.0 Applications</span></span>](http://aspnet.4guysfromrolla.com/articles/021506-1.aspx)
- [<span data-ttu-id="a4609-266">在 ASP.NET 2.0 中加密 `Web.config` 值</span><span class="sxs-lookup"><span data-stu-id="a4609-266">Encrypting `Web.config` Values in ASP.NET 2.0</span></span>](https://weblogs.asp.net/scottgu/archive/2006/01/09/434893.aspx)
- [<span data-ttu-id="a4609-267">如何：使用 DPAPI 加密 ASP.NET 2.0 中的配置节</span><span class="sxs-lookup"><span data-stu-id="a4609-267">How To: Encrypt Configuration Sections in ASP.NET 2.0 Using DPAPI</span></span>](https://msdn.microsoft.com/library/ms998280.aspx)
- [<span data-ttu-id="a4609-268">如何：使用 RSA 加密 ASP.NET 2.0 中的配置节</span><span class="sxs-lookup"><span data-stu-id="a4609-268">How To: Encrypt Configuration Sections in ASP.NET 2.0 Using RSA</span></span>](https://msdn.microsoft.com/library/ms998283.aspx)
- [<span data-ttu-id="a4609-269">.NET 2.0 中的配置 API</span><span class="sxs-lookup"><span data-stu-id="a4609-269">The Configuration API in .NET 2.0</span></span>](http://www.odetocode.com/Articles/418.aspx)
- [<span data-ttu-id="a4609-270">Windows 数据保护</span><span class="sxs-lookup"><span data-stu-id="a4609-270">Windows Data Protection</span></span>](https://msdn.microsoft.com/library/ms995355.aspx)

## <a name="about-the-author"></a><span data-ttu-id="a4609-271">关于作者</span><span class="sxs-lookup"><span data-stu-id="a4609-271">About the Author</span></span>

<span data-ttu-id="a4609-272">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，创始人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已在使用 Microsoft Web 技术，自1998开始。</span><span class="sxs-lookup"><span data-stu-id="a4609-272">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="a4609-273">Scott 的工作方式是独立的顾问、培训师和撰稿人。</span><span class="sxs-lookup"><span data-stu-id="a4609-273">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="a4609-274">他的最新书籍是，[*在24小时内，sam ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="a4609-274">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="a4609-275">可以[mitchell@4GuysFromRolla.com访问。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="a4609-275">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="a4609-276">或通过他的博客，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="a4609-276">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="a4609-277">特别感谢</span><span class="sxs-lookup"><span data-stu-id="a4609-277">Special Thanks To</span></span>

<span data-ttu-id="a4609-278">此教程系列由许多有用的审阅者查看。</span><span class="sxs-lookup"><span data-stu-id="a4609-278">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="a4609-279">本教程的主管评审者是 Teresa Murphy 和 Randy Schmidt。</span><span class="sxs-lookup"><span data-stu-id="a4609-279">Lead reviewers for this tutorial were Teresa Murphy and Randy Schmidt.</span></span> <span data-ttu-id="a4609-280">想要查看我即将发布的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="a4609-280">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="a4609-281">如果是这样，请在mitchell@4GuysFromRolla.com放置一行[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="a4609-281">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="a4609-282">[上一页](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
> [下一页](debugging-stored-procedures-cs.md)</span><span class="sxs-lookup"><span data-stu-id="a4609-282">[Previous](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
[Next](debugging-stored-procedures-cs.md)</span></span>
