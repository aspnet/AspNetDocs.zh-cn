---
uid: signalr/overview/performance/signalr-connection-density-testing-with-crank
title: 曲柄的 SignalR 连接密度测试 |Microsoft Docs
author: bradygaster
description: 使用曲柄实现 SignalR 连接密度测试
ms.author: bradyg
ms.date: 02/22/2015
ms.assetid: 148d9ca7-1af1-44b6-a9fb-91e261b9b463
msc.legacyurl: /signalr/overview/performance/signalr-connection-density-testing-with-crank
msc.type: authoredcontent
ms.openlocfilehash: 901e039fbb81651ed18d560c99745b7e7f716e01
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78449870"
---
# <a name="signalr-connection-density-testing-with-crank"></a><span data-ttu-id="c6c1e-103">使用曲柄实现 SignalR 连接密度测试</span><span class="sxs-lookup"><span data-stu-id="c6c1e-103">SignalR Connection Density Testing with Crank</span></span>

<span data-ttu-id="c6c1e-104">作者： [Tom FitzMacken](https://github.com/tfitzmac)</span><span class="sxs-lookup"><span data-stu-id="c6c1e-104">by [Tom FitzMacken](https://github.com/tfitzmac)</span></span>

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> <span data-ttu-id="c6c1e-105">本文介绍如何使用曲柄工具测试具有多个模拟客户端的应用程序。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-105">This article describes how to use the Crank tool to test an application with multiple simulated clients.</span></span>

<span data-ttu-id="c6c1e-106">当应用程序在其宿主环境（Azure web 角色、IIS 或使用 Owin 自承载的环境）中运行后，可以使用曲柄工具测试应用程序对高级别连接密度的响应。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-106">Once your application is running in its hosting environment (either an Azure web role, IIS, or self-hosted using Owin), you can test application's response to a high level of connection density using the Crank tool.</span></span> <span data-ttu-id="c6c1e-107">宿主环境可以是 Internet Information Services （IIS）服务器、Owin 主机或 Azure web 角色。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-107">The hosting environment can be an Internet Information Services (IIS) server, an Owin host, or an Azure web role.</span></span> <span data-ttu-id="c6c1e-108">（注意：性能计数器在 Azure App Service Web 应用中不可用，因此你将无法从连接密度测试获取性能数据。）</span><span class="sxs-lookup"><span data-stu-id="c6c1e-108">(Note: Performance counters are not available on Azure App Service Web Apps, so you will not be able to get performance data from a connection density test.)</span></span>

<span data-ttu-id="c6c1e-109">连接密度是指可以在服务器上建立的同时 TCP 连接数。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-109">Connection Density refers to the number of simultaneous TCP connections that can be established on a server.</span></span> <span data-ttu-id="c6c1e-110">每个 TCP 连接产生自己的开销，打开大量空闲连接将最终产生内存瓶颈。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-110">Each TCP connection incurs its own overhead, and opening a large number of idle connections will eventually create a memory bottleneck.</span></span>

<span data-ttu-id="c6c1e-111">[SignalR 基本代码](https://github.com/signalr/signalr)包含一个名为**曲柄**的负载测试工具。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-111">[The SignalR codebase](https://github.com/signalr/signalr) includes a load-testing tool called **Crank**.</span></span> <span data-ttu-id="c6c1e-112">最新版本的曲柄可在 GitHub 上[的开发分支](https://github.com/SignalR/signalr/tree/dev)中找到。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-112">The latest version of Crank can be found in [the Dev branch](https://github.com/SignalR/signalr/tree/dev) on GitHub.</span></span> <span data-ttu-id="c6c1e-113">可在[此处](https://github.com/SignalR/SignalR/archive/dev.zip)下载 SignalR Codebase 的开发分支的 Zip 存档。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-113">You can download a Zip archive of the Dev branch of the SignalR codebase [here](https://github.com/SignalR/SignalR/archive/dev.zip).</span></span>

<span data-ttu-id="c6c1e-114">曲柄可用于完全使服务器的内存饱和，以便计算服务器硬件上可能的空闲连接总数。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-114">Crank may be used to fully saturate the server's memory in order to calculate the total number of idle connections possible on the server hardware.</span></span> <span data-ttu-id="c6c1e-115">或者，您也可以使用曲柄在一定量的内存压力下负载测试服务器，方法是在达到特定计数或特定内存阈值之前向上斜连接。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-115">Alternatively, you may also use Crank to load test the server under a certain amount of memory pressure, by ramping up connections until a specific count or a specific memory threshold is reached.</span></span>

<span data-ttu-id="c6c1e-116">测试时，务必使用远程客户端以避免对资源（即 TCP 连接和内存）的任何竞赛。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-116">When testing, it is important to use remote client(s) to avoid any competition for resources (i.e., TCP connections and memory).</span></span> <span data-ttu-id="c6c1e-117">监视客户端，以确保它们不会遇到可能阻止服务器达到其全部容量（内存或 CPU）的任何瓶颈。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-117">Monitor the client(s) to ensure that they are not hitting any bottlenecks that may prevent the server from reaching its full capacity (memory or CPU).</span></span> <span data-ttu-id="c6c1e-118">为了完全加载服务器，你可能需要增加客户端的数量。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-118">You may need to increase the number of clients in order to fully load the server.</span></span>

### <a name="running-a-connection-density-test"></a><span data-ttu-id="c6c1e-119">运行连接密度测试</span><span class="sxs-lookup"><span data-stu-id="c6c1e-119">Running a Connection Density Test</span></span>

<span data-ttu-id="c6c1e-120">本部分介绍在 SignalR 应用程序上运行连接密度测试所需的步骤。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-120">This section describes the steps needed to run a connection density test on a SignalR application.</span></span>

1. <span data-ttu-id="c6c1e-121">下载并生成[SignalR 基本代码的开发分支](https://github.com/SignalR/SignalR/archive/dev.zip)。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-121">Download and build the [Dev branch of the SignalR codebase](https://github.com/SignalR/SignalR/archive/dev.zip).</span></span> <span data-ttu-id="c6c1e-122">在命令提示符下，导航到 &lt;项目目录 "&gt;\src\Microsoft.AspNet.SignalR.Crank\bin\debug。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-122">In a command prompt, navigate to &lt;project directory&gt;\src\Microsoft.AspNet.SignalR.Crank\bin\debug.</span></span>
2. <span data-ttu-id="c6c1e-123">将应用程序部署到其预期的宿主环境。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-123">Deploy your application to its intended hosting environment.</span></span> <span data-ttu-id="c6c1e-124">记下应用程序所使用的终结点;例如，在[入门教程](../getting-started/tutorial-getting-started-with-signalr.md)中创建的应用程序中，终结点是 `http://<yourhost>:8080/signalr`的。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-124">Make a note of the endpoint that your application uses; for example, in the application created in the [Getting Started tutorial](../getting-started/tutorial-getting-started-with-signalr.md), the endpoint is `http://<yourhost>:8080/signalr`.</span></span>
3. <span data-ttu-id="c6c1e-125">在服务器上安装[SignalR 性能计数器](signalr-performance.md#perfcounters)。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-125">Install [SignalR performance counters](signalr-performance.md#perfcounters) on the server.</span></span> <span data-ttu-id="c6c1e-126">如果你的应用程序在 Azure 上运行，请参阅[在 Azure Web 角色中使用 SignalR 性能计数器](using-signalr-performance-counters-in-an-azure-web-role.md)。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-126">If your application is running on Azure, see [Using SignalR Performance Counters in an Azure Web Role](using-signalr-performance-counters-in-an-azure-web-role.md).</span></span>

<span data-ttu-id="c6c1e-127">下载并生成基本代码并在主机上安装性能计数器后，可以在 `src\Microsoft.AspNet.SignalR.Crank\bin\Debug` 文件夹中找到曲柄命令行工具。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-127">Once you've downloaded and built the codebase, and installed performance counters on your host, the Crank command-line tool can be found in the `src\Microsoft.AspNet.SignalR.Crank\bin\Debug` folder.</span></span>

<span data-ttu-id="c6c1e-128">曲柄工具的可用选项包括：</span><span class="sxs-lookup"><span data-stu-id="c6c1e-128">Available options for the Crank tool include:</span></span>

- <span data-ttu-id="c6c1e-129">**/？** ：显示帮助屏幕。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-129">**/?**: Shows the help screen.</span></span> <span data-ttu-id="c6c1e-130">如果省略**Url**参数，还会显示可用选项。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-130">The available options are also displayed if the **Url** parameter is omitted.</span></span>
- <span data-ttu-id="c6c1e-131">**/Url**： SignalR 连接的 Url。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-131">**/Url**: The URL for SignalR connections.</span></span> <span data-ttu-id="c6c1e-132">此参数是必需的。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-132">This parameter is required.</span></span> <span data-ttu-id="c6c1e-133">对于使用默认映射的 SignalR 应用程序，该路径将以 "/signalr" 结尾。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-133">For a SignalR application using the default mapping, the path will end in "/signalr".</span></span>
- <span data-ttu-id="c6c1e-134">**/传输**：使用的传输名称。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-134">**/Transport**: The name of the transport used.</span></span> <span data-ttu-id="c6c1e-135">默认值为 `auto`，这将选择最佳的可用协议。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-135">The default is `auto`, which will select the best available protocol.</span></span> <span data-ttu-id="c6c1e-136">选项包括 `WebSockets`、`ServerSentEvents`和 `LongPolling` （由于使用的是 .NET 客户端而不是 Internet Explorer，因此不能使用`ForeverFrame` 曲柄的选项）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-136">Options include `WebSockets`, `ServerSentEvents`, and `LongPolling` (`ForeverFrame` is not an option for Crank, since the .NET client rather than Internet Explorer is used).</span></span> <span data-ttu-id="c6c1e-137">有关 SignalR 如何选择传输的详细信息，请参阅[传输和回退](../getting-started/introduction-to-signalr.md#transports)。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-137">For more information on how SignalR selects transports, see [Transports and Fallbacks](../getting-started/introduction-to-signalr.md#transports).</span></span>
- <span data-ttu-id="c6c1e-138">**/BatchSize**：每个批处理中添加的客户端数。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-138">**/BatchSize**: The number of clients added in each batch.</span></span> <span data-ttu-id="c6c1e-139">默认值为 50。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-139">The default is 50.</span></span>
- <span data-ttu-id="c6c1e-140">**/ConnectInterval**：添加连接之间的间隔（以毫秒为单位）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-140">**/ConnectInterval**: The interval in milliseconds between adding connections.</span></span> <span data-ttu-id="c6c1e-141">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-141">The default is 500.</span></span>
- <span data-ttu-id="c6c1e-142">**/Connections**：用于对应用程序进行负载测试的连接数。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-142">**/Connections**: The number of connections used to load-test the application.</span></span> <span data-ttu-id="c6c1e-143">默认值为100000。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-143">The default is 100,000.</span></span>
- <span data-ttu-id="c6c1e-144">**/ConnectTimeout**：中止测试之前的超时时间（秒）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-144">**/ConnectTimeout**: The timeout in seconds before aborting the test.</span></span> <span data-ttu-id="c6c1e-145">默认值为300。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-145">The default is 300.</span></span>
- <span data-ttu-id="c6c1e-146">**MinServerMBytes**：达到最小服务器兆字节。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-146">**MinServerMBytes**: The minimum server megabytes to reach.</span></span> <span data-ttu-id="c6c1e-147">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-147">The default is 500.</span></span>
- <span data-ttu-id="c6c1e-148">**SendBytes**：发送到服务器的负载的大小（以字节为单位）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-148">**SendBytes**: The size of the payload sent to the server in bytes.</span></span> <span data-ttu-id="c6c1e-149">默认值为 0。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-149">The default is 0.</span></span>
- <span data-ttu-id="c6c1e-150">**SendInterval**：消息与服务器之间的延迟（以毫秒为单位）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-150">**SendInterval**: The delay in milliseconds between messages to the server.</span></span> <span data-ttu-id="c6c1e-151">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-151">The default is 500.</span></span>
- <span data-ttu-id="c6c1e-152">**SendTimeout**：消息发送到服务器的超时值（以毫秒为单位）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-152">**SendTimeout**: The timeout in milliseconds for messages to the server.</span></span> <span data-ttu-id="c6c1e-153">默认值为300。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-153">The default is 300.</span></span>
- <span data-ttu-id="c6c1e-154">**ControllerUrl**：一个客户端将在其中承载控制器集线器的 Url。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-154">**ControllerUrl**: The Url where one client will host a controller hub.</span></span> <span data-ttu-id="c6c1e-155">默认值为 null （无控制器中心）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-155">The default is null (no controller hub).</span></span> <span data-ttu-id="c6c1e-156">当曲柄会话启动时，将启动控制器中心;控制器中心与曲柄之间不会有任何其他联系。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-156">The controller hub is started when the Crank session starts; no further contact between the controller hub and Crank is made.</span></span>
- <span data-ttu-id="c6c1e-157">**NumClients**：要连接到应用程序的模拟客户端数量。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-157">**NumClients**: The number of simulated clients to connect to the application.</span></span> <span data-ttu-id="c6c1e-158">默认值为1。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-158">The default is one.</span></span>
- <span data-ttu-id="c6c1e-159">**Logfile**：用于测试运行的日志文件的文件名。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-159">**Logfile**: The filename for the logfile for the test run.</span></span> <span data-ttu-id="c6c1e-160">默认值为 `crank.csv`。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-160">The default is `crank.csv`.</span></span>
- <span data-ttu-id="c6c1e-161">**SampleInterval**：性能计数器样本之间的时间（以毫秒为单位）。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-161">**SampleInterval**: The time in milliseconds between performance counter samples.</span></span> <span data-ttu-id="c6c1e-162">默认值为 1000。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-162">The default is 1000.</span></span>
- <span data-ttu-id="c6c1e-163">**SignalRInstance**：服务器上的性能计数器的实例名称。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-163">**SignalRInstance**: The instance name for the performance counters on the server.</span></span> <span data-ttu-id="c6c1e-164">默认情况下，使用客户端连接状态。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-164">The default is to use the client connection state.</span></span>

### <a name="example"></a><span data-ttu-id="c6c1e-165">示例</span><span class="sxs-lookup"><span data-stu-id="c6c1e-165">Example</span></span>

<span data-ttu-id="c6c1e-166">以下命令将使用100连接在 Azure 上测试一个名为 "ControllerHub" 的站点，该 `pfsignalr` 站点使用名为 "" 的集线器在端口8080上托管应用程序。</span><span class="sxs-lookup"><span data-stu-id="c6c1e-166">The following command will test a site called `pfsignalr` on Azure that hosts an application on port 8080 with a hub named "ControllerHub", using 100 connections.</span></span>

`crank /Connections:100 /Url:http://pfsignalr.cloudapp.net:8080/signalr`
