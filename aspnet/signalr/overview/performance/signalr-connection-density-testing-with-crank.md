---
uid: signalr/overview/performance/signalr-connection-density-testing-with-crank
title: 测试使用曲柄实现 SignalR 连接密度 |Microsoft Docs
author: bradygaster
description: 使用曲柄实现 SignalR 连接密度测试
ms.author: bradyg
ms.date: 02/22/2015
ms.assetid: 148d9ca7-1af1-44b6-a9fb-91e261b9b463
msc.legacyurl: /signalr/overview/performance/signalr-connection-density-testing-with-crank
msc.type: authoredcontent
ms.openlocfilehash: bb8a7da1080dc325c0479b337d114b8dcdf6e102
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/09/2019
ms.locfileid: "59390059"
---
# <a name="signalr-connection-density-testing-with-crank"></a><span data-ttu-id="84ff7-103">使用曲柄实现 SignalR 连接密度测试</span><span class="sxs-lookup"><span data-stu-id="84ff7-103">SignalR Connection Density Testing with Crank</span></span>

<span data-ttu-id="84ff7-104">通过[Tom FitzMacken](https://github.com/tfitzmac)</span><span class="sxs-lookup"><span data-stu-id="84ff7-104">by [Tom FitzMacken](https://github.com/tfitzmac)</span></span>

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> <span data-ttu-id="84ff7-105">本文介绍如何使用曲柄工具来测试具有多个模拟客户端的应用程序。</span><span class="sxs-lookup"><span data-stu-id="84ff7-105">This article describes how to use the Crank tool to test an application with multiple simulated clients.</span></span>


<span data-ttu-id="84ff7-106">在应用程序运行在其宿主环境中 （Azure web 角色，IIS，或使用 Owin 自承载） 中，可以测试应用程序的响应较高的使用曲柄工具的连接密度级别。</span><span class="sxs-lookup"><span data-stu-id="84ff7-106">Once your application is running in its hosting environment (either an Azure web role, IIS, or self-hosted using Owin), you can test application's response to a high level of connection density using the Crank tool.</span></span> <span data-ttu-id="84ff7-107">宿主环境可以是 Internet 信息服务 (IIS) 服务器、 Owin 主机或 Azure web 角色。</span><span class="sxs-lookup"><span data-stu-id="84ff7-107">The hosting environment can be an Internet Information Services (IIS) server, an Owin host, or an Azure web role.</span></span> <span data-ttu-id="84ff7-108">（注意：性能计数器不可在 Azure 应用服务 Web 应用，因此你将无法再从连接密度测试获取性能数据。）</span><span class="sxs-lookup"><span data-stu-id="84ff7-108">(Note: Performance counters are not available on Azure App Service Web Apps, so you will not be able to get performance data from a connection density test.)</span></span>

<span data-ttu-id="84ff7-109">连接密度是指可以在服务器建立的并发 TCP 连接数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-109">Connection Density refers to the number of simultaneous TCP connections that can be established on a server.</span></span> <span data-ttu-id="84ff7-110">每个 TCP 连接可能会产生其自身的开销，并打开大量的空闲连接最终会创建内存瓶颈。</span><span class="sxs-lookup"><span data-stu-id="84ff7-110">Each TCP connection incurs its own overhead, and opening a large number of idle connections will eventually create a memory bottleneck.</span></span>

<span data-ttu-id="84ff7-111">[SignalR o d e b](https://github.com/signalr/signalr)包括负载测试工具，称为**启动**。</span><span class="sxs-lookup"><span data-stu-id="84ff7-111">[The SignalR codebase](https://github.com/signalr/signalr) includes a load-testing tool called **Crank**.</span></span> <span data-ttu-id="84ff7-112">中找不到最新版本的曲柄[Dev 分支](https://github.com/SignalR/signalr/tree/dev)GitHub 上。</span><span class="sxs-lookup"><span data-stu-id="84ff7-112">The latest version of Crank can be found in [the Dev branch](https://github.com/SignalR/signalr/tree/dev) on GitHub.</span></span> <span data-ttu-id="84ff7-113">您可以下载的 Zip 存档的 SignalR 的 Dev 分支 o d e b[此处](https://github.com/SignalR/SignalR/archive/dev.zip)。</span><span class="sxs-lookup"><span data-stu-id="84ff7-113">You can download a Zip archive of the Dev branch of the SignalR codebase [here](https://github.com/SignalR/SignalR/archive/dev.zip).</span></span>

<span data-ttu-id="84ff7-114">曲柄可用于完全饱和服务器的内存以便计算可能服务器硬件上的空闲连接的总数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-114">Crank may be used to fully saturate the server's memory in order to calculate the total number of idle connections possible on the server hardware.</span></span> <span data-ttu-id="84ff7-115">或者，你可能还通过曲柄进行负载测试一定量的内存压力下的服务器的提升效应连接直到到达特定计数或特定的内存阈值。</span><span class="sxs-lookup"><span data-stu-id="84ff7-115">Alternatively, you may also use Crank to load test the server under a certain amount of memory pressure, by ramping up connections until a specific count or a specific memory threshold is reached.</span></span>

<span data-ttu-id="84ff7-116">在测试时，务必使用远程客户端以避免任何竞争资源 （即，TCP 连接和内存）。</span><span class="sxs-lookup"><span data-stu-id="84ff7-116">When testing, it is important to use remote client(s) to avoid any competition for resources (i.e., TCP connections and memory).</span></span> <span data-ttu-id="84ff7-117">监视客户端以确保没有达到可能会阻止服务器达到其完整的容量 （内存或 CPU） 的任何瓶颈。</span><span class="sxs-lookup"><span data-stu-id="84ff7-117">Monitor the client(s) to ensure that they are not hitting any bottlenecks that may prevent the server from reaching its full capacity (memory or CPU).</span></span> <span data-ttu-id="84ff7-118">您可能需要增加以完全加载服务器的客户端的数量。</span><span class="sxs-lookup"><span data-stu-id="84ff7-118">You may need to increase the number of clients in order to fully load the server.</span></span>

### <a name="running-a-connection-density-test"></a><span data-ttu-id="84ff7-119">运行连接密度测试</span><span class="sxs-lookup"><span data-stu-id="84ff7-119">Running a Connection Density Test</span></span>

<span data-ttu-id="84ff7-120">本部分介绍对 SignalR 应用程序运行连接密度测试所需的步骤。</span><span class="sxs-lookup"><span data-stu-id="84ff7-120">This section describes the steps needed to run a connection density test on a SignalR application.</span></span>

1. <span data-ttu-id="84ff7-121">下载并构建[SignalR 的 Dev 分支 b a s e](https://github.com/SignalR/SignalR/archive/dev.zip)。</span><span class="sxs-lookup"><span data-stu-id="84ff7-121">Download and build the [Dev branch of the SignalR codebase](https://github.com/SignalR/SignalR/archive/dev.zip).</span></span> <span data-ttu-id="84ff7-122">在命令提示符中，导航到&lt;项目目录&gt;\src\Microsoft.AspNet.SignalR.Crank\bin\debug。</span><span class="sxs-lookup"><span data-stu-id="84ff7-122">In a command prompt, navigate to &lt;project directory&gt;\src\Microsoft.AspNet.SignalR.Crank\bin\debug.</span></span>
2. <span data-ttu-id="84ff7-123">应用程序部署到其预期的宿主环境。</span><span class="sxs-lookup"><span data-stu-id="84ff7-123">Deploy your application to its intended hosting environment.</span></span> <span data-ttu-id="84ff7-124">请记下的终结点的应用程序使用;例如，在中创建的应用程序[入门教程](../getting-started/tutorial-getting-started-with-signalr.md)，该终结点是`http://<yourhost>:8080/signalr`。</span><span class="sxs-lookup"><span data-stu-id="84ff7-124">Make a note of the endpoint that your application uses; for example, in the application created in the [Getting Started tutorial](../getting-started/tutorial-getting-started-with-signalr.md), the endpoint is `http://<yourhost>:8080/signalr`.</span></span>
3. <span data-ttu-id="84ff7-125">安装[SignalR 性能计数器](signalr-performance.md#perfcounters)在服务器上。</span><span class="sxs-lookup"><span data-stu-id="84ff7-125">Install [SignalR performance counters](signalr-performance.md#perfcounters) on the server.</span></span> <span data-ttu-id="84ff7-126">如果在 Azure 上运行你的应用程序，请参阅[在 Azure Web 角色中使用 SignalR 性能计数器](using-signalr-performance-counters-in-an-azure-web-role.md)。</span><span class="sxs-lookup"><span data-stu-id="84ff7-126">If your application is running on Azure, see [Using SignalR Performance Counters in an Azure Web Role](using-signalr-performance-counters-in-an-azure-web-role.md).</span></span>

<span data-ttu-id="84ff7-127">曲柄命令行工具已下载和生成的基本代码，并在主机上安装性能计数器，可在`src\Microsoft.AspNet.SignalR.Crank\bin\Debug`文件夹。</span><span class="sxs-lookup"><span data-stu-id="84ff7-127">Once you've downloaded and built the codebase, and installed performance counters on your host, the Crank command-line tool can be found in the `src\Microsoft.AspNet.SignalR.Crank\bin\Debug` folder.</span></span>

<span data-ttu-id="84ff7-128">曲柄工具的可用选项包括：</span><span class="sxs-lookup"><span data-stu-id="84ff7-128">Available options for the Crank tool include:</span></span>

- <span data-ttu-id="84ff7-129">**/?**:显示帮助屏幕。</span><span class="sxs-lookup"><span data-stu-id="84ff7-129">**/?**: Shows the help screen.</span></span> <span data-ttu-id="84ff7-130">如果也会显示可用的选项**Url**省略参数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-130">The available options are also displayed if the **Url** parameter is omitted.</span></span>
- <span data-ttu-id="84ff7-131">**/ Url**:SignalR 连接 URL。</span><span class="sxs-lookup"><span data-stu-id="84ff7-131">**/Url**: The URL for SignalR connections.</span></span> <span data-ttu-id="84ff7-132">此参数是必需的。</span><span class="sxs-lookup"><span data-stu-id="84ff7-132">This parameter is required.</span></span> <span data-ttu-id="84ff7-133">使用默认映射为 SignalR 应用程序，该路径将在结尾"/ signalr"。</span><span class="sxs-lookup"><span data-stu-id="84ff7-133">For a SignalR application using the default mapping, the path will end in "/signalr".</span></span>
- <span data-ttu-id="84ff7-134">**/ 传输**:传输使用的名称。</span><span class="sxs-lookup"><span data-stu-id="84ff7-134">**/Transport**: The name of the transport used.</span></span> <span data-ttu-id="84ff7-135">默认值是`auto`，这将选择最佳的可用协议。</span><span class="sxs-lookup"><span data-stu-id="84ff7-135">The default is `auto`, which will select the best available protocol.</span></span> <span data-ttu-id="84ff7-136">选项包括`WebSockets`， `ServerSentEvents`，并`LongPolling`(`ForeverFrame`没有一个选项为曲柄，因为.NET 客户端而不是使用 Internet Explorer)。</span><span class="sxs-lookup"><span data-stu-id="84ff7-136">Options include `WebSockets`, `ServerSentEvents`, and `LongPolling` (`ForeverFrame` is not an option for Crank, since the .NET client rather than Internet Explorer is used).</span></span> <span data-ttu-id="84ff7-137">SignalR 如何选择传输方式的详细信息，请参阅[传输和回退](../getting-started/introduction-to-signalr.md#transports)。</span><span class="sxs-lookup"><span data-stu-id="84ff7-137">For more information on how SignalR selects transports, see [Transports and Fallbacks](../getting-started/introduction-to-signalr.md#transports).</span></span>
- <span data-ttu-id="84ff7-138">**/ BatchSize**:每个批处理中添加客户端数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-138">**/BatchSize**: The number of clients added in each batch.</span></span> <span data-ttu-id="84ff7-139">默认值为 50。</span><span class="sxs-lookup"><span data-stu-id="84ff7-139">The default is 50.</span></span>
- <span data-ttu-id="84ff7-140">**/ ConnectInterval**:间隔 （毫秒） 之间添加连接。</span><span class="sxs-lookup"><span data-stu-id="84ff7-140">**/ConnectInterval**: The interval in milliseconds between adding connections.</span></span> <span data-ttu-id="84ff7-141">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="84ff7-141">The default is 500.</span></span>
- <span data-ttu-id="84ff7-142">**/ 连接**:用于负载测试应用程序的连接数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-142">**/Connections**: The number of connections used to load-test the application.</span></span> <span data-ttu-id="84ff7-143">默认值为 100,000。</span><span class="sxs-lookup"><span data-stu-id="84ff7-143">The default is 100,000.</span></span>
- <span data-ttu-id="84ff7-144">**/ ConnectTimeout**:以秒，然后中止测试的超时。</span><span class="sxs-lookup"><span data-stu-id="84ff7-144">**/ConnectTimeout**: The timeout in seconds before aborting the test.</span></span> <span data-ttu-id="84ff7-145">默认值为 300。</span><span class="sxs-lookup"><span data-stu-id="84ff7-145">The default is 300.</span></span>
- <span data-ttu-id="84ff7-146">**MinServerMBytes**:若要达到最小服务器兆字节。</span><span class="sxs-lookup"><span data-stu-id="84ff7-146">**MinServerMBytes**: The minimum server megabytes to reach.</span></span> <span data-ttu-id="84ff7-147">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="84ff7-147">The default is 500.</span></span>
- <span data-ttu-id="84ff7-148">**SendBytes**:有效负载发送到服务器以字节为单位的大小。</span><span class="sxs-lookup"><span data-stu-id="84ff7-148">**SendBytes**: The size of the payload sent to the server in bytes.</span></span> <span data-ttu-id="84ff7-149">默认值为 0。</span><span class="sxs-lookup"><span data-stu-id="84ff7-149">The default is 0.</span></span>
- <span data-ttu-id="84ff7-150">**SendInterval**:延迟的消息与服务器之间的毫秒数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-150">**SendInterval**: The delay in milliseconds between messages to the server.</span></span> <span data-ttu-id="84ff7-151">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="84ff7-151">The default is 500.</span></span>
- <span data-ttu-id="84ff7-152">**SendTimeout**:以毫秒为单位的到服务器的消息的超时。</span><span class="sxs-lookup"><span data-stu-id="84ff7-152">**SendTimeout**: The timeout in milliseconds for messages to the server.</span></span> <span data-ttu-id="84ff7-153">默认值为 300。</span><span class="sxs-lookup"><span data-stu-id="84ff7-153">The default is 300.</span></span>
- <span data-ttu-id="84ff7-154">**ControllerUrl**:一台客户端将在其中托管控制器中心 Url。</span><span class="sxs-lookup"><span data-stu-id="84ff7-154">**ControllerUrl**: The Url where one client will host a controller hub.</span></span> <span data-ttu-id="84ff7-155">默认值为 null （无控制器中心）。</span><span class="sxs-lookup"><span data-stu-id="84ff7-155">The default is null (no controller hub).</span></span> <span data-ttu-id="84ff7-156">控制器中心启动时启动曲柄会话;无需再进行控制器集线器和曲柄之间的联系。</span><span class="sxs-lookup"><span data-stu-id="84ff7-156">The controller hub is started when the Crank session starts; no further contact between the controller hub and Crank is made.</span></span>
- <span data-ttu-id="84ff7-157">**NumClients**:模拟客户端连接到该应用程序数。</span><span class="sxs-lookup"><span data-stu-id="84ff7-157">**NumClients**: The number of simulated clients to connect to the application.</span></span> <span data-ttu-id="84ff7-158">默认值为 1。</span><span class="sxs-lookup"><span data-stu-id="84ff7-158">The default is one.</span></span>
- <span data-ttu-id="84ff7-159">**日志文件**:为测试运行日志文件的文件名。</span><span class="sxs-lookup"><span data-stu-id="84ff7-159">**Logfile**: The filename for the logfile for the test run.</span></span> <span data-ttu-id="84ff7-160">默认值为 `crank.csv`。</span><span class="sxs-lookup"><span data-stu-id="84ff7-160">The default is `crank.csv`.</span></span>
- <span data-ttu-id="84ff7-161">**SampleInterval**:时间 （毫秒） 之间的性能计数器样本。</span><span class="sxs-lookup"><span data-stu-id="84ff7-161">**SampleInterval**: The time in milliseconds between performance counter samples.</span></span> <span data-ttu-id="84ff7-162">默认值为 1000。</span><span class="sxs-lookup"><span data-stu-id="84ff7-162">The default is 1000.</span></span>
- <span data-ttu-id="84ff7-163">**SignalRInstance**:在服务器上的性能计数器实例名称。</span><span class="sxs-lookup"><span data-stu-id="84ff7-163">**SignalRInstance**: The instance name for the performance counters on the server.</span></span> <span data-ttu-id="84ff7-164">默认值是使用客户端连接状态。</span><span class="sxs-lookup"><span data-stu-id="84ff7-164">The default is to use the client connection state.</span></span>

### <a name="example"></a><span data-ttu-id="84ff7-165">示例</span><span class="sxs-lookup"><span data-stu-id="84ff7-165">Example</span></span>

<span data-ttu-id="84ff7-166">以下命令将测试名的网站`pfsignalr`在 Azure 上承载端口 8080 上的应用程序使用名为"ControllerHub"中心，使用 100 个连接。</span><span class="sxs-lookup"><span data-stu-id="84ff7-166">The following command will test a site called `pfsignalr` on Azure that hosts an application on port 8080 with a hub named "ControllerHub", using 100 connections.</span></span>

`crank /Connections:100 /Url:http://pfsignalr.cloudapp.net:8080/signalr`
