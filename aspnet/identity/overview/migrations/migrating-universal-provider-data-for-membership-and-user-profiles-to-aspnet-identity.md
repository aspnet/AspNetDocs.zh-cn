---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: 将成员身份和用户配置文件的通用提供程序数据C#迁移到 ASP.NET Identity （）-ASP.NET 4。x
author: rustd
description: 本教程介绍迁移使用现有应用通用提供程序创建的用户和角色数据和用户配置文件数据所需的步骤 。
ms.author: riande
ms.date: 12/13/2013
ms.custom: seoapril2019
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 31f02a0cec3c531c45c37b7aad8456e01e80b5ea
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456106"
---
# <a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="95d9b-103">将成员身份和用户配置文件的通用提供程序数据迁移到 ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="95d9b-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>

<span data-ttu-id="95d9b-104">作者： [Pranav rastogi 撰写](https://github.com/rustd)、 [Rick Anderson](https://twitter.com/RickAndMSFT)、 [Robert mcmurray 有关](https://github.com/rmcmurray)、 [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="95d9b-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://twitter.com/RickAndMSFT), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="95d9b-105">本教程介绍将使用现有应用程序通用提供程序创建的用户和角色数据和用户配置文件数据迁移到 ASP.NET Identity 模型所需的步骤。</span><span class="sxs-lookup"><span data-stu-id="95d9b-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="95d9b-106">此处所述的用于迁移用户配置文件数据的方法也可以在具有 SQL 成员身份的应用程序中使用。</span><span class="sxs-lookup"><span data-stu-id="95d9b-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="95d9b-107">随着 Visual Studio 2013 的发布，ASP.NET 团队引入了新的 ASP.NET Identity 系统，你可以在[此处](../../index.md)阅读有关该版本的详细信息。</span><span class="sxs-lookup"><span data-stu-id="95d9b-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="95d9b-108">本文介绍了如何将 web 应用程序从[SQL 成员身份迁移到新的标识系统](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)，本文介绍了将遵循提供程序模型的现有应用程序迁移到新的标识模型的步骤。</span><span class="sxs-lookup"><span data-stu-id="95d9b-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="95d9b-109">本教程的重点是迁移用户配置文件数据，将其无缝地挂钩到新系统。</span><span class="sxs-lookup"><span data-stu-id="95d9b-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="95d9b-110">迁移用户和角色信息与 SQL 成员身份类似。</span><span class="sxs-lookup"><span data-stu-id="95d9b-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="95d9b-111">迁移配置文件数据后的方法也可在具有 SQL 成员身份的应用程序中使用。</span><span class="sxs-lookup"><span data-stu-id="95d9b-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="95d9b-112">例如，我们将从使用提供程序模型的 Visual Studio 2012 创建的 web 应用开始。</span><span class="sxs-lookup"><span data-stu-id="95d9b-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="95d9b-113">接下来，我们将添加用于配置文件管理的代码，注册用户，为用户添加配置文件数据，迁移数据库架构，然后将应用程序更改为使用标识系统进行用户和角色管理。</span><span class="sxs-lookup"><span data-stu-id="95d9b-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="95d9b-114">作为迁移测试，使用通用提供程序创建的用户应能够登录，并且新用户应该能够注册。</span><span class="sxs-lookup"><span data-stu-id="95d9b-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="95d9b-115">可以在[https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations)找到完整示例。</span><span class="sxs-lookup"><span data-stu-id="95d9b-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>

## <a name="profile-data-migration-summary"></a><span data-ttu-id="95d9b-116">配置文件数据迁移摘要</span><span class="sxs-lookup"><span data-stu-id="95d9b-116">Profile data migration summary</span></span>

<span data-ttu-id="95d9b-117">在开始迁移之前，让我们看一下如何在提供程序模型中存储配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="95d9b-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="95d9b-118">应用程序用户的配置文件数据可以通过多种方式进行存储，最常见的方法是使用随通用提供程序提供的内置配置文件提供程序。</span><span class="sxs-lookup"><span data-stu-id="95d9b-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="95d9b-119">步骤包括</span><span class="sxs-lookup"><span data-stu-id="95d9b-119">The steps would include</span></span>

1. <span data-ttu-id="95d9b-120">添加一个具有用于存储配置文件数据的属性的类。</span><span class="sxs-lookup"><span data-stu-id="95d9b-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="95d9b-121">添加一个扩展 "ProfileBase" 的类，并实现方法以获取用户的上述配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="95d9b-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="95d9b-122">启用 web.config 文件中的默认配置*文件提供*程序，并定义在步骤 #2 中声明的类，以便在访问配置文件信息时使用。</span><span class="sxs-lookup"><span data-stu-id="95d9b-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="95d9b-123">配置文件信息作为序列化的 xml 和二进制数据存储在数据库的 "配置文件" 表中。</span><span class="sxs-lookup"><span data-stu-id="95d9b-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="95d9b-124">迁移应用程序以使用新的 ASP.NET Identity 系统后，配置文件信息将反序列化并存储为用户类的属性。</span><span class="sxs-lookup"><span data-stu-id="95d9b-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="95d9b-125">然后，可以将每个属性映射到用户表中的列。</span><span class="sxs-lookup"><span data-stu-id="95d9b-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="95d9b-126">此处的优点是，属性可以直接使用 user 类，而不必在每次访问数据信息时都对其进行序列化/反序列化。</span><span class="sxs-lookup"><span data-stu-id="95d9b-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="95d9b-127">入门</span><span class="sxs-lookup"><span data-stu-id="95d9b-127">Getting Started</span></span>

1. <span data-ttu-id="95d9b-128">在 Visual Studio 2012 中创建新的 ASP.NET 4.5 Web 窗体应用程序。</span><span class="sxs-lookup"><span data-stu-id="95d9b-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="95d9b-129">当前示例使用 Web 窗体模板，但也可以使用 MVC 应用程序。</span><span class="sxs-lookup"><span data-stu-id="95d9b-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="95d9b-130">创建新的文件夹 "模型" 以存储配置文件信息</span><span class="sxs-lookup"><span data-stu-id="95d9b-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="95d9b-131">例如，让我们在配置文件中存储用户的出生日期、城市、高度和权重。</span><span class="sxs-lookup"><span data-stu-id="95d9b-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="95d9b-132">高度和权重存储为名为 "PersonalStats" 的自定义类。</span><span class="sxs-lookup"><span data-stu-id="95d9b-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="95d9b-133">若要存储和检索配置文件，需要一个扩展了 "ProfileBase" 的类。</span><span class="sxs-lookup"><span data-stu-id="95d9b-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="95d9b-134">让我们创建一个新类 "AppProfile" 以获取和存储配置文件信息。</span><span class="sxs-lookup"><span data-stu-id="95d9b-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="95d9b-135">启用*web.config 文件中的配置文件。*</span><span class="sxs-lookup"><span data-stu-id="95d9b-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="95d9b-136">输入用于存储/检索在步骤 #3 中创建的用户信息的类名称。</span><span class="sxs-lookup"><span data-stu-id="95d9b-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="95d9b-137">在 "帐户" 文件夹中添加一个 web 窗体页面，以获取用户的配置文件数据并将其存储。</span><span class="sxs-lookup"><span data-stu-id="95d9b-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="95d9b-138">右键单击 "项目"，然后选择 "添加新项"。</span><span class="sxs-lookup"><span data-stu-id="95d9b-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="95d9b-139">添加带有母版页 "AddProfileData" 的新 webforms 页面。</span><span class="sxs-lookup"><span data-stu-id="95d9b-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="95d9b-140">将以下内容复制到 "MainContent" 部分：</span><span class="sxs-lookup"><span data-stu-id="95d9b-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="95d9b-141">在代码隐藏中添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="95d9b-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="95d9b-142">添加用于定义 AppProfile 类的命名空间，以删除编译错误。</span><span class="sxs-lookup"><span data-stu-id="95d9b-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="95d9b-143">运行应用并创建用户名为 "**olduser"** 的新用户。</span><span class="sxs-lookup"><span data-stu-id="95d9b-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="95d9b-144">导航到 "AddProfileData" 页，并为用户添加配置文件信息。</span><span class="sxs-lookup"><span data-stu-id="95d9b-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="95d9b-145">您可以使用 "服务器资源管理器" 窗口验证数据是否作为序列化的 xml 存储在 "配置文件" 表中。</span><span class="sxs-lookup"><span data-stu-id="95d9b-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="95d9b-146">在 Visual Studio 的 "视图" 菜单中，选择 "服务器资源管理器"。</span><span class="sxs-lookup"><span data-stu-id="95d9b-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="95d9b-147">应为*web.config*文件中定义的数据库提供数据连接。</span><span class="sxs-lookup"><span data-stu-id="95d9b-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="95d9b-148">单击数据连接将显示不同的子类别。</span><span class="sxs-lookup"><span data-stu-id="95d9b-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="95d9b-149">展开 "表" 以显示数据库中的不同表，右键单击 "配置文件"，然后选择 "显示表数据" 以查看存储在配置文件表中的配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="95d9b-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="95d9b-150">迁移数据库架构</span><span class="sxs-lookup"><span data-stu-id="95d9b-150">Migrating database schema</span></span>

<span data-ttu-id="95d9b-151">为了使现有数据库与标识系统一起工作，我们需要更新标识数据库中的架构，以支持添加到原始数据库中的字段。</span><span class="sxs-lookup"><span data-stu-id="95d9b-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="95d9b-152">这可以通过使用 SQL 脚本来创建新表并复制现有信息来实现。</span><span class="sxs-lookup"><span data-stu-id="95d9b-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="95d9b-153">在 "服务器资源管理器" 窗口中，展开 "DefaultConnection" 以显示表。</span><span class="sxs-lookup"><span data-stu-id="95d9b-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="95d9b-154">右键单击 "表" 并选择 "新建查询"</span><span class="sxs-lookup"><span data-stu-id="95d9b-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="95d9b-155">粘贴[https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt)的 SQL 脚本，然后运行该脚本。</span><span class="sxs-lookup"><span data-stu-id="95d9b-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="95d9b-156">如果刷新了 "DefaultConnection"，则可以看到添加了新表。</span><span class="sxs-lookup"><span data-stu-id="95d9b-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="95d9b-157">可以检查表中的数据，以查看信息是否已迁移。</span><span class="sxs-lookup"><span data-stu-id="95d9b-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="95d9b-158">正在迁移应用程序以使用 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="95d9b-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="95d9b-159">安装 ASP.NET Identity 所需的 Nuget 包：</span><span class="sxs-lookup"><span data-stu-id="95d9b-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="95d9b-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="95d9b-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="95d9b-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="95d9b-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="95d9b-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="95d9b-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="95d9b-163">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="95d9b-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="95d9b-164">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="95d9b-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="95d9b-165">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="95d9b-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="95d9b-166">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="95d9b-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="95d9b-167">可在[此处](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)找到有关管理 Nuget 包的详细信息</span><span class="sxs-lookup"><span data-stu-id="95d9b-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="95d9b-168">若要处理表中的现有数据，需要创建模型类，这些类映射回表并在标识系统中将它们挂钩。</span><span class="sxs-lookup"><span data-stu-id="95d9b-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="95d9b-169">作为标识协定的一部分，模型类应实现在 EntityFramework 中定义的接口，或者可以扩展这些接口在中的现有实现方式。</span><span class="sxs-lookup"><span data-stu-id="95d9b-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="95d9b-170">我们将使用现有的角色类、用户登录名和用户声明。</span><span class="sxs-lookup"><span data-stu-id="95d9b-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="95d9b-171">对于我们的示例，我们需要使用自定义用户。</span><span class="sxs-lookup"><span data-stu-id="95d9b-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="95d9b-172">右键单击该项目，然后创建新文件夹 "IdentityModels"。</span><span class="sxs-lookup"><span data-stu-id="95d9b-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="95d9b-173">添加新的 "User" 类，如下所示：</span><span class="sxs-lookup"><span data-stu-id="95d9b-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="95d9b-174">请注意，"ProfileInfo" 现在是 user 类的属性。</span><span class="sxs-lookup"><span data-stu-id="95d9b-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="95d9b-175">因此，我们可以使用 user 类直接处理配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="95d9b-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="95d9b-176">从下载源（ [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ）复制**IdentityModels**和**IdentityAccount**文件夹中的文件。</span><span class="sxs-lookup"><span data-stu-id="95d9b-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="95d9b-177">它们具有使用 ASP.NET Identity Api 的其他模型类和用户和角色管理所需的新页面。</span><span class="sxs-lookup"><span data-stu-id="95d9b-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="95d9b-178">使用的方法与 SQL 成员身份类似，可以在[此处](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)找到详细说明。</span><span class="sxs-lookup"><span data-stu-id="95d9b-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="95d9b-179">将配置文件数据复制到新表</span><span class="sxs-lookup"><span data-stu-id="95d9b-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="95d9b-180">如前文所述，我们需要在配置文件表中反序列化 xml 数据，并将其存储在 AspNetUsers 表的列中。</span><span class="sxs-lookup"><span data-stu-id="95d9b-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="95d9b-181">新列是在上一步的 "用户" 表中创建的，因此，剩下的就是用所需的数据填充这些列。</span><span class="sxs-lookup"><span data-stu-id="95d9b-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="95d9b-182">为此，我们将使用控制台应用程序，该应用程序将运行一次，以便在用户表中填充新创建的列。</span><span class="sxs-lookup"><span data-stu-id="95d9b-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="95d9b-183">在现有解决方案中创建新的控制台应用程序。</span><span class="sxs-lookup"><span data-stu-id="95d9b-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="95d9b-184">安装最新版本的实体框架包。</span><span class="sxs-lookup"><span data-stu-id="95d9b-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="95d9b-185">将上面创建的 web 应用程序添加到控制台应用程序的引用中。</span><span class="sxs-lookup"><span data-stu-id="95d9b-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="95d9b-186">要执行此操作，请右键单击项目，然后单击 "添加引用"，然后单击 "解决方案"，然后单击项目，并单击 "确定"。</span><span class="sxs-lookup"><span data-stu-id="95d9b-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="95d9b-187">将下面的代码复制到 Program.cs 类中。</span><span class="sxs-lookup"><span data-stu-id="95d9b-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="95d9b-188">此逻辑读取每个用户的配置文件数据，将其序列化为 "ProfileInfo" 对象，并将其存储回数据库。</span><span class="sxs-lookup"><span data-stu-id="95d9b-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="95d9b-189">某些使用的模型是在 web 应用程序项目的 "IdentityModels" 文件夹中定义的，因此您必须包含相应的命名空间。</span><span class="sxs-lookup"><span data-stu-id="95d9b-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="95d9b-190">上述代码适用于在之前步骤中创建的 web 应用程序项目\_Data 文件夹中的数据库文件。</span><span class="sxs-lookup"><span data-stu-id="95d9b-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="95d9b-191">若要引用该，请将控制台应用程序的 app.config 文件中的连接字符串更新为 web 应用程序的 web.config 中的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="95d9b-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="95d9b-192">还提供 "AttachDbFilename" 属性中的完整物理路径。</span><span class="sxs-lookup"><span data-stu-id="95d9b-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="95d9b-193">打开命令提示符并导航到上述控制台应用程序的 bin 文件夹。</span><span class="sxs-lookup"><span data-stu-id="95d9b-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="95d9b-194">运行可执行文件，并查看日志输出，如下图所示。</span><span class="sxs-lookup"><span data-stu-id="95d9b-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="95d9b-195">在服务器资源管理器中打开 "AspNetUsers" 表，并验证包含属性的新列中的数据。</span><span class="sxs-lookup"><span data-stu-id="95d9b-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="95d9b-196">应将这些属性值更新为相应的属性值。</span><span class="sxs-lookup"><span data-stu-id="95d9b-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="95d9b-197">验证功能</span><span class="sxs-lookup"><span data-stu-id="95d9b-197">Verify functionality</span></span>

<span data-ttu-id="95d9b-198">使用通过 ASP.NET Identity 实现的新添加的成员资格页从旧数据库登录用户。</span><span class="sxs-lookup"><span data-stu-id="95d9b-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="95d9b-199">用户应能够使用相同的凭据登录。</span><span class="sxs-lookup"><span data-stu-id="95d9b-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="95d9b-200">尝试其他功能，例如添加 OAuth、创建新用户、更改密码、添加角色、将用户添加到角色等。</span><span class="sxs-lookup"><span data-stu-id="95d9b-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="95d9b-201">应检索旧用户和新用户的配置文件数据，并将其存储在用户表中。</span><span class="sxs-lookup"><span data-stu-id="95d9b-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="95d9b-202">不应再引用旧表。</span><span class="sxs-lookup"><span data-stu-id="95d9b-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="95d9b-203">结束语</span><span class="sxs-lookup"><span data-stu-id="95d9b-203">Conclusion</span></span>

<span data-ttu-id="95d9b-204">本文介绍了将使用提供程序模型进行成员身份 ASP.NET Identity 的 web 应用程序迁移到的过程。</span><span class="sxs-lookup"><span data-stu-id="95d9b-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="95d9b-205">此外，还概述了如何将用户的配置文件数据迁移到标识系统。</span><span class="sxs-lookup"><span data-stu-id="95d9b-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="95d9b-206">有关迁移应用时遇到的问题和问题，请在下面留下评论。</span><span class="sxs-lookup"><span data-stu-id="95d9b-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="95d9b-207">*感谢 Rick Anderson 和 Robert Mcmurray 有关，用于查看本文。*</span><span class="sxs-lookup"><span data-stu-id="95d9b-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
