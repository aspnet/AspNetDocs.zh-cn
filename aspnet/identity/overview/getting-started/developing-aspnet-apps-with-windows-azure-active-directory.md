---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: 通过 Azure Active Directory-ASP.NET 4.x 开发 ASP.NET 应用
author: Rick-Anderson
description: Microsoft ASP.NET 的 Azure Active Directory 工具使你可以轻松地为在 Azure 上托管的 web 应用程序启用身份验证。 可以使用 Azure 身份 。
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 28425ea8d1312dfc6e14df9677396f2cbcf6f16d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471740"
---
# <a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="6ac5d-104">借助 Azure Active Directory 开发 ASP.NET 应用</span><span class="sxs-lookup"><span data-stu-id="6ac5d-104">Developing ASP.NET Apps with Azure Active Directory</span></span>

<span data-ttu-id="6ac5d-105">作者： [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="6ac5d-105">by [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="6ac5d-106">Azure Active Directory Microsoft ASP.NET 工具简化了在[Azure](https://www.windowsazure.com/home/features/web-sites/)上托管的 web 应用的身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-106">Microsoft ASP.NET tools for Azure Active Directory simplifies enabling authentication for web apps hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="6ac5d-107">你可以使用 Azure 身份验证对你的组织中的 Office 365 用户、从本地 Active Directory 同步的公司帐户或在你自己的自定义 Azure Active Directory 域中创建的用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="6ac5d-108">启用 Windows Azure 身份验证可以将应用程序配置为使用单个[Azure Active Directory](https://docs.microsoft.com/azure/active-directory/)租户对用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>

<span data-ttu-id="6ac5d-109">本教程将演示如何创建 ASP.NET 应用程序，该应用程序配置为使用[Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) （Azure AD）进行登录。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-109">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="6ac5d-110">你还将了解如何调用图形 API 以获取有关当前已登录用户的信息，以及如何将应用程序部署到 Azure。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-110">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="6ac5d-111">系统必备</span><span class="sxs-lookup"><span data-stu-id="6ac5d-111">Prerequisites</span></span>

1. <span data-ttu-id="6ac5d-112">用于 Web 或 [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) 的 [Visual Studio Express 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) 。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-112">[Visual Studio Express 2013 for Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) or [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span></span>
2. <span data-ttu-id="6ac5d-113">需要[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921)更新3或更高版本。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="6ac5d-114">一个 Azure 帐户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-114">An Azure account.</span></span> <span data-ttu-id="6ac5d-115">如果还没有帐户，[请单击此处](https://azure.microsoft.com/pricing/free-trial/)获取免费试用版。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-115">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="6ac5d-116">将全局管理员添加到 Active Directory</span><span class="sxs-lookup"><span data-stu-id="6ac5d-116">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="6ac5d-117">登录到 [Azure 管理门户](https://manage.windowsazure.com/)。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-117">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="6ac5d-118">所有 Azure 帐户都包含一个**默认目录**，单击它，然后单击页面顶部的 "**用户**" 选项卡（请参阅下图）。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-118">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="6ac5d-119">单击“添加用户”。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-119">Click Add User.</span></span>
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="6ac5d-120">使用 "**全局管理员**" 角色创建新用户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-120">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="6ac5d-121">单击顶部菜单中的 "**用户**"，然后单击命令栏上的 "**添加用户**" 按钮。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-121">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="6ac5d-122">在 "**添加用户**" 对话框中，输入新用户的名称，然后单击右箭头。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-122">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="6ac5d-123">输入用户名并将 "角色" 设置为 "**全局管理员**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-123">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="6ac5d-124">全局管理员需要使用备用电子邮件地址进行密码恢复。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-124">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="6ac5d-125">完成后，单击右箭头。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-125">After you're finished, click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="6ac5d-126">在对话框的下一页上，单击 "**创建**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-126">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="6ac5d-127">将为新用户创建一个临时密码，并显示在对话框中。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-127">A temporary password will be created for the new user and displayed in the dialog.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)

   <span data-ttu-id="6ac5d-128">保存密码，你将需要在首次登录后更改密码。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-128">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="6ac5d-129">下图显示了新的管理员帐户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-129">The following image shows the new admin account.</span></span> <span data-ttu-id="6ac5d-130">您必须使用 Azure Active Directory 登录到您的应用程序，而不是此页面上显示的 Microsoft 帐户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-130">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="6ac5d-131">创建 ASP.NET 应用程序</span><span class="sxs-lookup"><span data-stu-id="6ac5d-131">Create an ASP.NET Application</span></span>

<span data-ttu-id="6ac5d-132">以下步骤使用[Visual Studio Express 2013 For Web](https://www.microsoft.com/download/details.aspx?id=40747)，并需要[Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721)。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-132">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="6ac5d-133">在 Visual Studio 中，依次单击 "**文件**" 和 "**新建项目**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-133">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="6ac5d-134">在 "**新建项目**" 对话框中，从C#左侧菜单中选择 "可视 Web 项目"，然后单击 **"确定"** 。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-134">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="6ac5d-135">如果不需要应用程序的功能，则可能还需要取消选中 "**将 Application Insights 添加到项目**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-135">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="6ac5d-136">在 "**新建 ASP.NET 项目**" 对话框中，选择 " **MVC**"，然后单击 "**更改身份验证**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-136">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="6ac5d-137">在 "**更改身份验证**" 对话框中，选择 "**组织帐户**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-137">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="6ac5d-138">这些选项可用于自动向 Azure AD 注册应用程序，以及自动配置应用程序以与 Azure AD 集成。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-138">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="6ac5d-139">你不必使用 "**更改身份验证**" 对话框来注册和配置你的应用程序，但这样做会更容易。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-139">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="6ac5d-140">例如，如果使用的是 Visual Studio 2012，你仍可以在 Azure 管理门户中手动注册应用程序，并更新其配置以与 Azure AD 集成。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-140">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>
   <span data-ttu-id="6ac5d-141">在下拉菜单中，选择 "**云-单一组织**" 和 **"单一登录"，读取目录数据**。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-141">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="6ac5d-142">输入 Azure AD 目录的域（例如，在下图中） *aricka0yahoo.onmicrosoft.com*，然后单击 **"确定"** 。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-142">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="6ac5d-143">你可以从 azure 门户上的默认目录的 "域" 选项卡获取域名（请参阅下图）。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-143">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)

   <span data-ttu-id="6ac5d-144">下图显示了 Azure 门户中的域名。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-144">The following image shows the domain name from the Azure portal.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)

    > [!NOTE]
    > <span data-ttu-id="6ac5d-145">通过单击 "**更多选项**"，可以选择配置将在 Azure AD 中注册的应用程序 ID URI。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-145">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="6ac5d-146">应用 ID URI 是应用程序的唯一标识符，该标识符在 Azure AD 中注册，并在与 Azure AD 通信时由应用程序用来标识自身。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-146">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="6ac5d-147">有关已注册应用程序的应用 ID URI 和其他属性的详细信息，请参阅[此主题](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering)。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-147">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="6ac5d-148">单击 "应用 ID URI" 字段下面的复选框，你还可以选择覆盖 Azure AD 中使用相同应用 ID URI 的现有注册。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-148">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="6ac5d-149">单击 **"确定"** 后，将出现一个 "登录" 对话框，你将需要使用全局管理员帐户（而不是与你的订阅关联的 Microsoft 帐户）登录。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-149">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="6ac5d-150">如果你之前创建了一个新的管理员帐户，则需要更改该密码，然后使用新密码再次登录。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-150">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="6ac5d-151">成功通过身份验证后，"**新建 ASP.NET 项目**" 对话框将显示身份验证选择（**组织**）以及将在其中注册新应用程序的目录（下图中的*aricka0yahoo.onmicrosoft.com* ）。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-151">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="6ac5d-152">在此信息下方，选中标记为 **"在云中托管**" 的复选框。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-152">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="6ac5d-153">如果选中此复选框，则会将项目设置为 Azure web 应用，并在以后轻松发布。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-153">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="6ac5d-154">单击 **“确定”** 。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-154">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="6ac5d-155">将显示 "**配置 Azure 网站**" 对话框，其中使用自动生成的站点名称和区域。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-155">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="6ac5d-156">另请注意对话框中当前登录的帐户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-156">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="6ac5d-157">需要确保此帐户是 Azure 订阅附加到的帐户，通常是 Microsoft 帐户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-157">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="6ac5d-158">此项目需要数据库。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-158">This project requires a database.</span></span> <span data-ttu-id="6ac5d-159">需要选择一个现有数据库，或创建一个新数据库。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-159">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="6ac5d-160">数据库是必需的，因为该项目已使用本地数据库文件来存储少量的身份验证配置数据。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-160">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="6ac5d-161">当你将应用程序部署到 Azure 网站时，此数据库不会与部署一起打包，因此你需要选择一个在云中可访问的数据库。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-161">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="6ac5d-162">单击 **“确定”** 。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-162">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="6ac5d-163">将创建项目，并且会自动为该项目配置身份验证选项和 web 应用选项。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-163">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="6ac5d-164">完成此过程后，按 **^ F5**在本地运行该项目。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-164">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="6ac5d-165">你将需要使用你的组织帐户进行登录。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-165">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="6ac5d-166">提供前面创建的帐户的用户名和密码，并单击 "**登录**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-166">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="6ac5d-167">成功登录后，ASP.NET 网站将显示已通过在页面右上角显示用户名进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-167">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)

   <span data-ttu-id="6ac5d-168">如果收到错误：值不能为 null 或为空。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-168">If you get the error: Value cannot be null or empty.</span></span> <span data-ttu-id="6ac5d-169">参数名称： Externallink><maml linktext> ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="6ac5d-169">Parameter name: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span></span>

   <span data-ttu-id="6ac5d-170">请参阅本教程末尾的 "[调试](#dbg)" 部分。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-170">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="6ac5d-171">图形 API 基础知识</span><span class="sxs-lookup"><span data-stu-id="6ac5d-171">Basics of the Graph API</span></span>

<span data-ttu-id="6ac5d-172">[图形 API](https://msdn.microsoft.com/library/azure/hh974476.aspx)是用于对 Azure AD 目录中的对象执行 CRUD 和其他操作的编程接口。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-172">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="6ac5d-173">如果在 Visual Studio 2013 中创建新项目时，选择 "用于身份验证的组织帐户" 选项，则应用程序将配置为调用图形 API。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-173">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="6ac5d-174">本部分简要介绍图形 API 的工作方式。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-174">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="6ac5d-175">在正在运行的应用程序中，单击页面右上角的已登录用户的名称。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-175">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="6ac5d-176">这会将你转到 "用户配置文件" 页，该页面是对 Home 控制器的操作。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-176">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="6ac5d-177">你会注意到，该表包含之前创建的管理员帐户的用户信息。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-177">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="6ac5d-178">此信息存储在目录中，在加载页面时，将调用图形 API 来检索此信息。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-178">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="6ac5d-179">返回到 Visual Studio，展开 "**控制器**" 文件夹，然后打开**HomeController.cs**文件。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-179">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="6ac5d-180">你将看到一个**UserProfile （）** 操作，其中包含用于检索令牌并调用图形 API 的代码。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-180">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="6ac5d-181">此代码复制如下：</span><span class="sxs-lookup"><span data-stu-id="6ac5d-181">This code is duplicated below:</span></span>

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="6ac5d-182">若要调用图形 API，首先需要检索令牌。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-182">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="6ac5d-183">检索令牌后，必须将其字符串值追加到图形 API 的所有后续请求的授权标头中。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-183">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="6ac5d-184">上面的大多数代码都将处理对 Azure AD 的身份验证的详细信息，以获取令牌，并使用该令牌调用图形 API，然后转换响应以使其能够显示在视图中。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-184">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="6ac5d-185">讨论最相关的部分是以下突出显示的行： `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-185">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="6ac5d-186">该行表示用户的名称，该名称已经从 JSON 响应反序列化，并显示在视图中。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-186">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="6ac5d-187">你可以使用 HttpClient 调用图形 API 并自行处理原始数据，但更简单的方法是使用[Graph 客户端库（可通过 NuGet 获得](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/)）。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-187">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="6ac5d-188">客户端库处理原始 HTTP 请求和返回的数据的转换，并使在 .NET 环境中使用图形 API 变得更加容易。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-188">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="6ac5d-189">请参阅 GitHub 上的相关图形 API 代码示例[。](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="6ac5d-189">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="6ac5d-190">将应用程序部署到 Azure</span><span class="sxs-lookup"><span data-stu-id="6ac5d-190">Deploy the Application to Azure</span></span>

<span data-ttu-id="6ac5d-191">以下步骤将演示如何将应用程序部署到 Azure。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-191">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="6ac5d-192">在前面的步骤中，已将新项目与 Azure 上的 web 应用连接，因此只需几个步骤即可发布。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-192">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="6ac5d-193">在 Visual Studio 中，右键单击该项目，然后选择 "**发布**"。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-193">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="6ac5d-194">将显示 "**发布 Web** " 对话框，其中每个设置均已配置。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-194">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="6ac5d-195">单击 "**下一步**" 按钮以切换到 "**设置**" 页。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-195">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="6ac5d-196">系统可能会提示你进行身份验证;请确保使用 Azure 订阅帐户（通常是 Microsoft 帐户）进行身份验证，而不是之前创建的组织帐户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-196">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="6ac5d-197">选中 "**启用组织身份验证**" 选项。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-197">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="6ac5d-198">在 "**域**" 字段中，输入目录的域。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-198">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="6ac5d-199">从 "**访问级别**" 下拉选择 "**单一登录"，然后选择 "读取目录数据"** 。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-199">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="6ac5d-200">你会注意到，以前使用的数据库已在 "**数据库**" 部分中填充。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-200">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="6ac5d-201">单击“发布”。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-201">Click **Publish**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="6ac5d-202">Visual Studio 将开始部署你的网站，然后将显示一个新的浏览器窗口。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-202">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="6ac5d-203">系统可能会提示你再次向你的目录进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-203">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="6ac5d-204">经过身份验证后，会重定向到 Azure 上新发布的网站。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-204">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="6ac5d-205">调试应用程序</span><span class="sxs-lookup"><span data-stu-id="6ac5d-205">Debugging the app</span></span>

<span data-ttu-id="6ac5d-206">如果收到以下错误信息：值不能为 null 或为空。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-206">If you get the following error: Value cannot be null or empty.</span></span> <span data-ttu-id="6ac5d-207">参数名称： Externallink><maml linktext></span><span class="sxs-lookup"><span data-stu-id="6ac5d-207">Parameter name: linkText</span></span>

![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)

<span data-ttu-id="6ac5d-208">将*Views\Shared\\_LoginPartial*的代码替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="6ac5d-208">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="6ac5d-209">运行应用后，如果登录用户显示 "Null 用户"，注销，然后重新登录到前面创建的 Active Directory 帐户。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-209">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="6ac5d-210">要遵循的一个优秀教程是 Rick Rainey [深入探讨：使用 Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)的 Azure 网站和组织身份验证。</span><span class="sxs-lookup"><span data-stu-id="6ac5d-210">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="6ac5d-211">详细信息</span><span class="sxs-lookup"><span data-stu-id="6ac5d-211">More Information</span></span>

- <span data-ttu-id="6ac5d-212">[深入了解：使用 Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/) 的 Azure 网站和组织身份验证</span><span class="sxs-lookup"><span data-stu-id="6ac5d-212">[Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)</span></span>
- [<span data-ttu-id="6ac5d-213">Azure AD 图形 API 概述</span><span class="sxs-lookup"><span data-stu-id="6ac5d-213">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="6ac5d-214">Azure AD 中的身份验证方案</span><span class="sxs-lookup"><span data-stu-id="6ac5d-214">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="6ac5d-215">GitHub 上的 Azure AD 代码示例</span><span class="sxs-lookup"><span data-stu-id="6ac5d-215">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
