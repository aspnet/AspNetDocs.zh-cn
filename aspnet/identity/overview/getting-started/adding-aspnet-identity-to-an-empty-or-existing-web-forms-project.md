---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: 将 ASP.NET Identity 添加到空白或现有 Web 窗体项目-ASP.NET 4。x
author: raquelsa
description: 本教程介绍如何将 ASP.NET Identity （ASP.NET 的成员资格系统）添加到 ASP.NET 应用程序。 创建新的 Web 窗体或 MVC 时 。
ms.author: riande
ms.date: 01/22/2019
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: 8e82951d57f0b8052ee3f6530a7470be7d030206
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471974"
---
# <a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="a59b7-104">向空的或现有的 Web 窗体项目添加 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="a59b7-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>

> <span data-ttu-id="a59b7-105">本教程介绍如何将[ASP.NET Identity](introduction-to-aspnet-identity.md) （ASP.NET 的新成员资格系统）添加到 ASP.NET 应用程序。</span><span class="sxs-lookup"><span data-stu-id="a59b7-105">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="a59b7-106">当你在 Visual Studio 2017 RTM 中使用个人帐户创建新的 Web 窗体或 MVC 项目时，Visual Studio 将安装所有必需的包，并为你添加所有必要的类。</span><span class="sxs-lookup"><span data-stu-id="a59b7-106">When you create a new Web Forms or MVC project in Visual Studio 2017 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="a59b7-107">本教程将演示将 ASP.NET Identity 支持添加到现有 Web 窗体项目或新的空项目的步骤。</span><span class="sxs-lookup"><span data-stu-id="a59b7-107">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="a59b7-108">我将概述所有需要安装的 NuGet 包以及需要添加的类。</span><span class="sxs-lookup"><span data-stu-id="a59b7-108">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="a59b7-109">我将浏览用于注册新用户和登录的示例 Web 窗体，同时突出显示用于用户管理和身份验证的所有主入口点 Api。</span><span class="sxs-lookup"><span data-stu-id="a59b7-109">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="a59b7-110">此示例将使用基于实体框架生成的 SQL 数据存储 ASP.NET Identity 默认实现。</span><span class="sxs-lookup"><span data-stu-id="a59b7-110">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="a59b7-111">本教程将为 SQL 数据库使用 LocalDB。</span><span class="sxs-lookup"><span data-stu-id="a59b7-111">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 

## <a name="get-started-with-aspnet-identity"></a><span data-ttu-id="a59b7-112">ASP.NET Identity 入门</span><span class="sxs-lookup"><span data-stu-id="a59b7-112">Get started with ASP.NET Identity</span></span>

1. <span data-ttu-id="a59b7-113">首先，安装并运行[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/)。</span><span class="sxs-lookup"><span data-stu-id="a59b7-113">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span></span>
2. <span data-ttu-id="a59b7-114">从起始页中选择 "**新建项目**"，或者可以使用菜单并依次选择 "**文件**" 和 "**新建项目**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-114">Select **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="a59b7-115">在左侧窗格中，展开 **" C#视觉对象**"，选择 " **web**"，然后选择 " **ASP.NET web 应用程序（.net Framework）** "。</span><span class="sxs-lookup"><span data-stu-id="a59b7-115">In the left pane, expand **Visual C#**, then select **Web**, then **ASP.NET Web Application (.Net Framework)**.</span></span> <span data-ttu-id="a59b7-116">将项目命名为 "WebFormsIdentity"，然后选择 **"确定**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-116">Name your project "WebFormsIdentity" and select **OK**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image17.png)
4. <span data-ttu-id="a59b7-117">在 "**新建 ASP.NET 项目**" 对话框中，选择 "**空**" 模板。</span><span class="sxs-lookup"><span data-stu-id="a59b7-117">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="a59b7-118">请注意，"**更改身份验证**" 按钮已禁用，且此模板中未提供任何身份验证支持。</span><span class="sxs-lookup"><span data-stu-id="a59b7-118">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="a59b7-119">利用 Web 窗体、MVC 和 Web API 模板，你可以选择身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="a59b7-119">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span>

## <a name="add-identity-packages-to-your-app"></a><span data-ttu-id="a59b7-120">向应用程序添加标识包</span><span class="sxs-lookup"><span data-stu-id="a59b7-120">Add Identity packages to your app</span></span>

<span data-ttu-id="a59b7-121">在解决方案资源管理器中，右键单击项目并选择 "**管理 NuGet 包**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-121">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="a59b7-122">搜索并安装 " **EntityFramework** " 包。</span><span class="sxs-lookup"><span data-stu-id="a59b7-122">Search for and install the **Microsoft.AspNet.Identity.EntityFramework** package.</span></span> 
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image15.png)
  
<span data-ttu-id="a59b7-123">请注意，此包将安装依赖项包： **EntityFramework**和**Microsoft ASP.NET 标识核心**。</span><span class="sxs-lookup"><span data-stu-id="a59b7-123">Note that this package will install the dependency packages: **EntityFramework** and **Microsoft ASP.NET Identity Core**.</span></span>

## <a name="add-a-web-form-to-register-users"></a><span data-ttu-id="a59b7-124">添加 web 窗体以注册用户</span><span class="sxs-lookup"><span data-stu-id="a59b7-124">Add a web form to register users</span></span>

1. <span data-ttu-id="a59b7-125">在**解决方案资源管理器**中，右键单击项目并选择 "**添加**"，然后选择 " **Web 窗体**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-125">In **Solution Explorer**, right-click your project and select **Add**, and then **Web Form**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="a59b7-126">在 "**指定项目的名称**" 对话框中，将新的 web 窗体命名为**Register**，然后选择 **"确定"**</span><span class="sxs-lookup"><span data-stu-id="a59b7-126">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then select **OK**</span></span>
3. <span data-ttu-id="a59b7-127">将生成的*Register .aspx*文件中的标记替换为以下代码。</span><span class="sxs-lookup"><span data-stu-id="a59b7-127">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="a59b7-128">代码所作更改为突出显示状态。</span><span class="sxs-lookup"><span data-stu-id="a59b7-128">The code changes are highlighted.</span></span> 

    [!code-html[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="a59b7-129">这只是在创建新的 ASP.NET Web 窗体项目时所创建的*Register .aspx*文件的简化版本。</span><span class="sxs-lookup"><span data-stu-id="a59b7-129">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="a59b7-130">上面的标记将添加窗体字段和用于注册新用户的按钮。</span><span class="sxs-lookup"><span data-stu-id="a59b7-130">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="a59b7-131">打开*Register.aspx.cs*文件，并将该文件的内容替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="a59b7-131">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="a59b7-132">上面的代码是在创建新的 ASP.NET Web 窗体项目时创建的*Register.aspx.cs*文件的简化版本。</span><span class="sxs-lookup"><span data-stu-id="a59b7-132">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="a59b7-133">*IdentityUser*类是*IUser*接口的默认 EntityFramework 实现。</span><span class="sxs-lookup"><span data-stu-id="a59b7-133">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="a59b7-134">*IUser*接口是 ASP.NET Identity 核心上用户的最小界面。</span><span class="sxs-lookup"><span data-stu-id="a59b7-134">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="a59b7-135">*UserStore*类是用户存储的默认 EntityFramework 实现。</span><span class="sxs-lookup"><span data-stu-id="a59b7-135">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="a59b7-136">此类实现 ASP.NET Identity 核心的最小接口： *IUserStore*、 *IUserLoginStore*、 *IUserClaimStore*和*IUserRoleStore*。</span><span class="sxs-lookup"><span data-stu-id="a59b7-136">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="a59b7-137">*UserManager*类公开用户相关的 api，这些 api 会自动将更改保存到*UserStore*。</span><span class="sxs-lookup"><span data-stu-id="a59b7-137">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="a59b7-138">*IdentityResult*类表示标识操作的结果。</span><span class="sxs-lookup"><span data-stu-id="a59b7-138">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="a59b7-139">在**解决方案资源管理器**中，右键单击项目并选择 "**添加**"，**添加 "ASP.NET" 文件夹**，然后单击 "**应用\_数据**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-139">In **Solution Explorer**, right-click your project and select **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="a59b7-140">打开 web.config*文件，* 并添加用于存储用户信息的数据库的连接字符串项。</span><span class="sxs-lookup"><span data-stu-id="a59b7-140">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="a59b7-141">将在运行时通过 EntityFramework 为标识实体创建数据库。</span><span class="sxs-lookup"><span data-stu-id="a59b7-141">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="a59b7-142">在创建新的 Web 窗体项目时，连接字符串类似于创建的字符串。</span><span class="sxs-lookup"><span data-stu-id="a59b7-142">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="a59b7-143">突出显示的代码显示了应添加的标记：</span><span class="sxs-lookup"><span data-stu-id="a59b7-143">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="a59b7-144">对于 Visual Studio 2015 或更高版本，请在连接字符串中将 `(localdb)\v11.0` 替换为 `(localdb)\MSSQLLocalDB`。</span><span class="sxs-lookup"><span data-stu-id="a59b7-144">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="a59b7-145">右键单击项目中的 *"文件"* ，然后选择 "**设为起始页**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-145">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="a59b7-146">按 Ctrl + F5 生成并运行 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="a59b7-146">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="a59b7-147">输入新用户名和密码，然后选择 "**注册**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-147">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="a59b7-148">ASP.NET Identity 支持验证，在此示例中，你可以验证来自标识核心包的用户和密码验证程序的默认行为。</span><span class="sxs-lookup"><span data-stu-id="a59b7-148">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="a59b7-149">用户（`UserValidator`）的默认验证程序具有属性 `AllowOnlyAlphanumericUserNames`，其默认值设置为 "`true`"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-149">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="a59b7-150">密码（`MinimumLengthValidator`）的默认验证程序确保密码至少包含6个字符。</span><span class="sxs-lookup"><span data-stu-id="a59b7-150">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="a59b7-151">这些验证程序是 `UserManager` 上的属性，如果要进行自定义验证，则可以重写这些属性。</span><span class="sxs-lookup"><span data-stu-id="a59b7-151">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verify-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="a59b7-152">验证 LocalDb 标识数据库和生成的表实体框架</span><span class="sxs-lookup"><span data-stu-id="a59b7-152">Verify the LocalDb Identity database and tables generated by Entity Framework</span></span>

1. <span data-ttu-id="a59b7-153">在 "**视图**" 菜单中，选择**服务器资源管理器**。</span><span class="sxs-lookup"><span data-stu-id="a59b7-153">In the **View** menu, select **Server Explorer**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="a59b7-154">展开**DefaultConnection （WebFormsIdentity）** ，展开 "**表**"，右键单击**AspNetUsers** ，然后选择 "**显示表数据**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-154">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right-click **AspNetUsers** and then select **Show Table Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configure-the-application-for-owin-authentication"></a><span data-ttu-id="a59b7-155">配置应用程序进行 OWIN 身份验证</span><span class="sxs-lookup"><span data-stu-id="a59b7-155">Configure the application for OWIN authentication</span></span>

<span data-ttu-id="a59b7-156">此时，我们仅添加了对创建用户的支持。</span><span class="sxs-lookup"><span data-stu-id="a59b7-156">At this point we have only added support for creating users.</span></span> <span data-ttu-id="a59b7-157">现在，我们将演示如何添加身份验证来登录用户。</span><span class="sxs-lookup"><span data-stu-id="a59b7-157">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="a59b7-158">ASP.NET Identity 使用 Microsoft OWIN Authentication 中间件进行窗体身份验证。</span><span class="sxs-lookup"><span data-stu-id="a59b7-158">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="a59b7-159">OWIN Cookie 身份验证是一个 cookie 和基于声明的身份验证机制，可由[OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx)或 IIS 上托管的任何框架使用。</span><span class="sxs-lookup"><span data-stu-id="a59b7-159">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="a59b7-160">使用此模型时，可以跨多个框架（包括 ASP.NET MVC 和 Web 窗体）使用相同的身份验证包。</span><span class="sxs-lookup"><span data-stu-id="a59b7-160">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="a59b7-161">有关 project Katana 以及如何在主机中运行中间件的详细信息，请参阅[使用 Katana 项目入门](https://msdn.microsoft.com/magazine/dn451439.aspx)。</span><span class="sxs-lookup"><span data-stu-id="a59b7-161">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="install-authentication-packages-to-your-application"></a><span data-ttu-id="a59b7-162">将身份验证包安装到应用程序</span><span class="sxs-lookup"><span data-stu-id="a59b7-162">Install authentication packages to your application</span></span>

1. <span data-ttu-id="a59b7-163">在解决方案资源管理器中，右键单击项目并选择 "**管理 NuGet 包**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-163">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="a59b7-164">搜索并安装 " ***Owin*** " 包。</span><span class="sxs-lookup"><span data-stu-id="a59b7-164">Search for and install the ***Microsoft.AspNet.Identity.Owin*** package.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image16.png)

2. <span data-ttu-id="a59b7-165">搜索并安装 Owin. ***SystemWeb***包。</span><span class="sxs-lookup"><span data-stu-id="a59b7-165">Search for and install the ***Microsoft.Owin.Host.SystemWeb*** package.</span></span>

    > [!NOTE]
    > <span data-ttu-id="a59b7-166">**Owin**包包含一组 Owin 扩展类，以管理和配置要 ASP.NET Identity 核心包使用的 Owin 身份验证中间件。</span><span class="sxs-lookup"><span data-stu-id="a59b7-166">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>
    > <span data-ttu-id="a59b7-167">**Owin**包包含 Owin 服务器，该服务器允许基于 Owin 的应用程序使用 ASP.NET 请求管道在 IIS 上运行。</span><span class="sxs-lookup"><span data-stu-id="a59b7-167">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="a59b7-168">有关详细信息，请参阅[IIS 集成管道中的 OWIN 中间件](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md)。</span><span class="sxs-lookup"><span data-stu-id="a59b7-168">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="add-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="a59b7-169">添加 OWIN 启动和身份验证配置类</span><span class="sxs-lookup"><span data-stu-id="a59b7-169">Add OWIN startup and authentication configuration classes</span></span>

1. <span data-ttu-id="a59b7-170">在**解决方案资源管理器**中，右键单击项目，选择 "**添加**"，然后单击 "**添加新项**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-170">In **Solution Explorer**, right-click your project, select **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="a59b7-171">在 "搜索文本框" 对话框中，键入 "*owin*"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-171">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="a59b7-172">将类命名为 "*Startup*" 并选择 "**添加**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-172">Name the class "*Startup*" and select **Add**.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="a59b7-173">在 Startup.cs 文件中，添加以下突出显示的代码以配置 OWIN cookie 身份验证。</span><span class="sxs-lookup"><span data-stu-id="a59b7-173">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="a59b7-174">此类包含用于指定 OWIN startup 类的 `OwinStartup` 特性。</span><span class="sxs-lookup"><span data-stu-id="a59b7-174">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="a59b7-175">每个 OWIN 应用程序都有一个 startup 类，您可以在其中为应用程序管道指定组件。</span><span class="sxs-lookup"><span data-stu-id="a59b7-175">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="a59b7-176">有关此模型的详细信息，请参阅[OWIN Startup Class 检测](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)。</span><span class="sxs-lookup"><span data-stu-id="a59b7-176">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="add-web-forms-for-registering-and-signing-in-users"></a><span data-ttu-id="a59b7-177">添加 web 窗体以便在用户注册和登录</span><span class="sxs-lookup"><span data-stu-id="a59b7-177">Add web forms for registering and signing in users</span></span>

1. <span data-ttu-id="a59b7-178">打开*Register.aspx.cs*文件，并添加以下代码，以便在注册成功时登录用户。</span><span class="sxs-lookup"><span data-stu-id="a59b7-178">Open the *Register.aspx.cs* file and add the following code which signs in the user when registration succeeds.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="a59b7-179">由于 ASP.NET Identity 和 OWIN Cookie 身份验证是基于声明的系统，因此框架要求应用开发人员为用户生成[ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="a59b7-179">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="a59b7-180">ClaimsIdentity 包含用户的所有声明的相关信息，例如用户所属的角色。</span><span class="sxs-lookup"><span data-stu-id="a59b7-180">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="a59b7-181">你还可以在此阶段为用户添加更多声明。</span><span class="sxs-lookup"><span data-stu-id="a59b7-181">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="a59b7-182">你可以使用 OWIN 中的 AuthenticationManager 并调用 `SignIn` 并传入 ClaimsIdentity，如上文所示）登录用户。</span><span class="sxs-lookup"><span data-stu-id="a59b7-182">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="a59b7-183">此代码还将登录用户并生成 cookie。</span><span class="sxs-lookup"><span data-stu-id="a59b7-183">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="a59b7-184">此调用类似于[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模块使用的[FormAuthentication。](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx)</span><span class="sxs-lookup"><span data-stu-id="a59b7-184">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="a59b7-185">在**解决方案资源管理器**中，右键单击项目，选择 "**添加**"，然后选择 " **Web 窗体**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-185">In **Solution Explorer**, right-click your project, select **Add**, and then **Web Form**.</span></span> <span data-ttu-id="a59b7-186">将 web 窗体命名为**Login**。</span><span class="sxs-lookup"><span data-stu-id="a59b7-186">Name the web form **Login**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="a59b7-187">将该*登录 .aspx*文件的内容替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="a59b7-187">Replace the contents of the *Login.aspx* file with the following code:</span></span>

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="a59b7-188">将*Login.aspx.cs*文件的内容替换为以下内容：</span><span class="sxs-lookup"><span data-stu-id="a59b7-188">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="a59b7-189">`Page_Load` 现在会检查当前用户的状态，并根据其 `Context.User.Identity.IsAuthenticated` 状态采取措施。</span><span class="sxs-lookup"><span data-stu-id="a59b7-189">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>
    >   <span data-ttu-id="a59b7-190">**显示登录的用户名**： Microsoft ASP.NET 标识框架已在[IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx)上添加了扩展方法，该方法允许你获取已登录用户的 `UserName` 和 `UserId`。</span><span class="sxs-lookup"><span data-stu-id="a59b7-190">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="a59b7-191">这些扩展方法是在 `Microsoft.AspNet.Identity.Core` 程序集中定义的。</span><span class="sxs-lookup"><span data-stu-id="a59b7-191">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="a59b7-192">这些扩展方法是[HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx)的替代方法。</span><span class="sxs-lookup"><span data-stu-id="a59b7-192">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="a59b7-193">登录方法： `This` 方法替换此示例中以前的 `CreateUser_Click` 方法，并在成功创建用户后登录用户。</span><span class="sxs-lookup"><span data-stu-id="a59b7-193">SignIn method: `This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >   <span data-ttu-id="a59b7-194">Microsoft OWIN Framework 已在 `System.Web.HttpContext` 上添加了扩展方法，使你可以获取对 `IOwinContext`的引用。</span><span class="sxs-lookup"><span data-stu-id="a59b7-194">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="a59b7-195">这些扩展方法是在 `Microsoft.Owin.Host.SystemWeb` 程序集中定义的。</span><span class="sxs-lookup"><span data-stu-id="a59b7-195">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="a59b7-196">`OwinContext` 类公开了一个 `IAuthenticationManager` 属性，该属性表示当前请求上可用的身份验证中间件功能。</span><span class="sxs-lookup"><span data-stu-id="a59b7-196">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span> <span data-ttu-id="a59b7-197">您可以使用 OWIN 中的 `AuthenticationManager`，然后调用 `SignIn` 并传入 `ClaimsIdentity`，如上所示。</span><span class="sxs-lookup"><span data-stu-id="a59b7-197">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn` and passing in the `ClaimsIdentity` as shown above.</span></span> <span data-ttu-id="a59b7-198">由于 ASP.NET Identity 和 OWIN Cookie 身份验证是基于声明的系统，因此框架要求该应用为用户生成 `ClaimsIdentity`。</span><span class="sxs-lookup"><span data-stu-id="a59b7-198">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="a59b7-199">`ClaimsIdentity` 包含有关用户的所有声明的信息，例如用户所属的角色。</span><span class="sxs-lookup"><span data-stu-id="a59b7-199">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="a59b7-200">你还可以在此阶段为用户添加更多声明。此代码将登录用户并生成 cookie。</span><span class="sxs-lookup"><span data-stu-id="a59b7-200">You can also add more claims for the user at this stage This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="a59b7-201">此调用类似于[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模块使用的[FormAuthentication。](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx)</span><span class="sxs-lookup"><span data-stu-id="a59b7-201">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="a59b7-202">`SignOut` 方法：从 OWIN 获取对 `AuthenticationManager` 的引用，并调用 `SignOut`。</span><span class="sxs-lookup"><span data-stu-id="a59b7-202">`SignOut` method: Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="a59b7-203">这类似于[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模块使用的[FormsAuthentication. SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx)方法。</span><span class="sxs-lookup"><span data-stu-id="a59b7-203">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="a59b7-204">按**Ctrl + F5**生成并运行 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="a59b7-204">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="a59b7-205">输入新用户名和密码，然后选择 "**注册**"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-205">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="a59b7-206">注意：此时，将创建新用户并登录。</span><span class="sxs-lookup"><span data-stu-id="a59b7-206">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="a59b7-207">选择 "**注销**" 按钮。</span><span class="sxs-lookup"><span data-stu-id="a59b7-207">Select the **Log out** button.</span></span> <span data-ttu-id="a59b7-208">你将被重定向到登录窗体。</span><span class="sxs-lookup"><span data-stu-id="a59b7-208">You are redirected to the Log in form.</span></span>
7. <span data-ttu-id="a59b7-209">输入无效的用户名或密码，然后选择 "**登录**" 按钮。</span><span class="sxs-lookup"><span data-stu-id="a59b7-209">Enter an invalid user name or password and select the **Log in** button.</span></span> 
   <span data-ttu-id="a59b7-210">`UserManager.Find` 方法将返回 null，并将显示错误消息： "*用户名或密码无效*"。</span><span class="sxs-lookup"><span data-stu-id="a59b7-210">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
