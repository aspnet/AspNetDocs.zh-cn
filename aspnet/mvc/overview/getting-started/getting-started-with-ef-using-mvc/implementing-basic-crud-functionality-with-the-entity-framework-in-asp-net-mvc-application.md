---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
title: 教程：通过 ASP.NET MVC 中的实体框架实现 CRUD 功能 |Microsoft Docs
description: 查看并自定义 MVC 基架自动在控制器和视图中创建的创建、读取、更新、删除（CRUD）代码。
author: tdykstra
ms.author: riande
ms.date: 01/22/2019
ms.topic: tutorial
ms.assetid: a2f70ba4-83d1-4002-9255-24732726c4f2
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 9ed388543dd54d209ff2a0b92df4f7659962582c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471146"
---
# <a name="tutorial-implement-crud-functionality-with-the-entity-framework-in-aspnet-mvc"></a><span data-ttu-id="f89a5-103">教程：通过 ASP.NET MVC 中的实体框架实现 CRUD 功能</span><span class="sxs-lookup"><span data-stu-id="f89a5-103">Tutorial: Implement CRUD Functionality with the Entity Framework in ASP.NET MVC</span></span>

<span data-ttu-id="f89a5-104">在[上一教程](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)中，你创建了一个 MVC 应用程序，它使用实体框架（EF）6和 SQL Server LocalDB 来存储和显示数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-104">In the [previous tutorial](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md), you created an MVC application that stores and displays data using the Entity Framework (EF) 6 and SQL Server LocalDB.</span></span> <span data-ttu-id="f89a5-105">在本教程中，您将查看并自定义 MVC 基架在控制器和视图中为您自动创建的创建、读取、更新、删除（CRUD）代码。</span><span class="sxs-lookup"><span data-stu-id="f89a5-105">In this tutorial, you review and customize the create, read, update, delete (CRUD) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="f89a5-106">为了在控制器和数据访问层之间创建一个抽象层，常见的做法是实现存储库模式。</span><span class="sxs-lookup"><span data-stu-id="f89a5-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="f89a5-107">为了使这些教程更简单，重点介绍如何使用 EF 6 本身，它们不使用存储库。</span><span class="sxs-lookup"><span data-stu-id="f89a5-107">To keep these tutorials simple and focused on teaching how to use EF 6 itself, they don't use repositories.</span></span> <span data-ttu-id="f89a5-108">有关如何实现存储库的信息，请参阅[ASP.NET 数据访问内容映射](../../../../whitepapers/aspnet-data-access-content-map.md)。</span><span class="sxs-lookup"><span data-stu-id="f89a5-108">For info about how to implement repositories, see the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

<span data-ttu-id="f89a5-109">下面是你创建的网页的示例：</span><span class="sxs-lookup"><span data-stu-id="f89a5-109">Here are examples of the web pages you create:</span></span>

![学生详细信息页的屏幕截图。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image1.png)

![学生 "创建" 页的屏幕截图。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image2.png)

![学生删除页的屏幕截图。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image3.png)

<span data-ttu-id="f89a5-113">在本教程中，你将了解：</span><span class="sxs-lookup"><span data-stu-id="f89a5-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="f89a5-114">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="f89a5-114">Create a Details page</span></span>
> * <span data-ttu-id="f89a5-115">更新“创建”页</span><span class="sxs-lookup"><span data-stu-id="f89a5-115">Update the Create page</span></span>
> * <span data-ttu-id="f89a5-116">更新 HttpPost Edit 方法</span><span class="sxs-lookup"><span data-stu-id="f89a5-116">Update the HttpPost Edit method</span></span>
> * <span data-ttu-id="f89a5-117">更新“删除”页</span><span class="sxs-lookup"><span data-stu-id="f89a5-117">Update the Delete page</span></span>
> * <span data-ttu-id="f89a5-118">关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="f89a5-118">Close database connections</span></span>
> * <span data-ttu-id="f89a5-119">处理事务</span><span class="sxs-lookup"><span data-stu-id="f89a5-119">Handle transactions</span></span>

## <a name="prerequisites"></a><span data-ttu-id="f89a5-120">系统必备</span><span class="sxs-lookup"><span data-stu-id="f89a5-120">Prerequisites</span></span>

* [<span data-ttu-id="f89a5-121">创建实体框架数据模型</span><span class="sxs-lookup"><span data-stu-id="f89a5-121">Create the Entity Framework Data Model</span></span>](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)

## <a name="create-a-details-page"></a><span data-ttu-id="f89a5-122">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="f89a5-122">Create a Details page</span></span>

<span data-ttu-id="f89a5-123">学生 `Index` 的 "基架" 代码页遗留了 `Enrollments` 属性，因为该属性包含一个集合。</span><span class="sxs-lookup"><span data-stu-id="f89a5-123">The scaffolded code for the Students `Index` page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="f89a5-124">在 "`Details`" 页中，将在 HTML 表中显示集合的内容。</span><span class="sxs-lookup"><span data-stu-id="f89a5-124">In the `Details` page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="f89a5-125">在*Controllers\StudentController.cs*中，`Details` 视图的操作方法使用[Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx)方法检索单个 `Student` 实体。</span><span class="sxs-lookup"><span data-stu-id="f89a5-125">In *Controllers\StudentController.cs*, the action method for the `Details` view uses the [Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx) method to retrieve a single `Student` entity.</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="f89a5-126">键值作为 `id` 参数传递给方法，并来自索引页上**详细信息**超链接中的*路由数据*。</span><span class="sxs-lookup"><span data-stu-id="f89a5-126">The key value is passed to the method as the `id` parameter and comes from *route data* in the **Details** hyperlink on the Index page.</span></span>

### <a name="tip-route-data"></a><span data-ttu-id="f89a5-127">提示：**路由数据**</span><span class="sxs-lookup"><span data-stu-id="f89a5-127">Tip: **Route data**</span></span>

<span data-ttu-id="f89a5-128">路由数据是模型绑定器在路由表中指定的 URL 段中找到的数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-128">Route data is data that the model binder found in a URL segment specified in the routing table.</span></span> <span data-ttu-id="f89a5-129">例如，默认路由指定 `controller`、`action`和 `id` 段：</span><span class="sxs-lookup"><span data-stu-id="f89a5-129">For example, the default route specifies `controller`, `action`, and `id` segments:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample2.cs?highlight=3)]

<span data-ttu-id="f89a5-130">在下面的 URL 中，默认路由映射 `Instructor` 作为 `controller`，`Index` 作为 `action`，1作为 `id`;这些是路由数据值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-130">In the following URL, the default route maps `Instructor` as the `controller`, `Index` as the `action` and 1 as the `id`; these are route data values.</span></span>

`http://localhost:1230/Instructor/Index/1?courseID=2021`

<span data-ttu-id="f89a5-131">`?courseID=2021` 是一个查询字符串值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-131">`?courseID=2021` is a query string value.</span></span> <span data-ttu-id="f89a5-132">如果将 `id` 作为查询字符串值传递，则模型绑定器也起作用：</span><span class="sxs-lookup"><span data-stu-id="f89a5-132">The model binder will also work if you pass the `id` as a query string value:</span></span>

`http://localhost:1230/Instructor/Index?id=1&CourseID=2021`

<span data-ttu-id="f89a5-133">Url 是通过 Razor 视图中 `ActionLink` 语句创建的。</span><span class="sxs-lookup"><span data-stu-id="f89a5-133">The URLs are created by `ActionLink` statements in the Razor view.</span></span> <span data-ttu-id="f89a5-134">在下面的代码中，`id` 参数与默认路由匹配，因此 `id` 添加到路由数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-134">In the following code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample3.cshtml)]

<span data-ttu-id="f89a5-135">在下面的代码中，`courseID` 与默认路由中的参数不匹配，因此将其添加为查询字符串。</span><span class="sxs-lookup"><span data-stu-id="f89a5-135">In the following code, `courseID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample4.cshtml)]

### <a name="to-create-the-details-page"></a><span data-ttu-id="f89a5-136">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="f89a5-136">To create the Details page</span></span>

1. <span data-ttu-id="f89a5-137">打开*Views\Student\Details.cshtml*。</span><span class="sxs-lookup"><span data-stu-id="f89a5-137">Open *Views\Student\Details.cshtml*.</span></span>

   <span data-ttu-id="f89a5-138">每个字段都使用 `DisplayFor` 帮助器来显示，如以下示例中所示：</span><span class="sxs-lookup"><span data-stu-id="f89a5-138">Each field is displayed using a `DisplayFor` helper, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample5.cshtml)]

2. <span data-ttu-id="f89a5-139">在 "`EnrollmentDate`" 字段之后，在 "结束 `</dl>` 标记之前，添加突出显示的代码以显示注册列表，如以下示例中所示：</span><span class="sxs-lookup"><span data-stu-id="f89a5-139">After the `EnrollmentDate` field and immediately before the closing `</dl>` tag, add the highlighted code to display a list of enrollments, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample6.cshtml?highlight=8-29)]

    <span data-ttu-id="f89a5-140">如果代码缩进在粘贴代码后出现错误，请按**ctrl**+**K**， **ctrl**+**D**对其进行格式化。</span><span class="sxs-lookup"><span data-stu-id="f89a5-140">If code indentation is wrong after you paste the code, press **Ctrl**+**K**, **Ctrl**+**D** to format it.</span></span>

    <span data-ttu-id="f89a5-141">此代码循环通过 `Enrollments` 导航属性中的实体。</span><span class="sxs-lookup"><span data-stu-id="f89a5-141">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="f89a5-142">对于属性中的每个 `Enrollment` 实体，它显示课程标题和分数。</span><span class="sxs-lookup"><span data-stu-id="f89a5-142">For each `Enrollment` entity in the property, it displays the course title and the grade.</span></span> <span data-ttu-id="f89a5-143">课程标题将从存储在 `Enrollments` 实体的 `Course` 导航属性中的 `Course` 实体中进行检索。</span><span class="sxs-lookup"><span data-stu-id="f89a5-143">The course title is retrieved from the `Course` entity that's stored in the `Course` navigation property of the `Enrollments` entity.</span></span> <span data-ttu-id="f89a5-144">在需要时，将自动从数据库中检索所有数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-144">All of this data is retrieved from the database automatically when it's needed.</span></span> <span data-ttu-id="f89a5-145">换句话说，你在此处使用延迟加载。</span><span class="sxs-lookup"><span data-stu-id="f89a5-145">In other words, you are using lazy loading here.</span></span> <span data-ttu-id="f89a5-146">你没有为 `Courses` 导航属性指定*预先加载*，因此无法在获得学生的同一查询中检索注册。</span><span class="sxs-lookup"><span data-stu-id="f89a5-146">You did not specify *eager loading* for the `Courses` navigation property, so the enrollments were not retrieved in the same query that got the students.</span></span> <span data-ttu-id="f89a5-147">相反，第一次尝试访问 `Enrollments` 导航属性时，会将新查询发送到数据库以检索数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-147">Instead, the first time you try to access the `Enrollments` navigation property, a new query is sent to the database to retrieve the data.</span></span> <span data-ttu-id="f89a5-148">可以在本系列后面的[读取相关数据](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)教程中详细了解延迟加载和预先加载。</span><span class="sxs-lookup"><span data-stu-id="f89a5-148">You can read more about lazy loading and eager loading in the [Reading Related Data](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial later in this series.</span></span>

3. <span data-ttu-id="f89a5-149">通过启动程序（**Ctrl**+**F5**），选择 "**学生**" 选项卡，然后单击 "Alexander Carson" 的 "**详细信息**" 链接，打开 "详细信息" 页。</span><span class="sxs-lookup"><span data-stu-id="f89a5-149">Open the Details page by starting the program (**Ctrl**+**F5**), selecting the **Students** tab, and then clicking the **Details** link for Alexander Carson.</span></span> <span data-ttu-id="f89a5-150">（如果在*详细信息 cshtml*文件处于打开状态时按**Ctrl**+**F5** ，则会收到 HTTP 400 错误。</span><span class="sxs-lookup"><span data-stu-id="f89a5-150">(If you press **Ctrl**+**F5** while the *Details.cshtml* file is open, you get an HTTP 400 error.</span></span> <span data-ttu-id="f89a5-151">这是因为 Visual Studio 将尝试运行详细信息页，但它不是从指定要显示的学生的链接访问的。</span><span class="sxs-lookup"><span data-stu-id="f89a5-151">This is because Visual Studio tries to run the Details page, but it wasn't reached from a link that specifies the student to display.</span></span> <span data-ttu-id="f89a5-152">如果发生这种情况，请从 URL 中删除 "学生/详细信息" 并重试，或关闭浏览器，右键单击项目，然后单击 "查看**浏览器中**的 > 视图"。）</span><span class="sxs-lookup"><span data-stu-id="f89a5-152">If that happens, remove "Student/Details" from the URL and try again, or, close the browser, right-click the project, and click **View** > **View in Browser**.)</span></span>

    <span data-ttu-id="f89a5-153">你将看到所选学生的课程和成绩列表。</span><span class="sxs-lookup"><span data-stu-id="f89a5-153">You see the list of courses and grades for the selected student.</span></span>

4. <span data-ttu-id="f89a5-154">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="f89a5-154">Close the browser.</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="f89a5-155">更新“创建”页</span><span class="sxs-lookup"><span data-stu-id="f89a5-155">Update the Create page</span></span>

1. <span data-ttu-id="f89a5-156">在*Controllers\StudentController.cs*中，将 <xref:System.Web.Mvc.HttpPostAttribute> `Create` 操作方法替换为以下代码。</span><span class="sxs-lookup"><span data-stu-id="f89a5-156">In *Controllers\StudentController.cs*, replace the <xref:System.Web.Mvc.HttpPostAttribute> `Create` action method with the following code.</span></span> <span data-ttu-id="f89a5-157">此代码将添加一个 `try-catch` 块，并从基架方法的 <xref:System.Web.Mvc.BindAttribute> 属性中删除 `ID`：</span><span class="sxs-lookup"><span data-stu-id="f89a5-157">This code adds a `try-catch` block and removes `ID` from the <xref:System.Web.Mvc.BindAttribute> attribute for the scaffolded method:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample7.cs?highlight=3,5-6,13-18)]

    <span data-ttu-id="f89a5-158">此代码会将 ASP.NET MVC 模型联编程序创建的 `Student` 实体添加到 `Students` 实体集，然后将更改保存到数据库。</span><span class="sxs-lookup"><span data-stu-id="f89a5-158">This code adds the `Student` entity created by the ASP.NET MVC model binder to the `Students` entity set and then saves the changes to the database.</span></span> <span data-ttu-id="f89a5-159">*模型联编*程序是指使你可以更轻松地使用窗体提交的数据的 ASP.NET MVC 功能;模型联编程序将已发布的窗体值转换为 CLR 类型，并将其传递给参数中的操作方法。</span><span class="sxs-lookup"><span data-stu-id="f89a5-159">*Model binder* refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="f89a5-160">在这种情况下，模型联编程序会使用 `Form` 集合中的属性值实例化 `Student` 实体。</span><span class="sxs-lookup"><span data-stu-id="f89a5-160">In this case, the model binder instantiates a `Student` entity for you using property values from the `Form` collection.</span></span>

    <span data-ttu-id="f89a5-161">您从 Bind 属性中删除了 `ID`，因为 `ID` 是在插入行时 SQL Server 将自动设置的主键值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-161">You removed `ID` from the Bind attribute because `ID` is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="f89a5-162">用户的输入未设置 `ID` 值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-162">Input from the user does not set the `ID` value.</span></span>

    <a id="overpost"></a>

    ### <a name="security-warning---the-validateantiforgerytoken-attribute-helps-prevent-cross-site-request-forgery-attacks-it-requires-a-corresponding-htmlantiforgerytoken-statement-in-the-view-which-youll-see-later"></a><span data-ttu-id="f89a5-163">安全警告-`ValidateAntiForgeryToken` 特性有助于防止[跨站点请求伪造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻击。</span><span class="sxs-lookup"><span data-stu-id="f89a5-163">Security warning - The `ValidateAntiForgeryToken` attribute helps prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span> <span data-ttu-id="f89a5-164">它需要视图中相应的 `Html.AntiForgeryToken()` 语句，稍后会看到。</span><span class="sxs-lookup"><span data-stu-id="f89a5-164">It requires a corresponding `Html.AntiForgeryToken()` statement in the view, which you'll see later.</span></span>

    <span data-ttu-id="f89a5-165">`Bind` 特性是防止在创建方案中*过度发布*的一种方法。</span><span class="sxs-lookup"><span data-stu-id="f89a5-165">The `Bind` attribute is one way to protect against *over-posting* in create scenarios.</span></span> <span data-ttu-id="f89a5-166">例如，假设 `Student` 实体包含不希望此网页设置的 `Secret` 属性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-166">For example, suppose the `Student` entity includes a `Secret` property that you don't want this web page to set.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample8.cs?highlight=7)]

    <span data-ttu-id="f89a5-167">即使网页上没有 `Secret` 字段，黑客也可以使用[fiddler](http://fiddler2.com/home)之类的工具或编写一些 JavaScript 来发布 `Secret` 窗体值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-167">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as [fiddler](http://fiddler2.com/home), or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="f89a5-168">如果没有 <xref:System.Web.Mvc.BindAttribute> 特性限制模型绑定器在创建 `Student` 实例时使用的字段<em>，</em>则模型绑定器将选取该 `Secret` 窗体值，并使用它来创建 `Student` 实体实例。</span><span class="sxs-lookup"><span data-stu-id="f89a5-168">Without the <xref:System.Web.Mvc.BindAttribute> attribute limiting the fields that the model binder uses when it creates a `Student` instance<em>,</em> the model binder would pick up that `Secret` form value and use it to create the `Student` entity instance.</span></span> <span data-ttu-id="f89a5-169">然后将在数据库中更新黑客为 `Secret` 表单字段指定的任意值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-169">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="f89a5-170">下图显示了 fiddler 工具，将 `Secret` 字段（值为 "OverPost"）添加到已发布的窗体值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-170">The following image shows the fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

    ![](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image5.png)

    <span data-ttu-id="f89a5-171">然后值“OverPost”将成功添加到插入行的 `Secret` 属性，尽管你从未打算网页可设置该属性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-171">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

    <span data-ttu-id="f89a5-172">最好是使用`Include`参数与`Bind`归于*允许列表*字段</span><span class="sxs-lookup"><span data-stu-id="f89a5-172">It's best to use the `Include` parameter with the `Bind` attribute to *whitelist* fields.</span></span> <span data-ttu-id="f89a5-173">还有可能要使用`Exclude`参数*阻止列表*你想要排除的字段。</span><span class="sxs-lookup"><span data-stu-id="f89a5-173">It's also possible to use the `Exclude` parameter to *blacklist* fields you want to exclude.</span></span> <span data-ttu-id="f89a5-174">`Include` 更为安全的原因是：向实体添加新属性时，新字段不会由 `Exclude` 列表自动保护。</span><span class="sxs-lookup"><span data-stu-id="f89a5-174">The reason `Include` is more secure is that when you add a new property to the entity, the new field is not automatically protected by an `Exclude` list.</span></span>

    <span data-ttu-id="f89a5-175">在编辑方案中，可以防止过多发布从数据库中首先读取实体，然后调用 `TryUpdateModel`，并传入显式允许的属性列表。</span><span class="sxs-lookup"><span data-stu-id="f89a5-175">You can prevent overposting in edit scenarios is by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="f89a5-176">这是在这些教程中使用的方法。</span><span class="sxs-lookup"><span data-stu-id="f89a5-176">That is the method used in these tutorials.</span></span>

    <span data-ttu-id="f89a5-177">阻止许多开发人员首选的过多发布的另一种方法是使用视图模型，而不是使用模型绑定的实体类。</span><span class="sxs-lookup"><span data-stu-id="f89a5-177">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="f89a5-178">仅包含想要在视图模型中更新的属性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="f89a5-179">MVC 模型联编程序完成后，可以选择使用[AutoMapper](http://automapper.org/)等工具将视图模型属性复制到实体实例。</span><span class="sxs-lookup"><span data-stu-id="f89a5-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as [AutoMapper](http://automapper.org/).</span></span> <span data-ttu-id="f89a5-180">使用 db。条目，以将其状态设置为 "未更改"，然后设置 "属性" （"属性名称"）。视图模型中包含的每个实体属性上的 IsModified 为 true。</span><span class="sxs-lookup"><span data-stu-id="f89a5-180">Use db.Entry on the entity instance to set its state to Unchanged, and then set Property("PropertyName").IsModified to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="f89a5-181">此方法同时适用于编辑和创建方案。</span><span class="sxs-lookup"><span data-stu-id="f89a5-181">This method works in both edit and create scenarios.</span></span>

    <span data-ttu-id="f89a5-182">除了 `Bind` 属性，`try-catch` 块是对基架代码的唯一更改。</span><span class="sxs-lookup"><span data-stu-id="f89a5-182">Other than the `Bind` attribute, the `try-catch` block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="f89a5-183">如果保存更改时捕获到来自 <xref:System.Data.DataException> 的异常，则会显示一般错误消息。</span><span class="sxs-lookup"><span data-stu-id="f89a5-183">If an exception that derives from <xref:System.Data.DataException> is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="f89a5-184">有时 <xref:System.Data.DataException> 异常是由应用程序外部的某些内容而非编程错误引起的，因此建议用户再次尝试。</span><span class="sxs-lookup"><span data-stu-id="f89a5-184"><xref:System.Data.DataException> exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="f89a5-185">尽管在本示例中未实现，但生产质量应用程序会记录异常。</span><span class="sxs-lookup"><span data-stu-id="f89a5-185">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="f89a5-186">有关详细信息，请参阅[监视和遥测（使用 Azure 构建真实世界云应用）](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log)中的“见解记录”部分。</span><span class="sxs-lookup"><span data-stu-id="f89a5-186">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log).</span></span>

    <span data-ttu-id="f89a5-187">*Views\Student\Create.cshtml*中的代码与在*详细信息*中看到的代码类似，不同之处在于 `EditorFor` 和 `ValidationMessageFor` 帮助程序用于每个字段，而不是 `DisplayFor`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-187">The code in *Views\Student\Create.cshtml* is similar to what you saw in *Details.cshtml*, except that `EditorFor` and `ValidationMessageFor` helpers are used for each field instead of `DisplayFor`.</span></span> <span data-ttu-id="f89a5-188">相关代码如下：</span><span class="sxs-lookup"><span data-stu-id="f89a5-188">Here is the relevant code:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample9.cshtml)]

    <span data-ttu-id="f89a5-189">*Create. cshtml*还包括 `@Html.AntiForgeryToken()`，该属性与控制器中的 `ValidateAntiForgeryToken` 属性结合使用，以帮助防止[跨站点请求伪造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻击。</span><span class="sxs-lookup"><span data-stu-id="f89a5-189">*Create.cshtml* also includes `@Html.AntiForgeryToken()`, which works with the `ValidateAntiForgeryToken` attribute in the controller to help prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span>

    <span data-ttu-id="f89a5-190">*Create cshtml*中不需要进行任何更改。</span><span class="sxs-lookup"><span data-stu-id="f89a5-190">No changes are required in *Create.cshtml*.</span></span>

2. <span data-ttu-id="f89a5-191">通过启动该程序，选择 "**学生**" 选项卡，然后单击 "**新建**"，运行此页。</span><span class="sxs-lookup"><span data-stu-id="f89a5-191">Run the page by starting the program, selecting the **Students** tab, and then clicking **Create New**.</span></span>

3. <span data-ttu-id="f89a5-192">输入名称和无效日期，并单击 "**创建**" 以查看错误消息。</span><span class="sxs-lookup"><span data-stu-id="f89a5-192">Enter names and an invalid date and click **Create** to see the error message.</span></span>

    <span data-ttu-id="f89a5-193">这是默认情况下获取的服务器端验证。</span><span class="sxs-lookup"><span data-stu-id="f89a5-193">This is server-side validation that you get by default.</span></span> <span data-ttu-id="f89a5-194">在后面的教程中，你将了解如何添加为客户端验证生成代码的属性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-194">In a later tutorial, you'll see how to add attributes that generate code for client-side validation.</span></span> <span data-ttu-id="f89a5-195">以下突出显示的代码显示了**Create**方法中的模型验证检查。</span><span class="sxs-lookup"><span data-stu-id="f89a5-195">The following highlighted code shows the model validation check in the **Create** method.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample10.cs?highlight=1)]

4. <span data-ttu-id="f89a5-196">将日期更改为有效的值并单击 **Create**，查看在 **Index** 页上显示的新学生。</span><span class="sxs-lookup"><span data-stu-id="f89a5-196">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

5. <span data-ttu-id="f89a5-197">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="f89a5-197">Close the browser.</span></span>

## <a name="update-httppost-edit-method"></a><span data-ttu-id="f89a5-198">Update HttpPost Edit 方法</span><span class="sxs-lookup"><span data-stu-id="f89a5-198">Update HttpPost Edit method</span></span>

1. <span data-ttu-id="f89a5-199">将 <xref:System.Web.Mvc.HttpPostAttribute> `Edit` 操作方法替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="f89a5-199">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Edit` action method with the following code:</span></span>

   [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample11.cs)]

   > [!NOTE]
   > <span data-ttu-id="f89a5-200">在*Controllers\StudentController.cs*中，`HttpGet Edit` 方法（没有 `HttpPost` 特性的方法）使用 `Find` 方法来检索所选 `Student` 实体，如在 `Details` 方法中看到的那样。</span><span class="sxs-lookup"><span data-stu-id="f89a5-200">In *Controllers\StudentController.cs*, the `HttpGet Edit` method (the one without the `HttpPost` attribute) uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="f89a5-201">不需要更改此方法。</span><span class="sxs-lookup"><span data-stu-id="f89a5-201">You don't need to change this method.</span></span>

   <span data-ttu-id="f89a5-202">这些更改实现了一种安全最佳做法来防止[过多发布](#overpost)，scaffolder 生成了 `Bind` 属性，并将模型联编程序创建的实体添加到了带有修改标志的实体集。</span><span class="sxs-lookup"><span data-stu-id="f89a5-202">These changes implement a security best practice to prevent [overposting](#overpost), The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a Modified flag.</span></span> <span data-ttu-id="f89a5-203">不再建议使用该代码，因为 `Bind` 特性会清除未列在 `Include` 参数中的字段中的任何预先存在的数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-203">That code is no longer recommended because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span> <span data-ttu-id="f89a5-204">将来，将更新 MVC 控制器 scaffolder，以使其不会为编辑方法生成 `Bind` 特性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-204">In the future, the MVC controller scaffolder will be updated so that it doesn't generate `Bind` attributes for Edit methods.</span></span>

   <span data-ttu-id="f89a5-205">新代码读取现有实体，并调用 <xref:System.Web.Mvc.Controller.TryUpdateModel%2A> 从已发布表单数据中的用户输入更新字段。</span><span class="sxs-lookup"><span data-stu-id="f89a5-205">The new code reads the existing entity and calls <xref:System.Web.Mvc.Controller.TryUpdateModel%2A> to update fields from user input in the posted form data.</span></span> <span data-ttu-id="f89a5-206">实体框架的自动更改跟踪设置实体上的[EntityState](<xref:System.Data.EntityState.Modified>)标志。</span><span class="sxs-lookup"><span data-stu-id="f89a5-206">The Entity Framework's automatic change tracking sets the [EntityState.Modified](<xref:System.Data.EntityState.Modified>) flag on the entity.</span></span> <span data-ttu-id="f89a5-207">调用[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法时，<xref:System.Data.EntityState.Modified> 标志将导致实体框架创建 SQL 语句以更新数据库行。</span><span class="sxs-lookup"><span data-stu-id="f89a5-207">When the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method is called, the <xref:System.Data.EntityState.Modified> flag causes the Entity Framework to create SQL statements to update the database row.</span></span> <span data-ttu-id="f89a5-208">将忽略[并发冲突](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)，并更新数据库行的所有列，包括用户未更改的列。</span><span class="sxs-lookup"><span data-stu-id="f89a5-208">[Concurrency conflicts](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) are ignored, and all columns of the database row are updated, including those that the user didn't change.</span></span> <span data-ttu-id="f89a5-209">（后面的教程演示如何处理并发冲突，如果您只想在数据库中更新单个字段，则可以将实体设置为[EntityState](<xref:System.Data.EntityState.Unchanged>) ，并将各字段设置为[EntityState](<xref:System.Data.EntityState.Modified>)。）</span><span class="sxs-lookup"><span data-stu-id="f89a5-209">(A later tutorial shows how to handle concurrency conflicts, and if you only want individual fields to be updated in the database, you can set the entity to [EntityState.Unchanged](<xref:System.Data.EntityState.Unchanged>) and set individual fields to [EntityState.Modified](<xref:System.Data.EntityState.Modified>).)</span></span>

   <span data-ttu-id="f89a5-210">若要防止过多发布，"编辑" 页要更新的字段在 `TryUpdateModel` 参数中列入白名单。</span><span class="sxs-lookup"><span data-stu-id="f89a5-210">To prevent overposting, the fields that you want to be updateable by the Edit page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="f89a5-211">目前没有要保护的额外字段，但是列出希望模型绑定器绑定的字段可确保以后将字段添加到数据模型时，它们将自动受到保护，直到明确将其添加到此处为止。</span><span class="sxs-lookup"><span data-stu-id="f89a5-211">Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

   <span data-ttu-id="f89a5-212">由于这些更改，HttpPost Edit 方法的方法签名与 HttpGet edit 方法相同;因此，已将方法重命名为 EditPost。</span><span class="sxs-lookup"><span data-stu-id="f89a5-212">As a result of these changes, the method signature of the HttpPost Edit method is the same as the HttpGet edit method; therefore you've renamed the method EditPost.</span></span>

   > [!TIP]
   >
   > <span data-ttu-id="f89a5-213">**实体状态和附加方法和 SaveChanges 方法**</span><span class="sxs-lookup"><span data-stu-id="f89a5-213">**Entity States and the Attach and SaveChanges Methods**</span></span>
   >
   > <span data-ttu-id="f89a5-214">数据库上下文跟踪内存中的实体是否与数据库中相应的行同步，并且此信息确定调用 `SaveChanges` 方法时会发生的情况。</span><span class="sxs-lookup"><span data-stu-id="f89a5-214">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="f89a5-215">例如，将新实体传递到[Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx)方法时，该实体的状态将设置为 `Added`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-215">For example, when you pass a new entity to the [Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx) method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="f89a5-216">然后，当调用[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法时，数据库上下文会发出一个 SQL `INSERT` 命令。</span><span class="sxs-lookup"><span data-stu-id="f89a5-216">Then when you call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method, the database context issues a SQL `INSERT` command.</span></span>
   >
   > <span data-ttu-id="f89a5-217">实体可能处于以下[状态](xref:System.Data.EntityState)之一：</span><span class="sxs-lookup"><span data-stu-id="f89a5-217">An entity may be in one of the following [states](xref:System.Data.EntityState):</span></span>
   >
   > - <span data-ttu-id="f89a5-218">`Added`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-218">`Added`.</span></span> <span data-ttu-id="f89a5-219">数据库中尚不存在实体。</span><span class="sxs-lookup"><span data-stu-id="f89a5-219">The entity does not yet exist in the database.</span></span> <span data-ttu-id="f89a5-220">`SaveChanges` 方法必须发出 `INSERT` 语句。</span><span class="sxs-lookup"><span data-stu-id="f89a5-220">The `SaveChanges` method must issue an `INSERT` statement.</span></span>
   > - <span data-ttu-id="f89a5-221">`Unchanged`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-221">`Unchanged`.</span></span> <span data-ttu-id="f89a5-222">不需要通过 `SaveChanges` 方法对此实体执行操作。</span><span class="sxs-lookup"><span data-stu-id="f89a5-222">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="f89a5-223">从数据库读取实体时，实体将从此状态开始。</span><span class="sxs-lookup"><span data-stu-id="f89a5-223">When you read an entity from the database, the entity starts out with this status.</span></span>
   > - <span data-ttu-id="f89a5-224">`Modified`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-224">`Modified`.</span></span> <span data-ttu-id="f89a5-225">已修改实体的部分或全部属性值。</span><span class="sxs-lookup"><span data-stu-id="f89a5-225">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="f89a5-226">`SaveChanges` 方法必须发出 `UPDATE` 语句。</span><span class="sxs-lookup"><span data-stu-id="f89a5-226">The `SaveChanges` method must issue an `UPDATE` statement.</span></span>
   > - <span data-ttu-id="f89a5-227">`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-227">`Deleted`.</span></span> <span data-ttu-id="f89a5-228">已标记该实体进行删除。</span><span class="sxs-lookup"><span data-stu-id="f89a5-228">The entity has been marked for deletion.</span></span> <span data-ttu-id="f89a5-229">`SaveChanges` 方法必须发出 `DELETE` 语句。</span><span class="sxs-lookup"><span data-stu-id="f89a5-229">The `SaveChanges` method must issue a `DELETE` statement.</span></span>
   > - <span data-ttu-id="f89a5-230">`Detached`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-230">`Detached`.</span></span> <span data-ttu-id="f89a5-231">数据库上下文未跟踪该实体。</span><span class="sxs-lookup"><span data-stu-id="f89a5-231">The entity isn't being tracked by the database context.</span></span>
   >
   > <span data-ttu-id="f89a5-232">在桌面应用程序中，通常会自动设置状态更改。</span><span class="sxs-lookup"><span data-stu-id="f89a5-232">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="f89a5-233">在桌面类型的应用程序中，您可以读取实体并对其某些属性值进行更改。</span><span class="sxs-lookup"><span data-stu-id="f89a5-233">In a desktop type of application, you read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="f89a5-234">这将使其实体状态自动更改为 `Modified`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-234">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="f89a5-235">然后，在调用 `SaveChanges`时，实体框架将生成一个 SQL `UPDATE` 语句，该语句只更新您更改的实际属性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-235">Then when you call `SaveChanges`, the Entity Framework generates a SQL `UPDATE` statement that updates only the actual properties that you changed.</span></span>
   >
   > <span data-ttu-id="f89a5-236">Web 应用的断开连接特性不允许此连续序列。</span><span class="sxs-lookup"><span data-stu-id="f89a5-236">The disconnected nature of web apps doesn't allow for this continuous sequence.</span></span> <span data-ttu-id="f89a5-237">在呈现页面后，将释放读取实体的[DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) 。</span><span class="sxs-lookup"><span data-stu-id="f89a5-237">The [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) that reads an entity is disposed after a page is rendered.</span></span> <span data-ttu-id="f89a5-238">调用 `HttpPost` `Edit` 操作方法时，将发出新的请求，并且你具有[DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx)的新实例，因此你必须手动将实体状态设置为 `Modified.` 然后在调用 `SaveChanges`时，实体框架将更新数据库行的所有列，因为上下文无法知道你更改了哪些属性。</span><span class="sxs-lookup"><span data-stu-id="f89a5-238">When the `HttpPost` `Edit` action method is called, a new request is made and you have a new instance of the [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx), so you have to manually set the entity state to `Modified.` Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>
   >
   > <span data-ttu-id="f89a5-239">如果你希望 SQL `Update` 语句仅更新用户实际更改的字段，则可以通过某种方式（例如隐藏字段）保存原始值，以便在调用 `HttpPost` `Edit` 方法时可用。</span><span class="sxs-lookup"><span data-stu-id="f89a5-239">If you want the SQL `Update` statement to update only the fields that the user actually changed, you can save the original values in some way (such as hidden fields) so that they are available when the `HttpPost` `Edit` method is called.</span></span> <span data-ttu-id="f89a5-240">然后，你可以使用原始值创建一个 `Student` 实体，使用该实体的原始版本调用 `Attach` 方法，将该实体的值更新为新值，然后调用 `SaveChanges.` 有关详细信息，请参阅[实体状态和 SaveChanges](/ef/ef6/saving/change-tracking/entity-state)和[本地数据](/ef/ef6/querying/local-data)。</span><span class="sxs-lookup"><span data-stu-id="f89a5-240">Then you can create a `Student` entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges.` For more information, see [Entity states and SaveChanges](/ef/ef6/saving/change-tracking/entity-state) and [Local Data](/ef/ef6/querying/local-data).</span></span>

   <span data-ttu-id="f89a5-241">*Views\Student\Edit.cshtml*中的 HTML 和 Razor 代码与你在*Create. cshtml*中看到的代码相似，无需进行任何更改。</span><span class="sxs-lookup"><span data-stu-id="f89a5-241">The HTML and Razor code in *Views\Student\Edit.cshtml* is similar to what you saw in *Create.cshtml*, and no changes are required.</span></span>

2. <span data-ttu-id="f89a5-242">通过启动该程序，选择 "**学生**" 选项卡，然后单击**编辑**超链接来运行该页面。</span><span class="sxs-lookup"><span data-stu-id="f89a5-242">Run the page by starting the program, selecting the **Students** tab, and then clicking an **Edit** hyperlink.</span></span>

3. <span data-ttu-id="f89a5-243">更改某些数据并单击“保存”。</span><span class="sxs-lookup"><span data-stu-id="f89a5-243">Change some of the data and click **Save**.</span></span> <span data-ttu-id="f89a5-244">你将在 "索引" 页中看到已更改的数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-244">You see the changed data in the Index page.</span></span>

4. <span data-ttu-id="f89a5-245">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="f89a5-245">Close the browser.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="f89a5-246">更新“删除”页</span><span class="sxs-lookup"><span data-stu-id="f89a5-246">Update the Delete page</span></span>

<span data-ttu-id="f89a5-247">在*Controllers\StudentController.cs*中，<xref:System.Web.Mvc.HttpGetAttribute> `Delete` 方法的模板代码使用 `Find` 方法来检索所选 `Student` 实体，如在 `Details` 和 `Edit` 方法中看到的那样。</span><span class="sxs-lookup"><span data-stu-id="f89a5-247">In *Controllers\StudentController.cs*, the template code for the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` and `Edit` methods.</span></span> <span data-ttu-id="f89a5-248">但是，若要在调用 `SaveChanges` 失败时实现自定义错误消息，请将部分功能添加到此方法及其相应的视图中。</span><span class="sxs-lookup"><span data-stu-id="f89a5-248">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="f89a5-249">正如所看到的更新和创建操作，删除操作需要两个操作方法。</span><span class="sxs-lookup"><span data-stu-id="f89a5-249">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="f89a5-250">为响应 GET 请求而调用的方法会显示一个视图，该视图使用户有机会批准或取消删除操作。</span><span class="sxs-lookup"><span data-stu-id="f89a5-250">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="f89a5-251">如果用户批准，则创建 POST 请求。</span><span class="sxs-lookup"><span data-stu-id="f89a5-251">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="f89a5-252">发生这种情况时，将调用 `HttpPost` `Delete` 方法，然后该方法实际执行删除操作。</span><span class="sxs-lookup"><span data-stu-id="f89a5-252">When that happens, the `HttpPost` `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="f89a5-253">将 `try-catch` 块添加到 <xref:System.Web.Mvc.HttpPostAttribute> `Delete` 方法，以处理更新数据库时可能发生的任何错误。</span><span class="sxs-lookup"><span data-stu-id="f89a5-253">You'll add a `try-catch` block to the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="f89a5-254">如果发生错误，则 <xref:System.Web.Mvc.HttpPostAttribute> `Delete` 方法将调用 <xref:System.Web.Mvc.HttpGetAttribute> `Delete` 方法，并向其传递指示发生错误的参数。</span><span class="sxs-lookup"><span data-stu-id="f89a5-254">If an error occurs, the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method calls the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="f89a5-255">然后，<xref:System.Web.Mvc.HttpGetAttribute> `Delete` 方法将重新出现确认页面以及错误消息，使用户有机会取消或重试。</span><span class="sxs-lookup"><span data-stu-id="f89a5-255">The <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

1. <span data-ttu-id="f89a5-256">将 <xref:System.Web.Mvc.HttpGetAttribute> `Delete` 操作方法替换为以下代码，该代码可管理错误报告：</span><span class="sxs-lookup"><span data-stu-id="f89a5-256">Replace the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` action method with the following code, which manages error reporting:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample12.cs?highlight=1,7-10)]

    <span data-ttu-id="f89a5-257">此代码接受一个[可选参数](https://msdn.microsoft.com/library/dd264739.aspx)，该参数指示在保存更改失败后是否调用了方法。</span><span class="sxs-lookup"><span data-stu-id="f89a5-257">This code accepts an [optional parameter](https://msdn.microsoft.com/library/dd264739.aspx) that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="f89a5-258">如果在没有以前的失败的情况下调用 `HttpGet` `Delete` 方法，则 `false` 此参数。</span><span class="sxs-lookup"><span data-stu-id="f89a5-258">This parameter is `false` when the `HttpGet` `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="f89a5-259">当 `Delete` 方法 `HttpPost` 调用此方法以响应数据库更新错误时，该参数将 `true`，并向视图传递一条错误消息。</span><span class="sxs-lookup"><span data-stu-id="f89a5-259">When it is called by the `HttpPost` `Delete` method in response to a database update error, the parameter is `true` and an error message is passed to the view.</span></span>

2. <span data-ttu-id="f89a5-260">将 <xref:System.Web.Mvc.HttpPostAttribute> `Delete` 操作方法（名为 `DeleteConfirmed`）替换为以下代码，这将执行实际的 delete 操作并捕获任何数据库更新错误。</span><span class="sxs-lookup"><span data-stu-id="f89a5-260">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample13.cs)]

    <span data-ttu-id="f89a5-261">此代码检索所选的实体，然后调用[Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx)方法，将实体的状态设置为 `Deleted`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-261">This code retrieves the selected entity, then calls the [Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="f89a5-262">调用 `SaveChanges` 时，将生成 SQL `DELETE` 命令。</span><span class="sxs-lookup"><span data-stu-id="f89a5-262">When `SaveChanges` is called, a SQL `DELETE` command is generated.</span></span> <span data-ttu-id="f89a5-263">你还将操作方法名称从 `DeleteConfirmed` 更改为了 `Delete`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-263">You have also changed the action method name from `DeleteConfirmed` to `Delete`.</span></span> <span data-ttu-id="f89a5-264">`HttpPost` 的名为的基架代码 `Delete` 方法 `DeleteConfirmed` 为 `HttpPost` 方法指定唯一签名。</span><span class="sxs-lookup"><span data-stu-id="f89a5-264">The scaffolded code named the `HttpPost` `Delete` method `DeleteConfirmed` to give the `HttpPost` method a unique signature.</span></span> <span data-ttu-id="f89a5-265">（CLR 要求重载方法具有不同的方法参数。）签名是唯一的，可以坚持使用 MVC 约定，并为 `HttpPost` 和 `HttpGet` delete 方法使用相同的名称。</span><span class="sxs-lookup"><span data-stu-id="f89a5-265">(The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the `HttpPost` and `HttpGet` delete methods.</span></span>

    <span data-ttu-id="f89a5-266">如果提高大容量应用程序的性能是优先考虑的，则可以通过使用以下代码替换调用 `Find` 和 `Remove` 方法的代码行来避免不必要的 SQL 查询来检索行：</span><span class="sxs-lookup"><span data-stu-id="f89a5-266">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query to retrieve the row by replacing the lines of code that call the `Find` and `Remove` methods with the following code:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample14.cs)]

    <span data-ttu-id="f89a5-267">此代码仅使用主键值实例化一个 `Student` 实体，然后将实体状态设置为 `Deleted`。</span><span class="sxs-lookup"><span data-stu-id="f89a5-267">This code instantiates a `Student` entity using only the primary key value and then sets the entity state to `Deleted`.</span></span> <span data-ttu-id="f89a5-268">这是 Entity Framework 删除实体需要执行的所有操作。</span><span class="sxs-lookup"><span data-stu-id="f89a5-268">That's all that the Entity Framework needs in order to delete the entity.</span></span>

    <span data-ttu-id="f89a5-269">如上所述，`HttpGet` `Delete` 方法不会删除数据。</span><span class="sxs-lookup"><span data-stu-id="f89a5-269">As noted, the `HttpGet` `Delete` method doesn't delete the data.</span></span> <span data-ttu-id="f89a5-270">执行删除操作以响应 GET 请求（或者，执行任何编辑操作、创建操作或更改数据的任何其他操作）会产生安全风险。</span><span class="sxs-lookup"><span data-stu-id="f89a5-270">Performing a delete operation in response to a GET request (or for that matter, performing any edit operation, create operation, or any other operation that changes data) creates a security risk.</span></span> <span data-ttu-id="f89a5-271">有关详细信息，请参阅[ASP.NET MVC Tip #46 —不要使用 "删除链接"，因为它们](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx)在 Stephen Walther 的博客上创建安全漏洞。</span><span class="sxs-lookup"><span data-stu-id="f89a5-271">For more information, see [ASP.NET MVC Tip #46 — Don't use Delete Links because they create Security Holes](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx) on Stephen Walther's blog.</span></span>

3. <span data-ttu-id="f89a5-272">在*Views\Student\Delete.cshtml*中，在 `h2` 标题和 `h3` 标题之间添加一条错误消息，如以下示例中所示：</span><span class="sxs-lookup"><span data-stu-id="f89a5-272">In *Views\Student\Delete.cshtml*, add an error message between the `h2` heading and the `h3` heading, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample15.cshtml?highlight=2)]

4. <span data-ttu-id="f89a5-273">通过启动该程序，选择 "**学生**" 选项卡，然后单击 "**删除**" 超链接来运行该页面。</span><span class="sxs-lookup"><span data-stu-id="f89a5-273">Run the page by starting the program, selecting the **Students** tab, and then clicking a **Delete** hyperlink.</span></span>

5. <span data-ttu-id="f89a5-274">在指出**是否确实要删除此**内容的页面上选择 "**删除**"。</span><span class="sxs-lookup"><span data-stu-id="f89a5-274">Choose **Delete** on the page that says **Are you sure you want to delete this?**.</span></span>

    <span data-ttu-id="f89a5-275">将显示 "索引" 页，其中没有已删除的学生。</span><span class="sxs-lookup"><span data-stu-id="f89a5-275">The Index page displays without the deleted student.</span></span> <span data-ttu-id="f89a5-276">（在[并发教程](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)中，你将看到一个用于操作的错误处理代码示例。）</span><span class="sxs-lookup"><span data-stu-id="f89a5-276">(You'll see an example of the error handling code in action in the [concurrency tutorial](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md).)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="f89a5-277">关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="f89a5-277">Close database connections</span></span>

<span data-ttu-id="f89a5-278">若要关闭数据库连接并尽可能快地释放它们所占用的资源，请在完成后释放上下文实例。</span><span class="sxs-lookup"><span data-stu-id="f89a5-278">To close database connections and free up the resources they hold as soon as possible, dispose the context instance when you are done with it.</span></span> <span data-ttu-id="f89a5-279">这就是基架代码在*StudentController.cs*中 `StudentController` 类末尾提供[Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx)方法的原因，如以下示例中所示：</span><span class="sxs-lookup"><span data-stu-id="f89a5-279">That is why the scaffolded code provides a [Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx) method at the end of the `StudentController` class in *StudentController.cs*, as shown in the following example:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample16.cs)]

<span data-ttu-id="f89a5-280">基本 `Controller` 类已经实现了 `IDisposable` 接口，因此此代码只需将重写添加到 `Dispose(bool)` 方法以显式释放上下文实例。</span><span class="sxs-lookup"><span data-stu-id="f89a5-280">The base `Controller` class already implements the `IDisposable` interface, so this code simply adds an override to the `Dispose(bool)` method to explicitly dispose the context instance.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="f89a5-281">处理事务</span><span class="sxs-lookup"><span data-stu-id="f89a5-281">Handle transactions</span></span>

<span data-ttu-id="f89a5-282">默认情况下，Entity Framework 隐式实现事务。</span><span class="sxs-lookup"><span data-stu-id="f89a5-282">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="f89a5-283">如果对多个行或表进行了更改，然后调用 `SaveChanges`，实体框架将自动确保所有更改都成功或全部失败。</span><span class="sxs-lookup"><span data-stu-id="f89a5-283">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or all fail.</span></span> <span data-ttu-id="f89a5-284">如果完成某些更改后发生错误，这些更改会自动回退。</span><span class="sxs-lookup"><span data-stu-id="f89a5-284">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="f89a5-285">对于需要更多控制&mdash;的情况，例如，如果想要包括在事务中的实体框架之外完成的操作&mdash;参阅使用[事务](/ef/ef6/saving/transactions)。</span><span class="sxs-lookup"><span data-stu-id="f89a5-285">For scenarios where you need more control&mdash;for example, if you want to include operations done outside of Entity Framework in a transaction&mdash;see [Working with Transactions](/ef/ef6/saving/transactions).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="f89a5-286">获取代码</span><span class="sxs-lookup"><span data-stu-id="f89a5-286">Get the code</span></span>

[<span data-ttu-id="f89a5-287">下载完成的项目</span><span class="sxs-lookup"><span data-stu-id="f89a5-287">Download Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="f89a5-288">其他资源</span><span class="sxs-lookup"><span data-stu-id="f89a5-288">Additional resources</span></span>

<span data-ttu-id="f89a5-289">现在，可以使用一组完整的页来执行 `Student` 实体的简单 CRUD 操作。</span><span class="sxs-lookup"><span data-stu-id="f89a5-289">You now have a complete set of pages that perform simple CRUD operations for `Student` entities.</span></span> <span data-ttu-id="f89a5-290">你使用了 MVC 帮助器来生成数据字段的 UI 元素。</span><span class="sxs-lookup"><span data-stu-id="f89a5-290">You used MVC helpers to generate UI elements for data fields.</span></span> <span data-ttu-id="f89a5-291">有关 MVC 帮助器的详细信息，请参阅[使用 HTML 帮助器呈现表单](/previous-versions/aspnet/dd410596(v=vs.98))（这篇文章适用于 mvc 3，但对于 mvc 5 仍适用）。</span><span class="sxs-lookup"><span data-stu-id="f89a5-291">For more info about MVC helpers, see [Rendering a Form Using HTML Helpers](/previous-versions/aspnet/dd410596(v=vs.98)) (the article is for MVC 3 but is still relevant for MVC 5).</span></span>

<span data-ttu-id="f89a5-292">可在[ASP.NET 数据访问-推荐的资源](../../../../whitepapers/aspnet-data-access-content-map.md)中找到指向其他 EF 6 资源的链接。</span><span class="sxs-lookup"><span data-stu-id="f89a5-292">Links to other EF 6 resources can be found in [ASP.NET Data Access - Recommended Resources](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

## <a name="next-steps"></a><span data-ttu-id="f89a5-293">后续步骤</span><span class="sxs-lookup"><span data-stu-id="f89a5-293">Next steps</span></span>

<span data-ttu-id="f89a5-294">在本教程中，你将了解：</span><span class="sxs-lookup"><span data-stu-id="f89a5-294">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="f89a5-295">创建了详细信息页</span><span class="sxs-lookup"><span data-stu-id="f89a5-295">Created a Details page</span></span>
> * <span data-ttu-id="f89a5-296">已更新“创建”页</span><span class="sxs-lookup"><span data-stu-id="f89a5-296">Updated the Create page</span></span>
> * <span data-ttu-id="f89a5-297">更新了 HttpPost Edit 方法</span><span class="sxs-lookup"><span data-stu-id="f89a5-297">Updated the HttpPost Edit method</span></span>
> * <span data-ttu-id="f89a5-298">已更新“删除”页</span><span class="sxs-lookup"><span data-stu-id="f89a5-298">Updated the Delete page</span></span>
> * <span data-ttu-id="f89a5-299">已关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="f89a5-299">Closed database connections</span></span>
> * <span data-ttu-id="f89a5-300">处理的事务</span><span class="sxs-lookup"><span data-stu-id="f89a5-300">Handled transactions</span></span>

<span data-ttu-id="f89a5-301">转到下一篇文章，了解如何向项目添加排序、筛选和分页。</span><span class="sxs-lookup"><span data-stu-id="f89a5-301">Advance to the next article to learn how to add sorting, filtering, and paging to the project.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="f89a5-302">排序、筛选和分页</span><span class="sxs-lookup"><span data-stu-id="f89a5-302">Sorting, Filtering, and Paging</span></span>](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)
