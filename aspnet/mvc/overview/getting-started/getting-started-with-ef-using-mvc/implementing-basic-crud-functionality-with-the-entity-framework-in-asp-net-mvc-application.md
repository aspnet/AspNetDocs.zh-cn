---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
title: 教程：在 ASP.NET MVC 中实现与实体框架 CRUD 功能 |Microsoft Docs
description: 查看和自定义创建、 读取、 更新、 删除 (CRUD) 代码，可在控制器和视图中自动创建的 MVC 基架。
author: tdykstra
ms.author: riande
ms.date: 01/22/2019
ms.topic: tutorial
ms.assetid: a2f70ba4-83d1-4002-9255-24732726c4f2
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 9ed388543dd54d209ff2a0b92df4f7659962582c
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/01/2019
ms.locfileid: "57064074"
---
# <a name="tutorial-implement-crud-functionality-with-the-entity-framework-in-aspnet-mvc"></a><span data-ttu-id="c2115-103">教程：在 ASP.NET MVC 中实现与实体框架 CRUD 功能</span><span class="sxs-lookup"><span data-stu-id="c2115-103">Tutorial: Implement CRUD Functionality with the Entity Framework in ASP.NET MVC</span></span>

<span data-ttu-id="c2115-104">在中[前一篇教程](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)，创建的存储和显示数据使用 Entity Framework (EF) 6 和 SQL Server LocalDB 的 MVC 应用程序。</span><span class="sxs-lookup"><span data-stu-id="c2115-104">In the [previous tutorial](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md), you created an MVC application that stores and displays data using the Entity Framework (EF) 6 and SQL Server LocalDB.</span></span> <span data-ttu-id="c2115-105">在本教程中，您查看和自定义创建、 读取、 更新、 删除 (CRUD) MVC 基架自动为你创建在控制器和视图中的代码。</span><span class="sxs-lookup"><span data-stu-id="c2115-105">In this tutorial, you review and customize the create, read, update, delete (CRUD) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="c2115-106">为了在控制器和数据访问层之间创建一个抽象层，常见的做法是实现存储库模式。</span><span class="sxs-lookup"><span data-stu-id="c2115-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="c2115-107">若要保持这些教程内容简单并重点介绍如何使用 EF 6 本身，它们不使用存储库。</span><span class="sxs-lookup"><span data-stu-id="c2115-107">To keep these tutorials simple and focused on teaching how to use EF 6 itself, they don't use repositories.</span></span> <span data-ttu-id="c2115-108">有关如何实现存储库的信息，请参阅[ASP.NET 数据访问内容映射](../../../../whitepapers/aspnet-data-access-content-map.md)。</span><span class="sxs-lookup"><span data-stu-id="c2115-108">For info about how to implement repositories, see the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

<span data-ttu-id="c2115-109">下面是你创建的 web 页面的示例：</span><span class="sxs-lookup"><span data-stu-id="c2115-109">Here are examples of the web pages you create:</span></span>

![学生详细信息页的屏幕截图。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image1.png)

![学生的屏幕截图创建页。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image2.png)

![屏幕截图 ot 学生删除页。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image3.png)

<span data-ttu-id="c2115-113">在本教程中，你将了解：</span><span class="sxs-lookup"><span data-stu-id="c2115-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="c2115-114">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="c2115-114">Create a Details page</span></span>
> * <span data-ttu-id="c2115-115">更新“创建”页</span><span class="sxs-lookup"><span data-stu-id="c2115-115">Update the Create page</span></span>
> * <span data-ttu-id="c2115-116">更新的 HttpPost 编辑方法</span><span class="sxs-lookup"><span data-stu-id="c2115-116">Update the HttpPost Edit method</span></span>
> * <span data-ttu-id="c2115-117">更新“删除”页</span><span class="sxs-lookup"><span data-stu-id="c2115-117">Update the Delete page</span></span>
> * <span data-ttu-id="c2115-118">关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="c2115-118">Close database connections</span></span>
> * <span data-ttu-id="c2115-119">处理事务</span><span class="sxs-lookup"><span data-stu-id="c2115-119">Handle transactions</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c2115-120">系统必备</span><span class="sxs-lookup"><span data-stu-id="c2115-120">Prerequisites</span></span>

* [<span data-ttu-id="c2115-121">创建实体框架数据模型</span><span class="sxs-lookup"><span data-stu-id="c2115-121">Create the Entity Framework Data Model</span></span>](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)

## <a name="create-a-details-page"></a><span data-ttu-id="c2115-122">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="c2115-122">Create a Details page</span></span>

<span data-ttu-id="c2115-123">面向学生的基架的代码`Index`页上留出`Enrollments`属性，因为该属性包含一个集合。</span><span class="sxs-lookup"><span data-stu-id="c2115-123">The scaffolded code for the Students `Index` page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="c2115-124">在`Details`页上，将集合的内容显示在 HTML 表。</span><span class="sxs-lookup"><span data-stu-id="c2115-124">In the `Details` page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="c2115-125">在中*Controllers\StudentController.cs*，为操作方法`Details`查看使用[查找](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx)方法来检索单个`Student`实体。</span><span class="sxs-lookup"><span data-stu-id="c2115-125">In *Controllers\StudentController.cs*, the action method for the `Details` view uses the [Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx) method to retrieve a single `Student` entity.</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="c2115-126">密钥的值传递给方法作为`id`参数和来自*将数据路由*中**详细信息**索引页上的超链接。</span><span class="sxs-lookup"><span data-stu-id="c2115-126">The key value is passed to the method as the `id` parameter and comes from *route data* in the **Details** hyperlink on the Index page.</span></span>

### <a name="tip-route-data"></a><span data-ttu-id="c2115-127">提示:**路由数据**</span><span class="sxs-lookup"><span data-stu-id="c2115-127">Tip: **Route data**</span></span>

<span data-ttu-id="c2115-128">路由数据是在路由表中指定的 URL 段中找到的模型联编程序的数据。</span><span class="sxs-lookup"><span data-stu-id="c2115-128">Route data is data that the model binder found in a URL segment specified in the routing table.</span></span> <span data-ttu-id="c2115-129">例如，指定默认路由`controller`， `action`，和`id`段：</span><span class="sxs-lookup"><span data-stu-id="c2115-129">For example, the default route specifies `controller`, `action`, and `id` segments:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample2.cs?highlight=3)]

<span data-ttu-id="c2115-130">在以下 URL，默认路由映射`Instructor`作为`controller`，`Index`作为`action`1 赋`id`; 这些是路由数据值。</span><span class="sxs-lookup"><span data-stu-id="c2115-130">In the following URL, the default route maps `Instructor` as the `controller`, `Index` as the `action` and 1 as the `id`; these are route data values.</span></span>

`http://localhost:1230/Instructor/Index/1?courseID=2021`

<span data-ttu-id="c2115-131">`?courseID=2021` 查询字符串值。</span><span class="sxs-lookup"><span data-stu-id="c2115-131">`?courseID=2021` is a query string value.</span></span> <span data-ttu-id="c2115-132">如果传递的模型联编程序也能`id`作为查询字符串值：</span><span class="sxs-lookup"><span data-stu-id="c2115-132">The model binder will also work if you pass the `id` as a query string value:</span></span>

`http://localhost:1230/Instructor/Index?id=1&CourseID=2021`

<span data-ttu-id="c2115-133">通过创建 Url `ActionLink` Razor 视图中的语句。</span><span class="sxs-lookup"><span data-stu-id="c2115-133">The URLs are created by `ActionLink` statements in the Razor view.</span></span> <span data-ttu-id="c2115-134">在下面的代码中，`id`参数匹配的默认路由，因此`id`添加到路由数据。</span><span class="sxs-lookup"><span data-stu-id="c2115-134">In the following code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample3.cshtml)]

<span data-ttu-id="c2115-135">在下面的代码，`courseID`不匹配默认路由中的参数，因此，它将添加为查询字符串。</span><span class="sxs-lookup"><span data-stu-id="c2115-135">In the following code, `courseID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample4.cshtml)]

### <a name="to-create-the-details-page"></a><span data-ttu-id="c2115-136">若要创建的详细信息页</span><span class="sxs-lookup"><span data-stu-id="c2115-136">To create the Details page</span></span>

1. <span data-ttu-id="c2115-137">打开*Views\Student\Details.cshtml*。</span><span class="sxs-lookup"><span data-stu-id="c2115-137">Open *Views\Student\Details.cshtml*.</span></span>

   <span data-ttu-id="c2115-138">使用显示每个字段`DisplayFor`帮助程序，如下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="c2115-138">Each field is displayed using a `DisplayFor` helper, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample5.cshtml)]

2. <span data-ttu-id="c2115-139">之后`EnrollmentDate`字段，然后立即在关闭前`</dl>`标记中，添加突出显示的代码以显示注册列表，如下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="c2115-139">After the `EnrollmentDate` field and immediately before the closing `</dl>` tag, add the highlighted code to display a list of enrollments, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample6.cshtml?highlight=8-29)]

    <span data-ttu-id="c2115-140">如果代码缩进在粘贴代码后出现错误，按**Ctrl**+**K**， **Ctrl**+**D**要设置格式它。</span><span class="sxs-lookup"><span data-stu-id="c2115-140">If code indentation is wrong after you paste the code, press **Ctrl**+**K**, **Ctrl**+**D** to format it.</span></span>

    <span data-ttu-id="c2115-141">此代码循环通过 `Enrollments` 导航属性中的实体。</span><span class="sxs-lookup"><span data-stu-id="c2115-141">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="c2115-142">每个`Enrollment`实体在属性中，它将显示课程标题和成绩。</span><span class="sxs-lookup"><span data-stu-id="c2115-142">For each `Enrollment` entity in the property, it displays the course title and the grade.</span></span> <span data-ttu-id="c2115-143">课程标题检索从`Course`中存储的实体`Course`导航属性`Enrollments`实体。</span><span class="sxs-lookup"><span data-stu-id="c2115-143">The course title is retrieved from the `Course` entity that's stored in the `Course` navigation property of the `Enrollments` entity.</span></span> <span data-ttu-id="c2115-144">所有这些数据是从数据库中检索自动在需要时。</span><span class="sxs-lookup"><span data-stu-id="c2115-144">All of this data is retrieved from the database automatically when it's needed.</span></span> <span data-ttu-id="c2115-145">换而言之，使用延迟加载此处。</span><span class="sxs-lookup"><span data-stu-id="c2115-145">In other words, you are using lazy loading here.</span></span> <span data-ttu-id="c2115-146">未指定*预先加载*为`Courses`导航属性，因此有学生在同一查询中检索不到注册的。</span><span class="sxs-lookup"><span data-stu-id="c2115-146">You did not specify *eager loading* for the `Courses` navigation property, so the enrollments were not retrieved in the same query that got the students.</span></span> <span data-ttu-id="c2115-147">相反，第一次尝试访问`Enrollments`导航属性，一个新的查询发送到数据库以检索数据。</span><span class="sxs-lookup"><span data-stu-id="c2115-147">Instead, the first time you try to access the `Enrollments` navigation property, a new query is sent to the database to retrieve the data.</span></span> <span data-ttu-id="c2115-148">你可以阅读更多有关延迟加载和预先加载在[读取相关数据](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)本系列后面的教程。</span><span class="sxs-lookup"><span data-stu-id="c2115-148">You can read more about lazy loading and eager loading in the [Reading Related Data](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial later in this series.</span></span>

3. <span data-ttu-id="c2115-149">通过启动该程序打开的详细信息页 (**Ctrl**+**F5**)，选择**学生**选项卡上，，然后单击**的详细信息** Alexander Carson 的链接。</span><span class="sxs-lookup"><span data-stu-id="c2115-149">Open the Details page by starting the program (**Ctrl**+**F5**), selecting the **Students** tab, and then clicking the **Details** link for Alexander Carson.</span></span> <span data-ttu-id="c2115-150">(如果按下**Ctrl**+**F5**而*Details.cshtml*文件处于打开状态，你收到 HTTP 400 错误。</span><span class="sxs-lookup"><span data-stu-id="c2115-150">(If you press **Ctrl**+**F5** while the *Details.cshtml* file is open, you get an HTTP 400 error.</span></span> <span data-ttu-id="c2115-151">这是因为 Visual Studio 尝试运行详细信息页上，但它未达到指定的学生，若要显示的链接。</span><span class="sxs-lookup"><span data-stu-id="c2115-151">This is because Visual Studio tries to run the Details page, but it wasn't reached from a link that specifies the student to display.</span></span> <span data-ttu-id="c2115-152">如果发生这种情况，从 URL 中删除"学生/详细信息"和重试，或者，关闭浏览器中，右键单击项目，并单击**视图** > **用浏览器查看**。)</span><span class="sxs-lookup"><span data-stu-id="c2115-152">If that happens, remove "Student/Details" from the URL and try again, or, close the browser, right-click the project, and click **View** > **View in Browser**.)</span></span>

    <span data-ttu-id="c2115-153">看到所选学生的课程和成绩列表。</span><span class="sxs-lookup"><span data-stu-id="c2115-153">You see the list of courses and grades for the selected student.</span></span>

4. <span data-ttu-id="c2115-154">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="c2115-154">Close the browser.</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="c2115-155">更新“创建”页</span><span class="sxs-lookup"><span data-stu-id="c2115-155">Update the Create page</span></span>

1. <span data-ttu-id="c2115-156">在中*Controllers\StudentController.cs*，替换<xref:System.Web.Mvc.HttpPostAttribute>`Create`用下面的代码的操作方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-156">In *Controllers\StudentController.cs*, replace the <xref:System.Web.Mvc.HttpPostAttribute> `Create` action method with the following code.</span></span> <span data-ttu-id="c2115-157">此代码将添加`try-catch`块而不会`ID`从<xref:System.Web.Mvc.BindAttribute>基架生成的方法的属性：</span><span class="sxs-lookup"><span data-stu-id="c2115-157">This code adds a `try-catch` block and removes `ID` from the <xref:System.Web.Mvc.BindAttribute> attribute for the scaffolded method:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample7.cs?highlight=3,5-6,13-18)]

    <span data-ttu-id="c2115-158">此代码将添加`Student`ASP.NET MVC 模型绑定器创建实体到`Students`实体设置，并将所做的更改保存到数据库。</span><span class="sxs-lookup"><span data-stu-id="c2115-158">This code adds the `Student` entity created by the ASP.NET MVC model binder to the `Students` entity set and then saves the changes to the database.</span></span> <span data-ttu-id="c2115-159">*模型联编程序*指的是 ASP.NET MVC 功能，使其更轻松地处理提交的窗体的数据; 模型联编程序将发布窗体到 CLR 类型值，并将其传递给操作方法的参数。</span><span class="sxs-lookup"><span data-stu-id="c2115-159">*Model binder* refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="c2115-160">在这种情况下，模型绑定器实例化`Student`实体为你使用属性值从`Form`集合。</span><span class="sxs-lookup"><span data-stu-id="c2115-160">In this case, the model binder instantiates a `Student` entity for you using property values from the `Form` collection.</span></span>

    <span data-ttu-id="c2115-161">您删除`ID`从绑定属性，因为`ID`是 SQL Server 将插入行时自动设置的主键值。</span><span class="sxs-lookup"><span data-stu-id="c2115-161">You removed `ID` from the Bind attribute because `ID` is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="c2115-162">来自用户的输入不会设置`ID`值。</span><span class="sxs-lookup"><span data-stu-id="c2115-162">Input from the user does not set the `ID` value.</span></span>

    <a id="overpost"></a>

    ### <a name="security-warning---the-validateantiforgerytoken-attribute-helps-prevent-cross-site-request-forgerysecurityxsrfcsrf-prevention-in-aspnet-mvc-and-web-pagesmd-attacks-it-requires-a-corresponding-htmlantiforgerytoken-statement-in-the-view-which-youll-see-later"></a><span data-ttu-id="c2115-163">安全警告-`ValidateAntiForgeryToken`特性帮助抵御[跨站点请求伪造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻击。</span><span class="sxs-lookup"><span data-stu-id="c2115-163">Security warning - The `ValidateAntiForgeryToken` attribute helps prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span> <span data-ttu-id="c2115-164">它需要相应`Html.AntiForgeryToken()`语句在视图中，您将会看到更高版本。</span><span class="sxs-lookup"><span data-stu-id="c2115-164">It requires a corresponding `Html.AntiForgeryToken()` statement in the view, which you'll see later.</span></span>

    <span data-ttu-id="c2115-165">`Bind`属性是一种方法来防止*过度发布*创建方案中。</span><span class="sxs-lookup"><span data-stu-id="c2115-165">The `Bind` attribute is one way to protect against *over-posting* in create scenarios.</span></span> <span data-ttu-id="c2115-166">例如，假设`Student`实体包含`Secret`不希望此网页设置的属性。</span><span class="sxs-lookup"><span data-stu-id="c2115-166">For example, suppose the `Student` entity includes a `Secret` property that you don't want this web page to set.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample8.cs?highlight=7)]

    <span data-ttu-id="c2115-167">即使您没有`Secret`字段在网页上，黑客可以使用一种工具如[fiddler](http://fiddler2.com/home)，或编写一些 JavaScript 来发布`Secret`表单值。</span><span class="sxs-lookup"><span data-stu-id="c2115-167">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as [fiddler](http://fiddler2.com/home), or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="c2115-168">无需<xref:System.Web.Mvc.BindAttribute>特性来限制模型绑定器在创建时使用的字段`Student`实例<em>，</em>模型绑定器会选取该`Secret`表单值并使用它来创建`Student`实体实例。</span><span class="sxs-lookup"><span data-stu-id="c2115-168">Without the <xref:System.Web.Mvc.BindAttribute> attribute limiting the fields that the model binder uses when it creates a `Student` instance<em>,</em> the model binder would pick up that `Secret` form value and use it to create the `Student` entity instance.</span></span> <span data-ttu-id="c2115-169">然后将在数据库中更新黑客为 `Secret` 表单字段指定的任意值。</span><span class="sxs-lookup"><span data-stu-id="c2115-169">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="c2115-170">下图显示 fiddler 工具添加`Secret`（具有值"OverPost"） 为已发布的表单值的字段。</span><span class="sxs-lookup"><span data-stu-id="c2115-170">The following image shows the fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

    ![](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image5.png)

    <span data-ttu-id="c2115-171">然后值“OverPost”将成功添加到插入行的 `Secret` 属性，尽管你从未打算网页可设置该属性。</span><span class="sxs-lookup"><span data-stu-id="c2115-171">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

    <span data-ttu-id="c2115-172">最好是使用`Include`参数与`Bind`归于*允许列表*字段</span><span class="sxs-lookup"><span data-stu-id="c2115-172">It's best to use the `Include` parameter with the `Bind` attribute to *whitelist* fields.</span></span> <span data-ttu-id="c2115-173">还有可能要使用`Exclude`参数*阻止列表*你想要排除的字段。</span><span class="sxs-lookup"><span data-stu-id="c2115-173">It's also possible to use the `Exclude` parameter to *blacklist* fields you want to exclude.</span></span> <span data-ttu-id="c2115-174">原因`Include`更安全是，当将新属性添加到实体，新字段不会自动受`Exclude`列表。</span><span class="sxs-lookup"><span data-stu-id="c2115-174">The reason `Include` is more secure is that when you add a new property to the entity, the new field is not automatically protected by an `Exclude` list.</span></span>

    <span data-ttu-id="c2115-175">可以防止在编辑方案中的过多发布是通过首先从数据库读取实体，然后再调用`TryUpdateModel`，并传递显式允许的属性列表中。</span><span class="sxs-lookup"><span data-stu-id="c2115-175">You can prevent overposting in edit scenarios is by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="c2115-176">这是在这些教程中使用的方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-176">That is the method used in these tutorials.</span></span>

    <span data-ttu-id="c2115-177">防止过多发布的许多开发人员的首选的替代方法是使用视图模型而不是实体类与模型绑定。</span><span class="sxs-lookup"><span data-stu-id="c2115-177">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="c2115-178">仅包含想要在视图模型中更新的属性。</span><span class="sxs-lookup"><span data-stu-id="c2115-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="c2115-179">完成 MVC 模型绑定器后，将视图模型属性复制到的实体实例，根据需要使用一种工具类似于[AutoMapper](http://automapper.org/)。</span><span class="sxs-lookup"><span data-stu-id="c2115-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as [AutoMapper](http://automapper.org/).</span></span> <span data-ttu-id="c2115-180">使用数据库。要将其状态设置为 Unchanged，然后设置 Property("PropertyName") 的实体实例的项。为 true 的视图模型中包含每个实体属性的 IsModified。</span><span class="sxs-lookup"><span data-stu-id="c2115-180">Use db.Entry on the entity instance to set its state to Unchanged, and then set Property("PropertyName").IsModified to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="c2115-181">此方法同时适用于编辑和创建方案。</span><span class="sxs-lookup"><span data-stu-id="c2115-181">This method works in both edit and create scenarios.</span></span>

    <span data-ttu-id="c2115-182">以外`Bind`属性，`try-catch`块是对基架代码所做的唯一更改。</span><span class="sxs-lookup"><span data-stu-id="c2115-182">Other than the `Bind` attribute, the `try-catch` block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="c2115-183">如果保存更改时捕获到来自 <xref:System.Data.DataException> 的异常，则会显示一般错误消息。</span><span class="sxs-lookup"><span data-stu-id="c2115-183">If an exception that derives from <xref:System.Data.DataException> is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="c2115-184">有时 <xref:System.Data.DataException> 异常是由应用程序外部的某些内容而非编程错误引起的，因此建议用户再次尝试。</span><span class="sxs-lookup"><span data-stu-id="c2115-184"><xref:System.Data.DataException> exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="c2115-185">尽管在本示例中未实现，但生产质量应用程序会记录异常。</span><span class="sxs-lookup"><span data-stu-id="c2115-185">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="c2115-186">有关详细信息，请参阅[监视和遥测（使用 Azure 构建真实世界云应用）](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log)中的“见解记录”部分。</span><span class="sxs-lookup"><span data-stu-id="c2115-186">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log).</span></span>

    <span data-ttu-id="c2115-187">中的代码*Views\Student\Create.cshtml*类似于您在中看到*Details.cshtml*，只不过`EditorFor`和`ValidationMessageFor`帮助程序用于每个字段而不是`DisplayFor`.</span><span class="sxs-lookup"><span data-stu-id="c2115-187">The code in *Views\Student\Create.cshtml* is similar to what you saw in *Details.cshtml*, except that `EditorFor` and `ValidationMessageFor` helpers are used for each field instead of `DisplayFor`.</span></span> <span data-ttu-id="c2115-188">下面是相关的代码：</span><span class="sxs-lookup"><span data-stu-id="c2115-188">Here is the relevant code:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample9.cshtml)]

    <span data-ttu-id="c2115-189">*Create.cshtml*还包括`@Html.AntiForgeryToken()`，适用于`ValidateAntiForgeryToken`属性中的控制器，以帮助防止[跨站点请求伪造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻击。</span><span class="sxs-lookup"><span data-stu-id="c2115-189">*Create.cshtml* also includes `@Html.AntiForgeryToken()`, which works with the `ValidateAntiForgeryToken` attribute in the controller to help prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span>

    <span data-ttu-id="c2115-190">需要在不更改*Create.cshtml*。</span><span class="sxs-lookup"><span data-stu-id="c2115-190">No changes are required in *Create.cshtml*.</span></span>

2. <span data-ttu-id="c2115-191">通过启动该程序，运行页上选择**学生**选项卡上，，然后单击**创建新**。</span><span class="sxs-lookup"><span data-stu-id="c2115-191">Run the page by starting the program, selecting the **Students** tab, and then clicking **Create New**.</span></span>

3. <span data-ttu-id="c2115-192">输入名称和无效的日期，然后单击**创建**可查看错误消息。</span><span class="sxs-lookup"><span data-stu-id="c2115-192">Enter names and an invalid date and click **Create** to see the error message.</span></span>

    <span data-ttu-id="c2115-193">这是默认情况下获取的服务器端验证。</span><span class="sxs-lookup"><span data-stu-id="c2115-193">This is server-side validation that you get by default.</span></span> <span data-ttu-id="c2115-194">在更高版本的教程中，您将了解如何添加生成的客户端验证代码的属性。</span><span class="sxs-lookup"><span data-stu-id="c2115-194">In a later tutorial, you'll see how to add attributes that generate code for client-side validation.</span></span> <span data-ttu-id="c2115-195">以下突出显示的代码显示了中的模型验证检查**创建**方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-195">The following highlighted code shows the model validation check in the **Create** method.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample10.cs?highlight=1)]

4. <span data-ttu-id="c2115-196">将日期更改为有效值，并单击“创建”，查看“索引”页中显示的新学生。</span><span class="sxs-lookup"><span data-stu-id="c2115-196">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

5. <span data-ttu-id="c2115-197">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="c2115-197">Close the browser.</span></span>

## <a name="update-httppost-edit-method"></a><span data-ttu-id="c2115-198">更新 HttpPost 编辑方法</span><span class="sxs-lookup"><span data-stu-id="c2115-198">Update HttpPost Edit method</span></span>

1. <span data-ttu-id="c2115-199">替换<xref:System.Web.Mvc.HttpPostAttribute>`Edit`用下面的代码的操作方法：</span><span class="sxs-lookup"><span data-stu-id="c2115-199">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Edit` action method with the following code:</span></span>

   [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample11.cs)]

   > [!NOTE]
   > <span data-ttu-id="c2115-200">在*Controllers\StudentController.cs*，则`HttpGet Edit`方法 (而不是`HttpPost`属性) 使用`Find`方法来检索所选`Student`实体，为你在中看到`Details`方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-200">In *Controllers\StudentController.cs*, the `HttpGet Edit` method (the one without the `HttpPost` attribute) uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="c2115-201">不需要更改此方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-201">You don't need to change this method.</span></span>

   <span data-ttu-id="c2115-202">这些更改实现安全的最佳做法，以免[过多发布](#overpost)，基架生成`Bind`属性，并添加到的实体集具有已修改标志将模型绑定器创建的实体。</span><span class="sxs-lookup"><span data-stu-id="c2115-202">These changes implement a security best practice to prevent [overposting](#overpost), The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a Modified flag.</span></span> <span data-ttu-id="c2115-203">由于不再推荐代码`Bind`特性将清除在字段中未列出任何预先存在的数据`Include`参数。</span><span class="sxs-lookup"><span data-stu-id="c2115-203">That code is no longer recommended because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span> <span data-ttu-id="c2115-204">将来，MVC 控制器基架将进行更新，以便它不会生成`Bind`Edit 方法的属性。</span><span class="sxs-lookup"><span data-stu-id="c2115-204">In the future, the MVC controller scaffolder will be updated so that it doesn't generate `Bind` attributes for Edit methods.</span></span>

   <span data-ttu-id="c2115-205">新代码读取现有实体并调用<xref:System.Web.Mvc.Controller.TryUpdateModel%2A>更新从已发布的表单数据中的用户输入的字段。</span><span class="sxs-lookup"><span data-stu-id="c2115-205">The new code reads the existing entity and calls <xref:System.Web.Mvc.Controller.TryUpdateModel%2A> to update fields from user input in the posted form data.</span></span> <span data-ttu-id="c2115-206">实体框架的自动更改跟踪集[EntityState.Modified](<xref:System.Data.EntityState.Modified>)实体上的标志。</span><span class="sxs-lookup"><span data-stu-id="c2115-206">The Entity Framework's automatic change tracking sets the [EntityState.Modified](<xref:System.Data.EntityState.Modified>) flag on the entity.</span></span> <span data-ttu-id="c2115-207">当[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)调用方法时，<xref:System.Data.EntityState.Modified>标志会导致实体框架来创建 SQL 语句来更新数据库行。</span><span class="sxs-lookup"><span data-stu-id="c2115-207">When the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method is called, the <xref:System.Data.EntityState.Modified> flag causes the Entity Framework to create SQL statements to update the database row.</span></span> <span data-ttu-id="c2115-208">[并发冲突](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)将被忽略，并更新数据库行中的所有列，包括用户未更改。</span><span class="sxs-lookup"><span data-stu-id="c2115-208">[Concurrency conflicts](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) are ignored, and all columns of the database row are updated, including those that the user didn't change.</span></span> <span data-ttu-id="c2115-209">(更高版本的教程演示如何处理并发冲突，并且如果只想要在数据库中更新的单个字段，可以将实体设置为[EntityState.Unchanged](<xref:System.Data.EntityState.Unchanged>)并将各个字段设置为[EntityState.Modified](<xref:System.Data.EntityState.Modified>)。)</span><span class="sxs-lookup"><span data-stu-id="c2115-209">(A later tutorial shows how to handle concurrency conflicts, and if you only want individual fields to be updated in the database, you can set the entity to [EntityState.Unchanged](<xref:System.Data.EntityState.Unchanged>) and set individual fields to [EntityState.Modified](<xref:System.Data.EntityState.Modified>).)</span></span>

   <span data-ttu-id="c2115-210">若要防止过多发布，你想要通过编辑页面可更新的字段是否在允许列表中的`TryUpdateModel`参数。</span><span class="sxs-lookup"><span data-stu-id="c2115-210">To prevent overposting, the fields that you want to be updateable by the Edit page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="c2115-211">目前没有要保护的额外字段，但是列出希望模型绑定器绑定的字段可确保以后将字段添加到数据模型时，它们将自动受到保护，直到明确将其添加到此处为止。</span><span class="sxs-lookup"><span data-stu-id="c2115-211">Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

   <span data-ttu-id="c2115-212">这些更改会导致 HttpPost Edit 方法的方法签名是与 HttpGet 编辑方法; 相同因此，您已重命名方法 EditPost。</span><span class="sxs-lookup"><span data-stu-id="c2115-212">As a result of these changes, the method signature of the HttpPost Edit method is the same as the HttpGet edit method; therefore you've renamed the method EditPost.</span></span>

   > [!TIP]
   >
   > <span data-ttu-id="c2115-213">**实体状态的附加和 SaveChanges 方法**</span><span class="sxs-lookup"><span data-stu-id="c2115-213">**Entity States and the Attach and SaveChanges Methods**</span></span>
   >
   > <span data-ttu-id="c2115-214">数据库上下文跟踪内存中的实体是否与数据库中相应的行同步，并且此信息确定调用 `SaveChanges` 方法时会发生的情况。</span><span class="sxs-lookup"><span data-stu-id="c2115-214">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="c2115-215">例如，当传递到新的实体[外](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx)方法，该实体的状态设置为`Added`。</span><span class="sxs-lookup"><span data-stu-id="c2115-215">For example, when you pass a new entity to the [Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx) method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="c2115-216">然后调用[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法，将数据库上下文发出 SQL`INSERT`命令。</span><span class="sxs-lookup"><span data-stu-id="c2115-216">Then when you call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method, the database context issues a SQL `INSERT` command.</span></span>
   >
   > <span data-ttu-id="c2115-217">实体可能在下列情况之一[状态](xref:System.Data.EntityState):</span><span class="sxs-lookup"><span data-stu-id="c2115-217">An entity may be in one of the following [states](xref:System.Data.EntityState):</span></span>
   >
   > - <span data-ttu-id="c2115-218">`Added`。</span><span class="sxs-lookup"><span data-stu-id="c2115-218">`Added`.</span></span> <span data-ttu-id="c2115-219">实体在数据库中尚不存在。</span><span class="sxs-lookup"><span data-stu-id="c2115-219">The entity does not yet exist in the database.</span></span> <span data-ttu-id="c2115-220">`SaveChanges`方法必须发出`INSERT`语句。</span><span class="sxs-lookup"><span data-stu-id="c2115-220">The `SaveChanges` method must issue an `INSERT` statement.</span></span>
   > - <span data-ttu-id="c2115-221">`Unchanged`。</span><span class="sxs-lookup"><span data-stu-id="c2115-221">`Unchanged`.</span></span> <span data-ttu-id="c2115-222">不需要通过 `SaveChanges` 方法对此实体执行操作。</span><span class="sxs-lookup"><span data-stu-id="c2115-222">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="c2115-223">从数据库读取实体时，实体将从此状态开始。</span><span class="sxs-lookup"><span data-stu-id="c2115-223">When you read an entity from the database, the entity starts out with this status.</span></span>
   > - <span data-ttu-id="c2115-224">`Modified`。</span><span class="sxs-lookup"><span data-stu-id="c2115-224">`Modified`.</span></span> <span data-ttu-id="c2115-225">已修改实体的部分或全部属性值。</span><span class="sxs-lookup"><span data-stu-id="c2115-225">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="c2115-226">`SaveChanges`方法必须发出`UPDATE`语句。</span><span class="sxs-lookup"><span data-stu-id="c2115-226">The `SaveChanges` method must issue an `UPDATE` statement.</span></span>
   > - <span data-ttu-id="c2115-227">`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="c2115-227">`Deleted`.</span></span> <span data-ttu-id="c2115-228">已标记该实体进行删除。</span><span class="sxs-lookup"><span data-stu-id="c2115-228">The entity has been marked for deletion.</span></span> <span data-ttu-id="c2115-229">`SaveChanges`方法必须发出`DELETE`语句。</span><span class="sxs-lookup"><span data-stu-id="c2115-229">The `SaveChanges` method must issue a `DELETE` statement.</span></span>
   > - <span data-ttu-id="c2115-230">`Detached`。</span><span class="sxs-lookup"><span data-stu-id="c2115-230">`Detached`.</span></span> <span data-ttu-id="c2115-231">数据库上下文未跟踪该实体。</span><span class="sxs-lookup"><span data-stu-id="c2115-231">The entity isn't being tracked by the database context.</span></span>
   >
   > <span data-ttu-id="c2115-232">在桌面应用程序中，通常会自动设置状态更改。</span><span class="sxs-lookup"><span data-stu-id="c2115-232">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="c2115-233">在桌面应用程序的类型中，读取一个实体并对它的一些属性值进行更改。</span><span class="sxs-lookup"><span data-stu-id="c2115-233">In a desktop type of application, you read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="c2115-234">这将使其实体状态自动更改为 `Modified`。</span><span class="sxs-lookup"><span data-stu-id="c2115-234">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="c2115-235">然后调用`SaveChanges`，Entity Framework 生成 SQL`UPDATE`更新仅更改了的实际属性的语句。</span><span class="sxs-lookup"><span data-stu-id="c2115-235">Then when you call `SaveChanges`, the Entity Framework generates a SQL `UPDATE` statement that updates only the actual properties that you changed.</span></span>
   >
   > <span data-ttu-id="c2115-236">Web 应用断开连接的特性不允许此连续序列。</span><span class="sxs-lookup"><span data-stu-id="c2115-236">The disconnected nature of web apps doesn't allow for this continuous sequence.</span></span> <span data-ttu-id="c2115-237">[DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx)读取实体将在页面呈现后进行处理。</span><span class="sxs-lookup"><span data-stu-id="c2115-237">The [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) that reads an entity is disposed after a page is rendered.</span></span> <span data-ttu-id="c2115-238">当`HttpPost``Edit`调用操作方法，将进行新的请求并具有的新实例[DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx)，因此您必须手动将实体状态设置为`Modified.`然后当您调用`SaveChanges`，Entity Framework 会更新所有列的数据库行，因为上下文无法知道已更改的属性。</span><span class="sxs-lookup"><span data-stu-id="c2115-238">When the `HttpPost` `Edit` action method is called, a new request is made and you have a new instance of the [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx), so you have to manually set the entity state to `Modified.` Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>
   >
   > <span data-ttu-id="c2115-239">如果您希望 SQL`Update`语句来更新字段的用户实际更改，您可以以某种方式 （如隐藏字段） 保存的原始值，以便它们时，将用`HttpPost``Edit`调用方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-239">If you want the SQL `Update` statement to update only the fields that the user actually changed, you can save the original values in some way (such as hidden fields) so that they are available when the `HttpPost` `Edit` method is called.</span></span> <span data-ttu-id="c2115-240">然后可以创建`Student`实体使用的原始值，调用`Attach`方法与该原始版本的实体的实体的值更新为新值，然后调用`SaveChanges.`的详细信息，请参阅[实体状态和 SaveChanges](/ef/ef6/saving/change-tracking/entity-state)并[本地数据](/ef/ef6/querying/local-data)。</span><span class="sxs-lookup"><span data-stu-id="c2115-240">Then you can create a `Student` entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges.` For more information, see [Entity states and SaveChanges](/ef/ef6/saving/change-tracking/entity-state) and [Local Data](/ef/ef6/querying/local-data).</span></span>

   <span data-ttu-id="c2115-241">中的 HTML 和 Razor 代码*Views\Student\Edit.cshtml*类似于您在中看到*Create.cshtml*，并不不需要任何更改。</span><span class="sxs-lookup"><span data-stu-id="c2115-241">The HTML and Razor code in *Views\Student\Edit.cshtml* is similar to what you saw in *Create.cshtml*, and no changes are required.</span></span>

2. <span data-ttu-id="c2115-242">通过启动该程序，运行页上选择**学生**选项卡上，，然后单击**编辑**超链接。</span><span class="sxs-lookup"><span data-stu-id="c2115-242">Run the page by starting the program, selecting the **Students** tab, and then clicking an **Edit** hyperlink.</span></span>

3. <span data-ttu-id="c2115-243">更改某些数据并单击“保存”。</span><span class="sxs-lookup"><span data-stu-id="c2115-243">Change some of the data and click **Save**.</span></span> <span data-ttu-id="c2115-244">请参阅索引页中更改的数据。</span><span class="sxs-lookup"><span data-stu-id="c2115-244">You see the changed data in the Index page.</span></span>

4. <span data-ttu-id="c2115-245">关闭浏览器。</span><span class="sxs-lookup"><span data-stu-id="c2115-245">Close the browser.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="c2115-246">更新“删除”页</span><span class="sxs-lookup"><span data-stu-id="c2115-246">Update the Delete page</span></span>

<span data-ttu-id="c2115-247">在中*Controllers\StudentController.cs*的模板代码<xref:System.Web.Mvc.HttpGetAttribute>`Delete`方法使用`Find`方法来检索所选`Student`实体，为你在中看到`Details`和`Edit`方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-247">In *Controllers\StudentController.cs*, the template code for the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` and `Edit` methods.</span></span> <span data-ttu-id="c2115-248">但是，若要在调用 `SaveChanges` 失败时实现自定义错误消息，请将部分功能添加到此方法及其相应的视图中。</span><span class="sxs-lookup"><span data-stu-id="c2115-248">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="c2115-249">正如所看到的更新和创建操作，删除操作需要两个操作方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-249">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="c2115-250">调用以响应 GET 请求的方法显示一个视图，使用户有机会批准或取消删除操作。</span><span class="sxs-lookup"><span data-stu-id="c2115-250">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="c2115-251">如果用户批准，则创建 POST 请求。</span><span class="sxs-lookup"><span data-stu-id="c2115-251">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="c2115-252">在这种情况， `HttpPost` `Delete`调用方法，然后该方法实际执行删除操作。</span><span class="sxs-lookup"><span data-stu-id="c2115-252">When that happens, the `HttpPost` `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="c2115-253">你将添加`try-catch`阻止<xref:System.Web.Mvc.HttpPostAttribute>`Delete`方法以处理更新数据库时可能出现的任何错误。</span><span class="sxs-lookup"><span data-stu-id="c2115-253">You'll add a `try-catch` block to the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="c2115-254">如果发生错误， <xref:System.Web.Mvc.HttpPostAttribute> `Delete`方法调用<xref:System.Web.Mvc.HttpGetAttribute>`Delete`方法，并向其传递一个参数，指示发生错误。</span><span class="sxs-lookup"><span data-stu-id="c2115-254">If an error occurs, the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method calls the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="c2115-255"><xref:System.Web.Mvc.HttpGetAttribute> `Delete`方法然后重新显示确认页以及错误消息，为用户提供取消或稍后重试的机会。</span><span class="sxs-lookup"><span data-stu-id="c2115-255">The <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

1. <span data-ttu-id="c2115-256">替换<xref:System.Web.Mvc.HttpGetAttribute>`Delete`用下面的代码，用于管理错误报告的操作方法：</span><span class="sxs-lookup"><span data-stu-id="c2115-256">Replace the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` action method with the following code, which manages error reporting:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample12.cs?highlight=1,7-10)]

    <span data-ttu-id="c2115-257">此代码接受[可选参数](https://msdn.microsoft.com/library/dd264739.aspx)，该值指示是否在发生故障，以保存更改后调用该方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-257">This code accepts an [optional parameter](https://msdn.microsoft.com/library/dd264739.aspx) that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="c2115-258">此参数是`false`时`HttpGet``Delete`不上一次失败的情况下调用方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-258">This parameter is `false` when the `HttpGet` `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="c2115-259">调用时`HttpPost``Delete`方法以响应数据库更新错误，该参数是`true`和一条错误消息传递给视图。</span><span class="sxs-lookup"><span data-stu-id="c2115-259">When it is called by the `HttpPost` `Delete` method in response to a database update error, the parameter is `true` and an error message is passed to the view.</span></span>

2. <span data-ttu-id="c2115-260">替换<xref:System.Web.Mvc.HttpPostAttribute>`Delete`操作方法 (名为`DeleteConfirmed`) 使用以下代码，其执行实际删除操作并捕获任何数据库更新错误。</span><span class="sxs-lookup"><span data-stu-id="c2115-260">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample13.cs)]

    <span data-ttu-id="c2115-261">此代码检索所选的实体，然后调用[删除](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx)方法将实体的状态设置为`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="c2115-261">This code retrieves the selected entity, then calls the [Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="c2115-262">当`SaveChanges`调用时，SQL`DELETE`生成命令。</span><span class="sxs-lookup"><span data-stu-id="c2115-262">When `SaveChanges` is called, a SQL `DELETE` command is generated.</span></span> <span data-ttu-id="c2115-263">你还将操作方法名称从 `DeleteConfirmed` 更改为了 `Delete`。</span><span class="sxs-lookup"><span data-stu-id="c2115-263">You have also changed the action method name from `DeleteConfirmed` to `Delete`.</span></span> <span data-ttu-id="c2115-264">基架的代码名为`HttpPost``Delete`方法`DeleteConfirmed`以便`HttpPost`方法唯一的签名。</span><span class="sxs-lookup"><span data-stu-id="c2115-264">The scaffolded code named the `HttpPost` `Delete` method `DeleteConfirmed` to give the `HttpPost` method a unique signature.</span></span> <span data-ttu-id="c2115-265">（CLR 要求重载方法具有不同的方法参数。）签名是唯一的现在可以继续使用 MVC 约定，使用相同的名称`HttpPost`和`HttpGet`删除方法。</span><span class="sxs-lookup"><span data-stu-id="c2115-265">(The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the `HttpPost` and `HttpGet` delete methods.</span></span>

    <span data-ttu-id="c2115-266">如果在大容量应用程序中提高性能是优先考虑，可以避免不必要的 SQL 查询，若要检索的行替换为调用的代码行`Find`和`Remove`方法使用以下代码：</span><span class="sxs-lookup"><span data-stu-id="c2115-266">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query to retrieve the row by replacing the lines of code that call the `Find` and `Remove` methods with the following code:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample14.cs)]

    <span data-ttu-id="c2115-267">此代码实例化`Student`实体使用的主要密钥值然后将实体状态设置为`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="c2115-267">This code instantiates a `Student` entity using only the primary key value and then sets the entity state to `Deleted`.</span></span> <span data-ttu-id="c2115-268">这是 Entity Framework 删除实体需要执行的所有操作。</span><span class="sxs-lookup"><span data-stu-id="c2115-268">That's all that the Entity Framework needs in order to delete the entity.</span></span>

    <span data-ttu-id="c2115-269">如所述， `HttpGet` `Delete`方法不会删除数据。</span><span class="sxs-lookup"><span data-stu-id="c2115-269">As noted, the `HttpGet` `Delete` method doesn't delete the data.</span></span> <span data-ttu-id="c2115-270">执行删除操作以响应 GET 请求 （或者就此而言，执行的任何编辑操作，创建操作或更改数据的任何其他操作） 会产生安全风险。</span><span class="sxs-lookup"><span data-stu-id="c2115-270">Performing a delete operation in response to a GET request (or for that matter, performing any edit operation, create operation, or any other operation that changes data) creates a security risk.</span></span> <span data-ttu-id="c2115-271">有关详细信息，请参阅[ASP.NET MVC 提示 #46 — 不使用删除链接，因为他们创建的安全漏洞](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx)Stephen Walther 的博客上。</span><span class="sxs-lookup"><span data-stu-id="c2115-271">For more information, see [ASP.NET MVC Tip #46 — Don't use Delete Links because they create Security Holes](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx) on Stephen Walther's blog.</span></span>

3. <span data-ttu-id="c2115-272">在中*Views\Student\Delete.cshtml*，添加一条错误消息之间`h2`标题和`h3`标题，如下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="c2115-272">In *Views\Student\Delete.cshtml*, add an error message between the `h2` heading and the `h3` heading, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample15.cshtml?highlight=2)]

4. <span data-ttu-id="c2115-273">通过启动该程序，运行页上选择**学生**选项卡上，，然后单击**删除**超链接。</span><span class="sxs-lookup"><span data-stu-id="c2115-273">Run the page by starting the program, selecting the **Students** tab, and then clicking a **Delete** hyperlink.</span></span>

5. <span data-ttu-id="c2115-274">选择**删除**上显示的页面**是否确实要删除此？**。</span><span class="sxs-lookup"><span data-stu-id="c2115-274">Choose **Delete** on the page that says **Are you sure you want to delete this?**.</span></span>

    <span data-ttu-id="c2115-275">索引页显示不带已删除学生。</span><span class="sxs-lookup"><span data-stu-id="c2115-275">The Index page displays without the deleted student.</span></span> <span data-ttu-id="c2115-276">(您将看到的错误处理中的操作中的代码示例[并发教程](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)。)</span><span class="sxs-lookup"><span data-stu-id="c2115-276">(You'll see an example of the error handling code in action in the [concurrency tutorial](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md).)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="c2115-277">关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="c2115-277">Close database connections</span></span>

<span data-ttu-id="c2115-278">若要关闭的数据库连接并释放尽可能快地保存它们的资源，请释放上下文实例完成后使用它。</span><span class="sxs-lookup"><span data-stu-id="c2115-278">To close database connections and free up the resources they hold as soon as possible, dispose the context instance when you are done with it.</span></span> <span data-ttu-id="c2115-279">基架的代码提供的就是为什么[Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx)方法的末尾`StudentController`类*StudentController.cs*，如以下示例所示：</span><span class="sxs-lookup"><span data-stu-id="c2115-279">That is why the scaffolded code provides a [Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx) method at the end of the `StudentController` class in *StudentController.cs*, as shown in the following example:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample16.cs)]

<span data-ttu-id="c2115-280">基`Controller`类已经实现`IDisposable`接口，所以此代码只需将添加到替代`Dispose(bool)`方法来显式释放上下文实例。</span><span class="sxs-lookup"><span data-stu-id="c2115-280">The base `Controller` class already implements the `IDisposable` interface, so this code simply adds an override to the `Dispose(bool)` method to explicitly dispose the context instance.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="c2115-281">处理事务</span><span class="sxs-lookup"><span data-stu-id="c2115-281">Handle transactions</span></span>

<span data-ttu-id="c2115-282">默认情况下，Entity Framework 隐式实现事务。</span><span class="sxs-lookup"><span data-stu-id="c2115-282">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="c2115-283">在方案中，对多个行或表进行更改，然后调用`SaveChanges`，Entity Framework 自动确保所做的更改的所有成功或全部失败。</span><span class="sxs-lookup"><span data-stu-id="c2115-283">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or all fail.</span></span> <span data-ttu-id="c2115-284">如果完成某些更改后发生错误，这些更改会自动回退。</span><span class="sxs-lookup"><span data-stu-id="c2115-284">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="c2115-285">在需要更多控制&mdash;例如，如果你想要包括外部实体框架在事务中完成的操作&mdash;请参阅[使用事务](/ef/ef6/saving/transactions)。</span><span class="sxs-lookup"><span data-stu-id="c2115-285">For scenarios where you need more control&mdash;for example, if you want to include operations done outside of Entity Framework in a transaction&mdash;see [Working with Transactions](/ef/ef6/saving/transactions).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="c2115-286">获取代码</span><span class="sxs-lookup"><span data-stu-id="c2115-286">Get the code</span></span>

[<span data-ttu-id="c2115-287">下载已完成的项目</span><span class="sxs-lookup"><span data-stu-id="c2115-287">Download Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="c2115-288">其他资源</span><span class="sxs-lookup"><span data-stu-id="c2115-288">Additional resources</span></span>

<span data-ttu-id="c2115-289">现在有了一整套的执行简单的 CRUD 操作执行的页`Student`实体。</span><span class="sxs-lookup"><span data-stu-id="c2115-289">You now have a complete set of pages that perform simple CRUD operations for `Student` entities.</span></span> <span data-ttu-id="c2115-290">MVC 帮助程序用于生成数据字段的 UI 元素。</span><span class="sxs-lookup"><span data-stu-id="c2115-290">You used MVC helpers to generate UI elements for data fields.</span></span> <span data-ttu-id="c2115-291">MVC 帮助程序的详细信息，请参阅[呈现窗体使用 HTML 帮助程序](/previous-versions/aspnet/dd410596(v=vs.98))（文章是的 MVC 3 但仍适用于 MVC 5)。</span><span class="sxs-lookup"><span data-stu-id="c2115-291">For more info about MVC helpers, see [Rendering a Form Using HTML Helpers](/previous-versions/aspnet/dd410596(v=vs.98)) (the article is for MVC 3 but is still relevant for MVC 5).</span></span>

<span data-ttu-id="c2115-292">EF 6 中的其他资源的链接可在[ASP.NET 数据访问-推荐的资源](../../../../whitepapers/aspnet-data-access-content-map.md)。</span><span class="sxs-lookup"><span data-stu-id="c2115-292">Links to other EF 6 resources can be found in [ASP.NET Data Access - Recommended Resources](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

## <a name="next-steps"></a><span data-ttu-id="c2115-293">后续步骤</span><span class="sxs-lookup"><span data-stu-id="c2115-293">Next steps</span></span>

<span data-ttu-id="c2115-294">在本教程中，你将了解：</span><span class="sxs-lookup"><span data-stu-id="c2115-294">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="c2115-295">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="c2115-295">Created a Details page</span></span>
> * <span data-ttu-id="c2115-296">已更新“创建”页</span><span class="sxs-lookup"><span data-stu-id="c2115-296">Updated the Create page</span></span>
> * <span data-ttu-id="c2115-297">更新的 HttpPost 编辑方法</span><span class="sxs-lookup"><span data-stu-id="c2115-297">Updated the HttpPost Edit method</span></span>
> * <span data-ttu-id="c2115-298">已更新“删除”页</span><span class="sxs-lookup"><span data-stu-id="c2115-298">Updated the Delete page</span></span>
> * <span data-ttu-id="c2115-299">已关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="c2115-299">Closed database connections</span></span>
> * <span data-ttu-id="c2115-300">处理的事务</span><span class="sxs-lookup"><span data-stu-id="c2115-300">Handled transactions</span></span>

<span data-ttu-id="c2115-301">转到下一步的文章，了解如何添加排序、 筛选和分页到项目。</span><span class="sxs-lookup"><span data-stu-id="c2115-301">Advance to the next article to learn how to add sorting, filtering, and paging to the project.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="c2115-302">排序、筛选和分页</span><span class="sxs-lookup"><span data-stu-id="c2115-302">Sorting, Filtering, and Paging</span></span>](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)
