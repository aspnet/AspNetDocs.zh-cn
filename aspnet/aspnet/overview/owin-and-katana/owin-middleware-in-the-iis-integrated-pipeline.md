---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: IIS 集成管道中的 OWIN 中间件 |Microsoft Docs
author: Praburaj
description: 本文介绍如何在 IIS 集成管道中运行 OWIN 中间件组件（OMCs），以及如何设置 OMC 运行的管道事件。 你应 。
ms.author: riande
ms.date: 11/07/2013
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 7d157fb6bd9e2ae9b55af41ef06c1eb5e6310ce1
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456707"
---
# <a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="6e6b5-104">IIS 集成管道中的 OWIN 中间件</span><span class="sxs-lookup"><span data-stu-id="6e6b5-104">OWIN Middleware in the IIS integrated pipeline</span></span>

<span data-ttu-id="6e6b5-105">作者： [Praburaj Thiagarajan](https://github.com/Praburaj)， [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="6e6b5-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

> <span data-ttu-id="6e6b5-106">本文介绍如何在 IIS 集成管道中运行 OWIN 中间件组件（OMCs），以及如何设置 OMC 运行的管道事件。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="6e6b5-107">阅读本教程之前，应查看项目 Katana 和[OWIN Startup 类检测](owin-startup-class-detection.md)[的概述](an-overview-of-project-katana.md)。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="6e6b5-108">本教程由 Rick Anderson （ [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ）、丽丽 Ross、Praburaj Thiagarajan 和 Howard Dierking （ [@howard\_Dierking](https://twitter.com/howard_dierking) ）撰写。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>

<span data-ttu-id="6e6b5-109">尽管[OWIN](an-overview-of-project-katana.md)中间件组件（OMCs）主要设计为在服务器不可知的管道中运行，但也可以在 IIS 集成管道中运行 OMC （ \***不\*支持经典模式**）。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="6e6b5-110">通过从包管理器控制台安装以下包（PMC），可以在 IIS 集成管道中使用 OMC：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="6e6b5-111">这意味着所有应用程序框架（甚至还不能在 IIS 和 system.web 之外运行的框架）都可以从现有的 OWIN 中间件组件受益。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="6e6b5-112">Visual Studio 2013 中的新标识系统附带的所有 `Microsoft.Owin.Security.*` 包（例如： Cookie、Microsoft 帐户、Google、Facebook、Twitter、[持有者令牌](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html)、OAuth、授权服务器、JWT、Azure Active Directory 和 Active directory 联合身份验证服务）都是 OMCs，可用于自承载和 IIS 托管方案。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="6e6b5-113">OWIN 中间件在 IIS 集成管道中的执行方式</span><span class="sxs-lookup"><span data-stu-id="6e6b5-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="6e6b5-114">对于 OWIN 控制台应用程序，使用[启动配置](owin-startup-class-detection.md)构建的应用程序管道由使用 `IAppBuilder.Use` 方法添加组件的顺序设置。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="6e6b5-115">也就是说， [Katana](an-overview-of-project-katana.md)运行时中的 OWIN 管道将按照 `IAppBuilder.Use`的注册顺序处理 OMCs。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="6e6b5-116">在 IIS 集成管道中，请求管道由已订阅预定义管道事件集的[HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) （如[BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx)、 [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)、 [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)等）组成。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="6e6b5-117">如果比较 OMC 与 ASP.NET 世界[HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx)的比较，则必须将 OMC 注册到正确的预定义管道事件。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="6e6b5-118">例如，当请求进入管道中的[AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)阶段时，将会调用 HttpModule `MyModule`：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="6e6b5-119">为了使 OMC 参与此相同的基于事件的执行排序， [Katana](an-overview-of-project-katana.md)运行时代码将扫描[启动配置](owin-startup-class-detection.md)，并将每个中间件组件订阅到集成管道事件。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="6e6b5-120">例如，以下 OMC 和注册代码使你可以查看中间件组件的默认事件注册。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="6e6b5-121">（有关创建 OWIN startup 类的更多详细说明，请参阅[OWIN Startup Class 检测](owin-startup-class-detection.md)。）</span><span class="sxs-lookup"><span data-stu-id="6e6b5-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="6e6b5-122">创建一个空的 web 应用程序项目，并将其命名为**owin2**。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="6e6b5-123">从包管理器控制台（PMC）运行以下命令：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="6e6b5-124">添加 `OWIN Startup Class`，并将其命名为 `Startup`。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="6e6b5-125">将生成的代码替换为以下代码（更改已突出显示）：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="6e6b5-126">按 F5 运行应用。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="6e6b5-127">启动配置设置具有三个中间件组件的管道，前两个组件显示诊断信息，最后一个事件响应事件（同时显示诊断信息）。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="6e6b5-128">`PrintCurrentIntegratedPipelineStage` 方法显示在其上调用该中间件的集成管道事件和消息。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="6e6b5-129">"输出" 窗口显示以下内容：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="6e6b5-130">默认情况下，Katana 运行时将每个 OWIN 中间件组件映射到[PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) ，这对应于 IIS 管道事件[PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx)。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="6e6b5-131">阶段标记</span><span class="sxs-lookup"><span data-stu-id="6e6b5-131">Stage Markers</span></span>

<span data-ttu-id="6e6b5-132">使用 `IAppBuilder UseStageMarker()` 扩展方法，可以将 OMCs 标记为在管道的特定阶段执行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="6e6b5-133">若要在特定阶段运行一组中间件组件，请在注册过程中将最后一个组件设置为之后立即插入一个阶段标记。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="6e6b5-134">可以在管道的哪个阶段执行中间件，以及必须运行的顺序组件（在本教程的后面部分将介绍这些规则）。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="6e6b5-135">将 `UseStageMarker` 方法添加到 `Configuration` 代码，如下所示：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="6e6b5-136">`app.UseStageMarker(PipelineStage.Authenticate)` 调用将配置之前注册的所有中间件组件（在本例中为两个诊断组件），以便在管道的身份验证阶段运行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="6e6b5-137">最后一个中间件组件（显示诊断和响应请求）将在 `ResolveCache` 阶段（ [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx)事件）上运行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="6e6b5-138">按 F5 运行应用。"输出" 窗口显示以下内容：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="6e6b5-139">阶段标记规则</span><span class="sxs-lookup"><span data-stu-id="6e6b5-139">Stage Marker Rules</span></span>

<span data-ttu-id="6e6b5-140">Owin 中间件组件（OMC）可以配置为在以下 OWIN 管道阶段事件下运行：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="6e6b5-141">默认情况下，OMCs 在最后一个事件（`PreHandlerExecute`）上运行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="6e6b5-142">这就是我们的第一个示例代码显示为 "PreExecuteRequestHandler" 的原因。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="6e6b5-143">您可以使用 `app.UseStageMarker` 方法来注册一个 OMC，以便在 `PipelineStage` 枚举中列出的 OWIN 管道的任意阶段运行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="6e6b5-144">OWIN 管道和 IIS 管道已排序，因此对 `app.UseStageMarker` 的调用必须按顺序排列。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="6e6b5-145">不能将事件处理程序设置为在向注册的最后一个事件之前 `app.UseStageMarker`的事件。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="6e6b5-146">例如，*在调用后*：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="6e6b5-147">不会传递对 `app.UseStageMarker` 传递 `Authenticate` 或 `PostAuthenticate` 的调用，且不会引发异常。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="6e6b5-148">OMCs 在最新阶段运行，默认情况下 `PreHandlerExecute`。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="6e6b5-149">阶段标记用于使它们在前面运行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="6e6b5-150">如果按顺序指定阶段标记，我们将舍入到前面的标记。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="6e6b5-151">换言之，添加一个阶段标记显示 "不晚于舞台 X 运行"。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="6e6b5-152">OMC 在 OWIN 管道中添加之后的最早阶段标记处运行。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="6e6b5-153">调用 `app.UseStageMarker` 入选的最早阶段。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="6e6b5-154">例如，如果从前面的示例中切换 `app.UseStageMarker` 调用的顺序：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="6e6b5-155">"输出" 窗口将显示：</span><span class="sxs-lookup"><span data-stu-id="6e6b5-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="6e6b5-156">OMCs 在 `AuthenticateRequest` 阶段中运行，因为最后一个 OMC 注册了 `Authenticate` 事件，`Authenticate` 事件在所有其他事件之前。</span><span class="sxs-lookup"><span data-stu-id="6e6b5-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
